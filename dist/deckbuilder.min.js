/*! simspellstone 07-01-2019 */

"use strict";function loadCardCache(){var e=storageAPI.getField("GameData","CardCache");if(e&&e.lastUpdated>DataUpdated)e.newCards?($.extend(CARDS,e.newCards),$.extend(FUSIONS,e.newFusions)):CARDS=e.cards,DataUpdated=e.lastUpdated;else{var t={newCards:{},newFusions:{},lastUpdated:Date.now()};storageAPI.setField("GameData","CardCache",t)}}function parseInt(e){return e>>0}"function"!=typeof String.prototype.format&&(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(e,t){return void 0!==a[t]?a[t]:e})}),"function"!=typeof Object.assign&&(Object.assign=function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");e=Object(e);for(var t=1;t<arguments.length;t++){var a=arguments[t];if(null!=a)for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&(e[i]=a[i])}return e});var curry=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(this,t.concat(Array.prototype.slice.call(arguments,0)))}};function _GET(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var i=t[a].split("=");if(decodeURIComponent(i[0])==e)return decodeURIComponent(i[1]?i[1]:"")}}function _DEFINED(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var i=t[a].split("=");if(decodeURIComponent(i[0])==e)return!0}return!1}function time_elapsed(){var e=((time_stop||Date.now())-time_start)/1e3;return e=e.toFixed(3)}function batch_time_elapsed(e){return e||(e=time_start_batch),timeSince(e)}function timeSince(e){return((Date.now()-e)/1e3).toFixed(3)}function shuffle(e){var t,a,i,n=e.length;if(0==n)return!1;for(;--n;)t=~~(Math.random()*(n+1)),a=e[n],i=e[t],e[n]=i,e[t]=a}function initializeCard(e,t,a){e.owner=t,e.timer=e.cost,e.health_left=e.health,applyDefaultStatuses(e),e.key=a,e.reusableSkills||e.resetTimers()}function copy_deck(e){var t={};return t.commander=e.commander,t.deck=copy_card_list(e.deck),t}function getDeckCards(e,t){var a={};a.commander=get_card_by_id(e.commander),a.deck=[];for(var i=e.deck,n=SIMULATOR.battlegrounds.onCreate.filter(function(e){return!("player"===t&&e.enemy_only||"cpu"===t&&e.ally_only)}),r=0,l=i.length;r<l;r++)a.deck.push(get_card_apply_battlegrounds(i[r],n));return a}function copy_card_list(e){for(var t=[],a=0,i=e.length;a<i;a++)t[a]=e[a];return t}function cloneCard(e){var t=Object.create(e.__proto__);for(var a in t.id=e.id,t.name=e.name,t.attack=e.attack,t.health=e.health,t.maxLevel=e.maxLevel,t.level=e.level,t.cost=e.cost,t.rarity=e.rarity,t.card_type=e.card_type,t.type=e.type,t.sub_type=e.sub_type||[],t.set=e.set,SKILL_DATA){var i=SKILL_DATA[a].type;"passive"!==i&&"toggle"!==i||(t[a]=e[a])}return e.flurry&&(t.skillTimers=[],t.flurry={id:e.flurry.id,c:e.flurry.c},t.skillTimers.push(t.flurry)),t.reusableSkills=e.reusableSkills,e.reusableSkills?(t.skill=e.skill,t.earlyActivationSkills=e.earlyActivationSkills,t.onDeathSkills=e.onDeathSkills):copy_skills(t,e.skill,e.earlyActivationSkills,e.onDeathSkills),t.highlighted=e.highlighted,t.runes=e.runes,t.runes||(t.runes=[]),t}Function.prototype.debounce=function(a){var i,n=this;return function(){var e=this,t=arguments;clearTimeout(i),i=setTimeout(function(){i=null,n.apply(e,t)},a)}};var CardPrototype,defaultStatusValues={attack_berserk:0,attack_valor:0,attack_rally:0,attack_weaken:0,attack_corroded:0,corrosion_timer:0,mark_target:0,barrier_ice:0,corroded:0,enfeebled:0,enraged:0,envenomed:0,heartseeker:0,imbued:0,invisible:0,nullified:0,poisoned:0,protected:0,scorched:0,warded:0,jammed:!(Function.prototype.throttle=function(e){var a,i=this;return function(){var e=this,t=arguments;a||(i.apply(e,t),a=setTimeout(function(){a=null,i.apply(e,t)},250))}}),jammedSelf:!1,silenced:!1,valor_triggered:!1,dualstrike_triggered:!1,ondeath_triggered:!1,reanimated:!1};function applyDefaultStatuses(e){for(var t in e.removeImbue(),e.enhanced={},defaultStatusValues)e[t]=defaultStatusValues[t]}var makeUnit=function(){function g(e,t){return get_card_by_id({id:e.id,level:e.level})[t]}function k(e,t,a){for(var i in t){var n=t[i];n.x&&((n=copy_skill(n)).x+=Math.ceil(n.x*a),n.boosted=!0,t[i]=n,e.highlighted.push(n.id))}}for(var e in CardPrototype={p:null,health_left:0,timer:0,key:void 0,initialize:function(e){this.health_left=this.health,this.isCommander()||(this.timer=this.cost,applyDefaultStatuses(this)),this.reusableSkills||this.resetTimers()},upkeep:function(){if(0<this.timer&&(this.timer--,debug&&(echo+=debug_name(this)+" reduces its timer<br>"),this.valor&&this.isActive())){var e=field_o_assaults[i];e&&this.adjustedAttack()<e.adjustedAttack()?(this.attack_valor=this.valor,debug&&(echo+=debug_name(this)+" activates valor, boosting its attack by "+this.valor+"<br/>")):debug&&(echo+=debug_name(this)+" activates valor but ",echo+=e?"enemy is not strong enough.<br/>":"there is no opposing enemy.<br/>")}this.enfeebled=this.envenomed+this.heartseeker,this.enraged=0,this.protected=0,this.barrier_ice=0,this.enhanced={},this.removeImbue()},endTurn:function(){this.attack_rally=0,this.attack_weaken=0,this.nullified=0,this.silenced=!1,this.jammed=!1,this.jammedSelf=!1,this.dualstrike_triggered=!1;var e=this.poisoned;e&&do_damage(null,this,e,null,function(e,t,a){echo+=debug_name(t)+" takes "+a+" poison damage",t.isAlive()||(echo+=" and it dies"),echo+="<br>"});var t=this.scorched;t&&(i=t.amount,1<t.timer?t.timer--:this.scorched=0,do_damage(null,this,i,null,function(e,t,a){echo+=debug_name(t)+" takes "+a+" scorch damage",t.isAlive()?t.scorched||(echo+=" and scorch wears off"):echo+=" and it dies",echo+="<br>"}));var a=this.corroded;if(a)if(1<a.timer){a.timer--;var i=Math.min(a.amount,this.permanentAttack());this.attack_corroded=i,echo+=debug_name(this)+" is corroded by "+i+"<br/>"}else this.corroded=0,this.attack_corroded=0,debug&&(echo+="corrosion on "+debug_name(this)+" wears off<br/>")},countdownSkillTimers:function(){for(var e=this.skillTimers,t=0,a=e.length;t<a;t++){var i=e[t];i.countdown&&(i.countdown--,debug&&(i.countdown?echo+=debug_name(this)+" charges "+convertName(i.id)+" (ready in "+i.countdown+" turns)<br/>":echo+=debug_name(this)+" readies "+convertName(i.id)+"<br/>"))}},isCommander:function(){return"1"==this.card_type},isAssault:function(){return"2"==this.card_type},isTrap:function(){return"3"==this.card_type},isBattleground:function(){return!1},isAlive:function(){return 0<this.health_left},isDamaged:function(){return this.health_left<this.health},isActive:function(){return 0==this.timer},isActiveNextTurn:function(){return this.timer<=1},isInactive:function(){return 1<=this.timer},isUnjammed:function(){return!this.jammed},isUnsilenced:function(){return!this.silenced},imbue:function(e){this.imbued||(this.imbued={});var t,a=this.imbued,i=e.id;switch(SKILL_DATA[i].type){case"toggle":return this[i]=!0,void(this.imbued[i]=1);case"passive":return this[i]+=parseInt(e.x),void(this.imbued[i]=(this.imbued[i]||0)+e.x);case"flurry":return void(this.flurry||(this.flurry=e,this.flurry.countdown=0,this.imbued.flurry=!0));case"onDeath":t="onDeathSkills";break;case"earlyActivation":t="earlyActivationSkills";break;case"activation":default:t="skill"}if(void 0===a[t]){var n=this[t];a[t]=n.length,this[t]=n.slice()}this[t].push(e)},scorch:function(e){var t=this.scorched;t?(t.amount+=e,t.timer=2):this.scorched={amount:e,timer:2}},removeImbue:function(){var e=this.imbued;if(e){for(var t in e){var a=e[t];"skill"===t||"earlyActivationSkills"===t||"onDeathSkills"===t?this[t]=this[t].slice(0,a):this[t]-=a}this.imbued=0}},hasSkill:function(e,t){var a;switch(SKILL_DATA[e].type){case"toggle":case"passive":case"flurry":return this[e];case"onDeath":a=this.onDeathSkills;break;case"earlyActivation":a=this.earlyActivationSkills;break;case"activation":default:a=this.skill}for(var i in a){var n=a[i];if(n.id===e&&(void 0===t||(n.all||0)==t))return!0}return!1},hasAttack:function(){return 0<this.adjustedAttack()},attackPlusBuffs:function(){return this.attack+this.attack_rally+this.attack_berserk+this.attack_valor},adjustedAttack:function(){return this.attack+this.attack_rally+this.attack_berserk+this.attack_valor-this.attack_weaken-this.attack_corroded},permanentAttack:function(){return this.attack+this.attack_berserk+this.attack_valor},isInFaction:function(e){if(void 0===e)return 1;var t=e.split(",");if(t.length<=1)return this.type==e?1:0<=this.sub_type.indexOf(e.toString())?1:0;for(var a=0;a<t.length;a++)if(!this.isInFaction(t[a]))return 0;return 1},resetTimers:function(){for(var e=0,t=this.skillTimers.length;e<t;e++)this.skillTimers[e].countdown=0},addRunes:function(e){addRunes(this,e)}},SKILL_DATA){var t=SKILL_DATA[e].type;"passive"===t?CardPrototype[e]=0:"toggle"===t&&(CardPrototype[e]=!1)}return applyDefaultStatuses(CardPrototype),function(e,t,a,i,n,r){t||(t=1);var l=Object.create(CardPrototype);l.id=e.id,l.name=e.name,l.attack=e.attack,l.health=e.health,l.maxLevel=e.maxLevel,l.level=t>l.maxLevel?l.maxLevel:t,l.cost=e.cost,l.rarity=e.rarity,l.card_type=e.card_type,l.type=e.type,l.sub_type=e.sub_type||[],l.set=e.set;var s,o=e.skill;if(1<l.level)for(var c in e.upgrades)if(void 0!==(s=e.upgrades[c]).cost&&(l.cost=s.cost),void 0!==s.health&&(l.health=s.health),void 0!==s.attack&&(l.attack=s.attack),void 0!==s.desc&&(l.desc=s.desc),0<s.skill.length&&(o=s.skill),c==l.level)break;if(o=o.slice(),i&&i.length&&function(t,e,a,i){t.highlighted=[];for(var n=0;n<a.length;n++){var r=a[n];if("statChange"==r.modifierType&&!i)for(var l=0;l<r.effects.length;l++){var s=r.effects[l];t.isInFaction(s.y)&&Object.keys(s).forEach(function(e){t[e]=s[e]})}}}(l,0,i,r),a){l.addRunes(a);var d=1;i&&i.forEach(function(e){"runeMultiplier"==e.modifierType&&e.effects.forEach(function(e){l.isInFaction(e.y)&&(d=parseInt(e.mult))})}),addRunesToSkills(o,a,d)}else l.runes=[];return i&&i.length&&function(e,t,a,i){e.highlighted=[];for(var n=0;n<a.length;n++){var r=a[n];if("evolve_skill"==r.modifierType)for(var l=0;l<r.effects.length;l++){var s=r.effects[l];for(var o in t){var c=t[o];c.id==s.id&&c.all==s.all&&((c=copy_skill(c)).id=s.s,c.boosted=!0,t[o]=c,e.highlighted.push(c.id))}}else if("add_skill"==r.modifierType)for(l=0;l<r.effects.length;l++){var d=r.effects[l];if(e.isInFaction(d.y)){if(d.rarity&&e.rarity!=d.rarity)continue;var u={};if(u.id=d.id,u.x=d.x||0,d.mult)if(d.base){var h=g(e,d.base);u.x+=Math.ceil(d.mult*h)}else u.mult=d.mult;if(u.z=d.z,u.c=d.c,u.s=d.s,u.all=d.all,d.card&&(u.card=d.card),d.level&&(u.level=d.level),u.boosted=!0,d.mult&&d.base&&0==u.x)continue;t.push(u),e.highlighted.push(u.id)}}else if("scale_attributes"!=r.modifierType||i){if("scale_stat"==r.modifierType&&!i)for(l=0;l<r.effects.length;l++)f=r.effects[l],e.isInFaction(f.y)&&(e[r.scaledStat]+=Math.ceil(g(e,f.base)*f.mult))}else for(var l=0;l<r.effects.length;l++){var f=r.effects[l];if(e.isInFaction(f.y)){var v=f.mult,p=Math.ceil(e.attack*v);e.attack+=p;var m=Math.ceil(e.health*v);e.health+=m,k(e,t,v)}}}}(l,o,i,r),n&&k(l,o,n),copy_skills_2(l,o),l}}(),getEnhancement=function(e,t,a){var i=e.enhanced,n=i&&i[t]||0;return n<0&&(n=Math.ceil(a*-n)),n},isImbued=function(e,t,a){var i;switch(SKILL_DATA[t].type){case"flurry":case"toggle":return e.imbued[t];case"passive":return e[t]===e.imbued[t];case"onDeath":i="onDeathSkills";break;case"earlyActivation":i="earlyActivationSkills";break;case"activation":default:i="skill"}return void 0!==e.imbued[i]&&a>=e.imbued[i]},addRunes=function(e,t){e.runes||(e.runes=[]);for(var a=0,i=t.length;a<i;a++){var n=t[a].id,r=getRune(n).stat_boost;for(var l in e.runes.push({id:n,stat_boost:r}),r){var s=r[l];"skill"==l||(isNaN(s)&&(s=Math.max(Math.ceil(e[l]*s.mult),s.min_bonus||1)),e[l]+=parseInt(s))}}};function addRunesToSkills(e,t,a){if(t)for(var i=0,n=t.length;i<n;i++){var r=t[i].id,l=RUNES[r].stat_boost;for(var s in l){var o=l[s];if("skill"==s)for(var c=o.id,d=o.x,u=o.mult,h=0;h<e.length;h++){var f=e[h];if(f.id==c&&(f.all||0)==(o.all||0)){f=copy_skill(f),!d&&u&&(d=Math.ceil(f.x*u)),o.min_bonus&&(d=Math.max(d,o.min_bonus)),d&&(f.x+=parseInt(d)*a),o.c&&(f.c-=Math.min(f.c,parseInt(o.c)*a)),f.boosted=!0,e[h]=f;break}}}}}var getRune=function(e){return RUNES[e]},canUseRune=function(e,t){var a=getRune(t),i=a.stat_boost;if(a.faction_req&&!e.isInFaction(a.faction_req))return!1;for(var n in i)if("skill"==n){var r=i[n],l=r.all?1:0;if(!e.hasSkill(r.id,l))return!1}return!0};function MakeSkillModifier(e,t){return{name:e,modifierType:t.effect_type,effects:[t]}}function MakeStatScaler(e,t){return{name:e,modifierType:"scale_stat",scaledStat:t.effect_type.replace("scale_",""),effects:[t]}}var MakeOnPlayBGE=function(){var a=function(e,t){this.p=null,this.name=e,this.effect=t,this.runes=[]};return a.prototype={onCardPlayed:function(e){SIMULATOR.onPlaySkills[this.effect.id](this,e,this.effect)},isCommander:function(){return!1},isAssault:function(){return!1},isBattleground:function(){return!0}},function(e,t){return new a(e,t)}}(),MakeTrap=function(){var a=function(e,t){this.name=e,this.id=t.id,this.base=t.base,this.mult=t.mult,this.target_deck=t.target_deck,this.y=t.y};return a.prototype={onCardPlayed:function(e,t,a){var i="opponent"===this.target_deck?a:t;if(e.isInFaction(this.y)){for(var n=[],r=0;r<i.length;r++){(e=i[r]).trap||n.push(e)}if(n.length){var l=Math.ceil(e[this.base]*this.mult),s=get_card_by_id(makeUnitInfo(this.id,l));n[~~(Math.random()*n.length)].trap=s,debug&&(echo+=this.name+" inserts "+debug_name(s)+" into the opposing deck.<br/>")}}}},function(e,t){return new a(e,t)}}(),getBattlegrounds=function(e,t,a,i,n,r,l,s){var o={onCreate:[],onTurn:[],onCardPlayed:[]};return addBgesFromList(o,e),addBgesFromList(o,t,"player"),addBgesFromList(o,a,"cpu"),addMapBGEs(o,i,"player"),n?addMissionBGE(o,n,r):l&&addRaidBGE(o,l,s),o};function addBgesFromList(e,t,a){if(!t)return null;for(var i=t.split(","),n=0;n<i.length;n++){var r=i[n];addBgeFromList(e,BATTLEGROUNDS[r],a)}}function addMissionBGE(e,t,a){var i=CAMPAIGNS[t];if(i){var n=i.battleground_id;if(n){var r=BATTLEGROUNDS[n];if(a=Number(a)-1,!r.starting_level||Number(r.starting_level)<=a){if(r.scale_with_level){r=JSON.parse(JSON.stringify(r));for(var l=a-Number(r.starting_level),s=0;s<r.effect.length;s++){var o=r.effect[s];o.mult=o.base_mult+o.mult*l}}addBgeFromList(e,r,"cpu")}}}}function addRaidBGE(e,t,a){var i=RAIDS[t].bge;if(i){var n=BATTLEGROUNDS[i];if(n&&Number(a)>=Number(n.starting_level))for(var r=n.enemy_only,l=0;l<n.effect.length;l++){var s=n.effect[l],o=s.effect_type;if("skill"===o){if(n.scale_with_level)var c=n.scale_with_level*(a-n.starting_level+1);else c=1;(d=MakeBattleground(n.name,s,c)).enemy_only=r,e.onTurn.push(d)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(effect_Type)){(d=MakeSkillModifier(n.name,s)).enemy_only=r,e.onCreate.push(d)}else if(0<=["scale_attack","scale_health"].indexOf(effect_Type)){(d=MakeStatScaler(n.name,s)).enemy_only=r,e.onCreate.push(d)}else if("trap_card"===o){var d;(d=MakeTrap(n.name,s)).enemy_only=r,e.onCardPlayed.push(d)}}}}function addMapBGEs(e,t,a){if(!t)return null;for(var i=t.split(","),n=0;n<i.length;n++){var r=i[n].split("-"),l=r[0],s=r[1],o=r[2],c=Object.keys(MAP_BATTLEGROUNDS).filter(function(e){return MAP_BATTLEGROUNDS[e].location_id==l})[0];addBgeFromList(e,(c=MAP_BATTLEGROUNDS[c]).effects[s].upgrades[o],a)}}function addBgeFromList(e,t,a){for(var i=0;i<t.effect.length;i++){var n=t.effect[i],r=n.effect_type;if("skill"===r){var l=MakeBattleground(t.name,n);"player"===a&&(l.ally_only=!0),"cpu"===a&&(l.enemy_only=!0),e.onTurn.push(l)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(r)){l=MakeSkillModifier(t.name,n);"player"===a&&(l.ally_only=!0),"cpu"===a&&(l.enemy_only=!0),e.onCreate.push(l)}else if(0<=["scale_attack","scale_health"].indexOf(r)){l=MakeStatScaler(t.name,n);"player"===a&&(l.ally_only=!0),"cpu"===a&&(l.enemy_only=!0),e.onCreate.push(l)}else if("trap_card"===r){l=MakeTrap(t.name,n);"player"===a&&(l.ally_only=!0),"cpu"===a&&(l.enemy_only=!0),e.onCardPlayed.push(l)}else if("on_play"===r){(l=MakeOnPlayBGE(t.name,n.effect)).attacker=n.attacker,l.defender=n.defender,l.first_play=n.first_play,"player"===a&&(l.ally_only=!0),"cpu"===a&&(l.enemy_only=!0),e.onCardPlayed.push(l)}}}var MakeBattleground=function(){var i=function(e,t,a){this.name=e,copy_skills_2(this,[t],a)};return i.prototype={p:null,name:null,runes:[],isCommander:function(){return!1},isAssault:function(){return!1},isBattleground:function(){return!0},resetTimers:function(){for(var e=0,t=this.skillTimers.length;e<t;e++)this.skillTimers[e].countdown=0}},function(e,t,a){return new i(e,t,a)}}();function copy_skills_2(e,t,a){e.skill=[],e.earlyActivationSkills=[],e.onDeathSkills=[];var i=[],n=!0;for(var r in t){var l=t[r];if(l.c)setSkill_2(e,s=copy_skill(l)),i.push(s),n=!1;else if(a){var s;(s=copy_skill(l)).x=Math.ceil(s.x*a),setSkill_2(e,s)}else setSkill_2(e,l)}e.reusableSkills=n,e.skillTimers=i}function setSkill_2(e,t){var a=t.id;switch(SKILL_DATA[a].type){case"toggle":return void(e[a]=!0);case"passive":e[t.id]=(0|e[t.id])+t.x;break;case"flurry":e[t.id]=t;break;case"onDeath":e.onDeathSkills.push(t);break;case"earlyActivation":e.earlyActivationSkills.push(t);break;case"activation":default:e.skill.push(t)}}function copy_skills(e,t,a,i){e.skill=[],e.earlyActivationSkills=[],e.onDeathSkills=[],e.skillTimers||(e.skillTimers=[]),copy_Skill_lists(e,e.skill,t),copy_Skill_lists(e,e.earlyActivationSkills,a),copy_Skill_lists(e,e.onDeathSkills,i)}function copy_Skill_lists(e,t,a){for(var i=0;i<a.length;i++){var n=a[i];if(n.c){var r=copy_skill(n);t.push(r),e.skillTimers.push(r)}else t.push(n)}}function copy_skill(e){var t={};return t.id=e.id,t.x=e.x,t.mult=e.mult,t.on_delay_mult=e.on_delay_mult,t.all=e.all,t.y=e.y,t.z=e.z,t.c=e.c,t.s=e.s,t}function debug_dump_decks(){var e,t;echo+="<br>",echo+="<h1>Attacker</h1>",(t=get_card_by_id(cache_player_deck.commander)).owner="player",t.health_left=t.health,echo+=debug_name(t)+debug_skills(t)+"<br>",debug_dump_cards(cache_player_deck,"player"),cache_cpu_deck&&(e=cache_cpu_deck),echo+="<br>",echo+="<h1>Defender</h1>",(t=get_card_by_id(e.commander,!0)).owner="cpu",t.health_left=t.health,echo+=debug_name(t)+debug_skills(t)+"<br>",debug_dump_cards(e,"cpu"),echo+="<br><hr><br>"}function debug_dump_cards(e,t){for(var a in e.deck){var i=get_card_by_id(e.deck[a],!0);i.owner=t,i.key=void 0,i.health_left=i.health,i.timer=i.cost,echo+=debug_name(i)+debug_skills(i),i.type&&(echo+=" <u>"+factions.names[i.type]+"</u>");var n=i.sub_type;if(n.length)for(var r=0;r<n.length;r++)echo+=" <u>"+factions.names[n[r]]+"</u>";echo+="<br>"}}function debug_dump_field(e){if(debug){echo+='<font color="#666666">';for(var t=["player","cpu"],a=0,i=t.length;a<i;a++){var n=t[a];echo+="<br>",echo+=n+"'s assaults:<br>";for(var r=e[n].assaults,l=0,s=r.length;l<s;l++){var o=r[l];echo+=debug_name(o),echo+="("+key+")",echo+="<br>"}e[n].assaults.length||(echo+="None<br>")}echo+="</font>",echo+="<br>"}}function debug_name(e,t){if("cpu"==e.owner)var a="i";else a="b";var i="<"+a+">";if(i+=e.name,e.runes.length&&(i+="*"),1<e.maxLevel&&(i+="{"+e.level+"/"+e.maxLevel+"}"),void 0!==e.key&&(i+=" ("+e.key+")"),i+="</"+a+">",!t){if(i+="<u>",e.isCommander())i+=" [",void 0!==e.health_left?i+=debug_fraction(e.health_left):i+=e.health,i+=" HP]";else if(e.isAssault()){i+=" [";var n=e.adjustedAttack();(isNaN(n)||null==n)&&(n=e.attack),i+=n,i+="/",void 0!==e.health_left?i+=debug_fraction(e.health_left):i+=e.health,i+="/",void 0!==e.timer?i+=e.timer:i+=e.cost,i+="]"}i+="</u>"}return i}function debug_fraction(e){return e>Math.floor(e)&&(e=e.toFixed(1)),e}function dump(e){echo+="<pre>",print_r(e),echo+="</pre>"}function generate_card_list(e){var t=[],a=[],i=[],n=get_card_by_id(e.commander);t.push(n.name+"("+n.level+")"),a.push(1),i.push(0);var r=0;for(var l in e.deck){var s=e.deck[l],o=get_card_by_id(s);if(o){var c=o.name+"("+o.level+")";o.runes.length&&(c+="*"),t[r]==c?a[r]++:(t.push(c),a.push(1),i.push(s.priority),r++)}}for(var d=a.length-1;0<=d;d--){var u=a[d],h=i[d];1<u&&(t[d]+="x"+u),0<h&&(t[d]+="="+h)}return t=t.join("; ")}function generate_play_list(e){for(var t=[],a=0;a<e.length;a++){var i=get_card_by_id(e[a]);if(i){var n=a%2==0?"b":"i",r="<"+n+">"+i.name+"("+i.level+")";i.runes.length&&(r+="*"),r+="</"+n+">",t.push(r)}}return"<td>"+t.join("</td><td>")+"</td>"}function debug_skills(e){var t=[];for(var a in e.earlyActivationSkills)t.push(debug_skill(e.earlyActivationSkills[a]));for(var a in e.skill)t.push(debug_skill(e.skill[a]));for(var a in e.onDeathSkills)t.push(debug_skill(e.onDeathSkills[a]));return debug_passive_skills(e,t),0<t.length?" <u>( "+t.join(" | ")+" )</u>":""}function debug_skill(e){var t=convertName(e.id);return e.all&&(t+=" all"),e.y&&(t+=" "+factions.names[e.y]),e.s&&(t+=" "+convertName(e.s)),e.c?t+=" every "+e.c+" turns":e.x&&(t+=" "+e.x),t}function debug_passive_skills(t,a){Object.getOwnPropertyNames(SKILL_DATA).filter(function(e){return 0<=["passive","toggle","flurry"].indexOf(SKILL_DATA[e].type)}).forEach(function(e){debugNonActivatedSkill(t,e,a)})}function debugNonActivatedSkill(e,t,a){var i=e[t];i&&a.push(convertName(t)+" "+i)}function convertName(e){var t=SKILL_DATA[e];return t?t.name:e}var base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!~",multiplierChars="_*.'",runeDelimiter="/",indexDelimiter="-",priorityDelimiter="|",noFusionInHash={};for(var id in CARDS)if(id<1e4){var fusion=FUSIONS[id];(!fusion||Number(fusion)<1e4)&&(noFusionInHash[id]=!0)}var maxRuneID=1e3;function unitInfo_to_base64(e){var t=parseInt(e.id),a=parseInt(e.level)-1;if(noFusionInHash[t]){var i=Math.floor(a/7);a=a%7}else{i=Math.floor(t/1e4);t%=1e4}var n=0;e.runes.length&&(n=parseInt(e.runes[0].id),n%=5e3);e.priority;var r=t;return decimal_to_base64(r=(r=7*(r=3*r+i)+a)*maxRuneID+n,5)}function base64_to_unitInfo(e){var t=base64_to_decimal(e),a=t%maxRuneID,i=(t=(t-a)/maxRuneID)%7,n=(t=(t-i++)/7)%3,r=t=(t-n)/3;noFusionInHash[r]?i+=7*n:0<n&&(r=Number(n+""+r));var l=makeUnitInfo(r,i);return 0<a&&l.runes.push({id:a+5e3}),l}function decimal_to_base64(e,t){for(var a="",i=0;i<t;i++){var n=e%64;a+=base64chars[n],e=(e-n)/64}return a}function base64_to_decimal(e){for(var t=0,a=e.length-1;0<=a;a--){t*=64,t+=base64chars.indexOf(e[a])}return t}function runeID_to_decimal(e){if(0==e)return 0;var t=(e=parseInt(e)%5e3)%10,a=(e-t)/10;return e=e=5*a+t-1}function base64_to_runeID(e){return decimal_to_runeID(base64chars.indexOf(e[0])+64*base64chars.indexOf(e[1]))}function decimal_to_runeID(e){var t=e%5,a=(e-t)/5;return 0==a?0:10*a+t+5001}function numberToBase64(e){return base64chars[Math.floor(e/64)]+base64chars[e%64]}function base64ToNumber(e){return 64*base64chars.indexOf(e[0])+base64chars.indexOf(e[1])}function encode_multiplier(e){return 256<(e-=2)?"":multiplierChars[Math.floor(e/64)]+base64chars[e%64]}function decode_multiplier(e){return 64*multiplierChars.indexOf(e[0])+base64chars.indexOf(e[1])}function hash_encode(e){var t=[],a=!1,i=!1,n=[];e.commander&&t.push(unitInfo_to_base64(e.commander));var r=[1];for(var l in e.deck){(c=e.deck[l]).priority&&(a=!0),c.index&&(n.push(numberToBase64(c.index)),i=!0);var s=unitInfo_to_base64(c);t.push(s),r.push(1),0}if(a){var o=priorityDelimiter;for(var l in e.deck){var c;(c=e.deck[l]).priority?o+=c.priority:o+="0"}t.push(o)}i&&(n=indexDelimiter+n.join(""),t.push(n));for(var d=0;d<r.length;d++){var u=r[d];1<u&&(t[d]+=encode_multiplier(u))}return t=t.join("")}function areEqual(e,t){return!e==!t&&unitInfo_to_base64(e)==unitInfo_to_base64(t)}function hash_decode(e){var t,a,i={deck:[]};0<e.indexOf(indexDelimiter)&&(a=e.substr(e.indexOf(indexDelimiter)+1).match(/.{1,2}/g),e=e.substr(0,e.indexOf(indexDelimiter)));for(var n=0,r=0;r<e.length;r+=5)if(-1==multiplierChars.indexOf(e[r])){var l=e.substr(r,5);t=base64_to_unitInfo(l),0<n&&a&&(t.index=base64ToNumber(a[n-1])),t&&(loadCard(t.id)?(!i.commander&&is_commander(t.id)?i.commander=t:i.deck.push(t),n++):console.log("Could not decode '"+l+"' ("+t.id+")"))}else{for(var s=decode_multiplier(e.substr(r,2))+1,o=0;o<s;o++){var c=makeUnitInfo(t.id,t.level,t.runes);a&&(c.index=base64ToNumber(a[n-1])),i.deck.push(c),n++}r-=3}return i.commander||(i.commander=elariaCaptain),i}function load_deck_from_cardlist(e){var t=[];if(t.deck=[],e){var a=[];300<e.length&&(e=e.substr(0,300)),e=(e=(e=(e=e.toString().toLowerCase()).replace(/[\&\/\.\!\?\'-]/g,"")).replace(/\s/g,"")).split(/[,;:]/);var i=CARDS;for(var n in e){var r=e[n].toString(),l=makeUnitInfo(1,7);l.priority=0;var s=!1;3<r.toString().length&&r.toString().match(/=[1-9][0-9]*$/)&&(l.priority=parseInt(r.substr(r.length-1,1)),r=r.substr(0,r.length-2));var o,c=1;if((o=r.toString().match(/^[1-9]+x/))?(c=parseInt(o[0]),r=r.substr(o[0].length)):(o=r.toString().match(/x[1-9]+$/))&&(c=parseInt(o[0].substr(1)),r=r.substr(0,r.length-o[0].length)),(o=r.toString().match(/\(([1-9]+)\).*/))&&(l.level=o[1],r=r.substr(0,r.length-o[0].length)),o=(r=r.trim()).toString().match(/\[[1-9]+\]/))if(l.id=o[0],is_commander(l.id))t.commander=l;else for(;0<c;)t.deck.push(l),c--;else{for(var d in a[r=clean_name_for_matching(r)]&&(r=a[r]),r=clean_name_for_matching(r),i){var u=i[d];if(l.id=u.id,clean_name_for_matching(u.name)==r){if(is_commander(l.id)&&1==c)t.commander=l;else for(t.deck.push(l);1<c;)t.deck.push(l),c--;s=!0;break}}if(!s){if(!t.commander&&1==c)for(var d in i){u=i[d];if(l.id=u.id,is_commander(l.id))if(-1!=clean_name_for_matching(u.name).indexOf(r)){t.commander=l,s=!0;break}}if(!s)for(var d in i){u=i[d];if(l.id=u.id,!is_commander(l.id))if(-1!=clean_name_for_matching(u.name).indexOf(r)){for(t.deck.push(l);1<c;)t.deck.push(l),c--;s=!0;break}}}}}}return t.commander||(t.commander=elariaCaptain),t}function clean_name_for_matching(e){return e=(e=(e=(e=(e=(e=e.toLowerCase()).toString().replace(/[\&]/g,",")).toString().replace(/[\.\!\?]/g,"")).toString().replace(/\s/g,"")).toString().replace(/-/g,"")).toString().replace(/\'/g,"")}function load_deck_mission(e,t){var a=MISSIONS[e];return a?load_preset_deck(a,t,6):0}function load_deck_raid(e,t,a){a||(a=25);var i=RAIDS[e];return i?load_preset_deck({commander:i.commander,deck:i.deck.card},t,Number(i.upgradeLevels)):0}var reverseFusions,DoNotFuse=["8005","8006","8007","8008","8009","8010"];function load_preset_deck(e,t,a){var i=a+1;t||(t=i);var n=[];n.deck=[];var r=getPresetCommander(e,t),l=getPresetUnit(r,t,i);r.possibilities&&(l.randomInfo={possibilities:r.possibilities,level:t,maxedAt:i}),n.commander=l;var s=e.deck,o=n.deck;for(var c in s){var d=getPresetUnit(s[c],t,i);d&&o.push(d)}var u=getUpgradePoints(t,i,getMaxUpgradePoints(o));if(1<t&&t<i)for(var h=o.slice();0<u&&0<h.length;){var f=Math.floor(Math.random()*h.length);upgradeCard(h[f])?u--:h.splice(f,1)}return n}function update_preset_deck(e){if(l=e.commander.randomInfo){var t=l.possibilities;(r=getPresetUnit(t[~~(Math.random()*t.length)],l.level,l.maxedAt)).randomInfo=l,e.commander=r}for(var a=e.deck,i=0,n=a.length;i<n;i++){var r,l;(l=(r=a[i]).randomInfo)&&((r=getPresetUnit(l.unitInfo,l.level,l.maxedAt)).randomInfo=l,a[i]=r)}return getDeckCards(e,"cpu")}function getPresetCommander(e,t){t=parseInt(t);var a=e.commander;if(a.card){for(var i=[],n=0;n<a.card.length;n++){var r=a.card[n],l=parseInt(r.min_mastery_level)||0,s=parseInt(r.max_mastery_level)||999;l<=t&&t<=s&&i.push(r)}(a=i[~~(Math.random()*i.length)]).possibilities=i}return a}function getUpgradePoints(e,t,a){var i;return i=7==t?(e-1)/(t-1):e/t,Math.ceil(a*i)}function getMaxUpgradePoints(e){for(var t=0,a=0;a<e.length;a++){var i=get_card_by_id(e[a]);t+=(getMaxFusions(i)+1)*i.maxLevel-1}return t}function getMaxFusions(e){for(var t=baseFusion(e),a=-1;void 0!==t;)a++,t=FUSIONS[t];return a}function baseFusion(e){for(var t,a=e.id;t=a,void 0!==(a=REVERSE_FUSIONS[t]););return t}function getPresetUnit(e,t,a){if(t=parseInt(t),e.mastery_level&&t<parseInt(e.mastery_level))return null;if(e.remove_mastery_level&&t>=parseInt(e.remove_mastery_level))return null;var i=e.id,n=!1;i||(i=getRandomCard(e),n=!0);var r=e.level||1;if(a<=t)r=7,canFuse(i)&&(i=fuseCard(i));else if(1<t&&is_commander(i)){var l=(Number(loadCard(i).rarity)+1)/(a-1),s=t-1;r=Math.ceil(l*s)}var o=makeUnitInfo(i,r);return n&&(o.randomInfo={unitInfo:e,level:t,maxedAt:a}),o}function getRandomCard(e){var t=[];for(var a in CARDS)if(!REVERSE_FUSIONS[a]){var i=CARDS[a];if("1"!=i.card_type&&!(e.max_rarity&&Number(e.max_rarity)<Number(i.rarity)||e.min_rarity&&Number(e.min_rarity)>Number(i.rarity))&&(!e.type||e.type==i.type||0<=i.sub_type.indexOf(e.type.toString()))){if(e.set)if(e.set.split(",").indexOf(i.set)<0)continue;t.push(a)}}return t[~~(Math.random()*t.length)]}function upgradeCard(e){var t=parseInt(loadCard(e.id).rarity)+2;if(e.level==t){if(!canFuse(e.id))return!1;e.id=fuseCard(e.id,1),e.level=1}else e.level++;return!0}function canFuse(e){return!(-1<DoNotFuse.indexOf(e))&&(!is_commander(e)&&!!FUSIONS[e])}function fuseCard(e,t){if(-1==DoNotFuse.indexOf(e))if(t)for(var a=0;a<t;a++)e=doFuseCard(e);else for(;;){var i=doFuseCard(e);if(e===i)break;e=i}return e}function doFuseCard(e){var t=FUSIONS[e];return t||e}function getFusion(e){var t=0;for(reverseFusions||getReverseFusions();t++,reverseFusions[e];);return t}function getReverseFusions(){for(var e in reverseFusions={},FUSIONS)reverseFusions[FUSIONS[e]]=e}var get_card_apply_battlegrounds=function(e,t,a){return get_card_by_id(e,t=t||SIMULATOR.battlegrounds.onCreate,null,a)};function get_skills(e,t){var a,i=loadCard(e),n=i.skill;if(1<t)for(var r in i.upgrades)if(0<(a=i.upgrades[r]).skill.length&&(n=a.skill),r==t)break;return n}function get_card_by_id(e,t,a,i){var n=loadCard(e.id);if(n){n.skill||(n.skill=[]);var r=makeUnit(n,e.level,e.runes,t,a,i);return e.priority&&(r.priority=e.priority),r}return console.log(e.id+" not found"),(n={}).id=e.id,n.level=e.level,n.name=void 0,n.health=void 0,n.skill=[],n}function get_slim_card_by_id(e,t){var a=loadCard(e.id),i={};if("1"==a.card_type?(i.isCommander=function(){return!0},i.isAssault=function(){return!1}):(i.isCommander=function(){return!1},i.isAssault=function(){return!0}),a){if(i.id=a.id,i.name=a.name,i.rarity=a.rarity,i.maxLevel=a.maxLevel,e.level?(i.level=e.level,i.level>i.maxLevel&&(i.level=i.maxLevel)):i.level=1,t){if(i.attack=a.attack,i.health=a.health,i.cost=a.cost,i.set=a.set,i.card_type=a.card_type,i.type=a.type,i.sub_type=a.sub_type||[],i.skill=a.skill,1<i.level)for(var n in a.upgrades){var r=a.upgrades[n];if(void 0!==r.cost&&(i.cost=r.cost),void 0!==r.health&&(i.health=r.health),void 0!==r.attack&&(i.attack=r.attack),void 0!==r.desc&&(i.desc=r.desc),0<r.skill.length&&(i.skill=r.skill),n==i.level)break}var l=e.runes;l&&(i.skill=i.skill.slice(),addRunes(i,l),addRunesToSkills(i.skill,l))}}else i.id=void 0,i.name=void 0,i.card_type=void 0,i.set=void 0,i.type=void 0,i.sub_type=[],i.level=void 0,i.maxLevel=void 0,getSkills&&(i.skill=[]);return i}function loadCard(e){return CARDS[e]}function getCardInfo(e){var t=e.id,a=e.level,i=CARDS[t],n=Object.assign({},i);if(1<a&&1<a)for(var r in i.upgrades){var l=i.upgrades[r];if(void 0!==l.cost&&(n.cost=l.cost),void 0!==l.health&&(n.health=l.health),void 0!==l.attack&&(n.attack=l.attack),void 0!==l.desc&&(n.desc=l.desc),0<l.skill.length&&(n.skill=l.skill),r==a)break}return n.level=a,n.maxLevel=i.maxLevel,n}function get_card_name_by_id(e){var t=loadCard(e);return t?t.name:0}function is_commander(e){var t=loadCard(e);return t&&"1"==t.card_type}function is_assault(e){var t=loadCard(e);return t&&"2"==t.card_type}function is_trap(e){var t=loadCard(e);return t&&"3"==t.card_type}var makeUnitKey=function(e){var t=e.id+"_"+e.level;return e.runes&&e.runes.length&&(t+="_"+e.runes[0].id),t};function makeUnitInfo(e,t,a){var i={id:Number(e),level:Number(t),runes:[]};return a&&(i.runes=a),i}var elariaCaptain=makeUnitInfo(202,1);function getRarity(e){return rarityStrings[e]}function getCurrentPage(){var e=window.location.href,t=e.indexOf(".html"),a=(e=e.substring(0,t)).lastIndexOf("/")+1;return e=e.substring(a).toLowerCase()}var rarityStrings=["","Common","Rare","Epic","Legendary","Mythic"],factions={names:{0:"Factionless",1:"Aether",2:"Chaos",3:"Wyld",4:"Frog",5:"Elemental",6:"Angel",7:"Undead",8:"Void",9:"Dragon",10:"Avian",11:"Goblin",12:"Seafolk",13:"Insect",14:"Bear",15:"Token",16:"Mecha",17:"Knight",999:"Tower"},IDs:{Factionless:0,Aether:1,Chaos:2,Wyld:3,Frog:4,Elemental:5,Angel:6,Undead:7,Void:8,Dragon:9,Avian:10,Goblin:11,Seafolk:12,Insect:13,Bear:14,Token:15,Mecha:16,Knight:17,Tower:999}},CARD_GUI={};function createImg(e,t){return $("<img>").addClass(t).attr("src",e)[0]}function createDiv(e,t){return $("<div>").addClass(e).html(t)[0]}function createSpan(e,t){return $("<span>").addClass(e).html(t)[0]}!function(){var t="";function i(e,t,a){var i=[],n=get_card_by_id(e.commander);i.push(m(n,!1,!1));for(var r=0,l=e.deck.length;r<l;r++){var s=e.deck[r];if(a)var o=get_card_apply_battlegrounds(s,a);else o=get_card_by_id(s);i.push(m(o,!1,!1))}if(!t)for(;r<15;r++)i.push(createDiv("card blank"));return i}function o(e,t,a,i,n,r){var l,s,o;n=n||0;for(var c=0,d=[],u=0,h=e.length;u<h&&(!r||c<r);u++){var f=e[u],v=get_card_by_id(f);areEqual(v,s)?o++:(n<=c&&(p(l,o),(l=m(v,t,!(o=1),a,i,null,u)).setAttribute("data-i",u),void 0!==f.index&&l.setAttribute("data-index",f.index),d.push(l)),s=v,c++)}return p(l,o),d}function r(e,t,a,i,n){t||(t=[]);var r=[];if(i){var l=document.createElement("h1");l.innerHTML="Turn: "+i+" (Currently at "+SIMULATOR.calculatePoints(!0)+" points)",r.push(l)}var s=createDiv("field"),o=null;if(n){o=n.owner;n=n.isCommander()?-1:n.key}return"player"===o?(s.appendChild(c(e.cpu)),s.appendChild(c(e.player,n))):(s.appendChild(c(e.cpu,n)),s.appendChild(c(e.player))),r.push(s),r.push(d(t,a,i)),r.push(document.createElement("br")),r.push(document.createElement("br")),r}function c(e,t){var a=createDiv("float-left"),i=m(e.commander,!1,!0);-1===t&&u(i),a.appendChild(i);var n=e.assaults;if(n)for(var r=0,l=n.length;r<l;r++){var s=n[r];i=m(s,!1,!0);s.timer&&i.classList.add("inactive"),t===r&&u(i),a.appendChild(i)}return a}function d(e,t,a){for(var i=createDiv("float-left hand"),n=0,r=e.length;n<r;n++){var l=e[n];if(l){var s=m(l,!1);0===n?s.classList.add("left"):2===n?s.classList.add("right"):2<n&&s.classList.add("inactive");t&&s.addEventListener("click",function(e){return function(){choice=e,t(a)}}(n)),i.appendChild(s)}}return i}function u(e){e.style.outline="5px solid LawnGreen"}function p(e,t){var a=parseInt(t);if(a==t&&(t=1<a?a:null),t){var i=createDiv("multiplier","x"+t);i.setAttribute("data-count",t);var n=createImg(K("cardAssets")+"multiplier.png","multiplier");e.appendChild(n),e.appendChild(i)}}function m(e,t,a,i,n,r,l){var s=createDiv("card");s.setAttribute("data-id",e.id),s.setAttribute("data-level",e.level);for(var o=e.runes,c=[],d={},u=0,h=o.length;u<h;u++){var f=o[u].id;c.push(o[u].id);var v=getRune(f);for(var p in v.stat_boost)"skill"==p&&(p=v.stat_boost.skill.id),d[p]=!0}var m=e.highlighted;if(m)for(u=0;u<m.length;u++){d[p=m[u]]=!0}s.setAttribute("data-runeids",c.join(","));var g=loadCard(e.id).picture;if(g){var k=document.createElement("i");0==g.indexOf("portrait_")?k.className="portrait portrait-"+g:k.className="sprite sprite-"+g,s.appendChild(k)}e.isCommander()&&s.classList.add("commander"),s.classList.add(factions.names[e.type].toLowerCase());var y=createDiv("card-name",(void 0!==e.uid?"("+e.uid+") ":"")+e.name),_=createDiv("card-id","("+e.id+")");if(y.appendChild(_),s.appendChild(y),!e.isCommander()){if(0<=e.attack){if(a){e.isUnjammed()||s.classList.add("frozen");var b=createDiv("card-attack",e.adjustedAttack().toString());e.adjustedAttack()>e.attack?b.classList.add("increased"):e.adjustedAttack()<e.attack?b.classList.add("decreased"):d.attack&&b.classList.add("increased")}else b=createDiv("card-attack",e.attack.toString());s.appendChild(createImg(K("cardAssets")+"Attack.png","attack")),s.appendChild(b)}0<=e.cost&&(a?e.timer&&(s.appendChild(createDiv("delay",e.timer)),s.appendChild(createImg(K("cardAssets")+"Timer.png","timer"))):(s.appendChild(createDiv("delay",e.cost)),s.appendChild(createImg(K("cardAssets")+"Timer.png","timer"))))}if(0<=e.health){if(a){var C=createDiv("card-health",e.health_left.toString());e.health_left<e.health?C.classList.add("decreased"):d.health&&C.classList.add("increased")}else{C=createDiv("card-health",e.health.toString());d.health&&C.classList.add("increased")}s.appendChild(createImg(K("cardAssets")+"Health.png","health")),s.appendChild(C)}var D=createDiv("card-skills"),I=createDiv("card-skills-short");e.earlyActivationSkills&&P(e,D,I,e.earlyActivationSkills,a),P(e,D,I,e.skill,a),e.onDeathSkills&&P(e,D,I,e.onDeathSkills,a),function(t,a,i,n,r){Object.getOwnPropertyNames(SKILL_DATA).filter(function(e){return 0<=["passive","toggle"].indexOf(SKILL_DATA[e].type)}).forEach(function(e){!function(e,t,a,i,n,r){var l=i[n];if(l){var s={id:n,x:l,boosted:r[n]};e.appendChild(B(i,s,a)),e.appendChild(document.createElement("br")),t.appendChild(O(s.id))}}(t,a,n,i,e,r)});var e=i.flurry;e&&(t.appendChild(B(i,e,n)),t.appendChild(document.createElement("br")),a.appendChild(O(e.id)))}(D,I,e,a,d);var w,S,x=D.cloneNode(!0);if(x.className="card-skills-detailed",I.hasChildNodes()&&(t?(s.appendChild(I),s.appendChild(D)):s.appendChild(x)),s.appendChild(createDiv("faction")),a){var F=function(e){var t=[];if(e.enfeebled){var a=M("enfeeble",e.enfeebled);t.push(a)}if(e.marked){var a=M("enfeeble",e.marked);t.push(a)}if(e.nullified){var a=M("nullify",e.nullified);t.push(a)}if(e.poisoned){var a=M("poison",e.poisoned);t.push(a)}if(e.scorched&&e.scorched.amount){var a=M("burn",e.scorched.amount);t.push(a)}var i=[];if(e.enraged){var a=M("enrage",e.enraged);t.push(a)}if(e.protected){var a=M("protect",e.protected);i.push(a)}if(e.invisible){var a=M("evade",e.invisible);i.push(a)}var n=[];if(0<t.length){for(var r=createDiv("card-debuffs"),l=0,s=t.length;l<s;l++)r.appendChild(t[l]);n.push(r)}if(0<i.length){for(var o=createDiv("card-buffs"),l=0,s=i.length;l<s;l++)o.appendChild(i[l]);n.push(o)}return n}(e);if(0<F.length){s.appendChild(createDiv("hidden","..."));var A=createDiv("card-statuses");for(u=0;u<F.length;u++){var L=F[u];A.appendChild(L)}s.appendChild(A)}}if(e.set){var $=(w=e.set,S=G[w],createImg(K("cardAssets")+S+".png"));$.className="set",s.appendChild($)}var T=e.sub_type;if(T.length){var N=createDiv("subfaction");for(u=0;u<T.length;u++){var E=T[u];if(E){var R=j(E);N.appendChild(R)}}s.appendChild(N)}if(0<e.rarity){if(e.maxLevel>Number(e.rarity)+2)var U=createImg(K("cardAssets")+"Level_"+e.rarity+"_"+e.maxLevel+"_"+e.level+".png");else U=createImg(K("cardAssets")+"Level_"+e.rarity+"_"+e.level+".png");if(U.className="level",9999<e.id){var H="1"==e.id.toString()[0]?"Dualfuse":"Quadfuse";(H=createImg(K("cardAssets")+H+".png")).className="fusion",s.appendChild(H)}s.appendChild(U)}else if(1<e.maxLevel){(U=createImg(K("cardAssets")+e.maxLevel+"_"+e.level+".png")).className="level",s.appendChild(U)}return i&&s.addEventListener("click",function(){return i(s,l)}),n&&(s.oncontextmenu=function(){return n(s,l)}),r&&(s.onmouseover=function(){return r(s,l)}),s}function P(e,t,a,i,n){for(var r=0;r<i.length;r++){var l=i[r];t.appendChild(B(e,l,n,r)),t.appendChild(document.createElement("br")),a.appendChild(O(l.id))}}function B(e,t,a,i){var n=document.createElement("span");n.className="skill",n.appendChild(O(t.id));var r=isImbued(e,t.id,i),l=getEnhancement(e,t.id,t.x);r?n.classList.add("imbued"):(t.boosted||l)&&n.classList.add("increased"),t.all&&(n.innerHTML+=" All "),t.y&&n.appendChild(j(t.y)),t.s&&n.appendChild(O(t.s));var s=(0|t.x)+l;return s&&(n.innerHTML+=" "+s+" "),t.c&&(n.innerHTML+=t.c,a&&(n.innerHTML+=" ("+(t.countdown?t.countdown:"0")+")")),n}function O(e){var t=K("skills"),a=SKILL_DATA[e],i=createImg(t+=(a?a.icon:e)+".png");switch(e){case"weakenself":case"enlarge":i.classList.add("affect-self")}return i.title=a?a.name:e,i}function M(e,t){var a=document.createElement("span");return a.appendChild(O(e)),t&&(a.innerHTML+=t),a}function j(e){var t=factions.names[e];return createImg(K("factions")+t+".png")}function K(e){return t+"res/"+e+"/"}var G={1e3:"Basic",1100:"Legacy",7e3:"Basic",2e3:"Reward",2100:"Reward",3e3:"Premium",4e3:"BoxOnly",5e3:"Champion",5100:"Champion",9999:"StoryElements"};CARD_GUI.clearCardSpace=function(){$("#cardSpace").empty()},CARD_GUI.clearDeckSpace=function(){document.getElementById("deck").innerHTML=""},CARD_GUI.draw_deck=function(e,t){var a=$("#deck");return a.children().remove(),a.append(i(e,t)),a},CARD_GUI.create_card_html=m,CARD_GUI.makeDeckHTML=i,CARD_GUI.makeCardListHTML=function(e,t,a){for(var i=createDiv("float-left"),n=0,r=e.deck.length;n<r;n++){var l=e.deck[n],s=m(get_card_by_id(l),!1,!1,t,a,null,n);void 0!==l.index&&s.setAttribute("data-index",l.index),i.appendChild(s)}return i},CARD_GUI.draw_card_list=function(e,t,a,i,n,r){var l=o(e,t,null,null,n,r),s=$("#cardSpace");return s.empty(),s.append(l),s},CARD_GUI.draw_cards=function(e,t,a,i){var n=r(e,t,a,i);$("#cardSpace").children().remove().end().append(n)},CARD_GUI.doDrawField=r,CARD_GUI.draw_inventory=function(e){var t=o(e.deck),a=$("#deck");return a.children().remove(),a.append(o([e.commander])),a.append(t),a},CARD_GUI.draw_hand=d,CARD_GUI.createItemHTML=function(e,t,a){var i=createDiv("card item"),n=document.createElement("i");n.className="sprite sprite-Item",i.appendChild(n),a&&((a=createImg(K("items")+a+".png")).className="item-image",i.appendChild(a));var r=createDiv("card-name",e);return i.appendChild(r),i.classList.add("factionless"),i.appendChild(createDiv("faction")),p(i,t),i},CARD_GUI.addMult=p,CARD_GUI.addWeight=function(e,t){if(0<t){var a=createDiv("weight",(100*t).toFixed(2)+"%");a.setAttribute("data-count",t);var i=createImg(K("cardAssets")+"multiplier.png","weight");e.appendChild(i),e.appendChild(a)}},Object.defineProperties(CARD_GUI,{assetsRoot:{get:function(){return t},set:function(e){t=e}}})}();var inventory,DATA_UPDATER=function(){var r="https://spellstone.synapse-games.com",h={},f={},l=null;var s=["cards_heroes.xml","cards_premium_aether.xml","cards_premium_chaos.xml","cards_premium_wyld.xml","cards_reward.xml","cards_shard.xml","cards_special.xml","cards_standard.xml","cards_story.xml","fusion_recipes_cj2.xml"];function v(e){var t,a,i={};if(i.id=m(e,"id"),i.name=m(e,"name"),u(i,e,"desc"),i.picture=m(e,"picture")||(t=m(e,"asset_prefab"),a="prefab_",t?a+t:t),!i.picture){var n=m(e,"portrait");i.picture=n?"portrait_"+n.toLowerCase().replace("portrait_",""):"NotFound"}var r=m(e,"hidden_until")||m(e,"hidden_until_time");r&&(i.hidden_until=r+"000"),i.rarity=m(e,"rarity"),i.set=m(e,"set"),i.card_type=m(e,"card_type"),p(i,e,"shard_card"),i.type=m(e,"type")||0,i.sub_type=g(e,"sub_type")||[],p(i,e,"health"),"1"!=i.card_type&&(p(i,e,"attack"),p(i,e,"cost"));var l=function(e){for(var t=e.getElementsByTagName("upgrade"),a={},i=0;i<t.length;i++)a[i+2]=d(t[i]);return a}(e);return i.maxLevel=1+Object.keys(l).length,i.skill=o(e),i.upgrades=l,i}function o(e){for(var t=e.childNodes,a=[],i=0;i<t.length;i++){var n=t[i];"skill"===n.nodeName&&a.push(c(n))}return a}function c(e){var t={id:m(e,"id",!0)};return p(t,e,"x",!0),p(t,e,"mult",!0),p(t,e,"on_delay_mult",!0),u(t,e,"y",!0),p(t,e,"z",!0),p(t,e,"c",!0),u(t,e,"s",!0),u(t,e,"all",!0),t}function d(e){var t={};return p(t,e,"attack"),p(t,e,"health"),p(t,e,"cost"),u(t,e,"desc"),t.skill=o(e),t}function u(e,t,a,i){var n=m(t,a,i);null!=n&&0<n.length&&(e[a]=n)}function p(e,t,a,i){var n,r=null!=(n=m(t,a,i))?Number(n):-1;0<=r&&(e[a]=r)}function m(e,t,a){if(a)return e.getAttribute(t);var i=g(e,t);return i?i[0]:null}function g(e,t){var a=null,i=$(e).children(t);if(0<i.length){a=[];for(var n=0;n<i.length;n++)a.push(i[n].textContent)}return a}return{updateData:function(e,t){$("body").addClass("loading"),$("#loadingSplash").html("Checking for New Cards...");var a=Date.now();if(!l||6e4<l-a||t){l=a,h={};var i=[];i.push(function(){for(var e=[],t=0;t<s.length;t++){var a=jQuery.ajax({url:r+"/assets/"+s[t],success:function(e){for(var t="undefined"!=typeof spoilers,a=e.getElementsByTagName("unit"),i=0;i<a.length;i++){a[i];var n=m(a[i],"id"),r=v(a[i]),l=!1;CARDS[n]?JSON.stringify(CARDS[n])!==JSON.stringify(r)&&(l=!0):l=!0,l&&(t&&(spoilers[n]=!0),h[n]=r),CARDS[n]=r}for(var s=e.getElementsByTagName("fusion_recipe"),i=0;i<s.length;i++){var o=s[i],c=m(o,"card_id",!1),d=o.getElementsByTagName("resource")[0];if(d){var u=m(d,"card_id",!0);FUSIONS[u]&&FUSIONS[u]==c||(f[u]=c,FUSIONS[u]=c)}}},async:!0,cache:!1});e.push(a)}return $.when.apply($,e)}());var n=function(){!function(){if(void 0!==storageAPI){var e=storageAPI.getField("GameData","CardCache");e?(e.newCards=e.newCards||{},e.newFusions=e.newFusions||{},$.extend(e.newCards,h),$.extend(e.newFusions,f)):e={newCards:h,newFusions:f},e.lastUpdated=Date.now(),storageAPI.setField("GameData","CardCache",e)}}(),$("body").removeClass("loading"),e&&e()};$.when.apply($,i).then(n,n)}else e&&e()}}}(),delayTutorial=!0,fromInventory=!1,deck=[];deck.commander=elariaCaptain;var advancedFilters,optionsDialog,saveDeckDialog,loadDeckDialog,detailsDialog,form,$nameFilter,$deck,$cardSpace,inventoryMode=!(deck.deck=[]),attackHidden={},attackRanges=[],healthHidden={},healthRanges=[],delayHidden={},delayRanges=[],delayExclusions=[],skillFilters=[],skillExclusions=[],skillHidden={},skillFiltersAdv=[],skillHiddenAdv={},factionHidden={},subfactionHidden={},dualFactionHidden={},rarityFilters=[],rarityHidden={},typeFilters=[],typeHidden={},setFilters=[],setExclusions=[],setHidden={},fusionFilters=[],fusionHidden={},nameHidden={},allCards=CARDS,showUpgrades=!1,units=[],unitsShown=[],unitsFiltered=[],initDeckBuilder=function(){_DEFINED("fromSim")||($("#header").load("templates/header.html",function(){$("#header").show(),"undefined"!=typeof showTutorial&&$("#help").click(showTutorial)}),$.holdReady(!0),$("#footer").load("templates/footer.html",function(){$("#footer").show(),$.holdReady(!1)})),setupPopups(),stopPropagation("hash"),$("body").addClass("loading"),addDeckEventHandlers($("#deck")),addLibraryEventHandlers($("#cardSpace")),$(window).resize(onResize),window.onwheel=changePage,$("#rows").val(storageAPI.getField("deckBuilder","rows",3)),$("#rows").bind("change",function(){storageAPI.setField("deckBuilder","rows",$("#rows").val())}),$nameFilter=$("#nameFilter").keypress(function(e){13==e.which&&(1==unitsFiltered.length&&addUnitToDeck(unitsFiltered[0],$cardSpace.children()[0]),e.preventDefault())}).autocomplete({source:[]});$("#deck").sortable({items:".card:not(.commander):not(.blank)",tolerance:"intersect",helper:function(e,t){return t.clone()},start:function(e,t){var a=t.placeholder.index()-1;t.item.data("last_pos",a),$(t.item).hide()},change:function(e,t){var a=t.item.index(),i=t.item.data("last_pos")-1,n=t.placeholder.index();a<n&&n--,highlighted=n,t.item.data("last_pos",n),n--;var r=deck.deck;r.splice(n,0,r.splice(i,1)[0]),updateHash(),updateHighlights()}});inventory=_GET("inventory")||inventory,$("[name=rarity]").click(function(e){onClickFilter(e,filterRarity,e.altKey)}),$("[name=faction]").click(function(e){onClickFilter(e,filterFaction,e.altKey)}),$("[name=subfaction]").click(function(e){onClickFilter(e,filterSubfaction,e.altKey)}),$("[name=delay]").click(function(e){onClickFilter(e,filterDelay,e.altKey)}),$("[name=set]").click(function(e){onClickFilter(e,filterSet,e.altKey)}),$("#dualfaction").click(function(e){onClickFilter(e,filterDualFaction,e.altKey)}),_DEFINED("spoilers")||_DEFINED("latestCards")?($("#loadingSplash").html("Checking for New Cards..."),updateGameData()):(loadCardCache(),setTimeout(loadCards,1)),_DEFINED("unlimited")&&($deck=$("#deck"),toggleInventoryMode()),$("#graph-accordion").click(updateGraphs)};function updateGameData(){setTimeout(DATA_UPDATER.updateData,1,loadCards,!0)}var loadCards=function(){allCards=CARDS,$("#loadingSplash").html("Loading..."),drawAllCards(),$("body").removeClass("loading"),checkTutorial()},setupPopups=function(){stopPropagation("advancedFilters"),stopPropagation("unitOptions"),$(".accordion").accordion({collapsible:!0,heightStyle:"content"}),$(".start-closed").accordion("option","active",!1).show(),_DEFINED("spoilers")&&$("#deck-container, #filter-container").accordion("option","active",!1).show();for(var e=document.getElementsByTagName("input"),t=0;t<e.length;t++);advancedFilters=$("#advancedFilters").dialog({autoOpen:!1,width:150,minHeight:20,modal:!0,resizable:!1,buttons:{OK:function(){filterAdvanced(advancedFilters.skill),advancedFilters.dialog("close")},Cancel:function(){advancedFilters.dialog("close")}},open:function(){jQuery(".ui-widget-overlay").bind("click",function(){advancedFilters.dialog("close")})}}),optionsDialog=$("#unitOptions").dialog({autoOpen:!1,width:250,minHeight:20,modal:!0,resizable:!1,buttons:{OK:function(){disableTracking=!1,modifyCard(optionsDialog),updateHash(),optionsDialog.dialog("close"),disableTracking=!1},Cancel:function(){resetCard(optionsDialog),optionsDialog.dialog("close"),disableTracking=!1}},open:function(){jQuery(".ui-widget-overlay").bind("click",function(){optionsDialog.dialog("close")})}}).bind("change",function(){modifyCard(optionsDialog)});var a=$('input[type="image"]:not(.skill-filter)');for(t=0;t<a.length;t++){var i=a[t],n='<div class="tooltip">'+i.getAttribute("title")+"</div>";i.removeAttribute("title");var r='<div style="display:inline; position:relative; overflow:visible;">'+i.outerHTML+n+"</div>";i.outerHTML=r}saveDeckDialog=$("#saveDeckDialog").dialog({autoOpen:!1,modal:!0,resizable:!1,buttons:{Save:function(){var e=$("#saveDeckName").val(),t=$("#hash").val();storageAPI.saveDeck(e,t),saveDeckDialog.dialog("close")},Cancel:function(){saveDeckDialog.dialog("close")}},open:function(){jQuery(".ui-widget-overlay").bind("click",function(){saveDeckDialog.dialog("close")})}}),loadDeckDialog=$("#loadDeckDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{Delete:function(){var e=$("#loadDeckName").val();storageAPI.deleteDeck(e)},Load:function(){var e=$("#loadDeckName").val(),t=storageAPI.loadDeck(e);loadDeckDialog.onloaded(t),loadDeckDialog.dialog("close")},Cancel:function(){loadDeckDialog.dialog("close")}},open:function(){jQuery(".ui-widget-overlay").bind("click",function(){loadDeckDialog.dialog("close")})}}),detailsDialog=$("#detailedView").dialog({minWidth:480,minHeight:330,padding:0,autoOpen:!1,modal:!0,resizable:!1,open:function(){jQuery(".ui-widget-overlay").bind("click",function(){detailsDialog.dialog("close")})},close:function(){cardDetailScope.visible=!1}})},drawAllCards=function(){drawCardList(),drawDeck()},drawDeck=function(){var e=_GET("hash")||$("#hash").val();e&&hash_changed(e);var t=_GET("name");t&&setDeckName(t),doDrawDeck()};function doDrawDeck(){$deck=CARD_GUI.draw_deck(deck,inventoryMode),updateHash()}function addDeckEventHandlers(e){addCardEvent(e,"mousedown",duplicate),addCardEvent(e,"mouseover",highlight),addCardEvent(e,"click",deckOnClick),addCardEvent(e,"contextmenu",showCardOptions)}function addLibraryEventHandlers(e){addCardEvent(e,"click",addToDeck),addCardEvent(e,"contextmenu",showDetails)}function addCardEvent(e,t,i){i&&e.on(t,function(e){var t=e.target.closest(".card");if(t&&!t.classList.contains("blank")){var a=$(t).attr("data-i");return i(e,t,a)}})}var showDetails=function(e,t){e.preventDefault();var a=getUnitFromCard(t);cardDetailScope.setUnit(a).$apply(),cardDetailScope.visible=!0,detailsDialog.dialog("option","position",{my:"center",at:"center",of:window}),detailsDialog.dialog("open"),detailsDialog.onloaded=setInventory};function duplicate(e,t){if(e.ctrlKey){var a=$(t);if(!inventoryMode){var i=a.parent().find(".blank");if(!i.length)return;i.first().remove()}var n=a.index(),r=deck.deck[n-1];a.clone().insertBefore(a.parent().children()[n]),deck.deck.splice(n,0,makeUnitInfo(r.id,r.level,r.runes||[])),updateHash()}}function deckOnClick(e,t){e.ctrlKey||removeFromDeck(t)}var drawCardList=function(){if(units=[],unitsShown=[],inventory){fromInventory=!0;var e=(inventory=hash_decode(inventory)).commander;inventory=inventory.deck,e&&!areEqual(e,elariaCaptain)&&inventory.push(e);for(var t=0;t<inventory.length;t++)addInventoryUnit(inventory[t]);deck.commander=removeFromInventory(deck.commander);for(t=0;t<deck.deck.length;t++){var a=deck.deck[t];deck.deck[t]=removeFromInventory(a)}}else if(_DEFINED("spoilers"))for(var i in spoilers)addUnitLevels(i);else for(var i in allCards)i<1e4&&addUnit(i);sortCards(document.getElementById("sortField")),applyFilters()},page=0,pages=0;function doDrawCardList(e,t){var a=document.getElementById("skillDetails").checked,i=document.getElementById("cardSpace");t&&(page=0);var n=i.offsetWidth,r=document.getElementById("rows").value,l=~~(n/90);l*=r;for(var s=null,o=0,c=0,d=e.length;c<d;c++){var u=e[c];areEqual(u,s)||o++,s=u}if(1<(pages=Math.max(Math.ceil(o/l),1))){var h=l*page;pages<=page&&(h=l*(page=pages-1)),CARD_GUI.draw_card_list(e,a,addToDeck,hideContext,h,h+l)}else page=0,CARD_GUI.draw_card_list(e,a,addToDeck,hideContext);document.getElementById("pageNumber").innerHTML="Page "+(page+1)+"/"+pages;var f=($cardSpace=$("#cardSpace")).find(".card");if(f.length){var v=f[0],p=$(v),m=(v.offsetHeight+parseInt(p.css("marginTop"))+parseInt(p.css("marginBottom")))*parseInt(r);$cardSpace.css("min-height",m+"px")}}var onResize=function(){applyFilters(!0)}.debounce(50);function adjustTable(e){var t=e.parentElement,a=t.parentElement;if(e.offsetWidth<=2){if(1==a.childElementCount){for(var i=[],n=e.nextElementSibling;n;)i.push(n),n=n.nextElementSibling;if(i.length){for(var r=document.createElement("tr"),l=0;l<i.length;l++)r.appendChild(i[l]);a.appendChild(r)}}}else if(1<a.childElementCount&&(r=t.nextElementSibling)){for(l=0;l<r.childNodes.length;l++)t.appendChild(r.childNodes[l]);a.removeChild(r)}}function changePage(e){overInventory(e)&&(e.deltaY<0?pageUp():0<e.deltaY&&pageDown(),e.preventDefault())}function overInventory(e){for(var t=e.srcElement;null!=t;){if("cardSpace"===t.id)return!0;t=t.parentElement}}function pageUp(){--page<0?page=0:applyFilters(!0)}function pageDown(){pages<=++page?page--:applyFilters(!0)}var redrawCardList=function(e){sortCards(document.getElementById("sortField")),applyFilters(e)},addInventoryUnit=function(e){units.push(e),unitsShown.push(e)},addUnit=function(e,t){addUnitLevels(e),t?(t["1"+e]&&addUnitLevels("1"+e),t["2"+e]&&addUnitLevels("2"+e)):999<e&&(addUnitLevels("1"+e),addUnitLevels("2"+e))},addUnitLevels=function(e){var t=allCards[e];if(t)for(var a=1;a<=t.maxLevel;a++){var i=makeUnitInfo(e,a);units.push(i),(showUpgrades||a==t.maxLevel)&&unitsShown.push(i)}},resetDeck=function(){hash_changed("oZ0IB")},disableTracking=!1,hash_changed=function(e){if(fromInventory&&(areEqual(deck.commander,elariaCaptain)||unitsShown.push(deck.commander),unitsShown.push.apply(unitsShown,deck.deck),redrawCardList(!0)),void 0===e&&(e=document.getElementById("hash").value.trim()),setHash(e),updateSimulator(e),deck=hash_decode(e),e||(deck.commander=null),fromInventory){areEqual(deck.commander,elariaCaptain)||removeFromInventory(deck.commander);for(var t=0;t<deck.deck.length;t++)removeFromInventory(deck.deck[t]);applyFilters()}doDrawDeck(),generateLink()},setHash=function(e){$("#hash").val(e),generateLink()},sortDeck=function(){deck.deck.sort(function(e,t){var a,i=get_card_by_id(e),n=get_card_by_id(t);return(a=i.rarity-n.rarity)?a:(a=i.type-n.type)?a:(a=compareByID(e,t))?a:(a=e.level-t.level)?a:a=(e.runes.length?e.runes[0].id:0)-(t.runes.length?t.runes[0].id:0)}),doDrawDeck()},addToDeck=function(e,t){var a=getUnitFromCard(t);addUnitToDeck(a,t)},addUnitToDeck=function(e,t){var a=$(t).clone().find(".multiplier").remove().end();inventoryMode||(e=Object.assign({},e));var i=$("#deck");if(is_commander(e.id)){if(areEqual(deck.commander,e))return;deck.commander=e,replaceCard(i.find(".card").first(),a)}else{if(!inventoryMode&&15==deck.deck.length)return;deck.deck.push(e);var n=i.find(".blank");n.length?replaceCard(n.first(),a):i.append(a)}if(a=$(t),fromInventory){removeFromInventory(e);var r=a.find("div.multiplier");if(0<r.length){var l=Number(r.attr("data-count"))-1;1<l?(r.attr("data-count",l),r.html("x"+l)):a.find(".multiplier").remove()}else a.remove()}else a.stop().hide().fadeIn(100);updateHash()};function replaceCard(e,t){var a=e.hasClass("blank")?1e3:600;$(e).replaceWith(t),t.children().stop().hide().fadeIn(a).promise()}function removeFromInventory(e){for(var t=0;t<unitsShown.length;t++){if(areEqual(e,unitsShown[t]))return unitsShown.splice(t,1)[0]}return e}var removeFromDeck=function(e){var t,a=$(e),i=a.index();if(0==i){if(areEqual(t=deck.commander,elariaCaptain))return;var n=get_card_by_id(deck.commander=elariaCaptain);replaceCard(a,$(CARD_GUI.create_card_html(n)))}else t=deck.deck.splice(i-1,1)[0],a.remove(),deck.deck.length<15&&$deck.append("<div class='card blank'></div>");fromInventory&&(unitsShown.push(t),redrawCardList(!0)),updateHash()},highlight=function(e,t){highlighted=$(t).index(),updateHighlights()},highlighted=-1;function updateHighlights(){var e=document.getElementById("hash"),t=e.value,a=5*highlighted,i=a+5,n=t.substring(0,a)+"<span>"+t.substring(a,i)+"</span>"+t.substring(i),r=document.getElementById("hash_highlighter");r.innerHTML=n,$(r).width($(e).width())}var updateHash=function(){var e=hash_encode(deck);setHash(e),updateHighlights(),addChange(e),updateSimulator(e),updateGraphs()},updateSimulator=function(e){},updateGraphs=function(){if(!$("#deckGraphs").is(":visible"))return null;for(var e=[0,0,0,0,0],t=[],a=[],i=[],n={},r={},l=0;l<deck.deck.length;l++){e[(_=get_card_by_id(deck.deck[l])).cost]++,n[_.type]=(n[_.type]||0)+1,t.push(Number(_.attack)),a.push(Number(_.health)),i.push(Number(_.cost)),(b=_.sub_type).length||b.push(0);for(var s=0;s<b.length;s++){r[C=b[s]]=(r[C]||0)+1}}var o=function(e,t){return e-t};function c(e,t){return e+t}function d(e){return e.length?(e.reduce(c)/e.length).toFixed(0):0}t.sort(o),a.sort(o),i.sort(o);var u=d(t),h=d(a),f=d(i),v={width:300,height:200,axisY:{onlyInteger:!0},plugins:[Chartist.plugins.legend(),Chartist.plugins.tooltip()],series:{Attack:{lineSmooth:Chartist.Interpolation.simple()},Health:{lineSmooth:Chartist.Interpolation.simple()},Delay:{lineSmooth:Chartist.Interpolation.simple()}}};new Chartist.Line("#statChart",{series:[{name:"Attack",className:"ct-series-attack",data:t},{name:"Health",className:"ct-series-health",data:a},{name:"Delay",className:"ct-series-delay",data:i}]},v);v={width:300,height:200,axisY:{onlyInteger:!0},distributeSeries:!0};var p={labels:["0","1","2","3","4"],series:e};new Chartist.Bar("#delayChart",p,v);p={labels:["Attack","Health","Delay"],series:[{value:u,className:"ct-series-attack"},{value:h,className:"ct-series-health"},{value:f,className:"ct-series-delay"}]};new Chartist.Bar("#averagesChart",p,v).on("draw",function(e){var t,a,i,n;if("bar"===e.type&&(t=e.x1+.5*e.element.width(),a=e.y1+-1*e.element.height()-10,"0"!==(n=e.element.attr("ct:value"))))return(i=new Chartist.Svg("text")).text(n),i.addClass("ct-barlabel"),i.attr({x:t,y:a,"text-anchor":"middle"}),e.group.append(i)});v={width:450,height:200,labelInterpolationFnc:function(e,t){return p.series[t].value},plugins:[Chartist.plugins.legend()]};var m=[];p=[];for(var g in n){var k=factions.names[g];m.push(k),p.push({value:n[g],className:"ct-series-"+k})}p={labels:m,series:p};new Chartist.Pie("#factionChart",p,v),v.labelInterpolationFnc=function(e,t){return y.series[t].value};m=[];var y=[];for(var g in r){k=factions.names[g];m.push(k),y.push({value:r[g],className:"ct-series-"+k})}y={labels:m,series:y};new Chartist.Pie("#subfactionChart",y,v);for(t=[],a=[],i=[],n={},r={},l=0;l<deck.deck.length;l++){var _,b;e[(_=get_card_by_id(deck.deck[l])).cost]++,n[_.type]=(n[_.type]||0)+1,t.push(Number(_.attack)),a.push(Number(_.health)),i.push(Number(_.cost)),(b=_.sub_type).length||b.push(0);for(s=0;s<b.length;s++){var C;r[C=b[s]]=(r[C]||0)+1}}o=function(e,t){return e-t};function c(e,t){return e+t}function d(e){return e.length?(e.reduce(c)/e.length).toFixed(0):0}t.sort(o),a.sort(o),i.sort(o);u=d(t),h=d(a),f=d(i),v={width:300,height:200,axisY:{onlyInteger:!0},plugins:[Chartist.plugins.legend(),Chartist.plugins.tooltip()],series:{Attack:{lineSmooth:Chartist.Interpolation.simple()},Health:{lineSmooth:Chartist.Interpolation.simple()},Delay:{lineSmooth:Chartist.Interpolation.simple()}}};new Chartist.Line("#statChart",{series:[{name:"Attack",className:"ct-series-attack",data:t},{name:"Health",className:"ct-series-health",data:a},{name:"Delay",className:"ct-series-delay",data:i}]},v);var D=(get_card_by_id(deck.commander).health+a.reduce(function(e,t){return e+t},0))/15,I=(m=[],[]);for(l=0;l<=15;l++)m.push(130-l),I.push(Math.ceil(D*l));v={width:500,height:200,axisY:{onlyInteger:!0},plugins:[Chartist.plugins.legend(),Chartist.plugins.tooltip()]};new Chartist.Line("#hpplChart",{labels:m,series:[{name:"Health Lost",className:"ct-series-attack",data:I}]},v)},changeTracking=[],currentChange=-1;function addChange(e){disableTracking||(changeTracking[++currentChange]=e,changeTracking.length=currentChange+1,100<currentChange&&(currentChange--,changeTracking.splice(0,1)))}function KeyPress(e){var t=window.event?event:e;t.ctrlKey&&(90==t.keyCode?undo():89==t.keyCode&&redo())}function stopPropagation(e){document.getElementById(e).onkeydown=function(e){e.stopPropagation()}}function undo(){if(0<currentChange){var e=$(document.getElementById("hash"));e.on("focus",preventFocus),disableTracking=!0;var t=changeTracking[--currentChange];setHash(t),deck=hash_decode(t),doDrawDeck(),e.off("focus"),disableTracking=!1}}function redo(){if(currentChange<changeTracking.length-1){var e=$(document.getElementById("hash"));e.on("focus",preventFocus),disableTracking=!0;var t=changeTracking[++currentChange];setHash(t),deck=hash_decode(t),doDrawDeck(),e.off("focus"),disableTracking=!1}}document.onkeydown=KeyPress;var preventFocus=function(e){$(this).blur(),e.stopPropagation()},onClickFilter=function(e,t,a){var i=e.target;t(i,i.getAttribute("data-filter"),a)},onContextMenu=function(e){e.preventDefault();var t=e.target.getAttribute("data-filter");showAdvancedFilters(t)},filterAdvanced=function(e){for(var t={id:e,x:void 0,y:void 0,c:void 0,s:void 0,all:void 0},a=0;a<skillFiltersAdv.length;a++)if(skillFiltersAdv[a].id==e){skillFiltersAdv.splice(a,1);break}if("none"!=$("div#amount")[0].style.display){var i=parseInt($("#amount-min")[0].value),n=parseInt($("#amount-max")[0].value);isNaN(i)&&(i=0),isNaN(n)&&(n=99),t.x={min:i,max:n}}if("none"!=$("div#timer")[0].style.display){i=parseInt($("#timer-min")[0].value),n=parseInt($("#timer-max")[0].value);isNaN(i)&&(i=0),isNaN(n)&&(n=99),t.c={min:i,max:n}}if("none"!=$("div#faction")[0].style.display){var r=$("select#faction")[0].value;t.y="Generic"==r?-1:factions.IDs[r]}"none"!=$("div#skill")[0].style.display&&0<$("select#skill")[0].value.length&&(t.s=$("select#skill")[0].value),"none"!=$("label[for=all]")[0].style.display&&(t.all=$("select#all")[0].value);var l=$("input[name=skill][data-filter="+e+"]")[0].classList;l.add("selected-advanced"),skillFiltersAdv.push(t),l.contains("selected")&&(l.remove("selected"),skillFilters.splice(skillFilters.indexOf(e),1),checkBasicSkillFilters()),l.contains("excluded")&&(l.remove("excluded"),skillExclusions.splice(skillFilters.indexOf(e),1),checkBasicSkillFilters()),checkAdvancedFilters()},checkAdvancedFilters=function(){skillHiddenAdv={};for(var e=0;e<units.length;e++)for(var t=units[e],a=0;a<skillFiltersAdv.length;a++)hasSkillAdvanced(t,skillFiltersAdv[a])||(skillHiddenAdv[makeUnitKey(t)]=!0);for(var i in skillFiltersAdv)skillFiltersAdv[i];applyFilters()},filterSkill=function(e,t,a){if(e.classList.contains("selected"))e.classList.remove("selected"),skillFilters.splice(skillFilters.indexOf(t),1);else if(e.classList.contains("excluded"))e.classList.remove("excluded"),skillExclusions.splice(skillFilters.indexOf(t),1);else{if(e.classList.contains("selected-advanced")){e.classList.remove("selected-advanced");for(var i=0;i<skillFiltersAdv.length;i++)if(skillFiltersAdv[i].id==t){skillFiltersAdv.splice(i,1);break}return void checkAdvancedFilters()}a?(e.classList.add("excluded"),skillExclusions.push(t)):(e.classList.add("selected"),skillFilters.push(t))}checkBasicSkillFilters(),applyFilters()};function checkBasicSkillFilters(){if(skillHidden={},0<skillFilters.length+skillExclusions.length)for(var e=0;e<units.length;e++){for(var t=units[e],a=0;a<skillFilters.length;a++)if(!hasSkill(t,skillFilters[a])){skillHidden[makeUnitKey(t)]=!0;break}for(a=0;a<skillExclusions.length;a++)if(hasSkill(t,skillExclusions[a])){skillHidden[makeUnitKey(t)]=!0;break}}}var filterFaction=function(e,t){if(factionHidden={},e.classList.contains("selected"))e.classList.remove("selected"),e.checked=!1;else{e.classList.add("selected");for(var a=0,i=units.length;a<i;a++){var n=units[a];isInFaction(n,t)||(factionHidden[makeUnitKey(n)]=!0)}}var r=document.getElementsByName("faction");for(a=0;a<r.length;a++){var l=r[a];l!=e&&l.classList.remove("selected")}applyFilters()},filterName=function(e){var t=e.value.toLowerCase();if(nameHidden={},t)if(0===t.indexOf("[")||t.indexOf("]")-t.length==-1){0!==t.indexOf("[")&&(t=".*"+t),t.indexOf("]")-t.length!=-1&&(t+=".*");for(var a=new RegExp("^"+t.replace("[","").replace("]","")+"$"),i=0,n=units.length;i<n;i++){var r=(l=units[i]).id;a.test(r.toString())||(nameHidden[makeUnitKey(l)]=!0)}}else for(i=0,n=units.length;i<n;i++){var l,s=get_slim_card_by_id(l=units[i],!0);s.name&&-1!=s.name.toLowerCase().indexOf(t)||(nameHidden[makeUnitKey(l)]=!0)}applyFilters()}.throttle(250),filterSubfaction=function(e,t,a){e.classList.contains("selected")||e.classList.contains("excluded")?(e.classList.remove("selected"),e.classList.remove("excluded"),e.checked=!1):a?(e.classList.add("excluded"),e.classList.remove("selected")):(e.classList.remove("excluded"),e.classList.add("selected")),subfactionHidden={};for(var i=$("[name=subfaction].selected").toArray().map(function(e){return e.attributes["data-filter"].value}),n=$("[name=subfaction].excluded").toArray().map(function(e){return e.attributes["data-filter"].value}),r=0,l=units.length;r<l;r++){for(var s=units[r],o=0;o<i.length;o++)isInSubfaction(s,i[o])||(subfactionHidden[makeUnitKey(s)]=!0);for(var c=0;c<n.length;c++)isInSubfaction(s,n[c])&&(subfactionHidden[makeUnitKey(s)]=!0)}applyFilters()},filterDualFaction=function(e,t,a){var i;if(e.classList.contains("selected")||e.classList.contains("excluded")?(e.classList.remove("selected"),e.classList.remove("excluded"),e.checked=!1):i=a?(e.classList.add("excluded"),e.classList.remove("selected"),!1):(e.classList.remove("excluded"),e.classList.add("selected"),!0),dualFactionHidden={},void 0!==i)for(var n=0,r=units.length;n<r;n++){var l=units[n];isDualFaction(l)!==i&&(dualFactionHidden[makeUnitKey(l)]=!0)}applyFilters()},filterAttack=function(e,t,a){if(attackHidden={},e.classList.contains("selected")){e.classList.remove("selected"),e.checked=!1;for(var i=0;i<attackRanges.length;i++)if(attackRanges[i][0]==t){attackRanges.splice(i,1);break}}else e.classList.add("selected"),attackRanges.push([t,a]);if(0<attackRanges.length){i=0;for(var n=units.length;i<n;i++){for(var r=units[i],l=!0,s=0;s<attackRanges.length;s++){var o=attackRanges[s];if(isInRange(r,"attack",o[0],o[1])){l=!1;break}}l&&(attackHidden[makeUnitKey(r)]=!0)}}applyFilters()},filterHealth=function(e,t,a){if(healthHidden={},e.classList.contains("selected")){e.classList.remove("selected"),e.checked=!1;for(var i=0;i<healthRanges.length;i++)if(healthRanges[i][0]==t){healthRanges.splice(i,1);break}}else e.classList.add("selected"),healthRanges.push([t,a]);if(0<healthRanges.length){i=0;for(var n=units.length;i<n;i++){for(var r=units[i],l=!0,s=0;s<healthRanges.length;s++){var o=healthRanges[s];if(isInRange(r,"health",o[0],o[1])){l=!1;break}}l&&(healthHidden[makeUnitKey(r)]=!0)}}applyFilters()},filterDelay=function(e,t,a){if(delayHidden={},e.classList.contains("selected")){e.classList.remove("selected"),e.checked=!1;for(var i=0;i<delayRanges.length;i++)if(delayRanges[i]==t){delayRanges.splice(i,1);break}}else if(e.classList.contains("excluded")){e.classList.remove("excluded"),e.checked=!1;for(i=0;i<delayExclusions.length;i++)if(delayExclusions[i]==t){delayExclusions.splice(i,1);break}}else a?(e.classList.add("excluded"),delayExclusions.push(t)):(e.classList.add("selected"),delayRanges.push(t));if(0<delayExclusions.length){i=0;for(var n=units.length;i<n;i++){for(var r=units[i],l=!1,s=0;s<delayExclusions.length;s++){t=delayExclusions[s];if(isInRange(r,"cost",t,t)){l=!0;break}}l&&(delayHidden[makeUnitKey(r)]=!0)}}if(0<delayRanges.length)for(i=0,n=units.length;i<n;i++){for(r=units[i],l=!0,s=0;s<delayRanges.length;s++){t=delayRanges[s];if(isInRange(r,"cost",t,t)){l=!1;break}}l&&(delayHidden[makeUnitKey(r)]=!0)}applyFilters()},filterType=function(e,t){if(typeHidden={},e.classList.contains("selected")){e.classList.remove("selected"),e.checked=!1;for(var a=0;a<typeFilters.length;a++)if(typeFilters[a]==t){typeFilters.splice(a,1);break}}else e.classList.add("selected"),typeFilters.push(t);if(0<typeFilters.length){a=0;for(var i=units.length;a<i;a++){for(var n=units[a],r=!0,l=0;l<typeFilters.length;l++){t=typeFilters[l];if(isInRange(n,"card_type",t,t)){r=!1;break}}r&&(typeHidden[makeUnitKey(n)]=!0)}}applyFilters()},filterFusion=function(e,t){if(fusionHidden={},e.classList.contains("selected")){e.classList.remove("selected"),e.checked=!1;for(var a=0;a<fusionFilters.length;a++)if(fusionFilters[a]==t){fusionFilters.splice(a,1);break}}else e.classList.add("selected"),fusionFilters.push(t);if(0<fusionFilters.length){a=0;for(var i=units.length;a<i;a++){for(var n=units[a],r=n.id.toString(),l=(t=4<r.length?r[0]:"",!0),s=0;s<fusionFilters.length;s++)if(t==fusionFilters[s]){l=!1;break}l&&(fusionHidden[makeUnitKey(n)]=!0)}}applyFilters()},showAdvancedFilters=function(e){$("label[for=all]").hide(),$("div#amount").hide(),$("div#faction").hide(),$("div#skill").hide(),$("div#timer").hide(),$("#amount-min")[0].value=0,$("#amount-max")[0].value=99,$("#timer-min")[0].value=0,$("#timer-max")[0].value=99,$("select#faction")[0].value="",$("select#skill")[0].value="",$("select#all")[0].value=-1;for(var t=0;t<skillFiltersAdv.length;t++){var a=skillFiltersAdv[t];if(a.id==e){a.x&&($("#amount-min")[0].value=a.x.min,$("#amount-max")[0].value=a.x.max),a.c&&($("#timer-min")[0].value=a.c.min,$("#timer-max")[0].value=a.c.max),a.y&&-1==a.y&&($("select#faction")[0].value="Generic"),a.s&&($("select#skill")[0].value=a.s),a.all&&($("select#all")[0].value=a.all);break}}switch(e){case"absorb":case"armored":case"barrage":case"backlash":case"berserk":case"burn":case"corrosive":case"counter":case"counterburn":case"evade":case"evadebarrier":case"frost":case"fury":case"heartseeker":case"leech":case"nullify":case"pierce":case"poison":case"regenerate":case"scorchbreath":case"stasis":case"taunt":case"valor":$("div#amount").show();break;case"silence":$("div#amount").show(),$("div#faction").show();break;case"fervor":case"legion":case"reanimate":case"resurrect":$("div#amount").show(),$("div#faction").show(),$("div#timer").show();break;case"enrage":case"heal":case"protect":case"protect_ice":case"rally":$("div#amount").show(),$("label[for=all]").show(),$("div#faction").show();break;case"enfeeble":case"poisonstrike":case"strike":case"weaken":case"weakenself":$("div#amount").show(),$("label[for=all]").show();break;case"enhance":case"imbue":$("div#amount").show(),$("label[for=all]").show(),$("div#faction").show(),$("div#skill").show(),$("div#timer").show();break;case"jam":$("label[for=all]").show(),$("div#timer").show();break;case"flurry":$("div#timer").show();break;default:return null}return advancedFilters.dialog("option","position",{mw:"center",at:"center",of:$("[data-filter="+e+"]")[0]}),advancedFilters.dialog("open"),advancedFilters.skill=e,!1},showCardOptions=function(e,t){e.preventDefault();var a=!1,i=$(t).index()-1;if(i<0)var n=deck.commander;else n=deck.deck[i];optionsDialog.index=i;var r=get_card_by_id(n);$("#upgradeDiv").hide();var l=document.getElementById("upgrade");l.max=r.maxLevel,l.value=r.level,1<r.maxLevel&&($("#upgradeDiv").show(),a=!0);var s=document.getElementById("fusion");if(s.value=0,$("#fusionDiv").hide(),!r.isCommander()){var o=1;if(4<(c=r.id.toString()).length){o=parseInt(c[0])+1;var c=c.substring(1)}FUSIONS[c]&&(s.value=o,$("#fusionDiv").show(),a=!0)}return"none"==$("#upgradeDiv").css("display")||"none"==$("#fusionDiv").css("display")?$("#upgradeDiv").add("#fusionDiv").toggleClass("split",!1):$("#upgradeDiv").add("#fusionDiv").toggleClass("split",!0),showRunePicker(r)&&(a=!0),a&&(disableTracking=!0,optionsDialog.dialog("option","position",{my:"left",at:"right",of:t}),optionsDialog.dialog("open"),optionsDialog.unit=n,optionsDialog.originalUnit=$.extend({},n)),!1};function hideContext(e){return e.preventDefault(),!1}var showRunePicker=function(e){var t=document.getElementById("runeChoices");if(t.innerHTML='<option value=""></option>',optionsDialog.hiddenOptions=[],$("#runeChoicesDiv").hide(),3<=e.rarity&&!e.isCommander()){for(var a in RUNES){var i=RUNES[a];if(canUseRune(e,i.id)){var n=document.createElement("option");n.appendChild(document.createTextNode(i.desc)),n.value=i.id,t.appendChild(n)}}return e.runes.length?document.getElementById("runeChoices").value=e.runes[0].id:document.getElementById("runeChoices").value="",0<t.childNodes.length&&($("#runeChoicesDiv").show(),!0)}return!1},toggleUnreleasedRunes=function(e){for(var t=optionsDialog.hiddenOptions,a=0,i=t.length;a<i;a++)t[a].hidden=!e.checked,t[a].disabled=!e.checked},modifyCard=function(e){if(void 0!==(a=e.unit)){var t=document.getElementById("runeChoices").value;a.runes=t?[{id:t}]:[]}else var a=deck.commander;a.level=document.getElementById("upgrade").value;var i=document.getElementById("fusion").value;if(i){i=(i-1).toString();var n=a.id.toString();4<n.length&&(n=n.substring(1)),0<=i&&(n=i+n),a.id=parseInt(n)}var r=get_card_by_id(a);showRunePicker(r),setCard(e.index,a),setHash(hash_encode(deck))},resetCard=function(e){setCard(e.index,e.originalUnit),setHash(hash_encode(deck))},setCard=function(e,t){e<0?deck.commander=t:deck.deck[e]=t;var a=CARD_GUI.create_card_html(get_card_by_id(t),!1,!1);$deck.find(".card").eq(e+1).replaceWith(a)},filterSet=function(e,t,a){setHidden={};var i=null;if(e.classList.contains("selected")?(e.classList.remove("selected"),e.checked=!1,i="selected"):e.classList.contains("excluded")?(e.classList.remove("excluded"),e.checked=!1,i="excluded"):a?e.classList.add("excluded"):e.classList.add("selected"),t.split(",").forEach(function(e){switch(i){case"selected":setFilters.splice(setFilters.indexOf(e),1);break;case"excluded":setExclusions.splice(setExclusions.indexOf(e),1);break;default:a?setExclusions.push(e):setFilters.push(e)}}),0<setFilters.length+setExclusions.length)for(var n=0,r=units.length;n<r;n++){for(var l=units[n],s=0===setFilters.length,o=0;o<setFilters.length;o++){var c=setFilters[o];if(isInRange(l,"set",c,c)){s=!0;break}}if(s){var d=!1;for(o=0;o<setExclusions.length;o++){c=setExclusions[o];if(isInRange(l,"set",c,c)){d=!0;break}}}s&&!d||(setHidden[makeUnitKey(l)]=!0)}applyFilters()},filterRarity=function(e,t){if(rarityHidden={},e.classList.contains("selected")){e.classList.remove("selected"),e.checked=!1;for(var a=0;a<rarityFilters.length;a++)if(rarityFilters[a]==t){rarityFilters.splice(a,1);break}}else e.classList.add("selected"),rarityFilters.push(t);if(0<rarityFilters.length){a=0;for(var i=units.length;a<i;a++){for(var n=units[a],r=!0,l=0;l<rarityFilters.length;l++){t=rarityFilters[l];if(isInRange(n,"rarity",t,t)){r=!1;break}}r&&(rarityHidden[makeUnitKey(n)]=!0)}}applyFilters()},applyFilters=function(e,t){unitsFiltered=[];for(var a=[],i={},n=0,r=unitsShown.length;n<r;n++){var l=unitsShown[n],s=makeUnitKey(l);if(skillHidden[s]||factionHidden[s]||subfactionHidden[s]||attackHidden[s]||healthHidden[s]||delayHidden[s]||typeHidden[s]||fusionHidden[s]||setHidden[s]||nameHidden[s]||rarityHidden[s]||skillHiddenAdv[s]||dualFactionHidden[s]);else{unitsFiltered.push(l);var o=get_card_by_id(l);i[o.name]||(a.push(o.name),i[o.name]=!0)}}$nameFilter.autocomplete("option",{source:a}),t||doDrawCardList(unitsFiltered,!e)},hasSkill=function(e,t){for(var a=get_slim_card_by_id(e,!0).skill,i=0,n=a.length;i<n;i++)if(t==a[i].id)return!0;return!1},hasSkillAdvanced=function(e,t){for(var a=get_slim_card_by_id(e,!0).skill,i=0,n=a.length;i<n;i++){var r=a[i];if(t.id==r.id){if(t.x&&(r.x<t.x.min||r.x>t.x.max))continue;if(t.c&&(r.c<t.c.min||r.c>t.c.max))continue;if(-1==t.y&&r.y)continue;if(0<t.y&&r.y!=t.y)continue;if(t.s&&r.s!=t.s)continue;if(-1<t.all&&(r.all||"0")!=t.all)continue;return!0}}return!1},clearFilters=function(){attackHidden={},attackRanges=[],healthHidden={},healthRanges=[],delayHidden={},delayRanges=[],delayExclusions=[],skillFilters=[],skillExclusions=[],skillHidden={},skillFiltersAdv=[],skillHiddenAdv={},factionHidden={},subfactionHidden={},dualFactionHidden={},rarityFilters=[],rarityHidden={},typeFilters=[],typeHidden={},setFilters=[],setExclusions=[],setHidden={},fusionFilters=[],fusionHidden={},nameHidden={},$(".selected").removeClass("selected"),$(".excluded").removeClass("excluded"),$(".selected-advanced").removeClass("selected-advanced"),$("#nameFilter").val(""),applyFilters()},isInFaction=function(e,t){var a=factions.IDs[t];return get_slim_card_by_id(e,!0).type==a},isInSubfaction=function(e,t){var a=factions.IDs[t],i=get_slim_card_by_id(e,!0);return void 0===a?0===i.sub_type.length:0<=i.sub_type.indexOf(a.toString())},isDualFaction=function(e){return 1<get_slim_card_by_id(e,!0).sub_type.length},isInRange=function(e,t,a,i){var n=get_slim_card_by_id(e,!0)[t];return void 0!==n&&(!(0<=a&&n<a)&&!(0<=i&&i<n))},toggleSkillDetails=function(){applyFilters(!0)},toggleUpgrades=function(e){showUpgrades=e.checked,$("body").addClass("loading"),setTimeout(function(){drawCardList(),$("body").removeClass("loading"),applyFilters(!1)},1)};function sortAndDraw(e){doSort(e),applyFilters()}var sortCards=function(e){doSort(e)};function doSort(e){var r=e.value;unitsShown.sort(function(e,t){var a=is_commander(t.id)-is_commander(e.id);if(0!=a)return a;if("id"===r)return compareByID(e,t);var i=get_card_by_id(e),n=get_card_by_id(t);return 0!=(a="sub_type"===r?compareBySubfactions(i,n):(i[r]||0)-(n[r]||0))?a:compareByID(e,t)})}function quicksort(e,t){if(0===e.length)return[];for(var a=[],i=[],n=e[0],r=1;r<e.length;r++)t(e[r],n)<0?a.push(e[r]):i.push(e[r]);return quicksort(a,t).concat(n,quicksort(i,t))}var compareByID=function(e,t){var a,i=e.id,n=t.id;return 0!=(a=i%1e4-n%1e4)?a:0!=(a=i-n)?a:0!=(a=e.level-t.level)?a:sortByRunes(e,t)};function compareBySubfactions(e,t){for(var a=e.sub_type,i=t.sub_type,n=Math.max(a.length,i.length),r=0;r<n;r++){var l=(a[r]||-1)-(i[r]||-1);if(l)return l}return 0}function sortByRunes(e,t){var a=e.runes.length-t.runes.length;return 0!=a?a:e.runes.length?e.runes[0].id-t.runes[0].id:0}var getUnitFromCard=function(e){for(var t={id:e.attributes.getNamedItem("data-id").value,level:e.attributes.getNamedItem("data-level").value},a=e.attributes.getNamedItem("data-runeids").value.split(","),i=[],n=0,r=a.length;n<r;n++){var l=a[n];0<l&&i.push({id:l})}var s=e.attributes.getNamedItem("data-index");return s&&(t.index=s.value),t.runes=i,t},skillStyle=document.createElement("style");function setDeckName(e){document.getElementById("version_label").innerHTML+=" "+e}function saveDeck(){var e=$("#hash").val();$("#saveDeckName").val("");var t=storageAPI.getSavedDecks();for(var a in t){if(e==t[a]){$("#saveDeckName").val(a);break}}saveDeckDialog.dialog("option","position",{my:"center",at:"center",of:window}),saveDeckDialog.dialog("open")}function loadDeck(){$('label[for="loadDeckName"]').html("<strong>Deck:</strong>"),loadDeckDialog.dialog("option","position",{my:"center",at:"center",of:window}),loadDeckDialog.dialog("open"),loadDeckDialog.onloaded=hash_changed}function loadInventory(){$('label[for="loadDeckName"]').html("<strong>Inventory:</strong>"),loadDeckDialog.dialog("option","position",{my:"center",at:"center",of:window}),loadDeckDialog.dialog("open"),loadDeckDialog.onloaded=setInventory}function setInventory(e){inventory=e,drawCardList(),generateLink()}function toggleInventoryMode(){if(inventoryMode=!inventoryMode)$("#inventoryMode").val("Switch to Deck Builder"),$deck.find(".card.blank").remove(),$deck.sortable("disable"),doDrawDeck();else{$("#inventoryMode").val("Switch to Inventory Builder");for(var e=$deck.find(".card").length;e<16;e++)$deck.append("<div class='card blank'></div>");$deck.sortable("enable"),doDrawDeck()}generateLink()}function generateLink(){var e=[],t=_GET("name"),a=$("#hash").val();t&&e.push("name="+t),a&&e.push("hash="+a),inventory&&e.push("inventory="+hash_encode({commander:elariaCaptain,deck:inventory})),inventoryMode&&e.push("unlimited"),_DEFINED("spoilers")&&e.push("spoilers");var i="http://thesench.github.io/SIMSpellstone/DeckBuilder.html";e.length&&(i+="?"+e.join("&")),$("#link").attr("href",i).text(i)}function externalData(e,t){setHash(e),inventory=t}skillStyle.type="text/css",document.getElementsByTagName("head")[0].appendChild(skillStyle);var storageAPI={};function getTutorialScript(){for(var e=[{msg:"Welcome to SIM Spellstone!  This is a brief tutorial of how to use the Deck Builder."},{ui:"#deckContainer",msg:'The "Deck" section contains your current deck.',actions:[_,n,f,r,l]},{ui:"#hash-container",msg:"If you have a deck hash, you can paste it here to set the current deck.",actions:[_]},{ui:"#deckContainer",msg:"Manually modifying the deck hash will automatically update the deck.",actions:[v]},{ui:"#deckContainer",msg:"Left-click on a card to remove it from your deck.",actions:[p]},{ui:"#deckContainer",msg:'Left-click on the commander will remove it and replace it with "Elaria Captain".',actions:[function(){C("QpLQAQwrxIQWkpBglFpB4jrBC4jrBC4jrBC")}]},{ui:"#deckContainer",msg:'Pressing Ctrl-Z will undo the last change made to your deck.  (Ctrl-Y can be used to "redo" a change as well).',actions:[p]},{ui:"#deckContainer",msg:"Holding Ctrl and left-clicking on a card will add a copy of it to your deck.",actions:[v]},{ui:"#deckContainer",msg:"You can drag-and-drop units in your deck to rearrange them (currently PC-only).",actions:[y,m]},{ui:"#unitOptions",dialog:!0,msg:"Right-click on a card to bring up an edit dialog.",actions:[m,g]},{ui:"#unitOptions",dialog:!0,msg:"Here, you can edit its level, fusion, and runes.",actions:[k]},{ui:"#deck .card:eq(1)",msg:'Changes will made will be shown on the card, but will not be saved until you hit "OK".',actions:[g,k]},{ui:"#deckContainer",msg:'Clicking "Cancel" will revert the unit back to its original stats.',actions:[y,m]},{ui:"#link",msg:"This link will load the DeckBuilder with your current deck to allow for easy sharing of decks.  It is automatically updated whenever you update the deck."},{ui:"#resetDeck",msg:'This will remove all cards from your deck and set the commander back to "Elaria Captain".',actions:[_]},{ui:"#sortDeck",msg:"This will sort all cards in your deck based on faction, rarity, and ID (the same way they are sorted in the game)."},{ui:"#saveDeck",msg:"This will allow you to save a deck locally so that you can easily load it later."},{ui:"#loadDeck",msg:"If you have any saved decks, you can use this button to quickly load one of them into the DeckBuilder.",actions:[l,n]},{ui:"#collection-container",msg:'The "Cards" section contains all of the cards in the game.',actions:[function(){$("#deck-container").accordion("option","active",null)},function(){$("#collection-container").accordion("option","active",0)}]},{ui:"#collection-container",msg:"Left-clicking on a card will add it to your deck.",actions:[s]},{ui:"#detailedView",dialog:!0,msg:"Right-clicking on a card will display a detailed view of the card.",actions:[function(){$("#collection-container").find(".card").first().contextmenu()},r]},{ui:"#filter-container",msg:'The "Filters" section allows you to filter the cards in the collection.',actions:[s,function(){$("#filter-container").accordion("option","active",0)}]},{ui:"#filter-container",msg:"Click on a filter to only show cards that match that filter.",actions:[f]},{ui:"[name=skill][data-filter=fervor]",msg:'For instance, clicking the "Fervor" filter will only show units that have the skill "Fervor".',actions:[o]},{ui:"#collection-container",msg:'Now only units with "Fervor" are visible.',actions:[function(){advancedFilters.dialog("close")}]},{ui:"#advancedFilters",dialog:!0,msg:"Right-clicking on a Skill filter will allow you to perform more advanced filtering.",actions:[d]},{ui:"#advancedFilters",dialog:!0,msg:"Here you can specify specific Skill values to filter by.  Different skills have different advanced filters available.",actions:[o,d,function(){$("#amount-min").val(4),b()}]},{ui:"[name=skill][data-filter=fervor]",dialog:!0,msg:'Clicking "OK" will apply the advanced filtering.',actions:[u]},{ui:"#collection-container",msg:'Now only units with at least "Fervor 4" are visible.'},{ui:"#filter-container",msg:'Holding the "Alt" key while clicking on a filter while hide cards that match that filter (not supported by all filters).',actions:[function(){var e=$("[name=skill][data-filter=enfeeble]");for(;e.hasClass("excluded")||e.hasClass("selected");)e.click()}]},{ui:"[name=skill][data-filter=enfeeble]",msg:'For instance, holding "Alt" and clicking the "Hex" filter will hide all units that have the skill "Hex".',actions:[c]},{ui:"#collection-container",msg:'Now only units with no "Hex" and at least "Fervor 4" are visible.'},{ui:"#name-container",msg:"You can also simply search for a unit by its name.",actions:[function(){$("#nameFilter").val("").trigger(jQuery.Event("keyup"))}]},{ui:"#name-container",msg:'For instance, typing "hide" will filter down to just "Spikehide Dragon" and "Spearhide Dragon".',actions:[h]},{ui:"#name-container",msg:'Tip: If the collection is filtered down to a single card, pressing "Enter" while in the Name Filter will add that card to your deck.',actions:[h,u,c]},{ui:"#clear-filters",msg:'You can click the "Clear All" button to reset all filters.',actions:[f]},{msg:'To view this tutorial again at any time, you can click the "Help" button.  (Note: this will reset the DeckBuilder.)'}],t=getCurrentPage(),a=0;a<e.length;a++){var i=e[a];i.showFor&&i.showFor!==t&&e.splice(a--,1)}function n(){$("#deck-container").accordion("option","active",0)}function r(){$("#filter-container").accordion("option","active",null)}function l(){$("#collection-container").accordion("option","active",null)}function s(){detailsDialog.dialog("close")}function o(){for(var e=$("[name=skill][data-filter=fervor]");!e.hasClass("selected");)e.click()}function c(){var e=$("[name=skill][data-filter=enfeeble]"),t=jQuery.Event("click");for(t.altKey=!0;!e.hasClass("excluded");)e.trigger(t)}function d(){$("[name=skill][data-filter=fervor]").contextmenu(),b()}function u(){advancedFilters.dialog("option","buttons").OK.apply(advancedFilters),b()}function h(){$("#nameFilter").val("hide").trigger(jQuery.Event("keyup"))}function f(){$("#clear-filters").click()}function v(){C("g~pAAQwrxIQWkpBglFpBglFpB4jrBC4jrBC4jrBC")}function p(){C("g~pAAQwrxIQWkpBglFpB4jrBC4jrBC4jrBC")}function m(){C("g~pAAQwrxIglFpBQWkpBglFpB4jrBC4jrBC4jrBC")}function g(){$("#deck .card").eq(1).contextmenu(),b()}function k(){$("#fusion").val(3),$("#runeChoices").val("5102").change(),b()}function y(){optionsDialog.dialog("close")}function _(){C("QpLQA")}function b(){$(".ui-dialog-buttonset .ui-button:visible").first().focus()}function C(e){$("#hash").val(e).change()}return e}!function(t){var a;try{a=t.module("simulatorApp")}catch(e){a=t.module("simulatorApp",[])}a.controller("DeckStorageCtrl",["$scope","$window",function(e,t){e.getSavedDecks=t.storageAPI.getSavedDecks,e.keys=function(e){return e?Object.keys(e):[]}}])}(angular),function(e){try{var t=window.localStorage,a="__storage_test__";return t.setItem(a,a),t.removeItem(a),!0}catch(e){return!1}}()?function(){var n="SavedDecks",r="Tutorial";function l(e){var t=localStorage.getItem(e);if(t)try{t=JSON.parse(t)}catch(e){t={}}else t={};return storageAPI.data[e]=t}storageAPI.initialize=function(){var e,t=getCurrentPage();void 0===(e=l(n)).savedDecks&&storageAPI.setField(n,"savedDecks",e),storageAPI.getField(n,"savedDecks",{}),storageAPI.shouldShowTutorial=storageAPI.getField(r,t,!0)[t];var a=storageAPI.onUpdateDecks;storageAPI.onUpdateDecks=function(e){a(),storageAPI.setField(n,"savedDecks",e)};var i=storageAPI.setShowTutorial;storageAPI.setShowTutorial=function(e){i(e),storageAPI.setField(r,t,e)}},storageAPI.getField=function(e,t,a){var i=l(e)[t];return void 0===i&&(i=a,storageAPI.setField(e,t,i)),i},storageAPI.setField=function(e,t,a){var i=l(e);i[t]=a,localStorage.setItem(e,JSON.stringify(i))},window.addEventListener("storage",function(e){"__storage_test__"!==e.key&&(localStorage.getItem(e.key)!==e.newValue&&angular.element("#loadDeckDialog").scope().$apply(localStorage.setItem(e.key,e.newValue)))})}():function(){storageAPI.initialize=function(){storageAPI.getSavedDecks=function(){return{}},storageAPI.loadDeck=e,storageAPI.deleteDeck=e,storageAPI.clearDecks=e,storageAPI.getField=function(e,t,a){return a},storageAPI.setField=function(){},storageAPI.savedDecks={},storageAPI.shouldShowTutorial=!0};var e=function(e,t){alert("Your browser does not support this feature.")}}(),function(){var e,t="SavedDecks";storageAPI.data={},storageAPI.getSavedDecks=function(){return storageAPI.getField(t,"savedDecks",{})},storageAPI.saveDeck=function(e,t){var a=storageAPI.getSavedDecks();a[e]=t,storageAPI.onUpdateDecks(a)},storageAPI.loadDeck=function(e){return storageAPI.getSavedDecks()[e]},storageAPI.deleteDeck=function(e){var t=storageAPI.getSavedDecks();delete t[e],storageAPI.onUpdateDecks(t)},storageAPI.clearDecks=function(e){var t=storageAPI.getSavedDecks();for(var e in t)delete t[e];storageAPI.onUpdateDecks(t)},storageAPI.onUpdateDecks=function(){e||(e=angular.element("#loadDeckDialog").scope()),e.$apply()},storageAPI.setShowTutorial=function(e){shouldShowTutorial=e},storageAPI.initialize()}(),angular.module("simulatorApp").controller("CardDetailsCtrl",["$scope","$window",function(i,a){var n;(a.cardDetailScope=i).id&&i.level&&(i.unit=a.makeUnitInfo(i.id,i.level),i.card=a.getCardInfo(i.unit)),i.setUnit=function(e){var t;return i.id=e.id,i.level=e.level,i.unit=a.makeUnitInfo(i.id,i.level),i.card=a.getCardInfo(i.unit),i.releaseDate=t=(t=i.card.hidden_until)?(t=new Date(Number(t))).getMonth()+1+"/"+t.getDate()+"/"+t.getFullYear():"",this},i.visible=!1,i.getCardImage=function(){var e=new Image;return e.src="res/cardImagesLarge/"+loadCard(i.card.id).picture+".jpg",e.onerror=function(){330!==this.naturalHeight&&(this.src=th.replace("ImagesLarge","Images"),this.onload=null),$modal.find("img").attr("src",this.src)},"res/cardImagesLarge/"+loadCard(i.card.id).picture+".jpg"},i.imageSrc="res/cardImagesLarge/NotFound.jpg",i.$watch("card.id",function(e,t){if(e){var a=".jpg";is_commander(e)&&(a=".png"),(n=new Image).onerror=function(){this.onerror=function(){this.onerror=null,this.src="res/cardImagesLarge/NotFound.jpg"},this.src=this.src.replace("ImagesLarge","Images")},n.onload=function(){this.onerror=null,this.onload=null,i.imageSrc=n.src,i.$apply()},n.src="res/cardImagesLarge/"+loadCard(e).picture+a}else i.imageSrc="res/cardImagesLarge/NotFound.jpg"}),i.isCommander=function(){return a.is_commander(i.id)},i.commanderClass=function(){return i.isCommander()?"commander "+i.getFaction(i.card.type).toLowerCase():""},i.getRarityString=function(){return a.rarityStrings[i.card.rarity]},i.fontSize=function(){var e=$("#rarity-string").text().length;return{"font-size":Math.ceil(71e3/(e*e))+"px"}},i.showRarity=function(){var e=i.card;return 0<e.rarity||1<e.maxLevel},i.getRarityIcon=function(){var e=i.card;return 0<e.rarity?"res/cardAssets/Level_"+e.rarity+(e.maxLevel>Number(e.rarity)+2?"_"+e.maxLevel:"")+"_"+e.level+".png":1<e.maxLevel?"res/cardAssets/"+e.maxLevel+"_"+e.level+".png":void 0};var t=i.previousFusion=function(){var e=a.FUSIONS;for(var t in e)if(e[t]===i.id)return t;return!1},r=i.nextFusion=function(){return a.FUSIONS[i.id]};i.previousLevel=function(){return 1<i.card.level},i.nextLevel=function(){return i.card.level<i.card.maxLevel};var e=i.getFusion=function(){var e=Number(i.id);return Math.floor(e/1e4)+1};i.fusionText=function(){return{1:"Single",2:"Dual",3:"Quad"}[e()]},i.keyPress=function(e){var t;switch(e.which){case 37:t="decrementLevel";break;case 38:t="incrementFusion";break;case 39:t="incrementLevel";break;case 40:t="decrementFusion"}t&&(i[t](),e.preventDefault(),e.stopPropagation())},i.isFused=function(){return 1<e()},i.getFusionIcon=function(){return"res/cardAssets/"+(2===e()?"Dualfuse":"Quadfuse")+".png"},i.getSkillIcon=function(e){var t=SKILL_DATA[e];return"res/skills/"+(t?t.icon:e)+".png"},i.getSkillDescription=function(e){var t=SKILL_DATA[e];return t?t.desc||t.name:e};var l={1e3:"Basic",7e3:"Basic",2e3:"Reward",3e3:"Premium",4e3:"BoxOnly",9999:"StoryElements"};i.getSetIcon=function(){var e=l[i.card.set];return e||(e=l[9999]),"res/cardAssets/"+e+"_64x64.png"},i.getFaction=function(e){var t=a.factions.names[e];return"Tower"===t&&(t=""),t},i.decrementFusion=function(){var e=t(Number(i.id));e&&(i.id=e,i.unit.id=i.id,i.card=a.getCardInfo(i.unit),i.level>i.card.maxLevel&&(i.level=i.card.maxLevel,i.unit.level=i.level,i.card=a.getCardInfo(i.unit)))},i.incrementFusion=function(){var e=r(Number(i.id));if(e){var t=i.level==i.card.maxLevel;i.id=e,i.unit.id=i.id,i.card=a.getCardInfo(i.unit),t&&i.level<i.card.maxLevel&&(i.level=i.card.maxLevel,i.unit.level=i.level,i.card=a.getCardInfo(i.unit))}},i.decrementLevel=function(){i.level=Number(i.level),1<i.level&&i.level--,i.unit.level=i.level,i.card=a.getCardInfo(i.unit)},i.incrementLevel=function(){i.level=Number(i.level),i.level<i.card.maxLevel&&i.level++,i.unit.level=i.level,i.card=a.getCardInfo(i.unit)}}]).directive("ngRightClick",["$parse",function(n){return{link:function(t,e,a){var i=n(a.ngRightClick);e.contextmenu(function(e){t.$apply(function(){e.preventDefault(),i(t,{$event:e})})})}}}]).directive("cardDetails",function(){return{restrict:"A",replace:!0,templateUrl:"templates/card-template.html",controller:"CardDetailsCtrl"}}).directive("sssAutofocus",function(){return{link:function(e,t,a){t.focus()}}}).filter("capitalize",function(){return function(e){if(e){for(var t=e.split(" "),a=0;a<t.length;a++){var i=t[a];t[a]=i.charAt(0).toUpperCase()+i.substr(1)}return t.join(" ")}return""}}).filter("convertName",function(){return window.convertName}).controller("DeckBuilderCtrl",["$scope","$window",function(e,a){e.getSkillIcon=function(e){var t=SKILL_DATA[e];return"res/skills/"+(t?t.icon:e)+".png"},e.supportedSkills=["absorb","armored","backlash","barrage","berserk","burn","corrosive","counter","counterburn","daze","enfeeble","enhance","enrage","evade","evadebarrier","fervor","flurry","frost","fury","heal","heartseeker","imbue","jam","leech","legion","nullify","pierce","poison","poisonstrike","protect","rally","regenerate","scorchbreath","silence","stasis","strike","taunt","valor","weaken","weakenself"].sort(function(e,t){return SKILL_DATA[e].name.localeCompare(SKILL_DATA[t].name)}),e.getSkillName=function(e){var t=SKILL_DATA[e];return t?t.name:e},e.showAdvancedFilters=a.showAdvancedFilters,e.filterSkill=function(e,t){a.filterSkill(e.target,t,e.altKey)}}]),$(document).ready(function(){var l=getTutorialScript(),e=$("<div></div>");function t(){storageAPI.shouldShowTutorial?a():r()}function a(){o=0,c();$("#tutorial").show()}$(document.body).append(e),e.load("templates/tutorial-overlay.html",null,function(){e.replaceWith(function(){return $(this).contents()}),$("#tutorial-show").prop("checked",storageAPI.shouldShowTutorial).change(function(e){storageAPI.setShowTutorial(this.checked)}),$("#help").click(a),$("#tutorial-close, #tutorial-skip").click(r),$("#tutorial-next").click(i),$("#tutorial-prev").click(n),void 0===delayTutorial&&t()});var s,o=0;function i(){o++,c()}function n(){o--,c()}function r(){$("#tutorial").hide(),$("#tutorial-permahide").is(":checked")&&storageAPI.hideTutorial()}function c(){clearTimeout(s);var e=l[o],t=e.actions;if(t)for(var a=0;a<t.length;a++)t[a]();var i=e.msg,n=e.ui;if(n){var r=$(n);e.dialog&&(r=r.parent()),d(r),t&&(s=setTimeout(d,500,r)),i.indexOf(!1)&&(i=i.replace(/\{0\}/g,r.text()))}else $(".overlay-fog").width(0).height(0);$("#tutorialMessage").text(i),o<l.length-1?($("#tutorial-next").show(),$("#tutorial-close").hide()):($("#tutorial-next").hide(),$("#tutorial-close").show()),0<o?$("#tutorial-prev").removeClass("disabled"):$("#tutorial-prev").addClass("disabled")}function d(e){var t=e.offset();$(".overlay-fog").css({top:t.top-2+"px",left:t.left-2+"px"}).width(e.outerWidth()+4+"px").height(e.outerHeight()+4+"px")}window.showTutorial=a,window.checkTutorial=t});