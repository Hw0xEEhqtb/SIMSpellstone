define("config",[],function(){return{pvpAI:!1}});var current_timeout,battle_history="",mass_debug=!1,loss_debug=!1,win_debug=!1,play_debug=!1,closeDiv=!1,battleground=[];define("matchStats",[],function(){return{matchesPlayed:0,matchesWon:0,matchesLost:0,matchesDrawn:0,totalTurns:0,totalPoints:0}}),function(){var e=function(){};window.ga=e,define("animations",[],function(){return{}}),define("debugLog",[],function(){return{enabled:!1,getLog:function(){return""},clear:e,prepend:e,prependLines:e,append:e,appendLines:e}}),define("log",[],function(){return{}}),define("ui",[],function(){return{show:e,hide:e,getSelectedBattlegrounds:e,getSelectedMapBattlegrounds:e,generateLink:e,displayText:e,displayTurns:e,showWinrate:e,hideTable:e,setSimStatus:e,loadDeckBuilder:e,updateGameData:e,loadSavedDeck:e,toggleTheme:e}})}(),define("bgeApi",["log","cardApi","debugLog"],function(o,c,u){var e={getBattlegrounds:function(e,n,a,i,r,t,s,l){var d={onCreate:[],onTurn:[],onCardPlayed:[]};h(d,e),h(d,n,"player"),h(d,a,"cpu"),function(e,n,a){if(n)for(var i=n.split(","),r=0;r<i.length;r++){var t=i[r].split("-"),s=t[0],l=t[1],d=t[2],o=Object.keys(MAP_BATTLEGROUNDS).filter(function(e){return MAP_BATTLEGROUNDS[e].location_id==s})[0],u=(o=MAP_BATTLEGROUNDS[o]).effects[l].upgrades[d];v(e,u,a)}}(d,i,"player"),r?function(e,n,a){var i=CAMPAIGNS[n];if(i){var r=i.battleground_id;if(r){var t=BATTLEGROUNDS[r];if(a=Number(a)-1,!t.starting_level||Number(t.starting_level)<=a){if(t.scale_with_level){t=JSON.parse(JSON.stringify(t));for(var s=a-Number(t.starting_level),l=0;l<t.effect.length;l++){var d=t.effect[l];d.mult=d.base_mult+d.mult*s}}v(e,t,"cpu")}}}}(d,r,t):s&&function(e,n,a){var i=RAIDS[n].bge;if(i){var r=BATTLEGROUNDS[i];if(r&&Number(a)>=Number(r.starting_level))for(var t=r.enemy_only,s=0;s<r.effect.length;s++){var l=r.effect[s],d=l.effect_type;if("skill"===d){if(r.scale_with_level)var o=r.scale_with_level*(a-r.starting_level+1);else var o=1;var u=c.makeBattleground(r.name,l,o);u.enemy_only=t,e.onTurn.push(u)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(d)){var u=p(r.name,l);u.enemy_only=t,e.onCreate.push(u)}else if(0<=["scale_attack","scale_health"].indexOf(d)){var u=f(r.name,l);u.enemy_only=t,e.onCreate.push(u)}else if("trap_card"===d){var u=m(r.name,l);u.enemy_only=t,e.onCardPlayed.push(u)}}}}(d,s,l);return d}};function p(e,n){return{name:e,modifierType:n.effect_type,effects:[n]}}function f(e,n){return{name:e,modifierType:"scale_stat",scaledStat:n.effect_type.replace("scale_",""),effects:[n]}}var a,i,l=((a=function(e,n){this.p=null,this.name=e,this.effect=n,this.runes=[]}).prototype={onCardPlayed:function(e){SIMULATOR.onPlaySkills[this.effect.id](this,e,this.effect)},isCommander:function(){return!1},isAssault:function(){return!1}},function(e,n){return new a(e,n)}),m=((i=function(e,n){this.name=e,this.id=n.id,this.base=n.base,this.mult=n.mult,this.target_deck=n.target_deck,this.y=n.y}).prototype={onCardPlayed:function(e,n,a){var i="opponent"===this.target_deck?a:n;if(e.isInFaction(this.y)){for(var r=[],t=0;t<i.length;t++)(e=i[t]).trap||r.push(e);if(r.length){var s=Math.ceil(e[this.base]*this.mult),l=unitInfo.create(this.id,s),d=c.byId(l);r[~~(Math.random()*r.length)].trap=d,u.enabled&&u.appendLines(this.name+" inserts "+o.name(d)+" into the opposing deck.")}}}},function(e,n){return new i(e,n)});function v(e,n,a){for(var i=0;i<n.effect.length;i++){var r=n.effect[i],t=r.effect_type;if("skill"===t){var s=c.makeBattleground(n.name,r);"player"===a&&(s.ally_only=!0),"cpu"===a&&(s.enemy_only=!0),e.onTurn.push(s)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(t)){s=p(n.name,r);"player"===a&&(s.ally_only=!0),"cpu"===a&&(s.enemy_only=!0),e.onCreate.push(s)}else if(0<=["scale_attack","scale_health"].indexOf(t)){s=f(n.name,r);"player"===a&&(s.ally_only=!0),"cpu"===a&&(s.enemy_only=!0),e.onCreate.push(s)}else if("trap_card"===t){s=m(n.name,r);"player"===a&&(s.ally_only=!0),"cpu"===a&&(s.enemy_only=!0),e.onCardPlayed.push(s)}else if("on_play"===t){(s=l(n.name,r.effect)).attacker=r.attacker,s.defender=r.defender,s.first_play=r.first_play,"player"===a&&(s.ally_only=!0),"cpu"===a&&(s.enemy_only=!0),e.onCardPlayed.push(s)}}}function h(e,n,a){if(!n)return null;for(var i=n.split(","),r=0;r<i.length;r++){var t=i[r];v(e,BATTLEGROUNDS[t],a)}}return e}),define("loadDeck",["cardInfo","cardApi","unitInfo"],function(o,L,e){"use strict";function y(e){for(var n=function(e){for(var n,a=e.id;n=a,void 0!==(a=REVERSE_FUSIONS[n]););return n}(e),a=-1;void 0!==n;)a++,n=FUSIONS[n];return a}function k(e,n,a){if(n=parseInt(n),e.mastery_level&&n<parseInt(e.mastery_level))return null;if(e.remove_mastery_level&&n>=parseInt(e.remove_mastery_level))return null;var i=e.id,r=!1;i||(i=function(e){var n=[];for(var a in CARDS)if(!REVERSE_FUSIONS[a]){var i=CARDS[a];if("1"!=i.card_type&&!(e.max_rarity&&Number(e.max_rarity)<Number(i.rarity)||e.min_rarity&&Number(e.min_rarity)>Number(i.rarity))&&(!e.type||e.type==i.type||0<=i.sub_type.indexOf(e.type.toString()))){if(e.set&&e.set.split(",").indexOf(i.set)<0)continue;n.push(a)}}return n[~~(Math.random()*n.length)]}(e),r=!0);var t=e.level||1;if(a<=n)t=7,u(i)&&(i=c(i));else if(1<n&&o.isCommander(i)){var s=(Number(o.loadCard(i).rarity)+1)/(a-1),l=n-1;t=Math.ceil(s*l)}var d=e.create(i,t);return r&&(d.randomInfo={unitInfo:e,level:n,maxedAt:a}),d}function _(e){var n=parseInt(o.loadCard(e.id).rarity)+2;if(e.level==n){if(!u(e.id))return!1;e.id=c(e.id,1),e.level=1}else e.level++;return!0}function u(e){return!(-1<t.indexOf(e))&&(!o.isCommander(e)&&!!FUSIONS[e])}function c(e,n){if(-1==t.indexOf(e))if(n)for(var a=0;a<n;a++)e=r(e);else do{var i=r(e);e=i}while(e!==i);return e}function r(e){var n=FUSIONS[e];return n||e}var t=["8005","8006","8007","8008","8009","8010"];function s(e,n,a){var i=a+1;n||(n=i);var r=[];r.deck=[];var t=function(e,n){n=parseInt(n);var a=e.commander;if(a.card){for(var i=[],r=0;r<a.card.length;r++){var t=a.card[r],s=parseInt(t.min_mastery_level)||0,l=parseInt(t.max_mastery_level)||999;s<=n&&n<=l&&i.push(t)}(a=i[~~(Math.random()*i.length)]).possibilities=i}return a}(e,n),s=k(t,n,i);t.possibilities&&(s.randomInfo={possibilities:t.possibilities,level:n,maxedAt:i}),r.commander=s;var l=e.deck,d=r.deck;for(var o in l){var u=k(l[o],n,i);u&&d.push(u)}var c,p,f,m,v=function(e){for(var n=0,a=0;a<e.length;a++){var i=e[a],r=L.byId(i);n+=(y(r)+1)*r.maxLevel-1}return n}(d),h=(c=n,f=v,m=7==(p=i)?(c-1)/(p-1):c/p,Math.ceil(f*m));if(1<n&&n<i)for(var g=d.slice();0<h&&0<g.length;){var b=Math.floor(Math.random()*g.length);_(g[b])?h--:g.splice(b,1)}return r}function a(e){for(var n=[],a=0,i=e.length;a<i;a++)n[a]=e[a];return n}return{mission:function(e,n){var a=MISSIONS[e];return a?s(a,n,6):0},raid:function(e,n,a){a||(a=25);var i=RAIDS[e];{if(i){var r={commander:i.commander,deck:i.deck.card};return s(r,n,Number(i.upgradeLevels))}return 0}},defaultDeck:function(){return{commander:e.defaultCommander,deck:[]}},copyCardList:a,copyDeck:function(e){var n={};return n.commander=e.commander,n.deck=a(e.deck),n},getDeckCards:function(e,n){var a={};a.commander=L.byId(e.commander),a.deck=[];for(var i=e.deck,r=SIMULATOR.battlegrounds.onCreate.filter(function(e){return!("player"===n&&e.enemy_only||"cpu"===n&&e.ally_only)}),t=0,s=i.length;t<s;t++)a.deck.push(L.byIdWithBgeApplied(i[t],r));return a}}}),define("simController",["matchTimer","debugLog","animations","ui"],function(i,_,A,S){"use strict";var r={getConfiguration:function(){var e=$("#deck1").val(),n=$("#ordered").is(":checked"),a=$("#exactorder").is(":checked"),i=$("#deck2").val(),r=$("#campaign").val(),t=$("#mission").val(),s=$("#mission_level").val(),l=$("#raid").val(),d=$("#raid_level").val(),o=$("#ordered2").is(":checked"),u=$("#exactorder2").is(":checked"),c=$("#surge").is(":checked"),p=$("#siege").is(":checked"),f=$("#tower_level").val(),m=$("#tower_type").val(),v="",h="",g="",b="";BATTLEGROUNDS&&(v=S.getSelectedBattlegrounds(),h=S.getSelectedBattlegrounds("self-"),g=S.getSelectedBattlegrounds("enemy-"),b=t?S.getSelectedMapBattlegrounds():"");var L=$("#sims").val()||1;_.enabled=$("#debug").is(":checked"),(play_debug=_.enabled&&$("#play_debug").is(":checked"))&&(_.enabled=!1);if(mass_debug=$("#mass_debug").is(":checked"),win_debug=$("#win_debug").is(":checked"),loss_debug=$("#loss_debug").is(":checked"),A.areShown=$("#animations").is(":checked"),$("#auto_mode").length){var y=$("#auto_mode").is(":checked");SIMULATOR.user_controlled=!y}var k=$("#tournament").is(":checked");return{playerHash:e,playerOrdered:n,playerExactOrder:a,cpuHash:i,selectedCampaign:r,selectedMission:t,missionLevel:s,selectedRaid:l,raidLevel:d,cpuOrdered:o,cpuExactOrder:u,surgeMode:c,siegeMode:p,towerLevel:f,towerType:m,selectedBges:v,selfbges:h,enemybges:g,mapbges:b,simsToRun:L,play_debug:play_debug,mass_debug:mass_debug,win_debug:win_debug,loss_debug:loss_debug,auto_mode:y,tournamentMode:k,pvpAI:!1}},debug_end:function(e){var n,e=r.processSimResult();SIMULATOR.remainingSims=0,i.stop();var a="";SIMULATOR.config.cpuHash&&(a=" ("+SIMULATOR.calculatePoints()+" points)");n="draw"===e?"<br><h1>DRAW"+a+"</h1><br>":e?"<br><h1>WIN"+a+"</h1><br>":"<br><h1>LOSS"+a+"</h1><br>";S.displayTurns(),S.setSimStatus(n),S.show(),SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(SIMULATOR.simulation_turns);r.endSimsCallback&&r.endSimsCallback()},endSimsCallback:null,stop_sims_callback:null};return window.SIM_CONTROLLER=r}),function(){"use strict";var n=require("bgeApi"),s=require("matchTimer"),e=require("urlHelpers"),l=require("debugLog"),d=require("simController"),o=require("ui"),u=require("matchStats");function c(e){if(SIMULATOR.user_controlled)p(e,!0)&&d.debug_end();else if(!l.enabled&&!play_debug||mass_debug||loss_debug||win_debug)if(0<SIMULATOR.remainingSims){if(m<=f){var n=0;if(0<m){f=0;var a=s.elapsed(),i=s.batchElapsed();n=0===i?0:m/i,o.setSimStatus("Running simulations...",a,n.toFixed(1)),o.showWinrate()}(m=1)<n&&(m=Math.ceil(n/8)),m>SIMULATOR.remainingSims&&(m=SIMULATOR.remainingSims),(l.enabled||play_debug)&&(mass_debug||loss_debug||win_debug)&&(m=1),s.startBatch(),current_timeout=setTimeout(c,1,e);for(var r=0;r<m;r++)p(e)}}else{m=f=0,s.stop();a=s.elapsed();var t=u.matchesPlayed/a;t=t.toFixed(2),o.displayText(l.getLog()),o.setSimStatus("Simulations complete.",a,t),o.showWinrate(),o.show(),d.endSimsCallback&&d.endSimsCallback()}else p(e,!0),d.debug_end()}d.startsim=function(){u.totalTurns=0,s.reset(),l.clear(),u.matchesPlayed=0,m=0;var e=d.getConfiguration();return SIMULATOR.battlegrounds=n.getBattlegrounds(e.getbattleground,e.selfbges,e.enemybges,e.mapbges,e.selectedCampaign,e.missionLevel,e.selectedRaid,e.raidLevel),o.hide(),SIMULATOR.remainingSims=e.simsToRun,SIMULATOR.setupDecks(e),u.matchesWon=0,u.matchesLost=0,u.matchesDrawn=0,u.totalPoints=0,o.displayText(""),SIMULATOR.user_controlled?o.setSimStatus(""):(o.hideTable(),o.setSimStatus("Initializing simulations...")),window.ga("send","event","simulation","start","single-threaded",e.simsToRun),current_timeout=setTimeout(c,0,e),!1},d.stopsim=function(){s.stop();var e=s.elapsed(),n=u.matchesPlayed/e;n=n.toFixed(2),SIMULATOR.simulating=!1,current_timeout&&clearTimeout(current_timeout),SIMULATOR.user_controlled||(o.setSimStatus("Simulations interrupted.",e,n),o.showWinrate()),o.show(),d.stop_sims_callback&&d.stop_sims_callback()};var a=e.paramValue("seedtest")||0;function p(e,n){if(a&&Math.seedrandom(a++),!SIMULATOR.simulate(e))return!1;n||d.processSimResult()}d.processSimResult=function(){var e;return e=!!SIMULATOR.field.player.commander.isAlive()&&(!SIMULATOR.field.cpu.commander.isAlive()||"draw"),0<m&&(0<SIMULATOR.remainingSims&&SIMULATOR.remainingSims--,f++),"draw"===e?u.matchesDrawn++:e?u.matchesWon++:u.matchesLost++,u.totalPoints+=SIMULATOR.calculatePoints(),u.matchesPlayed++,u.totalTurns+=SIMULATOR.simulation_turns,(l.enabled||play_debug)&&(loss_debug?"draw"===e?(l.prependLines("Draw found after "+u.matchesPlayed+" games. Displaying debug output...",""),l.appendLines("","<h1>DRAW</h1>"),SIMULATOR.remainingSims=0):e?(l.clear(),SIMULATOR.remainingSims||l.appendLines("No losses found after "+u.matchesPlayed+" games. No debug output to display.")):(l.prependLines("Loss found after "+u.matchesPlayed+" games. Displaying debug output...",""),l.appendLines("","<h1>LOSS</h1>"),SIMULATOR.remainingSims=0):win_debug?e&&"draw"!==e?(l.prependLines("Win found after "+u.matchesPlayed+" games. Displaying debug output...",""),l.appendLines("","<h1>WIN</h1>"),SIMULATOR.remainingSims=0):(l.clear(),SIMULATOR.remainingSims||l.appendLines("No wins found after "+u.matchesPlayed+" games. No debug output to display.")):mass_debug&&(l.appendLines(""),"draw"===e?l.appendLines("<h1>DRAW</h1>"):e?l.appendLines("<h1>WIN</h1>"):l.appendLines("<h1>LOSS</h1>")),mass_debug&&SIMULATOR.remainingSims&&l.appendLines("","<hr>NEW BATTLE BEGINS<hr>")),e};var f=0,m=0}();var SIMULATOR={};!function(){var n,i,r,t,M=require("log"),s=require("cardApi"),l=require("skillApi"),a=require("base64"),O=require("unitInfo"),u=require("loadDeck"),R=require("debugLog"),U=require("animations"),d=require("simController"),f=require("ui"),o=(require("config"),100);function c(e,n,a,i){var r=se[n].assaults;if(!e.id)return 0;var t=r.length;if(O.initializeUnit(e,n,t),e.played=!0,e.isAssault()&&(r[t]=e),!R.enabled&&!play_debug||i||R.appendLines(M.name(se[n].commander)+" plays "+M.name(e)),e.isTrap())g(e),N(e);else for(var s=0;s<re.onCardPlayed.length;s++){var l=re.onCardPlayed[s],d="player"===n?"cpu":"player",o=SIMULATOR.config.surgeMode;if(l.defender){if(!o&&"cpu"!==n)continue;if(o&&"player"!==n)continue;l.owner=d}else if(l.attacker){if(!o&&"player"!==n)continue;if(o&&"cpu"!==n)continue;l.owner=n}else{if(l.enemy_only&&"cpu"!==n)continue;if(l.ally_only&&"player"!==n)continue;l.owner=n}1<a&&l.first_play||l.onCardPlayed(e,te[n].deck,te[d].deck)}U.areShown&&U.drawField(se,null,null,a)}function h(e){for(var n=se[e].assaults,a=0,i=n.length;a<i;a++){var r=n[a];if(!r.isAlive()){R.enabled&&R.appendLines(M.name(r)+" <strong>is removed from field</strong>");var t=a;for(a++;a<i;a++)(r=n[a]).isAlive()?(n[r.key=t]=r,t++):R.enabled&&R.appendLines(M.name(r)+" <strong>is removed from field</strong>");n.length=t;break}}}function L(e){return[e[~~(Math.random()*e.length)]]}function y(e){return e.owner}function b(e){return"cpu"==e.owner?"player":"player"==e.owner?"cpu":void 0}function E(e,n,a,i,r){a>=n.health_left?n.health_left=0:n.health_left-=a,R.enabled&&r(e,n,a),i&&x(n),!n.isAlive()&&e&&C(n,e)}function x(e){var n=e.barrier_ice,a=se[b(e)],i=a.assaults[e.key];i&&i.isAlive()||(i=a.commander),E(e,i,n,null,function(e,n,a){R.append(M.name(e)+"'s barrier shatters and hits "+M.name(n)+" for "+a+" damage"),R.appendLines(n.isAlive()?"":" and it dies")})}function p(e,n){return e[n]||m}function m(e,n){if(R.enabled){var a=SKILL_DATA[n.id]?SKILL_DATA[n.id].name:n.id;R.appendLines(M.name(e)+" attempts to use "+a+", but it is not implemented.")}return 0}function g(e){var n=e.earlyActivationSkills,a=n.length;if(a)if(e.silenced)R.enabled&&R.appendLines(M.name(e)+" is silenced and cannot use skills");else{var i=e.dualstrike_triggered;R.enabled&&i&&R.appendLines(M.name(e)+" activates dualstrike");for(var r=i?2:1,t=k(e),s=0;s<r;s++)for(var l=0;l<a&&t();l++){var d=n[l];if(!d.countdown){var o=p(T,d.id)(e,d);d.c&&0<o&&(d.countdown=d.c),U.areShown&&U.drawField(se,null,null,ue,e)}}}}function v(){return!0}function k(e){return e.isAlive?e.isAlive.bind(e):v}function C(e,n){if(!e.ondeath_triggered){var a=e.onDeathSkills,i=a.length;if(0!=i){for(var r=0;r<i;r++){var t=a[r];B[t.id](e,n,t),U.areShown&&U.drawField(se,null,null,ue,e)}e.ondeath_triggered=!0}}}var _=["backlash","counter","counterburn","counterpoison","armored","evade","stasis"];function A(e){return-1===_.indexOf(e)}function S(e,n){if(e.isAssault()&&n.isAlive()){var a=n.backlash;ie(e,n,"Backlash",a,O.getEnhancement(n,"backlash",a))}}function D(e){return e.isActive()&&e.isUnjammed()?0:e.stasis||0}var w={burnself:function(e,n){var a=n.x;return e.scorched?(e.scorched.amount+=a,e.scorched.timer=2):e.scorched={amount:a,timer:2},R.enabled&&R.appendLines(M.name(e)+" inflicts scorch("+a+") on itself"),1},scorchbreath:function(e,n){return w.burn(e,n)},burn:function(e,n){var a,i=b(e),r=se[i].assaults;switch(n.id){case"scorchbreath":var t=Math.max(0,e.key-1),s=Math.min(r.length,e.key+2);a=r.slice(t,s);break;case"burnself":a=[e];break;default:a=r.slice(e.key,e.key+1)}if(!a.length)return 0;var l=n.x;l+=O.getEnhancement(e,"burn",l);for(var d=0,o=0;o<a.length;o++){var u=a[o];u.scorched?(u.scorched.amount+=l,u.scorched.timer=2):u.scorched={amount:l,timer:2},R.enabled&&R.appendLines(M.name(e)+" inflicts scorch("+l+") on "+M.name(u)),d++}return d},protect_ice:function(e,n){return w.protect(e,n,"barrier_ice")},protect_seafolk:function(e,n){return w.protect(e,n,null,null,!0)},evadebarrier:function(e,n){return w.protect(e,n,"invisible",function(e,n){return" and imbues it with invisible "+n})},protect:function(e,n,a,i,r){for(var t=n.y,s=y(e),l=n.x,d=n.all,o=se[s].assaults,u=[],c=0,p=o.length;c<p;c++){!(v=o[c]).isAlive()||!v.isInFaction(t)||r&&v.isActive()||u.push(c)}if(!u.length)return 0;d||(u=L(u));var f=O.getEnhancement(e,n.id,l);l+=f;var m=0;for(c=0,p=u.length;c<p;c++){var v;if((v=o[u[c]]).nullified)v.nullified--,R.enabled&&R.appendLines(M.name(e)+" protects "+M.name(v)+" but it is nullified!");else{m++;var h=l;if(!h){var g=n.mult;v.isActive()||(g+=n.on_delay_mult||0),h=Math.ceil(v.health*g)}if(v.protected+=h,a&&(v[a]=(v[a]||0)+h),R.enabled){f&&R.appendLines("<u>(Enhance: +"+f+")</u>");var b=M.name(e)+" barriers "+M.name(v)+" by "+h;"function"==typeof i&&(b+=i(v,h)),R.appendLines(b)}}}return m},heal:function(e,n){for(var a=y(e),i=n.y,r=n.x,t=n.all,s=se[a].assaults,l=[],d=0,o=s.length;d<o;d++){(p=s[d]).isAlive()&&p.isInFaction(i)&&(t||p.isDamaged())&&l.push(d)}if(!l.length)return 0;t||(l=L(l));var u=O.getEnhancement(e,n.id,r);r+=u;var c=0;for(d=0,o=l.length;d<o;d++){var p;if((p=s[l[d]]).nullified)p.nullified--,R.enabled&&R.appendLines(M.name(e)+" heals "+M.name(p)+" but it is nullified!");else{c++;var f=r;if(!f){var m=n.mult;f=Math.ceil(p.health*m)}f>p.health-p.health_left&&(f=p.health-p.health_left),p.health_left+=f,R.enabled&&(u&&R.appendLines("<u>(Enhance: +"+u+")</u>"),R.appendLines(M.name(e)+" heals "+M.name(p)+" by "+f))}}return c},poisonstrike:function(e,n,a){return w.strike(e,n,!0)},strike:function(e,i,n){for(var a=b(e),r=i.x,t=i.y,s=i.all,l=se[a].assaults,d=[],o=0,u=l.length;o<u;o++){(f=l[o]).isAlive()&&f.isInFaction(t)&&d.push(o)}if(!d.length)return 0;s||(d=L(d));var c=O.getEnhancement(e,i.id,r);r+=c;var p=0;for(o=0,u=d.length;o<u;o++){var f;if((f=l[d[o]]).invisible)f.invisible--,R.enabled&&R.appendLines(M.name(e)+" bolts "+M.name(f)+" but it is invisible!");else{p++;var m=r,v=X(f,m);m=v.damage;var h=v.shatter,g=0;0<m&&n&&f.isAlive()&&r>f.poisoned&&(g=r,f.poisoned=g),E(e,f,m,h,function(e,n,a){R.appendLines("<u>(Strike: +"+i.x),c&&R.appendLines(" Enhance: +"+c),R.appendLines(v.echo),R.appendLines(") = "+a+" damage</u>"),R.appendLines(M.name(e)+" bolts "+M.name(n)+" for "+a+" damage"),n.isAlive()?g&&R.appendLines(" and inflicts poison("+g+") on it"):R.appendLines(" and it dies"),R.appendLines("")}),f.backlash&&S(e,f)}}return p},intensify:function(e,n,a){for(var i=b(e),r=n.x,t=n.y,s=n.all,l=se[i].assaults,d=[],o=0,u=l.length;o<u;o++){(p=l[o]).isAlive()&&p.isInFaction(t)&&(p.scorched||p.poisoned)&&d.push(o)}if(!d.length)return 0;s||(d=L(d)),r+=O.getEnhancement(e,n.id,r);var c=0;for(o=0,u=d.length;o<u;o++){var p,f=(p=l[d[o]]).scorched?"scorch":"";f+=p.poisoned?f?" and poison":"poison":"",p.invisible?(p.invisible--,R.enabled&&R.appendLines(M.name(e)+" intensifies "+f+" on "+M.name(p)+" but it is invisible!")):(c++,p.scorched&&(p.scorched.amount+=r),p.poisoned&&(p.poisoned+=r),R.enabled&&R.appendLines(M.name(e)+" intensifies "+f+" on "+M.name(p)+" by "+r),p.backlash&&S(e,p))}return c},ignite:function(e,n,a){for(var i=b(e),r=(n.x,n.y),t=(n.all,se[i].assaults),s=[],l=0,d=t.length;l<d;l++){var o=t[l];o.isAlive()&&o.isInFaction(r)&&s.push(l)}return I(e,n,"ignites",s,t,function(e,n){e.scorch(n)})},jamself:function(e,n){return e.jammed=!0,e.jammedSelf=!0,R.enabled&&R.appendLines(M.name(e)+" freezes itself"),1},jam:function(e,n){y(e);for(var a=b(e),i=n.all,r=se[a].assaults,t=[],s=0,l=r.length;s<l;s++){(o=r[s]).isAlive()&&(i||o.isActiveNextTurn()&&o.isUnjammed())&&t.push(s)}if(!t.length)return 0;i||(t=L(t));var d=0;for(s=0,l=t.length;s<l;s++){var o;(o=r[t[s]]).invisible?(o.invisible--,n.countdown=0,R.enabled&&R.appendLines(M.name(e)+" freezes "+M.name(o)+" but it is invisible!")):(d++,o.jammed=!0,R.enabled&&R.appendLines(M.name(e)+" freezes "+M.name(o)),o.backlash&&S(e,o))}return d},frost:function(e,i){y(e);var n=b(e),a=i.x,r=O.getEnhancement(e,i.id,a);a+=r;i.all;for(var t=se[n].assaults,s=[],l=e.key-1,d=l+2;l<=d;l++){(p=t[l])&&p.isAlive()&&s.push(l)}if(!s.length)return 0;for(var o=0,u=0,c=s.length;u<c;u++){var p;if((p=t[s[u]]).invisible)p.invisible--,R.enabled&&R.appendLines(M.name(e)+" breathes frost at "+M.name(p)+" but it is invisible!");else{o++;var f=a,m=X(p,f);E(e,p,f=m.damage,m.shatter,function(e,n,a){R.appendLines("<u>(Frostbreath: +"+i.x),r&&R.appendLines(" Enhance: +"+r),R.appendLines(m.echo),R.appendLines(") = "+a+" damage</u>"),R.appendLines(M.name(e)+" breathes frost at "+M.name(n)+" for "+a+" damage"),R.appendLines(n.isAlive()?"":" and it dies")}),p.backlash&&S(e,p)}}return o},heartseeker:function(e,n){var a=b(e),i=n.x,r=se[a].assaults[e.key];return r?(i+=O.getEnhancement(e,n.id,i),r.heartseeker+=i,r.enfeebled+=i,R.enabled&&R.appendLines(M.name(e)+" inflicts heartseeker "+i+" on "+M.name(r)),1):0},enfeeble:function(e,n){for(var a=n.y,i=b(e),r=se[i].assaults,t=[],s=0,l=r.length;s<l;s++){var d=r[s];d.isAlive()&&d.isInFaction(a)&&t.push(s)}return I(e,n,"hexes",t,r,function(e,n){e.enfeebled+=n})},weakenself:function(e,n){return w.weaken(e,n)},weaken:function(e,n){var a,r=n.y;switch(n.id){case"weakenself":a=y(e);break;default:a=b(e)}var t=n.all,s=se[a].assaults,l=[],i=function(e){for(var n=0,a=s.length;n<a;n++){var i=s[n];i.isAlive()&&i.isInFaction(r)&&(t||i.isActiveNextTurn()&&i.isUnjammed()&&(e||i.hasAttack()))&&l.push(n)}};i(!1),l.length||i(!0);return I(e,n,"weakens",l,s,function(e,n){e.attack_weaken+=n})}};function I(e,n,a,i,r,t){if(!i.length)return 0;var s=O.getEnhancement(e,n.id,n.x),l=n.x+s;n.all||(i=L(i));for(var d=0,o=0,u=i.length;o<u;o++){var c=r[i[o]];c.invisible?(c.invisible--,R.enabled&&R.appendLines(M.name(e)+" "+a+" "+M.name(c)+" but it is invisible!")):(d++,t(c,l),R.enabled&&(s&&R.appendLines("<u>(Enhance: +"+s+")</u>"),R.appendLines(M.name(e)+" "+a+" "+M.name(c)+" by "+l)),c.backlash&&S(e,c))}return d}var T={enlarge:function(e,n){var a=n.y,i=y(e),r=n.x,t=O.getEnhancement(e,n.id,r);r+=t;for(var s=n.all,l=se[i].assaults,d=[],o=0,u=l.length;o<u;o++){(p=l[o]).isAlive()&&p.isInFaction(a)&&(s||p.isUnjammed()&&p.isActive())&&d.push(o)}if(!d.length)return 0;s||(d=L(d));var c=0;for(o=0,u=d.length;o<u;o++){var p=l[d[o]],f=r;if(!f){var m=n.mult;f=Math.ceil(p.attack*m)}p.attack_rally+=f,R.enabled&&(t&&R.appendLines("<u>(Enhance: +"+t+")</u>"),R.appendLines(M.name(e)+" enlarges "+M.name(p)+" by "+f)),c++}return c},rally:function(e,n){for(var a=n.y,i=y(e),r=n.x,t=n.all,s=se[i].assaults,l=[],d=0,o=s.length;d<o;d++){(p=s[d]).isAlive()&&p.isInFaction(a)&&(t||p.isActive()&&p.isUnjammed())&&l.push(d)}if(!l.length)return 0;t||(l=L(l));var u=O.getEnhancement(e,n.id,r);r+=u;var c=0;for(d=0,o=l.length;d<o;d++){var p;if((p=s[l[d]]).nullified)p.nullified--,R.enabled&&R.appendLines(M.name(e)+" empowers "+M.name(p)+" but it is nullified!");else{c++;var f=r;if(!f){var m=n.mult;f=Math.ceil(p.attack*m)}p.attack_rally+=f,R.enabled&&(u&&R.appendLines("<u>(Enhance: +"+u+")</u>"),R.appendLines(M.name(e)+" empowers "+M.name(p)+" by "+f))}}return c},legion:function(e,n){var a=y(e),i=se[a].assaults,r=n.x,t=O.getEnhancement(e,n.id,r);r+=t;var s=n.y,l=e.key-1,d=l+2;l<0&&(l+=2);for(var o=0;l<=d;){var u=i[l];u&&u.isActive()&&u.isInFaction(s)&&(u.nullified?(u.nullified--,R.enabled&&R.appendLines(M.name(e)+" activates legion and empowers "+M.name(u)+" but it is nullified!")):(o++,u.attack_rally+=r,R.enabled&&(t&&R.appendLines("<u>(Enhance: +"+t+")</u>"),R.appendLines(M.name(e)+" activates legion and empowers "+M.name(u)+" by "+r)))),l+=2}return o},fervor:function(e,n){var a=y(e),i=se[a].assaults,r=n.x,t=O.getEnhancement(e,n.id,r);r+=t;var s=n.y,l=0,d=e.key-1,o=d+2;for(d<0&&(d+=2);d<=o;){var u=i[d];u&&u.isInFaction(s)&&(l+=r),d+=2}return l?(e.attack_rally+=l,R.enabled&&(t&&R.appendLines("<u>(Enhance: +"+t+")</u>"),R.appendLines(M.name(e)+" activates fervor for "+l)),1):0},barrage:function(e,n){var a=b(e),i=n.x,r=n.y,t=n.all,s=se[a].assaults;i+=O.getEnhancement(e,n.id,i);for(var l=0;l<i;l++){for(var d=[],o=0,u=s.length;o<u;o++){(p=s[o]).isAlive()&&p.isInFaction(r)&&d.push(o)}if(!d.length)return 0;t||(d=L(d));var c=0;for(o=0,u=d.length;o<u;o++){var p;if((p=s[d[o]]).invisible)p.invisible--,R.enabled&&R.appendLines(M.name(e)+" throws a bomb at "+M.name(p)+" but it is invisible!");else{c++;var f=1,m=X(p,f,{enfeeble:!0});E(e,p,f=m.damage,m.shatter,function(e,n,a){R.appendLines("<u>(Barrage: +1"),R.appendLines(m.echo),R.appendLines(") = "+a+" damage</u>"),R.appendLines(M.name(e)+" throws a bomb at "+M.name(n)+" for "+a+" damage"),R.appendLines(n.isAlive()?"":" and it dies")})}}}return c},enhance:function(e,n){for(var a=n.y,i=y(e),r=(b(e),n.x),t=(a=n.y,n.s),s=n.mult,l=n.all,d=se[i].assaults,o=A(t),u=[],c=0,p=d.length;c<p;c++){(m=d[c]).isAlive()&&m.isInFaction(a)&&(l||!o||m.isActive()&&m.isUnjammed())&&m.hasSkill(t)&&u.push(c)}if(!u.length)return 0;l||(u=L(u));var f=0;for(c=0,p=u.length;c<p;c++){var m;if((m=d[u[c]]).nullified)m.nullified--,R.enabled&&R.appendLines(M.name(e)+" enhances "+M.name(m)+" but it is nullified!");else{f++;var v=m.enhanced;0<r?(v[t]=(v[t]||0)+r,R.enabled&&R.appendLines(M.name(e)+" enhances "+t+" of "+M.name(m,!1)+" by "+r)):0<s&&(v[t]=-s,R.enabled&&R.appendLines(M.name(e)+" enhances "+t+" of "+M.name(m,!1)+" by "+100*s+"%"))}}return f},enrage:function(e,n){for(var a=y(e),i=n.y,r=n.x,t=n.all,s=se[a].assaults,l=[],d=0,o=s.length;d<o;d++){(p=s[d]).isAlive()&&p.isInFaction(i)&&l.push(d)}if(!l.length)return 0;t||(l=L(l));var u=O.getEnhancement(e,n.id,r);r+=u;var c=0;for(d=0,o=l.length;d<o;d++){var p,f=r;(p=s[l[d]]).nullified?(p.nullified--,R.enabled&&R.appendLines(M.name(e)+" enrages "+M.name(p)+" but it is nullified!")):(c++,n.mult&&(f=Math.ceil(n.mult*p.health)),p.enraged+=f,R.enabled&&(u&&R.appendLines("<u>(Enhance: +"+u+")</u>"),R.appendLines(M.name(e)+" enrages "+M.name(p)+" by "+f)))}return c},imbue:function(e,n){for(var a=n.y,i=y(e),r=(b(e),n.x),t=(n.c,n.s),s=n.all,l=se[i].assaults,d=A(t),o=[],u=0,c=l.length;u<c;u++){(f=l[u]).isAlive()&&f.isInFaction(a)&&(s||!d||f.isActive()&&f.isUnjammed())&&o.push(u)}if(!o.length)return 0;n={id:t,x:r};s||(o=L(o));var p=0;for(u=0,c=o.length;u<c;u++){var f;if((f=l[o[u]]).nullified)f.nullified--,R.enabled&&R.appendLines(M.name(e)+" enhances "+M.name(f)+" but it is nullified!");else if(p++,f.hasSkill(t)){var m=f.enhanced;m[t]=(m[t]||0)+r,R.enabled&&R.appendLines(M.name(e)+" imbues "+M.name(f,!1)+" existing "+M.skill(n)+" by "+r)}else f.imbue(n),R.enabled&&R.appendLines(M.name(e)+" imbues "+M.name(f,!1)+" with "+M.skill(n))}return p},mark:function(e,n){for(var a=n.y,i=(y(e),b(e)),r=n.x,t=n.all,s=se[i].assaults,l=e.mark_target,d=[],o=0,u=s.length;o<u;o++){if((p=s[o]).isAlive()&&p.isInFaction(a)){if(p.uid===l){d=[o];break}d.push(o)}}if(!d.length)return 0;t||(d=L(d)),r+=O.getEnhancement(e,n.id,r);var c=0;for(o=0,u=d.length;o<u;o++){var p;c++,(p=s[d[o]]).enfeebled+=r,e.mark_target=p.uid,R.enabled&&R.appendLines(M.name(e)+" marks "+M.name(p)+" by "+r),n.countdown=1}return c}},e={ambush:function(e,n,a){var i=a.x,r=a.base,t=a.mult,s=i;if(!s){t=a.mult;s=Math.ceil(n[r]*t)}return E(e,n,s,null,function(e,n,a){R.appendLines(M.name(e)+" ambushes "+M.name(n)+" for "+a+" damage"),R.appendLines(n.isAlive()?"":" and it dies")}),1},slow:function(e,n,a){var i=a.x,r=a.base,t=a.mult,s=i;if(!s){t=a.mult;s=Math.ceil(n[r]*t)}return n.timer+=s,R.enabled&&R.appendLines(M.name(e)+" slows "+M.name(n)+" by "+s),1}},B={unearth:function(e,n,a){if(!e.isToken){var i=O.create(a.card||e.id,a.level||a.x),r=s.byIdWithBgeApplied(i,null,!0);r.isToken=!0;var t=a.mult;return t&&(r.attack=Math.floor(e.attack*t),r.health=Math.floor(e.health*t)),c(r,e.owner,!0),R.enabled&&R.appendLines(M.name(r)+" is unearthed</br>"),1}},reanimate:function(e,n,a){return e.reanimated?0:(e.health_left=a.x,e.reanimated=!0,R.enabled&&R.appendLines(" and is reanimated</br>"),1)}};function N(e){if(e.silenced)R.enabled&&R.appendLines(M.name(e)+" is silenced and cannot use skills</br>");else for(var n=e.skill,a=k(e),i=0,r=n.length;i<r&&a();i++){var t=n[i];if(!t.countdown){var s=p(w,t.id)(e,t);t.c&&0<s&&(t.countdown=t.c),U.areShown&&U.drawField(se,null,null,ue,e)}}}function P(e){var n,a,i,r=e.length;if(0===r)return!1;for(;--r;)n=~~(Math.random()*(r+1)),a=e[r],i=e[n],e[r]=i,e[n]=a}function F(e,n){var l;U.clearFrames(),$(e,(l=n,function(e,n,a,i){if(e%2)var r=a,t=i;else var r=i,t=a;var s=te[r].deck;return c(s[l],r,e),H(s,l),closeDiv=!1,K(r,t,n,e),!0}))}function $(e,n){if(SIMULATOR.pause)return SIMULATOR.pause=!1;var a=function(e,n){var a,i,r=SIMULATOR.config.surgeMode;i=r?(a="cpu","player"):(a="player","cpu");if(0<e){if(!n(e,se,a,i,!1))return!1;if(!se.player.commander.isAlive()||!se.cpu.commander.isAlive())return!(de=!1)}else!r&&SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(e);for(e++;e<=o+1;e++){if(e===o+1)return!(de=!1);if(q(e,a,i,se),!W(e,se,a,i,!0,-1))return!1;if(!se.player.commander.isAlive()||!se.cpu.commander.isAlive())return de=!1,R.enabled&&R.appendLines("<u>Turn "+e+" ends</u><br><br></div>"),!0}return!(de=!1)}(e,n);return a&&oe&&d.debug_end(),a}function W(e,n,a,i,r,t){if(e%2)var s=a,l=i;else s=i,l=a;return closeDiv=!1,!!function(e,n,a,i){var r=te[e],t=r.deck,s=r.ordered;if(t[0]){SIMULATOR.waiting=!1;var l=0;if(1===t.length)l=0;else{for(var d=0;d<t.length;d++){var o=t[d];if(o.trap&&(c(o.trap,e,n),o.trap=!1),2===d)break}l=r.chooseCard(e,t,s,n,a,i)}if(l<0)return!1;c(t[l],e,n),H(t,l)}return!0}(s,e,r,t)&&(K(s,l,n,e),!0)}function j(e,n,a){var i=n[a];return i?e+" draws "+M.name(i,!0)+"<br/>":""}function q(e,n,a,i){if((le=e)%2)var r=n,t=a;else r=a,t=n;if(R.enabled){var s=M.name(i[r].commander),l=te[r].deck;R.appendLines('<div id="turn_"'+e+' class="turn-info"><hr/><br/><u>Turn '+e+" begins for "+s+"</u>"),e<=2&&(R.appendLines(j(s,l,0)),R.appendLines(j(s,l,1))),R.appendLines(j(s,l,2))}var d=i[r],o=i[t],u=d.assaults,c=o.assaults;ee(d.commander);for(var p=0,f=u.length;p<f;p++){var m=u[p];if(0<m.timer&&(3===e&&SIMULATOR.config.tournamentMode||(m.timer--,R.enabled&&R.appendLines(M.name(m)+" reduces its timer"))),m.valor){var v=c[p];v&&m.adjustedAttack()<v.adjustedAttack()?(m.attack_valor+=m.valor,R.enabled&&R.appendLines(M.name(m)+" activates valor, boosting its attack by "+m.valor)):R.enabled&&(R.appendLines(M.name(m)+" activates valor but "),v?R.appendLines("enemy is not strong enough."):R.appendLines("there is no opposing enemy."))}m.enfeebled=m.envenomed+m.heartseeker,m.enraged=0,m.invisible=0,m.protected=0,m.barrier_ice=0,m.warded=0,m.enhanced={},m.removeImbue(),ee(m)}}function H(e,n){for(var a=n,i=e.length-1;a<i;)e[a]=e[++a];e.length=a}function Q(e,n,a,i,r,t){if(0<=t)return t;var s=n.slice(0,3);closeDiv=!0;for(var l=[],d=[],o=0,u=s.length;o<u;o++){var c=s[o],p=o+": "+c.name;1<c.maxLevel&&(p+="{"+c.level+"/"+c.maxLevel+"}"),l.push(p),d.push(c)}return r&&(f.hideTable(),f.displayTurns(),U.drawField(se,d,F,i)),-1}function G(e,n,a,i,r){if(void 0===a)return 0;for(var t=n.slice(0,3),s=!1,l=0,d=a.length;l<d;l++){for(var o,u=a[l],c=u.priority,p=-1,f=0,m=t.length;f<m;f++){var v=(o=t[f]).priority;if(O.areEqual(u,o)){s=!0;break}0<c&&c==v&&(p=f)}if(!s&&0<=p&&(s=!0,o=t[f=p]),s){for(var h=a.length-1;l<h;l++)a[l]=a[l+1];return a.length=l,f}}return-1}function z(e,n,a,i,r){var t=n.slice(0,3);return~~(Math.random()*t.length)}function V(e,n,a,i,r){for(var t,s,l,d,o,u=n.slice(0,3),c=-1,p=-1,f=0;f<u.length;f++){var m=u[f],v=(void 0,s=(t=m).id.toString(),l=6*parseInt(t.rarity),d=3*(4<s.length?parseInt(s[0]):0),o=parseInt(t.level)-parseInt(t.maxLevel),l+d+o);p<v&&(p=v,c=f)}return c}function J(e,n,a,i,r){return 0}function K(e,n,a,i){for(var r=a[e],t=r.commander,s=r.assaults,l=a[n],d=l.commander,o=l.assaults,u=0;u<re.onTurn.length;u++){var c=re.onTurn[u];c.enemy_only&&"cpu"!==e||(c.ally_only&&"player"!==e||(c.owner=e,g(c),N(c)))}g(r.commander);for(var p=0,f=s.length;p<f;p++){Y(m=s[p],"evade","invisible"),Y(m,"absorb","warded")}!function(e){for(var n=e.assaults,a=0,i=n.length;a<i;a++){var r=n[a];if(r.isAlive()&&r.isActive()&&r.isUnjammed()){var t=r.flurry;t&&0===t.countdown&&r.hasAttack()&&(t.countdown=t.c,r.dualstrike_triggered=!0),g(r)}}}(r),N(t);for(p=0,f=s.length;p<f;p++){var m;if((m=s[p]).isAlive()&&m.isActive())if(m.jammed)R.enabled&&R.appendLines(M.name(m)+" is frozen and cannot attack");else{var v=1;for(m.dualstrike_triggered&&(v++,R.enabled&&R.appendLines(M.name(m)+" activates dualstrike"));0<v;v--)if(N(m),m.isAlive())if(m.hasAttack()){if(ae(m,o,d),!d.isAlive()||!t.isAlive())return;if(!m.isAlive())break}else R.enabled&&0<m.permanentAttack()&&R.appendLines(M.name(m)+" is weakened and cannot attack")}}!function(e){for(var n=0,a=e.length;n<a;n++){var i=e[n];if(i.jammedSelf?i.jammedSelf=!1:i.jammed=!1,i.attack_rally=0,i.attack_weaken=0,i.nullified=0,i.dualstrike_triggered=!1,i.silenced=!1,i.regenerate&&i.isDamaged()){var r=i.regenerate,t=O.getEnhancement(i,"regenerate",r);r+=t;var s=i.health-i.health_left;s<=r&&(r=s),i.health_left+=r,R.enabled&&R.appendLines(M.name(i)+" regenerates "+r+" health")}var l=i.poisoned;if(l){var d=i.warded;d&&(l-=Z(i,"warded",l)),E(null,i,l,null,function(e,n,a){R.appendLines(M.name(n)+" takes "+a),d&&R.appendLines(" (Poison: +"+i.poisoned+" Ward: -"+d+")"),R.appendLines(" poison damage"),R.appendLines(n.isAlive()?"":" and it dies")})}var l=i.envenomed;if(l){var d=i.warded;d&&(l-=Z(i,"warded",l)),E(null,i,l,null,function(e,n,a){R.appendLines(M.name(n)+" takes "+a),d&&R.appendLines(" (Venom: +"+i.envenomed+" Ward: -"+d+")"),R.appendLines(" venom damage"),R.appendLines(n.isAlive()?"":" and it dies")})}var o=i.scorched;if(o){l=o.amount;var d=i.warded;d&&(l-=Z(i,"warded",l)),E(null,i,l,null,function(e,n,a){R.appendLines(M.name(n)+" takes "+a),d&&R.appendLines(" (Scorch: +"+o.amount+" Ward: -"+d+")"),R.appendLines(" scorch damage"),n.isAlive()?n.scorched||R.appendLines(" and scorch wears off"):R.appendLines(" and it dies"),R.appendLines("")}),1<o.timer?o.timer--:i.scorched=0}var u=i.corroded;if(u)if(u.timer--,u.timer<0)i.corroded=!1,i.attack_corroded=0,R.enabled&&R.appendLines(M.name(i)+" recovers from corrosion");else{var c=u.amount;i.attack_corroded=c,R.enabled&&R.appendLines(M.name(i)+" loses "+c+" attack to corrosion")}i.isAlive()||C(i,null)}}(s),h("player"),h("cpu"),R.enabled&&R.appendLines("<u>Turn "+i+" ends</u><br><br></div>")}function Y(e,n,a){var i=0;e[n]&&(i=e[n],i+=O.getEnhancement(e,n,i));e[a]=i}function X(e,n,a){var i=(a=a||{}).enfeeble?0:e.enfeebled||0,r=a.stasis?0:D(e),t=a.protect?0:e.protected||0,s=a.ward?0:e.warded||0;n+=i-r;var l=!1;s&&(n-=Z(e,"warded",n)),t&&(n-=Z(e,"protected",n),0==e.protected&&(l=e.barrier_ice)),r&&(n-=r);return R.enabled&&(i&&R.appendLines(" Enfeeble: +"+i),r&&R.appendLines(" Stasis: -"+r),t&&R.appendLines(" Barrier: -"+t),s&&R.appendLines(" Ward: -"+s)),n<0&&(n=0),{damage:n,shatter:l,echo:""}}function Z(e,n,a){var i=e[n];return i<=a?(e[n]=0,i):(e[n]-=a,a)}function ee(e){ne(e,e.skill),ne(e,e.earlyActivationSkills);var n=e.flurry;n&&n.countdown&&(n.countdown--,R.enabled&&(n.countdown?R.appendLines(M.name(e)+" charges  dualstrike (ready in "+n.countdown+" turns)"):R.appendLines(M.name(e)+" readies dualstrike")))}function ne(e,n){for(var a=0,i=n.length;a<i;a++){var r=n[a];r.countdown&&(r.countdown--,R.enabled&&(r.countdown?R.appendLines(M.name(e)+" charges "+l.nameFromId(r.id)+" (ready in "+r.countdown+" turns)"):R.appendLines(M.name(e)+" readies "+l.nameFromId(r.id))))}}function ae(e,n,a){var i=n[e.key];if(i&&i.isAlive()){var r,t=!1;if(!i.taunt)if((r=n[e.key-1])&&r.taunt)i=r,t=!0;else(r=n[e.key+1])&&r.taunt&&(i=r,t=!0);t&&R.enabled&&R.appendLines(M.name(i)+" taunts "+M.name(e))}else i=a;var s=e.adjustedAttack(),l=i.enfeebled;s+=l,R.enabled&&(R.appendLines("<u>(Attack: +"+e.attack),e.attack_berserk&&R.appendLines(" Berserk: +"+e.attack_berserk),e.attack_valor&&R.appendLines(" Valor: +"+e.attack_valor),e.attack_rally&&R.appendLines(" Rally: +"+e.attack_rally),e.attack_weaken&&R.appendLines(" Weaken: -"+e.attack_weaken),e.attack_corroded&&R.appendLines(" Corrosion: -"+e.attack_corroded),l&&R.appendLines(" Enfeeble: +"+l));var d=e.pierce;d?d+=O.getEnhancement(e,"pierce",d):d=0;var o=i.protected,u=!1,c=i.armored,p=D(i);if(o&&(R.enabled&&R.appendLines(" Barrier: -"+o),d&&(o<=d?(R.enabled&&R.appendLines(" Pierce: +"+o),d-=o,o=0,i.protected=0):(R.enabled&&R.appendLines(" Pierce: +"+d),o-=d,i.protected-=d,d=0)),o&&(o<=s?(u=i.barrier_ice,s-=o,i.protected=0):(i.protected-=s,s=0))),p&&(p+=O.getEnhancement(i,"stasis",p),R.enabled&&R.appendLines(" Shroud: -"+p),d&&(p<d?(R.enabled&&R.appendLines(" Pierce: +"+p),p=0):(R.enabled&&R.appendLines(" Pierce: +"+d),p-=d)),s-=p),c&&(c+=O.getEnhancement(i,"armored",c),R.enabled&&R.appendLines(" Armor: -"+c),d&&(c<d?(R.enabled&&R.appendLines(" Pierce: +"+c),c=0):(R.enabled&&R.appendLines(" Pierce: +"+d),c-=d)),s-=c),s<0&&(s=0),R.enabled&&R.appendLines(") = "+s+" damage</u>"),E(e,i,s,null,function(e,n,a){R.appendLines(M.name(e)+" attacks "+M.name(n)+" for "+a+" damage"),R.appendLines(n.isAlive()?"":" and it dies")}),U.areShown&&U.drawField(se,null,null,ue,e),a.isAlive()){if(0<s&&i.isAssault()&&i.isAlive()){if(e.poison){var f=e.poison;(f+=O.getEnhancement(e,"poison",f))>i.poisoned&&(i.poisoned=f,R.enabled&&R.appendLines(M.name(e)+" inflicts poison("+f+") on "+M.name(i)))}if(e.venom){var m=e.venom;if((m+=O.getEnhancement(e,"venom",m))>i.envenomed){var v=m-i.envenomed;i.envenomed=m,i.enfeebled+=v,R.enabled&&R.appendLines(M.name(e)+" inflicts venom("+m+") on "+M.name(i))}}if(e.nullify){var h=e.nullify;h+=O.getEnhancement(e,"nullify",h),i.nullified+=h,R.enabled&&R.appendLines(M.name(e)+" inflicts nullify("+h+") on "+M.name(i))}if(e.silence&&(i.silenced=!0,R.enabled&&R.appendLines(M.name(e)+" inflicts silence on "+M.name(i))),e.daze){var g=e.daze;g+=O.getEnhancement(e,"daze",g),i.attack_weaken+=g,R.enabled&&R.appendLines(M.name(e)+" dazed "+M.name(i)+" for "+g)}}if(u&&x(i),0<s&&e.isAlive()){if(e.leech&&e.isDamaged()){var b=e.leech;b+=O.getEnhancement(e,"leech",b);var L=e.health-e.health_left;L<=b&&(b=L),e.health_left+=b,R.enabled&&R.appendLines(M.name(e)+" siphons "+b+" health")}if(e.reinforce){var y=e.reinforce;y+=O.getEnhancement(e,"reinforce",y),e.protected+=y,R.enabled&&R.appendLines(M.name(e)+" reinforces itself with barrier "+y)}if(i.counter){var k=0+i.counter;ie(e,i,"Vengance",k,O.getEnhancement(i,"counter",k))}if(i.counterburn){var _=i.counterburn||0;_+=O.getEnhancement(i,"counterburn",_),e.scorched?(e.scorched.amount+=_,e.scorched.timer=2):e.scorched={amount:_,timer:2},R.enabled&&R.appendLines(M.name(i)+" inflicts counterburn("+_+") on "+M.name(e))}if(i.counterpoison){f=i.counterpoison||0;(f+=O.getEnhancement(i,"counterpoison",f))>e.poisoned&&(e.poisoned=f,R.enabled&&R.appendLines(M.name(i)+" inflicts counterpoison("+f+") on "+M.name(e)))}if(i.fury){var A=i.fury,S=O.getEnhancement(i,"counter",A);if(i.isAlive()){var w=A+S;i.attack_berserk+=w,R.enabled&&R.appendLines(M.name(i)+" activates fury and gains "+w+" attack")}ie(e,i,"Fury",A,S)}if(0<i.enraged&&(i.attack_berserk+=i.enraged,R.enabled&&R.appendLines(M.name(i)+" is enraged and gains "+i.enraged+" attack!</br>")),e.berserk){var I=e.berserk;I+=O.getEnhancement(e,"berserk",I),e.attack_berserk+=I,R.enabled&&R.appendLines(M.name(e)+" activates berserk and gains "+I+" attack")}}if(i.corrosive){var T=i.corrosive||0;T+=O.getEnhancement(i,"corrosive",T),e.corroded?(e.corroded.amount+=T,e.corroded.timer=2):e.corroded={amount:T,timer:2},R.enabled&&R.appendLines(M.name(i)+" inflicts corrosion("+T+") on "+M.name(e)),e.attack_corroded=T,R.enabled&&R.appendLines(M.name(e)+" loses "+T+" attack to corrosion")}e.isAlive()||C(e,i),U.areShown&&U.drawField(se,null,null,ue,e)}}function ie(e,n,i,a,r){var t=a+r,s=X(e,t,{enfeeble:!0});t=s.damage;s.shatter;R.enabled&&(R.appendLines("<u>("+i+": +"+a),r&&R.appendLines(" Enhance: +"+r),R.appendLines(s.echo),R.appendLines(") = "+t+" damage</u>")),E(n,e,t,null,function(e,n,a){R.appendLines(M.name(n)+" takes "+a+" "+i.toLowerCase()+" damage"),R.appendLines(n.isAlive()?"":" and it dies")})}SIMULATOR.pause=!1;var re,te={},se={},le=0,de=!1,oe=!1,ue=0,ce=0,pe=0;SIMULATOR.simulate=function(e){var d,o;if(de=!0,function(e){SIMULATOR.config=e,SIMULATOR.simulation_turns=0;var n={cpu:{deck:[]},player:{deck:[]}};SIMULATOR.deck=n,SIMULATOR.field={cpu:{assaults:[]},player:{assaults:[]}},t&&(n.player=u.copyDeck(t)),e.selectedMission&&1<e.missionLevel&&e.missionLevel<7?(i=u.mission(e.selectedMission,e.missionLevel),r=u.getDeckCards(i,"cpu")):e.selectedRaid&&(i=u.raid(e.selectedRaid,e.raidLevel),r=u.getDeckCards(i,"cpu")),r&&(n.cpu=u.copyDeck(r)),e.playerOrdered&&!e.playerExactOrder&&(n.player.ordered=u.copyCardList(n.player.deck)),e.cpuOrdered&&!e.cpuExactOrder&&(n.cpu.ordered=u.copyCardList(n.cpu.deck)),n.player.chooseCard=oe?Q:e.playerOrdered?G:z,n.cpu.chooseCard=e.cpuOrdered?G:e.pvpAI?V:e.cpuExactOrder?z:J}(e),e.playerExactOrder?e.playerOrdered||(te.player.shuffleHand=!0):P(te.player.deck),e.cpuExactOrder?e.cpuOrdered||(te.cpu.shuffleHand=!0):P(te.cpu.deck),o=(d=se).uids={},["player","cpu"].forEach(function(e){for(var n=te[e],a=n.deck,i="player"===e?1:101,r=0;r<a.length;r++){var t=i+r,s=a[r];s.owner=e,s.played=!1,s.uid=t,o[t]=s}var l=n.commander;l.owner=e,l.health_left=l.health,l.reusableSkills||l.resetTimers();var t="player"===e?-1:-2;l.uid=t,o[t]=l,d[e].commander=l}),e.siegeMode){var n=BATTLEGROUNDS[e.towerType].effect[e.towerLevel];if(n){n=O.create(n.id,n.level);var a=s.byIdWithBgeApplied(n);a.uid=150,c(se.uids[150]=a,"cpu",-1,!0)}}return $(0)},SIMULATOR.setupDecks=function(e){n=e.playerHash?a.decodeHash(e.playerHash):u.defaultDeck(),t=u.getDeckCards(n,"player"),e.pvpAI=!0,e.cpuHash?(i=a.decodeHash(e.cpuHash),e.selectedMission&&(e.pvpAI=!1)):e.selectedMission?(i=u.mission(e.selectedMission,e.missionLevel),e.pvpAI=!1):e.selectedRaid?(i=u.raid(e.selectedRaid,e.raidLevel),e.pvpAI=!1):i=u.defaultDeck(),r=u.getDeckCards(i,"cpu")},SIMULATOR.onPlaySkills=e,SIMULATOR.calculatePoints=function(e){var n=se.uids,a={player:{total:0,taken:0},cpu:{total:0,taken:0}};for(var i in n){var r=n[i],t=a[r.owner];t&&(t.total+=r.health,(r.played||r.isCommander())&&(t.taken+=r.health-r.health_left))}a.player.percent=t.taken/t.total,a.cpu.percent=t.taken/t.total;var s,l=se.cpu.commander;return s=SIMULATOR.config.cpuHash?l.isAlive()&&!e?Math.floor(25*a.cpu.percent):130-Math.floor(15*a.player.percent):l.isAlive()&&!e?(s=Math.floor(a.cpu.percent/.02),Math.max(5,s)):200-Math.floor(a.player.percent/.02)},Object.defineProperties(SIMULATOR,{deck:{get:function(){return te},set:function(e){te=e}},field:{get:function(){return se},set:function(e){se=e}},battlegrounds:{get:function(){return re},set:function(e){re=e}},simulation_turns:{get:function(){return le},set:function(e){le=e}},simulating:{get:function(){return de},set:function(e){de=e}},totalDeckHealth:{get:function(){return ce},set:function(e){ce=e}},totalCpuDeckHealth:{get:function(){return pe},set:function(e){pe=e}},user_controlled:{get:function(){return oe},set:function(e){oe=e}}})}(),function(){"use strict";var e=require("simController"),n=require("matchStats");e.getConfiguration=function(){return{auto_mode:void 0,cpuExactOrder:!1,cpuHash:"QpLQAQcHQBA3KQBAiYQBgsRQBQHVQBIC!wAoJJQB",cpuOrdered:!1,enemybges:"",loss_debug:!1,mapbges:"",mass_debug:!1,missionLevel:"7",play_debug:!1,playerExactOrder:!1,playerHash:"QpLQAQcHQBA3KQBAiYQBgsRQBQHVQBIC!wAoJJQB",playerOrdered:!1,raidLevel:"25",selectedBges:"121,122",selectedCampaign:"",selectedMission:"",selectedRaid:"",selfbges:"",siegeMode:!1,simsToRun:"10000",surgeMode:!1,tournamentMode:!1,towerLevel:"18",towerType:"501",win_debug:!1}},e.startsim(),e.endSimsCallback=function(){console.log(n.matchesWon/n.matchesPlayed)}}();
//# sourceMappingURL=engineTest.min.js.map