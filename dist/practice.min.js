/*! simspellstone 09-01-2019 */

for(var skillID in SKILL_DATA){var skillInfo=SKILL_DATA[skillID];"flurry"===skillID?skillInfo.type="flurry":0<=["turnStart","onAttack","onDamaged","turnEnd"].indexOf(skillInfo.type)&&(skillInfo.type="passive")}var REVERSE_FUSIONS={};for(var id in FUSIONS){var fusion=FUSIONS[id];REVERSE_FUSIONS[fusion]=id}var DATA_UPDATER=function(){var i="https://spellstone.synapse-games.com",h={},f={},o=null;var s=["cards_heroes.xml","cards_premium_aether.xml","cards_premium_chaos.xml","cards_premium_wyld.xml","cards_reward.xml","cards_shard.xml","cards_special.xml","cards_standard.xml","cards_story.xml","fusion_recipes_cj2.xml"];function m(e){var t,a,r={};if(r.id=v(e,"id"),r.name=v(e,"name"),u(r,e,"desc"),r.picture=v(e,"picture")||(t=v(e,"asset_prefab"),a="prefab_",t?a+t:t),!r.picture){var n=v(e,"portrait");r.picture=n?"portrait_"+n.toLowerCase().replace("portrait_",""):"NotFound"}var i=v(e,"hidden_until")||v(e,"hidden_until_time");i&&(r.hidden_until=i+"000"),r.rarity=v(e,"rarity"),r.set=v(e,"set"),r.card_type=v(e,"card_type"),g(r,e,"shard_card"),r.type=v(e,"type")||0,r.sub_type=p(e,"sub_type")||[],g(r,e,"health"),"1"!=r.card_type&&(g(r,e,"attack"),g(r,e,"cost"));var o=function(e){for(var t=e.getElementsByTagName("upgrade"),a={},r=0;r<t.length;r++)a[r+2]=d(t[r]);return a}(e);return r.maxLevel=1+Object.keys(o).length,r.skill=l(e),r.upgrades=o,r}function l(e){for(var t=e.childNodes,a=[],r=0;r<t.length;r++){var n=t[r];"skill"===n.nodeName&&a.push(c(n))}return a}function c(e){var t={id:v(e,"id",!0)};return g(t,e,"x",!0),g(t,e,"mult",!0),g(t,e,"on_delay_mult",!0),u(t,e,"y",!0),g(t,e,"z",!0),g(t,e,"c",!0),u(t,e,"s",!0),u(t,e,"all",!0),t}function d(e){var t={};return g(t,e,"attack"),g(t,e,"health"),g(t,e,"cost"),u(t,e,"desc"),t.skill=l(e),t}function u(e,t,a,r){var n=v(t,a,r);null!=n&&0<n.length&&(e[a]=n)}function g(e,t,a,r){var n,i=null!=(n=v(t,a,r))?Number(n):-1;0<=i&&(e[a]=i)}function v(e,t,a){if(a)return e.getAttribute(t);var r=p(e,t);return r?r[0]:null}function p(e,t){var a=null,r=$(e).children(t);if(0<r.length){a=[];for(var n=0;n<r.length;n++)a.push(r[n].textContent)}return a}return{updateData:function(e,t){$("body").addClass("loading"),$("#loadingSplash").html("Checking for New Cards...");var a=Date.now();if(!o||6e4<o-a||t){o=a,h={};var r=[];r.push(function(){for(var e=[],t=0;t<s.length;t++){var a=jQuery.ajax({url:i+"/assets/"+s[t],success:function(e){for(var t="undefined"!=typeof spoilers,a=e.getElementsByTagName("unit"),r=0;r<a.length;r++){a[r];var n=v(a[r],"id"),i=m(a[r]),o=!1;CARDS[n]?JSON.stringify(CARDS[n])!==JSON.stringify(i)&&(o=!0):o=!0,o&&(t&&(spoilers[n]=!0),h[n]=i),CARDS[n]=i}for(var s=e.getElementsByTagName("fusion_recipe"),r=0;r<s.length;r++){var l=s[r],c=v(l,"card_id",!1),d=l.getElementsByTagName("resource")[0];if(d){var u=v(d,"card_id",!0);FUSIONS[u]&&FUSIONS[u]==c||(f[u]=c,FUSIONS[u]=c)}}},async:!0,cache:!1});e.push(a)}return $.when.apply($,e)}());var n=function(){!function(){if(void 0!==storageAPI){var e=storageAPI.getField("GameData","CardCache");e?(e.newCards=e.newCards||{},e.newFusions=e.newFusions||{},$.extend(e.newCards,h),$.extend(e.newFusions,f)):e={newCards:h,newFusions:f},e.lastUpdated=Date.now(),storageAPI.setField("GameData","CardCache",e)}}(),$("body").removeClass("loading"),e&&e()};$.when.apply($,r).then(n,n)}else e&&e()}}}();function loadCardCache(){var e=storageAPI.getField("GameData","CardCache");if(e&&e.lastUpdated>DataUpdated)e.newCards?($.extend(CARDS,e.newCards),$.extend(FUSIONS,e.newFusions)):CARDS=e.cards,DataUpdated=e.lastUpdated;else{var t={newCards:{},newFusions:{},lastUpdated:Date.now()};storageAPI.setField("GameData","CardCache",t)}}function parseInt(e){return e>>0}"function"!=typeof String.prototype.format&&(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(e,t){return void 0!==a[t]?a[t]:e})}),"function"!=typeof Object.assign&&(Object.assign=function(e){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");e=Object(e);for(var t=1;t<arguments.length;t++){var a=arguments[t];if(null!=a)for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e});var curry=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(this,t.concat(Array.prototype.slice.call(arguments,0)))}};function _GET(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var r=t[a].split("=");if(decodeURIComponent(r[0])==e)return decodeURIComponent(r[1]?r[1]:"")}}function _DEFINED(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var r=t[a].split("=");if(decodeURIComponent(r[0])==e)return!0}return!1}function time_elapsed(){var e=((time_stop||Date.now())-time_start)/1e3;return e=e.toFixed(3)}function batch_time_elapsed(e){return e||(e=time_start_batch),timeSince(e)}function timeSince(e){return((Date.now()-e)/1e3).toFixed(3)}function shuffle(e){var t,a,r,n=e.length;if(0==n)return!1;for(;--n;)t=~~(Math.random()*(n+1)),a=e[n],r=e[t],e[n]=r,e[t]=a}function initializeCard(e,t,a){e.owner=t,e.timer=e.cost,e.health_left=e.health,applyDefaultStatuses(e),e.key=a,e.reusableSkills||e.resetTimers()}function copy_deck(e){var t={};return t.commander=e.commander,t.deck=copy_card_list(e.deck),t}function getDeckCards(e,t){var a={};a.commander=get_card_by_id(e.commander),a.deck=[];for(var r=e.deck,n=SIMULATOR.battlegrounds.onCreate.filter(function(e){return!("player"===t&&e.enemy_only||"cpu"===t&&e.ally_only)}),i=0,o=r.length;i<o;i++)a.deck.push(get_card_apply_battlegrounds(r[i],n));return a}function copy_card_list(e){for(var t=[],a=0,r=e.length;a<r;a++)t[a]=e[a];return t}function cloneCard(e){var t=Object.create(e.__proto__);for(var a in t.id=e.id,t.name=e.name,t.attack=e.attack,t.health=e.health,t.maxLevel=e.maxLevel,t.level=e.level,t.cost=e.cost,t.rarity=e.rarity,t.card_type=e.card_type,t.type=e.type,t.sub_type=e.sub_type||[],t.set=e.set,SKILL_DATA){var r=SKILL_DATA[a].type;"passive"!==r&&"toggle"!==r||(t[a]=e[a])}return e.flurry&&(t.skillTimers=[],t.flurry={id:e.flurry.id,c:e.flurry.c},t.skillTimers.push(t.flurry)),t.reusableSkills=e.reusableSkills,e.reusableSkills?(t.skill=e.skill,t.earlyActivationSkills=e.earlyActivationSkills,t.onDeathSkills=e.onDeathSkills):copy_skills(t,e.skill,e.earlyActivationSkills,e.onDeathSkills),t.highlighted=e.highlighted,t.runes=e.runes,t.runes||(t.runes=[]),t}Function.prototype.debounce=function(a){var r,n=this;return function(){var e=this,t=arguments;clearTimeout(r),r=setTimeout(function(){r=null,n.apply(e,t)},a)}};var CardPrototype,defaultStatusValues={attack_berserk:0,attack_valor:0,attack_rally:0,attack_weaken:0,attack_corroded:0,corrosion_timer:0,mark_target:0,barrier_ice:0,corroded:0,enfeebled:0,enraged:0,envenomed:0,heartseeker:0,imbued:0,invisible:0,nullified:0,poisoned:0,protected:0,scorched:0,warded:0,jammed:!(Function.prototype.throttle=function(e){var a,r=this;return function(){var e=this,t=arguments;a||(r.apply(e,t),a=setTimeout(function(){a=null,r.apply(e,t)},250))}}),jammedSelf:!1,silenced:!1,valor_triggered:!1,dualstrike_triggered:!1,ondeath_triggered:!1,reanimated:!1};function applyDefaultStatuses(e){for(var t in e.removeImbue(),e.enhanced={},defaultStatusValues)e[t]=defaultStatusValues[t]}var makeUnit=function(){function p(e,t){return get_card_by_id({id:e.id,level:e.level})[t]}function _(e,t,a){for(var r in t){var n=t[r];n.x&&((n=copy_skill(n)).x+=Math.ceil(n.x*a),n.boosted=!0,t[r]=n,e.highlighted.push(n.id))}}for(var e in CardPrototype={p:null,health_left:0,timer:0,key:void 0,initialize:function(e){this.health_left=this.health,this.isCommander()||(this.timer=this.cost,applyDefaultStatuses(this)),this.reusableSkills||this.resetTimers()},upkeep:function(){if(0<this.timer&&(this.timer--,debug&&(echo+=debug_name(this)+" reduces its timer<br>"),this.valor&&this.isActive())){var e=field_o_assaults[i];e&&this.adjustedAttack()<e.adjustedAttack()?(this.attack_valor=this.valor,debug&&(echo+=debug_name(this)+" activates valor, boosting its attack by "+this.valor+"<br/>")):debug&&(echo+=debug_name(this)+" activates valor but ",echo+=e?"enemy is not strong enough.<br/>":"there is no opposing enemy.<br/>")}this.enfeebled=this.envenomed+this.heartseeker,this.enraged=0,this.protected=0,this.barrier_ice=0,this.enhanced={},this.removeImbue()},endTurn:function(){this.attack_rally=0,this.attack_weaken=0,this.nullified=0,this.silenced=!1,this.jammed=!1,this.jammedSelf=!1,this.dualstrike_triggered=!1;var e=this.poisoned;e&&do_damage(null,this,e,null,function(e,t,a){echo+=debug_name(t)+" takes "+a+" poison damage",t.isAlive()||(echo+=" and it dies"),echo+="<br>"});var t=this.scorched;t&&(r=t.amount,1<t.timer?t.timer--:this.scorched=0,do_damage(null,this,r,null,function(e,t,a){echo+=debug_name(t)+" takes "+a+" scorch damage",t.isAlive()?t.scorched||(echo+=" and scorch wears off"):echo+=" and it dies",echo+="<br>"}));var a=this.corroded;if(a)if(1<a.timer){a.timer--;var r=Math.min(a.amount,this.permanentAttack());this.attack_corroded=r,echo+=debug_name(this)+" is corroded by "+r+"<br/>"}else this.corroded=0,this.attack_corroded=0,debug&&(echo+="corrosion on "+debug_name(this)+" wears off<br/>")},countdownSkillTimers:function(){for(var e=this.skillTimers,t=0,a=e.length;t<a;t++){var r=e[t];r.countdown&&(r.countdown--,debug&&(r.countdown?echo+=debug_name(this)+" charges "+convertName(r.id)+" (ready in "+r.countdown+" turns)<br/>":echo+=debug_name(this)+" readies "+convertName(r.id)+"<br/>"))}},isCommander:function(){return"1"==this.card_type},isAssault:function(){return"2"==this.card_type},isTrap:function(){return"3"==this.card_type},isBattleground:function(){return!1},isAlive:function(){return 0<this.health_left},isDamaged:function(){return this.health_left<this.health},isActive:function(){return 0==this.timer},isActiveNextTurn:function(){return this.timer<=1},isInactive:function(){return 1<=this.timer},isUnjammed:function(){return!this.jammed},isUnsilenced:function(){return!this.silenced},imbue:function(e){this.imbued||(this.imbued={});var t,a=this.imbued,r=e.id;switch(SKILL_DATA[r].type){case"toggle":return this[r]=!0,void(this.imbued[r]=1);case"passive":return this[r]+=parseInt(e.x),void(this.imbued[r]=(this.imbued[r]||0)+e.x);case"flurry":return void(this.flurry||(this.flurry=e,this.flurry.countdown=0,this.imbued.flurry=!0));case"onDeath":t="onDeathSkills";break;case"earlyActivation":t="earlyActivationSkills";break;case"activation":default:t="skill"}if(void 0===a[t]){var n=this[t];a[t]=n.length,this[t]=n.slice()}this[t].push(e)},scorch:function(e){var t=this.scorched;t?(t.amount+=e,t.timer=2):this.scorched={amount:e,timer:2}},removeImbue:function(){var e=this.imbued;if(e){for(var t in e){var a=e[t];"skill"===t||"earlyActivationSkills"===t||"onDeathSkills"===t?this[t]=this[t].slice(0,a):this[t]-=a}this.imbued=0}},hasSkill:function(e,t){var a;switch(SKILL_DATA[e].type){case"toggle":case"passive":case"flurry":return this[e];case"onDeath":a=this.onDeathSkills;break;case"earlyActivation":a=this.earlyActivationSkills;break;case"activation":default:a=this.skill}for(var r in a){var n=a[r];if(n.id===e&&(void 0===t||(n.all||0)==t))return!0}return!1},hasAttack:function(){return 0<this.adjustedAttack()},attackPlusBuffs:function(){return this.attack+this.attack_rally+this.attack_berserk+this.attack_valor},adjustedAttack:function(){return this.attack+this.attack_rally+this.attack_berserk+this.attack_valor-this.attack_weaken-this.attack_corroded},permanentAttack:function(){return this.attack+this.attack_berserk+this.attack_valor},isInFaction:function(e){if(void 0===e)return 1;var t=e.split(",");if(t.length<=1)return this.type==e?1:0<=this.sub_type.indexOf(e.toString())?1:0;for(var a=0;a<t.length;a++)if(!this.isInFaction(t[a]))return 0;return 1},resetTimers:function(){for(var e=0,t=this.skillTimers.length;e<t;e++)this.skillTimers[e].countdown=0},addRunes:function(e){addRunes(this,e)}},SKILL_DATA){var t=SKILL_DATA[e].type;"passive"===t?CardPrototype[e]=0:"toggle"===t&&(CardPrototype[e]=!1)}return applyDefaultStatuses(CardPrototype),function(e,t,a,r,n,i){t||(t=1);var o=Object.create(CardPrototype);o.id=e.id,o.name=e.name,o.attack=e.attack,o.health=e.health,o.maxLevel=e.maxLevel,o.level=t>o.maxLevel?o.maxLevel:t,o.cost=e.cost,o.rarity=e.rarity,o.card_type=e.card_type,o.type=e.type,o.sub_type=e.sub_type||[],o.set=e.set;var s,l=e.skill;if(1<o.level)for(var c in e.upgrades)if(void 0!==(s=e.upgrades[c]).cost&&(o.cost=s.cost),void 0!==s.health&&(o.health=s.health),void 0!==s.attack&&(o.attack=s.attack),void 0!==s.desc&&(o.desc=s.desc),0<s.skill.length&&(l=s.skill),c==o.level)break;if(l=l.slice(),r&&r.length&&function(t,e,a,r){t.highlighted=[];for(var n=0;n<a.length;n++){var i=a[n];if("statChange"==i.modifierType&&!r)for(var o=0;o<i.effects.length;o++){var s=i.effects[o];t.isInFaction(s.y)&&Object.keys(s).forEach(function(e){t[e]=s[e]})}}}(o,0,r,i),a){o.addRunes(a);var d=1;r&&r.forEach(function(e){"runeMultiplier"==e.modifierType&&e.effects.forEach(function(e){o.isInFaction(e.y)&&(d=parseInt(e.mult))})}),addRunesToSkills(l,a,d)}else o.runes=[];return r&&r.length&&function(e,t,a,r){e.highlighted=[];for(var n=0;n<a.length;n++){var i=a[n];if("evolve_skill"==i.modifierType)for(var o=0;o<i.effects.length;o++){var s=i.effects[o];for(var l in t){var c=t[l];c.id==s.id&&c.all==s.all&&((c=copy_skill(c)).id=s.s,c.boosted=!0,t[l]=c,e.highlighted.push(c.id))}}else if("add_skill"==i.modifierType)for(o=0;o<i.effects.length;o++){var d=i.effects[o];if(e.isInFaction(d.y)){if(d.rarity&&e.rarity!=d.rarity)continue;var u={};if(u.id=d.id,u.x=d.x||0,d.mult)if(d.base){var h=p(e,d.base);u.x+=Math.ceil(d.mult*h)}else u.mult=d.mult;if(u.z=d.z,u.c=d.c,u.s=d.s,u.all=d.all,d.card&&(u.card=d.card),d.level&&(u.level=d.level),u.boosted=!0,d.mult&&d.base&&0==u.x)continue;t.push(u),e.highlighted.push(u.id)}}else if("scale_attributes"!=i.modifierType||r){if("scale_stat"==i.modifierType&&!r)for(o=0;o<i.effects.length;o++)f=i.effects[o],e.isInFaction(f.y)&&(e[i.scaledStat]+=Math.ceil(p(e,f.base)*f.mult))}else for(var o=0;o<i.effects.length;o++){var f=i.effects[o];if(e.isInFaction(f.y)){var m=f.mult,g=Math.ceil(e.attack*m);e.attack+=g;var v=Math.ceil(e.health*m);e.health+=v,_(e,t,m)}}}}(o,l,r,i),n&&_(o,l,n),copy_skills_2(o,l),o}}(),getEnhancement=function(e,t,a){var r=e.enhanced,n=r&&r[t]||0;return n<0&&(n=Math.ceil(a*-n)),n},isImbued=function(e,t,a){var r;switch(SKILL_DATA[t].type){case"flurry":case"toggle":return e.imbued[t];case"passive":return e[t]===e.imbued[t];case"onDeath":r="onDeathSkills";break;case"earlyActivation":r="earlyActivationSkills";break;case"activation":default:r="skill"}return void 0!==e.imbued[r]&&a>=e.imbued[r]},addRunes=function(e,t){e.runes||(e.runes=[]);for(var a=0,r=t.length;a<r;a++){var n=t[a].id,i=getRune(n).stat_boost;for(var o in e.runes.push({id:n,stat_boost:i}),i){var s=i[o];"skill"==o||(isNaN(s)&&(s=Math.max(Math.ceil(e[o]*s.mult),s.min_bonus||1)),e[o]+=parseInt(s))}}};function addRunesToSkills(e,t,a){if(t)for(var r=0,n=t.length;r<n;r++){var i=t[r].id,o=RUNES[i].stat_boost;for(var s in o){var l=o[s];if("skill"==s)for(var c=l.id,d=l.x,u=l.mult,h=0;h<e.length;h++){var f=e[h];if(f.id==c&&(f.all||0)==(l.all||0)){f=copy_skill(f),!d&&u&&(d=Math.ceil(f.x*u)),l.min_bonus&&(d=Math.max(d,l.min_bonus)),d&&(f.x+=parseInt(d)*a),l.c&&(f.c-=Math.min(f.c,parseInt(l.c)*a)),f.boosted=!0,e[h]=f;break}}}}}var getRune=function(e){return RUNES[e]},canUseRune=function(e,t){var a=getRune(t),r=a.stat_boost;if(a.faction_req&&!e.isInFaction(a.faction_req))return!1;for(var n in r)if("skill"==n){var i=r[n],o=i.all?1:0;if(!e.hasSkill(i.id,o))return!1}return!0};function MakeSkillModifier(e,t){return{name:e,modifierType:t.effect_type,effects:[t]}}function MakeStatScaler(e,t){return{name:e,modifierType:"scale_stat",scaledStat:t.effect_type.replace("scale_",""),effects:[t]}}var MakeOnPlayBGE=function(){var a=function(e,t){this.p=null,this.name=e,this.effect=t,this.runes=[]};return a.prototype={onCardPlayed:function(e){SIMULATOR.onPlaySkills[this.effect.id](this,e,this.effect)},isCommander:function(){return!1},isAssault:function(){return!1},isBattleground:function(){return!0}},function(e,t){return new a(e,t)}}(),MakeTrap=function(){var a=function(e,t){this.name=e,this.id=t.id,this.base=t.base,this.mult=t.mult,this.target_deck=t.target_deck,this.y=t.y};return a.prototype={onCardPlayed:function(e,t,a){var r="opponent"===this.target_deck?a:t;if(e.isInFaction(this.y)){for(var n=[],i=0;i<r.length;i++){(e=r[i]).trap||n.push(e)}if(n.length){var o=Math.ceil(e[this.base]*this.mult),s=get_card_by_id(makeUnitInfo(this.id,o));n[~~(Math.random()*n.length)].trap=s,debug&&(echo+=this.name+" inserts "+debug_name(s)+" into the opposing deck.<br/>")}}}},function(e,t){return new a(e,t)}}(),getBattlegrounds=function(e,t,a,r,n,i,o,s){var l={onCreate:[],onTurn:[],onCardPlayed:[]};return addBgesFromList(l,e),addBgesFromList(l,t,"player"),addBgesFromList(l,a,"cpu"),addMapBGEs(l,r,"player"),n?addMissionBGE(l,n,i):o&&addRaidBGE(l,o,s),l};function addBgesFromList(e,t,a){if(!t)return null;for(var r=t.split(","),n=0;n<r.length;n++){var i=r[n];addBgeFromList(e,BATTLEGROUNDS[i],a)}}function addMissionBGE(e,t,a){var r=CAMPAIGNS[t];if(r){var n=r.battleground_id;if(n){var i=BATTLEGROUNDS[n];if(a=Number(a)-1,!i.starting_level||Number(i.starting_level)<=a){if(i.scale_with_level){i=JSON.parse(JSON.stringify(i));for(var o=a-Number(i.starting_level),s=0;s<i.effect.length;s++){var l=i.effect[s];l.mult=l.base_mult+l.mult*o}}addBgeFromList(e,i,"cpu")}}}}function addRaidBGE(e,t,a){var r=RAIDS[t].bge;if(r){var n=BATTLEGROUNDS[r];if(n&&Number(a)>=Number(n.starting_level))for(var i=n.enemy_only,o=0;o<n.effect.length;o++){var s=n.effect[o],l=s.effect_type;if("skill"===l){if(n.scale_with_level)var c=n.scale_with_level*(a-n.starting_level+1);else c=1;(d=MakeBattleground(n.name,s,c)).enemy_only=i,e.onTurn.push(d)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(effect_Type)){(d=MakeSkillModifier(n.name,s)).enemy_only=i,e.onCreate.push(d)}else if(0<=["scale_attack","scale_health"].indexOf(effect_Type)){(d=MakeStatScaler(n.name,s)).enemy_only=i,e.onCreate.push(d)}else if("trap_card"===l){var d;(d=MakeTrap(n.name,s)).enemy_only=i,e.onCardPlayed.push(d)}}}}function addMapBGEs(e,t,a){if(!t)return null;for(var r=t.split(","),n=0;n<r.length;n++){var i=r[n].split("-"),o=i[0],s=i[1],l=i[2],c=Object.keys(MAP_BATTLEGROUNDS).filter(function(e){return MAP_BATTLEGROUNDS[e].location_id==o})[0];addBgeFromList(e,(c=MAP_BATTLEGROUNDS[c]).effects[s].upgrades[l],a)}}function addBgeFromList(e,t,a){for(var r=0;r<t.effect.length;r++){var n=t.effect[r],i=n.effect_type;if("skill"===i){var o=MakeBattleground(t.name,n);"player"===a&&(o.ally_only=!0),"cpu"===a&&(o.enemy_only=!0),e.onTurn.push(o)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(i)){o=MakeSkillModifier(t.name,n);"player"===a&&(o.ally_only=!0),"cpu"===a&&(o.enemy_only=!0),e.onCreate.push(o)}else if(0<=["scale_attack","scale_health"].indexOf(i)){o=MakeStatScaler(t.name,n);"player"===a&&(o.ally_only=!0),"cpu"===a&&(o.enemy_only=!0),e.onCreate.push(o)}else if("trap_card"===i){o=MakeTrap(t.name,n);"player"===a&&(o.ally_only=!0),"cpu"===a&&(o.enemy_only=!0),e.onCardPlayed.push(o)}else if("on_play"===i){(o=MakeOnPlayBGE(t.name,n.effect)).attacker=n.attacker,o.defender=n.defender,o.first_play=n.first_play,"player"===a&&(o.ally_only=!0),"cpu"===a&&(o.enemy_only=!0),e.onCardPlayed.push(o)}}}var MakeBattleground=function(){var r=function(e,t,a){this.name=e,copy_skills_2(this,[t],a)};return r.prototype={p:null,name:null,runes:[],isCommander:function(){return!1},isAssault:function(){return!1},isBattleground:function(){return!0},resetTimers:function(){for(var e=0,t=this.skillTimers.length;e<t;e++)this.skillTimers[e].countdown=0}},function(e,t,a){return new r(e,t,a)}}();function copy_skills_2(e,t,a){e.skill=[],e.earlyActivationSkills=[],e.onDeathSkills=[];var r=[],n=!0;for(var i in t){var o=t[i];if(o.c)setSkill_2(e,s=copy_skill(o)),r.push(s),n=!1;else if(a){var s;(s=copy_skill(o)).x=Math.ceil(s.x*a),setSkill_2(e,s)}else setSkill_2(e,o)}e.reusableSkills=n,e.skillTimers=r}function setSkill_2(e,t){var a=t.id;switch(SKILL_DATA[a].type){case"toggle":return void(e[a]=!0);case"passive":e[t.id]=(0|e[t.id])+t.x;break;case"flurry":e[t.id]=t;break;case"onDeath":e.onDeathSkills.push(t);break;case"earlyActivation":e.earlyActivationSkills.push(t);break;case"activation":default:e.skill.push(t)}}function copy_skills(e,t,a,r){e.skill=[],e.earlyActivationSkills=[],e.onDeathSkills=[],e.skillTimers||(e.skillTimers=[]),copy_Skill_lists(e,e.skill,t),copy_Skill_lists(e,e.earlyActivationSkills,a),copy_Skill_lists(e,e.onDeathSkills,r)}function copy_Skill_lists(e,t,a){for(var r=0;r<a.length;r++){var n=a[r];if(n.c){var i=copy_skill(n);t.push(i),e.skillTimers.push(i)}else t.push(n)}}function copy_skill(e){var t={};return t.id=e.id,t.x=e.x,t.mult=e.mult,t.on_delay_mult=e.on_delay_mult,t.all=e.all,t.y=e.y,t.z=e.z,t.c=e.c,t.s=e.s,t}function debug_dump_decks(){var e,t;echo+="<br>",echo+="<h1>Attacker</h1>",(t=get_card_by_id(cache_player_deck.commander)).owner="player",t.health_left=t.health,echo+=debug_name(t)+debug_skills(t)+"<br>",debug_dump_cards(cache_player_deck,"player"),cache_cpu_deck&&(e=cache_cpu_deck),echo+="<br>",echo+="<h1>Defender</h1>",(t=get_card_by_id(e.commander,!0)).owner="cpu",t.health_left=t.health,echo+=debug_name(t)+debug_skills(t)+"<br>",debug_dump_cards(e,"cpu"),echo+="<br><hr><br>"}function debug_dump_cards(e,t){for(var a in e.deck){var r=get_card_by_id(e.deck[a],!0);r.owner=t,r.key=void 0,r.health_left=r.health,r.timer=r.cost,echo+=debug_name(r)+debug_skills(r),r.type&&(echo+=" <u>"+factions.names[r.type]+"</u>");var n=r.sub_type;if(n.length)for(var i=0;i<n.length;i++)echo+=" <u>"+factions.names[n[i]]+"</u>";echo+="<br>"}}function debug_dump_field(e){if(debug){echo+='<font color="#666666">';for(var t=["player","cpu"],a=0,r=t.length;a<r;a++){var n=t[a];echo+="<br>",echo+=n+"'s assaults:<br>";for(var i=e[n].assaults,o=0,s=i.length;o<s;o++){var l=i[o];echo+=debug_name(l),echo+="("+key+")",echo+="<br>"}e[n].assaults.length||(echo+="None<br>")}echo+="</font>",echo+="<br>"}}function debug_name(e,t){if("cpu"==e.owner)var a="i";else a="b";var r="<"+a+">";if(r+=e.name,e.runes.length&&(r+="*"),1<e.maxLevel&&(r+="{"+e.level+"/"+e.maxLevel+"}"),void 0!==e.key&&(r+=" ("+e.key+")"),r+="</"+a+">",!t){if(r+="<u>",e.isCommander())r+=" [",void 0!==e.health_left?r+=debug_fraction(e.health_left):r+=e.health,r+=" HP]";else if(e.isAssault()){r+=" [";var n=e.adjustedAttack();(isNaN(n)||null==n)&&(n=e.attack),r+=n,r+="/",void 0!==e.health_left?r+=debug_fraction(e.health_left):r+=e.health,r+="/",void 0!==e.timer?r+=e.timer:r+=e.cost,r+="]"}r+="</u>"}return r}function debug_fraction(e){return e>Math.floor(e)&&(e=e.toFixed(1)),e}function dump(e){echo+="<pre>",print_r(e),echo+="</pre>"}function generate_card_list(e){var t=[],a=[],r=[],n=get_card_by_id(e.commander);t.push(n.name+"("+n.level+")"),a.push(1),r.push(0);var i=0;for(var o in e.deck){var s=e.deck[o],l=get_card_by_id(s);if(l){var c=l.name+"("+l.level+")";l.runes.length&&(c+="*"),t[i]==c?a[i]++:(t.push(c),a.push(1),r.push(s.priority),i++)}}for(var d=a.length-1;0<=d;d--){var u=a[d],h=r[d];1<u&&(t[d]+="x"+u),0<h&&(t[d]+="="+h)}return t=t.join("; ")}function generate_play_list(e){for(var t=[],a=0;a<e.length;a++){var r=get_card_by_id(e[a]);if(r){var n=a%2==0?"b":"i",i="<"+n+">"+r.name+"("+r.level+")";r.runes.length&&(i+="*"),i+="</"+n+">",t.push(i)}}return"<td>"+t.join("</td><td>")+"</td>"}function debug_skills(e){var t=[];for(var a in e.earlyActivationSkills)t.push(debug_skill(e.earlyActivationSkills[a]));for(var a in e.skill)t.push(debug_skill(e.skill[a]));for(var a in e.onDeathSkills)t.push(debug_skill(e.onDeathSkills[a]));return debug_passive_skills(e,t),0<t.length?" <u>( "+t.join(" | ")+" )</u>":""}function debug_skill(e){var t=convertName(e.id);return e.all&&(t+=" all"),e.y&&(t+=" "+factions.names[e.y]),e.s&&(t+=" "+convertName(e.s)),e.c?t+=" every "+e.c+" turns":e.x&&(t+=" "+e.x),t}function debug_passive_skills(t,a){Object.getOwnPropertyNames(SKILL_DATA).filter(function(e){return 0<=["passive","toggle","flurry"].indexOf(SKILL_DATA[e].type)}).forEach(function(e){debugNonActivatedSkill(t,e,a)})}function debugNonActivatedSkill(e,t,a){var r=e[t];r&&a.push(convertName(t)+" "+r)}function convertName(e){var t=SKILL_DATA[e];return t?t.name:e}var base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!~",multiplierChars="_*.'",runeDelimiter="/",indexDelimiter="-",priorityDelimiter="|",noFusionInHash={};for(var id in CARDS){if(id<1e4)(!(fusion=FUSIONS[id])||Number(fusion)<1e4)&&(noFusionInHash[id]=!0)}var maxRuneID=1e3;function unitInfo_to_base64(e){var t=parseInt(e.id),a=parseInt(e.level)-1;if(noFusionInHash[t]){var r=Math.floor(a/7);a=a%7}else{r=Math.floor(t/1e4);t%=1e4}var n=0;e.runes.length&&(n=parseInt(e.runes[0].id),n%=5e3);e.priority;var i=t;return decimal_to_base64(i=(i=7*(i=3*i+r)+a)*maxRuneID+n,5)}function base64_to_unitInfo(e){var t=base64_to_decimal(e),a=t%maxRuneID,r=(t=(t-a)/maxRuneID)%7,n=(t=(t-r++)/7)%3,i=t=(t-n)/3;noFusionInHash[i]?r+=7*n:0<n&&(i=Number(n+""+i));var o=makeUnitInfo(i,r);return 0<a&&o.runes.push({id:a+5e3}),o}function decimal_to_base64(e,t){for(var a="",r=0;r<t;r++){var n=e%64;a+=base64chars[n],e=(e-n)/64}return a}function base64_to_decimal(e){for(var t=0,a=e.length-1;0<=a;a--){t*=64,t+=base64chars.indexOf(e[a])}return t}function runeID_to_decimal(e){if(0==e)return 0;var t=(e=parseInt(e)%5e3)%10,a=(e-t)/10;return e=e=5*a+t-1}function base64_to_runeID(e){return decimal_to_runeID(base64chars.indexOf(e[0])+64*base64chars.indexOf(e[1]))}function decimal_to_runeID(e){var t=e%5,a=(e-t)/5;return 0==a?0:10*a+t+5001}function numberToBase64(e){return base64chars[Math.floor(e/64)]+base64chars[e%64]}function base64ToNumber(e){return 64*base64chars.indexOf(e[0])+base64chars.indexOf(e[1])}function encode_multiplier(e){return 256<(e-=2)?"":multiplierChars[Math.floor(e/64)]+base64chars[e%64]}function decode_multiplier(e){return 64*multiplierChars.indexOf(e[0])+base64chars.indexOf(e[1])}function hash_encode(e){var t=[],a=!1,r=!1,n=[];e.commander&&t.push(unitInfo_to_base64(e.commander));var i=[1];for(var o in e.deck){(c=e.deck[o]).priority&&(a=!0),c.index&&(n.push(numberToBase64(c.index)),r=!0);var s=unitInfo_to_base64(c);t.push(s),i.push(1),0}if(a){var l=priorityDelimiter;for(var o in e.deck){var c;(c=e.deck[o]).priority?l+=c.priority:l+="0"}t.push(l)}r&&(n=indexDelimiter+n.join(""),t.push(n));for(var d=0;d<i.length;d++){var u=i[d];1<u&&(t[d]+=encode_multiplier(u))}return t=t.join("")}function areEqual(e,t){return!e==!t&&unitInfo_to_base64(e)==unitInfo_to_base64(t)}function hash_decode(e){var t,a,r={deck:[]};0<e.indexOf(indexDelimiter)&&(a=e.substr(e.indexOf(indexDelimiter)+1).match(/.{1,2}/g),e=e.substr(0,e.indexOf(indexDelimiter)));for(var n=0,i=0;i<e.length;i+=5)if(-1==multiplierChars.indexOf(e[i])){var o=e.substr(i,5);t=base64_to_unitInfo(o),0<n&&a&&(t.index=base64ToNumber(a[n-1])),t&&(loadCard(t.id)?(!r.commander&&is_commander(t.id)?r.commander=t:r.deck.push(t),n++):console.log("Could not decode '"+o+"' ("+t.id+")"))}else{for(var s=decode_multiplier(e.substr(i,2))+1,l=0;l<s;l++){var c=makeUnitInfo(t.id,t.level,t.runes);a&&(c.index=base64ToNumber(a[n-1])),r.deck.push(c),n++}i-=3}return r.commander||(r.commander=elariaCaptain),r}function load_deck_from_cardlist(e){var t=[];if(t.deck=[],e){var a=[];300<e.length&&(e=e.substr(0,300)),e=(e=(e=(e=e.toString().toLowerCase()).replace(/[\&\/\.\!\?\'-]/g,"")).replace(/\s/g,"")).split(/[,;:]/);var r=CARDS;for(var n in e){var i=e[n].toString(),o=makeUnitInfo(1,7);o.priority=0;var s=!1;3<i.toString().length&&i.toString().match(/=[1-9][0-9]*$/)&&(o.priority=parseInt(i.substr(i.length-1,1)),i=i.substr(0,i.length-2));var l,c=1;if((l=i.toString().match(/^[1-9]+x/))?(c=parseInt(l[0]),i=i.substr(l[0].length)):(l=i.toString().match(/x[1-9]+$/))&&(c=parseInt(l[0].substr(1)),i=i.substr(0,i.length-l[0].length)),(l=i.toString().match(/\(([1-9]+)\).*/))&&(o.level=l[1],i=i.substr(0,i.length-l[0].length)),l=(i=i.trim()).toString().match(/\[[1-9]+\]/))if(o.id=l[0],is_commander(o.id))t.commander=o;else for(;0<c;)t.deck.push(o),c--;else{for(var d in a[i=clean_name_for_matching(i)]&&(i=a[i]),i=clean_name_for_matching(i),r){var u=r[d];if(o.id=u.id,clean_name_for_matching(u.name)==i){if(is_commander(o.id)&&1==c)t.commander=o;else for(t.deck.push(o);1<c;)t.deck.push(o),c--;s=!0;break}}if(!s){if(!t.commander&&1==c)for(var d in r){u=r[d];if(o.id=u.id,is_commander(o.id))if(-1!=clean_name_for_matching(u.name).indexOf(i)){t.commander=o,s=!0;break}}if(!s)for(var d in r){u=r[d];if(o.id=u.id,!is_commander(o.id))if(-1!=clean_name_for_matching(u.name).indexOf(i)){for(t.deck.push(o);1<c;)t.deck.push(o),c--;s=!0;break}}}}}}return t.commander||(t.commander=elariaCaptain),t}function clean_name_for_matching(e){return e=(e=(e=(e=(e=(e=e.toLowerCase()).toString().replace(/[\&]/g,",")).toString().replace(/[\.\!\?]/g,"")).toString().replace(/\s/g,"")).toString().replace(/-/g,"")).toString().replace(/\'/g,"")}function load_deck_mission(e,t){var a=MISSIONS[e];return a?load_preset_deck(a,t,6):0}function load_deck_raid(e,t,a){a||(a=25);var r=RAIDS[e];return r?load_preset_deck({commander:r.commander,deck:r.deck.card},t,Number(r.upgradeLevels)):0}var reverseFusions,DoNotFuse=["8005","8006","8007","8008","8009","8010"];function load_preset_deck(e,t,a){var r=a+1;t||(t=r);var n=[];n.deck=[];var i=getPresetCommander(e,t),o=getPresetUnit(i,t,r);i.possibilities&&(o.randomInfo={possibilities:i.possibilities,level:t,maxedAt:r}),n.commander=o;var s=e.deck,l=n.deck;for(var c in s){var d=getPresetUnit(s[c],t,r);d&&l.push(d)}var u=getUpgradePoints(t,r,getMaxUpgradePoints(l));if(1<t&&t<r)for(var h=l.slice();0<u&&0<h.length;){var f=Math.floor(Math.random()*h.length);upgradeCard(h[f])?u--:h.splice(f,1)}return n}function update_preset_deck(e){if(o=e.commander.randomInfo){var t=o.possibilities;(i=getPresetUnit(t[~~(Math.random()*t.length)],o.level,o.maxedAt)).randomInfo=o,e.commander=i}for(var a=e.deck,r=0,n=a.length;r<n;r++){var i,o;(o=(i=a[r]).randomInfo)&&((i=getPresetUnit(o.unitInfo,o.level,o.maxedAt)).randomInfo=o,a[r]=i)}return getDeckCards(e,"cpu")}function getPresetCommander(e,t){t=parseInt(t);var a=e.commander;if(a.card){for(var r=[],n=0;n<a.card.length;n++){var i=a.card[n],o=parseInt(i.min_mastery_level)||0,s=parseInt(i.max_mastery_level)||999;o<=t&&t<=s&&r.push(i)}(a=r[~~(Math.random()*r.length)]).possibilities=r}return a}function getUpgradePoints(e,t,a){var r;return r=7==t?(e-1)/(t-1):e/t,Math.ceil(a*r)}function getMaxUpgradePoints(e){for(var t=0,a=0;a<e.length;a++){var r=get_card_by_id(e[a]);t+=(getMaxFusions(r)+1)*r.maxLevel-1}return t}function getMaxFusions(e){for(var t=baseFusion(e),a=-1;void 0!==t;)a++,t=FUSIONS[t];return a}function baseFusion(e){for(var t,a=e.id;void 0!==(a=REVERSE_FUSIONS[t=a]););return t}function getPresetUnit(e,t,a){if(t=parseInt(t),e.mastery_level&&t<parseInt(e.mastery_level))return null;if(e.remove_mastery_level&&t>=parseInt(e.remove_mastery_level))return null;var r=e.id,n=!1;r||(r=getRandomCard(e),n=!0);var i=e.level||1;if(a<=t)i=7,canFuse(r)&&(r=fuseCard(r));else if(1<t&&is_commander(r)){var o=(Number(loadCard(r).rarity)+1)/(a-1),s=t-1;i=Math.ceil(o*s)}var l=makeUnitInfo(r,i);return n&&(l.randomInfo={unitInfo:e,level:t,maxedAt:a}),l}function getRandomCard(e){var t=[];for(var a in CARDS)if(!REVERSE_FUSIONS[a]){var r=CARDS[a];if("1"!=r.card_type&&!(e.max_rarity&&Number(e.max_rarity)<Number(r.rarity)||e.min_rarity&&Number(e.min_rarity)>Number(r.rarity))&&(!e.type||e.type==r.type||0<=r.sub_type.indexOf(e.type.toString()))){if(e.set)if(e.set.split(",").indexOf(r.set)<0)continue;t.push(a)}}return t[~~(Math.random()*t.length)]}function upgradeCard(e){var t=parseInt(loadCard(e.id).rarity)+2;if(e.level==t){if(!canFuse(e.id))return!1;e.id=fuseCard(e.id,1),e.level=1}else e.level++;return!0}function canFuse(e){return!(-1<DoNotFuse.indexOf(e))&&(!is_commander(e)&&!!FUSIONS[e])}function fuseCard(e,t){if(-1==DoNotFuse.indexOf(e))if(t)for(var a=0;a<t;a++)e=doFuseCard(e);else for(;;){var r=doFuseCard(e);if(e===r)break;e=r}return e}function doFuseCard(e){var t=FUSIONS[e];return t||e}function getFusion(e){var t=0;for(reverseFusions||getReverseFusions();t++,reverseFusions[e];);return t}function getReverseFusions(){for(var e in reverseFusions={},FUSIONS)reverseFusions[FUSIONS[e]]=e}var get_card_apply_battlegrounds=function(e,t,a){return get_card_by_id(e,t=t||SIMULATOR.battlegrounds.onCreate,null,a)};function get_skills(e,t){var a,r=loadCard(e),n=r.skill;if(1<t)for(var i in r.upgrades)if(0<(a=r.upgrades[i]).skill.length&&(n=a.skill),i==t)break;return n}function get_card_by_id(e,t,a,r){var n=loadCard(e.id);if(n){n.skill||(n.skill=[]);var i=makeUnit(n,e.level,e.runes,t,a,r);return e.priority&&(i.priority=e.priority),i}return console.log(e.id+" not found"),(n={}).id=e.id,n.level=e.level,n.name=void 0,n.health=void 0,n.skill=[],n}function get_slim_card_by_id(e,t){var a=loadCard(e.id),r={};if("1"==a.card_type?(r.isCommander=function(){return!0},r.isAssault=function(){return!1}):(r.isCommander=function(){return!1},r.isAssault=function(){return!0}),a){if(r.id=a.id,r.name=a.name,r.rarity=a.rarity,r.maxLevel=a.maxLevel,e.level?(r.level=e.level,r.level>r.maxLevel&&(r.level=r.maxLevel)):r.level=1,t){if(r.attack=a.attack,r.health=a.health,r.cost=a.cost,r.set=a.set,r.card_type=a.card_type,r.type=a.type,r.sub_type=a.sub_type||[],r.skill=a.skill,1<r.level)for(var n in a.upgrades){var i=a.upgrades[n];if(void 0!==i.cost&&(r.cost=i.cost),void 0!==i.health&&(r.health=i.health),void 0!==i.attack&&(r.attack=i.attack),void 0!==i.desc&&(r.desc=i.desc),0<i.skill.length&&(r.skill=i.skill),n==r.level)break}var o=e.runes;o&&(r.skill=r.skill.slice(),addRunes(r,o),addRunesToSkills(r.skill,o))}}else r.id=void 0,r.name=void 0,r.card_type=void 0,r.set=void 0,r.type=void 0,r.sub_type=[],r.level=void 0,r.maxLevel=void 0,getSkills&&(r.skill=[]);return r}function loadCard(e){return CARDS[e]}function getCardInfo(e){var t=e.id,a=e.level,r=CARDS[t],n=Object.assign({},r);if(1<a&&1<a)for(var i in r.upgrades){var o=r.upgrades[i];if(void 0!==o.cost&&(n.cost=o.cost),void 0!==o.health&&(n.health=o.health),void 0!==o.attack&&(n.attack=o.attack),void 0!==o.desc&&(n.desc=o.desc),0<o.skill.length&&(n.skill=o.skill),i==a)break}return n.level=a,n.maxLevel=r.maxLevel,n}function get_card_name_by_id(e){var t=loadCard(e);return t?t.name:0}function is_commander(e){var t=loadCard(e);return t&&"1"==t.card_type}function is_assault(e){var t=loadCard(e);return t&&"2"==t.card_type}function is_trap(e){var t=loadCard(e);return t&&"3"==t.card_type}var makeUnitKey=function(e){var t=e.id+"_"+e.level;return e.runes&&e.runes.length&&(t+="_"+e.runes[0].id),t};function makeUnitInfo(e,t,a){var r={id:Number(e),level:Number(t),runes:[]};return a&&(r.runes=a),r}var elariaCaptain=makeUnitInfo(202,1);function getRarity(e){return rarityStrings[e]}function getCurrentPage(){var e=window.location.href,t=e.indexOf(".html"),a=(e=e.substring(0,t)).lastIndexOf("/")+1;return e=e.substring(a).toLowerCase()}var rarityStrings=["","Common","Rare","Epic","Legendary","Mythic"],factions={names:{0:"Factionless",1:"Aether",2:"Chaos",3:"Wyld",4:"Frog",5:"Elemental",6:"Angel",7:"Undead",8:"Void",9:"Dragon",10:"Avian",11:"Goblin",12:"Seafolk",13:"Insect",14:"Bear",15:"Token",16:"Mecha",17:"Knight",999:"Tower"},IDs:{Factionless:0,Aether:1,Chaos:2,Wyld:3,Frog:4,Elemental:5,Angel:6,Undead:7,Void:8,Dragon:9,Avian:10,Goblin:11,Seafolk:12,Insect:13,Bear:14,Token:15,Mecha:16,Knight:17,Tower:999}},SIM_CONTROLLER={getConfiguration:function(){getdeck=$("#deck1").val(),getordered=$("#ordered").is(":checked"),getexactorder=$("#exactorder").is(":checked"),getdeck2=$("#deck2").val(),getcampaign=$("#campaign").val(),getmission=$("#mission").val(),missionlevel=$("#mission_level").val(),getraid=$("#raid").val(),raidlevel=$("#raid_level").val(),getordered2=$("#ordered2").is(":checked"),getexactorder2=$("#exactorder2").is(":checked"),surge=$("#surge").is(":checked"),getsiege=$("#siege").is(":checked"),tower_level=$("#tower_level").val(),tower_type=$("#tower_type").val(),BATTLEGROUNDS&&(getbattleground=getSelectedBattlegrounds(),selfbges=getSelectedBattlegrounds("self-"),enemybges=getSelectedBattlegrounds("enemy-"),mapbges=getmission?getSelectedMapBattlegrounds():""),sims_left=$("#sims").val()||1,debug=$("#debug").is(":checked"),(play_debug=debug&&$("#play_debug").is(":checked"))&&(debug=!1),mass_debug=$("#mass_debug").is(":checked"),win_debug=$("#win_debug").is(":checked"),loss_debug=$("#loss_debug").is(":checked"),showAnimations=$("#animations").is(":checked"),$("#auto_mode").length&&(auto_mode=$("#auto_mode").is(":checked"),SIMULATOR.user_controlled=!auto_mode),tournament=$("#tournament").is(":checked")},debug_end:function(e){var t;e=SIM_CONTROLLER.processSimResult(),sims_left=0,time_stop=new Date;var a="";getdeck2&&(a=" ("+SIMULATOR.calculatePoints()+" points)"),t="draw"==e?"<br><h1>DRAW"+a+"</h1><br>":e?"<br><h1>WIN"+a+"</h1><br>":"<br><h1>LOSS"+a+"</h1><br>",echo&&outputTurns(echo),setSimStatus(t),showUI(),SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(SIMULATOR.simulation_turns),SIM_CONTROLLER.end_sims_callback&&SIM_CONTROLLER.end_sims_callback()},end_sims_callback:null,stop_sims_callback:null};!function(){function o(){if(SIMULATOR.user_controlled)s(!0)&&SIM_CONTROLLER.debug_end();else if(!debug&&!play_debug||mass_debug||loss_debug||win_debug)if(0<sims_left){if(c<=l){var e=0;if(0<c){l=0;var t=games/(games+sims_left)*100;t=t.toFixed(2);var a=time_elapsed(),r=batch_time_elapsed();setSimStatus("Running simulations...",a,(e=0==r?0:c/r).toFixed(1)),showWinrate()}(c=1)<e&&(c=Math.ceil(e/8)),sims_left<c&&(c=sims_left),(debug||play_debug)&&(mass_debug||loss_debug||win_debug)&&(c=1),time_start_batch=new Date,current_timeout=setTimeout(o,1);for(var n=0;n<c;n++)s()}}else{c=l=0,time_stop=new Date;a=time_elapsed();var i=games/a;i=i.toFixed(2),echo&&outp(echo),setSimStatus("Simulations complete.",a,i),showWinrate(),showUI(),SIM_CONTROLLER.end_sims_callback&&SIM_CONTROLLER.end_sims_callback()}else s(!0),SIM_CONTROLLER.debug_end()}SIM_CONTROLLER.startsim=function(){return total_turns=0,time_start=Date.now(),echo="",c=games=time_stop=0,SIM_CONTROLLER.getConfiguration(),SIMULATOR.battlegrounds=getBattlegrounds(getbattleground,selfbges,enemybges,mapbges,getcampaign,missionlevel,getraid,raidlevel),hideUI(),SIMULATOR.setupDecks(),points=draws=losses=wins=0,outp(""),SIMULATOR.user_controlled?setSimStatus(""):(hideTable(),setSimStatus("Initializing simulations...")),current_timeout=setTimeout(o),!1},SIM_CONTROLLER.stopsim=function(){time_stop=new Date;var e=time_elapsed(),t=games/e;t=t.toFixed(2),SIMULATOR.simulating=!1,current_timeout&&clearTimeout(current_timeout),SIMULATOR.user_controlled||(setSimStatus("Simulations interrupted.",e,t),showWinrate()),showUI(),SIM_CONTROLLER.stop_sims_callback&&SIM_CONTROLLER.stop_sims_callback()};var t=_GET("seedtest")||0;function s(e){if(t&&Math.seedrandom(t++),!SIMULATOR.simulate())return!1;e||SIM_CONTROLLER.processSimResult()}SIM_CONTROLLER.processSimResult=function(){var e;return e=!!SIMULATOR.field.player.commander.isAlive()&&(!SIMULATOR.field.cpu.commander.isAlive()||"draw"),0<c&&(0<sims_left&&sims_left--,l++),"draw"==e?draws++:e?wins++:losses++,points+=SIMULATOR.calculatePoints(),games++,total_turns+=SIMULATOR.simulation_turns,(debug||play_debug)&&(loss_debug?"draw"==e?(echo="Draw found after "+games+" games. Displaying debug output... <br><br>"+echo,echo+="<br><h1>DRAW</h1><br>",sims_left=0):e?sims_left?echo="":(echo="No losses found after "+games+" games. No debug output to display.<br><br>",sims_left=0):(echo="Loss found after "+games+" games. Displaying debug output... <br><br>"+echo,echo+="<br><h1>LOSS</h1><br>",sims_left=0):win_debug?e&&"draw"!=e?(echo="Win found after "+games+" games. Displaying debug output... <br><br>"+echo,echo+="<br><h1>WIN</h1><br>",sims_left=0):sims_left?echo="":(echo="No wins found after "+games+" games. No debug output to display.<br><br>",sims_left=0):mass_debug&&(echo+="draw"==e?"<br><h1>DRAW</h1><br>":e?"<br><h1>WIN</h1><br>":"<br><h1>LOSS</h1><br>"),mass_debug&&sims_left&&(echo+="<br><hr>NEW BATTLE BEGINS<hr><br>")),e};var l=0,c=0}();var SIMULATOR={};!function(){function c(e,t,a,r){var n=V[t].assaults;if(!e.id)return 0;var i=n.length;if(initializeCard(e,t,i),e.played=!0,e.isAssault()&&(n[i]=e),!debug&&!play_debug||r||(echo+=debug_name(V[t].commander)+" plays "+debug_name(e)+"<br>"),e.isTrap())p(e),I(e);else for(var o=0;o<j.onCardPlayed.length;o++){var s=j.onCardPlayed[o],l="player"===t?"cpu":"player";if(s.defender){if(!surge&&"cpu"!=t)continue;if(surge&&"player"!=t)continue;s.owner=l}else if(s.attacker){if(!surge&&"player"!=t)continue;if(surge&&"cpu"!=t)continue;s.owner=t}else{if(s.enemy_only&&"cpu"!=t)continue;if(s.ally_only&&"player"!=t)continue;s.owner=t}1<a&&s.first_play||s.onCardPlayed(e,W[t].deck,W[l].deck)}showAnimations&&drawField(V,null,null,a)}function v(e){for(var t=V[e].assaults,a=0,r=t.length;a<r;a++){var n=t[a];if(!n.isAlive()){debug&&(echo+=debug_name(n)+" <strong>is removed from field</strong><br>");var i=a;for(a++;a<r;a++)(n=t[a]).isAlive()?(t[n.key=i]=n,i++):debug&&(echo+=debug_name(n)+" <strong>is removed from field</strong><br>");t.length=i;break}}}function _(e){return[e[~~(Math.random()*e.length)]]}function b(e){return e.owner}function k(e){return"cpu"==e.owner?"player":"player"==e.owner?"cpu":void 0}function T(e,t,a,r,n){a>=t.health_left?t.health_left=0:t.health_left-=a,debug&&n(e,t,a),r&&E(t),!t.isAlive()&&e&&x(t,e)}function E(e){var t=e.barrier_ice,a=k(e),r=V[a],n=r.assaults[e.key];n&&n.isAlive()||(n=r.commander),T(e,n,t,null,function(e,t,a){echo+=debug_name(e)+"'s barrier shatters and hits "+debug_name(t)+" for "+a+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}function d(e,t){return e[t]||a}function a(e,t){if(debug){var a=SKILL_DATA[t.id]?SKILL_DATA[t.id].name:t.id;echo+=debug_name(e)+" attempts to use "+a+", but it is not implemented.<br>"}return 0}function p(e){var t=e.earlyActivationSkills,a=t.length;if(0!=a)if(e.silenced)debug&&(echo+=debug_name(e)+" is silenced and cannot use skills</br>");else{var r=e.dualstrike_triggered;debug&&r&&(echo+=debug_name(e)+" activates dualstrike<br>");for(var n=r?2:1,i=u(e),o=0;o<n;o++)for(var s=0;s<a&&i();s++){var l=t[s];if(!l.countdown){var c=d(h,l.id)(e,l);l.c&&0<c&&(l.countdown=l.c),showAnimations&&drawField(V,null,null,J,e)}}}}function t(){return!0}function u(e){return e.isAlive?e.isAlive.bind(e):t}function x(e,t){if(!e.ondeath_triggered){var a=e.onDeathSkills,r=a.length;if(0!=r){for(var n=0;n<r;n++){var i=a[n];o[i.id](e,t,i),showAnimations&&drawField(V,null,null,J,e)}e.ondeath_triggered=!0}}}var r=["backlash","counter","counterburn","counterpoison","armored","evade","stasis"];function y(e){return-1===r.indexOf(e)}function S(e,t){if(e.isAssault()&&t.isAlive()){var a=t.backlash;G(e,t,"Backlash",a,getEnhancement(t,"backlash",a))}}function L(e){return e.isActive()&&e.isUnjammed()?0:e.stasis||0}var s={burnself:function(e,t){var a=t.x;return e.scorched?(e.scorched.amount+=a,e.scorched.timer=2):e.scorched={amount:a,timer:2},debug&&(echo+=debug_name(e)+" inflicts scorch("+a+") on itself<br>"),1},scorchbreath:function(e,t){return s.burn(e,t)},burn:function(e,t){var a,r=k(e),n=V[r].assaults;switch(t.id){case"scorchbreath":var i=Math.max(0,e.key-1),o=Math.min(n.length,e.key+2);a=n.slice(i,o);break;case"burnself":a=[e];break;default:a=n.slice(e.key,e.key+1)}if(!a.length)return 0;var s=t.x;s+=getEnhancement(e,"burn",s);for(var l=0,c=0;c<a.length;c++){var d=a[c];d.scorched?(d.scorched.amount+=s,d.scorched.timer=2):d.scorched={amount:s,timer:2},debug&&(echo+=debug_name(e)+" inflicts scorch("+s+") on "+debug_name(d)+"<br>"),l++}return l},protect_ice:function(e,t){return s.protect(e,t,"barrier_ice")},protect_seafolk:function(e,t){return s.protect(e,t,null,null,!0)},evadebarrier:function(e,t){return s.protect(e,t,"invisible",function(e,t){return" and imbues it with invisible "+t})},protect:function(e,t,a,r,n){for(var i=t.y,o=b(e),s=t.x,l=t.all,c=V[o].assaults,d=[],u=0,h=c.length;u<h;u++){!(g=c[u]).isAlive()||!g.isInFaction(i)||n&&g.isActive()||d.push(u)}if(!d.length)return 0;l||(d=_(d));var f=getEnhancement(e,t.id,s);s+=f;var m=0;for(u=0,h=d.length;u<h;u++){var g;if((g=c[d[u]]).nullified)g.nullified--,debug&&(echo+=debug_name(e)+" protects "+debug_name(g)+" but it is nullified!<br>");else{m++;var v=s;if(!v){var p=t.mult;g.isActive()||(p+=t.on_delay_mult||0),v=Math.ceil(g.health*p)}g.protected+=v,a&&(g[a]=(g[a]||0)+v),debug&&(f&&(echo+="<u>(Enhance: +"+f+")</u><br>"),echo+=debug_name(e)+" barriers "+debug_name(g)+" by "+v,"function"==typeof r&&(echo+=r(g,v)),echo+="<br>")}}return m},heal:function(e,t){for(var a=b(e),r=t.y,n=t.x,i=t.all,o=V[a].assaults,s=[],l=0,c=o.length;l<c;l++){(h=o[l]).isAlive()&&h.isInFaction(r)&&(i||h.isDamaged())&&s.push(l)}if(!s.length)return 0;i||(s=_(s));var d=getEnhancement(e,t.id,n);n+=d;var u=0;for(l=0,c=s.length;l<c;l++){var h;if((h=o[s[l]]).nullified)h.nullified--,debug&&(echo+=debug_name(e)+" heals "+debug_name(h)+" but it is nullified!<br>");else{u++;var f=n;if(!f){var m=t.mult;f=Math.ceil(h.health*m)}f>h.health-h.health_left&&(f=h.health-h.health_left),h.health_left+=f,debug&&(d&&(echo+="<u>(Enhance: +"+d+")</u><br>"),echo+=debug_name(e)+" heals "+debug_name(h)+" by "+f+"<br>")}}return u},poisonstrike:function(e,t,a){return s.strike(e,t,!0)},strike:function(e,r,t){for(var a=k(e),n=r.x,i=r.y,o=r.all,s=V[a].assaults,l=[],c=0,d=s.length;c<d;c++){(f=s[c]).isAlive()&&f.isInFaction(i)&&l.push(c)}if(!l.length)return 0;o||(l=_(l));var u=getEnhancement(e,r.id,n);n+=u;var h=0;for(c=0,d=l.length;c<d;c++){var f;if((f=s[l[c]]).invisible)f.invisible--,debug&&(echo+=debug_name(e)+" bolts "+debug_name(f)+" but it is invisible!<br>");else{h++;var m=n,g=M(f,m);m=g.damage;var v=g.shatter,p=0;0<m&&t&&f.isAlive()&&n>f.poisoned&&(p=n,f.poisoned=p),T(e,f,m,v,function(e,t,a){echo+="<u>(Strike: +"+r.x,u&&(echo+=" Enhance: +"+u),echo+=g.echo,echo+=") = "+a+" damage</u><br>",echo+=debug_name(e)+" bolts "+debug_name(t)+" for "+a+" damage",t.isAlive()?p&&(echo+=" and inflicts poison("+p+") on it"):echo+=" and it dies",echo+="<br>"}),f.backlash&&S(e,f)}}return h},intensify:function(e,t,a){for(var r=k(e),n=t.x,i=t.y,o=t.all,s=V[r].assaults,l=[],c=0,d=s.length;c<d;c++){(h=s[c]).isAlive()&&h.isInFaction(i)&&(h.scorched||h.poisoned)&&l.push(c)}if(!l.length)return 0;o||(l=_(l)),n+=getEnhancement(e,t.id,n);var u=0;for(c=0,d=l.length;c<d;c++){var h,f=(h=s[l[c]]).scorched?"scorch":"";f+=h.poisoned?f?" and poison":"poison":"",h.invisible?(h.invisible--,debug&&(echo+=debug_name(e)+" intensifies "+f+" on "+debug_name(h)+" but it is invisible!<br>")):(u++,h.scorched&&(h.scorched.amount+=n),h.poisoned&&(h.poisoned+=n),debug&&(echo+=debug_name(e)+" intensifies "+f+" on "+debug_name(h)+" by "+n+"<br>"),h.backlash&&S(e,h))}return u},ignite:function(e,t,a){for(var r=k(e),n=t.x,i=t.y,o=t.all,s=V[r].assaults,l=[],c=0,d=s.length;c<d;c++){(h=s[c]).isAlive()&&h.isInFaction(i)&&l.push(c)}if(!l.length)return 0;o||(l=_(l)),n+=getEnhancement(e,t.id,n);var u=0;for(c=0,d=l.length;c<d;c++){var h;(h=s[l[c]]).invisible?(h.invisible--,debug&&(echo+=debug_name(e)+" ignites "+debug_name(h)+" but it is invisible!<br>")):(u++,h.scorch(n),debug&&(echo+=debug_name(e)+" ignites("+n+") "+debug_name(h)+"<br>"),h.backlash&&S(e,h))}return u},jamself:function(e,t){return e.jammed=!0,e.jammedSelf=!0,debug&&(echo+=debug_name(e)+" freezes itself<br>"),1},jam:function(e,t){b(e);for(var a=k(e),r=t.all,n=V[a].assaults,i=[],o=0,s=n.length;o<s;o++){(c=n[o]).isAlive()&&(r||c.isActiveNextTurn()&&c.isUnjammed())&&i.push(o)}if(!i.length)return 0;r||(i=_(i));var l=0;for(o=0,s=i.length;o<s;o++){var c;(c=n[i[o]]).invisible?(c.invisible--,t.countdown=0,debug&&(echo+=debug_name(e)+" freezes "+debug_name(c)+" but it is invisible!<br>")):(l++,c.jammed=!0,debug&&(echo+=debug_name(e)+" freezes "+debug_name(c)+"<br>"),c.backlash&&S(e,c))}return l},frost:function(e,r){b(e);var t=k(e),a=r.x,n=getEnhancement(e,r.id,a);a+=n;r.all;for(var i=V[t].assaults,o=[],s=e.key-1,l=s+2;s<=l;s++){(h=i[s])&&h.isAlive()&&o.push(s)}if(!o.length)return 0;for(var c=0,d=0,u=o.length;d<u;d++){var h;if((h=i[o[d]]).invisible)h.invisible--,debug&&(echo+=debug_name(e)+" breathes frost at "+debug_name(h)+" but it is invisible!<br>");else{c++;var f=a,m=M(h,f);T(e,h,f=m.damage,m.shatter,function(e,t,a){echo+="<u>(Frostbreath: +"+r.x,n&&(echo+=" Enhance: +"+n),echo+=m.echo,echo+=") = "+a+" damage</u><br>",echo+=debug_name(e)+" breathes frost at "+debug_name(t)+" for "+a+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"}),h.backlash&&S(e,h)}}return c},heartseeker:function(e,t){t.y;var a=k(e),r=t.x,n=V[a].assaults[e.key];return n?(r+=getEnhancement(e,t.id,r),n.heartseeker+=r,n.enfeebled+=r,debug&&(echo+=debug_name(e)+" inflicts heartseeker "+r+" on "+debug_name(n)+"<br>"),1):0},enfeeble:function(e,t){for(var a=t.y,r=(b(e),k(e)),n=t.x,i=t.all,o=V[r].assaults,s=[],l=0,c=o.length;l<c;l++){(u=o[l]).isAlive()&&u.isInFaction(a)&&s.push(l)}if(!s.length)return 0;i||(s=_(s)),n+=getEnhancement(e,t.id,n);var d=0;for(l=0,c=s.length;l<c;l++){var u;(u=o[s[l]]).invisible?(u.invisible--,debug&&(echo+=debug_name(e)+" hexes "+debug_name(u)+" but it is invisible!<br>")):(d++,u.enfeebled+=n,debug&&(echo+=debug_name(e)+" hexes "+debug_name(u)+" by "+n+"<br>"),u.backlash&&S(e,u))}return d},weakenself:function(e,t){return s.weaken(e,t)},weaken:function(e,t){var a,n=t.y;switch(t.id){case"weakenself":a=b(e);break;default:a=k(e)}var r=t.x,i=t.all,o=V[a].assaults,s=[],l=function(e){for(var t=0,a=o.length;t<a;t++){var r=o[t];r.isAlive()&&r.isInFaction(n)&&(i||r.isActiveNextTurn()&&r.isUnjammed()&&(e||r.hasAttack()))&&s.push(t)}};if(l(!1),s.length||l(!0),!s.length)return 0;i||(s=_(s));var c=getEnhancement(e,t.id,r);r+=c;for(var d=0,u=0,h=s.length;u<h;u++){var f=o[s[u]];f.invisible?(f.invisible--,debug&&(echo+=debug_name(e)+" weakens "+debug_name(f)+" but it is invisible!<br>")):(d++,f.attack_weaken+=r,debug&&(c&&(echo+="<u>(Enhance: +"+c+")</u><br>"),echo+=debug_name(e)+" weakens "+debug_name(f)+" by "+r+"<br>"),f.backlash&&S(e,f))}return d}},h={enlarge:function(e,t){var a=t.y,r=b(e),n=t.x,i=getEnhancement(e,t.id,n);n+=i;for(var o=t.all,s=V[r].assaults,l=[],c=0,d=s.length;c<d;c++){(h=s[c]).isAlive()&&h.isInFaction(a)&&(o||h.isUnjammed()&&h.isActive())&&l.push(c)}if(!l.length)return 0;o||(l=_(l));var u=0;for(c=0,d=l.length;c<d;c++){var h=s[l[c]],f=n;if(!f){var m=t.mult;f=Math.ceil(h.attack*m)}h.attack_rally+=f,debug&&(i&&(echo+="<u>(Enhance: +"+i+")</u><br>"),echo+=debug_name(e)+" enlarges "+debug_name(h)+" by "+f+"<br>"),u++}return u},rally:function(e,t){for(var a=t.y,r=b(e),n=t.x,i=t.all,o=V[r].assaults,s=[],l=0,c=o.length;l<c;l++){(h=o[l]).isAlive()&&h.isInFaction(a)&&(i||h.isActive()&&h.isUnjammed())&&s.push(l)}if(!s.length)return 0;i||(s=_(s));var d=getEnhancement(e,t.id,n);n+=d;var u=0;for(l=0,c=s.length;l<c;l++){var h;if((h=o[s[l]]).nullified)h.nullified--,debug&&(echo+=debug_name(e)+" empowers "+debug_name(h)+" but it is nullified!<br>");else{u++;var f=n;if(!f){var m=t.mult;f=Math.ceil(h.attack*m)}h.attack_rally+=f,debug&&(d&&(echo+="<u>(Enhance: +"+d+")</u><br>"),echo+=debug_name(e)+" empowers "+debug_name(h)+" by "+f+"<br>")}}return u},legion:function(e,t){var a=b(e),r=V[a].assaults,n=t.x,i=getEnhancement(e,t.id,n);n+=i;var o=t.y,s=e.key-1,l=s+2;s<0&&(s+=2);for(var c=0;s<=l;){var d=r[s];d&&d.isActive()&&d.isInFaction(o)&&(d.nullified?(d.nullified--,debug&&(echo+=debug_name(e)+" activates legion and empowers "+debug_name(d)+" but it is nullified!<br>")):(c++,d.attack_rally+=n,debug&&(i&&(echo+="<u>(Enhance: +"+i+")</u><br>"),echo+=debug_name(e)+" activates legion and empowers "+debug_name(d)+" by "+n+"<br>"))),s+=2}return c},fervor:function(e,t){var a=b(e),r=V[a].assaults,n=t.x,i=getEnhancement(e,t.id,n);n+=i;var o=t.y,s=0,l=e.key-1,c=l+2;for(l<0&&(l+=2);l<=c;){var d=r[l];d&&d.isInFaction(o)&&(s+=n),l+=2}return s?(e.attack_rally+=s,debug&&(i&&(echo+="<u>(Enhance: +"+i+")</u><br>"),echo+=debug_name(e)+" activates fervor for "+s+"<br>"),1):0},barrage:function(e,t){var a=k(e),r=t.x,n=t.y,i=t.all,o=V[a].assaults;r+=getEnhancement(e,t.id,r);for(var s=0;s<r;s++){for(var l=[],c=0,d=o.length;c<d;c++){(h=o[c]).isAlive()&&h.isInFaction(n)&&l.push(c)}if(!l.length)return 0;i||(l=_(l));var u=0;for(c=0,d=l.length;c<d;c++){var h;if((h=o[l[c]]).invisible)h.invisible--,debug&&(echo+=debug_name(e)+" throws a bomb at "+debug_name(h)+" but it is invisible!<br>");else{u++;var f=1,m=M(h,f,{enfeeble:!0});T(e,h,f=m.damage,m.shatter,function(e,t,a){echo+="<u>(Barrage: +1",echo+=m.echo,echo+=") = "+a+" damage</u><br>",echo+=debug_name(e)+" throws a bomb at "+debug_name(t)+" for "+a+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}}}return u},enhance:function(e,t){for(var a=t.y,r=b(e),n=(k(e),t.x),i=(a=t.y,t.s),o=t.mult,s=t.all,l=V[r].assaults,c=y(i),d=[],u=0,h=l.length;u<h;u++){(m=l[u]).isAlive()&&m.isInFaction(a)&&(s||!c||m.isActive()&&m.isUnjammed())&&m.hasSkill(i)&&d.push(u)}if(!d.length)return 0;s||(d=_(d));var f=0;for(u=0,h=d.length;u<h;u++){var m;if((m=l[d[u]]).nullified)m.nullified--,debug&&(echo+=debug_name(e)+" enhances "+debug_name(m)+" but it is nullified!<br>");else{f++;var g=m.enhanced;0<n?(g[i]=(g[i]||0)+n,debug&&(echo+=debug_name(e)+" enhances "+i+" of "+debug_name(m,!1)+" by "+n+"<br>")):0<o&&(g[i]=-o,debug&&(echo+=debug_name(e)+" enhances "+i+" of "+debug_name(m,!1)+" by "+100*o+"%<br>"))}}return f},enrage:function(e,t){for(var a=b(e),r=t.y,n=t.x,i=t.all,o=V[a].assaults,s=[],l=0,c=o.length;l<c;l++){(h=o[l]).isAlive()&&h.isInFaction(r)&&s.push(l)}if(!s.length)return 0;i||(s=_(s));var d=getEnhancement(e,t.id,n);n+=d;var u=0;for(l=0,c=s.length;l<c;l++){var h,f=n;(h=o[s[l]]).nullified?(h.nullified--,debug&&(echo+=debug_name(e)+" enrages "+debug_name(h)+" but it is nullified!<br>")):(u++,t.mult&&(f=Math.ceil(t.mult*h.health)),h.enraged+=f,debug&&(d&&(echo+="<u>(Enhance: +"+d+")</u><br>"),echo+=debug_name(e)+" enrages "+debug_name(h)+" by "+f+"<br>"))}return u},imbue:function(e,t){for(var a=t.y,r=b(e),n=(k(e),t.x),i=(t.c,t.s),o=t.all,s=V[r].assaults,l=y(i),c=[],d=0,u=s.length;d<u;d++){(f=s[d]).isAlive()&&f.isInFaction(a)&&(o||!l||f.isActive()&&f.isUnjammed())&&c.push(d)}if(!c.length)return 0;t={id:i,x:n};o||(c=_(c));var h=0;for(d=0,u=c.length;d<u;d++){var f;if((f=s[c[d]]).nullified)f.nullified--,debug&&(echo+=debug_name(e)+" enhances "+debug_name(f)+" but it is nullified!<br>");else if(h++,f.hasSkill(i)){var m=f.enhanced;m[i]=(m[i]||0)+n,debug&&(echo+=debug_name(e)+" imbues "+debug_name(f,!1)+" existing "+debug_skill(t)+" by "+n+"<br>")}else f.imbue(t),debug&&(echo+=debug_name(e)+" imbues "+debug_name(f,!1)+" with "+debug_skill(t)+"<br>")}return h},mark:function(e,t){for(var a=t.y,r=(b(e),k(e)),n=t.x,i=t.all,o=V[r].assaults,s=e.mark_target,l=[],c=0,d=o.length;c<d;c++){if((h=o[c]).isAlive()&&h.isInFaction(a)){if(h.uid===s){l=[c];break}l.push(c)}}if(!l.length)return 0;i||(l=_(l)),n+=getEnhancement(e,t.id,n);var u=0;for(c=0,d=l.length;c<d;c++){var h;u++,(h=o[l[c]]).enfeebled+=n,e.mark_target=h.uid,debug&&(echo+=debug_name(e)+" marks "+debug_name(h)+" by "+n+"<br>"),t.countdown=1}return u},snaretongue:function(e,t){for(var a=t.y,r=(b(e),k(e)),n=V[r].assaults,i=(e.mark_target,[]),o=0,s=n.length;o<s;o++){(l=n[o]).isAlive()&&l.isInFaction(a)&&i.push(o)}if(!i.length)return 0;var l=n[i.reduce(function(e,t){return n[t].health_left<n[e].health_left?t:e},i[0])],c=e.key,d=l.key;if(c==c)return debug&&(echo+=debug_name(e)+" activates snaretongue and keeps "+debug_name(l)+" in front of it<br>"),!1;if(n.splice(l.key,1),n.length<c){CARDS[0]=CARDS[0]||{id:"0",name:"Filler",picture:"",rarity:"0",set:"9999",card_type:"0",type:"0",sub_type:[],health:1,attack:0,cost:0,maxLevel:1,skill:[]};var u=get_card_by_id({id:0,level:1});u.name="filler",u.health_left=0;for(var h=n.length;h<c;h++)n.push(u)}n.splice(c,0,l);h=Math.min(c,d);for(var f=Math.max(c,d);h<=f;h++)n[h].key=h;return debug&&(echo+=debug_name(e)+" activates snaretongue and pulls "+debug_name(l)+" in front of it<br>"),t.countdown=1}},e={ambush:function(e,t,a){var r=a.x,n=a.base,i=a.mult,o=r;if(!o){i=a.mult;o=Math.ceil(t[n]*i)}return T(e,t,o,null,function(e,t,a){echo+=debug_name(e)+" ambushes "+debug_name(t)+" for "+a+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"}),1},slow:function(e,t,a){var r=a.x,n=a.base,i=a.mult,o=r;if(!o){i=a.mult;o=Math.ceil(t[n]*i)}return t.timer+=o,debug&&(echo+=debug_name(e)+" slows "+debug_name(t)+" by "+o+"<br>"),1}},o={unearth:function(e,t,a){if(!e.isToken){var r=makeUnitInfo(a.card||e.id,a.level||a.x),n=get_card_apply_battlegrounds(r,null,!0);n.isToken=!0;var i=a.mult;return i&&(n.attack=Math.floor(e.attack*i),n.health=Math.floor(e.health*i)),c(n,e.owner,!0),debug&&(echo+=debug_name(n)+" is unearthed</br>"),1}},reanimate:function(e,t,a){return e.reanimated?0:(e.health_left=a.x,e.reanimated=!0,debug&&(echo+=" and is reanimated</br>"),1)}};function I(e){if(e.silenced)debug&&(echo+=debug_name(e)+" is silenced and cannot use skills</br>");else for(var t=e.skill,a=u(e),r=0,n=t.length;r<n&&a();r++){var i=t[r];if(!i.countdown){var o=d(s,i.id)(e,i);i.c&&0<o&&(i.countdown=i.c),showAnimations&&drawField(V,null,null,J,e)}}}function n(){cache_player_deck=getdeck?hash_decode(getdeck):getcardlist?load_deck_from_cardlist(getcardlist):load_deck_from_cardlist(),cache_player_deck_cards=getDeckCards(cache_player_deck,"player"),pvpAI=!0,getdeck2?(cache_cpu_deck=hash_decode(getdeck2),getmission&&(pvpAI=!1)):getcardlist2?cache_cpu_deck=load_deck_from_cardlist(getcardlist2):getmission?(cache_cpu_deck=load_deck_mission(getmission,missionlevel),pvpAI=!1):getraid?(cache_cpu_deck=load_deck_raid(getraid,raidlevel),pvpAI=!1):cache_cpu_deck=load_deck_from_cardlist(),cache_cpu_deck_cards=getDeckCards(cache_cpu_deck,"cpu")}function i(l){var c=l.uids={};["player","cpu"].forEach(function(e){for(var t=W[e],a=t.deck,r="player"===e?1:101,n=0;n<a.length;n++){var i=r+n,o=a[n];o.owner=e,o.played=!1,o.uid=i,c[i]=o}var s=t.commander;s.owner=e,s.health_left=s.health,s.reusableSkills||s.resetTimers();i="player"===e?-1:-2;s.uid=i,c[i]=s,l[e].commander=s})}function f(e,t){clearFrames(),l(e,t)}function l(e,t){if(SIMULATOR.pause)return SIMULATOR.pause=!1;var a=function(e,t){var a,r;r=surge?(a="cpu","player"):(a="player","cpu");if(0<e){if(q&&(!V.player.commander.isAlive()||!V.cpu.commander.isAlive()))return!(z=!1);if(!m(e,V,a,r,t))return!1;if(!V.player.commander.isAlive()||!V.cpu.commander.isAlive())return!(z=!1)}else!surge&&SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(e);for(e++;e<=max_turns+1;e++){if(e==max_turns+1)return!(z=!1);g(e,a,r,V);if(!m(e,V,a,r,!0))return!1;if(!V.player.commander.isAlive()||!V.cpu.commander.isAlive())return debug&&(echo+="<u>Turn "+e+" ends</u><br><br></div>"),!(z=!1)}return!(z=!1)}(e,t);return a&&K&&SIM_CONTROLLER.debug_end(),a}function m(e,t,a,r,n){if(e%2)var i=a,o=r;else i=r,o=a;return closeDiv=!1,!!function(e,t,a){var r=W[e],n=r.deck,i=r.ordered;{if(q&&"cpu"===e&&a)return w(e,n,i,t,a),!1;if(n[0]){SIMULATOR.waiting=!1;var o=0;if(1==n.length)o=0;else{for(var s=0;s<n.length;s++){var l=n[s];if(l.trap&&(c(l.trap,e,t),l.trap=!1),2===s)break}o=r.chooseCard(e,n,i,t,a)}if(o<0)return!1;c(n[o],e,t),function(e,t){var a=t,r=e.length-1;for(;a<r;)e[a]=e[++a];e.length=a}(n,o)}}return!0}(i,e,n)&&(function(e,t,a,r){for(var n=a[e],i=n.commander,o=n.assaults,s=a[t],l=s.commander,c=s.assaults,d=0;d<j.onTurn.length;d++){var u=j.onTurn[d];u.enemy_only&&"cpu"!==e||(u.ally_only&&"player"!==e||(u.owner=e,p(u),I(u)))}p(n.commander);for(var h=0,f=o.length;h<f;h++){var m=o[h];R(m,"evade","invisible"),R(m,"absorb","warded")}(function(e){for(var t=e.assaults,a=0,r=t.length;a<r;a++){var n=t[a];if(n.isAlive()&&n.isActive()&&n.isUnjammed()){var i=n.flurry;i&&0===i.countdown&&n.hasAttack()&&(i.countdown=i.c,n.dualstrike_triggered=!0),p(n)}}})(n),I(i);for(var h=0,f=o.length;h<f;h++){var m=o[h];if(m.isAlive()&&m.isActive())if(m.jammed)debug&&(echo+=debug_name(m)+" is frozen and cannot attack<br>");else{var g=1;for(m.dualstrike_triggered&&(g++,debug&&(echo+=debug_name(m)+" activates dualstrike<br>"));0<g;g--)if(I(m),m.isAlive())if(m.hasAttack()){if(B(m,c,l),!l.isAlive()||!i.isAlive())return;if(!m.isAlive())break}else debug&&0<m.permanentAttack()&&(echo+=debug_name(m)+" is weakened and cannot attack<br>")}}(function(e){for(var t=0,a=e.length;t<a;t++){var r=e[t];if(r.jammedSelf?r.jammedSelf=!1:r.jammed=!1,r.attack_rally=0,r.attack_weaken=0,r.nullified=0,r.dualstrike_triggered=!1,r.silenced=!1,r.regenerate&&r.isDamaged()){var n=r.regenerate,i=getEnhancement(r,"regenerate",n);n+=i;var o=r.health-r.health_left;o<=n&&(n=o),r.health_left+=n,debug&&(echo+=debug_name(r)+" regenerates "+n+" health<br>")}var s=r.poisoned;if(s){var l=r.warded;l&&(s-=F(r,"warded",s)),T(null,r,s,null,function(e,t,a){echo+=debug_name(t)+" takes "+a,l&&(echo+=" (Poison: +"+r.poisoned+" Ward: -"+l+")"),echo+=" poison damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}var s=r.envenomed;if(s){var l=r.warded;l&&(s-=F(r,"warded",s)),T(null,r,s,null,function(e,t,a){echo+=debug_name(t)+" takes "+a,l&&(echo+=" (Venom: +"+r.envenomed+" Ward: -"+l+")"),echo+=" venom damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}var c=r.scorched;if(c){s=c.amount;var l=r.warded;l&&(s-=F(r,"warded",s)),T(null,r,s,null,function(e,t,a){echo+=debug_name(t)+" takes "+a,l&&(echo+=" (Scorch: +"+c.amount+" Ward: -"+l+")"),echo+=" scorch damage",t.isAlive()?t.scorched||(echo+=" and scorch wears off"):echo+=" and it dies",echo+="<br>"}),1<c.timer?c.timer--:r.scorched=0}var d=r.corroded;if(d)if(d.timer--,d.timer<0)r.corroded=!1,r.attack_corroded=0,debug&&(echo+=debug_name(r)+" recovers from corrosion<br>");else{var u=d.amount;r.attack_corroded=u,debug&&(echo+=debug_name(r)+" loses "+u+" attack to corrosion<br>")}r.isAlive()||x(r,null)}})(o),v("player"),v("cpu"),debug&&(echo+="<u>Turn "+r+" ends</u><br><br></div>")}(i,o,t,e),!0)}function A(e,t,a){var r=t[a];return r?e+" draws "+debug_name(r,!0)+"<br/>":""}function g(e,t,a,r){if(choice=void 0,(H=e)%2)var n=t,i=a;else n=a,i=t;if(debug){var o=debug_name(r[n].commander),s=W[n].deck;echo+='<div id="turn_"'+e+' class="turn-info"><hr/><br/><u>Turn '+e+" begins for "+o+"</u><br>",e<=2&&(echo+=A(o,s,0),echo+=A(o,s,1)),echo+=A(o,s,2)}var l=r[n],c=r[i],d=l.assaults,u=c.assaults;U(l.commander);for(var h=0,f=d.length;h<f;h++){var m=d[h];if(0<m.timer&&(3===e&&tournament||(m.timer--,debug&&(echo+=debug_name(m)+" reduces its timer<br>"))),m.valor){var g=u[h];g&&m.adjustedAttack()<g.adjustedAttack()?(m.attack_valor+=m.valor,debug&&(echo+=debug_name(m)+" activates valor, boosting its attack by "+m.valor+"<br/>")):debug&&(echo+=debug_name(m)+" activates valor but ",echo+=g?"enemy is not strong enough.<br/>":"there is no opposing enemy.<br/>")}m.enfeebled=m.envenomed+m.heartseeker,m.enraged=0,m.invisible=0,m.protected=0,m.barrier_ice=0,m.warded=0,m.enhanced={},m.removeImbue(),U(m)}}function w(e,t,a,r,n){return SIMULATOR.waiting=!0,closeDiv=!0,n&&(hideTable(),outputTurns(echo),drawField(V,null,l,r),SIMULATOR.sendBattleUpdate(r)),-1}function D(e,t,a,r,n){var i=t.slice(0,3);closeDiv=!0;for(var o=[],s=[],l=0,c=i.length;l<c;l++){var d=i[l],u=l+": "+d.name;1<d.maxLevel&&(u+="{"+d.level+"/"+d.maxLevel+"}"),o.push(u),s.push(d)}if(n&&(hideTable(),outputTurns(echo),drawField(V,s,f,r)),void 0===choice)return-1;var h=choice;return h||(h=0),h}function C(e,t,a,r,n){if(void 0===a)return 0;for(var i=t.slice(0,3),o=!1,s=0,l=a.length;s<l;s++){for(var c,d=a[s],u=d.priority,h=-1,f=0,m=i.length;f<m;f++){var g=(c=i[f]).priority;if(areEqual(d,c)){o=!0;break}0<u&&u==g&&(h=f)}if(!o&&0<=h&&(o=!0,c=i[f=h]),o){for(var v=a.length-1;s<v;s++)a[s]=a[s+1];return a.length=s,f}}return-1}function $(e,t,a,r,n){var i=t.slice(0,3);return~~(Math.random()*i.length)}function N(e,t,a,r,n){for(var i,o,s,l,c,d=t.slice(0,3),u=-1,h=-1,f=0;f<d.length;f++){var m=d[f],g=(void 0,o=(i=m).id.toString(),s=6*parseInt(i.rarity),l=3*(4<o.length?parseInt(o[0]):0),c=parseInt(i.level)-parseInt(i.maxLevel),s+l+c);h<g&&(h=g,u=f)}return u}function O(e,t,a,r,n){return 0}function R(e,t,a){var r=0;e[t]&&(r=e[t],r+=getEnhancement(e,t,r));e[a]=r}function M(e,t,a){var r=(a=a||{}).enfeeble?0:e.enfeebled||0,n=a.stasis?0:L(e),i=a.protect?0:e.protected||0,o=a.ward?0:e.warded||0;t+=r-n;var s=!1;o&&(t-=F(e,"warded",t)),i&&(t-=F(e,"protected",t),0==e.protected&&(s=e.barrier_ice)),n&&(t-=n);var l="";return debug&&(r&&(l+=" Enfeeble: +"+r),n&&(l+=" Stasis: -"+n),i&&(l+=" Barrier: -"+i),o&&(l+=" Ward: -"+o)),t<0&&(t=0),{damage:t,shatter:s,echo:l}}function F(e,t,a){var r=e[t];return r<=a?(e[t]=0,r):(e[t]-=a,a)}function U(e){P(e,e.skill),P(e,e.earlyActivationSkills);var t=e.flurry;t&&t.countdown&&(t.countdown--,debug&&(t.countdown?echo+=debug_name(e)+" charges  dualstrike (ready in "+t.countdown+" turns)<br/>":echo+=debug_name(e)+" readies dualstrike<br/>"))}function P(e,t){for(var a=0,r=t.length;a<r;a++){var n=t[a];n.countdown&&(n.countdown--,debug&&(n.countdown?echo+=debug_name(e)+" charges "+convertName(n.id)+" (ready in "+n.countdown+" turns)<br/>":echo+=debug_name(e)+" readies "+convertName(n.id)+"<br/>"))}}function B(e,t,a){var r=t[e.key];if(r&&r.isAlive()){var n,i=!1;if(!r.taunt)if((n=t[e.key-1])&&n.taunt)r=n,i=!0;else(n=t[e.key+1])&&n.taunt&&(r=n,i=!0);i&&debug&&(echo+=debug_name(r)+" taunts "+debug_name(e))}else r=a;var o=e.adjustedAttack(),s=r.enfeebled;o+=s,debug&&(echo+="<u>(Attack: +"+e.attack,e.attack_berserk&&(echo+=" Berserk: +"+e.attack_berserk),e.attack_valor&&(echo+=" Valor: +"+e.attack_valor),e.attack_rally&&(echo+=" Rally: +"+e.attack_rally),e.attack_weaken&&(echo+=" Weaken: -"+e.attack_weaken),e.attack_corroded&&(echo+=" Corrosion: -"+e.attack_corroded),s&&(echo+=" Enfeeble: +"+s));var l=e.pierce;l?l+=getEnhancement(e,"pierce",l):l=0;var c=r.protected,d=!1,u=r.armored,h=L(r);if(c&&(debug&&(echo+=" Barrier: -"+c),l&&(c<=l?(debug&&(echo+=" Pierce: +"+c),l-=c,c=0,r.protected=0):(debug&&(echo+=" Pierce: +"+l),c-=l,r.protected-=l,l=0)),c&&(c<=o?(d=r.barrier_ice,o-=c,r.protected=0):(r.protected-=o,o=0))),h&&(h+=getEnhancement(r,"stasis",h),debug&&(echo+=" Shroud: -"+h),l&&(h<l?(debug&&(echo+=" Pierce: +"+h),h=0):(debug&&(echo+=" Pierce: +"+l),h-=l)),o-=h),u&&(u+=getEnhancement(r,"armored",u),debug&&(echo+=" Armor: -"+u),l&&(u<l?(debug&&(echo+=" Pierce: +"+u),u=0):(debug&&(echo+=" Pierce: +"+l),u-=l)),o-=u),o<0&&(o=0),debug&&(echo+=") = "+o+" damage</u><br>"),T(e,r,o,null,function(e,t,a){echo+=debug_name(e)+" attacks "+debug_name(t)+" for "+a+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"}),showAnimations&&drawField(V,null,null,J,e),a.isAlive()){if(0<o&&r.isAssault()&&r.isAlive()){if(e.poison){var f=e.poison;(f+=getEnhancement(e,"poison",f))>r.poisoned&&(r.poisoned=f,debug&&(echo+=debug_name(e)+" inflicts poison("+f+") on "+debug_name(r)+"<br>"))}if(e.venom){var m=e.venom;if((m+=getEnhancement(e,"venom",m))>r.envenomed){var g=m-r.envenomed;r.envenomed=m,r.enfeebled+=g,debug&&(echo+=debug_name(e)+" inflicts venom("+m+") on "+debug_name(r)+"<br>")}}if(e.nullify){var v=e.nullify;v+=getEnhancement(e,"nullify",v),r.nullified+=v,debug&&(echo+=debug_name(e)+" inflicts nullify("+v+") on "+debug_name(r)+"<br>")}if(e.silence&&(r.silenced=!0,debug&&(echo+=debug_name(e)+" inflicts silence on "+debug_name(r)+"<br>")),e.daze){var p=e.daze;p+=getEnhancement(e,"daze",p),r.attack_weaken+=p,debug&&(echo+=debug_name(e)+" dazed "+debug_name(r)+" for "+p+"<br>")}}if(d&&E(r),0<o&&e.isAlive()){if(e.leech&&e.isDamaged()){var _=e.leech;_+=getEnhancement(e,"leech",_);var b=e.health-e.health_left;b<=_&&(_=b),e.health_left+=_,debug&&(echo+=debug_name(e)+" siphons "+_+" health<br>")}if(e.reinforce){var k=e.reinforce;k+=getEnhancement(e,"reinforce",k),e.protected+=k,debug&&(echo+=debug_name(e)+" reinforces itself with barrier "+k+"<br>")}if(r.counter){var y=0+r.counter;G(e,r,"Vengance",y,getEnhancement(r,"counter",y))}if(r.counterburn){var S=r.counterburn||0;S+=getEnhancement(r,"counterburn",S),e.scorched?(e.scorched.amount+=S,e.scorched.timer=2):e.scorched={amount:S,timer:2},debug&&(echo+=debug_name(r)+" inflicts counterburn("+S+") on "+debug_name(e)+"<br>")}if(r.counterpoison){f=r.counterpoison||0;(f+=getEnhancement(r,"counterpoison",f))>e.poisoned&&(e.poisoned=f,debug&&(echo+=debug_name(r)+" inflicts counterpoison("+f+") on "+debug_name(e)+"<br>"))}if(r.fury){var I=r.fury,A=getEnhancement(r,"counter",I);if(r.isAlive()){var w=I+A;r.attack_berserk+=w,debug&&(echo+=debug_name(r)+" activates fury and gains "+w+" attack<br>")}G(e,r,"Fury",I,A)}if(0<r.enraged&&(r.attack_berserk+=r.enraged,debug&&(echo+=debug_name(r)+" is enraged and gains "+r.enraged+" attack!</br>")),e.berserk){var D=e.berserk;D+=getEnhancement(e,"berserk",D),e.attack_berserk+=D,debug&&(echo+=debug_name(e)+" activates berserk and gains "+D+" attack<br>")}}if(r.corrosive){var C=r.corrosive||0;C+=getEnhancement(r,"corrosive",C),e.corroded?(e.corroded.amount+=C,e.corroded.timer=2):e.corroded={amount:C,timer:2},debug&&(echo+=debug_name(r)+" inflicts corrosion("+C+") on "+debug_name(e)+"<br>"),e.attack_corroded=C,debug&&(echo+=debug_name(e)+" loses "+C+" attack to corrosion<br>")}e.isAlive()||x(e,r),showAnimations&&drawField(V,null,null,J,e)}}function G(e,t,r,a,n){var i=a+n,o=M(e,i,{enfeeble:!0});i=o.damage;o.shatter;debug&&(echo+="<u>("+r+": +"+a,n&&(echo+=" Enhance: +"+n),echo+=o.echo,echo+=") = "+i+" damage</u><br>"),T(t,e,i,null,function(e,t,a){echo+=debug_name(t)+" takes "+a+" "+r.toLowerCase()+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}SIMULATOR.pause=!1,SIMULATOR.performTurns=l,SIMULATOR.waitForOpponent=w;var j,W={},V={},H=0,z=!1,K=!1,q=!1,J=0,Y=0,Q=0;SIMULATOR.simulate=function(){if(z=!0,function(){SIMULATOR.simulation_turns=0;var e={cpu:{deck:[]},player:{deck:[]}};SIMULATOR.deck=e,SIMULATOR.field={cpu:{assaults:[]},player:{assaults:[]}},cache_player_deck_cards&&(e.player=copy_deck(cache_player_deck_cards)),getmission&&1<missionlevel&&missionlevel<7?(cache_cpu_deck=load_deck_mission(getmission,missionlevel),cache_cpu_deck_cards=getDeckCards(cache_cpu_deck,"cpu")):getraid&&(cache_cpu_deck=load_deck_raid(getraid,raidlevel),cache_cpu_deck_cards=getDeckCards(cache_cpu_deck,"cpu")),cache_cpu_deck_cards&&(e.cpu=copy_deck(cache_cpu_deck_cards)),getordered&&!getexactorder&&(e.player.ordered=copy_card_list(e.player.deck)),getordered2&&!getexactorder2&&(e.cpu.ordered=copy_card_list(e.cpu.deck)),e.player.chooseCard=K?D:getordered?C:$,e.cpu.chooseCard=getordered2?C:pvpAI?N:getexactorder2?$:O}(),getexactorder?getordered||(W.player.shuffleHand=!0):shuffle(W.player.deck),getexactorder2?getordered2||(W.cpu.shuffleHand=!0):shuffle(W.cpu.deck),i(V),getsiege){var e=BATTLEGROUNDS[tower_type].effect[tower_level];if(e){e=makeUnitInfo(e.id,e.level);var t=get_card_apply_battlegrounds(e);t.uid=150,c(V.uids[150]=t,"cpu",-1,!0)}}return l(0)},SIMULATOR.onPlaySkills=e,SIMULATOR.calculatePoints=function(e){var t=V.uids,a={player:{total:0,taken:0},cpu:{total:0,taken:0}};for(var r in t){var n=t[r],i=a[n.owner];i&&(i.total+=n.health,(n.played||n.isCommander())&&(i.taken+=n.health-n.health_left))}a.player.percent=i.taken/i.total,a.cpu.percent=i.taken/i.total;var o=V.cpu.commander;if(getdeck2)if(o.isAlive()&&!e)var s=Math.floor(25*a.cpu.percent);else s=130-Math.floor(15*a.player.percent);else s=o.isAlive()&&!e?(s=Math.floor(a.cpu.percent/.02),Math.max(5,s)):200-Math.floor(a.player.percent/.02);return s},Object.defineProperties(SIMULATOR,{setupDecks:{get:function(){return n},set:function(e){n=e}},setupField:{get:function(){return i},set:function(e){i=e}},deck:{get:function(){return W},set:function(e){W=e}},field:{get:function(){return V},set:function(e){V=e}},battlegrounds:{get:function(){return j},set:function(e){j=e}},simulation_turns:{get:function(){return H},set:function(e){H=e}},simulating:{get:function(){return z},set:function(e){z=e}},totalDeckHealth:{get:function(){return Y},set:function(e){Y=e}},totalCpuDeckHealth:{get:function(){return Q},set:function(e){Q=e}},user_controlled:{get:function(){return K},set:function(e){K=e}},livePvP:{get:function(){return q},set:function(e){q=e}}})}(),function(){function e(){CARD_GUI.draw_cards(SIMULATOR.field)}SIM_CONTROLLER.end_sims_callback=function(){hideUI(),e()},SIM_CONTROLLER.stop_sims_callback=e}();var battle_sim=!0;!function(e){"use strict";var t=function(e,t,a){return e.filter(function(e){return e[a]==t})},a=function(e,t,a,r,n){var i=a.filter(function(e){return e.id==t})[0];if(i){var o=i[r];return e.filter(function(e){var t=e[n];return 0<=o.indexOf(t)})}return[]};e.module("core",[]).filter("forMissions",function(){return function(e,t){if(!e||!t)return e;for(var a=[],r=0,n=e.length;r<n;r++){for(var i=e[r],o=i.missions,s=!0,l=0;l<o.length;l++){if(!t[o[l]]){s=!1;break}}s&&a.push(i)}return a}}).filter("filterByParent",function(){return t}).filter("filterChildren",function(){return a}),e.module("simulatorApp",["core"]).controller("SimulatorCtrl",["$scope","$window",function(n,e){function t(e){var t=Object.keys(e);t.sort(function(e,t){return Number(e)-Number(t)});for(var a=[],r=0;r<t.length;r++){var n=t[r],i=e[n];a.push(i)}return a}function a(e){var t=[];for(var a in e)t.push(e[a]);return t}n.locations=[],n.campaigns=[],n.missions=e.TITANS,n.raids=e.RAIDS,n.battlegrounds=e.BATTLEGROUNDS,n.mapBattlegrounds=a(e.MAP_BATTLEGROUNDS),n.campaignBGEs=[],n.tower=!1,n.auto=!1,n.debugMode=!1,n.selections={location:"",campaign:"",mission:"",raid:""},n.titans=function(){n.campaigns=a(e.CAMPAIGNS),n.missions=e.TITANS},n.campaignSections=function(){n.locations=t(e.LOCATIONS).sort(function(e,t){return Number(e.id)-Number(t.id)}),n.missions=t(e.MISSIONS),n.campaigns=t(e.CAMPAIGNS)},n.filteredRaids=function(){var t={};return a(n.raids).sort(function(e,t){return Number(t.id)-Number(e.id)}).forEach(function(e){t[e.name]||(t[e.name]=e)}),a(t).sort(function(e,t){return Number(e.id)-Number(t.id)})},n.getLocationClass=function(e){if(!e){var t=n.selections.location;e=n.locations.filter(function(e){return e.id==t})[0]}if(e){var a=Number(e.id);return 0===a?"heroUpgrade":100<=a?"event":"black"}return"grey"},n.getCampaignClass=function(e){if(!e){var t=n.selections.campaign;e=n.campaigns.filter(function(e){return e.id==t})[0]}return e?e.side_mission?0==e.location_id?"heroUpgrade":"mythic":e.isLocation?"location":"black":"grey"},n.$watch("selections.location",function(e,t){n.selections.campaign=""}),n.$watch("selections.campaign",function(e,t){n.selections.mission=""}),n.towerTypes=["Castle Tower","Cannon Tower","Tree of Life"],n.selectableBattlegrounds=function(){var e=[];for(var t in n.battlegrounds){var a=n.battlegrounds[t];a.hidden||a.isTower||e.push(a)}return e.sort(function(e,t){return e.id-t.id}),e},n.personalBattlegrounds=function(){var e=[];for(var t in n.battlegrounds){var a=n.battlegrounds[t],r=Number(a.id);1e3<r&&r<2e3&&e.push(a)}return e.sort(function(e,t){return e.id-t.id}),e},n.towerTypes=function(){var e=[];for(var t in n.battlegrounds){var a=n.battlegrounds[t];a.isTower&&e.push(a)}return e.sort(function(e,t){return e.id-t.id}),e},n.$watch("debugMode",function(e,t){})}])}(angular);var loadDeckDialog,mapBGEDialog,storageAPI={};function doneLoading(){$("body").removeClass("loading"),checkTutorial()}function updateGameData(e){var t=doneLoading;e&&(t=function(){doneLoading(),e()}),DATA_UPDATER.updateData(t,!0)}function setDeckSortable(e,l){$(e).sortable({items:".card:not(.commander):not(.blank)",tolerance:"intersect",helper:function(e,t){return t.clone()},start:function(e,t){var a=t.placeholder.index()-1;t.item.data("origPos",a),$(t.item).hide()},stop:function(e,t){var a=t.item.data("origPos")-1,r=t.item.index()-1,n=$(l),i=hash_decode(n.val()),o=i.deck;o.splice(r,0,o.splice(a,1)[0]);var s=hash_encode(i);n.val(s)}})}function showMapBGEs(){mapBGEDialog.dialog("open"),mapBGEDialog.dialog("option","position",{my:"center",at:"center",of:window})}function loadDeck(e){$('label[for="loadDeckName"]').html("<strong>Deck:</strong>"),loadDeckDialog.dialog("open"),loadDeckDialog.dialog("option","position",{my:"center",at:"center",of:window}),loadDeckDialog.hashField=e}function onDeckLoaded(e,t){$(t).val(e).change()}!function(t){"use strict";var a;try{a=t.module("simulatorApp")}catch(e){a=t.module("simulatorApp",[])}a.controller("DeckStorageCtrl",["$scope","$window",function(e,t){e.getSavedDecks=t.storageAPI.getSavedDecks,e.keys=function(e){return e?Object.keys(e):[]}}])}(angular),function(e){try{var t=window.localStorage,a="__storage_test__";return t.setItem(a,a),t.removeItem(a),!0}catch(e){return!1}}()?function(){var n="SavedDecks",i="Tutorial";function o(e){var t=localStorage.getItem(e);if(t)try{t=JSON.parse(t)}catch(e){t={}}else t={};return storageAPI.data[e]=t}storageAPI.initialize=function(){var e,t=getCurrentPage();void 0===(e=o(n)).savedDecks&&storageAPI.setField(n,"savedDecks",e),storageAPI.getField(n,"savedDecks",{}),storageAPI.shouldShowTutorial=storageAPI.getField(i,t,!0)[t];var a=storageAPI.onUpdateDecks;storageAPI.onUpdateDecks=function(e){a(),storageAPI.setField(n,"savedDecks",e)};var r=storageAPI.setShowTutorial;storageAPI.setShowTutorial=function(e){r(e),storageAPI.setField(i,t,e)}},storageAPI.getField=function(e,t,a){var r=o(e)[t];return void 0===r&&(r=a,storageAPI.setField(e,t,r)),r},storageAPI.setField=function(e,t,a){var r=o(e);r[t]=a,localStorage.setItem(e,JSON.stringify(r))},window.addEventListener("storage",function(e){"__storage_test__"!==e.key&&(localStorage.getItem(e.key)!==e.newValue&&angular.element("#loadDeckDialog").scope().$apply(localStorage.setItem(e.key,e.newValue)))})}():function(){storageAPI.initialize=function(){storageAPI.getSavedDecks=function(){return{}},storageAPI.loadDeck=e,storageAPI.deleteDeck=e,storageAPI.clearDecks=e,storageAPI.getField=function(e,t,a){return a},storageAPI.setField=function(){},storageAPI.savedDecks={},storageAPI.shouldShowTutorial=!0};var e=function(e,t){alert("Your browser does not support this feature.")}}(),function(){var e,t="SavedDecks";storageAPI.data={},storageAPI.getSavedDecks=function(){return storageAPI.getField(t,"savedDecks",{})},storageAPI.saveDeck=function(e,t){var a=storageAPI.getSavedDecks();a[e]=t,storageAPI.onUpdateDecks(a)},storageAPI.loadDeck=function(e){return storageAPI.getSavedDecks()[e]},storageAPI.deleteDeck=function(e){var t=storageAPI.getSavedDecks();delete t[e],storageAPI.onUpdateDecks(t)},storageAPI.clearDecks=function(e){var t=storageAPI.getSavedDecks();for(var e in t)delete t[e];storageAPI.onUpdateDecks(t)},storageAPI.onUpdateDecks=function(){e||(e=angular.element("#loadDeckDialog").scope()),e.$apply()},storageAPI.setShowTutorial=function(e){shouldShowTutorial=e},storageAPI.initialize()}(),$(function(){$("#deck1").change(function(){this.value=this.value.trim(),n("attack_deck",hash_decode(this.value),"player")}),$("#deck2").change(function(){this.value=this.value.trim(),n("defend_deck",hash_decode(this.value),"cpu")}),$("#battleground").change(function(){$("#deck1").change(),$("#deck2").val()?$("#deck2").change():$("#mission").val()?$("#mission").change():$("#raid").val()&&$("#raid").change()});for(var e=$("label[bge-desc]"),t=0;t<e.length;t++){$(e[t]).hover(a,r)}function a(e){var t=$("#tooltip"),a=$("#tooltip-text");a.html($(e.target).attr("bge-desc")),a.width(200),t.show(),$("#tooltip .arrow").css("borderTopWidth",0).css("borderBottomWidth",0);var r=$(e.target).offset();r.left-=230,r.top-=t.outerHeight()/2-10,t.offset(r);var n=a.innerHeight()/2-4;$("#tooltip .arrow").css("borderTopWidth",n).css("borderBottomWidth",n)}function r(e){$("#tooltip").hide()}function n(e,t,a){var r=$("#"+e);if(r.children().remove(),!_DEFINED("seedtest")){SIM_CONTROLLER.getConfiguration();var n=getBattlegrounds(getbattleground,selfbges,enemybges,mapbges,getcampaign,missionlevel,getraid,raidlevel);n=n.onCreate.filter(function(e){return!("player"===a&&e.enemy_only||"cpu"===a&&e.ally_only)}),r.append(CARD_GUI.makeDeckHTML(t,!1,n))}}$(".accordion").accordion({collapsible:!0,active:!1,heightStyle:"content"}).filter(".start-open").accordion("option","active",0);if($("#raid, #raid_level").change(function(){var e,t=$("#raid").val(),a=$("#raid_level");t?(e=load_deck_raid(t,a.val()),"Dungeon"===RAIDS[t].type?a.attr("max",150):a.attr("max",40)):(e=hash_decode(""),a.attr("max",40)),n("defend_deck",e,"cpu")}),$("#location, #campaign").change(function(){$("#mission").change()}),$("#mission, #mission_level").change(function(){var e,t=$("#mission").val();t?e=load_deck_mission(t,$("#mission_level").val()):e=hash_decode("");n("defend_deck",e,"cpu")}),loadDeckDialog=$("#loadDeckDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{Delete:function(){var e=$("#loadDeckName").val();storageAPI.deleteDeck(e)},Load:function(){var e=$("#loadDeckName").val();onDeckLoaded(storageAPI.loadDeck(e),loadDeckDialog.hashField),loadDeckDialog.dialog("close")},Cancel:function(){loadDeckDialog.dialog("close")}}}),mapBGEDialog=$("#bgeDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{OK:function(){mapBGEDialog.dialog("close")},Cancel:function(){mapBGEDialog.dialog("close")}}}),n("attack_deck",hash_decode("")),n("defend_deck",hash_decode("")),debug_dump_decks=function(){},setDeckSortable("#attack_deck","#deck1"),setDeckSortable("#defend_deck","#deck2"),_DEFINED("latestCards")){var i=null;_DEFINED("autostart")&&(i=function(){SIM_CONTROLLER.startsim(1)}),updateGameData(i)}else loadCardCache();processQueryString()});var dark=!1;function toggleTheme(){dark?($("#theme").attr("href","dist/light.min.css"),$("#toggleTheme").val("Dark Theme")):($("#theme").attr("href","dist/dark.min.css"),$("#toggleTheme").val("Light Theme")),dark=!dark}var frames=[],frameInterval=null;function drawField(e,t,a,r,n){var i=CARD_GUI.doDrawField(e,t,a,r,n);frames.push(i),frameInterval||(drawFrames(),frameInterval=setInterval(drawFrames,500))}function clearFrames(){frames=[],clearInterval(frameInterval),frameInterval=null}var deckPopupDialog,style,disabledInterval=!1;function drawFrames(){if(0===frames.length)disabledInterval?(clearInterval(frameInterval),frameInterval=null):disabledInterval=!0;else{var e=frames.splice(0,1)[0];$("#cardSpace").children().remove().end().append(e),disabledInterval=!1}}function processQueryString(){if($("#header").load("templates/header.html",function(){"undefined"!=typeof showTutorial&&$("#help").click(showTutorial)}),$.holdReady(!0),$("#footer").load("templates/footer.html",function(){$.holdReady(!1)}),!document.getElementById("ui"))return 0;angular.element(document.getElementById("ui")).scope();$("#generate_link").on("click",display_generated_link),$("#btn_simulate").on("click",SIM_CONTROLLER.startsim),$("#btnStop").on("click",SIM_CONTROLLER.stopsim),$("#display_history").on("click",display_history),$("#deck1").val(_GET("deck1")).change(),$("#deck2").val(_GET("deck2")).change(),$("#surge").prop("checked",_DEFINED("surge")),$("#siege").prop("checked",_DEFINED("siege"));var e=Math.min(Math.max(_GET("tower_level")||18,0),18);$("#tower_level").val(e);var t=_GET("tower_type")||501;$("#tower_type").val(t),$("#auto_mode").prop("checked",_DEFINED("auto_mode")),$("#tournament").prop("checked",_DEFINED("tournament")),$("#ordered").prop("checked",_DEFINED("ordered")),$("#exactorder").prop("checked",_DEFINED("exactorder")),$("#ordered2").prop("checked",_DEFINED("ordered2")),$("#exactorder2").prop("checked",_DEFINED("exactorder2")),_DEFINED("randomAI")&&(pvpAI=!1);var a=_GET("location"),r=_GET("campaign"),n=_GET("mission"),i=_GET("raid");if(a&&$("#location").val(a).change(),r&&(a||(a=CAMPAIGNS[r].location_id,$("#location").val(a).change()),$("#campaign").val(r).change()),n&&($("#mission_level").val(_GET("mission_level")||7),$("#mission").val(n).change()),i&&($("#raid_level").val(_GET("raid_level")||25),$("#raid").val(i).change()),_DEFINED("bges"))for(var o=_GET("bges"),s=0;s<o.length;s+=2){var l=base64_to_decimal(o.substring(s,s+2));$("#battleground_"+l).prop("checked",!0)}else for(document.getElementsByName("battleground"),s=0;s<current_bges.length;s++)$("#battleground_"+current_bges[s]).prop("checked",!0);if(o=_GET("selfbges"))for(s=0;s<o.length;s+=2){l=base64_to_decimal(o.substring(s,s+2))+1e4;$("#self-battleground_"+l).prop("checked",!0)}if(o=_GET("enemybges"))for(s=0;s<o.length;s+=2){l=base64_to_decimal(o.substring(s,s+2))+1e4;$("#enemy-battleground_"+l).prop("checked",!0)}var c=_GET("mapBges");if(c&&setSelectedMapBattlegrounds(c),$("#battleground").change(),$("#sims").val(_GET("sims")||1e4),_DEFINED("debug")&&$("#debug").click(),_DEFINED("mass_debug")&&$("#mass_debug").click(),_DEFINED("loss_debug")&&$("#loss_debug").click(),_DEFINED("win_debug")&&$("#win_debug").click(),_DEFINED("play_debug")&&$("#play_debug").click(),document.title="SimSpellstone "+text_version+" - The Spellstone Simulator that runs from your browser!",_DEFINED("autostart")&&!_DEFINED("latestCards"))SIM_CONTROLLER.startsim(1);else if(_DEFINED("unit_tests")){var d=document.getElementsByTagName("body")[0],u=document.createElement("script");u.src="scripts/unit_tests.js",d.appendChild(u),u.onload=function(){var e=document.createElement("script");e.src="scripts/unit_test_runner.js",d.appendChild(e)}}document.getElementById("missionDeckDialog")&&(deckPopupDialog=$("#missionDeckDialog").dialog({autoOpen:!1,minWidth:500,minHeight:20,modal:!0,resizable:!1,draggable:!1,buttons:{Close:function(){deckPopupDialog.dialog("close")}},open:function(e,t){$(".ui-dialog-titlebar-close",t.dialog|t).hide()}}))}var u_black=!(window.onerror=function(e,t,a){if(0==a){var r="<br><br><i>Error Message:</i><br><br><i>It appears you're having trouble loading SimSpellstone. Thanks.</i><br><br>";return outp?outp(r):document.write(r),1}var n="JavaScript error:\n "+e+"\n on line "+a+"\n for "+t;n+="\n",n+="Browser CodeName: "+navigator.appCodeName+"\n",n+="Browser Name: "+navigator.appName+"\n",n+="Browser Version: "+navigator.appVersion+"\n",n+="Cookies Enabled: "+navigator.cookieEnabled+"\n",n+="Platform: "+navigator.platform+"\n",n+="User-agent header: "+navigator.userAgent+"\n",n+="SimSpellstone version: "+text_version+"\n",getdeck&&(n+="Deck hash: "+getdeck+"\n"),getcardlist&&(n+="Card list: "+getcardlist+"\n"),getordered&&(n+="Ordered: Yes\n"),getexactorder&&(n+="Exact-order: Yes\n"),surge&&(n+="Surge: Yes\n"),getdeck2&&(n+="Enemy deck hash: "+getdeck2+"\n"),getcardlist2&&(n+="Enemy Card list: "+getcardlist2+"\n"),getordered2&&(n+="Enemy Ordered: Yes\n"),getexactorder2&&(n+="Enemy Exact-order: Yes\n"),getmission&&(n+="Mission ID: "+getmission+"\n"),getraid&&(n+="Raid ID: "+getraid+"\n"),getbattleground&&(n+="Battleground ID: "+getbattleground+"\n"),games&&(n+="Sims run so far: "+games+"\n"),outp('<br><br><i>Error Message:</i><br><textarea cols=50 rows=6 onclick="this.select()"><blockquote>'+n+"</blockquote></textarea>"+echo),current_timeout&&clearTimeout(current_timeout)});function toggle_u(){var e=!1;if(void 0===style)e=!0,style=document.createElement("style");else for(;style.hasChildNodes();)style.removeChild(style.firstChild);var t,a=document.getElementsByTagName("head")[0];t=u_black?(u_black=!1,document.createTextNode("u { text-decoration: none; font-style:normal; color: #dddddd; font-weight: normal; }")):(u_black=!0,document.createTextNode("u { text-decoration: none; font-style:normal; color: #000000; font-weight: normal; }")),style.type="text/css",style.styleSheet?style.styleSheet.cssText=t.nodeValue:style.appendChild(t),!0===e&&a.appendChild(style)}function toggleUI(e){e?$("#ui").show():$("#ui").hide()}function showUI(){toggleUI(!0),document.getElementById("stop").style.display="none"}function hideUI(){$(".accordion").accordion("option","active",null),toggleUI(!1),document.getElementById("stop").style.display="block"}function getSelectedBattlegrounds(e){e=e||"";for(var t=[],a=document.getElementsByName(e+"battleground"),r=0;r<a.length;r++){var n=a[r];n&&n.checked&&t.push(n.value)}return t=t.join()}function getSelectedMapBattlegrounds(){for(var e=[],t=$("#location").val(),a=document.getElementsByName("map-battleground"),r=0;r<a.length;r++){var n=a[r];0<n.value&&e.push(t+"-"+r+"-"+n.value)}return e=e.join()}function setSelectedMapBattlegrounds(e){for(var t=document.getElementsByName("map-battleground"),a=0;a<e.length&&a<t.length;a++)t[a].value=e[a]}function outp(e){$("#content").html(e)}function outputTurns(e){closeDiv&&(e+="</div>",closeDiv=!1),outp(e="<input id='show-turns' type='button' value='Show All' /> <div id='turn-container'>Turn: <select id='turn-picker'></select></div> <div>"+e+"</div>");for(var t=$(".turn-info").hide().length,a=[],r=0;r<t;r++){var n=r+1;a.push("<option value='"+r+"'>"+n+"</option>")}var i=r-1;i&&closeDiv&&i--,$("#turn-picker").append(a).change(function(e){var t=e.target.selectedIndex;$(".turn-info").hide().eq(t).show()}).val(i).change();var o=!0;$("#show-turns").click(function(){if(o=!o){var e=$("#turn-picker").val();$(".turn-info").hide().eq(e).show(),$("#turn-container").show(),this.value="Show All"}else $(".turn-info").show(),$("#turn-container").hide(),this.value="Show One"})}function showWinrate(){if(suppressOutput);else if(debug||0==sims_left){var e="";if(e+='<br><br><i>Non-autostart link</i><br><a href="'+generate_link()+'">'+generate_link()+'</a><br><br><i>Autostart link</i><br><a href="'+generate_link(1)+'">'+generate_link(1)+"</a><br><br>",debug)return e}var t=(100*(wins/games)).toFixed(2)+"%";$("#wins").html(wins),$("#winrate").html(t);var a=losses/games*100;a=a.toFixed(2)+"%",$("#losses").html(losses),$("#lossrate").html(a);var r=draws/games*100;r=r.toFixed(2)+"%",$("#draws").html(draws),$("#drawrate").html(r);var n=marginOfError(wins,games);$("#marginGames").html((n*games).toFixed(0)),n=n.toFixed(2)+"%",$("#marginPercent").html(n);var i=(100*games/(games+sims_left)).toFixed("2")+"%";$(".battleCount").html(games),$("#percentComplete").html(i),$("#avgLength").html((total_turns/games).toFixed(1)),$("#avgPoints").html((points/games).toFixed(2)),$("#winrateTable").show();var o="";if(0==sims_left){o+=e;var s="",l=[],c=document.getElementById("deck1").value,d=$("#cardlist").val();d&&(d=d.value),c?l.player=hash_decode(c):d&&(l.player=load_deck_from_cardlist(d)),l.player&&(s=hash_encode(l.player)),battle_history+=t+" (+/- "+n+") &nbsp; &nbsp; "+s+"<br>"}return o}function hideTable(){$("#winrateTable").hide()}function setSimStatus(e,t,a){if($("#simStatusMsg").html(e),t&&a){var r=games+sims_left,n=(100*games/r).toFixed("2")+"%",i="("+games+"/"+r+") "+n;$("#progress").html(i),$("#speed").show(),$("#elapsed").html(t),$("#simsPerSec").html(a)}else $("#progress").html(""),$("#speed").hide();$("#simulationStatus").show()}function winrateDev(e,t){if(t<=1)return 1;var a=e/t,r=t;return Math.sqrt(r*a*(1-a))}function marginOfError(e,t){if(t<=1)return 1;var a=e/t,r=t;return 100*(1.96*Math.sqrt(a*(1-a)/r)+.5/r)}function generate_link(e){var t=0,a=document.URL,r=a.indexOf("?");0<r&&(a=a.substring(0,r));var n=[];addValueParam(n,"deck1"),addValueParam(n,"deck2"),addValueParam(n,"location"),addValueParam(n,"campaign"),addValueParam(n,"mission"),addValueParam(n,"mission_level"),addValueParam(n,"raid"),addValueParam(n,"raid_level");var i=$("select[name=map-battleground]").toArray().reduce(function(e,t){return e+t.value},"");i.length&&n.push("mapBges="+i),addBoolParam(n,"surge"),addBoolParam(n,"siege")&&(addValueParam(n,"tower_level"),addValueParam(n,"tower_type")),addBoolParam(n,"auto_mode"),addBoolParam(n,"tournament"),addBoolParam(n,"ordered"),addBoolParam(n,"exactorder"),addBoolParam(n,"ordered2"),addBoolParam(n,"exactorder2");for(var o="",s=document.getElementsByName("battleground"),l=0;l<s.length;l++)(t=s[l]).checked&&(o+=decimal_to_base64(t.value,2));n.push("bges="+o);for(o="",s=document.getElementsByName("self-battleground"),l=0;l<s.length;l++)(t=s[l]).checked&&(o+=decimal_to_base64(t.value-1e4,2));o&&n.push("selfbges="+o);for(o="",s=document.getElementsByName("enemy-battleground"),l=0;l<s.length;l++)(t=s[l]).checked&&(o+=decimal_to_base64(t.value-1e4,2));return o&&n.push("enemybges="+o),addValueParam(n,"sims"),addBoolParam(n,"debug"),addBoolParam(n,"mass_debug"),addBoolParam(n,"loss_debug"),addBoolParam(n,"win_debug"),addBoolParam(n,"play_debug"),e&&n.push("autostart"),0<n.length?a+"?"+n.join("&"):a}function addValueParam(e,t,a){var r=$("#"+(a||t)).val();return!!r&&(e.push(t+"="+r),!0)}function addBoolParam(e,t){return!!$("#"+t).is(":checked")&&(e.push(t),!0)}function load_deck_builder_for_field(e){var t=$("#"+e),a=t.val();a||(a=hash_encode({commander:elariaCaptain,deck:[]})),open_deck_builder("Card Hash",a,null,t)}var deckBuilders={};function load_deck_builder(e){if("player"==e)var t=$("#deck1").val();else{t=$("#deck2").val();var a=$("#mission").val(),r=$("#mission_level").val(),n=$("#raid").val(),i=$("#raid_level").val()}var o,s={commander:elariaCaptain,deck:[]};t?s=hash_decode(t):a?s=load_deck_mission(a,r):n&&(s=load_deck_raid(n,i)),s&&(o=hash_encode(s));var l="player"==e?"Player Deck":"Enemy Deck",c=e?$("#"+("player"==e?"deck1":"deck2")):null,d=deckBuilders[e];null==d||d.closed?deckBuilders[e]=open_deck_builder(l,o,null,c):d.focus()}function open_deck_builder(e,t,a,r){var n=["nosort"];t&&n.push("hash="+t),a&&n.push("inventory="+a),e&&n.push("name="+e),_DEFINED("ajax")&&n.push("ajax"),n.push("fromSim");var i,o="DeckBuilder.html?"+n.join("&"),s=Math.min(screen.width,1e3),l=Math.min(screen.height,700),c=Number((screen.width-s)/2),d=Number((screen.height-l)/2),u="scrollbars,left="+c+"top="+d+",width="+s+",height="+l+",top="+d+",left="+c,h=window.open(o,"",u);return $(h).load((i=r,function(){i&&(h.updateSimulator=function(e){i.val(e).change()})})),h}function display_generated_link(){outp('<br><i>Non-autostart link</i><br><a href="'+generate_link()+'">'+generate_link()+'</a><br><br><i>Autostart link</i><br><a href="'+generate_link(1)+'">'+generate_link(1)+"</a><br><br>")}function clear_history(){battle_history="",display_history()}function display_history(){outp("<br><hr>"+(battle_history||"No history available.")+'<hr><br><br><input type="button" value="Clear History" onclick="clear_history();" style="text-align: center; font-weight: normal;"><br><br>')}function supports_html5_storage(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}var current_timeout,cache_player_deck,cache_cpu_deck,cache_player_deck_cards,cache_cpu_deck_cards,battle_history="",max_turns=100,debug=!1,mass_debug=!1,loss_debug=!1,win_debug=!1,found_desired=!1,play_debug=!1,showAnimations=!1,getdeck="",getdeck2="",getcardlist="",getcardlist2="",getordered=!1,getordered2=!1,getexactorder=!1,getexactorder2=!1,getcampaign=0,getmission=0,missionlevel=0,getraid=!1,raidlevel=0,getbattleground="",enemybges="",selfbges="",mapbges="",getsiege=0,tower_level=0,tower_type=0,pvpAI=!0,echo="",closeDiv=!1,wins=0,losses=0,draws=0,games=0,points=0,num_sims=0,last_games=[],sims_left=0,time_start=0,time_stop=0,time_start_batch=0,time_end=0,surge=!1,battleground=[],total_turns=0,choice=void 0,auto_mode=!1,tournament=!1,suppressOutput=!1,orders={},cardStats={},CARD_GUI={};function createImg(e,t){return $("<img>").addClass(t).attr("src",e)[0]}function createDiv(e,t){return $("<div>").addClass(e).html(t)[0]}function createSpan(e,t){return $("<span>").addClass(e).html(t)[0]}function getTutorialScript(){for(var e=[{msg:"Welcome to SIM Spellstone!  This is a brief tutorial of how to use the Simulator."},{ui:"#setup-container",msg:"Here is where you set everything up for a simulation.",actions:[i]},{ui:"#setup-container",msg:'When you are done, you can click the "Setup" bar to hide this section.',actions:[n]},{ui:"#setup-container",msg:"Clicking it again will open it back up.",actions:[i]},{ui:"#attacker-container",msg:"Use this section to set up the deck for the attacker."},{ui:"#edit-player",msg:'Click "Edit" to open the DeckBuilder and create a deck.'},{ui:"#load-player",msg:'Click "Load" to choose a deck from the ones you have saved in the DeckBuilder.'},{ui:"#attacker-hash-container",msg:"If you have a deck hash, you can simply paste it here as well."},{ui:"#attacker-advanced",msg:"This section contains some additional settings for the attacker that determine how their deck is played."},{ui:"#auto-container",msg:"Check this to have fights run on auto, rather than playing them yourself.",showFor:"battle"},{ui:"#auto-container",msg:'Setting the attacker to "auto" also enables the "Ordered" and "Do Not Shuffle" options.',showFor:"battle"},{ui:"#ordered-container",msg:"Check this to have the AI attempt to play the attacker's deck as close as possible to the order that the cards are listed."},{ui:"#exactorder-container",msg:"Check this to disable shuffling of the attacker's deck."},{ui:"#defender-container",msg:"Use this section to set up the deck for the defender."},{ui:"#defender-hash-container",msg:"You can manually create a deck for the defender here."},{ui:"#pve-container",msg:"Or you can choose a PvE deck to sim against.",actions:[l]},{ui:"#campaign-container",msg:"To choose a campaign mission, first pick a Campaign from the dropdown...",actions:[s]},{ui:"#mission-container",msg:"... then pick a Mission from the mission dropdown.",actions:[c,s,function(){$("#mission").val(11).change()}]},{ui:"#raid-container",msg:"To fight against a raid boss, pick the desired Raid from the dropdown",actions:[l,function(){$("#raid").val(24005).change()}]},{ui:"#defender-advanced",msg:"This section contains some additional settings for the defender that determine how their deck is played.",actions:[c]},{ui:"#surge-container",msg:"Check this to have the defender go first.",showFor:"battle"},{ui:"#tower-container",msg:"Use these fields to set up a tower for the defender."},{ui:"#siege-container",msg:"Check this field to turn the tower on."},{ui:"#tower_level",msg:"This field determines the BR of the defender.  The tower's level is one less than the defender's BR."},{ui:"#tower_type",msg:"This field determines which type of tower the defender will have."},{ui:"#bge-container",msg:"Check/uncheck boxes here to set active battleground effects.",actions:[o,i]},{ui:"#view-container",msg:'Click "View" to display the currently set decks for the attacker and defender.',actions:[n,function(){$("#view-container").accordion("option","active",0)}]},{ui:"#view-container",msg:"Click it again to hide it.",actions:[o]},{ui:"#sims-container",msg:"This field determines how many fights to run.",showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Simulate" to run a batch of fights.',showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Battle" to start a fight.',showFor:"battle"},{ui:"#generate_link",msg:'Click "Generate Link" to create a link that will open this tool with all of the current settings.'},{msg:'To view this tutorial again at any time, you can click the "Help" button.  (Note: this will reset the Simulator.)'}],t=getCurrentPage(),a=0;a<e.length;a++){var r=e[a];r.showFor&&r.showFor!==t&&e.splice(a--,1)}function n(){$("#setup-container").accordion("option","active",null)}function i(){$("#setup-container").accordion("option","active",0)}function o(){$("#view-container").accordion("option","active",null)}function s(){$("#campaign").val(1).change()}function l(){$("#campaign").val("").change()}function c(){$("#raid").val("").change()}return e}!function(){var t="";function r(e,t,a){var r=[],n=get_card_by_id(e.commander);r.push(v(n,!1,!1));for(var i=0,o=e.deck.length;i<o;i++){var s=e.deck[i];if(a)var l=get_card_apply_battlegrounds(s,a);else l=get_card_by_id(s);r.push(v(l,!1,!1))}if(!t)for(;i<15;i++)r.push(createDiv("card blank"));return r}function l(e,t,a,r,n,i){var o,s,l;n=n||0;for(var c=0,d=[],u=0,h=e.length;u<h&&(!i||c<i);u++){var f=e[u],m=get_card_by_id(f);areEqual(m,s)?l++:(n<=c&&(g(o,l),(o=v(m,t,!(l=1),a,r,null,u)).setAttribute("data-i",u),void 0!==f.index&&o.setAttribute("data-index",f.index),d.push(o)),s=m,c++)}return g(o,l),d}function i(e,t,a,r,n){t||(t=[]);var i=[];if(r){var o=document.createElement("h1");o.innerHTML="Turn: "+r+" (Currently at "+SIMULATOR.calculatePoints(!0)+" points)",i.push(o)}var s=createDiv("field"),l=null;if(n){l=n.owner;n=n.isCommander()?-1:n.key}return"player"===l?(s.appendChild(c(e.cpu)),s.appendChild(c(e.player,n))):(s.appendChild(c(e.cpu,n)),s.appendChild(c(e.player))),i.push(s),i.push(d(t,a,r)),i.push(document.createElement("br")),i.push(document.createElement("br")),i}function c(e,t){var a=createDiv("float-left"),r=v(e.commander,!1,!0);-1===t&&u(r),a.appendChild(r);var n=e.assaults;if(n)for(var i=0,o=n.length;i<o;i++){var s=n[i];r=v(s,!1,!0);s.timer&&r.classList.add("inactive"),t===i&&u(r),a.appendChild(r)}return a}function d(e,t,a){for(var r=createDiv("float-left hand"),n=0,i=e.length;n<i;n++){var o=e[n];if(o){var s=v(o,!1);0===n?s.classList.add("left"):2===n?s.classList.add("right"):2<n&&s.classList.add("inactive");t&&s.addEventListener("click",function(e){return function(){choice=e,t(a)}}(n)),r.appendChild(s)}}return r}function u(e){e.style.outline="5px solid LawnGreen"}function g(e,t){var a=parseInt(t);if(a==t&&(t=1<a?a:null),t){var r=createDiv("multiplier","x"+t);r.setAttribute("data-count",t);var n=createImg(W("cardAssets")+"multiplier.png","multiplier");e.appendChild(n),e.appendChild(r)}}function v(e,t,a,r,n,i,o){var s=createDiv("card");s.setAttribute("data-id",e.id),s.setAttribute("data-level",e.level);for(var l=e.runes,c=[],d={},u=0,h=l.length;u<h;u++){var f=l[u].id;c.push(l[u].id);var m=getRune(f);for(var g in m.stat_boost)"skill"==g&&(g=m.stat_boost.skill.id),d[g]=!0}var v=e.highlighted;if(v)for(u=0;u<v.length;u++){d[g=v[u]]=!0}s.setAttribute("data-runeids",c.join(","));var p=loadCard(e.id).picture;if(p){var _=document.createElement("i");0==p.indexOf("portrait_")?_.className="portrait portrait-"+p:_.className="sprite sprite-"+p,s.appendChild(_)}e.isCommander()&&s.classList.add("commander"),s.classList.add(factions.names[e.type].toLowerCase());var b=createDiv("card-name",(void 0!==e.uid?"("+e.uid+") ":"")+e.name),k=createDiv("card-id","("+e.id+")");if(b.appendChild(k),s.appendChild(b),!e.isCommander()){if(0<=e.attack){if(a){e.isUnjammed()||s.classList.add("frozen");var y=createDiv("card-attack",e.adjustedAttack().toString());e.adjustedAttack()>e.attack?y.classList.add("increased"):e.adjustedAttack()<e.attack?y.classList.add("decreased"):d.attack&&y.classList.add("increased")}else y=createDiv("card-attack",e.attack.toString());s.appendChild(createImg(W("cardAssets")+"Attack.png","attack")),s.appendChild(y)}0<=e.cost&&(a?e.timer&&(s.appendChild(createDiv("delay",e.timer)),s.appendChild(createImg(W("cardAssets")+"Timer.png","timer"))):(s.appendChild(createDiv("delay",e.cost)),s.appendChild(createImg(W("cardAssets")+"Timer.png","timer"))))}if(0<=e.health){if(a){var S=createDiv("card-health",e.health_left.toString());e.health_left<e.health?S.classList.add("decreased"):d.health&&S.classList.add("increased")}else{S=createDiv("card-health",e.health.toString());d.health&&S.classList.add("increased")}s.appendChild(createImg(W("cardAssets")+"Health.png","health")),s.appendChild(S)}var I=createDiv("card-skills"),A=createDiv("card-skills-short");e.earlyActivationSkills&&U(e,I,A,e.earlyActivationSkills,a),U(e,I,A,e.skill,a),e.onDeathSkills&&U(e,I,A,e.onDeathSkills,a),function(t,a,r,n,i){Object.getOwnPropertyNames(SKILL_DATA).filter(function(e){return 0<=["passive","toggle"].indexOf(SKILL_DATA[e].type)}).forEach(function(e){!function(e,t,a,r,n,i){var o=r[n];if(o){var s={id:n,x:o,boosted:i[n]};e.appendChild(P(r,s,a)),e.appendChild(document.createElement("br")),t.appendChild(B(s.id))}}(t,a,n,r,e,i)});var e=r.flurry;e&&(t.appendChild(P(r,e,n)),t.appendChild(document.createElement("br")),a.appendChild(B(e.id)))}(I,A,e,a,d);var w,D,C=I.cloneNode(!0);if(C.className="card-skills-detailed",A.hasChildNodes()&&(t?(s.appendChild(A),s.appendChild(I)):s.appendChild(C)),s.appendChild(createDiv("faction")),a){var T=function(e){var t=[];if(e.enfeebled){var a=G("enfeeble",e.enfeebled);t.push(a)}if(e.marked){var a=G("enfeeble",e.marked);t.push(a)}if(e.nullified){var a=G("nullify",e.nullified);t.push(a)}if(e.poisoned){var a=G("poison",e.poisoned);t.push(a)}if(e.scorched&&e.scorched.amount){var a=G("burn",e.scorched.amount);t.push(a)}var r=[];if(e.enraged){var a=G("enrage",e.enraged);t.push(a)}if(e.protected){var a=G("protect",e.protected);r.push(a)}if(e.invisible){var a=G("evade",e.invisible);r.push(a)}var n=[];if(0<t.length){for(var i=createDiv("card-debuffs"),o=0,s=t.length;o<s;o++)i.appendChild(t[o]);n.push(i)}if(0<r.length){for(var l=createDiv("card-buffs"),o=0,s=r.length;o<s;o++)l.appendChild(r[o]);n.push(l)}return n}(e);if(0<T.length){s.appendChild(createDiv("hidden","..."));var E=createDiv("card-statuses");for(u=0;u<T.length;u++){var x=T[u];E.appendChild(x)}s.appendChild(E)}}if(e.set){var L=(w=e.set,D=V[w],createImg(W("cardAssets")+D+".png"));L.className="set",s.appendChild(L)}var $=e.sub_type;if($.length){var N=createDiv("subfaction");for(u=0;u<$.length;u++){var O=$[u];if(O){var R=j(O);N.appendChild(R)}}s.appendChild(N)}if(0<e.rarity){if(e.maxLevel>Number(e.rarity)+2)var M=createImg(W("cardAssets")+"Level_"+e.rarity+"_"+e.maxLevel+"_"+e.level+".png");else M=createImg(W("cardAssets")+"Level_"+e.rarity+"_"+e.level+".png");if(M.className="level",9999<e.id){var F="1"==e.id.toString()[0]?"Dualfuse":"Quadfuse";(F=createImg(W("cardAssets")+F+".png")).className="fusion",s.appendChild(F)}s.appendChild(M)}else if(1<e.maxLevel){(M=createImg(W("cardAssets")+e.maxLevel+"_"+e.level+".png")).className="level",s.appendChild(M)}return r&&s.addEventListener("click",function(){return r(s,o)}),n&&(s.oncontextmenu=function(){return n(s,o)}),i&&(s.onmouseover=function(){return i(s,o)}),s}function U(e,t,a,r,n){for(var i=0;i<r.length;i++){var o=r[i];t.appendChild(P(e,o,n,i)),t.appendChild(document.createElement("br")),a.appendChild(B(o.id))}}function P(e,t,a,r){var n=document.createElement("span");n.className="skill",n.appendChild(B(t.id));var i=isImbued(e,t.id,r),o=getEnhancement(e,t.id,t.x);i?n.classList.add("imbued"):(t.boosted||o)&&n.classList.add("increased"),t.all&&(n.innerHTML+=" All "),t.y&&n.appendChild(j(t.y)),t.s&&n.appendChild(B(t.s));var s=(0|t.x)+o;return s&&(n.innerHTML+=" "+s+" "),t.c&&(n.innerHTML+=t.c,a&&(n.innerHTML+=" ("+(t.countdown?t.countdown:"0")+")")),n}function B(e){var t=W("skills"),a=SKILL_DATA[e],r=createImg(t+=(a?a.icon:e)+".png");switch(e){case"weakenself":case"enlarge":r.classList.add("affect-self")}return r.title=a?a.name:e,r}function G(e,t){var a=document.createElement("span");return a.appendChild(B(e)),t&&(a.innerHTML+=t),a}function j(e){var t=factions.names[e];return createImg(W("factions")+t+".png")}function W(e){return t+"res/"+e+"/"}var V={1e3:"Basic",1100:"Legacy",7e3:"Basic",2e3:"Reward",2100:"Reward",3e3:"Premium",4e3:"BoxOnly",5e3:"Champion",5100:"Champion",9999:"StoryElements"};CARD_GUI.clearCardSpace=function(){$("#cardSpace").empty()},CARD_GUI.clearDeckSpace=function(){document.getElementById("deck").innerHTML=""},CARD_GUI.draw_deck=function(e,t){var a=$("#deck");return a.children().remove(),a.append(r(e,t)),a},CARD_GUI.create_card_html=v,CARD_GUI.makeDeckHTML=r,CARD_GUI.makeCardListHTML=function(e,t,a){for(var r=createDiv("float-left"),n=0,i=e.deck.length;n<i;n++){var o=e.deck[n],s=v(get_card_by_id(o),!1,!1,t,a,null,n);void 0!==o.index&&s.setAttribute("data-index",o.index),r.appendChild(s)}return r},CARD_GUI.draw_card_list=function(e,t,a,r,n,i){var o=l(e,t,null,null,n,i),s=$("#cardSpace");return s.empty(),s.append(o),s},CARD_GUI.draw_cards=function(e,t,a,r){var n=i(e,t,a,r);$("#cardSpace").children().remove().end().append(n)},CARD_GUI.doDrawField=i,CARD_GUI.draw_inventory=function(e){var t=l(e.deck),a=$("#deck");return a.children().remove(),a.append(l([e.commander])),a.append(t),a},CARD_GUI.draw_hand=d,CARD_GUI.createItemHTML=function(e,t,a){var r=createDiv("card item"),n=document.createElement("i");n.className="sprite sprite-Item",r.appendChild(n),a&&((a=createImg(W("items")+a+".png")).className="item-image",r.appendChild(a));var i=createDiv("card-name",e);return r.appendChild(i),r.classList.add("factionless"),r.appendChild(createDiv("faction")),g(r,t),r},CARD_GUI.addMult=g,CARD_GUI.addWeight=function(e,t){if(0<t){var a=createDiv("weight",(100*t).toFixed(2)+"%");a.setAttribute("data-count",t);var r=createImg(W("cardAssets")+"multiplier.png","weight");e.appendChild(r),e.appendChild(a)}},Object.defineProperties(CARD_GUI,{assetsRoot:{get:function(){return t},set:function(e){t=e}}})}(),$(document).ready(function(){var o=getTutorialScript(),e=$("<div></div>");function t(){storageAPI.shouldShowTutorial?a():i()}function a(){l=0,c();$("#tutorial").show()}$(document.body).append(e),e.load("templates/tutorial-overlay.html",null,function(){e.replaceWith(function(){return $(this).contents()}),$("#tutorial-show").prop("checked",storageAPI.shouldShowTutorial).change(function(e){storageAPI.setShowTutorial(this.checked)}),$("#help").click(a),$("#tutorial-close, #tutorial-skip").click(i),$("#tutorial-next").click(r),$("#tutorial-prev").click(n),"undefined"==typeof delayTutorial&&t()});var s,l=0;function r(){l++,c()}function n(){l--,c()}function i(){$("#tutorial").hide(),$("#tutorial-permahide").is(":checked")&&storageAPI.hideTutorial()}function c(){clearTimeout(s);var e=o[l],t=e.actions;if(t)for(var a=0;a<t.length;a++)t[a]();var r=e.msg,n=e.ui;if(n){var i=$(n);e.dialog&&(i=i.parent()),d(i),t&&(s=setTimeout(d,500,i)),r.indexOf(!1)&&(r=r.replace(/\{0\}/g,i.text()))}else $(".overlay-fog").width(0).height(0);$("#tutorialMessage").text(r),l<o.length-1?($("#tutorial-next").show(),$("#tutorial-close").hide()):($("#tutorial-next").hide(),$("#tutorial-close").show()),0<l?$("#tutorial-prev").removeClass("disabled"):$("#tutorial-prev").addClass("disabled")}function d(e){var t=e.offset();$(".overlay-fog").css({top:t.top-2+"px",left:t.left-2+"px"}).width(e.outerWidth()+4+"px").height(e.outerHeight()+4+"px")}window.showTutorial=a,window.checkTutorial=t});