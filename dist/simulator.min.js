define("config",[],function(){return{pvpAI:!1}}),define("matchStats",[],function(){return{matchesPlayed:0,matchesWon:0,matchesLost:0,matchesDrawn:0,totalTurns:0,totalPoints:0}});var current_timeout,battle_history="",mass_debug=!1,loss_debug=!1,win_debug=!1,play_debug=!1,getdeck="",getdeck2="",getordered=!1,getordered2=!1,getexactorder=!1,getexactorder2=!1,closeDiv=!1,sims_left=0,surge=!1,battleground=[],choice=void 0,tournament=!1;for(var skillID in define("debugLog",[],function(){var e={enabled:!1,getLog:function(){return n},clear:function(){n=""},prepend:a,prependLines:function(){for(var e=0;e<arguments.length;e++)a(arguments[e]+"</br>")},append:t,appendLines:function(){for(var e=0;e<arguments.length;e++)t(arguments[e]+"</br>")}},n="";function a(e){n=e+n}function t(e){n+=e}return e}),define("log",["factions","skillApi"],function(a,t){"use strict";function r(e){return e>Math.floor(e)&&(e=e.toFixed(1)),e}return{skill:function(e){var n=t.nameFromId(e.id);e.all&&(n+=" all");e.y&&(n+=" "+a.names[e.y]);e.s&&(n+=" "+t.nameFromId(e.s));e.c?n+=" every "+e.c+" turns":e.x&&(n+=" "+e.x);return n},name:function(e,n){if("cpu"===e.owner)var a="i";else var a="b";var t="<"+a+">";t+=e.name,e.runes.length&&(t+="*");1<e.maxLevel&&(t+="{"+e.level+"/"+e.maxLevel+"}");void 0!==e.key&&(t+=" ("+e.key+")");if(t+="</"+a+">",!n){if(t+="<u>",e.isCommander())t+=" [",void 0!==e.health_left?t+=r(e.health_left):t+=e.health,t+=" HP]";else if(e.isAssault()){t+=" [";var i=e.adjustedAttack();(isNaN(i)||null==i)&&(i=e.attack),t+=i,t+="/",void 0!==e.health_left?t+=r(e.health_left):t+=e.health,t+="/",void 0!==e.timer?t+=e.timer:t+=e.cost,t+="]"}t+="</u>"}return t}}}),define("bgeApi",["log","cardApi","debugLog"],function(d,u,c){var e={getBattlegrounds:function(e,n,a,t,i,r,s,o){var l={onCreate:[],onTurn:[],onCardPlayed:[]};v(l,e),v(l,n,"player"),v(l,a,"cpu"),function(e,n,a){if(n)for(var t=n.split(","),i=0;i<t.length;i++){var r=t[i].split("-"),s=r[0],o=r[1],l=r[2],d=Object.keys(MAP_BATTLEGROUNDS).filter(function(e){return MAP_BATTLEGROUNDS[e].location_id==s})[0],c=(d=MAP_BATTLEGROUNDS[d]).effects[o].upgrades[l];h(e,c,a)}}(l,t,"player"),i?function(e,n,a){var t=CAMPAIGNS[n];if(t){var i=t.battleground_id;if(i){var r=BATTLEGROUNDS[i];if(a=Number(a)-1,!r.starting_level||Number(r.starting_level)<=a){if(r.scale_with_level){r=JSON.parse(JSON.stringify(r));for(var s=a-Number(r.starting_level),o=0;o<r.effect.length;o++){var l=r.effect[o];l.mult=l.base_mult+l.mult*s}}h(e,r,"cpu")}}}}(l,i,r):s&&function(e,n,a){var t=RAIDS[n].bge;if(t){var i=BATTLEGROUNDS[t];if(i&&Number(a)>=Number(i.starting_level))for(var r=i.enemy_only,s=0;s<i.effect.length;s++){var o=i.effect[s],l=o.effect_type;if("skill"===l){if(i.scale_with_level)var d=i.scale_with_level*(a-i.starting_level+1);else var d=1;var c=u.makeBattleground(i.name,o,d);c.enemy_only=r,e.onTurn.push(c)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(l)){var c=f(i.name,o);c.enemy_only=r,e.onCreate.push(c)}else if(0<=["scale_attack","scale_health"].indexOf(l)){var c=p(i.name,o);c.enemy_only=r,e.onCreate.push(c)}else if("trap_card"===l){var c=m(i.name,o);c.enemy_only=r,e.onCardPlayed.push(c)}}}}(l,s,o);return l}};function f(e,n){return{name:e,modifierType:n.effect_type,effects:[n]}}function p(e,n){return{name:e,modifierType:"scale_stat",scaledStat:n.effect_type.replace("scale_",""),effects:[n]}}var a,t,o=((a=function(e,n){this.p=null,this.name=e,this.effect=n,this.runes=[]}).prototype={onCardPlayed:function(e){SIMULATOR.onPlaySkills[this.effect.id](this,e,this.effect)},isCommander:function(){return!1},isAssault:function(){return!1}},function(e,n){return new a(e,n)}),m=((t=function(e,n){this.name=e,this.id=n.id,this.base=n.base,this.mult=n.mult,this.target_deck=n.target_deck,this.y=n.y}).prototype={onCardPlayed:function(e,n,a){var t="opponent"===this.target_deck?a:n;if(e.isInFaction(this.y)){for(var i=[],r=0;r<t.length;r++)(e=t[r]).trap||i.push(e);if(i.length){var s=Math.ceil(e[this.base]*this.mult),o=unitInfo.create(this.id,s),l=u.byId(o);i[~~(Math.random()*i.length)].trap=l,c.enabled&&c.appendLines(this.name+" inserts "+d.name(l)+" into the opposing deck.")}}}},function(e,n){return new t(e,n)});function h(e,n,a){for(var t=0;t<n.effect.length;t++){var i=n.effect[t],r=i.effect_type;if("skill"===r){var s=u.makeBattleground(n.name,i);"player"===a&&(s.ally_only=!0),"cpu"===a&&(s.enemy_only=!0),e.onTurn.push(s)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(r)){s=f(n.name,i);"player"===a&&(s.ally_only=!0),"cpu"===a&&(s.enemy_only=!0),e.onCreate.push(s)}else if(0<=["scale_attack","scale_health"].indexOf(r)){s=p(n.name,i);"player"===a&&(s.ally_only=!0),"cpu"===a&&(s.enemy_only=!0),e.onCreate.push(s)}else if("trap_card"===r){s=m(n.name,i);"player"===a&&(s.ally_only=!0),"cpu"===a&&(s.enemy_only=!0),e.onCardPlayed.push(s)}else if("on_play"===r){(s=o(n.name,i.effect)).attacker=i.attacker,s.defender=i.defender,s.first_play=i.first_play,"player"===a&&(s.ally_only=!0),"cpu"===a&&(s.enemy_only=!0),e.onCardPlayed.push(s)}}}function v(e,n,a){if(!n)return null;for(var t=n.split(","),i=0;i<t.length;i++){var r=t[i];h(e,BATTLEGROUNDS[r],a)}}return e}),define("loadDeck",["cardInfo","cardApi","unitInfo"],function(d,k,e){"use strict";function y(e){for(var n=function(e){for(var n,a=e.id;void 0!==(a=REVERSE_FUSIONS[n=a]););return n}(e),a=-1;void 0!==n;)a++,n=FUSIONS[n];return a}function _(e,n,a){if(n=parseInt(n),e.mastery_level&&n<parseInt(e.mastery_level))return null;if(e.remove_mastery_level&&n>=parseInt(e.remove_mastery_level))return null;var t=e.id,i=!1;t||(t=function(e){var n=[];for(var a in CARDS)if(!REVERSE_FUSIONS[a]){var t=CARDS[a];if("1"!=t.card_type&&!(e.max_rarity&&Number(e.max_rarity)<Number(t.rarity)||e.min_rarity&&Number(e.min_rarity)>Number(t.rarity))&&(!e.type||e.type==t.type||0<=t.sub_type.indexOf(e.type.toString()))){if(e.set&&e.set.split(",").indexOf(t.set)<0)continue;n.push(a)}}return n[~~(Math.random()*n.length)]}(e),i=!0);var r=e.level||1;if(a<=n)r=7,c(t)&&(t=u(t));else if(1<n&&d.isCommander(t)){var s=(Number(d.loadCard(t).rarity)+1)/(a-1),o=n-1;r=Math.ceil(s*o)}var l=e.create(t,r);return i&&(l.randomInfo={unitInfo:e,level:n,maxedAt:a}),l}function L(e){var n=parseInt(d.loadCard(e.id).rarity)+2;if(e.level==n){if(!c(e.id))return!1;e.id=u(e.id,1),e.level=1}else e.level++;return!0}function c(e){return!(-1<r.indexOf(e))&&(!d.isCommander(e)&&!!FUSIONS[e])}function u(e,n){if(-1==r.indexOf(e))if(n)for(var a=0;a<n;a++)e=i(e);else do{var t=i(e);e=t}while(e!==t);return e}function i(e){var n=FUSIONS[e];return n||e}var r=["8005","8006","8007","8008","8009","8010"];function s(e,n,a){var t=a+1;n||(n=t);var i=[];i.deck=[];var r=function(e,n){n=parseInt(n);var a=e.commander;if(a.card){for(var t=[],i=0;i<a.card.length;i++){var r=a.card[i],s=parseInt(r.min_mastery_level)||0,o=parseInt(r.max_mastery_level)||999;s<=n&&n<=o&&t.push(r)}(a=t[~~(Math.random()*t.length)]).possibilities=t}return a}(e,n),s=_(r,n,t);r.possibilities&&(s.randomInfo={possibilities:r.possibilities,level:n,maxedAt:t}),i.commander=s;var o=e.deck,l=i.deck;for(var d in o){var c=_(o[d],n,t);c&&l.push(c)}var u,f,p,m,h=function(e){for(var n=0,a=0;a<e.length;a++){var t=e[a],i=k.byId(t);n+=(y(i)+1)*i.maxLevel-1}return n}(l),v=(u=n,p=h,m=7==(f=t)?(u-1)/(f-1):u/f,Math.ceil(p*m));if(1<n&&n<t)for(var g=l.slice();0<v&&0<g.length;){var b=Math.floor(Math.random()*g.length);L(g[b])?v--:g.splice(b,1)}return i}function a(e){for(var n=[],a=0,t=e.length;a<t;a++)n[a]=e[a];return n}return{mission:function(e,n){var a=MISSIONS[e];return a?s(a,n,6):0},raid:function(e,n,a){a||(a=25);var t=RAIDS[e];{if(t){var i={commander:t.commander,deck:t.deck.card};return s(i,n,Number(t.upgradeLevels))}return 0}},defaultDeck:function(){return{commander:e.defaultCommander,deck:[]}},copyCardList:a,copyDeck:function(e){var n={};return n.commander=e.commander,n.deck=a(e.deck),n},getDeckCards:function(e,n){var a={};a.commander=k.byId(e.commander),a.deck=[];for(var t=e.deck,i=SIMULATOR.battlegrounds.onCreate.filter(function(e){return!("player"===n&&e.enemy_only||"cpu"===n&&e.ally_only)}),r=0,s=t.length;r<s;r++)a.deck.push(k.byIdWithBgeApplied(t[r],i));return a}}}),define("animations",["cardUI"],function(s){"use strict";var e={areShown:!1,drawField:function(e,n,a,t,i){var r=s.doDisplayField(e,n,a,t,i);o.push(r),l||(d(),l=setInterval(d,500))},clearFrames:function(){o=[],clearInterval(l),l=null}},o=[],l=null,n=!1;function d(){if(0===o.length)n?(clearInterval(l),l=null):n=!0;else{var e=o.splice(0,1)[0];$("#cardSpace").children().remove().end().append(e),n=!1}}return e}),define("ui",["base64","urlHelpers","loadDeck","debugLog","storageAPI","dataUpdater","matchStats"],function(u,p,c,f,i,a,m){var r,e={show:function(){n(!0),document.getElementById("stop").style.display="none"},hide:function(){$(".accordion").accordion("option","active",null),n(!1),document.getElementById("stop").style.display="block"},getSelectedBattlegrounds:function(e){e=e||"";for(var n=[],a=document.getElementsByName(e+"battleground"),t=0;t<a.length;t++){var i=a[t];i&&i.checked&&n.push(i.value)}return n=n.join()},getSelectedMapBattlegrounds:function(){for(var e=[],n=$("#location").val(),a=document.getElementsByName("map-battleground"),t=0;t<a.length;t++){var i=a[t];0<i.value&&e.push(n+"-"+t+"-"+i.value)}return e=e.join()},generateLink:h,displayText:o,displayTurns:function(){var e=f.getLog();if(!e)return;closeDiv&&(e+="</div>",closeDiv=!1);o(e="<input id='show-turns' type='button' value='Show All' /> <div id='turn-container'>Turn: <select id='turn-picker'></select></div> <div>"+e+"</div>");for(var n=$(".turn-info").hide().length,a=[],t=0;t<n;t++){var i=t+1;a.push("<option value='"+t+"'>"+i+"</option>")}var r=t-1;r&&closeDiv&&r--;$("#turn-picker").append(a).change(function(e){var n=e.target.selectedIndex;$(".turn-info").hide().eq(n).show()}).val(r).change();var s=!0;$("#show-turns").click(function(){if(s=!s){var e=$("#turn-picker").val();$(".turn-info").hide().eq(e).show(),$("#turn-container").show(),this.value="Show All"}else $(".turn-info").show(),$("#turn-container").hide(),this.value="Show One"})},showWinrate:function(){if(f.enabled||0==sims_left){var e="";if(e+='<br><br><i>Non-autostart link</i><br><a href="'+h()+'">'+h()+'</a><br><br><i>Autostart link</i><br><a href="'+h(1)+'">'+h(1)+"</a><br><br>",f.enabled)return e}var n=(m.matchesWon/m.matchesPlayed*100).toFixed(2)+"%";$("#wins").html(m.matchesWon),$("#winrate").html(n);var a=m.matchesLost/m.matchesPlayed*100;a=a.toFixed(2)+"%",$("#losses").html(m.matchesLost),$("#lossrate").html(a);var t=m.matchesDrawn/m.matchesPlayed*100;t=t.toFixed(2)+"%",$("#draws").html(m.matchesDrawn),$("#drawrate").html(t);var i=function(e,n){if(n<=1)return 1;var a=e/n,t=n;return 100*(1.96*Math.sqrt(a*(1-a)/t)+.5/t)}(m.matchesWon,m.matchesPlayed);$("#marginGames").html((i*m.matchesPlayed).toFixed(0)),i=i.toFixed(2)+"%",$("#marginPercent").html(i);var r=m.matchesPlayed+sims_left,s=(100*m.matchesPlayed/r).toFixed("2")+"%";$(".battleCount").html(m.matchesPlayed),$("#percentComplete").html(s),$("#avgLength").html((m.totalTurns/m.matchesPlayed).toFixed(1)),$("#avgPoints").html((m.totalPoints/m.matchesPlayed).toFixed(2)),$("#winrateTable").show();var o="";if(0==sims_left){o+=e;var l="",d=[],c=document.getElementById("deck1").value;c&&(d.player=u.decodeHash(c)),d.player&&(l=u.encodeHash(d.player)),battle_history+=n+" (+/- "+i+") &nbsp; &nbsp; "+l+"<br>"}return o},hideTable:function(){$("#winrateTable").hide()},setSimStatus:function(e,n,a){if($("#simStatusMsg").html(e),n&&a){var t=m.matchesPlayed+sims_left,i=(100*m.matchesPlayed/t).toFixed("2")+"%",r="("+m.matchesPlayed+"/"+t+") "+i;$("#progress").html(r),$("#speed").show(),$("#elapsed").html(n),$("#simsPerSec").html(a)}else $("#progress").html(""),$("#speed").hide();$("#simulationStatus").show()},loadDeckBuilder:function(e){var n,a,t,i,r;"player"===e?n=$("#deck1").val():(n=$("#deck2").val(),a=$("#mission").val(),t=$("#mission_level").val(),i=$("#raid").val(),r=$("#raid_level").val());deck=n?u.decodeHash(n):a?c.mission(a,t):i?c.raid(i,r):c.defaultDeck();var s=u.encodeHash(deck),o="player"===e?"Player Deck":"Enemy Deck",l=e?$("#"+("player"===e?"deck1":"deck2")):null,d=g[e];null==d||d.closed?g[e]=function(e,n,a,t){var i=["nosort"];n&&i.push("hash="+n);a&&i.push("inventory="+a);e&&i.push("name="+e);p.paramDefined("ajax")&&i.push("ajax");i.push("fromSim");var r="DeckBuilder.html?"+i.join("&"),s=Math.min(screen.width,1e3),o=Math.min(screen.height,700),l=Number((screen.width-s)/2),d=Number((screen.height-o)/2),c="scrollbars,left="+l+"top="+d+",width="+s+",height="+o+",top="+d+",left="+l,u=window.open(r,"",c);return $(u).load((f=t,function(){f&&(u.updateSimulator=function(e){f.val(e).change()})})),u;var f}(o,s,null,l):d.focus()},updateGameData:function(e){var n=t;e&&(n=function(){t(),e()});a.updateData(n,!0)},loadSavedDeck:function(e){$('label[for="loadDeckName"]').html("<strong>Deck:</strong>"),r.dialog("open"),r.dialog("option","position",{my:"center",at:"center",of:window}),r.hashField=e},toggleTheme:function(){s?($("#theme").attr("href","dist/light.min.css"),$("#toggleTheme").val("Dark Theme")):($("#theme").attr("href","dist/dark.min.css"),$("#toggleTheme").val("Light Theme"));s=!s}};function n(e){e?$("#ui").show():$("#ui").hide()}function o(e){$("#content").html(e)}function h(e){var n=0,a=document.URL,t=a.indexOf("?");0<t&&(a=a.substring(0,t));var i=[];d(i,"deck1"),d(i,"deck2"),d(i,"location"),d(i,"campaign"),d(i,"mission"),d(i,"mission_level"),d(i,"raid"),d(i,"raid_level");var r=$("select[name=map-battleground]").toArray().reduce(function(e,n){return e+n.value},"");r.length&&i.push("mapBges="+r),v(i,"surge"),v(i,"siege")&&(d(i,"tower_level"),d(i,"tower_type")),v(i,"auto_mode"),v(i,"tournament"),v(i,"ordered"),v(i,"exactorder"),v(i,"ordered2"),v(i,"exactorder2");for(var s="",o=document.getElementsByName("battleground"),l=0;l<o.length;l++)(n=o[l]).checked&&(s+=u.fromDecimal(n.value,2));i.push("bges="+s);for(s="",o=document.getElementsByName("self-battleground"),l=0;l<o.length;l++)(n=o[l]).checked&&(s+=u.fromDecimal(n.value-1e4,2));s&&i.push("selfbges="+s);for(s="",o=document.getElementsByName("enemy-battleground"),l=0;l<o.length;l++)(n=o[l]).checked&&(s+=u.fromDecimal(n.value-1e4,2));return s&&i.push("enemybges="+s),d(i,"sims"),v(i,"debug"),v(i,"mass_debug"),v(i,"loss_debug"),v(i,"win_debug"),v(i,"play_debug"),e&&i.push("autostart"),0<i.length?a+"?"+i.join("&"):a}function d(e,n,a){var t=$("#"+(a||n)).val();return!!t&&(e.push(n+"="+t),!0)}function v(e,n){return!!$("#"+n).is(":checked")&&(e.push(n),!0)}window.addEventListener("error",function(e,n,a){var t="JavaScript error:\n "+e+"\n on line "+a+"\n for "+n;if(window.sa("send","exception",{exDescription:t,exFatal:!1}),0===a){var i="<br><br><i>Error Message:</i><br><br><i>It appears you're having trouble loading SimSpellstone. Thanks.</i><br><br>";return o(i),1}t+="\n",t+="Browser CodeName: "+navigator.appCodeName+"\n",t+="Browser Name: "+navigator.appName+"\n",t+="Browser Version: "+navigator.appVersion+"\n",t+="Cookies Enabled: "+navigator.cookieEnabled+"\n",t+="Platform: "+navigator.platform+"\n",t+="User-agent header: "+navigator.userAgent+"\n";try{t+="URL: "+h()+"\n"}catch(e){}o('<br><br><i>Error Message:</i><br><textarea cols=50 rows=6 onclick="this.select()"><blockquote>'+t+"</blockquote></textarea>"),current_timeout&&clearTimeout(current_timeout)});var g={};function t(){$("body").removeClass("loading"),checkTutorial()}var s=!1;return $(function(){r=$("#loadDeckDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{Delete:function(){var e=$("#loadDeckName").val();i.deleteDeck(e)},Load:function(){var e,n,a=$("#loadDeckName").val(),t=i.loadDeck(a);e=t,n=r.hashField,$(n).val(e).change(),r.dialog("close")},Cancel:function(){r.dialog("close")}}})}),window.ui=e}),define("simController",["matchTimer","debugLog","animations","ui"],function(t,p,m,h){"use strict";var i={getConfiguration:function(){getdeck=$("#deck1").val(),getordered=$("#ordered").is(":checked"),getexactorder=$("#exactorder").is(":checked"),getdeck2=$("#deck2").val();var e=$("#campaign").val(),n=$("#mission").val(),a=$("#mission_level").val(),t=$("#raid").val(),i=$("#raid_level").val();getordered2=$("#ordered2").is(":checked"),getexactorder2=$("#exactorder2").is(":checked"),surge=$("#surge").is(":checked");var r=$("#siege").is(":checked"),s=$("#tower_level").val(),o=$("#tower_type").val(),l="",d="",c="",u="";BATTLEGROUNDS&&(l=h.getSelectedBattlegrounds(),d=h.getSelectedBattlegrounds("self-"),c=h.getSelectedBattlegrounds("enemy-"),u=n?h.getSelectedMapBattlegrounds():"");sims_left=$("#sims").val()||1,p.enabled=$("#debug").is(":checked"),(play_debug=p.enabled&&$("#play_debug").is(":checked"))&&(p.enabled=!1);if(mass_debug=$("#mass_debug").is(":checked"),win_debug=$("#win_debug").is(":checked"),loss_debug=$("#loss_debug").is(":checked"),m.areShown=$("#animations").is(":checked"),$("#auto_mode").length){var f=$("#auto_mode").is(":checked");SIMULATOR.user_controlled=!f}return tournament=$("#tournament").is(":checked"),{getdeck:getdeck,getordered:getordered,getexactorder:getexactorder,getdeck2:getdeck2,selectedCampaign:e,selectedMission:n,missionLevel:a,selectedRaid:t,raidLevel:i,getordered2:getordered2,getexactorder2:getexactorder2,surge:surge,siegeMode:r,towerLevel:s,towerType:o,selectedBges:l,selfbges:d,enemybges:c,mapbges:u,sims_left:sims_left,play_debug:play_debug,mass_debug:mass_debug,win_debug:win_debug,loss_debug:loss_debug,auto_mode:f,tournament:tournament}},debug_end:function(e){var n,e=i.processSimResult();sims_left=0,t.stop();var a="";getdeck2&&(a=" ("+SIMULATOR.calculatePoints()+" points)");n="draw"==e?"<br><h1>DRAW"+a+"</h1><br>":e?"<br><h1>WIN"+a+"</h1><br>":"<br><h1>LOSS"+a+"</h1><br>";h.displayTurns(),h.setSimStatus(n),h.show(),SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(SIMULATOR.simulation_turns);i.endSimsCallback&&i.endSimsCallback()},endSimsCallback:null,stop_sims_callback:null};return window.SIM_CONTROLLER=i}),define("startup",["base64","urlHelpers","simController","bgeApi","cardUI","loadDeck","loadCardCache","ui","config"],function(f,p,m,s,o,t,i,e,h){"use strict";var r,v;function l(e,l){$(e).sortable({items:".card:not(.commander):not(.blank)",tolerance:"intersect",helper:function(e,n){return n.clone()},start:function(e,n){var a=n.placeholder.index()-1;n.item.data("origPos",a),$(n.item).hide()},stop:function(e,n){var a=n.item.data("origPos")-1,t=n.item.index()-1,i=$(l),r=f.decodeHash(i.val()),s=r.deck;s.splice(t,0,s.splice(a,1)[0]);var o=f.encodeHash(r);i.val(o)}})}function d(e){var n=$("#tooltip"),a=$("#tooltip-text");a.html($(e.target).attr("bge-desc")),a.width(200),n.show(),$("#tooltip .arrow").css("borderTopWidth",0).css("borderBottomWidth",0);var t=$(e.target).offset();t.left-=230,t.top-=n.outerHeight()/2-10,n.offset(t);var i=a.innerHeight()/2-4;$("#tooltip .arrow").css("borderTopWidth",i).css("borderBottomWidth",i)}function c(){$("#tooltip").hide()}function u(e,n,a){var t=$("#"+e);if(t.children().remove(),!p.paramDefined("seedtest")){var i=m.getConfiguration(),r=s.getBattlegrounds(i.getbattleground,i.selfbges,i.enemybges,i.mapbges,i.selectedCampaign,i.missionLevel,i.selectedRaid,i.raidLevel);r=r.onCreate.filter(function(e){return!("player"===a&&e.enemy_only||"cpu"===a&&e.ally_only)}),t.append(o.deckToHtml(n,!1,r))}}function g(){r.dialog("open"),r.dialog("option","position",{my:"center",at:"center",of:window})}function b(){e.displayText('<br><i>Non-autostart link</i><br><a href="'+e.generateLink()+'">'+e.generateLink()+'</a><br><br><i>Autostart link</i><br><a href="'+e.generateLink(1)+'">'+e.generateLink(1)+"</a><br><br>")}function n(){battle_history="",k()}function k(){e.displayText("<br><hr>"+(battle_history||"No history available.")+'<hr><br><br><input id="clear-history" type="button" value="Clear History" style="text-align: center; font-weight: normal;"><br><br>'),$("#clear-history").click(n)}function y(){if($("#header").load("templates/header.html",function(){"undefined"!=typeof showTutorial&&$("#help").click(showTutorial)}),$.holdReady(!0),$("#footer").load("templates/footer.html",function(){$.holdReady(!1)}),!document.getElementById("ui"))return 0;$("#generate_link").on("click",b),$("#btn_simulate").on("click",m.startsim),$("#btnStop").on("click",m.stopsim),$("#display_history").on("click",k),$("#deck1").val(p.paramValue("deck1")).change(),$("#deck2").val(p.paramValue("deck2")).change(),$("#surge").prop("checked",p.paramDefined("surge")),$("#siege").prop("checked",p.paramDefined("siege"));var e=Math.min(Math.max(p.paramValue("tower_level")||18,0),18);$("#tower_level").val(e);var n=p.paramValue("tower_type")||501;$("#tower_type").val(n),$("#auto_mode").prop("checked",p.paramDefined("auto_mode")),$("#tournament").prop("checked",p.paramDefined("tournament")),$("#ordered").prop("checked",p.paramDefined("ordered")),$("#exactorder").prop("checked",p.paramDefined("exactorder")),$("#ordered2").prop("checked",p.paramDefined("ordered2")),$("#exactorder2").prop("checked",p.paramDefined("exactorder2")),p.paramDefined("randomAI")&&(h.pvpAI=!1);var a=p.paramValue("location"),t=p.paramValue("campaign"),i=p.paramValue("mission"),r=p.paramValue("raid");if(a&&$("#location").val(a).change(),t&&(a||(a=CAMPAIGNS[t].location_id,$("#location").val(a).change()),$("#campaign").val(t).change()),i&&($("#mission_level").val(p.paramValue("mission_level")||7),$("#mission").val(i).change()),r&&($("#raid_level").val(p.paramValue("raid_level")||25),$("#raid").val(r).change()),p.paramDefined("bges"))for(var s=p.paramValue("bges"),o=0;o<s.length;o+=2){var l=f.toDecimal(s.substring(o,o+2));$("#battleground_"+l).prop("checked",!0)}else for(o=0;o<current_bges.length;o++)$("#battleground_"+current_bges[o]).prop("checked",!0);if(s=p.paramValue("selfbges"))for(o=0;o<s.length;o+=2){l=f.toDecimal(s.substring(o,o+2))+1e4;$("#self-battleground_"+l).prop("checked",!0)}if(s=p.paramValue("enemybges"))for(o=0;o<s.length;o+=2){l=f.toDecimal(s.substring(o,o+2))+1e4;$("#enemy-battleground_"+l).prop("checked",!0)}var d=p.paramValue("mapBges");if(d&&function(e){for(var n=document.getElementsByName("map-battleground"),a=0;a<e.length&&a<n.length;a++)n[a].value=e[a]}(d),$("#battleground").change(),$("#sims").val(p.paramValue("sims")||1e4),p.paramDefined("debug")&&$("#debug").click(),p.paramDefined("mass_debug")&&$("#mass_debug").click(),p.paramDefined("loss_debug")&&$("#loss_debug").click(),p.paramDefined("win_debug")&&$("#win_debug").click(),p.paramDefined("play_debug")&&$("#play_debug").click(),document.title="SimSpellstone "+text_version+" - The Spellstone Simulator that runs from your browser!",p.paramDefined("autostart")&&!p.paramDefined("latestCards"))m.startsim(1);else if(p.paramDefined("unit_tests")){var c=document.getElementsByTagName("body")[0],u=document.createElement("script");u.src="scripts/unit_tests.js",c.appendChild(u),u.onload=function(){var e=document.createElement("script");e.src="scripts/unit_test_runner.js",c.appendChild(e)}}document.getElementById("missionDeckDialog")&&(v=$("#missionDeckDialog").dialog({autoOpen:!1,minWidth:500,minHeight:20,modal:!0,resizable:!1,draggable:!1,buttons:{Close:function(){v.dialog("close")}},open:function(e,n){$(".ui-dialog-titlebar-close",n.dialog|n).hide()}}))}$(function(){$("#deck1").change(function(){this.value=this.value.trim(),u("attack_deck",f.decodeHash(this.value),"player")}),$("#deck2").change(function(){this.value=this.value.trim(),u("defend_deck",f.decodeHash(this.value),"cpu")}),$("#battleground").change(function(){$("#deck1").change(),$("#deck2").val()?$("#deck2").change():$("#mission").val()?$("#mission").change():$("#raid").val()&&$("#raid").change()});for(var e=$("label[bge-desc]"),n=0;n<e.length;n++){$(e[n]).hover(d,c)}if($(".accordion").accordion({collapsible:!0,active:!1,heightStyle:"content"}).filter(".start-open").accordion("option","active",0),$("#raid, #raid_level").change(function(){var e,n=$("#raid").val(),a=$("#raid_level");n?(e=t.raid(n,a.val()),"Dungeon"===RAIDS[n].type?a.attr("max",150):a.attr("max",40)):(e=f.decodeHash(""),a.attr("max",40)),u("defend_deck",e,"cpu")}),$("#location, #campaign").change(function(){$("#mission").change()}),$("#mission, #mission_level").change(function(){var e,n=$("#mission").val();if(n){var a=$("#mission_level").val();e=t.mission(n,a)}else e=f.decodeHash("");u("defend_deck",e,"cpu")}),$("#config-map-bge").click(g),r=$("#bgeDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{OK:function(){r.dialog("close")},Cancel:function(){r.dialog("close")}}}),u("attack_deck",f.decodeHash("")),u("defend_deck",f.decodeHash("")),l("#attack_deck","#deck1"),l("#defend_deck","#deck2"),p.paramDefined("latestCards")){var a=null;p.paramDefined("autostart")&&(a=function(){m.startsim(1)}),updateGameData(a)}else i();y()})}),SKILL_DATA){var skillInfo=SKILL_DATA[skillID];"flurry"===skillID?skillInfo.type="flurry":0<=["turnStart","onAttack","onDamaged","turnEnd"].indexOf(skillInfo.type)&&(skillInfo.type="passive")}var REVERSE_FUSIONS={};for(var id in FUSIONS){var fusion=FUSIONS[id];REVERSE_FUSIONS[fusion]=id}!function(){var n=require("bgeApi"),s=require("matchTimer"),e=require("urlHelpers"),o=require("debugLog"),l=require("simController"),d=require("ui"),c=require("matchStats");function u(e){if(SIMULATOR.user_controlled)f(e,!0)&&l.debug_end();else if(!o.enabled&&!play_debug||mass_debug||loss_debug||win_debug)if(0<sims_left){if(m<=p){var n=0;if(0<m){p=0;var a=s.elapsed(),t=s.batchElapsed();n=0===t?0:m/t,d.setSimStatus("Running simulations...",a,n.toFixed(1)),d.showWinrate()}(m=1)<n&&(m=Math.ceil(n/8)),sims_left<m&&(m=sims_left),(o.enabled||play_debug)&&(mass_debug||loss_debug||win_debug)&&(m=1),s.startBatch(),current_timeout=setTimeout(u,1,e);for(var i=0;i<m;i++)f(e)}}else{m=p=0,s.stop();a=s.elapsed();var r=c.matchesPlayed/a;r=r.toFixed(2),d.displayText(o.getLog()),d.setSimStatus("Simulations complete.",a,r),d.showWinrate(),d.show(),l.endSimsCallback&&l.endSimsCallback()}else f(e,!0),l.debug_end()}l.startsim=function(){c.totalTurns=0,s.reset(),o.clear(),c.matchesPlayed=0,m=0;var e=l.getConfiguration();return SIMULATOR.battlegrounds=n.getBattlegrounds(e.getbattleground,e.selfbges,e.enemybges,e.mapbges,e.selectedCampaign,e.missionLevel,e.selectedRaid,e.raidLevel),d.hide(),SIMULATOR.setupDecks(e),c.matchesWon=0,c.matchesLost=0,c.matchesDrawn=0,c.totalPoints=0,d.displayText(""),SIMULATOR.user_controlled?d.setSimStatus(""):(d.hideTable(),d.setSimStatus("Initializing simulations...")),window.ga("send","event","simulation","start","single-threaded",sims_left),current_timeout=setTimeout(u,0,e),!1},l.stopsim=function(){s.stop();var e=s.elapsed(),n=c.matchesPlayed/e;n=n.toFixed(2),SIMULATOR.simulating=!1,current_timeout&&clearTimeout(current_timeout),SIMULATOR.user_controlled||(d.setSimStatus("Simulations interrupted.",e,n),d.showWinrate()),d.show(),l.stop_sims_callback&&l.stop_sims_callback()};var a=e.paramValue("seedtest")||0;function f(e,n){if(a&&Math.seedrandom(a++),!SIMULATOR.simulate(e))return!1;n||l.processSimResult()}l.processSimResult=function(){var e;return e=!!SIMULATOR.field.player.commander.isAlive()&&(!SIMULATOR.field.cpu.commander.isAlive()||"draw"),0<m&&(0<sims_left&&sims_left--,p++),"draw"==e?c.matchesDrawn++:e?c.matchesWon++:c.matchesLost++,c.totalPoints+=SIMULATOR.calculatePoints(),c.matchesPlayed++,c.totalTurns+=SIMULATOR.simulation_turns,(o.enabled||play_debug)&&(loss_debug?"draw"===e?(o.prependLines("Draw found after "+c.matchesPlayed+" games. Displaying debug output...",""),o.appendLines("","<h1>DRAW</h1>"),sims_left=0):e?(o.clear(),sims_left||o.appendLines("No losses found after "+c.matchesPlayed+" games. No debug output to display.")):(o.prependLines("Loss found after "+c.matchesPlayed+" games. Displaying debug output...",""),o.appendLines("","<h1>LOSS</h1>"),sims_left=0):win_debug?e&&"draw"!==e?(o.prependLines("Win found after "+c.matchesPlayed+" games. Displaying debug output...",""),o.appendLines("","<h1>WIN</h1>"),sims_left=0):(o.clear(),sims_left||o.appendLines("No wins found after "+c.matchesPlayed+" games. No debug output to display.")):mass_debug&&(o.appendLines(""),"draw"===e?o.appendLines("<h1>DRAW</h1>"):e?o.appendLines("<h1>WIN</h1>"):o.appendLines("<h1>LOSS</h1>")),mass_debug&&sims_left&&o.appendLines("","<hr>NEW BATTLE BEGINS<hr>")),e};var p=0,m=0}();var SIMULATOR={};!function(){var n,t,i,r,I=require("log"),s=require("cardApi"),o=require("skillApi"),a=require("base64"),D=require("unitInfo"),l=require("loadDeck"),x=require("debugLog"),C=require("animations"),d=require("simController"),p=require("ui"),c=(require("config"),100);function u(e,n,a,t){var i=se[n].assaults;if(!e.id)return 0;var r=i.length;if(D.initializeUnit(e,n,r),e.played=!0,e.isAssault()&&(i[r]=e),!x.enabled&&!play_debug||t||x.appendLines(I.name(se[n].commander)+" plays "+I.name(e)),e.isTrap())g(e),U(e);else for(var s=0;s<ie.onCardPlayed.length;s++){var o=ie.onCardPlayed[s],l="player"===n?"cpu":"player";if(o.defender){if(!surge&&"cpu"!==n)continue;if(surge&&"player"!==n)continue;o.owner=l}else if(o.attacker){if(!surge&&"player"!==n)continue;if(surge&&"cpu"!==n)continue;o.owner=n}else{if(o.enemy_only&&"cpu"!==n)continue;if(o.ally_only&&"player"!==n)continue;o.owner=n}1<a&&o.first_play||o.onCardPlayed(e,re[n].deck,re[l].deck)}C.areShown&&C.drawField(se,null,null,a)}function v(e){for(var n=se[e].assaults,a=0,t=n.length;a<t;a++){var i=n[a];if(!i.isAlive()){x.enabled&&x.appendLines(I.name(i)+" <strong>is removed from field</strong>");var r=a;for(a++;a<t;a++)(i=n[a]).isAlive()?(n[i.key=r]=i,r++):x.enabled&&x.appendLines(I.name(i)+" <strong>is removed from field</strong>");n.length=r;break}}}function k(e){return[e[~~(Math.random()*e.length)]]}function y(e){return e.owner}function b(e){return"cpu"==e.owner?"player":"player"==e.owner?"cpu":void 0}function M(e,n,a,t,i){a>=n.health_left?n.health_left=0:n.health_left-=a,x.enabled&&i(e,n,a),t&&E(n),!n.isAlive()&&e&&O(n,e)}function E(e){var n=e.barrier_ice,a=se[b(e)],t=a.assaults[e.key];t&&t.isAlive()||(t=a.commander),M(e,t,n,null,function(e,n,a){x.append(I.name(e)+"'s barrier shatters and hits "+I.name(n)+" for "+a+" damage"),x.appendLines(n.isAlive()?"":" and it dies")})}function f(e,n){return e[n]||m}function m(e,n){if(x.enabled){var a=SKILL_DATA[n.id]?SKILL_DATA[n.id].name:n.id;x.appendLines(I.name(e)+" attempts to use "+a+", but it is not implemented.")}return 0}function g(e){var n=e.earlyActivationSkills,a=n.length;if(a)if(e.silenced)x.enabled&&x.appendLines(I.name(e)+" is silenced and cannot use skills");else{var t=e.dualstrike_triggered;x.enabled&&t&&x.appendLines(I.name(e)+" activates dualstrike");for(var i=t?2:1,r=_(e),s=0;s<i;s++)for(var o=0;o<a&&r();o++){var l=n[o];if(!l.countdown){var d=f(T,l.id)(e,l);l.c&&0<d&&(l.countdown=l.c),C.areShown&&C.drawField(se,null,null,ue,e)}}}}function h(){return!0}function _(e){return e.isAlive?e.isAlive.bind(e):h}function O(e,n){if(!e.ondeath_triggered){var a=e.onDeathSkills,t=a.length;if(0!=t){for(var i=0;i<t;i++){var r=a[i];R[r.id](e,n,r),C.areShown&&C.drawField(se,null,null,ue,e)}e.ondeath_triggered=!0}}}var L=["backlash","counter","counterburn","counterpoison","armored","evade","stasis"];function w(e){return-1===L.indexOf(e)}function A(e,n){if(e.isAssault()&&n.isAlive()){var a=n.backlash;te(e,n,"Backlash",a,D.getEnhancement(n,"backlash",a))}}function N(e){return e.isActive()&&e.isUnjammed()?0:e.stasis||0}var S={burnself:function(e,n){var a=n.x;return e.scorched?(e.scorched.amount+=a,e.scorched.timer=2):e.scorched={amount:a,timer:2},x.enabled&&x.appendLines(I.name(e)+" inflicts scorch("+a+") on itself"),1},scorchbreath:function(e,n){return S.burn(e,n)},burn:function(e,n){var a,t=b(e),i=se[t].assaults;switch(n.id){case"scorchbreath":var r=Math.max(0,e.key-1),s=Math.min(i.length,e.key+2);a=i.slice(r,s);break;case"burnself":a=[e];break;default:a=i.slice(e.key,e.key+1)}if(!a.length)return 0;var o=n.x;o+=D.getEnhancement(e,"burn",o);for(var l=0,d=0;d<a.length;d++){var c=a[d];c.scorched?(c.scorched.amount+=o,c.scorched.timer=2):c.scorched={amount:o,timer:2},x.enabled&&x.appendLines(I.name(e)+" inflicts scorch("+o+") on "+I.name(c)),l++}return l},protect_ice:function(e,n){return S.protect(e,n,"barrier_ice")},protect_seafolk:function(e,n){return S.protect(e,n,null,null,!0)},evadebarrier:function(e,n){return S.protect(e,n,"invisible",function(e,n){return" and imbues it with invisible "+n})},protect:function(e,n,a,t,i){for(var r=n.y,s=y(e),o=n.x,l=n.all,d=se[s].assaults,c=[],u=0,f=d.length;u<f;u++){!(h=d[u]).isAlive()||!h.isInFaction(r)||i&&h.isActive()||c.push(u)}if(!c.length)return 0;l||(c=k(c));var p=D.getEnhancement(e,n.id,o);o+=p;var m=0;for(u=0,f=c.length;u<f;u++){var h;if((h=d[c[u]]).nullified)h.nullified--,x.enabled&&x.appendLines(I.name(e)+" protects "+I.name(h)+" but it is nullified!");else{m++;var v=o;if(!v){var g=n.mult;h.isActive()||(g+=n.on_delay_mult||0),v=Math.ceil(h.health*g)}if(h.protected+=v,a&&(h[a]=(h[a]||0)+v),x.enabled){p&&x.appendLines("<u>(Enhance: +"+p+")</u>");var b=I.name(e)+" barriers "+I.name(h)+" by "+v;"function"==typeof t&&(b+=t(h,v)),x.appendLines(b)}}}return m},heal:function(e,n){for(var a=y(e),t=n.y,i=n.x,r=n.all,s=se[a].assaults,o=[],l=0,d=s.length;l<d;l++){(f=s[l]).isAlive()&&f.isInFaction(t)&&(r||f.isDamaged())&&o.push(l)}if(!o.length)return 0;r||(o=k(o));var c=D.getEnhancement(e,n.id,i);i+=c;var u=0;for(l=0,d=o.length;l<d;l++){var f;if((f=s[o[l]]).nullified)f.nullified--,x.enabled&&x.appendLines(I.name(e)+" heals "+I.name(f)+" but it is nullified!");else{u++;var p=i;if(!p){var m=n.mult;p=Math.ceil(f.health*m)}p>f.health-f.health_left&&(p=f.health-f.health_left),f.health_left+=p,x.enabled&&(c&&x.appendLines("<u>(Enhance: +"+c+")</u>"),x.appendLines(I.name(e)+" heals "+I.name(f)+" by "+p))}}return u},poisonstrike:function(e,n,a){return S.strike(e,n,!0)},strike:function(e,t,n){for(var a=b(e),i=t.x,r=t.y,s=t.all,o=se[a].assaults,l=[],d=0,c=o.length;d<c;d++){(p=o[d]).isAlive()&&p.isInFaction(r)&&l.push(d)}if(!l.length)return 0;s||(l=k(l));var u=D.getEnhancement(e,t.id,i);i+=u;var f=0;for(d=0,c=l.length;d<c;d++){var p;if((p=o[l[d]]).invisible)p.invisible--,x.enabled&&x.appendLines(I.name(e)+" bolts "+I.name(p)+" but it is invisible!");else{f++;var m=i,h=X(p,m);m=h.damage;var v=h.shatter,g=0;0<m&&n&&p.isAlive()&&i>p.poisoned&&(g=i,p.poisoned=g),M(e,p,m,v,function(e,n,a){x.appendLines("<u>(Strike: +"+t.x),u&&x.appendLines(" Enhance: +"+u),x.appendLines(h.echo),x.appendLines(") = "+a+" damage</u>"),x.appendLines(I.name(e)+" bolts "+I.name(n)+" for "+a+" damage"),n.isAlive()?g&&x.appendLines(" and inflicts poison("+g+") on it"):x.appendLines(" and it dies"),x.appendLines("")}),p.backlash&&A(e,p)}}return f},intensify:function(e,n,a){for(var t=b(e),i=n.x,r=n.y,s=n.all,o=se[t].assaults,l=[],d=0,c=o.length;d<c;d++){(f=o[d]).isAlive()&&f.isInFaction(r)&&(f.scorched||f.poisoned)&&l.push(d)}if(!l.length)return 0;s||(l=k(l)),i+=D.getEnhancement(e,n.id,i);var u=0;for(d=0,c=l.length;d<c;d++){var f,p=(f=o[l[d]]).scorched?"scorch":"";p+=f.poisoned?p?" and poison":"poison":"",f.invisible?(f.invisible--,x.enabled&&x.appendLines(I.name(e)+" intensifies "+p+" on "+I.name(f)+" but it is invisible!")):(u++,f.scorched&&(f.scorched.amount+=i),f.poisoned&&(f.poisoned+=i),x.enabled&&x.appendLines(I.name(e)+" intensifies "+p+" on "+I.name(f)+" by "+i),f.backlash&&A(e,f))}return u},ignite:function(e,n,a){for(var t=b(e),i=(n.x,n.y),r=(n.all,se[t].assaults),s=[],o=0,l=r.length;o<l;o++){var d=r[o];d.isAlive()&&d.isInFaction(i)&&s.push(o)}return $(e,n,"ignites",s,r,function(e,n){e.scorch(n)})},jamself:function(e,n){return e.jammed=!0,e.jammedSelf=!0,x.enabled&&x.appendLines(I.name(e)+" freezes itself"),1},jam:function(e,n){y(e);for(var a=b(e),t=n.all,i=se[a].assaults,r=[],s=0,o=i.length;s<o;s++){(d=i[s]).isAlive()&&(t||d.isActiveNextTurn()&&d.isUnjammed())&&r.push(s)}if(!r.length)return 0;t||(r=k(r));var l=0;for(s=0,o=r.length;s<o;s++){var d;(d=i[r[s]]).invisible?(d.invisible--,n.countdown=0,x.enabled&&x.appendLines(I.name(e)+" freezes "+I.name(d)+" but it is invisible!")):(l++,d.jammed=!0,x.enabled&&x.appendLines(I.name(e)+" freezes "+I.name(d)),d.backlash&&A(e,d))}return l},frost:function(e,t){y(e);var n=b(e),a=t.x,i=D.getEnhancement(e,t.id,a);a+=i;t.all;for(var r=se[n].assaults,s=[],o=e.key-1,l=o+2;o<=l;o++){(f=r[o])&&f.isAlive()&&s.push(o)}if(!s.length)return 0;for(var d=0,c=0,u=s.length;c<u;c++){var f;if((f=r[s[c]]).invisible)f.invisible--,x.enabled&&x.appendLines(I.name(e)+" breathes frost at "+I.name(f)+" but it is invisible!");else{d++;var p=a,m=X(f,p);M(e,f,p=m.damage,m.shatter,function(e,n,a){x.appendLines("<u>(Frostbreath: +"+t.x),i&&x.appendLines(" Enhance: +"+i),x.appendLines(m.echo),x.appendLines(") = "+a+" damage</u>"),x.appendLines(I.name(e)+" breathes frost at "+I.name(n)+" for "+a+" damage"),x.appendLines(n.isAlive()?"":" and it dies")}),f.backlash&&A(e,f)}}return d},heartseeker:function(e,n){var a=b(e),t=n.x,i=se[a].assaults[e.key];return i?(t+=D.getEnhancement(e,n.id,t),i.heartseeker+=t,i.enfeebled+=t,x.enabled&&x.appendLines(I.name(e)+" inflicts heartseeker "+t+" on "+I.name(i)),1):0},enfeeble:function(e,n){for(var a=n.y,t=b(e),i=se[t].assaults,r=[],s=0,o=i.length;s<o;s++){var l=i[s];l.isAlive()&&l.isInFaction(a)&&r.push(s)}return $(e,n,"hexes",r,i,function(e,n){e.enfeebled+=n})},weakenself:function(e,n){return S.weaken(e,n)},weaken:function(e,n){var a,i=n.y;switch(n.id){case"weakenself":a=y(e);break;default:a=b(e)}var r=n.all,s=se[a].assaults,o=[],t=function(e){for(var n=0,a=s.length;n<a;n++){var t=s[n];t.isAlive()&&t.isInFaction(i)&&(r||t.isActiveNextTurn()&&t.isUnjammed()&&(e||t.hasAttack()))&&o.push(n)}};t(!1),o.length||t(!0);return $(e,n,"weakens",o,s,function(e,n){e.attack_weaken+=n})}};function $(e,n,a,t,i,r){if(!t.length)return 0;var s=D.getEnhancement(e,n.id,n.x),o=n.x+s;n.all||(t=k(t));for(var l=0,d=0,c=t.length;d<c;d++){var u=i[t[d]];u.invisible?(u.invisible--,x.enabled&&x.appendLines(I.name(e)+" "+a+" "+I.name(u)+" but it is invisible!")):(l++,r(u,o),x.enabled&&(s&&x.appendLines("<u>(Enhance: +"+s+")</u>"),x.appendLines(I.name(e)+" "+a+" "+I.name(u)+" by "+o)),u.backlash&&A(e,u))}return l}var T={enlarge:function(e,n){var a=n.y,t=y(e),i=n.x,r=D.getEnhancement(e,n.id,i);i+=r;for(var s=n.all,o=se[t].assaults,l=[],d=0,c=o.length;d<c;d++){(f=o[d]).isAlive()&&f.isInFaction(a)&&(s||f.isUnjammed()&&f.isActive())&&l.push(d)}if(!l.length)return 0;s||(l=k(l));var u=0;for(d=0,c=l.length;d<c;d++){var f=o[l[d]],p=i;if(!p){var m=n.mult;p=Math.ceil(f.attack*m)}f.attack_rally+=p,x.enabled&&(r&&x.appendLines("<u>(Enhance: +"+r+")</u>"),x.appendLines(I.name(e)+" enlarges "+I.name(f)+" by "+p)),u++}return u},rally:function(e,n){for(var a=n.y,t=y(e),i=n.x,r=n.all,s=se[t].assaults,o=[],l=0,d=s.length;l<d;l++){(f=s[l]).isAlive()&&f.isInFaction(a)&&(r||f.isActive()&&f.isUnjammed())&&o.push(l)}if(!o.length)return 0;r||(o=k(o));var c=D.getEnhancement(e,n.id,i);i+=c;var u=0;for(l=0,d=o.length;l<d;l++){var f;if((f=s[o[l]]).nullified)f.nullified--,x.enabled&&x.appendLines(I.name(e)+" empowers "+I.name(f)+" but it is nullified!");else{u++;var p=i;if(!p){var m=n.mult;p=Math.ceil(f.attack*m)}f.attack_rally+=p,x.enabled&&(c&&x.appendLines("<u>(Enhance: +"+c+")</u>"),x.appendLines(I.name(e)+" empowers "+I.name(f)+" by "+p))}}return u},legion:function(e,n){var a=y(e),t=se[a].assaults,i=n.x,r=D.getEnhancement(e,n.id,i);i+=r;var s=n.y,o=e.key-1,l=o+2;o<0&&(o+=2);for(var d=0;o<=l;){var c=t[o];c&&c.isActive()&&c.isInFaction(s)&&(c.nullified?(c.nullified--,x.enabled&&x.appendLines(I.name(e)+" activates legion and empowers "+I.name(c)+" but it is nullified!")):(d++,c.attack_rally+=i,x.enabled&&(r&&x.appendLines("<u>(Enhance: +"+r+")</u>"),x.appendLines(I.name(e)+" activates legion and empowers "+I.name(c)+" by "+i)))),o+=2}return d},fervor:function(e,n){var a=y(e),t=se[a].assaults,i=n.x,r=D.getEnhancement(e,n.id,i);i+=r;var s=n.y,o=0,l=e.key-1,d=l+2;for(l<0&&(l+=2);l<=d;){var c=t[l];c&&c.isInFaction(s)&&(o+=i),l+=2}return o?(e.attack_rally+=o,x.enabled&&(r&&x.appendLines("<u>(Enhance: +"+r+")</u>"),x.appendLines(I.name(e)+" activates fervor for "+o)),1):0},barrage:function(e,n){var a=b(e),t=n.x,i=n.y,r=n.all,s=se[a].assaults;t+=D.getEnhancement(e,n.id,t);for(var o=0;o<t;o++){for(var l=[],d=0,c=s.length;d<c;d++){(f=s[d]).isAlive()&&f.isInFaction(i)&&l.push(d)}if(!l.length)return 0;r||(l=k(l));var u=0;for(d=0,c=l.length;d<c;d++){var f;if((f=s[l[d]]).invisible)f.invisible--,x.enabled&&x.appendLines(I.name(e)+" throws a bomb at "+I.name(f)+" but it is invisible!");else{u++;var p=1,m=X(f,p,{enfeeble:!0});M(e,f,p=m.damage,m.shatter,function(e,n,a){x.appendLines("<u>(Barrage: +1"),x.appendLines(m.echo),x.appendLines(") = "+a+" damage</u>"),x.appendLines(I.name(e)+" throws a bomb at "+I.name(n)+" for "+a+" damage"),x.appendLines(n.isAlive()?"":" and it dies")})}}}return u},enhance:function(e,n){for(var a=n.y,t=y(e),i=(b(e),n.x),r=(a=n.y,n.s),s=n.mult,o=n.all,l=se[t].assaults,d=w(r),c=[],u=0,f=l.length;u<f;u++){(m=l[u]).isAlive()&&m.isInFaction(a)&&(o||!d||m.isActive()&&m.isUnjammed())&&m.hasSkill(r)&&c.push(u)}if(!c.length)return 0;o||(c=k(c));var p=0;for(u=0,f=c.length;u<f;u++){var m;if((m=l[c[u]]).nullified)m.nullified--,x.enabled&&x.appendLines(I.name(e)+" enhances "+I.name(m)+" but it is nullified!");else{p++;var h=m.enhanced;0<i?(h[r]=(h[r]||0)+i,x.enabled&&x.appendLines(I.name(e)+" enhances "+r+" of "+I.name(m,!1)+" by "+i)):0<s&&(h[r]=-s,x.enabled&&x.appendLines(I.name(e)+" enhances "+r+" of "+I.name(m,!1)+" by "+100*s+"%"))}}return p},enrage:function(e,n){for(var a=y(e),t=n.y,i=n.x,r=n.all,s=se[a].assaults,o=[],l=0,d=s.length;l<d;l++){(f=s[l]).isAlive()&&f.isInFaction(t)&&o.push(l)}if(!o.length)return 0;r||(o=k(o));var c=D.getEnhancement(e,n.id,i);i+=c;var u=0;for(l=0,d=o.length;l<d;l++){var f,p=i;(f=s[o[l]]).nullified?(f.nullified--,x.enabled&&x.appendLines(I.name(e)+" enrages "+I.name(f)+" but it is nullified!")):(u++,n.mult&&(p=Math.ceil(n.mult*f.health)),f.enraged+=p,x.enabled&&(c&&x.appendLines("<u>(Enhance: +"+c+")</u>"),x.appendLines(I.name(e)+" enrages "+I.name(f)+" by "+p)))}return u},imbue:function(e,n){for(var a=n.y,t=y(e),i=(b(e),n.x),r=(n.c,n.s),s=n.all,o=se[t].assaults,l=w(r),d=[],c=0,u=o.length;c<u;c++){(p=o[c]).isAlive()&&p.isInFaction(a)&&(s||!l||p.isActive()&&p.isUnjammed())&&d.push(c)}if(!d.length)return 0;n={id:r,x:i};s||(d=k(d));var f=0;for(c=0,u=d.length;c<u;c++){var p;if((p=o[d[c]]).nullified)p.nullified--,x.enabled&&x.appendLines(I.name(e)+" enhances "+I.name(p)+" but it is nullified!");else if(f++,p.hasSkill(r)){var m=p.enhanced;m[r]=(m[r]||0)+i,x.enabled&&x.appendLines(I.name(e)+" imbues "+I.name(p,!1)+" existing "+I.skill(n)+" by "+i)}else p.imbue(n),x.enabled&&x.appendLines(I.name(e)+" imbues "+I.name(p,!1)+" with "+I.skill(n))}return f},mark:function(e,n){for(var a=n.y,t=(y(e),b(e)),i=n.x,r=n.all,s=se[t].assaults,o=e.mark_target,l=[],d=0,c=s.length;d<c;d++){if((f=s[d]).isAlive()&&f.isInFaction(a)){if(f.uid===o){l=[d];break}l.push(d)}}if(!l.length)return 0;r||(l=k(l)),i+=D.getEnhancement(e,n.id,i);var u=0;for(d=0,c=l.length;d<c;d++){var f;u++,(f=s[l[d]]).enfeebled+=i,e.mark_target=f.uid,x.enabled&&x.appendLines(I.name(e)+" marks "+I.name(f)+" by "+i),n.countdown=1}return u}},e={ambush:function(e,n,a){var t=a.x,i=a.base,r=a.mult,s=t;if(!s){r=a.mult;s=Math.ceil(n[i]*r)}return M(e,n,s,null,function(e,n,a){x.appendLines(I.name(e)+" ambushes "+I.name(n)+" for "+a+" damage"),x.appendLines(n.isAlive()?"":" and it dies")}),1},slow:function(e,n,a){var t=a.x,i=a.base,r=a.mult,s=t;if(!s){r=a.mult;s=Math.ceil(n[i]*r)}return n.timer+=s,x.enabled&&x.appendLines(I.name(e)+" slows "+I.name(n)+" by "+s),1}},R={unearth:function(e,n,a){if(!e.isToken){var t=D.create(a.card||e.id,a.level||a.x),i=s.byIdWithBgeApplied(t,null,!0);i.isToken=!0;var r=a.mult;return r&&(i.attack=Math.floor(e.attack*r),i.health=Math.floor(e.health*r)),u(i,e.owner,!0),x.enabled&&x.appendLines(I.name(i)+" is unearthed</br>"),1}},reanimate:function(e,n,a){return e.reanimated?0:(e.health_left=a.x,e.reanimated=!0,x.enabled&&x.appendLines(" and is reanimated</br>"),1)}};function U(e){if(e.silenced)x.enabled&&x.appendLines(I.name(e)+" is silenced and cannot use skills</br>");else for(var n=e.skill,a=_(e),t=0,i=n.length;t<i&&a();t++){var r=n[t];if(!r.countdown){var s=f(S,r.id)(e,r);r.c&&0<s&&(r.countdown=r.c),C.areShown&&C.drawField(se,null,null,ue,e)}}}function P(e){var n,a,t,i=e.length;if(0==i)return!1;for(;--i;)n=~~(Math.random()*(i+1)),a=e[i],t=e[n],e[i]=t,e[n]=a}function F(l){var d=l.uids={};["player","cpu"].forEach(function(e){for(var n=re[e],a=n.deck,t="player"===e?1:101,i=0;i<a.length;i++){var r=t+i,s=a[i];s.owner=e,s.played=!1,s.uid=r,d[r]=s}var o=n.commander;o.owner=e,o.health_left=o.health,o.reusableSkills||o.resetTimers();r="player"===e?-1:-2;o.uid=r,d[r]=o,l[e].commander=o})}function B(e,n){C.clearFrames(),W(e,n)}function W(e,n){if(SIMULATOR.pause)return SIMULATOR.pause=!1;var a=function(e,n){var a,t;t=surge?(a="cpu","player"):(a="player","cpu");if(0<e){if(ce&&(!se.player.commander.isAlive()||!se.cpu.commander.isAlive()))return!(le=!1);if(!j(e,se,a,t,n))return!1;if(!se.player.commander.isAlive()||!se.cpu.commander.isAlive())return!(le=!1)}else!surge&&SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(e);for(e++;e<=c+1;e++){if(e===c+1)return!(le=!1);if(q(e,a,t,se),!j(e,se,a,t,!0))return!1;if(!se.player.commander.isAlive()||!se.cpu.commander.isAlive())return le=!1,x.enabled&&x.appendLines("<u>Turn "+e+" ends</u><br><br></div>"),!0}return!(le=!1)}(e,n);return a&&de&&d.debug_end(),a}function j(e,n,a,t,i){if(e%2)var r=a,s=t;else r=t,s=a;return closeDiv=!1,!!function(e,n,a){var t=re[e],i=t.deck,r=t.ordered;{if(ce&&"cpu"===e&&a)return V(e,i,r,n,a),!1;if(i[0]){SIMULATOR.waiting=!1;var s=0;if(1==i.length)s=0;else{for(var o=0;o<i.length;o++){var l=i[o];if(l.trap&&(u(l.trap,e,n),l.trap=!1),2===o)break}s=t.chooseCard(e,i,r,n,a)}if(s<0)return!1;u(i[s],e,n),function(e,n){var a=n,t=e.length-1;for(;a<t;)e[a]=e[++a];e.length=a}(i,s)}}return!0}(r,e,i)&&(function(e,n,a,t){for(var i=a[e],r=i.commander,s=i.assaults,o=a[n],l=o.commander,d=o.assaults,c=0;c<ie.onTurn.length;c++){var u=ie.onTurn[c];u.enemy_only&&"cpu"!==e||(u.ally_only&&"player"!==e||(u.owner=e,g(u),U(u)))}g(i.commander);for(var f=0,p=s.length;f<p;f++){var m=s[f];Q(m,"evade","invisible"),Q(m,"absorb","warded")}(function(e){for(var n=e.assaults,a=0,t=n.length;a<t;a++){var i=n[a];if(i.isAlive()&&i.isActive()&&i.isUnjammed()){var r=i.flurry;r&&0===r.countdown&&i.hasAttack()&&(r.countdown=r.c,i.dualstrike_triggered=!0),g(i)}}})(i),U(r);for(var f=0,p=s.length;f<p;f++){var m=s[f];if(m.isAlive()&&m.isActive())if(m.jammed)x.enabled&&x.appendLines(I.name(m)+" is frozen and cannot attack");else{var h=1;for(m.dualstrike_triggered&&(h++,x.enabled&&x.appendLines(I.name(m)+" activates dualstrike"));0<h;h--)if(U(m),m.isAlive())if(m.hasAttack()){if(ae(m,d,l),!l.isAlive()||!r.isAlive())return;if(!m.isAlive())break}else x.enabled&&0<m.permanentAttack()&&x.appendLines(I.name(m)+" is weakened and cannot attack")}}(function(e){for(var n=0,a=e.length;n<a;n++){var t=e[n];if(t.jammedSelf?t.jammedSelf=!1:t.jammed=!1,t.attack_rally=0,t.attack_weaken=0,t.nullified=0,t.dualstrike_triggered=!1,t.silenced=!1,t.regenerate&&t.isDamaged()){var i=t.regenerate,r=D.getEnhancement(t,"regenerate",i);i+=r;var s=t.health-t.health_left;s<=i&&(i=s),t.health_left+=i,x.enabled&&x.appendLines(I.name(t)+" regenerates "+i+" health")}var o=t.poisoned;if(o){var l=t.warded;l&&(o-=Z(t,"warded",o)),M(null,t,o,null,function(e,n,a){x.appendLines(I.name(n)+" takes "+a),l&&x.appendLines(" (Poison: +"+t.poisoned+" Ward: -"+l+")"),x.appendLines(" poison damage"),x.appendLines(n.isAlive()?"":" and it dies")})}var o=t.envenomed;if(o){var l=t.warded;l&&(o-=Z(t,"warded",o)),M(null,t,o,null,function(e,n,a){x.appendLines(I.name(n)+" takes "+a),l&&x.appendLines(" (Venom: +"+t.envenomed+" Ward: -"+l+")"),x.appendLines(" venom damage"),x.appendLines(n.isAlive()?"":" and it dies")})}var d=t.scorched;if(d){o=d.amount;var l=t.warded;l&&(o-=Z(t,"warded",o)),M(null,t,o,null,function(e,n,a){x.appendLines(I.name(n)+" takes "+a),l&&x.appendLines(" (Scorch: +"+d.amount+" Ward: -"+l+")"),x.appendLines(" scorch damage"),n.isAlive()?n.scorched||x.appendLines(" and scorch wears off"):x.appendLines(" and it dies"),x.appendLines("")}),1<d.timer?d.timer--:t.scorched=0}var c=t.corroded;if(c)if(c.timer--,c.timer<0)t.corroded=!1,t.attack_corroded=0,x.enabled&&x.appendLines(I.name(t)+" recovers from corrosion");else{var u=c.amount;t.attack_corroded=u,x.enabled&&x.appendLines(I.name(t)+" loses "+u+" attack to corrosion")}t.isAlive()||O(t,null)}})(s),v("player"),v("cpu"),x.enabled&&x.appendLines("<u>Turn "+t+" ends</u><br><br></div>")}(r,s,n,e),!0)}function H(e,n,a){var t=n[a];return t?e+" draws "+I.name(t,!0)+"<br/>":""}function q(e,n,a,t){if(choice=void 0,(oe=e)%2)var i=n,r=a;else i=a,r=n;if(x.enabled){var s=I.name(t[i].commander),o=re[i].deck;x.appendLines('<div id="turn_"'+e+' class="turn-info"><hr/><br/><u>Turn '+e+" begins for "+s+"</u>"),e<=2&&(x.appendLines(H(s,o,0)),x.appendLines(H(s,o,1))),x.appendLines(H(s,o,2))}var l=t[i],d=t[r],c=l.assaults,u=d.assaults;ee(l.commander);for(var f=0,p=c.length;f<p;f++){var m=c[f];if(0<m.timer&&(3===e&&tournament||(m.timer--,x.enabled&&x.appendLines(I.name(m)+" reduces its timer"))),m.valor){var h=u[f];h&&m.adjustedAttack()<h.adjustedAttack()?(m.attack_valor+=m.valor,x.enabled&&x.appendLines(I.name(m)+" activates valor, boosting its attack by "+m.valor)):x.enabled&&(x.appendLines(I.name(m)+" activates valor but "),h?x.appendLines("enemy is not strong enough."):x.appendLines("there is no opposing enemy."))}m.enfeebled=m.envenomed+m.heartseeker,m.enraged=0,m.invisible=0,m.protected=0,m.barrier_ice=0,m.warded=0,m.enhanced={},m.removeImbue(),ee(m)}}function V(e,n,a,t,i){return SIMULATOR.waiting=!0,closeDiv=!0,i&&(p.hideTable(),p.displayTurns(),C.drawField(se,null,W,t),SIMULATOR.sendBattleUpdate(t)),-1}function G(e,n,a,t,i){var r=n.slice(0,3);closeDiv=!0;for(var s=[],o=[],l=0,d=r.length;l<d;l++){var c=r[l],u=l+": "+c.name;1<c.maxLevel&&(u+="{"+c.level+"/"+c.maxLevel+"}"),s.push(u),o.push(c)}if(i&&(p.hideTable(),p.displayTurns(),C.drawField(se,o,B,t)),void 0===choice)return-1;var f=choice;return f||(f=0),f}function z(e,n,a,t,i){if(void 0===a)return 0;for(var r=n.slice(0,3),s=!1,o=0,l=a.length;o<l;o++){for(var d,c=a[o],u=c.priority,f=-1,p=0,m=r.length;p<m;p++){var h=(d=r[p]).priority;if(D.areEqual(c,d)){s=!0;break}0<u&&u==h&&(f=p)}if(!s&&0<=f&&(s=!0,d=r[p=f]),s){for(var v=a.length-1;o<v;o++)a[o]=a[o+1];return a.length=o,p}}return-1}function K(e,n,a,t,i){var r=n.slice(0,3);return~~(Math.random()*r.length)}function J(e,n,a,t,i){for(var r,s,o,l,d,c=n.slice(0,3),u=-1,f=-1,p=0;p<c.length;p++){var m=c[p],h=(void 0,s=(r=m).id.toString(),o=6*parseInt(r.rarity),l=3*(4<s.length?parseInt(s[0]):0),d=parseInt(r.level)-parseInt(r.maxLevel),o+l+d);f<h&&(f=h,u=p)}return u}function Y(e,n,a,t,i){return 0}function Q(e,n,a){var t=0;e[n]&&(t=e[n],t+=D.getEnhancement(e,n,t));e[a]=t}function X(e,n,a){var t=(a=a||{}).enfeeble?0:e.enfeebled||0,i=a.stasis?0:N(e),r=a.protect?0:e.protected||0,s=a.ward?0:e.warded||0;n+=t-i;var o=!1;s&&(n-=Z(e,"warded",n)),r&&(n-=Z(e,"protected",n),0==e.protected&&(o=e.barrier_ice)),i&&(n-=i);return x.enabled&&(t&&x.appendLines(" Enfeeble: +"+t),i&&x.appendLines(" Stasis: -"+i),r&&x.appendLines(" Barrier: -"+r),s&&x.appendLines(" Ward: -"+s)),n<0&&(n=0),{damage:n,shatter:o,echo:""}}function Z(e,n,a){var t=e[n];return t<=a?(e[n]=0,t):(e[n]-=a,a)}function ee(e){ne(e,e.skill),ne(e,e.earlyActivationSkills);var n=e.flurry;n&&n.countdown&&(n.countdown--,x.enabled&&(n.countdown?x.appendLines(I.name(e)+" charges  dualstrike (ready in "+n.countdown+" turns)"):x.appendLines(I.name(e)+" readies dualstrike")))}function ne(e,n){for(var a=0,t=n.length;a<t;a++){var i=n[a];i.countdown&&(i.countdown--,x.enabled&&(i.countdown?x.appendLines(I.name(e)+" charges "+o.nameFromId(i.id)+" (ready in "+i.countdown+" turns)"):x.appendLines(I.name(e)+" readies "+o.nameFromId(i.id))))}}function ae(e,n,a){var t=n[e.key];if(t&&t.isAlive()){var i,r=!1;if(!t.taunt)if((i=n[e.key-1])&&i.taunt)t=i,r=!0;else(i=n[e.key+1])&&i.taunt&&(t=i,r=!0);r&&x.enabled&&x.appendLines(I.name(t)+" taunts "+I.name(e))}else t=a;var s=e.adjustedAttack(),o=t.enfeebled;s+=o,x.enabled&&(x.appendLines("<u>(Attack: +"+e.attack),e.attack_berserk&&x.appendLines(" Berserk: +"+e.attack_berserk),e.attack_valor&&x.appendLines(" Valor: +"+e.attack_valor),e.attack_rally&&x.appendLines(" Rally: +"+e.attack_rally),e.attack_weaken&&x.appendLines(" Weaken: -"+e.attack_weaken),e.attack_corroded&&x.appendLines(" Corrosion: -"+e.attack_corroded),o&&x.appendLines(" Enfeeble: +"+o));var l=e.pierce;l?l+=D.getEnhancement(e,"pierce",l):l=0;var d=t.protected,c=!1,u=t.armored,f=N(t);if(d&&(x.enabled&&x.appendLines(" Barrier: -"+d),l&&(d<=l?(x.enabled&&x.appendLines(" Pierce: +"+d),l-=d,d=0,t.protected=0):(x.enabled&&x.appendLines(" Pierce: +"+l),d-=l,t.protected-=l,l=0)),d&&(d<=s?(c=t.barrier_ice,s-=d,t.protected=0):(t.protected-=s,s=0))),f&&(f+=D.getEnhancement(t,"stasis",f),x.enabled&&x.appendLines(" Shroud: -"+f),l&&(f<l?(x.enabled&&x.appendLines(" Pierce: +"+f),f=0):(x.enabled&&x.appendLines(" Pierce: +"+l),f-=l)),s-=f),u&&(u+=D.getEnhancement(t,"armored",u),x.enabled&&x.appendLines(" Armor: -"+u),l&&(u<l?(x.enabled&&x.appendLines(" Pierce: +"+u),u=0):(x.enabled&&x.appendLines(" Pierce: +"+l),u-=l)),s-=u),s<0&&(s=0),x.enabled&&x.appendLines(") = "+s+" damage</u>"),M(e,t,s,null,function(e,n,a){x.appendLines(I.name(e)+" attacks "+I.name(n)+" for "+a+" damage"),x.appendLines(n.isAlive()?"":" and it dies")}),C.areShown&&C.drawField(se,null,null,ue,e),a.isAlive()){if(0<s&&t.isAssault()&&t.isAlive()){if(e.poison){var p=e.poison;(p+=D.getEnhancement(e,"poison",p))>t.poisoned&&(t.poisoned=p,x.enabled&&x.appendLines(I.name(e)+" inflicts poison("+p+") on "+I.name(t)))}if(e.venom){var m=e.venom;if((m+=D.getEnhancement(e,"venom",m))>t.envenomed){var h=m-t.envenomed;t.envenomed=m,t.enfeebled+=h,x.enabled&&x.appendLines(I.name(e)+" inflicts venom("+m+") on "+I.name(t))}}if(e.nullify){var v=e.nullify;v+=D.getEnhancement(e,"nullify",v),t.nullified+=v,x.enabled&&x.appendLines(I.name(e)+" inflicts nullify("+v+") on "+I.name(t))}if(e.silence&&(t.silenced=!0,x.enabled&&x.appendLines(I.name(e)+" inflicts silence on "+I.name(t))),e.daze){var g=e.daze;g+=D.getEnhancement(e,"daze",g),t.attack_weaken+=g,x.enabled&&x.appendLines(I.name(e)+" dazed "+I.name(t)+" for "+g)}}if(c&&E(t),0<s&&e.isAlive()){if(e.leech&&e.isDamaged()){var b=e.leech;b+=D.getEnhancement(e,"leech",b);var k=e.health-e.health_left;k<=b&&(b=k),e.health_left+=b,x.enabled&&x.appendLines(I.name(e)+" siphons "+b+" health")}if(e.reinforce){var y=e.reinforce;y+=D.getEnhancement(e,"reinforce",y),e.protected+=y,x.enabled&&x.appendLines(I.name(e)+" reinforces itself with barrier "+y)}if(t.counter){var _=0+t.counter;te(e,t,"Vengance",_,D.getEnhancement(t,"counter",_))}if(t.counterburn){var L=t.counterburn||0;L+=D.getEnhancement(t,"counterburn",L),e.scorched?(e.scorched.amount+=L,e.scorched.timer=2):e.scorched={amount:L,timer:2},x.enabled&&x.appendLines(I.name(t)+" inflicts counterburn("+L+") on "+I.name(e))}if(t.counterpoison){p=t.counterpoison||0;(p+=D.getEnhancement(t,"counterpoison",p))>e.poisoned&&(e.poisoned=p,x.enabled&&x.appendLines(I.name(t)+" inflicts counterpoison("+p+") on "+I.name(e)))}if(t.fury){var w=t.fury,A=D.getEnhancement(t,"counter",w);if(t.isAlive()){var S=w+A;t.attack_berserk+=S,x.enabled&&x.appendLines(I.name(t)+" activates fury and gains "+S+" attack")}te(e,t,"Fury",w,A)}if(0<t.enraged&&(t.attack_berserk+=t.enraged,x.enabled&&x.appendLines(I.name(t)+" is enraged and gains "+t.enraged+" attack!</br>")),e.berserk){var $=e.berserk;$+=D.getEnhancement(e,"berserk",$),e.attack_berserk+=$,x.enabled&&x.appendLines(I.name(e)+" activates berserk and gains "+$+" attack")}}if(t.corrosive){var T=t.corrosive||0;T+=D.getEnhancement(t,"corrosive",T),e.corroded?(e.corroded.amount+=T,e.corroded.timer=2):e.corroded={amount:T,timer:2},x.enabled&&x.appendLines(I.name(t)+" inflicts corrosion("+T+") on "+I.name(e)),e.attack_corroded=T,x.enabled&&x.appendLines(I.name(e)+" loses "+T+" attack to corrosion")}e.isAlive()||O(e,t),C.areShown&&C.drawField(se,null,null,ue,e)}}function te(e,n,t,a,i){var r=a+i,s=X(e,r,{enfeeble:!0});r=s.damage;s.shatter;x.enabled&&(x.appendLines("<u>("+t+": +"+a),i&&x.appendLines(" Enhance: +"+i),x.appendLines(s.echo),x.appendLines(") = "+r+" damage</u>")),M(n,e,r,null,function(e,n,a){x.appendLines(I.name(n)+" takes "+a+" "+t.toLowerCase()+" damage"),x.appendLines(n.isAlive()?"":" and it dies")})}SIMULATOR.pause=!1,SIMULATOR.performTurns=W,SIMULATOR.waitForOpponent=V;var ie,re={},se={},oe=0,le=!1,de=!1,ce=!1,ue=0,fe=0,pe=0;SIMULATOR.simulate=function(e){if(le=!0,function(e){SIMULATOR.simulation_turns=0;var n={cpu:{deck:[]},player:{deck:[]}};SIMULATOR.deck=n,SIMULATOR.field={cpu:{assaults:[]},player:{assaults:[]}},r&&(n.player=l.copyDeck(r)),e.selectedMission&&1<e.missionLevel&&e.missionLevel<7?(t=l.mission(e.selectedMission,e.missionLevel),i=l.getDeckCards(t,"cpu")):e.selectedRaid&&(t=l.raid(e.selectedRaid,e.raidLevel),i=l.getDeckCards(t,"cpu")),i&&(n.cpu=l.copyDeck(i)),getordered&&!getexactorder&&(n.player.ordered=l.copyCardList(n.player.deck)),getordered2&&!getexactorder2&&(n.cpu.ordered=l.copyCardList(n.cpu.deck)),n.player.chooseCard=de?G:getordered?z:K,n.cpu.chooseCard=getordered2?z:e.pvpAI?J:getexactorder2?K:Y}(e),getexactorder?getordered||(re.player.shuffleHand=!0):P(re.player.deck),getexactorder2?getordered2||(re.cpu.shuffleHand=!0):P(re.cpu.deck),F(se),e.siegeMode){var n=BATTLEGROUNDS[e.towerType].effect[e.towerLevel];if(n){n=D.create(n.id,n.level);var a=s.byIdWithBgeApplied(n);a.uid=150,u(se.uids[150]=a,"cpu",-1,!0)}}return W(0)},SIMULATOR.setupDecks=function(e){n=getdeck?a.decodeHash(getdeck):l.defaultDeck(),r=l.getDeckCards(n,"player"),e.pvpAI=!0,getdeck2?(t=a.decodeHash(getdeck2),e.selectedMission&&(e.pvpAI=!1)):e.selectedMission?(t=l.mission(e.selectedMission,e.missionLevel),e.pvpAI=!1):e.selectedRaid?(t=l.raid(e.selectedRaid,e.raidLevel),e.pvpAI=!1):t=l.defaultDeck(),i=l.getDeckCards(t,"cpu")},SIMULATOR.onPlaySkills=e,SIMULATOR.calculatePoints=function(e){var n=se.uids,a={player:{total:0,taken:0},cpu:{total:0,taken:0}};for(var t in n){var i=n[t],r=a[i.owner];r&&(r.total+=i.health,(i.played||i.isCommander())&&(r.taken+=i.health-i.health_left))}a.player.percent=r.taken/r.total,a.cpu.percent=r.taken/r.total;var s,o=se.cpu.commander;return s=getdeck2?o.isAlive()&&!e?Math.floor(25*a.cpu.percent):130-Math.floor(15*a.player.percent):o.isAlive()&&!e?(s=Math.floor(a.cpu.percent/.02),Math.max(5,s)):200-Math.floor(a.player.percent/.02)},Object.defineProperties(SIMULATOR,{setupField:{get:function(){return F},set:function(e){F=e}},deck:{get:function(){return re},set:function(e){re=e}},field:{get:function(){return se},set:function(e){se=e}},battlegrounds:{get:function(){return ie},set:function(e){ie=e}},simulation_turns:{get:function(){return oe},set:function(e){oe=e}},simulating:{get:function(){return le},set:function(e){le=e}},totalDeckHealth:{get:function(){return fe},set:function(e){fe=e}},totalCpuDeckHealth:{get:function(){return pe},set:function(e){pe=e}},user_controlled:{get:function(){return de},set:function(e){de=e}},livePvP:{get:function(){return ce},set:function(e){ce=e}}})}(),function(e){"use strict";var n=function(e,n,a){return e.filter(function(e){return e[a]==n})},a=function(e,n,a,t,i){var r=a.filter(function(e){return e.id==n})[0];if(r){var s=r[t];return e.filter(function(e){var n=e[i];return 0<=s.indexOf(n)})}return[]};e.module("core",[]).filter("forMissions",function(){return function(e,n){if(!e||!n)return e;for(var a=[],t=0,i=e.length;t<i;t++){for(var r=e[t],s=r.missions,o=!0,l=0;l<s.length;l++){if(!n[s[l]]){o=!1;break}}o&&a.push(r)}return a}}).filter("filterByParent",function(){return n}).filter("filterChildren",function(){return a}),e.module("simulatorApp",["core"]).controller("SimulatorCtrl",["$scope","$window",function(i,e){function n(e){var n=Object.keys(e);n.sort(function(e,n){return Number(e)-Number(n)});for(var a=[],t=0;t<n.length;t++){var i=n[t],r=e[i];a.push(r)}return a}function a(e){var n=[];for(var a in e)n.push(e[a]);return n}i.locations=[],i.campaigns=[],i.missions=e.TITANS,i.raids=e.RAIDS,i.battlegrounds=e.BATTLEGROUNDS,i.mapBattlegrounds=a(e.MAP_BATTLEGROUNDS),i.campaignBGEs=[],i.tower=!1,i.auto=!1,i.debugMode=!1,i.selections={location:"",campaign:"",mission:"",raid:""},i.titans=function(){i.campaigns=a(e.CAMPAIGNS),i.missions=e.TITANS},i.campaignSections=function(){i.locations=n(e.LOCATIONS).sort(function(e,n){return Number(e.id)-Number(n.id)}),i.missions=n(e.MISSIONS),i.campaigns=n(e.CAMPAIGNS)},i.filteredRaids=function(){var n={};return a(i.raids).sort(function(e,n){return Number(n.id)-Number(e.id)}).forEach(function(e){n[e.name]||(n[e.name]=e)}),a(n).sort(function(e,n){return Number(e.id)-Number(n.id)})},i.getLocationClass=function(e){if(!e){var n=i.selections.location;e=i.locations.filter(function(e){return e.id==n})[0]}if(e){var a=Number(e.id);return 0===a?"heroUpgrade":100<=a?"event":"black"}return"grey"},i.getCampaignClass=function(e){if(!e){var n=i.selections.campaign;e=i.campaigns.filter(function(e){return e.id==n})[0]}return e?e.side_mission?0==e.location_id?"heroUpgrade":"mythic":e.isLocation?"location":"black":"grey"},i.$watch("selections.location",function(e,n){i.selections.campaign=""}),i.$watch("selections.campaign",function(e,n){i.selections.mission=""}),i.towerTypes=["Castle Tower","Cannon Tower","Tree of Life"],i.selectableBattlegrounds=function(){var e=[];for(var n in i.battlegrounds){var a=i.battlegrounds[n];a.hidden||a.isTower||e.push(a)}return e.sort(function(e,n){return e.id-n.id}),e},i.personalBattlegrounds=function(){var e=[];for(var n in i.battlegrounds){var a=i.battlegrounds[n],t=Number(a.id);1e3<t&&t<2e3&&e.push(a)}return e.sort(function(e,n){return e.id-n.id}),e},i.towerTypes=function(){var e=[];for(var n in i.battlegrounds){var a=i.battlegrounds[n];a.isTower&&e.push(a)}return e.sort(function(e,n){return e.id-n.id}),e},i.$watch("debugMode",function(e,n){})}])}(angular),function(n){"use strict";var a,t=require("storageAPI");try{a=n.module("simulatorApp")}catch(e){a=n.module("simulatorApp",[])}a.controller("DeckStorageCtrl",["$scope","$window",function(e,n){e.getSavedDecks=t.getSavedDecks,e.keys=function(e){return e?Object.keys(e):[]}}])}(angular),define("tutorialScript",["urlHelpers"],function(e){for(var n=[{msg:"Welcome to SIM Spellstone!  This is a brief tutorial of how to use the Simulator."},{ui:"#setup-container",msg:"Here is where you set everything up for a simulation.",actions:[s]},{ui:"#setup-container",msg:'When you are done, you can click the "Setup" bar to hide this section.',actions:[r]},{ui:"#setup-container",msg:"Clicking it again will open it back up.",actions:[s]},{ui:"#attacker-container",msg:"Use this section to set up the deck for the attacker."},{ui:"#edit-player",msg:'Click "Edit" to open the DeckBuilder and create a deck.'},{ui:"#load-player",msg:'Click "Load" to choose a deck from the ones you have saved in the DeckBuilder.'},{ui:"#attacker-hash-container",msg:"If you have a deck hash, you can simply paste it here as well."},{ui:"#attacker-advanced",msg:"This section contains some additional settings for the attacker that determine how their deck is played."},{ui:"#auto-container",msg:"Check this to have fights run on auto, rather than playing them yourself.",showFor:"battle"},{ui:"#auto-container",msg:'Setting the attacker to "auto" also enables the "Ordered" and "Do Not Shuffle" options.',showFor:"battle"},{ui:"#ordered-container",msg:"Check this to have the AI attempt to play the attacker's deck as close as possible to the order that the cards are listed."},{ui:"#exactorder-container",msg:"Check this to disable shuffling of the attacker's deck."},{ui:"#defender-container",msg:"Use this section to set up the deck for the defender."},{ui:"#defender-hash-container",msg:"You can manually create a deck for the defender here."},{ui:"#pve-container",msg:"Or you can choose a PvE deck to sim against.",actions:[d]},{ui:"#campaign-container",msg:"To choose a campaign mission, first pick a Campaign from the dropdown...",actions:[l]},{ui:"#mission-container",msg:"... then pick a Mission from the mission dropdown.",actions:[c,l,function(){$("#mission").val(11).change()}]},{ui:"#raid-container",msg:"To fight against a raid boss, pick the desired Raid from the dropdown",actions:[d,function(){$("#raid").val(24005).change()}]},{ui:"#defender-advanced",msg:"This section contains some additional settings for the defender that determine how their deck is played.",actions:[c]},{ui:"#surge-container",msg:"Check this to have the defender go first.",showFor:"battle"},{ui:"#tower-container",msg:"Use these fields to set up a tower for the defender."},{ui:"#siege-container",msg:"Check this field to turn the tower on."},{ui:"#tower_level",msg:"This field determines the BR of the defender.  The tower's level is one less than the defender's BR."},{ui:"#tower_type",msg:"This field determines which type of tower the defender will have."},{ui:"#bge-container",msg:"Check/uncheck boxes here to set active battleground effects.",actions:[o,s]},{ui:"#view-container",msg:'Click "View" to display the currently set decks for the attacker and defender.',actions:[r,function(){$("#view-container").accordion("option","active",0)}]},{ui:"#view-container",msg:"Click it again to hide it.",actions:[o]},{ui:"#sims-container",msg:"This field determines how many fights to run.",showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Simulate" to run a batch of fights.',showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Battle" to start a fight.',showFor:"battle"},{ui:"#generate_link",msg:'Click "Generate Link" to create a link that will open this tool with all of the current settings.'},{msg:'To view this tutorial again at any time, you can click the "Help" button.  (Note: this will reset the Simulator.)'}],a=e.getCurrentPage(),t=0;t<n.length;t++){var i=n[t];i.showFor&&i.showFor!==a&&n.splice(t--,1)}function r(){$("#setup-container").accordion("option","active",null)}function s(){$("#setup-container").accordion("option","active",0)}function o(){$("#view-container").accordion("option","active",null)}function l(){$("#campaign").val(1).change()}function d(){$("#campaign").val("").change()}function c(){$("#raid").val("").change()}return n}),$(document).ready(function(){var e=require("storageAPI"),r=require("tutorialScript"),n=$("<div></div>");function a(){e.shouldShowTutorial?t():d()}function t(){o=0,c(),$("#tutorial").show()}$(document.body).append(n),n.load("templates/tutorial-overlay.html",null,function(){n.replaceWith(function(){return $(this).contents()}),$("#tutorial-show").prop("checked",e.shouldShowTutorial).change(function(){e.setShowTutorial(this.checked)}),$("#help").click(t),$("#tutorial-close, #tutorial-skip").click(d),$("#tutorial-next").click(i),$("#tutorial-prev").click(l),"undefined"==typeof delayTutorial&&a()});var s,o=0;function i(){o++,c()}function l(){o--,c()}function d(){$("#tutorial").hide(),$("#tutorial-permahide").is(":checked")&&e.hideTutorial()}function c(){clearTimeout(s);var e=r[o],n=e.actions;n&&n.forEach(function(e){e()});var a=e.msg,t=e.ui;if(t){var i=$(t);e.dialog&&(i=i.parent()),u(i),n&&(s=setTimeout(u,500,i)),a.indexOf(!1)&&(a=a.replace(/\{0\}/g,i.text()))}else $(".overlay-fog").width(0).height(0);$("#tutorialMessage").text(a),o<r.length-1?($("#tutorial-next").show(),$("#tutorial-close").hide()):($("#tutorial-next").hide(),$("#tutorial-close").show()),0<o?$("#tutorial-prev").removeClass("disabled"):$("#tutorial-prev").addClass("disabled")}function u(e){var n=e.offset();$(".overlay-fog").css({top:n.top-2+"px",left:n.left-2+"px"}).width(e.outerWidth()+4+"px").height(e.outerHeight()+4+"px")}window.showTutorial=t,window.checkTutorial=a});
//# sourceMappingURL=simulator.min.js.map