for(var skillID in define("debugLog",function(){var e={enabled:!1,getLog:function(){return a},clear:function(){a=""},prepend:n,prependLines:function(){for(var e=0;e<arguments.length;e++)n(arguments[e]+"</br>")},append:t,appendLines:function(){for(var e=0;e<arguments.length;e++)t(arguments[e]+"</br>")}},a="";function n(e){a=e+a}function t(e){a+=e}return e}),define("log",function(){var e={skill:function(e){var a=t.nameFromId(e.id);e.all&&(a+=" all");e.y&&(a+=" "+n.names[e.y]);e.s&&(a+=" "+t.nameFromId(e.s));e.c?a+=" every "+e.c+" turns":e.x&&(a+=" "+e.x);return a},name:function(e,a){if("cpu"===e.owner)var n="i";else var n="b";var t="<"+n+">";t+=e.name,e.runes.length&&(t+="*");1<e.maxLevel&&(t+="{"+e.level+"/"+e.maxLevel+"}");void 0!==e.key&&(t+=" ("+e.key+")");if(t+="</"+n+">",!a){if(t+="<u>",e.isCommander())t+=" [",void 0!==e.health_left?t+=i(e.health_left):t+=e.health,t+=" HP]";else if(e.isAssault()){t+=" [";var r=e.adjustedAttack();(isNaN(r)||null==r)&&(r=e.attack),t+=r,t+="/",void 0!==e.health_left?t+=i(e.health_left):t+=e.health,t+="/",void 0!==e.timer?t+=e.timer:t+=e.cost,t+="]"}t+="</u>"}return t}},n=require("factions"),t=require("skillApi");function i(e){return e>Math.floor(e)&&(e=e.toFixed(1)),e}return e}),define("bgeApi",function(){var e={getBattlegrounds:function(e,a,n,t,r,i,s,o){var l={onCreate:[],onTurn:[],onCardPlayed:[]};g(l,e),g(l,a,"player"),g(l,n,"cpu"),function(e,a,n){if(a)for(var t=a.split(","),r=0;r<t.length;r++){var i=t[r].split("-"),s=i[0],o=i[1],l=i[2],d=Object.keys(MAP_BATTLEGROUNDS).filter(function(e){return MAP_BATTLEGROUNDS[e].location_id==s})[0],c=(d=MAP_BATTLEGROUNDS[d]).effects[o].upgrades[l];h(e,c,n)}}(l,t,"player"),r?function(e,a,n){var t=CAMPAIGNS[a];if(t){var r=t.battleground_id;if(r){var i=BATTLEGROUNDS[r];if(n=Number(n)-1,!i.starting_level||Number(i.starting_level)<=n){if(i.scale_with_level){i=JSON.parse(JSON.stringify(i));for(var s=n-Number(i.starting_level),o=0;o<i.effect.length;o++){var l=i.effect[o];l.mult=l.base_mult+l.mult*s}}h(e,i,"cpu")}}}}(l,r,i):s&&function(e,a,n){var t=RAIDS[a].bge;if(t){var r=BATTLEGROUNDS[t];if(r&&Number(n)>=Number(r.starting_level))for(var i=r.enemy_only,s=0;s<r.effect.length;s++){var o=r.effect[s],l=o.effect_type;if("skill"===l){if(r.scale_with_level)var d=r.scale_with_level*(n-r.starting_level+1);else var d=1;var c=u.makeBattleground(r.name,o,d);c.enemy_only=i,e.onTurn.push(c)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(l)){var c=p(r.name,o);c.enemy_only=i,e.onCreate.push(c)}else if(0<=["scale_attack","scale_health"].indexOf(l)){var c=m(r.name,o);c.enemy_only=i,e.onCreate.push(c)}else if("trap_card"===l){var c=f(r.name,o);c.enemy_only=i,e.onCardPlayed.push(c)}}}}(l,s,o);return l}},d=require("log"),u=require("cardApi"),c=require("debugLog");function p(e,a){return{name:e,modifierType:a.effect_type,effects:[a]}}function m(e,a){return{name:e,modifierType:"scale_stat",scaledStat:a.effect_type.replace("scale_",""),effects:[a]}}var n,t,o=((n=function(e,a){this.p=null,this.name=e,this.effect=a,this.runes=[]}).prototype={onCardPlayed:function(e){SIMULATOR.onPlaySkills[this.effect.id](this,e,this.effect)},isCommander:function(){return!1},isAssault:function(){return!1}},function(e,a){return new n(e,a)}),f=((t=function(e,a){this.name=e,this.id=a.id,this.base=a.base,this.mult=a.mult,this.target_deck=a.target_deck,this.y=a.y}).prototype={onCardPlayed:function(e,a,n){var t="opponent"===this.target_deck?n:a;if(e.isInFaction(this.y)){for(var r=[],i=0;i<t.length;i++)(e=t[i]).trap||r.push(e);if(r.length){var s=Math.ceil(e[this.base]*this.mult),o=unitInfo.create(this.id,s),l=u.byId(o);r[~~(Math.random()*r.length)].trap=l,c.enabled&&c.appendLines(this.name+" inserts "+d.name(l)+" into the opposing deck.")}}}},function(e,a){return new t(e,a)});function h(e,a,n){for(var t=0;t<a.effect.length;t++){var r=a.effect[t],i=r.effect_type;if("skill"===i){var s=u.makeBattleground(a.name,r);"player"===n&&(s.ally_only=!0),"cpu"===n&&(s.enemy_only=!0),e.onTurn.push(s)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(i)){s=p(a.name,r);"player"===n&&(s.ally_only=!0),"cpu"===n&&(s.enemy_only=!0),e.onCreate.push(s)}else if(0<=["scale_attack","scale_health"].indexOf(i)){s=m(a.name,r);"player"===n&&(s.ally_only=!0),"cpu"===n&&(s.enemy_only=!0),e.onCreate.push(s)}else if("trap_card"===i){s=f(a.name,r);"player"===n&&(s.ally_only=!0),"cpu"===n&&(s.enemy_only=!0),e.onCardPlayed.push(s)}else if("on_play"===i){(s=o(a.name,r.effect)).attacker=r.attacker,s.defender=r.defender,s.first_play=r.first_play,"player"===n&&(s.ally_only=!0),"cpu"===n&&(s.enemy_only=!0),e.onCardPlayed.push(s)}}}function g(e,a,n){if(!a)return null;for(var t=a.split(","),r=0;r<t.length;r++){var i=t[r];h(e,BATTLEGROUNDS[i],n)}}return e}),define("loadDeck",function(){var d=require("cardInfo"),k=require("cardApi"),e=require("unitInfo");function _(e){for(var a=function(e){for(var a,n=e.id;void 0!==(n=REVERSE_FUSIONS[a=n]););return a}(e),n=-1;void 0!==a;)n++,a=FUSIONS[a];return n}function y(e,a,n){if(a=parseInt(a),e.mastery_level&&a<parseInt(e.mastery_level))return null;if(e.remove_mastery_level&&a>=parseInt(e.remove_mastery_level))return null;var t=e.id,r=!1;t||(t=function(e){var a=[];for(var n in CARDS)if(!REVERSE_FUSIONS[n]){var t=CARDS[n];if("1"!=t.card_type&&!(e.max_rarity&&Number(e.max_rarity)<Number(t.rarity)||e.min_rarity&&Number(e.min_rarity)>Number(t.rarity))&&(!e.type||e.type==t.type||0<=t.sub_type.indexOf(e.type.toString()))){if(e.set&&e.set.split(",").indexOf(t.set)<0)continue;a.push(n)}}return a[~~(Math.random()*a.length)]}(e),r=!0);var i=e.level||1;if(n<=a)i=7,c(t)&&(t=u(t));else if(1<a&&d.isCommander(t)){var s=(Number(d.loadCard(t).rarity)+1)/(n-1),o=a-1;i=Math.ceil(s*o)}var l=e.create(t,i);return r&&(l.randomInfo={unitInfo:e,level:a,maxedAt:n}),l}function L(e){var a=parseInt(d.loadCard(e.id).rarity)+2;if(e.level==a){if(!c(e.id))return!1;e.id=u(e.id,1),e.level=1}else e.level++;return!0}function c(e){return!(-1<i.indexOf(e))&&(!d.isCommander(e)&&!!FUSIONS[e])}function u(e,a){if(-1==i.indexOf(e))if(a)for(var n=0;n<a;n++)e=r(e);else do{var t=r(e);e=t}while(e!==t);return e}function r(e){var a=FUSIONS[e];return a||e}var i=["8005","8006","8007","8008","8009","8010"];function s(e,a,n){var t=n+1;a||(a=t);var r=[];r.deck=[];var i=function(e,a){a=parseInt(a);var n=e.commander;if(n.card){for(var t=[],r=0;r<n.card.length;r++){var i=n.card[r],s=parseInt(i.min_mastery_level)||0,o=parseInt(i.max_mastery_level)||999;s<=a&&a<=o&&t.push(i)}(n=t[~~(Math.random()*t.length)]).possibilities=t}return n}(e,a),s=y(i,a,t);i.possibilities&&(s.randomInfo={possibilities:i.possibilities,level:a,maxedAt:t}),r.commander=s;var o=e.deck,l=r.deck;for(var d in o){var c=y(o[d],a,t);c&&l.push(c)}var u,p,m,f,h=function(e){for(var a=0,n=0;n<e.length;n++){var t=e[n],r=k.byId(t);a+=(_(r)+1)*r.maxLevel-1}return a}(l),g=(u=a,m=h,f=7==(p=t)?(u-1)/(p-1):u/p,Math.ceil(m*f));if(1<a&&a<t)for(var v=l.slice();0<g&&0<v.length;){var b=Math.floor(Math.random()*v.length);L(v[b])?g--:v.splice(b,1)}return r}function n(e){for(var a=[],n=0,t=e.length;n<t;n++)a[n]=e[n];return a}return{mission:function(e,a){var n=MISSIONS[e];return n?s(n,a,6):0},raid:function(e,a,n){n||(n=25);var t=RAIDS[e];{if(t){var r={commander:t.commander,deck:t.deck.card};return s(r,a,Number(t.upgradeLevels))}return 0}},defaultDeck:function(){return{commander:e.defaultCommander,deck:[]}},copyCardList:n,copyDeck:function(e){var a={};return a.commander=e.commander,a.deck=n(e.deck),a},getDeckCards:function(e,a){var n={};n.commander=k.byId(e.commander),n.deck=[];for(var t=e.deck,r=SIMULATOR.battlegrounds.onCreate.filter(function(e){return!("player"===a&&e.enemy_only||"cpu"===a&&e.ally_only)}),i=0,s=t.length;i<s;i++)n.deck.push(k.byIdWithBgeApplied(t[i],r));return n}}}),define("animations",function(){var s=require("cardUI"),e={areShown:!1,drawField:function(e,a,n,t,r){var i=s.doDrawField(e,a,n,t,r);o.push(i),l||(d(),l=setInterval(d,500))},clearFrames:function(){o=[],clearInterval(l),l=null}},o=[],l=null,a=!1;function d(){if(0===o.length)a?(clearInterval(l),l=null):a=!0;else{var e=o.splice(0,1)[0];$("#cardSpace").children().remove().end().append(e),a=!1}}return e}),define("simController",function(){"use strict";var t=require("matchTimer"),n=require("debugLog"),r=require("animations"),i={getConfiguration:function(){getdeck=$("#deck1").val(),getordered=$("#ordered").is(":checked"),getexactorder=$("#exactorder").is(":checked"),getdeck2=$("#deck2").val();var e=$("#campaign").val();getmission=$("#mission").val(),missionlevel=$("#mission_level").val(),getraid=$("#raid").val(),raidlevel=$("#raid_level").val(),getordered2=$("#ordered2").is(":checked"),getexactorder2=$("#exactorder2").is(":checked"),surge=$("#surge").is(":checked"),getsiege=$("#siege").is(":checked"),tower_level=$("#tower_level").val(),tower_type=$("#tower_type").val(),BATTLEGROUNDS&&(getbattleground=getSelectedBattlegrounds(),selfbges=getSelectedBattlegrounds("self-"),enemybges=getSelectedBattlegrounds("enemy-"),mapbges=getmission?getSelectedMapBattlegrounds():"");sims_left=$("#sims").val()||1,n.enabled=$("#debug").is(":checked"),(play_debug=n.enabled&&$("#play_debug").is(":checked"))&&(n.enabled=!1);if(mass_debug=$("#mass_debug").is(":checked"),win_debug=$("#win_debug").is(":checked"),loss_debug=$("#loss_debug").is(":checked"),r.areShown=$("#animations").is(":checked"),$("#auto_mode").length){var a=$("#auto_mode").is(":checked");SIMULATOR.user_controlled=!a}return tournament=$("#tournament").is(":checked"),{getdeck:getdeck,getordered:getordered,getexactorder:getexactorder,getdeck2:getdeck2,selectedCampaign:e,getmission:getmission,missionlevel:missionlevel,getraid:getraid,raidlevel:raidlevel,getordered2:getordered2,getexactorder2:getexactorder2,surge:surge,getsiege:getsiege,tower_level:tower_level,tower_type:tower_type,getbattleground:getbattleground,selfbges:selfbges,enemybges:enemybges,mapbges:mapbges,sims_left:sims_left,play_debug:play_debug,mass_debug:mass_debug,win_debug:win_debug,loss_debug:loss_debug,auto_mode:a,tournament:tournament}},debug_end:function(e){var a,e=i.processSimResult();sims_left=0,t.stop();var n="";getdeck2&&(n=" ("+SIMULATOR.calculatePoints()+" points)");a="draw"==e?"<br><h1>DRAW"+n+"</h1><br>":e?"<br><h1>WIN"+n+"</h1><br>":"<br><h1>LOSS"+n+"</h1><br>";outputTurns(),setSimStatus(a),showUI(),SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(SIMULATOR.simulation_turns);i.end_sims_callback&&i.end_sims_callback()},end_sims_callback:null,stop_sims_callback:null};return window.SIM_CONTROLLER=i}),SKILL_DATA){var skillInfo=SKILL_DATA[skillID];"flurry"===skillID?skillInfo.type="flurry":0<=["turnStart","onAttack","onDamaged","turnEnd"].indexOf(skillInfo.type)&&(skillInfo.type="passive")}var REVERSE_FUSIONS={};for(var id in FUSIONS){var fusion=FUSIONS[id];REVERSE_FUSIONS[fusion]=id}!function(){var a=require("bgeApi"),s=require("matchTimer"),e=require("urlHelpers"),o=require("debugLog"),l=require("simController");function d(){if(SIMULATOR.user_controlled)c(!0)&&l.debug_end();else if(!o.enabled&&!play_debug||mass_debug||loss_debug||win_debug)if(0<sims_left){if(p<=u){var e=0;if(0<p){u=0;var a=games/(games+sims_left)*100;a=a.toFixed(2);var n=s.elapsed(),t=s.batchElapsed();setSimStatus("Running simulations...",n,(e=0==t?0:p/t).toFixed(1)),showWinrate()}(p=1)<e&&(p=Math.ceil(e/8)),sims_left<p&&(p=sims_left),(o.enabled||play_debug)&&(mass_debug||loss_debug||win_debug)&&(p=1),s.startBatch(),current_timeout=setTimeout(d,1);for(var r=0;r<p;r++)c()}}else{p=u=0,s.stop();n=s.elapsed();var i=games/n;i=i.toFixed(2),outp(o.getLog()),setSimStatus("Simulations complete.",n,i),showWinrate(),showUI(),l.end_sims_callback&&l.end_sims_callback()}else c(!0),l.debug_end()}l.startsim=function(){total_turns=0,s.reset(),o.clear(),p=games=0;var e=l.getConfiguration();return SIMULATOR.battlegrounds=a.getBattlegrounds(getbattleground,selfbges,enemybges,mapbges,e.selectedCampaign,missionlevel,getraid,raidlevel),hideUI(),SIMULATOR.setupDecks(),points=draws=losses=wins=0,outp(""),SIMULATOR.user_controlled?setSimStatus(""):(hideTable(),setSimStatus("Initializing simulations...")),window.ga("send","event","simulation","start","single-threaded",sims_left),current_timeout=setTimeout(d),!1},l.stopsim=function(){s.stop();var e=s.elapsed(),a=games/e;a=a.toFixed(2),SIMULATOR.simulating=!1,current_timeout&&clearTimeout(current_timeout),SIMULATOR.user_controlled||(setSimStatus("Simulations interrupted.",e,a),showWinrate()),showUI(),l.stop_sims_callback&&l.stop_sims_callback()};var n=e.paramValue("seedtest")||0;function c(e){if(n&&Math.seedrandom(n++),!SIMULATOR.simulate())return!1;e||l.processSimResult()}l.processSimResult=function(){var e;return e=!!SIMULATOR.field.player.commander.isAlive()&&(!SIMULATOR.field.cpu.commander.isAlive()||"draw"),0<p&&(0<sims_left&&sims_left--,u++),"draw"==e?draws++:e?wins++:losses++,points+=SIMULATOR.calculatePoints(),games++,total_turns+=SIMULATOR.simulation_turns,(o.enabled||play_debug)&&(loss_debug?"draw"===e?(o.prependLines("Draw found after "+games+" games. Displaying debug output...",""),o.appendLines("","<h1>DRAW</h1>"),sims_left=0):e?(o.clear(),sims_left||o.appendLines("No losses found after "+games+" games. No debug output to display.")):(o.prependLines("Loss found after "+games+" games. Displaying debug output...",""),o.appendLines("","<h1>LOSS</h1>"),sims_left=0):win_debug?e&&"draw"!==e?(o.prependLines("Win found after "+games+" games. Displaying debug output...",""),o.appendLines("","<h1>WIN</h1>"),sims_left=0):(o.clear(),sims_left||o.appendLines("No wins found after "+games+" games. No debug output to display.")):mass_debug&&(o.appendLines(""),"draw"===e?o.appendLines("<h1>DRAW</h1>"):e?o.appendLines("<h1>WIN</h1>"):o.appendLines("<h1>LOSS</h1>")),mass_debug&&sims_left&&o.appendLines("","<hr>NEW BATTLE BEGINS<hr>")),e};var u=0,p=0}();var loadDeckDialog,mapBGEDialog,SIMULATOR={};!function(){var D=require("log"),s=require("cardApi"),i=require("skillApi"),e=require("base64"),T=require("unitInfo"),n=require("loadDeck"),x=require("debugLog"),C=require("animations"),t=require("simController"),r=100;function d(e,a,n,t){var r=ne[a].assaults;if(!e.id)return 0;var i=r.length;if(T.initializeUnit(e,a,i),e.played=!0,e.isAssault()&&(r[i]=e),!x.enabled&&!play_debug||t||x.appendLines(D.name(ne[a].commander)+" plays "+D.name(e)),e.isTrap())v(e),A(e);else for(var s=0;s<ee.onCardPlayed.length;s++){var o=ee.onCardPlayed[s],l="player"===a?"cpu":"player";if(o.defender){if(!surge&&"cpu"!==a)continue;if(surge&&"player"!==a)continue;o.owner=l}else if(o.attacker){if(!surge&&"player"!==a)continue;if(surge&&"cpu"!==a)continue;o.owner=a}else{if(o.enemy_only&&"cpu"!==a)continue;if(o.ally_only&&"player"!==a)continue;o.owner=a}1<n&&o.first_play||o.onCardPlayed(e,ae[a].deck,ae[l].deck)}C.areShown&&C.drawField(ne,null,null,n)}function g(e){for(var a=ne[e].assaults,n=0,t=a.length;n<t;n++){var r=a[n];if(!r.isAlive()){x.enabled&&x.appendLines(D.name(r)+" <strong>is removed from field</strong>");var i=n;for(n++;n<t;n++)(r=a[n]).isAlive()?(a[r.key=i]=r,i++):x.enabled&&x.appendLines(D.name(r)+" <strong>is removed from field</strong>");a.length=i;break}}}function k(e){return[e[~~(Math.random()*e.length)]]}function _(e){return e.owner}function b(e){return"cpu"==e.owner?"player":"player"==e.owner?"cpu":void 0}function E(e,a,n,t,r){n>=a.health_left?a.health_left=0:a.health_left-=n,x.enabled&&r(e,a,n),t&&M(a),!a.isAlive()&&e&&B(a,e)}function M(e){var a=e.barrier_ice,n=ne[b(e)],t=n.assaults[e.key];t&&t.isAlive()||(t=n.commander),E(e,t,a,null,function(e,a,n){x.append(D.name(e)+"'s barrier shatters and hits "+D.name(a)+" for "+n+" damage"),x.appendLines(a.isAlive()?"":" and it dies")})}function c(e,a){return e[a]||o}function o(e,a){if(x.enabled){var n=SKILL_DATA[a.id]?SKILL_DATA[a.id].name:a.id;x.appendLines(D.name(e)+" attempts to use "+n+", but it is not implemented.")}return 0}function v(e){var a=e.earlyActivationSkills,n=a.length;if(n)if(e.silenced)x.enabled&&x.appendLines(D.name(e)+" is silenced and cannot use skills");else{var t=e.dualstrike_triggered;x.enabled&&t&&x.appendLines(D.name(e)+" activates dualstrike");for(var r=t?2:1,i=u(e),s=0;s<r;s++)for(var o=0;o<n&&i();o++){var l=a[o];if(!l.countdown){var d=c(f,l.id)(e,l);l.c&&0<d&&(l.countdown=l.c),C.areShown&&C.drawField(ne,null,null,oe,e)}}}}function a(){return!0}function u(e){return e.isAlive?e.isAlive.bind(e):a}function B(e,a){if(!e.ondeath_triggered){var n=e.onDeathSkills,t=n.length;if(0!=t){for(var r=0;r<t;r++){var i=n[r];w[i.id](e,a,i),C.areShown&&C.drawField(ne,null,null,oe,e)}e.ondeath_triggered=!0}}}var l=["backlash","counter","counterburn","counterpoison","armored","evade","stasis"];function y(e){return-1===l.indexOf(e)}function L(e,a){if(e.isAssault()&&a.isAlive()){var n=a.backlash;Z(e,a,"Backlash",n,T.getEnhancement(a,"backlash",n))}}function O(e){return e.isActive()&&e.isUnjammed()?0:e.stasis||0}var p={burnself:function(e,a){var n=a.x;return e.scorched?(e.scorched.amount+=n,e.scorched.timer=2):e.scorched={amount:n,timer:2},x.enabled&&x.appendLines(D.name(e)+" inflicts scorch("+n+") on itself"),1},scorchbreath:function(e,a){return p.burn(e,a)},burn:function(e,a){var n,t=b(e),r=ne[t].assaults;switch(a.id){case"scorchbreath":var i=Math.max(0,e.key-1),s=Math.min(r.length,e.key+2);n=r.slice(i,s);break;case"burnself":n=[e];break;default:n=r.slice(e.key,e.key+1)}if(!n.length)return 0;var o=a.x;o+=T.getEnhancement(e,"burn",o);for(var l=0,d=0;d<n.length;d++){var c=n[d];c.scorched?(c.scorched.amount+=o,c.scorched.timer=2):c.scorched={amount:o,timer:2},x.enabled&&x.appendLines(D.name(e)+" inflicts scorch("+o+") on "+D.name(c)),l++}return l},protect_ice:function(e,a){return p.protect(e,a,"barrier_ice")},protect_seafolk:function(e,a){return p.protect(e,a,null,null,!0)},evadebarrier:function(e,a){return p.protect(e,a,"invisible",function(e,a){return" and imbues it with invisible "+a})},protect:function(e,a,n,t,r){for(var i=a.y,s=_(e),o=a.x,l=a.all,d=ne[s].assaults,c=[],u=0,p=d.length;u<p;u++){!(h=d[u]).isAlive()||!h.isInFaction(i)||r&&h.isActive()||c.push(u)}if(!c.length)return 0;l||(c=k(c));var m=T.getEnhancement(e,a.id,o);o+=m;var f=0;for(u=0,p=c.length;u<p;u++){var h;if((h=d[c[u]]).nullified)h.nullified--,x.enabled&&x.appendLines(D.name(e)+" protects "+D.name(h)+" but it is nullified!");else{f++;var g=o;if(!g){var v=a.mult;h.isActive()||(v+=a.on_delay_mult||0),g=Math.ceil(h.health*v)}if(h.protected+=g,n&&(h[n]=(h[n]||0)+g),x.enabled){m&&x.appendLines("<u>(Enhance: +"+m+")</u>");var b=D.name(e)+" barriers "+D.name(h)+" by "+g;"function"==typeof t&&(b+=t(h,g)),x.appendLines(b)}}}return f},heal:function(e,a){for(var n=_(e),t=a.y,r=a.x,i=a.all,s=ne[n].assaults,o=[],l=0,d=s.length;l<d;l++){(p=s[l]).isAlive()&&p.isInFaction(t)&&(i||p.isDamaged())&&o.push(l)}if(!o.length)return 0;i||(o=k(o));var c=T.getEnhancement(e,a.id,r);r+=c;var u=0;for(l=0,d=o.length;l<d;l++){var p;if((p=s[o[l]]).nullified)p.nullified--,x.enabled&&x.appendLines(D.name(e)+" heals "+D.name(p)+" but it is nullified!");else{u++;var m=r;if(!m){var f=a.mult;m=Math.ceil(p.health*f)}m>p.health-p.health_left&&(m=p.health-p.health_left),p.health_left+=m,x.enabled&&(c&&x.appendLines("<u>(Enhance: +"+c+")</u>"),x.appendLines(D.name(e)+" heals "+D.name(p)+" by "+m))}}return u},poisonstrike:function(e,a,n){return p.strike(e,a,!0)},strike:function(e,t,a){for(var n=b(e),r=t.x,i=t.y,s=t.all,o=ne[n].assaults,l=[],d=0,c=o.length;d<c;d++){(m=o[d]).isAlive()&&m.isInFaction(i)&&l.push(d)}if(!l.length)return 0;s||(l=k(l));var u=T.getEnhancement(e,t.id,r);r+=u;var p=0;for(d=0,c=l.length;d<c;d++){var m;if((m=o[l[d]]).invisible)m.invisible--,x.enabled&&x.appendLines(D.name(e)+" bolts "+D.name(m)+" but it is invisible!");else{p++;var f=r,h=K(m,f);f=h.damage;var g=h.shatter,v=0;0<f&&a&&m.isAlive()&&r>m.poisoned&&(v=r,m.poisoned=v),E(e,m,f,g,function(e,a,n){x.appendLines("<u>(Strike: +"+t.x),u&&x.appendLines(" Enhance: +"+u),x.appendLines(h.echo),x.appendLines(") = "+n+" damage</u>"),x.appendLines(D.name(e)+" bolts "+D.name(a)+" for "+n+" damage"),a.isAlive()?v&&x.appendLines(" and inflicts poison("+v+") on it"):x.appendLines(" and it dies"),x.appendLines("")}),m.backlash&&L(e,m)}}return p},intensify:function(e,a,n){for(var t=b(e),r=a.x,i=a.y,s=a.all,o=ne[t].assaults,l=[],d=0,c=o.length;d<c;d++){(p=o[d]).isAlive()&&p.isInFaction(i)&&(p.scorched||p.poisoned)&&l.push(d)}if(!l.length)return 0;s||(l=k(l)),r+=T.getEnhancement(e,a.id,r);var u=0;for(d=0,c=l.length;d<c;d++){var p,m=(p=o[l[d]]).scorched?"scorch":"";m+=p.poisoned?m?" and poison":"poison":"",p.invisible?(p.invisible--,x.enabled&&x.appendLines(D.name(e)+" intensifies "+m+" on "+D.name(p)+" but it is invisible!")):(u++,p.scorched&&(p.scorched.amount+=r),p.poisoned&&(p.poisoned+=r),x.enabled&&x.appendLines(D.name(e)+" intensifies "+m+" on "+D.name(p)+" by "+r),p.backlash&&L(e,p))}return u},ignite:function(e,a,n){for(var t=b(e),r=(a.x,a.y),i=(a.all,ne[t].assaults),s=[],o=0,l=i.length;o<l;o++){var d=i[o];d.isAlive()&&d.isInFaction(r)&&s.push(o)}return m(e,a,"ignites",s,i,function(e,a){e.scorch(a)})},jamself:function(e,a){return e.jammed=!0,e.jammedSelf=!0,x.enabled&&x.appendLines(D.name(e)+" freezes itself"),1},jam:function(e,a){_(e);for(var n=b(e),t=a.all,r=ne[n].assaults,i=[],s=0,o=r.length;s<o;s++){(d=r[s]).isAlive()&&(t||d.isActiveNextTurn()&&d.isUnjammed())&&i.push(s)}if(!i.length)return 0;t||(i=k(i));var l=0;for(s=0,o=i.length;s<o;s++){var d;(d=r[i[s]]).invisible?(d.invisible--,a.countdown=0,x.enabled&&x.appendLines(D.name(e)+" freezes "+D.name(d)+" but it is invisible!")):(l++,d.jammed=!0,x.enabled&&x.appendLines(D.name(e)+" freezes "+D.name(d)),d.backlash&&L(e,d))}return l},frost:function(e,t){_(e);var a=b(e),n=t.x,r=T.getEnhancement(e,t.id,n);n+=r;t.all;for(var i=ne[a].assaults,s=[],o=e.key-1,l=o+2;o<=l;o++){(p=i[o])&&p.isAlive()&&s.push(o)}if(!s.length)return 0;for(var d=0,c=0,u=s.length;c<u;c++){var p;if((p=i[s[c]]).invisible)p.invisible--,x.enabled&&x.appendLines(D.name(e)+" breathes frost at "+D.name(p)+" but it is invisible!");else{d++;var m=n,f=K(p,m);E(e,p,m=f.damage,f.shatter,function(e,a,n){x.appendLines("<u>(Frostbreath: +"+t.x),r&&x.appendLines(" Enhance: +"+r),x.appendLines(f.echo),x.appendLines(") = "+n+" damage</u>"),x.appendLines(D.name(e)+" breathes frost at "+D.name(a)+" for "+n+" damage"),x.appendLines(a.isAlive()?"":" and it dies")}),p.backlash&&L(e,p)}}return d},heartseeker:function(e,a){var n=b(e),t=a.x,r=ne[n].assaults[e.key];return r?(t+=T.getEnhancement(e,a.id,t),r.heartseeker+=t,r.enfeebled+=t,x.enabled&&x.appendLines(D.name(e)+" inflicts heartseeker "+t+" on "+D.name(r)),1):0},enfeeble:function(e,a){for(var n=a.y,t=b(e),r=ne[t].assaults,i=[],s=0,o=r.length;s<o;s++){var l=r[s];l.isAlive()&&l.isInFaction(n)&&i.push(s)}return m(e,a,"hexes",i,r,function(e,a){e.enfeebled+=a})},weakenself:function(e,a){return p.weaken(e,a)},weaken:function(e,a){var n,r=a.y;switch(a.id){case"weakenself":n=_(e);break;default:n=b(e)}var i=a.all,s=ne[n].assaults,o=[],t=function(e){for(var a=0,n=s.length;a<n;a++){var t=s[a];t.isAlive()&&t.isInFaction(r)&&(i||t.isActiveNextTurn()&&t.isUnjammed()&&(e||t.hasAttack()))&&o.push(a)}};t(!1),o.length||t(!0);return m(e,a,"weakens",o,s,function(e,a){e.attack_weaken+=a})}};function m(e,a,n,t,r,i){if(!t.length)return 0;var s=T.getEnhancement(e,a.id,a.x),o=a.x+s;a.all||(t=k(t));for(var l=0,d=0,c=t.length;d<c;d++){var u=r[t[d]];u.invisible?(u.invisible--,x.enabled&&x.appendLines(D.name(e)+" "+n+" "+D.name(u)+" but it is invisible!")):(l++,i(u,o),x.enabled&&(s&&x.appendLines("<u>(Enhance: +"+s+")</u>"),x.appendLines(D.name(e)+" "+n+" "+D.name(u)+" by "+o)),u.backlash&&L(e,u))}return l}var f={enlarge:function(e,a){var n=a.y,t=_(e),r=a.x,i=T.getEnhancement(e,a.id,r);r+=i;for(var s=a.all,o=ne[t].assaults,l=[],d=0,c=o.length;d<c;d++){(p=o[d]).isAlive()&&p.isInFaction(n)&&(s||p.isUnjammed()&&p.isActive())&&l.push(d)}if(!l.length)return 0;s||(l=k(l));var u=0;for(d=0,c=l.length;d<c;d++){var p=o[l[d]],m=r;if(!m){var f=a.mult;m=Math.ceil(p.attack*f)}p.attack_rally+=m,x.enabled&&(i&&x.appendLines("<u>(Enhance: +"+i+")</u>"),x.appendLines(D.name(e)+" enlarges "+D.name(p)+" by "+m)),u++}return u},rally:function(e,a){for(var n=a.y,t=_(e),r=a.x,i=a.all,s=ne[t].assaults,o=[],l=0,d=s.length;l<d;l++){(p=s[l]).isAlive()&&p.isInFaction(n)&&(i||p.isActive()&&p.isUnjammed())&&o.push(l)}if(!o.length)return 0;i||(o=k(o));var c=T.getEnhancement(e,a.id,r);r+=c;var u=0;for(l=0,d=o.length;l<d;l++){var p;if((p=s[o[l]]).nullified)p.nullified--,x.enabled&&x.appendLines(D.name(e)+" empowers "+D.name(p)+" but it is nullified!");else{u++;var m=r;if(!m){var f=a.mult;m=Math.ceil(p.attack*f)}p.attack_rally+=m,x.enabled&&(c&&x.appendLines("<u>(Enhance: +"+c+")</u>"),x.appendLines(D.name(e)+" empowers "+D.name(p)+" by "+m))}}return u},legion:function(e,a){var n=_(e),t=ne[n].assaults,r=a.x,i=T.getEnhancement(e,a.id,r);r+=i;var s=a.y,o=e.key-1,l=o+2;o<0&&(o+=2);for(var d=0;o<=l;){var c=t[o];c&&c.isActive()&&c.isInFaction(s)&&(c.nullified?(c.nullified--,x.enabled&&x.appendLines(D.name(e)+" activates legion and empowers "+D.name(c)+" but it is nullified!")):(d++,c.attack_rally+=r,x.enabled&&(i&&x.appendLines("<u>(Enhance: +"+i+")</u>"),x.appendLines(D.name(e)+" activates legion and empowers "+D.name(c)+" by "+r)))),o+=2}return d},fervor:function(e,a){var n=_(e),t=ne[n].assaults,r=a.x,i=T.getEnhancement(e,a.id,r);r+=i;var s=a.y,o=0,l=e.key-1,d=l+2;for(l<0&&(l+=2);l<=d;){var c=t[l];c&&c.isInFaction(s)&&(o+=r),l+=2}return o?(e.attack_rally+=o,x.enabled&&(i&&x.appendLines("<u>(Enhance: +"+i+")</u>"),x.appendLines(D.name(e)+" activates fervor for "+o)),1):0},barrage:function(e,a){var n=b(e),t=a.x,r=a.y,i=a.all,s=ne[n].assaults;t+=T.getEnhancement(e,a.id,t);for(var o=0;o<t;o++){for(var l=[],d=0,c=s.length;d<c;d++){(p=s[d]).isAlive()&&p.isInFaction(r)&&l.push(d)}if(!l.length)return 0;i||(l=k(l));var u=0;for(d=0,c=l.length;d<c;d++){var p;if((p=s[l[d]]).invisible)p.invisible--,x.enabled&&x.appendLines(D.name(e)+" throws a bomb at "+D.name(p)+" but it is invisible!");else{u++;var m=1,f=K(p,m,{enfeeble:!0});E(e,p,m=f.damage,f.shatter,function(e,a,n){x.appendLines("<u>(Barrage: +1"),x.appendLines(f.echo),x.appendLines(") = "+n+" damage</u>"),x.appendLines(D.name(e)+" throws a bomb at "+D.name(a)+" for "+n+" damage"),x.appendLines(a.isAlive()?"":" and it dies")})}}}return u},enhance:function(e,a){for(var n=a.y,t=_(e),r=(b(e),a.x),i=(n=a.y,a.s),s=a.mult,o=a.all,l=ne[t].assaults,d=y(i),c=[],u=0,p=l.length;u<p;u++){(f=l[u]).isAlive()&&f.isInFaction(n)&&(o||!d||f.isActive()&&f.isUnjammed())&&f.hasSkill(i)&&c.push(u)}if(!c.length)return 0;o||(c=k(c));var m=0;for(u=0,p=c.length;u<p;u++){var f;if((f=l[c[u]]).nullified)f.nullified--,x.enabled&&x.appendLines(D.name(e)+" enhances "+D.name(f)+" but it is nullified!");else{m++;var h=f.enhanced;0<r?(h[i]=(h[i]||0)+r,x.enabled&&x.appendLines(D.name(e)+" enhances "+i+" of "+D.name(f,!1)+" by "+r)):0<s&&(h[i]=-s,x.enabled&&x.appendLines(D.name(e)+" enhances "+i+" of "+D.name(f,!1)+" by "+100*s+"%"))}}return m},enrage:function(e,a){for(var n=_(e),t=a.y,r=a.x,i=a.all,s=ne[n].assaults,o=[],l=0,d=s.length;l<d;l++){(p=s[l]).isAlive()&&p.isInFaction(t)&&o.push(l)}if(!o.length)return 0;i||(o=k(o));var c=T.getEnhancement(e,a.id,r);r+=c;var u=0;for(l=0,d=o.length;l<d;l++){var p,m=r;(p=s[o[l]]).nullified?(p.nullified--,x.enabled&&x.appendLines(D.name(e)+" enrages "+D.name(p)+" but it is nullified!")):(u++,a.mult&&(m=Math.ceil(a.mult*p.health)),p.enraged+=m,x.enabled&&(c&&x.appendLines("<u>(Enhance: +"+c+")</u>"),x.appendLines(D.name(e)+" enrages "+D.name(p)+" by "+m)))}return u},imbue:function(e,a){for(var n=a.y,t=_(e),r=(b(e),a.x),i=(a.c,a.s),s=a.all,o=ne[t].assaults,l=y(i),d=[],c=0,u=o.length;c<u;c++){(m=o[c]).isAlive()&&m.isInFaction(n)&&(s||!l||m.isActive()&&m.isUnjammed())&&d.push(c)}if(!d.length)return 0;a={id:i,x:r};s||(d=k(d));var p=0;for(c=0,u=d.length;c<u;c++){var m;if((m=o[d[c]]).nullified)m.nullified--,x.enabled&&x.appendLines(D.name(e)+" enhances "+D.name(m)+" but it is nullified!");else if(p++,m.hasSkill(i)){var f=m.enhanced;f[i]=(f[i]||0)+r,x.enabled&&x.appendLines(D.name(e)+" imbues "+D.name(m,!1)+" existing "+D.skill(a)+" by "+r)}else m.imbue(a),x.enabled&&x.appendLines(D.name(e)+" imbues "+D.name(m,!1)+" with "+D.skill(a))}return p},mark:function(e,a){for(var n=a.y,t=(_(e),b(e)),r=a.x,i=a.all,s=ne[t].assaults,o=e.mark_target,l=[],d=0,c=s.length;d<c;d++){if((p=s[d]).isAlive()&&p.isInFaction(n)){if(p.uid===o){l=[d];break}l.push(d)}}if(!l.length)return 0;i||(l=k(l)),r+=T.getEnhancement(e,a.id,r);var u=0;for(d=0,c=l.length;d<c;d++){var p;u++,(p=s[l[d]]).enfeebled+=r,e.mark_target=p.uid,x.enabled&&x.appendLines(D.name(e)+" marks "+D.name(p)+" by "+r),a.countdown=1}return u}},h={ambush:function(e,a,n){var t=n.x,r=n.base,i=n.mult,s=t;if(!s){i=n.mult;s=Math.ceil(a[r]*i)}return E(e,a,s,null,function(e,a,n){x.appendLines(D.name(e)+" ambushes "+D.name(a)+" for "+n+" damage"),x.appendLines(a.isAlive()?"":" and it dies")}),1},slow:function(e,a,n){var t=n.x,r=n.base,i=n.mult,s=t;if(!s){i=n.mult;s=Math.ceil(a[r]*i)}return a.timer+=s,x.enabled&&x.appendLines(D.name(e)+" slows "+D.name(a)+" by "+s),1}},w={unearth:function(e,a,n){if(!e.isToken){var t=T.create(n.card||e.id,n.level||n.x),r=s.byIdWithBgeApplied(t,null,!0);r.isToken=!0;var i=n.mult;return i&&(r.attack=Math.floor(e.attack*i),r.health=Math.floor(e.health*i)),d(r,e.owner,!0),x.enabled&&x.appendLines(D.name(r)+" is unearthed</br>"),1}},reanimate:function(e,a,n){return e.reanimated?0:(e.health_left=n.x,e.reanimated=!0,x.enabled&&x.appendLines(" and is reanimated</br>"),1)}};function A(e){if(e.silenced)x.enabled&&x.appendLines(D.name(e)+" is silenced and cannot use skills</br>");else for(var a=e.skill,n=u(e),t=0,r=a.length;t<r&&n();t++){var i=a[t];if(!i.countdown){var s=c(p,i.id)(e,i);i.c&&0<s&&(i.countdown=i.c),C.areShown&&C.drawField(ne,null,null,oe,e)}}}function S(e){var a,n,t,r=e.length;if(0==r)return!1;for(;--r;)a=~~(Math.random()*(r+1)),n=e[r],t=e[a],e[r]=t,e[a]=n}function $(){cache_player_deck=getdeck?e.decodeHash(getdeck):n.defaultDeck(),cache_player_deck_cards=n.getDeckCards(cache_player_deck,"player"),pvpAI=!0,getdeck2?(cache_cpu_deck=e.decodeHash(getdeck2),getmission&&(pvpAI=!1)):getmission?(cache_cpu_deck=n.mission(getmission,missionlevel),pvpAI=!1):getraid?(cache_cpu_deck=n.raid(getraid,raidlevel),pvpAI=!1):cache_cpu_deck=n.defaultDeck(),cache_cpu_deck_cards=n.getDeckCards(cache_cpu_deck,"cpu")}function I(l){var d=l.uids={};["player","cpu"].forEach(function(e){for(var a=ae[e],n=a.deck,t="player"===e?1:101,r=0;r<n.length;r++){var i=t+r,s=n[r];s.owner=e,s.played=!1,s.uid=i,d[i]=s}var o=a.commander;o.owner=e,o.health_left=o.health,o.reusableSkills||o.resetTimers();i="player"===e?-1:-2;o.uid=i,d[i]=o,l[e].commander=o})}function U(e,a){C.clearFrames(),N(e,a)}function N(e,a){if(SIMULATOR.pause)return SIMULATOR.pause=!1;var n=function(e,a){var n,t;t=surge?(n="cpu","player"):(n="player","cpu");if(0<e){if(se&&(!ne.player.commander.isAlive()||!ne.cpu.commander.isAlive()))return!(re=!1);if(!P(e,ne,n,t,a))return!1;if(!ne.player.commander.isAlive()||!ne.cpu.commander.isAlive())return!(re=!1)}else!surge&&SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(e);for(e++;e<=r+1;e++){if(e===r+1)return!(re=!1);F(e,n,t,ne);if(!P(e,ne,n,t,!0))return!1;if(!ne.player.commander.isAlive()||!ne.cpu.commander.isAlive())return re=!1,x.enabled&&x.appendLines("<u>Turn "+e+" ends</u><br><br></div>"),!0}return!(re=!1)}(e,a);return n&&ie&&t.debug_end(),n}function P(e,a,n,t,r){if(e%2)var i=n,s=t;else i=t,s=n;return closeDiv=!1,!!function(e,a,n){var t=ae[e],r=t.deck,i=t.ordered;{if(se&&"cpu"===e&&n)return H(e,r,i,a,n),!1;if(r[0]){SIMULATOR.waiting=!1;var s=0;if(1==r.length)s=0;else{for(var o=0;o<r.length;o++){var l=r[o];if(l.trap&&(d(l.trap,e,a),l.trap=!1),2===o)break}s=t.chooseCard(e,r,i,a,n)}if(s<0)return!1;d(r[s],e,a),function(e,a){var n=a,t=e.length-1;for(;n<t;)e[n]=e[++n];e.length=n}(r,s)}}return!0}(i,e,r)&&(function(e,a,n,t){for(var r=n[e],i=r.commander,s=r.assaults,o=n[a],l=o.commander,d=o.assaults,c=0;c<ee.onTurn.length;c++){var u=ee.onTurn[c];u.enemy_only&&"cpu"!==e||(u.ally_only&&"player"!==e||(u.owner=e,v(u),A(u)))}v(r.commander);for(var p=0,m=s.length;p<m;p++){var f=s[p];z(f,"evade","invisible"),z(f,"absorb","warded")}(function(e){for(var a=e.assaults,n=0,t=a.length;n<t;n++){var r=a[n];if(r.isAlive()&&r.isActive()&&r.isUnjammed()){var i=r.flurry;i&&0===i.countdown&&r.hasAttack()&&(i.countdown=i.c,r.dualstrike_triggered=!0),v(r)}}})(r),A(i);for(var p=0,m=s.length;p<m;p++){var f=s[p];if(f.isAlive()&&f.isActive())if(f.jammed)x.enabled&&x.appendLines(D.name(f)+" is frozen and cannot attack");else{var h=1;for(f.dualstrike_triggered&&(h++,x.enabled&&x.appendLines(D.name(f)+" activates dualstrike"));0<h;h--)if(A(f),f.isAlive())if(f.hasAttack()){if(X(f,d,l),!l.isAlive()||!i.isAlive())return;if(!f.isAlive())break}else x.enabled&&0<f.permanentAttack()&&x.appendLines(D.name(f)+" is weakened and cannot attack")}}(function(e){for(var a=0,n=e.length;a<n;a++){var t=e[a];if(t.jammedSelf?t.jammedSelf=!1:t.jammed=!1,t.attack_rally=0,t.attack_weaken=0,t.nullified=0,t.dualstrike_triggered=!1,t.silenced=!1,t.regenerate&&t.isDamaged()){var r=t.regenerate,i=T.getEnhancement(t,"regenerate",r);r+=i;var s=t.health-t.health_left;s<=r&&(r=s),t.health_left+=r,x.enabled&&x.appendLines(D.name(t)+" regenerates "+r+" health")}var o=t.poisoned;if(o){var l=t.warded;l&&(o-=J(t,"warded",o)),E(null,t,o,null,function(e,a,n){x.appendLines(D.name(a)+" takes "+n),l&&x.appendLines(" (Poison: +"+t.poisoned+" Ward: -"+l+")"),x.appendLines(" poison damage"),x.appendLines(a.isAlive()?"":" and it dies")})}var o=t.envenomed;if(o){var l=t.warded;l&&(o-=J(t,"warded",o)),E(null,t,o,null,function(e,a,n){x.appendLines(D.name(a)+" takes "+n),l&&x.appendLines(" (Venom: +"+t.envenomed+" Ward: -"+l+")"),x.appendLines(" venom damage"),x.appendLines(a.isAlive()?"":" and it dies")})}var d=t.scorched;if(d){o=d.amount;var l=t.warded;l&&(o-=J(t,"warded",o)),E(null,t,o,null,function(e,a,n){x.appendLines(D.name(a)+" takes "+n),l&&x.appendLines(" (Scorch: +"+d.amount+" Ward: -"+l+")"),x.appendLines(" scorch damage"),a.isAlive()?a.scorched||x.appendLines(" and scorch wears off"):x.appendLines(" and it dies"),x.appendLines("")}),1<d.timer?d.timer--:t.scorched=0}var c=t.corroded;if(c)if(c.timer--,c.timer<0)t.corroded=!1,t.attack_corroded=0,x.enabled&&x.appendLines(D.name(t)+" recovers from corrosion");else{var u=c.amount;t.attack_corroded=u,x.enabled&&x.appendLines(D.name(t)+" loses "+u+" attack to corrosion")}t.isAlive()||B(t,null)}})(s),g("player"),g("cpu"),x.enabled&&x.appendLines("<u>Turn "+t+" ends</u><br><br></div>")}(i,s,a,e),!0)}function R(e,a,n){var t=a[n];return t?e+" draws "+D.name(t,!0)+"<br/>":""}function F(e,a,n,t){if(choice=void 0,(te=e)%2)var r=a,i=n;else r=n,i=a;if(x.enabled){var s=D.name(t[r].commander),o=ae[r].deck;x.appendLines('<div id="turn_"'+e+' class="turn-info"><hr/><br/><u>Turn '+e+" begins for "+s+"</u>"),e<=2&&(x.appendLines(R(s,o,0)),x.appendLines(R(s,o,1))),x.appendLines(R(s,o,2))}var l=t[r],d=t[i],c=l.assaults,u=d.assaults;Q(l.commander);for(var p=0,m=c.length;p<m;p++){var f=c[p];if(0<f.timer&&(3===e&&tournament||(f.timer--,x.enabled&&x.appendLines(D.name(f)+" reduces its timer"))),f.valor){var h=u[p];h&&f.adjustedAttack()<h.adjustedAttack()?(f.attack_valor+=f.valor,x.enabled&&x.appendLines(D.name(f)+" activates valor, boosting its attack by "+f.valor)):x.enabled&&(x.appendLines(D.name(f)+" activates valor but "),h?x.appendLines("enemy is not strong enough."):x.appendLines("there is no opposing enemy."))}f.enfeebled=f.envenomed+f.heartseeker,f.enraged=0,f.invisible=0,f.protected=0,f.barrier_ice=0,f.warded=0,f.enhanced={},f.removeImbue(),Q(f)}}function H(e,a,n,t,r){return SIMULATOR.waiting=!0,closeDiv=!0,r&&(hideTable(),outputTurns(),C.drawField(ne,null,N,t),SIMULATOR.sendBattleUpdate(t)),-1}function q(e,a,n,t,r){var i=a.slice(0,3);closeDiv=!0;for(var s=[],o=[],l=0,d=i.length;l<d;l++){var c=i[l],u=l+": "+c.name;1<c.maxLevel&&(u+="{"+c.level+"/"+c.maxLevel+"}"),s.push(u),o.push(c)}if(r&&(hideTable(),outputTurns(),C.drawField(ne,o,U,t)),void 0===choice)return-1;var p=choice;return p||(p=0),p}function V(e,a,n,t,r){if(void 0===n)return 0;for(var i=a.slice(0,3),s=!1,o=0,l=n.length;o<l;o++){for(var d,c=n[o],u=c.priority,p=-1,m=0,f=i.length;m<f;m++){var h=(d=i[m]).priority;if(T.areEqual(c,d)){s=!0;break}0<u&&u==h&&(p=m)}if(!s&&0<=p&&(s=!0,d=i[m=p]),s){for(var g=n.length-1;o<g;o++)n[o]=n[o+1];return n.length=o,m}}return-1}function j(e,a,n,t,r){var i=a.slice(0,3);return~~(Math.random()*i.length)}function W(e,a,n,t,r){for(var i,s,o,l,d,c=a.slice(0,3),u=-1,p=-1,m=0;m<c.length;m++){var f=c[m],h=(void 0,s=(i=f).id.toString(),o=6*parseInt(i.rarity),l=3*(4<s.length?parseInt(s[0]):0),d=parseInt(i.level)-parseInt(i.maxLevel),o+l+d);p<h&&(p=h,u=m)}return u}function G(e,a,n,t,r){return 0}function z(e,a,n){var t=0;e[a]&&(t=e[a],t+=T.getEnhancement(e,a,t));e[n]=t}function K(e,a,n){var t=(n=n||{}).enfeeble?0:e.enfeebled||0,r=n.stasis?0:O(e),i=n.protect?0:e.protected||0,s=n.ward?0:e.warded||0;a+=t-r;var o=!1;s&&(a-=J(e,"warded",a)),i&&(a-=J(e,"protected",a),0==e.protected&&(o=e.barrier_ice)),r&&(a-=r);return x.enabled&&(t&&x.appendLines(" Enfeeble: +"+t),r&&x.appendLines(" Stasis: -"+r),i&&x.appendLines(" Barrier: -"+i),s&&x.appendLines(" Ward: -"+s)),a<0&&(a=0),{damage:a,shatter:o,echo:""}}function J(e,a,n){var t=e[a];return t<=n?(e[a]=0,t):(e[a]-=n,n)}function Q(e){Y(e,e.skill),Y(e,e.earlyActivationSkills);var a=e.flurry;a&&a.countdown&&(a.countdown--,x.enabled&&(a.countdown?x.appendLines(D.name(e)+" charges  dualstrike (ready in "+a.countdown+" turns)"):x.appendLines(D.name(e)+" readies dualstrike")))}function Y(e,a){for(var n=0,t=a.length;n<t;n++){var r=a[n];r.countdown&&(r.countdown--,x.enabled&&(r.countdown?x.appendLines(D.name(e)+" charges "+i.nameFromId(r.id)+" (ready in "+r.countdown+" turns)"):x.appendLines(D.name(e)+" readies "+i.nameFromId(r.id))))}}function X(e,a,n){var t=a[e.key];if(t&&t.isAlive()){var r,i=!1;if(!t.taunt)if((r=a[e.key-1])&&r.taunt)t=r,i=!0;else(r=a[e.key+1])&&r.taunt&&(t=r,i=!0);i&&x.enabled&&x.appendLines(D.name(t)+" taunts "+D.name(e))}else t=n;var s=e.adjustedAttack(),o=t.enfeebled;s+=o,x.enabled&&(x.appendLines("<u>(Attack: +"+e.attack),e.attack_berserk&&x.appendLines(" Berserk: +"+e.attack_berserk),e.attack_valor&&x.appendLines(" Valor: +"+e.attack_valor),e.attack_rally&&x.appendLines(" Rally: +"+e.attack_rally),e.attack_weaken&&x.appendLines(" Weaken: -"+e.attack_weaken),e.attack_corroded&&x.appendLines(" Corrosion: -"+e.attack_corroded),o&&x.appendLines(" Enfeeble: +"+o));var l=e.pierce;l?l+=T.getEnhancement(e,"pierce",l):l=0;var d=t.protected,c=!1,u=t.armored,p=O(t);if(d&&(x.enabled&&x.appendLines(" Barrier: -"+d),l&&(d<=l?(x.enabled&&x.appendLines(" Pierce: +"+d),l-=d,d=0,t.protected=0):(x.enabled&&x.appendLines(" Pierce: +"+l),d-=l,t.protected-=l,l=0)),d&&(d<=s?(c=t.barrier_ice,s-=d,t.protected=0):(t.protected-=s,s=0))),p&&(p+=T.getEnhancement(t,"stasis",p),x.enabled&&x.appendLines(" Shroud: -"+p),l&&(p<l?(x.enabled&&x.appendLines(" Pierce: +"+p),p=0):(x.enabled&&x.appendLines(" Pierce: +"+l),p-=l)),s-=p),u&&(u+=T.getEnhancement(t,"armored",u),x.enabled&&x.appendLines(" Armor: -"+u),l&&(u<l?(x.enabled&&x.appendLines(" Pierce: +"+u),u=0):(x.enabled&&x.appendLines(" Pierce: +"+l),u-=l)),s-=u),s<0&&(s=0),x.enabled&&x.appendLines(") = "+s+" damage</u>"),E(e,t,s,null,function(e,a,n){x.appendLines(D.name(e)+" attacks "+D.name(a)+" for "+n+" damage"),x.appendLines(a.isAlive()?"":" and it dies")}),C.areShown&&C.drawField(ne,null,null,oe,e),n.isAlive()){if(0<s&&t.isAssault()&&t.isAlive()){if(e.poison){var m=e.poison;(m+=T.getEnhancement(e,"poison",m))>t.poisoned&&(t.poisoned=m,x.enabled&&x.appendLines(D.name(e)+" inflicts poison("+m+") on "+D.name(t)))}if(e.venom){var f=e.venom;if((f+=T.getEnhancement(e,"venom",f))>t.envenomed){var h=f-t.envenomed;t.envenomed=f,t.enfeebled+=h,x.enabled&&x.appendLines(D.name(e)+" inflicts venom("+f+") on "+D.name(t))}}if(e.nullify){var g=e.nullify;g+=T.getEnhancement(e,"nullify",g),t.nullified+=g,x.enabled&&x.appendLines(D.name(e)+" inflicts nullify("+g+") on "+D.name(t))}if(e.silence&&(t.silenced=!0,x.enabled&&x.appendLines(D.name(e)+" inflicts silence on "+D.name(t))),e.daze){var v=e.daze;v+=T.getEnhancement(e,"daze",v),t.attack_weaken+=v,x.enabled&&x.appendLines(D.name(e)+" dazed "+D.name(t)+" for "+v)}}if(c&&M(t),0<s&&e.isAlive()){if(e.leech&&e.isDamaged()){var b=e.leech;b+=T.getEnhancement(e,"leech",b);var k=e.health-e.health_left;k<=b&&(b=k),e.health_left+=b,x.enabled&&x.appendLines(D.name(e)+" siphons "+b+" health")}if(e.reinforce){var _=e.reinforce;_+=T.getEnhancement(e,"reinforce",_),e.protected+=_,x.enabled&&x.appendLines(D.name(e)+" reinforces itself with barrier "+_)}if(t.counter){var y=0+t.counter;Z(e,t,"Vengance",y,T.getEnhancement(t,"counter",y))}if(t.counterburn){var L=t.counterburn||0;L+=T.getEnhancement(t,"counterburn",L),e.scorched?(e.scorched.amount+=L,e.scorched.timer=2):e.scorched={amount:L,timer:2},x.enabled&&x.appendLines(D.name(t)+" inflicts counterburn("+L+") on "+D.name(e))}if(t.counterpoison){m=t.counterpoison||0;(m+=T.getEnhancement(t,"counterpoison",m))>e.poisoned&&(e.poisoned=m,x.enabled&&x.appendLines(D.name(t)+" inflicts counterpoison("+m+") on "+D.name(e)))}if(t.fury){var w=t.fury,A=T.getEnhancement(t,"counter",w);if(t.isAlive()){var S=w+A;t.attack_berserk+=S,x.enabled&&x.appendLines(D.name(t)+" activates fury and gains "+S+" attack")}Z(e,t,"Fury",w,A)}if(0<t.enraged&&(t.attack_berserk+=t.enraged,x.enabled&&x.appendLines(D.name(t)+" is enraged and gains "+t.enraged+" attack!</br>")),e.berserk){var $=e.berserk;$+=T.getEnhancement(e,"berserk",$),e.attack_berserk+=$,x.enabled&&x.appendLines(D.name(e)+" activates berserk and gains "+$+" attack")}}if(t.corrosive){var I=t.corrosive||0;I+=T.getEnhancement(t,"corrosive",I),e.corroded?(e.corroded.amount+=I,e.corroded.timer=2):e.corroded={amount:I,timer:2},x.enabled&&x.appendLines(D.name(t)+" inflicts corrosion("+I+") on "+D.name(e)),e.attack_corroded=I,x.enabled&&x.appendLines(D.name(e)+" loses "+I+" attack to corrosion")}e.isAlive()||B(e,t),C.areShown&&C.drawField(ne,null,null,oe,e)}}function Z(e,a,t,n,r){var i=n+r,s=K(e,i,{enfeeble:!0});i=s.damage;s.shatter;x.enabled&&(x.appendLines("<u>("+t+": +"+n),r&&x.appendLines(" Enhance: +"+r),x.appendLines(s.echo),x.appendLines(") = "+i+" damage</u>")),E(a,e,i,null,function(e,a,n){x.appendLines(D.name(a)+" takes "+n+" "+t.toLowerCase()+" damage"),x.appendLines(a.isAlive()?"":" and it dies")})}SIMULATOR.pause=!1,SIMULATOR.performTurns=N,SIMULATOR.waitForOpponent=H;var ee,ae={},ne={},te=0,re=!1,ie=!1,se=!1,oe=0,le=0,de=0;SIMULATOR.simulate=function(){if(re=!0,function(){SIMULATOR.simulation_turns=0;var e={cpu:{deck:[]},player:{deck:[]}};SIMULATOR.deck=e,SIMULATOR.field={cpu:{assaults:[]},player:{assaults:[]}},cache_player_deck_cards&&(e.player=n.copyDeck(cache_player_deck_cards)),getmission&&1<missionlevel&&missionlevel<7?(cache_cpu_deck=n.mission(getmission,missionlevel),cache_cpu_deck_cards=n.getDeckCards(cache_cpu_deck,"cpu")):getraid&&(cache_cpu_deck=n.raid(getraid,raidlevel),cache_cpu_deck_cards=n.getDeckCards(cache_cpu_deck,"cpu")),cache_cpu_deck_cards&&(e.cpu=n.copyDeck(cache_cpu_deck_cards)),getordered&&!getexactorder&&(e.player.ordered=n.copyCardList(e.player.deck)),getordered2&&!getexactorder2&&(e.cpu.ordered=n.copyCardList(e.cpu.deck)),e.player.chooseCard=ie?q:getordered?V:j,e.cpu.chooseCard=getordered2?V:pvpAI?W:getexactorder2?j:G}(),getexactorder?getordered||(ae.player.shuffleHand=!0):S(ae.player.deck),getexactorder2?getordered2||(ae.cpu.shuffleHand=!0):S(ae.cpu.deck),I(ne),getsiege){var e=BATTLEGROUNDS[tower_type].effect[tower_level];if(e){e=T.create(e.id,e.level);var a=s.byIdWithBgeApplied(e);a.uid=150,d(ne.uids[150]=a,"cpu",-1,!0)}}return N(0)},SIMULATOR.onPlaySkills=h,SIMULATOR.calculatePoints=function(e){var a=ne.uids,n={player:{total:0,taken:0},cpu:{total:0,taken:0}};for(var t in a){var r=a[t],i=n[r.owner];i&&(i.total+=r.health,(r.played||r.isCommander())&&(i.taken+=r.health-r.health_left))}n.player.percent=i.taken/i.total,n.cpu.percent=i.taken/i.total;var s=ne.cpu.commander;if(getdeck2)if(s.isAlive()&&!e)var o=Math.floor(25*n.cpu.percent);else o=130-Math.floor(15*n.player.percent);else o=s.isAlive()&&!e?(o=Math.floor(n.cpu.percent/.02),Math.max(5,o)):200-Math.floor(n.player.percent/.02);return o},Object.defineProperties(SIMULATOR,{setupDecks:{get:function(){return $},set:function(e){$=e}},setupField:{get:function(){return I},set:function(e){I=e}},deck:{get:function(){return ae},set:function(e){ae=e}},field:{get:function(){return ne},set:function(e){ne=e}},battlegrounds:{get:function(){return ee},set:function(e){ee=e}},simulation_turns:{get:function(){return te},set:function(e){te=e}},simulating:{get:function(){return re},set:function(e){re=e}},totalDeckHealth:{get:function(){return le},set:function(e){le=e}},totalCpuDeckHealth:{get:function(){return de},set:function(e){de=e}},user_controlled:{get:function(){return ie},set:function(e){ie=e}},livePvP:{get:function(){return se},set:function(e){se=e}}})}(),function(e){"use strict";var a=function(e,a,n){return e.filter(function(e){return e[n]==a})},n=function(e,a,n,t,r){var i=n.filter(function(e){return e.id==a})[0];if(i){var s=i[t];return e.filter(function(e){var a=e[r];return 0<=s.indexOf(a)})}return[]};e.module("core",[]).filter("forMissions",function(){return function(e,a){if(!e||!a)return e;for(var n=[],t=0,r=e.length;t<r;t++){for(var i=e[t],s=i.missions,o=!0,l=0;l<s.length;l++){if(!a[s[l]]){o=!1;break}}o&&n.push(i)}return n}}).filter("filterByParent",function(){return a}).filter("filterChildren",function(){return n}),e.module("simulatorApp",["core"]).controller("SimulatorCtrl",["$scope","$window",function(r,e){function a(e){var a=Object.keys(e);a.sort(function(e,a){return Number(e)-Number(a)});for(var n=[],t=0;t<a.length;t++){var r=a[t],i=e[r];n.push(i)}return n}function n(e){var a=[];for(var n in e)a.push(e[n]);return a}r.locations=[],r.campaigns=[],r.missions=e.TITANS,r.raids=e.RAIDS,r.battlegrounds=e.BATTLEGROUNDS,r.mapBattlegrounds=n(e.MAP_BATTLEGROUNDS),r.campaignBGEs=[],r.tower=!1,r.auto=!1,r.debugMode=!1,r.selections={location:"",campaign:"",mission:"",raid:""},r.titans=function(){r.campaigns=n(e.CAMPAIGNS),r.missions=e.TITANS},r.campaignSections=function(){r.locations=a(e.LOCATIONS).sort(function(e,a){return Number(e.id)-Number(a.id)}),r.missions=a(e.MISSIONS),r.campaigns=a(e.CAMPAIGNS)},r.filteredRaids=function(){var a={};return n(r.raids).sort(function(e,a){return Number(a.id)-Number(e.id)}).forEach(function(e){a[e.name]||(a[e.name]=e)}),n(a).sort(function(e,a){return Number(e.id)-Number(a.id)})},r.getLocationClass=function(e){if(!e){var a=r.selections.location;e=r.locations.filter(function(e){return e.id==a})[0]}if(e){var n=Number(e.id);return 0===n?"heroUpgrade":100<=n?"event":"black"}return"grey"},r.getCampaignClass=function(e){if(!e){var a=r.selections.campaign;e=r.campaigns.filter(function(e){return e.id==a})[0]}return e?e.side_mission?0==e.location_id?"heroUpgrade":"mythic":e.isLocation?"location":"black":"grey"},r.$watch("selections.location",function(e,a){r.selections.campaign=""}),r.$watch("selections.campaign",function(e,a){r.selections.mission=""}),r.towerTypes=["Castle Tower","Cannon Tower","Tree of Life"],r.selectableBattlegrounds=function(){var e=[];for(var a in r.battlegrounds){var n=r.battlegrounds[a];n.hidden||n.isTower||e.push(n)}return e.sort(function(e,a){return e.id-a.id}),e},r.personalBattlegrounds=function(){var e=[];for(var a in r.battlegrounds){var n=r.battlegrounds[a],t=Number(n.id);1e3<t&&t<2e3&&e.push(n)}return e.sort(function(e,a){return e.id-a.id}),e},r.towerTypes=function(){var e=[];for(var a in r.battlegrounds){var n=r.battlegrounds[a];n.isTower&&e.push(n)}return e.sort(function(e,a){return e.id-a.id}),e},r.$watch("debugMode",function(e,a){})}])}(angular),function(a){"use strict";var n,t=require("storageAPI");try{n=a.module("simulatorApp")}catch(e){n=a.module("simulatorApp",[])}n.controller("DeckStorageCtrl",["$scope","$window",function(e,a){e.getSavedDecks=t.getSavedDecks,e.keys=function(e){return e?Object.keys(e):[]}}])}(angular);var bgeApi=require("bgeApi"),base64=require("base64"),urlHelpers=require("urlHelpers"),loadDeck=require("loadDeck"),cardUI=require("cardUI"),simController=require("simController"),storageAPI=require("storageAPI"),dataUpdater=require("dataUpdater"),loadCardCache=require("loadCardCache");function doneLoading(){$("body").removeClass("loading"),checkTutorial()}function updateGameData(e){var a=doneLoading;e&&(a=function(){doneLoading(),e()}),dataUpdater.updateData(a,!0)}function setDeckSortable(e,l){$(e).sortable({items:".card:not(.commander):not(.blank)",tolerance:"intersect",helper:function(e,a){return a.clone()},start:function(e,a){var n=a.placeholder.index()-1;a.item.data("origPos",n),$(a.item).hide()},stop:function(e,a){var n=a.item.data("origPos")-1,t=a.item.index()-1,r=$(l),i=base64.decodeHash(r.val()),s=i.deck;s.splice(t,0,s.splice(n,1)[0]);var o=base64.encodeHash(i);r.val(o)}})}function showMapBGEs(){mapBGEDialog.dialog("open"),mapBGEDialog.dialog("option","position",{my:"center",at:"center",of:window})}function loadDeck(e){$('label[for="loadDeckName"]').html("<strong>Deck:</strong>"),loadDeckDialog.dialog("open"),loadDeckDialog.dialog("option","position",{my:"center",at:"center",of:window}),loadDeckDialog.hashField=e}function onDeckLoaded(e,a){$(a).val(e).change()}$(function(){$("#deck1").change(function(){this.value=this.value.trim(),r("attack_deck",base64.decodeHash(this.value),"player")}),$("#deck2").change(function(){this.value=this.value.trim(),r("defend_deck",base64.decodeHash(this.value),"cpu")}),$("#battleground").change(function(){$("#deck1").change(),$("#deck2").val()?$("#deck2").change():$("#mission").val()?$("#mission").change():$("#raid").val()&&$("#raid").change()});for(var e=$("label[bge-desc]"),a=0;a<e.length;a++){$(e[a]).hover(n,t)}function n(e){var a=$("#tooltip"),n=$("#tooltip-text");n.html($(e.target).attr("bge-desc")),n.width(200),a.show(),$("#tooltip .arrow").css("borderTopWidth",0).css("borderBottomWidth",0);var t=$(e.target).offset();t.left-=230,t.top-=a.outerHeight()/2-10,a.offset(t);var r=n.innerHeight()/2-4;$("#tooltip .arrow").css("borderTopWidth",r).css("borderBottomWidth",r)}function t(e){$("#tooltip").hide()}function r(e,a,n){var t=$("#"+e);if(t.children().remove(),!urlHelpers.paramDefined("seedtest")){var r=simController.getConfiguration(),i=bgeApi.getBattlegrounds(getbattleground,selfbges,enemybges,mapbges,r.selectedCampaign,missionlevel,getraid,raidlevel);i=i.onCreate.filter(function(e){return!("player"===n&&e.enemy_only||"cpu"===n&&e.ally_only)}),t.append(cardUI.makeDeckHTML(a,!1,i))}}$(".accordion").accordion({collapsible:!0,active:!1,heightStyle:"content"}).filter(".start-open").accordion("option","active",0);if($("#raid, #raid_level").change(function(){var e,a=$("#raid").val(),n=$("#raid_level");a?(e=loadDeck.raid(a,n.val()),"Dungeon"===RAIDS[a].type?n.attr("max",150):n.attr("max",40)):(e=base64.decodeHash(""),n.attr("max",40)),r("defend_deck",e,"cpu")}),$("#location, #campaign").change(function(){$("#mission").change()}),$("#mission, #mission_level").change(function(){var e,a=$("#mission").val();if(a){var n=$("#mission_level").val();e=loadDeck.mission(a,n)}else e=base64.decodeHash("");r("defend_deck",e,"cpu")}),loadDeckDialog=$("#loadDeckDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{Delete:function(){var e=$("#loadDeckName").val();storageAPI.deleteDeck(e)},Load:function(){var e=$("#loadDeckName").val();onDeckLoaded(storageAPI.loadDeck(e),loadDeckDialog.hashField),loadDeckDialog.dialog("close")},Cancel:function(){loadDeckDialog.dialog("close")}}}),mapBGEDialog=$("#bgeDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{OK:function(){mapBGEDialog.dialog("close")},Cancel:function(){mapBGEDialog.dialog("close")}}}),r("attack_deck",base64.decodeHash("")),r("defend_deck",base64.decodeHash("")),setDeckSortable("#attack_deck","#deck1"),setDeckSortable("#defend_deck","#deck2"),urlHelpers.paramDefined("latestCards")){var i=null;urlHelpers.paramDefined("autostart")&&(i=function(){simController.startsim(1)}),updateGameData(i)}else loadCardCache();processQueryString()});var deckPopupDialog,dark=!1;function toggleTheme(){dark?($("#theme").attr("href","dist/light.min.css"),$("#toggleTheme").val("Dark Theme")):($("#theme").attr("href","dist/dark.min.css"),$("#toggleTheme").val("Light Theme")),dark=!dark}base64=require("base64"),urlHelpers=require("urlHelpers"),loadDeck=require("loadDeck");var style,debugLog=require("debugLog");simController=require("simController");function processQueryString(){if($("#header").load("templates/header.html",function(){"undefined"!=typeof showTutorial&&$("#help").click(showTutorial)}),$.holdReady(!0),$("#footer").load("templates/footer.html",function(){$.holdReady(!1)}),!document.getElementById("ui"))return 0;angular.element(document.getElementById("ui")).scope();$("#generate_link").on("click",display_generated_link),$("#btn_simulate").on("click",simController.startsim),$("#btnStop").on("click",simController.stopsim),$("#display_history").on("click",display_history),$("#deck1").val(urlHelpers.paramValue("deck1")).change(),$("#deck2").val(urlHelpers.paramValue("deck2")).change(),$("#surge").prop("checked",urlHelpers.paramDefined("surge")),$("#siege").prop("checked",urlHelpers.paramDefined("siege"));var e=Math.min(Math.max(urlHelpers.paramValue("tower_level")||18,0),18);$("#tower_level").val(e);var a=urlHelpers.paramValue("tower_type")||501;$("#tower_type").val(a),$("#auto_mode").prop("checked",urlHelpers.paramDefined("auto_mode")),$("#tournament").prop("checked",urlHelpers.paramDefined("tournament")),$("#ordered").prop("checked",urlHelpers.paramDefined("ordered")),$("#exactorder").prop("checked",urlHelpers.paramDefined("exactorder")),$("#ordered2").prop("checked",urlHelpers.paramDefined("ordered2")),$("#exactorder2").prop("checked",urlHelpers.paramDefined("exactorder2")),urlHelpers.paramDefined("randomAI")&&(pvpAI=!1);var n=urlHelpers.paramValue("location"),t=urlHelpers.paramValue("campaign"),r=urlHelpers.paramValue("mission"),i=urlHelpers.paramValue("raid");if(n&&$("#location").val(n).change(),t&&(n||(n=CAMPAIGNS[t].location_id,$("#location").val(n).change()),$("#campaign").val(t).change()),r&&($("#mission_level").val(urlHelpers.paramValue("mission_level")||7),$("#mission").val(r).change()),i&&($("#raid_level").val(urlHelpers.paramValue("raid_level")||25),$("#raid").val(i).change()),urlHelpers.paramDefined("bges"))for(var s=urlHelpers.paramValue("bges"),o=0;o<s.length;o+=2){var l=base64.toDecimal(s.substring(o,o+2));$("#battleground_"+l).prop("checked",!0)}else for(document.getElementsByName("battleground"),o=0;o<current_bges.length;o++)$("#battleground_"+current_bges[o]).prop("checked",!0);if(s=urlHelpers.paramValue("selfbges"))for(o=0;o<s.length;o+=2){l=base64.toDecimal(s.substring(o,o+2))+1e4;$("#self-battleground_"+l).prop("checked",!0)}if(s=urlHelpers.paramValue("enemybges"))for(o=0;o<s.length;o+=2){l=base64.toDecimal(s.substring(o,o+2))+1e4;$("#enemy-battleground_"+l).prop("checked",!0)}var d=urlHelpers.paramValue("mapBges");if(d&&setSelectedMapBattlegrounds(d),$("#battleground").change(),$("#sims").val(urlHelpers.paramValue("sims")||1e4),urlHelpers.paramDefined("debug")&&$("#debug").click(),urlHelpers.paramDefined("mass_debug")&&$("#mass_debug").click(),urlHelpers.paramDefined("loss_debug")&&$("#loss_debug").click(),urlHelpers.paramDefined("win_debug")&&$("#win_debug").click(),urlHelpers.paramDefined("play_debug")&&$("#play_debug").click(),document.title="SimSpellstone "+text_version+" - The Spellstone Simulator that runs from your browser!",urlHelpers.paramDefined("autostart")&&!urlHelpers.paramDefined("latestCards"))simController.startsim(1);else if(urlHelpers.paramDefined("unit_tests")){var c=document.getElementsByTagName("body")[0],u=document.createElement("script");u.src="scripts/unit_tests.js",c.appendChild(u),u.onload=function(){var e=document.createElement("script");e.src="scripts/unit_test_runner.js",c.appendChild(e)}}document.getElementById("missionDeckDialog")&&(deckPopupDialog=$("#missionDeckDialog").dialog({autoOpen:!1,minWidth:500,minHeight:20,modal:!0,resizable:!1,draggable:!1,buttons:{Close:function(){deckPopupDialog.dialog("close")}},open:function(e,a){$(".ui-dialog-titlebar-close",a.dialog|a).hide()}}))}window.addEventListener("error",function(e,a,n){var t="JavaScript error:\n "+e+"\n on line "+n+"\n for "+a;if(window.sa("send","exception",{exDescription:t,exFatal:!1}),0===n){var r="<br><br><i>Error Message:</i><br><br><i>It appears you're having trouble loading SimSpellstone. Thanks.</i><br><br>";return outp?outp(r):document.write(r),1}t+="\n",t+="Browser CodeName: "+navigator.appCodeName+"\n",t+="Browser Name: "+navigator.appName+"\n",t+="Browser Version: "+navigator.appVersion+"\n",t+="Cookies Enabled: "+navigator.cookieEnabled+"\n",t+="Platform: "+navigator.platform+"\n",t+="User-agent header: "+navigator.userAgent+"\n";try{t+="URL: "+generate_link()+"\n"}catch(e){}outp('<br><br><i>Error Message:</i><br><textarea cols=50 rows=6 onclick="this.select()"><blockquote>'+t+"</blockquote></textarea>"),current_timeout&&clearTimeout(current_timeout)});var u_black=!1;function toggle_u(){var e=!1;if(void 0===style)e=!0,style=document.createElement("style");else for(;style.hasChildNodes();)style.removeChild(style.firstChild);var a,n=document.getElementsByTagName("head")[0];a=u_black?(u_black=!1,document.createTextNode("u { text-decoration: none; font-style:normal; color: #dddddd; font-weight: normal; }")):(u_black=!0,document.createTextNode("u { text-decoration: none; font-style:normal; color: #000000; font-weight: normal; }")),style.type="text/css",style.styleSheet?style.styleSheet.cssText=a.nodeValue:style.appendChild(a),!0===e&&n.appendChild(style)}function toggleUI(e){e?$("#ui").show():$("#ui").hide()}function showUI(){toggleUI(!0),document.getElementById("stop").style.display="none"}function hideUI(){$(".accordion").accordion("option","active",null),toggleUI(!1),document.getElementById("stop").style.display="block"}function getSelectedBattlegrounds(e){e=e||"";for(var a=[],n=document.getElementsByName(e+"battleground"),t=0;t<n.length;t++){var r=n[t];r&&r.checked&&a.push(r.value)}return a=a.join()}function getSelectedMapBattlegrounds(){for(var e=[],a=$("#location").val(),n=document.getElementsByName("map-battleground"),t=0;t<n.length;t++){var r=n[t];0<r.value&&e.push(a+"-"+t+"-"+r.value)}return e=e.join()}function setSelectedMapBattlegrounds(e){for(var a=document.getElementsByName("map-battleground"),n=0;n<e.length&&n<a.length;n++)a[n].value=e[n]}function outp(e){$("#content").html(e)}function outputTurns(){var e=debugLog.getLog();if(e){closeDiv&&(e+="</div>",closeDiv=!1),outp(e="<input id='show-turns' type='button' value='Show All' /> <div id='turn-container'>Turn: <select id='turn-picker'></select></div> <div>"+e+"</div>");for(var a=$(".turn-info").hide().length,n=[],t=0;t<a;t++){var r=t+1;n.push("<option value='"+t+"'>"+r+"</option>")}var i=t-1;i&&closeDiv&&i--,$("#turn-picker").append(n).change(function(e){var a=e.target.selectedIndex;$(".turn-info").hide().eq(a).show()}).val(i).change();var s=!0;$("#show-turns").click(function(){if(s=!s){var e=$("#turn-picker").val();$(".turn-info").hide().eq(e).show(),$("#turn-container").show(),this.value="Show All"}else $(".turn-info").show(),$("#turn-container").hide(),this.value="Show One"})}}function showWinrate(){if(suppressOutput);else if(debugLog.enabled||0==sims_left){var e="";if(e+='<br><br><i>Non-autostart link</i><br><a href="'+generate_link()+'">'+generate_link()+'</a><br><br><i>Autostart link</i><br><a href="'+generate_link(1)+'">'+generate_link(1)+"</a><br><br>",debugLog.enabled)return e}var a=(100*(wins/games)).toFixed(2)+"%";$("#wins").html(wins),$("#winrate").html(a);var n=losses/games*100;n=n.toFixed(2)+"%",$("#losses").html(losses),$("#lossrate").html(n);var t=draws/games*100;t=t.toFixed(2)+"%",$("#draws").html(draws),$("#drawrate").html(t);var r=marginOfError(wins,games);$("#marginGames").html((r*games).toFixed(0)),r=r.toFixed(2)+"%",$("#marginPercent").html(r);var i=(100*games/(games+sims_left)).toFixed("2")+"%";$(".battleCount").html(games),$("#percentComplete").html(i),$("#avgLength").html((total_turns/games).toFixed(1)),$("#avgPoints").html((points/games).toFixed(2)),$("#winrateTable").show();var s="";if(0==sims_left){s+=e;var o="",l=[],d=document.getElementById("deck1").value;d&&(l.player=base64.decodeHash(d)),l.player&&(o=base64.encodeHash(l.player)),battle_history+=a+" (+/- "+r+") &nbsp; &nbsp; "+o+"<br>"}return s}function hideTable(){$("#winrateTable").hide()}function setSimStatus(e,a,n){if($("#simStatusMsg").html(e),a&&n){var t=games+sims_left,r=(100*games/t).toFixed("2")+"%",i="("+games+"/"+t+") "+r;$("#progress").html(i),$("#speed").show(),$("#elapsed").html(a),$("#simsPerSec").html(n)}else $("#progress").html(""),$("#speed").hide();$("#simulationStatus").show()}function winrateDev(e,a){if(a<=1)return 1;var n=e/a,t=a;return Math.sqrt(t*n*(1-n))}function marginOfError(e,a){if(a<=1)return 1;var n=e/a,t=a;return 100*(1.96*Math.sqrt(n*(1-n)/t)+.5/t)}function generate_link(e){var a=0,n=document.URL,t=n.indexOf("?");0<t&&(n=n.substring(0,t));var r=[];addValueParam(r,"deck1"),addValueParam(r,"deck2"),addValueParam(r,"location"),addValueParam(r,"campaign"),addValueParam(r,"mission"),addValueParam(r,"mission_level"),addValueParam(r,"raid"),addValueParam(r,"raid_level");var i=$("select[name=map-battleground]").toArray().reduce(function(e,a){return e+a.value},"");i.length&&r.push("mapBges="+i),addBoolParam(r,"surge"),addBoolParam(r,"siege")&&(addValueParam(r,"tower_level"),addValueParam(r,"tower_type")),addBoolParam(r,"auto_mode"),addBoolParam(r,"tournament"),addBoolParam(r,"ordered"),addBoolParam(r,"exactorder"),addBoolParam(r,"ordered2"),addBoolParam(r,"exactorder2");for(var s="",o=document.getElementsByName("battleground"),l=0;l<o.length;l++)(a=o[l]).checked&&(s+=base64.fromDecimal(a.value,2));r.push("bges="+s);for(s="",o=document.getElementsByName("self-battleground"),l=0;l<o.length;l++)(a=o[l]).checked&&(s+=base64.fromDecimal(a.value-1e4,2));s&&r.push("selfbges="+s);for(s="",o=document.getElementsByName("enemy-battleground"),l=0;l<o.length;l++)(a=o[l]).checked&&(s+=base64.fromDecimal(a.value-1e4,2));return s&&r.push("enemybges="+s),addValueParam(r,"sims"),addBoolParam(r,"debug"),addBoolParam(r,"mass_debug"),addBoolParam(r,"loss_debug"),addBoolParam(r,"win_debug"),addBoolParam(r,"play_debug"),e&&r.push("autostart"),0<r.length?n+"?"+r.join("&"):n}function addValueParam(e,a,n){var t=$("#"+(n||a)).val();return!!t&&(e.push(a+"="+t),!0)}function addBoolParam(e,a){return!!$("#"+a).is(":checked")&&(e.push(a),!0)}var deckBuilders={};function load_deck_builder(e){if("player"===e)var a=$("#deck1").val();else{a=$("#deck2").val();var n=$("#mission").val(),t=$("#mission_level").val(),r=$("#raid").val(),i=$("#raid_level").val()}deck=a?base64.decodeHash(a):n?loadDeck.mission(n,t):r?loadDeck.raid(r,i):loadDeck.defaultDeck();var s=base64.encodeHash(deck),o="player"==e?"Player Deck":"Enemy Deck",l=e?$("#"+("player"==e?"deck1":"deck2")):null,d=deckBuilders[e];null==d||d.closed?deckBuilders[e]=open_deck_builder(o,s,null,l):d.focus()}function open_deck_builder(e,a,n,t){var r=["nosort"];a&&r.push("hash="+a),n&&r.push("inventory="+n),e&&r.push("name="+e),urlHelpers.paramDefined("ajax")&&r.push("ajax"),r.push("fromSim");var i,s="DeckBuilder.html?"+r.join("&"),o=Math.min(screen.width,1e3),l=Math.min(screen.height,700),d=Number((screen.width-o)/2),c=Number((screen.height-l)/2),u="scrollbars,left="+d+"top="+c+",width="+o+",height="+l+",top="+c+",left="+d,p=window.open(s,"",u);return $(p).load((i=t,function(){i&&(p.updateSimulator=function(e){i.val(e).change()})})),p}function display_generated_link(){outp('<br><i>Non-autostart link</i><br><a href="'+generate_link()+'">'+generate_link()+'</a><br><br><i>Autostart link</i><br><a href="'+generate_link(1)+'">'+generate_link(1)+"</a><br><br>")}function clear_history(){battle_history="",display_history()}function display_history(){outp("<br><hr>"+(battle_history||"No history available.")+'<hr><br><br><input type="button" value="Clear History" onclick="clear_history();" style="text-align: center; font-weight: normal;"><br><br>')}var current_timeout,cache_player_deck,cache_cpu_deck,cache_player_deck_cards,cache_cpu_deck_cards,battle_history="",mass_debug=!1,loss_debug=!1,win_debug=!1,found_desired=!1,play_debug=!1,getdeck="",getdeck2="",getcardlist="",getcardlist2="",getordered=!1,getordered2=!1,getexactorder=!1,getexactorder2=!1,getmission=0,missionlevel=0,getraid=!1,raidlevel=0,getbattleground="",enemybges="",selfbges="",mapbges="",getsiege=0,tower_level=0,tower_type=0,pvpAI=!0,closeDiv=!1,wins=0,losses=0,draws=0,games=0,points=0,num_sims=0,last_games=[],sims_left=0,surge=!1,battleground=[],total_turns=0,choice=void 0,tournament=!1,suppressOutput=!1,orders={},cardStats={};function getTutorialScript(){for(var e=[{msg:"Welcome to SIM Spellstone!  This is a brief tutorial of how to use the Simulator."},{ui:"#setup-container",msg:"Here is where you set everything up for a simulation.",actions:[i]},{ui:"#setup-container",msg:'When you are done, you can click the "Setup" bar to hide this section.',actions:[r]},{ui:"#setup-container",msg:"Clicking it again will open it back up.",actions:[i]},{ui:"#attacker-container",msg:"Use this section to set up the deck for the attacker."},{ui:"#edit-player",msg:'Click "Edit" to open the DeckBuilder and create a deck.'},{ui:"#load-player",msg:'Click "Load" to choose a deck from the ones you have saved in the DeckBuilder.'},{ui:"#attacker-hash-container",msg:"If you have a deck hash, you can simply paste it here as well."},{ui:"#attacker-advanced",msg:"This section contains some additional settings for the attacker that determine how their deck is played."},{ui:"#auto-container",msg:"Check this to have fights run on auto, rather than playing them yourself.",showFor:"battle"},{ui:"#auto-container",msg:'Setting the attacker to "auto" also enables the "Ordered" and "Do Not Shuffle" options.',showFor:"battle"},{ui:"#ordered-container",msg:"Check this to have the AI attempt to play the attacker's deck as close as possible to the order that the cards are listed."},{ui:"#exactorder-container",msg:"Check this to disable shuffling of the attacker's deck."},{ui:"#defender-container",msg:"Use this section to set up the deck for the defender."},{ui:"#defender-hash-container",msg:"You can manually create a deck for the defender here."},{ui:"#pve-container",msg:"Or you can choose a PvE deck to sim against.",actions:[l]},{ui:"#campaign-container",msg:"To choose a campaign mission, first pick a Campaign from the dropdown...",actions:[o]},{ui:"#mission-container",msg:"... then pick a Mission from the mission dropdown.",actions:[d,o,function(){$("#mission").val(11).change()}]},{ui:"#raid-container",msg:"To fight against a raid boss, pick the desired Raid from the dropdown",actions:[l,function(){$("#raid").val(24005).change()}]},{ui:"#defender-advanced",msg:"This section contains some additional settings for the defender that determine how their deck is played.",actions:[d]},{ui:"#surge-container",msg:"Check this to have the defender go first.",showFor:"battle"},{ui:"#tower-container",msg:"Use these fields to set up a tower for the defender."},{ui:"#siege-container",msg:"Check this field to turn the tower on."},{ui:"#tower_level",msg:"This field determines the BR of the defender.  The tower's level is one less than the defender's BR."},{ui:"#tower_type",msg:"This field determines which type of tower the defender will have."},{ui:"#bge-container",msg:"Check/uncheck boxes here to set active battleground effects.",actions:[s,i]},{ui:"#view-container",msg:'Click "View" to display the currently set decks for the attacker and defender.',actions:[r,function(){$("#view-container").accordion("option","active",0)}]},{ui:"#view-container",msg:"Click it again to hide it.",actions:[s]},{ui:"#sims-container",msg:"This field determines how many fights to run.",showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Simulate" to run a batch of fights.',showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Battle" to start a fight.',showFor:"battle"},{ui:"#generate_link",msg:'Click "Generate Link" to create a link that will open this tool with all of the current settings.'},{msg:'To view this tutorial again at any time, you can click the "Help" button.  (Note: this will reset the Simulator.)'}],a=require("urlHelpers").getCurrentPage(),n=0;n<e.length;n++){var t=e[n];t.showFor&&t.showFor!==a&&e.splice(n--,1)}function r(){$("#setup-container").accordion("option","active",null)}function i(){$("#setup-container").accordion("option","active",0)}function s(){$("#view-container").accordion("option","active",null)}function o(){$("#campaign").val(1).change()}function l(){$("#campaign").val("").change()}function d(){$("#raid").val("").change()}return e}$(document).ready(function(){var a=require("storageAPI"),s=getTutorialScript(),e=$("<div></div>");function n(){a.shouldShowTutorial?t():d()}function t(){l=0,c(),$("#tutorial").show()}$(document.body).append(e),e.load("templates/tutorial-overlay.html",null,function(){e.replaceWith(function(){return $(this).contents()}),$("#tutorial-show").prop("checked",a.shouldShowTutorial).change(function(e){a.setShowTutorial(this.checked)}),$("#help").click(t),$("#tutorial-close, #tutorial-skip").click(d),$("#tutorial-next").click(r),$("#tutorial-prev").click(i),"undefined"==typeof delayTutorial&&n()});var o,l=0;function r(){l++,c()}function i(){l--,c()}function d(){$("#tutorial").hide(),$("#tutorial-permahide").is(":checked")&&a.hideTutorial()}function c(){clearTimeout(o);var e=s[l],a=e.actions;if(a)for(var n=0;n<a.length;n++)a[n]();var t=e.msg,r=e.ui;if(r){var i=$(r);e.dialog&&(i=i.parent()),u(i),a&&(o=setTimeout(u,500,i)),t.indexOf(!1)&&(t=t.replace(/\{0\}/g,i.text()))}else $(".overlay-fog").width(0).height(0);$("#tutorialMessage").text(t),l<s.length-1?($("#tutorial-next").show(),$("#tutorial-close").hide()):($("#tutorial-next").hide(),$("#tutorial-close").show()),0<l?$("#tutorial-prev").removeClass("disabled"):$("#tutorial-prev").addClass("disabled")}function u(e){var a=e.offset();$(".overlay-fog").css({top:a.top-2+"px",left:a.left-2+"px"}).width(e.outerWidth()+4+"px").height(e.outerHeight()+4+"px")}window.showTutorial=t,window.checkTutorial=n});
//# sourceMappingURL=simulator.min.js.map