for(var skillID in function(){var t={};window.define=function(e,a){t[e]="function"==typeof a?a():a},window.require=function(e){var a=t[e];if(a)return a;throw"Module '"+e+"' is not defined yet."}}(),"function"!=typeof Object.assign&&(Object.assign=function(e){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");e=Object(e);for(var a=1;a<arguments.length;a++){var t=arguments[a];if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}),Function.prototype.debounce=function(t){var n,r=this;return function(){var e=this,a=arguments;clearTimeout(n),n=setTimeout(function(){n=null,r.apply(e,a)},t)}},Function.prototype.throttle=function(t){var n,r=this;return function(){var e=this,a=arguments;if(!n){r.apply(e,a);n=setTimeout(function(){n=null,r.apply(e,a)},t)}}},define("factions",{names:{0:"Factionless",1:"Aether",2:"Chaos",3:"Wyld",4:"Frog",5:"Elemental",6:"Angel",7:"Undead",8:"Void",9:"Dragon",10:"Avian",11:"Goblin",12:"Seafolk",13:"Insect",14:"Bear",15:"Token",16:"Mecha",17:"Knight",999:"Tower"},IDs:{Factionless:0,Aether:1,Chaos:2,Wyld:3,Frog:4,Elemental:5,Angel:6,Undead:7,Void:8,Dragon:9,Avian:10,Goblin:11,Seafolk:12,Insect:13,Bear:14,Token:15,Mecha:16,Knight:17,Tower:999}}),define("skillApi",function(){function o(e,a){var t=a.id;switch(SKILL_DATA[t].type){case"toggle":return void(e[t]=!0);case"passive":e[a.id]=(0|e[a.id])+a.x;break;case"flurry":e[a.id]=a;break;case"onDeath":e.onDeathSkills.push(a);break;case"earlyActivation":e.earlyActivationSkills.push(a);break;case"activation":default:e.skill.push(a)}}function d(e){var a={};return a.id=e.id,a.x=e.x,a.mult=e.mult,a.on_delay_mult=e.on_delay_mult,a.all=e.all,a.y=e.y,a.z=e.z,a.c=e.c,a.s=e.s,a}return{setSkill:o,copySkill:d,copySkills:function(e,a,t){e.skill=[],e.earlyActivationSkills=[],e.onDeathSkills=[];var n=[],r=!0;for(var i in a){var s=a[i];if(s.c){var l=d(s);o(e,l),n.push(l),r=!1}else if(t){var l=d(s);l.x=Math.ceil(l.x*t),o(e,l)}else o(e,s)}e.reusableSkills=r,e.skillTimers=n},nameFromId:function(e){var a=SKILL_DATA[e];return a?a.name:e}}}),define("runeApi",function(){function o(e){return RUNES[e]}return{addRunes:function(e,a){e.runes||(e.runes=[]);for(var t=0,n=a.length;t<n;t++){var r=a[t].id,i=o(r).stat_boost;for(var s in e.runes.push({id:r,stat_boost:i}),i){var l=i[s];"skill"===s||(isNaN(l)&&(l=Math.max(Math.ceil(e[s]*l.mult),l.min_bonus||1)),e[s]+=parseInt(l))}}},canUseRune:function(e,a){var t=o(a),n=t.stat_boost;if(t.faction_req&&!e.isInFaction(t.faction_req))return!1;for(var r in n)if("skill"===r){var i=n[r],s=i.all?1:0;if(!e.hasSkill(i.id,s))return!1}return!0},getRune:o}}),define("cardInfo",function(){function t(e){return CARDS[e]}return{loadCard:t,isCommander:function(e){var a=t(e);return a&&"1"==a.card_type},isAssault:function(e){var a=t(e);return a&&"2"==a.card_type},isTrap:function(e){var a=t(e);return a&&"3"==a.card_type}}}),define("matchTimer",function(){function t(e,a){return((a-e)/1e3).toFixed(3)}return{elapsed:function(){var e=this.timeStop||Date.now();return t(this.timeStart,e)},batchElapsed:function(e){return a=e||this.batchStarted,t(a,Date.now());var a},startBatch:function(){this.batchStarted=Date.now()},stop:function(){this.timeStop=Date.now()},reset:function(){this.timeStart=Date.now(),this.timeStop=0}}}),define("urlHelpers",function(){return{paramDefined:function(e){for(var a=window.location.search.substring(1).split("&"),t=0;t<a.length;t++){var n=a[t].split("=");if(decodeURIComponent(n[0])==e)return!0}return!1},paramValue:function(e){for(var a=window.location.search.substring(1).split("&"),t=0;t<a.length;t++){var n=a[t].split("=");if(decodeURIComponent(n[0])==e)return decodeURIComponent(n[1]?n[1]:"")}return},getCurrentPage:function(){var e=window.location.href,a=e.indexOf(".html"),t=(e=e.substring(0,a)).lastIndexOf("/")+1;return e=e.substring(t).toLowerCase()}}}),define("debugLog",function(){var e={enabled:!1,getLog:function(){return a},clear:function(){a=""},prepend:t,prependLines:function(){for(var e=0;e<arguments.length;e++)t(arguments[e]+"</br>")},append:n,appendLines:function(){for(var e=0;e<arguments.length;e++)n(arguments[e]+"</br>")}},a="";function t(e){a=e+a}function n(e){a+=e}return e}),define("storageAPI",function(){"use strict";!function(){try{var e=window.localStorage,a="__storage_test__";return e.setItem(a,a),e.removeItem(a),!0}catch(e){return!1}}()?function(){storageAPI.initialize=function(){storageAPI.getSavedDecks=function(){return{}},storageAPI.loadDeck=e,storageAPI.deleteDeck=e,storageAPI.clearDecks=e,storageAPI.getField=function(e,a,t){return t},storageAPI.setField=function(){},storageAPI.savedDecks={},storageAPI.setShowTutorial=function(e){storageAPI.shouldShowTutorial=e},storageAPI.shouldShowTutorial=!0};var e=function(){alert("Your browser does not support this feature.")}}():function(){var n=require("urlHelpers"),r="SavedDecks",i="Tutorial";function s(e){var a=localStorage.getItem(e);if(a)try{a=JSON.parse(a)}catch(e){a={}}else a={};return storageAPI.data[e]=a}storageAPI.initialize=function(){var e,a=n.getCurrentPage();void 0===(e=s(r)).savedDecks&&storageAPI.setField(r,"savedDecks",e),storageAPI.getField(r,"savedDecks",{}),storageAPI.shouldShowTutorial=storageAPI.getField(i,a,!0)[a];var t=storageAPI.onUpdateDecks;storageAPI.onUpdateDecks=function(e){t(),storageAPI.setField(r,"savedDecks",e)},storageAPI.setShowTutorial=function(e){storageAPI.shouldShowTutorial=e,storageAPI.setField(i,a,e)}},storageAPI.getField=function(e,a,t){var n=s(e)[a];return void 0===n&&(n=t,storageAPI.setField(e,a,n)),n},storageAPI.setField=function(e,a,t){var n=s(e);n[a]=t,localStorage.setItem(e,JSON.stringify(n))},window.addEventListener("storage",function(e){"__storage_test__"!==e.key&&localStorage.getItem(e.key)!==e.newValue&&angular.element("#loadDeckDialog").scope().$apply(localStorage.setItem(e.key,e.newValue))})}();var e,a="SavedDecks";return storageAPI.data={},storageAPI.getSavedDecks=function(){return storageAPI.getField(a,"savedDecks",{})},storageAPI.saveDeck=function(e,a){var t=storageAPI.getSavedDecks();t[e]=a,storageAPI.onUpdateDecks(t)},storageAPI.loadDeck=function(e){return storageAPI.getSavedDecks()[e]},storageAPI.deleteDeck=function(e){var a=storageAPI.getSavedDecks();delete a[e],storageAPI.onUpdateDecks(a)},storageAPI.clearDecks=function(e){var a=storageAPI.getSavedDecks();for(var e in a)delete a[e];storageAPI.onUpdateDecks(a)},storageAPI.onUpdateDecks=function(){e||(e=angular.element("#loadDeckDialog").scope()),e.$apply()},storageAPI.initialize(),{}}),define("dataUpdater",function(){var e={updateData:function(e,a){$("body").addClass("loading"),$("#loadingSplash").html("Checking for New Cards...");var t=Date.now();if(!l||6e4<l-t||a){l=t,f={};var n=[];n.push(function(){for(var e=[],a=0;a<o.length;a++){var t=jQuery.ajax({url:s+"/assets/"+o[a],success:function(e){for(var a="undefined"!=typeof spoilers,t=e.getElementsByTagName("unit"),n=0;n<t.length;n++){var r=t[n],i=g(r,"id"),s=h(r),l=!1;CARDS[i]?JSON.stringify(CARDS[i])!==JSON.stringify(s)&&(l=!0):l=!0,l&&(a&&(spoilers[i]=!0),f[i]=s),CARDS[i]=s}for(var o=e.getElementsByTagName("fusion_recipe"),n=0;n<o.length;n++){var d=o[n],c=g(d,"card_id",!1),u=d.getElementsByTagName("resource")[0];if(u){var p=g(u,"card_id",!0);FUSIONS[p]&&FUSIONS[p]===c||(m[p]=c,FUSIONS[p]=c)}}},async:!0,cache:!1});e.push(t)}return $.when.apply($,e)}());var r=function(){!function(){if(void 0!==i){var e=i.getField("GameData","CardCache");e?(e.newCards=e.newCards||{},e.newFusions=e.newFusions||{},$.extend(e.newCards,f),$.extend(e.newFusions,m)):e={newCards:f,newFusions:m},e.lastUpdated=Date.now(),i.setField("GameData","CardCache",e)}}(),$("body").removeClass("loading"),e&&e()};$.when.apply($,n).then(r,r)}else e&&e()}},i=require("storageAPI"),s="https://spellstone.synapse-games.com",f={},m={},l=null;var o=["cards_heroes.xml","cards_premium_aether.xml","cards_premium_chaos.xml","cards_premium_wyld.xml","cards_reward.xml","cards_shard.xml","cards_special.xml","cards_standard.xml","cards_story.xml","fusion_recipes_cj2.xml"];function h(e){var a,t,n={};if(n.id=g(e,"id"),n.name=g(e,"name"),p(n,e,"desc"),n.picture=g(e,"picture")||(a=g(e,"asset_prefab"),t="prefab_",a?t+a:a),!n.picture){var r=g(e,"portrait");n.picture=r?"portrait_"+r.toLowerCase().replace("portrait_",""):"NotFound"}var i=g(e,"hidden_until")||g(e,"hidden_until_time");i&&(n.hidden_until=i+"000"),n.rarity=g(e,"rarity"),n.set=g(e,"set"),n.card_type=g(e,"card_type"),v(n,e,"shard_card"),n.type=g(e,"type")||0,n.sub_type=b(e,"sub_type")||[],v(n,e,"health"),"1"!==n.card_type&&(v(n,e,"attack"),v(n,e,"cost"));var s=function(e){for(var a=e.getElementsByTagName("upgrade"),t={},n=0;n<a.length;n++)t[n+2]=u(a[n]);return t}(e);return n.maxLevel=1+Object.keys(s).length,n.skill=d(e),n.upgrades=s,n}function d(e){for(var a=e.childNodes,t=[],n=0;n<a.length;n++){var r=a[n];"skill"===r.nodeName&&t.push(c(r))}return t}function c(e){var a={id:g(e,"id",!0)};return v(a,e,"x",!0),v(a,e,"mult",!0),v(a,e,"on_delay_mult",!0),p(a,e,"y",!0),v(a,e,"z",!0),v(a,e,"c",!0),p(a,e,"s",!0),p(a,e,"all",!0),a}function u(e){var a={};return v(a,e,"attack"),v(a,e,"health"),v(a,e,"cost"),p(a,e,"desc"),a.skill=d(e),a}function p(e,a,t,n){var r=g(a,t,n);null!=r&&0<r.length&&(e[t]=r)}function v(e,a,t,n){var r,i=null!=(r=g(a,t,n))?Number(r):-1;0<=i&&(e[t]=i)}function g(e,a,t){if(t)return e.getAttribute(a);var n=b(e,a);return n?n[0]:null}function b(e,a){var t=null,n=$(e).children(a);if(0<n.length){t=[];for(var r=0;r<n.length;r++)t.push(n[r].textContent)}return t}return e}),define("log",function(){var e={skill:function(e){var a=n.nameFromId(e.id);e.all&&(a+=" all");e.y&&(a+=" "+t.names[e.y]);e.s&&(a+=" "+n.nameFromId(e.s));e.c?a+=" every "+e.c+" turns":e.x&&(a+=" "+e.x);return a},name:function(e,a){if("cpu"===e.owner)var t="i";else var t="b";var n="<"+t+">";n+=e.name,e.runes.length&&(n+="*");1<e.maxLevel&&(n+="{"+e.level+"/"+e.maxLevel+"}");void 0!==e.key&&(n+=" ("+e.key+")");if(n+="</"+t+">",!a){if(n+="<u>",e.isCommander())n+=" [",void 0!==e.health_left?n+=i(e.health_left):n+=e.health,n+=" HP]";else if(e.isAssault()){n+=" [";var r=e.adjustedAttack();(isNaN(r)||null==r)&&(r=e.attack),n+=r,n+="/",void 0!==e.health_left?n+=i(e.health_left):n+=e.health,n+="/",void 0!==e.timer?n+=e.timer:n+=e.cost,n+="]"}n+="</u>"}return n}},t=require("factions"),n=require("skillApi");function i(e){return e>Math.floor(e)&&(e=e.toFixed(1)),e}return e}),define("base64",function(){"use strict";var i=require("cardInfo"),e={encodeHash:function(e){var a=[];e.commander&&a.push(e.commander);return a.concat(e.deck).map(n).join("")},decodeHash:function(e){for(var a,t={deck:[]},n=0;n<e.length;n+=5){var r=e.substr(n,5);(a=d(r))&&(i.loadCard(a.id)?!t.commander&&i.isCommander(a.id)?t.commander=a:t.deck.push(a):console.log("Could not decode '"+r+"' ("+a.id+")"))}t.commander||(t.commander=a.defaultCommander);return t},fromDecimal:c,toDecimal:u,fromUnitInfo:n},s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!~",l={};for(var a in CARDS)if(a<1e4){var t=FUSIONS[a];(!t||Number(t)<1e4)&&(l[a]=!0)}var o=1e3;function n(e){var a=parseInt(e.id),t=parseInt(e.level)-1;if(l[a]){var n=Math.floor(t/7);t=t%7}else{n=Math.floor(a/1e4);a%=1e4}var r=0;e.runes.length&&(r=parseInt(e.runes[0].id),r%=5e3);var i=a;return c(i=(i=7*(i=3*i+n)+t)*o+r,5)}function d(e){var a=u(e),t=a%o,n=(a=(a-t)/o)%7,r=(a=(a-n++)/7)%3,i=a=(a-r)/3;l[i]?n+=7*r:0<r&&(i=Number(r+""+i));var s=unitInfo.create(i,n);return 0<t&&s.runes.push({id:t+5e3}),s}function c(e,a){for(var t="",n=0;n<a;n++){var r=e%64;t+=s[r],e=(e-r)/64}return t}function u(e){for(var a=0,t=e.length-1;0<=t;t--){a*=64,a+=s.indexOf(e[t])}return a}return e}),define("cardApi",function(){var e={byId:r,byIdSlim:function(e,a){var t=l.loadCard(e.id),n={};"1"==t.card_type?(n.isCommander=function(){return!0},n.isAssault=function(){return!1}):(n.isCommander=function(){return!1},n.isAssault=function(){return!0});if(t){if(n.id=t.id,n.name=t.name,n.rarity=t.rarity,n.maxLevel=t.maxLevel,e.level?(n.level=e.level,n.level>n.maxLevel&&(n.level=n.maxLevel)):n.level=1,a){if(n.attack=t.attack,n.health=t.health,n.cost=t.cost,n.set=t.set,n.card_type=t.card_type,n.type=t.type,n.sub_type=t.sub_type||[],n.skill=t.skill,1<n.level)for(var r in t.upgrades){var i=t.upgrades[r];if(void 0!==i.cost&&(n.cost=i.cost),void 0!==i.health&&(n.health=i.health),void 0!==i.attack&&(n.attack=i.attack),void 0!==i.desc&&(n.desc=i.desc),0<i.skill.length&&(n.skill=i.skill),r==n.level)break}var s=e.runes;s&&(n.skill=n.skill.slice(),d(n,s),p(n.skill,s))}}else n.id=void 0,n.name=void 0,n.card_type=void 0,n.set=void 0,n.type=void 0,n.sub_type=[],n.level=void 0,n.maxLevel=void 0,a&&(n.skill=[]);return n},byIdWithBgeApplied:function(e,a,t){return a=a||SIMULATOR.battlegrounds.onCreate,r(e,a,null,t)},makeBattleground:a,applyDefaultStatuses:n},l=require("cardInfo"),k=require("skillApi"),o=require("runeApi"),t={attack_berserk:0,attack_valor:0,attack_rally:0,attack_weaken:0,attack_corroded:0,corrosion_timer:0,mark_target:0,barrier_ice:0,corroded:0,enfeebled:0,enraged:0,envenomed:0,heartseeker:0,imbued:0,invisible:0,nullified:0,poisoned:0,protected:0,scorched:0,warded:0,jammed:!1,jammedSelf:!1,silenced:!1,valor_triggered:!1,dualstrike_triggered:!1,ondeath_triggered:!1,reanimated:!1};function n(e){for(var a in e.removeImbue(),e.enhanced={},t)e[a]=t[a]}function d(e,a){e.runes||(e.runes=[]);for(var t=0,n=a.length;t<n;t++){var r=a[t].id,i=o.getRune(r).stat_boost;for(var s in e.runes.push({id:r,stat_boost:i}),i){var l=i[s];"skill"===s||(isNaN(l)&&(l=Math.max(Math.ceil(e[s]*l.mult),l.min_bonus||1)),e[s]+=parseInt(l))}}}function r(e,a,t,n){var r=l.loadCard(e.id);if(r){r.skill||(r.skill=[]);var i=s(r,e.level,e.runes,a,t,n);return e.priority&&(i.priority=e.priority),i}return console.log(e.id+" not found"),(r={}).id=e.id,r.level=e.level,r.name=void 0,r.health=void 0,r.skill=[],r}function p(e,a,t){if(a)for(var n=0,r=a.length;n<r;n++){var i=a[n].id,s=RUNES[i].stat_boost;for(var l in s){var o=s[l];if("skill"===l)for(var d=o.id,c=o.x,u=o.mult,p=0;p<e.length;p++){var f=e[p];if(f.id===d&&(f.all||0)==(o.all||0)){f=k.copySkill(f),!c&&u&&(c=Math.ceil(f.x*u)),o.min_bonus&&(c=Math.max(c,o.min_bonus)),c&&(f.x+=parseInt(c)*t),o.c&&(f.c-=Math.min(f.c,parseInt(o.c)*t)),f.boosted=!0,e[p]=f;break}}}}}var i,s=function(){var u;function g(e,a){return r({id:e.id,level:e.level})[a]}function b(e,a,t){for(var n in a){var r=a[n];r.x&&((r=k.copySkill(r)).x+=Math.ceil(r.x*t),r.boosted=!0,a[n]=r,e.highlighted.push(r.id))}}for(var e in u={p:null,health_left:0,timer:0,key:void 0,isCommander:function(){return"1"==this.card_type},isAssault:function(){return"2"==this.card_type},isTrap:function(){return"3"==this.card_type},isAlive:function(){return 0<this.health_left},isDamaged:function(){return this.health_left<this.health},isActive:function(){return 0==this.timer},isActiveNextTurn:function(){return this.timer<=1},isInactive:function(){return 1<=this.timer},isUnjammed:function(){return!this.jammed},isUnsilenced:function(){return!this.silenced},imbue:function(e){this.imbued||(this.imbued={});var a,t=this.imbued,n=e.id;switch(SKILL_DATA[n].type){case"toggle":return this[n]=!0,void(this.imbued[n]=1);case"passive":return this[n]+=parseInt(e.x),void(this.imbued[n]=(this.imbued[n]||0)+e.x);case"flurry":return void(this.flurry||(this.flurry=e,this.flurry.countdown=0,this.imbued.flurry=!0));case"onDeath":a="onDeathSkills";break;case"earlyActivation":a="earlyActivationSkills";break;case"activation":default:a="skill"}if(void 0===t[a]){var r=this[a];t[a]=r.length,this[a]=r.slice()}this[a].push(e)},scorch:function(e){var a=this.scorched;a?(a.amount+=e,a.timer=2):this.scorched={amount:e,timer:2}},removeImbue:function(){var e=this.imbued;if(e){for(var a in e){var t=e[a];"skill"===a||"earlyActivationSkills"===a||"onDeathSkills"===a?this[a]=this[a].slice(0,t):this[a]-=t}this.imbued=0}},hasSkill:function(e,a){var t;switch(SKILL_DATA[e].type){case"toggle":case"passive":case"flurry":return this[e];case"onDeath":t=this.onDeathSkills;break;case"earlyActivation":t=this.earlyActivationSkills;break;case"activation":default:t=this.skill}for(var n in t){var r=t[n];if(r.id===e&&(void 0===a||(r.all||0)==a))return!0}return!1},hasAttack:function(){return 0<this.adjustedAttack()},attackPlusBuffs:function(){return this.attack+this.attack_rally+this.attack_berserk+this.attack_valor},adjustedAttack:function(){return this.attack+this.attack_rally+this.attack_berserk+this.attack_valor-this.attack_weaken-this.attack_corroded},permanentAttack:function(){return this.attack+this.attack_berserk+this.attack_valor},isInFaction:function(e){if(void 0===e)return 1;var a=e.split(",");if(a.length<=1)return this.type==e?1:0<=this.sub_type.indexOf(e.toString())?1:0;for(var t=0;t<a.length;t++)if(!this.isInFaction(a[t]))return 0;return 1},resetTimers:function(){for(var e=0,a=this.skillTimers.length;e<a;e++)this.skillTimers[e].countdown=0},addRunes:function(e){d(this,e)}},SKILL_DATA){var a=SKILL_DATA[e].type;"passive"===a?u[e]=0:"toggle"===a&&(u[e]=!1)}return n(u),function(e,a,t,n,r,i){a||(a=1);var s=Object.create(u);s.id=e.id,s.name=e.name,s.attack=e.attack,s.health=e.health,s.maxLevel=e.maxLevel,s.level=a>s.maxLevel?s.maxLevel:a,s.cost=e.cost,s.rarity=e.rarity,s.card_type=e.card_type,s.type=e.type,s.sub_type=e.sub_type||[],s.set=e.set;var l,o=e.skill;if(1<s.level)for(var d in e.upgrades)if(void 0!==(l=e.upgrades[d]).cost&&(s.cost=l.cost),void 0!==l.health&&(s.health=l.health),void 0!==l.attack&&(s.attack=l.attack),void 0!==l.desc&&(s.desc=l.desc),0<l.skill.length&&(o=l.skill),d==s.level)break;if(o=o.slice(),n&&n.length&&function(a,e,t,n){a.highlighted=[];for(var r=0;r<t.length;r++){var i=t[r];if("statChange"==i.modifierType&&!n)for(var s=0;s<i.effects.length;s++){var l=i.effects[s];a.isInFaction(l.y)&&Object.keys(l).forEach(function(e){a[e]=l[e]})}}}(s,0,n,i),t){s.addRunes(t);var c=1;n&&n.forEach(function(e){"runeMultiplier"==e.modifierType&&e.effects.forEach(function(e){s.isInFaction(e.y)&&(c=parseInt(e.mult))})}),p(o,t,c)}else s.runes=[];return n&&n.length&&function(e,a,t,n){e.highlighted=[];for(var r=0;r<t.length;r++){var i=t[r];if("evolve_skill"===i.modifierType)for(var s=0;s<i.effects.length;s++){var l=i.effects[s];for(var o in a){var d=a[o];d.id==l.id&&d.all==l.all&&((d=k.copySkill(d)).id=l.s,d.boosted=!0,a[o]=d,e.highlighted.push(d.id))}}else if("add_skill"===i.modifierType)for(s=0;s<i.effects.length;s++){var c=i.effects[s];if(e.isInFaction(c.y)){if(c.rarity&&e.rarity!=c.rarity)continue;var u={};if(u.id=c.id,u.x=c.x||0,c.mult)if(c.base){var p=g(e,c.base);u.x+=Math.ceil(c.mult*p)}else u.mult=c.mult;if(u.z=c.z,u.c=c.c,u.s=c.s,u.all=c.all,c.card&&(u.card=c.card),c.level&&(u.level=c.level),u.boosted=!0,c.mult&&c.base&&0==u.x)continue;a.push(u),e.highlighted.push(u.id)}}else if("scale_attributes"!==i.modifierType||n){if("scale_stat"===i.modifierType&&!n)for(s=0;s<i.effects.length;s++)f=i.effects[s],e.isInFaction(f.y)&&(e[i.scaledStat]+=Math.ceil(g(e,f.base)*f.mult))}else for(var s=0;s<i.effects.length;s++){var f=i.effects[s];if(e.isInFaction(f.y)){var m=f.mult,h=Math.ceil(e.attack*m);e.attack+=h;var v=Math.ceil(e.health*m);e.health+=v,b(e,a,m)}}}}(s,o,n,i),r&&b(s,o,r),k.copySkills(s,o),s}}(),a=((i=function(e,a,t){this.name=e,k.copySkills(this,[a],t)}).prototype={p:null,name:null,runes:[],isCommander:function(){return!1},isAssault:function(){return!1},resetTimers:function(){for(var e=0,a=this.skillTimers.length;e<a;e++)this.skillTimers[e].countdown=0}},function(e,a,t){return new i(e,a,t)});return e}),define("unitInfo",function(){var e={areEqual:function(e,a){if(!e!=!a)return!1;var t=r.fromUnitInfo(e),n=r.fromUnitInfo(a);return t===n},getEnhancement:function(e,a,t){var n=e.enhanced,r=n&&n[a]||0;r<0&&(r=Math.ceil(t*-r));return r},initializeUnit:function(e,a,t){e.owner=a,e.timer=e.cost,e.health_left=e.health,n.applyDefaultStatuses(e),e.key=t,e.reusableSkills||e.resetTimers()},isImbued:function(e,a,t){var n;switch(SKILL_DATA[a].type){case"flurry":case"toggle":return e.imbued[a];case"passive":return e[a]===e.imbued[a];case"onDeath":n="onDeathSkills";break;case"earlyActivation":n="earlyActivationSkills";break;case"activation":default:n="skill"}return void 0!==e.imbued[n]&&t>=e.imbued[n]},create:a,elariaCaptain:a(202,1)},r=require("base64"),n=require("cardApi");function a(e,a,t){var n={id:Number(e),level:Number(a),runes:[]};return t&&(n.runes=t),n}return e}),define("bgeApi",function(){var e={getBattlegrounds:function(e,a,t,n,r,i,s,l){var o={onCreate:[],onTurn:[],onCardPlayed:[]};v(o,e),v(o,a,"player"),v(o,t,"cpu"),function(e,a,t){if(a)for(var n=a.split(","),r=0;r<n.length;r++){var i=n[r].split("-"),s=i[0],l=i[1],o=i[2],d=Object.keys(MAP_BATTLEGROUNDS).filter(function(e){return MAP_BATTLEGROUNDS[e].location_id==s})[0],c=(d=MAP_BATTLEGROUNDS[d]).effects[l].upgrades[o];h(e,c,t)}}(o,n,"player"),r?function(e,a,t){var n=CAMPAIGNS[a];if(n){var r=n.battleground_id;if(r){var i=BATTLEGROUNDS[r];if(t=Number(t)-1,!i.starting_level||Number(i.starting_level)<=t){if(i.scale_with_level){i=JSON.parse(JSON.stringify(i));for(var s=t-Number(i.starting_level),l=0;l<i.effect.length;l++){var o=i.effect[l];o.mult=o.base_mult+o.mult*s}}h(e,i,"cpu")}}}}(o,r,i):s&&function(e,a,t){var n=RAIDS[a].bge;if(n){var r=BATTLEGROUNDS[n];if(r&&Number(t)>=Number(r.starting_level))for(var i=r.enemy_only,s=0;s<r.effect.length;s++){var l=r.effect[s],o=l.effect_type;if("skill"===o){if(r.scale_with_level)var d=r.scale_with_level*(t-r.starting_level+1);else var d=1;var c=u.makeBattleground(r.name,l,d);c.enemy_only=i,e.onTurn.push(c)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(o)){var c=p(r.name,l);c.enemy_only=i,e.onCreate.push(c)}else if(0<=["scale_attack","scale_health"].indexOf(o)){var c=f(r.name,l);c.enemy_only=i,e.onCreate.push(c)}else if("trap_card"===o){var c=m(r.name,l);c.enemy_only=i,e.onCardPlayed.push(c)}}}}(o,s,l);return o}},d=require("log"),u=require("cardApi"),c=require("debugLog");function p(e,a){return{name:e,modifierType:a.effect_type,effects:[a]}}function f(e,a){return{name:e,modifierType:"scale_stat",scaledStat:a.effect_type.replace("scale_",""),effects:[a]}}var t,n,l=((t=function(e,a){this.p=null,this.name=e,this.effect=a,this.runes=[]}).prototype={onCardPlayed:function(e){SIMULATOR.onPlaySkills[this.effect.id](this,e,this.effect)},isCommander:function(){return!1},isAssault:function(){return!1}},function(e,a){return new t(e,a)}),m=((n=function(e,a){this.name=e,this.id=a.id,this.base=a.base,this.mult=a.mult,this.target_deck=a.target_deck,this.y=a.y}).prototype={onCardPlayed:function(e,a,t){var n="opponent"===this.target_deck?t:a;if(e.isInFaction(this.y)){for(var r=[],i=0;i<n.length;i++)(e=n[i]).trap||r.push(e);if(r.length){var s=Math.ceil(e[this.base]*this.mult),l=unitInfo.create(this.id,s),o=u.byId(l);r[~~(Math.random()*r.length)].trap=o,c.enabled&&c.appendLines(this.name+" inserts "+d.name(o)+" into the opposing deck.")}}}},function(e,a){return new n(e,a)});function h(e,a,t){for(var n=0;n<a.effect.length;n++){var r=a.effect[n],i=r.effect_type;if("skill"===i){var s=u.makeBattleground(a.name,r);"player"===t&&(s.ally_only=!0),"cpu"===t&&(s.enemy_only=!0),e.onTurn.push(s)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(i)){s=p(a.name,r);"player"===t&&(s.ally_only=!0),"cpu"===t&&(s.enemy_only=!0),e.onCreate.push(s)}else if(0<=["scale_attack","scale_health"].indexOf(i)){s=f(a.name,r);"player"===t&&(s.ally_only=!0),"cpu"===t&&(s.enemy_only=!0),e.onCreate.push(s)}else if("trap_card"===i){s=m(a.name,r);"player"===t&&(s.ally_only=!0),"cpu"===t&&(s.enemy_only=!0),e.onCardPlayed.push(s)}else if("on_play"===i){(s=l(a.name,r.effect)).attacker=r.attacker,s.defender=r.defender,s.first_play=r.first_play,"player"===t&&(s.ally_only=!0),"cpu"===t&&(s.enemy_only=!0),e.onCardPlayed.push(s)}}}function v(e,a,t){if(!a)return null;for(var n=a.split(","),r=0;r<n.length;r++){var i=n[r];h(e,BATTLEGROUNDS[i],t)}}return e}),define("cardUI",function(){"use strict";var h=require("cardApi"),F=require("cardInfo"),B=require("runeApi"),R=require("factions"),v=require("unitInfo"),a="";function n(e,a,t){var n=[],r=h.byId(e.commander);n.push(b(r,!1,!1));for(var i=0,s=e.deck.length;i<s;i++){var l=e.deck[i];if(t)var o=h.byIdWithBgeApplied(l,t);else o=h.byId(l);n.push(b(o,!1,!1))}if(!a)for(;i<15;i++)n.push(K("card blank"));return n}function o(e,a,t,n,r,i){var s,l,o;r=r||0;for(var d=0,c=[],u=0,p=e.length;u<p&&(!i||d<i);u++){var f=e[u],m=h.byId(f);v.areEqual(m,l)?o++:(r<=d&&(g(s,o),(s=b(m,a,!(o=1),t,n,null,u)).setAttribute("data-i",u),void 0!==f.index&&s.setAttribute("data-index",f.index),c.push(s)),l=m,d++)}return g(s,o),c}function i(e,a,t,n,r){a||(a=[]);var i=[];if(n){var s=document.createElement("h1");s.innerHTML="Turn: "+n+" (Currently at "+SIMULATOR.calculatePoints(!0)+" points)",i.push(s)}var l=K("field"),o=null;if(r){o=r.owner;r=r.isCommander()?-1:r.key}return"player"===o?(l.appendChild(d(e.cpu)),l.appendChild(d(e.player,r))):(l.appendChild(d(e.cpu,r)),l.appendChild(d(e.player))),i.push(l),i.push(c(a,t,n)),i.push(document.createElement("br")),i.push(document.createElement("br")),i}function d(e,a){var t=K("float-left"),n=b(e.commander,!1,!0);-1===a&&u(n),t.appendChild(n);var r=e.assaults;if(r)for(var i=0,s=r.length;i<s;i++){var l=r[i];n=b(l,!1,!0);l.timer&&n.classList.add("inactive"),a===i&&u(n),t.appendChild(n)}return t}function c(e,a,t){for(var n=K("float-left hand"),r=0,i=e.length;r<i;r++){var s=e[r];if(s){var l=b(s,!1);0===r?l.classList.add("left"):2===r?l.classList.add("right"):2<r&&l.classList.add("inactive");a&&l.addEventListener("click",function(e){return function(){choice=e,a(t)}}(r)),n.appendChild(l)}}return n}function u(e){e.style.outline="5px solid LawnGreen"}function g(e,a){var t=parseInt(a);if(t==a&&(a=1<t?t:null),a){var n=K("multiplier","x"+a);n.setAttribute("data-count",a);var r=z(G("cardAssets")+"multiplier.png","multiplier");e.appendChild(r),e.appendChild(n)}}function b(e,a,t,n,r,i,s){var l=K("card");l.setAttribute("data-id",e.id),l.setAttribute("data-level",e.level);for(var o=e.runes,d=[],c={},u=0,p=o.length;u<p;u++){var f=o[u].id;d.push(o[u].id);var m=B.getRune(f);for(var h in m.stat_boost)"skill"==h&&(h=m.stat_boost.skill.id),c[h]=!0}var v=e.highlighted;if(v)for(u=0;u<v.length;u++){c[h=v[u]]=!0}l.setAttribute("data-runeids",d.join(","));var g=F.loadCard(e.id).picture;if(g){var b=document.createElement("i");0==g.indexOf("portrait_")?b.className="portrait portrait-"+g:b.className="sprite sprite-"+g,l.appendChild(b)}e.isCommander()&&l.classList.add("commander"),l.classList.add(R.names[e.type].toLowerCase());var k=K("card-name",(void 0!==e.uid?"("+e.uid+") ":"")+e.name),y=K("card-id","("+e.id+")");if(k.appendChild(y),l.appendChild(k),!e.isCommander()){if(0<=e.attack){if(t){e.isUnjammed()||l.classList.add("frozen");var _=K("card-attack",e.adjustedAttack().toString());e.adjustedAttack()>e.attack?_.classList.add("increased"):e.adjustedAttack()<e.attack?_.classList.add("decreased"):c.attack&&_.classList.add("increased")}else _=K("card-attack",e.attack.toString());l.appendChild(z(G("cardAssets")+"Attack.png","attack")),l.appendChild(_)}0<=e.cost&&(t?e.timer&&(l.appendChild(K("delay",e.timer)),l.appendChild(z(G("cardAssets")+"Timer.png","timer"))):(l.appendChild(K("delay",e.cost)),l.appendChild(z(G("cardAssets")+"Timer.png","timer"))))}if(0<=e.health){if(t){var w=K("card-health",e.health_left.toString());e.health_left<e.health?w.classList.add("decreased"):c.health&&w.classList.add("increased")}else{w=K("card-health",e.health.toString());c.health&&w.classList.add("increased")}l.appendChild(z(G("cardAssets")+"Health.png","health")),l.appendChild(w)}var A=K("card-skills"),L=K("card-skills-short");e.earlyActivationSkills&&H(e,A,L,e.earlyActivationSkills,t),H(e,A,L,e.skill,t),e.onDeathSkills&&H(e,A,L,e.onDeathSkills,t),function(a,t,n,r,i){Object.getOwnPropertyNames(SKILL_DATA).filter(function(e){return 0<=["passive","toggle"].indexOf(SKILL_DATA[e].type)}).forEach(function(e){!function(e,a,t,n,r,i){var s=n[r];if(s){var l={id:r,x:s,boosted:i[r]};e.appendChild(q(n,l,t)),e.appendChild(document.createElement("br")),a.appendChild(j(l.id))}}(a,t,r,n,e,i)});var e=n.flurry;e&&(a.appendChild(q(n,e,r)),a.appendChild(document.createElement("br")),t.appendChild(j(e.id)))}(A,L,e,t,c);var S,I,D=A.cloneNode(!0);if(D.className="card-skills-detailed",L.hasChildNodes()&&(a?(l.appendChild(L),l.appendChild(A)):l.appendChild(D)),l.appendChild(K("faction")),t){var C=function(e){var a=[];if(e.enfeebled){var t=V("enfeeble",e.enfeebled);a.push(t)}if(e.marked){var t=V("enfeeble",e.marked);a.push(t)}if(e.nullified){var t=V("nullify",e.nullified);a.push(t)}if(e.poisoned){var t=V("poison",e.poisoned);a.push(t)}if(e.scorched&&e.scorched.amount){var t=V("burn",e.scorched.amount);a.push(t)}var n=[];if(e.enraged){var t=V("enrage",e.enraged);a.push(t)}if(e.protected){var t=V("protect",e.protected);n.push(t)}if(e.invisible){var t=V("evade",e.invisible);n.push(t)}var r=[];if(0<a.length){for(var i=K("card-debuffs"),s=0,l=a.length;s<l;s++)i.appendChild(a[s]);r.push(i)}if(0<n.length){for(var o=K("card-buffs"),s=0,l=n.length;s<l;s++)o.appendChild(n[s]);r.push(o)}return r}(e);if(0<C.length){l.appendChild(K("hidden","..."));var $=K("card-statuses");for(u=0;u<C.length;u++){var T=C[u];$.appendChild(T)}l.appendChild($)}}if(e.set){var x=(S=e.set,I=J[S],z(G("cardAssets")+I+".png"));x.className="set",l.appendChild(x)}var E=e.sub_type;if(E.length){var N=K("subfaction");for(u=0;u<E.length;u++){var P=E[u];if(P){var M=W(P);N.appendChild(M)}}l.appendChild(N)}if(0<e.rarity){if(e.maxLevel>Number(e.rarity)+2)var U=z(G("cardAssets")+"Level_"+e.rarity+"_"+e.maxLevel+"_"+e.level+".png");else U=z(G("cardAssets")+"Level_"+e.rarity+"_"+e.level+".png");if(U.className="level",9999<e.id){var O="1"==e.id.toString()[0]?"Dualfuse":"Quadfuse";(O=z(G("cardAssets")+O+".png")).className="fusion",l.appendChild(O)}l.appendChild(U)}else if(1<e.maxLevel){(U=z(G("cardAssets")+e.maxLevel+"_"+e.level+".png")).className="level",l.appendChild(U)}return n&&l.addEventListener("click",function(){return n(l,s)}),r&&(l.oncontextmenu=function(){return r(l,s)}),i&&(l.onmouseover=function(){return i(l,s)}),l}function H(e,a,t,n,r){for(var i=0;i<n.length;i++){var s=n[i];a.appendChild(q(e,s,r,i)),a.appendChild(document.createElement("br")),t.appendChild(j(s.id))}}function q(e,a,t,n){var r=document.createElement("span");r.className="skill",r.appendChild(j(a.id));var i=v.isImbued(e,a.id,n),s=v.getEnhancement(e,a.id,a.x);i?r.classList.add("imbued"):(a.boosted||s)&&r.classList.add("increased"),a.all&&(r.innerHTML+=" All "),a.y&&r.appendChild(W(a.y)),a.s&&r.appendChild(j(a.s));var l=(0|a.x)+s;return l&&(r.innerHTML+=" "+l+" "),a.c&&(r.innerHTML+=a.c,t&&(r.innerHTML+=" ("+(a.countdown?a.countdown:"0")+")")),r}function j(e){var a=G("skills"),t=SKILL_DATA[e],n=z(a+=(t?t.icon:e)+".png");switch(e){case"weakenself":case"enlarge":n.classList.add("affect-self")}return n.title=t?t.name:e,n}function V(e,a){var t=document.createElement("span");return t.appendChild(j(e)),a&&(t.innerHTML+=a),t}function W(e){var a=R.names[e];return z(G("factions")+a+".png")}function G(e){return a+"res/"+e+"/"}function z(e,a){return $("<img>").addClass(a).attr("src",e)[0]}function K(e,a){return $("<div>").addClass(e).html(a)[0]}var J={1e3:"Basic",1100:"Legacy",7e3:"Basic",2e3:"Reward",2100:"Reward",3e3:"Premium",4e3:"BoxOnly",5e3:"Champion",5100:"Champion",9999:"StoryElements"},e={clearCardSpace:function(){$("#cardSpace").empty()},clearDeckSpace:function(){document.getElementById("deck").innerHTML=""},draw_deck:function(e,a){var t=$("#deck");return t.children().remove(),t.append(n(e,a)),t},create_card_html:b,makeDeckHTML:n,makeCardListHTML:function(e,a,t){for(var n=K("float-left"),r=0,i=e.deck.length;r<i;r++){var s=e.deck[r],l=b(h.byId(s),!1,!1,a,t,null,r);void 0!==s.index&&l.setAttribute("data-index",s.index),n.appendChild(l)}return n},draw_card_list:function(e,a,t,n,r,i){var s=o(e,a,null,null,r,i),l=$("#cardSpace");return l.empty(),l.append(s),l},draw_cards:function(e,a,t,n){var r=i(e,a,t,n);$("#cardSpace").children().remove().end().append(r)},doDrawField:i,draw_inventory:function(e){var a=o(e.deck),t=$("#deck");return t.children().remove(),t.append(o([e.commander])),t.append(a),t},draw_hand:c,createItemHTML:function(e,a,t){var n=K("card item"),r=document.createElement("i");r.className="sprite sprite-Item",n.appendChild(r),t&&((t=z(G("items")+t+".png")).className="item-image",n.appendChild(t));var i=K("card-name",e);return n.appendChild(i),n.classList.add("factionless"),n.appendChild(K("faction")),g(n,a),n},addMult:g,addWeight:function(e,a){if(0<a){var t=K("weight",(100*a).toFixed(2)+"%");t.setAttribute("data-count",a);var n=z(G("cardAssets")+"multiplier.png","weight");e.appendChild(n),e.appendChild(t)}}};return Object.defineProperties(e,{assetsRoot:{get:function(){return a},set:function(e){a=e}}}),e}),define("loadDeck",function(){var d=require("cardInfo"),k=require("cardApi"),e=require("unitInfo");function y(e){for(var a=function(e){for(var a,t=e.id;void 0!==(t=REVERSE_FUSIONS[a=t]););return a}(e),t=-1;void 0!==a;)t++,a=FUSIONS[a];return t}function _(e,a,t){if(a=parseInt(a),e.mastery_level&&a<parseInt(e.mastery_level))return null;if(e.remove_mastery_level&&a>=parseInt(e.remove_mastery_level))return null;var n=e.id,r=!1;n||(n=function(e){var a=[];for(var t in CARDS)if(!REVERSE_FUSIONS[t]){var n=CARDS[t];if("1"!=n.card_type&&!(e.max_rarity&&Number(e.max_rarity)<Number(n.rarity)||e.min_rarity&&Number(e.min_rarity)>Number(n.rarity))&&(!e.type||e.type==n.type||0<=n.sub_type.indexOf(e.type.toString()))){if(e.set&&e.set.split(",").indexOf(n.set)<0)continue;a.push(t)}}return a[~~(Math.random()*a.length)]}(e),r=!0);var i=e.level||1;if(t<=a)i=7,c(n)&&(n=u(n));else if(1<a&&d.isCommander(n)){var s=(Number(d.loadCard(n).rarity)+1)/(t-1),l=a-1;i=Math.ceil(s*l)}var o=e.create(n,i);return r&&(o.randomInfo={unitInfo:e,level:a,maxedAt:t}),o}function w(e){var a=parseInt(d.loadCard(e.id).rarity)+2;if(e.level==a){if(!c(e.id))return!1;e.id=u(e.id,1),e.level=1}else e.level++;return!0}function c(e){return!(-1<i.indexOf(e))&&(!d.isCommander(e)&&!!FUSIONS[e])}function u(e,a){if(-1==i.indexOf(e))if(a)for(var t=0;t<a;t++)e=r(e);else do{var n=r(e);e=n}while(e!==n);return e}function r(e){var a=FUSIONS[e];return a||e}var i=["8005","8006","8007","8008","8009","8010"];function s(e,a,t){var n=t+1;a||(a=n);var r=[];r.deck=[];var i=function(e,a){a=parseInt(a);var t=e.commander;if(t.card){for(var n=[],r=0;r<t.card.length;r++){var i=t.card[r],s=parseInt(i.min_mastery_level)||0,l=parseInt(i.max_mastery_level)||999;s<=a&&a<=l&&n.push(i)}(t=n[~~(Math.random()*n.length)]).possibilities=n}return t}(e,a),s=_(i,a,n);i.possibilities&&(s.randomInfo={possibilities:i.possibilities,level:a,maxedAt:n}),r.commander=s;var l=e.deck,o=r.deck;for(var d in l){var c=_(l[d],a,n);c&&o.push(c)}var u,p,f,m,h=function(e){for(var a=0,t=0;t<e.length;t++){var n=e[t],r=k.byId(n);a+=(y(r)+1)*r.maxLevel-1}return a}(o),v=(u=a,f=h,m=7==(p=n)?(u-1)/(p-1):u/p,Math.ceil(f*m));if(1<a&&a<n)for(var g=o.slice();0<v&&0<g.length;){var b=Math.floor(Math.random()*g.length);w(g[b])?v--:g.splice(b,1)}return r}function t(e){for(var a=[],t=0,n=e.length;t<n;t++)a[t]=e[t];return a}return{mission:function(e,a){var t=MISSIONS[e];return t?s(t,a,6):0},raid:function(e,a,t){t||(t=25);var n=RAIDS[e];{if(n){var r={commander:n.commander,deck:n.deck.card};return s(r,a,Number(n.upgradeLevels))}return 0}},defaultDeck:function(){return{commander:e.defaultCommander,deck:[]}},copyCardList:t,copyDeck:function(e){var a={};return a.commander=e.commander,a.deck=t(e.deck),a},getDeckCards:function(e,a){var t={};t.commander=k.byId(e.commander),t.deck=[];for(var n=e.deck,r=SIMULATOR.battlegrounds.onCreate.filter(function(e){return!("player"===a&&e.enemy_only||"cpu"===a&&e.ally_only)}),i=0,s=n.length;i<s;i++)t.deck.push(k.byIdWithBgeApplied(n[i],r));return t}}}),define("animations",function(){var s=require("cardUI"),e={areShown:!1,drawField:function(e,a,t,n,r){var i=s.doDrawField(e,a,t,n,r);l.push(i),o||(d(),o=setInterval(d,500))},clearFrames:function(){l=[],clearInterval(o),o=null}},l=[],o=null,a=!1;function d(){if(0===l.length)a?(clearInterval(o),o=null):a=!0;else{var e=l.splice(0,1)[0];$("#cardSpace").children().remove().end().append(e),a=!1}}return e}),define("simController",function(){"use strict";var n=require("matchTimer"),t=require("debugLog"),r=require("animations"),i={getConfiguration:function(){getdeck=$("#deck1").val(),getordered=$("#ordered").is(":checked"),getexactorder=$("#exactorder").is(":checked"),getdeck2=$("#deck2").val();var e=$("#campaign").val();getmission=$("#mission").val(),missionlevel=$("#mission_level").val(),getraid=$("#raid").val(),raidlevel=$("#raid_level").val(),getordered2=$("#ordered2").is(":checked"),getexactorder2=$("#exactorder2").is(":checked"),surge=$("#surge").is(":checked"),getsiege=$("#siege").is(":checked"),tower_level=$("#tower_level").val(),tower_type=$("#tower_type").val(),BATTLEGROUNDS&&(getbattleground=getSelectedBattlegrounds(),selfbges=getSelectedBattlegrounds("self-"),enemybges=getSelectedBattlegrounds("enemy-"),mapbges=getmission?getSelectedMapBattlegrounds():"");sims_left=$("#sims").val()||1,t.enabled=$("#debug").is(":checked"),(play_debug=t.enabled&&$("#play_debug").is(":checked"))&&(t.enabled=!1);if(mass_debug=$("#mass_debug").is(":checked"),win_debug=$("#win_debug").is(":checked"),loss_debug=$("#loss_debug").is(":checked"),r.areShown=$("#animations").is(":checked"),$("#auto_mode").length){var a=$("#auto_mode").is(":checked");SIMULATOR.user_controlled=!a}return tournament=$("#tournament").is(":checked"),{getdeck:getdeck,getordered:getordered,getexactorder:getexactorder,getdeck2:getdeck2,selectedCampaign:e,getmission:getmission,missionlevel:missionlevel,getraid:getraid,raidlevel:raidlevel,getordered2:getordered2,getexactorder2:getexactorder2,surge:surge,getsiege:getsiege,tower_level:tower_level,tower_type:tower_type,getbattleground:getbattleground,selfbges:selfbges,enemybges:enemybges,mapbges:mapbges,sims_left:sims_left,play_debug:play_debug,mass_debug:mass_debug,win_debug:win_debug,loss_debug:loss_debug,auto_mode:a,tournament:tournament}},debug_end:function(e){var a,e=i.processSimResult();sims_left=0,n.stop();var t="";getdeck2&&(t=" ("+SIMULATOR.calculatePoints()+" points)");a="draw"==e?"<br><h1>DRAW"+t+"</h1><br>":e?"<br><h1>WIN"+t+"</h1><br>":"<br><h1>LOSS"+t+"</h1><br>";outputTurns(),setSimStatus(a),showUI(),SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(SIMULATOR.simulation_turns);i.end_sims_callback&&i.end_sims_callback()},end_sims_callback:null,stop_sims_callback:null};return window.SIM_CONTROLLER=i}),SKILL_DATA){var skillInfo=SKILL_DATA[skillID];"flurry"===skillID?skillInfo.type="flurry":0<=["turnStart","onAttack","onDamaged","turnEnd"].indexOf(skillInfo.type)&&(skillInfo.type="passive")}var REVERSE_FUSIONS={};for(var id in FUSIONS){var fusion=FUSIONS[id];REVERSE_FUSIONS[fusion]=id}var storageAPI=require("storageAPI");function shuffle(e){var a,t,n,r=e.length;if(0==r)return!1;for(;--r;)a=~~(Math.random()*(r+1)),t=e[r],n=e[a],e[r]=n,e[a]=t}window.loadCardCache=function(){var e=storageAPI.getField("GameData","CardCache");if(e&&e.lastUpdated>DataUpdated)e.newCards&&($.extend(CARDS,e.newCards),$.extend(FUSIONS,e.newFusions)),DataUpdated=e.lastUpdated;else{var a={newCards:{},newFusions:{},lastUpdated:Date.now()};storageAPI.setField("GameData","CardCache",a)}},function(){var a=require("bgeApi"),s=require("matchTimer"),e=require("urlHelpers"),l=require("debugLog"),o=require("simController");function d(){if(SIMULATOR.user_controlled)c(!0)&&o.debug_end();else if(!l.enabled&&!play_debug||mass_debug||loss_debug||win_debug)if(0<sims_left){if(p<=u){var e=0;if(0<p){u=0;var a=games/(games+sims_left)*100;a=a.toFixed(2);var t=s.elapsed(),n=s.batchElapsed();setSimStatus("Running simulations...",t,(e=0==n?0:p/n).toFixed(1)),showWinrate()}(p=1)<e&&(p=Math.ceil(e/8)),sims_left<p&&(p=sims_left),(l.enabled||play_debug)&&(mass_debug||loss_debug||win_debug)&&(p=1),s.startBatch(),current_timeout=setTimeout(d,1);for(var r=0;r<p;r++)c()}}else{p=u=0,s.stop();t=s.elapsed();var i=games/t;i=i.toFixed(2),outp(l.getLog()),setSimStatus("Simulations complete.",t,i),showWinrate(),showUI(),o.end_sims_callback&&o.end_sims_callback()}else c(!0),o.debug_end()}o.startsim=function(){total_turns=0,s.reset(),l.clear(),p=games=0;var e=o.getConfiguration();return SIMULATOR.battlegrounds=a.getBattlegrounds(getbattleground,selfbges,enemybges,mapbges,e.selectedCampaign,missionlevel,getraid,raidlevel),hideUI(),SIMULATOR.setupDecks(),points=draws=losses=wins=0,outp(""),SIMULATOR.user_controlled?setSimStatus(""):(hideTable(),setSimStatus("Initializing simulations...")),window.ga("send","event","simulation","start","single-threaded",sims_left),current_timeout=setTimeout(d),!1},o.stopsim=function(){s.stop();var e=s.elapsed(),a=games/e;a=a.toFixed(2),SIMULATOR.simulating=!1,current_timeout&&clearTimeout(current_timeout),SIMULATOR.user_controlled||(setSimStatus("Simulations interrupted.",e,a),showWinrate()),showUI(),o.stop_sims_callback&&o.stop_sims_callback()};var t=e.paramValue("seedtest")||0;function c(e){if(t&&Math.seedrandom(t++),!SIMULATOR.simulate())return!1;e||o.processSimResult()}o.processSimResult=function(){var e;return e=!!SIMULATOR.field.player.commander.isAlive()&&(!SIMULATOR.field.cpu.commander.isAlive()||"draw"),0<p&&(0<sims_left&&sims_left--,u++),"draw"==e?draws++:e?wins++:losses++,points+=SIMULATOR.calculatePoints(),games++,total_turns+=SIMULATOR.simulation_turns,(l.enabled||play_debug)&&(loss_debug?"draw"===e?(l.prependLines("Draw found after "+games+" games. Displaying debug output...",""),l.appendLines("","<h1>DRAW</h1>"),sims_left=0):e?(l.clear(),sims_left||l.appendLines("No losses found after "+games+" games. No debug output to display.")):(l.prependLines("Loss found after "+games+" games. Displaying debug output...",""),l.appendLines("","<h1>LOSS</h1>"),sims_left=0):win_debug?e&&"draw"!==e?(l.prependLines("Win found after "+games+" games. Displaying debug output...",""),l.appendLines("","<h1>WIN</h1>"),sims_left=0):(l.clear(),sims_left||l.appendLines("No wins found after "+games+" games. No debug output to display.")):mass_debug&&(l.appendLines(""),"draw"===e?l.appendLines("<h1>DRAW</h1>"):e?l.appendLines("<h1>WIN</h1>"):l.appendLines("<h1>LOSS</h1>")),mass_debug&&sims_left&&l.appendLines("","<hr>NEW BATTLE BEGINS<hr>")),e};var u=0,p=0}();var loadDeckDialog,mapBGEDialog,SIMULATOR={};!function(){var C=require("log"),s=require("cardApi"),i=require("skillApi"),e=require("base64"),$=require("unitInfo"),t=require("loadDeck"),T=require("debugLog"),x=require("animations"),n=require("simController"),r=100;function d(e,a,t,n){var r=ae[a].assaults;if(!e.id)return 0;var i=r.length;if($.initializeUnit(e,a,i),e.played=!0,e.isAssault()&&(r[i]=e),!T.enabled&&!play_debug||n||T.appendLines(C.name(ae[a].commander)+" plays "+C.name(e)),e.isTrap())g(e),L(e);else for(var s=0;s<Z.onCardPlayed.length;s++){var l=Z.onCardPlayed[s],o="player"===a?"cpu":"player";if(l.defender){if(!surge&&"cpu"!==a)continue;if(surge&&"player"!==a)continue;l.owner=o}else if(l.attacker){if(!surge&&"player"!==a)continue;if(surge&&"cpu"!==a)continue;l.owner=a}else{if(l.enemy_only&&"cpu"!==a)continue;if(l.ally_only&&"player"!==a)continue;l.owner=a}1<t&&l.first_play||l.onCardPlayed(e,ee[a].deck,ee[o].deck)}x.areShown&&x.drawField(ae,null,null,t)}function v(e){for(var a=ae[e].assaults,t=0,n=a.length;t<n;t++){var r=a[t];if(!r.isAlive()){T.enabled&&T.appendLines(C.name(r)+" <strong>is removed from field</strong>");var i=t;for(t++;t<n;t++)(r=a[t]).isAlive()?(a[r.key=i]=r,i++):T.enabled&&T.appendLines(C.name(r)+" <strong>is removed from field</strong>");a.length=i;break}}}function k(e){return[e[~~(Math.random()*e.length)]]}function y(e){return e.owner}function b(e){return"cpu"==e.owner?"player":"player"==e.owner?"cpu":void 0}function E(e,a,t,n,r){t>=a.health_left?a.health_left=0:a.health_left-=t,T.enabled&&r(e,a,t),n&&N(a),!a.isAlive()&&e&&P(a,e)}function N(e){var a=e.barrier_ice,t=ae[b(e)],n=t.assaults[e.key];n&&n.isAlive()||(n=t.commander),E(e,n,a,null,function(e,a,t){T.append(C.name(e)+"'s barrier shatters and hits "+C.name(a)+" for "+t+" damage"),T.appendLines(a.isAlive()?"":" and it dies")})}function c(e,a){return e[a]||l}function l(e,a){if(T.enabled){var t=SKILL_DATA[a.id]?SKILL_DATA[a.id].name:a.id;T.appendLines(C.name(e)+" attempts to use "+t+", but it is not implemented.")}return 0}function g(e){var a=e.earlyActivationSkills,t=a.length;if(t)if(e.silenced)T.enabled&&T.appendLines(C.name(e)+" is silenced and cannot use skills");else{var n=e.dualstrike_triggered;T.enabled&&n&&T.appendLines(C.name(e)+" activates dualstrike");for(var r=n?2:1,i=u(e),s=0;s<r;s++)for(var l=0;l<t&&i();l++){var o=a[l];if(!o.countdown){var d=c(m,o.id)(e,o);o.c&&0<d&&(o.countdown=o.c),x.areShown&&x.drawField(ae,null,null,se,e)}}}}function a(){return!0}function u(e){return e.isAlive?e.isAlive.bind(e):a}function P(e,a){if(!e.ondeath_triggered){var t=e.onDeathSkills,n=t.length;if(0!=n){for(var r=0;r<n;r++){var i=t[r];A[i.id](e,a,i),x.areShown&&x.drawField(ae,null,null,se,e)}e.ondeath_triggered=!0}}}var o=["backlash","counter","counterburn","counterpoison","armored","evade","stasis"];function _(e){return-1===o.indexOf(e)}function w(e,a){if(e.isAssault()&&a.isAlive()){var t=a.backlash;X(e,a,"Backlash",t,$.getEnhancement(a,"backlash",t))}}function M(e){return e.isActive()&&e.isUnjammed()?0:e.stasis||0}var p={burnself:function(e,a){var t=a.x;return e.scorched?(e.scorched.amount+=t,e.scorched.timer=2):e.scorched={amount:t,timer:2},T.enabled&&T.appendLines(C.name(e)+" inflicts scorch("+t+") on itself"),1},scorchbreath:function(e,a){return p.burn(e,a)},burn:function(e,a){var t,n=b(e),r=ae[n].assaults;switch(a.id){case"scorchbreath":var i=Math.max(0,e.key-1),s=Math.min(r.length,e.key+2);t=r.slice(i,s);break;case"burnself":t=[e];break;default:t=r.slice(e.key,e.key+1)}if(!t.length)return 0;var l=a.x;l+=$.getEnhancement(e,"burn",l);for(var o=0,d=0;d<t.length;d++){var c=t[d];c.scorched?(c.scorched.amount+=l,c.scorched.timer=2):c.scorched={amount:l,timer:2},T.enabled&&T.appendLines(C.name(e)+" inflicts scorch("+l+") on "+C.name(c)),o++}return o},protect_ice:function(e,a){return p.protect(e,a,"barrier_ice")},protect_seafolk:function(e,a){return p.protect(e,a,null,null,!0)},evadebarrier:function(e,a){return p.protect(e,a,"invisible",function(e,a){return" and imbues it with invisible "+a})},protect:function(e,a,t,n,r){for(var i=a.y,s=y(e),l=a.x,o=a.all,d=ae[s].assaults,c=[],u=0,p=d.length;u<p;u++){!(h=d[u]).isAlive()||!h.isInFaction(i)||r&&h.isActive()||c.push(u)}if(!c.length)return 0;o||(c=k(c));var f=$.getEnhancement(e,a.id,l);l+=f;var m=0;for(u=0,p=c.length;u<p;u++){var h;if((h=d[c[u]]).nullified)h.nullified--,T.enabled&&T.appendLines(C.name(e)+" protects "+C.name(h)+" but it is nullified!");else{m++;var v=l;if(!v){var g=a.mult;h.isActive()||(g+=a.on_delay_mult||0),v=Math.ceil(h.health*g)}if(h.protected+=v,t&&(h[t]=(h[t]||0)+v),T.enabled){f&&T.appendLines("<u>(Enhance: +"+f+")</u>");var b=C.name(e)+" barriers "+C.name(h)+" by "+v;"function"==typeof n&&(b+=n(h,v)),T.appendLines(b)}}}return m},heal:function(e,a){for(var t=y(e),n=a.y,r=a.x,i=a.all,s=ae[t].assaults,l=[],o=0,d=s.length;o<d;o++){(p=s[o]).isAlive()&&p.isInFaction(n)&&(i||p.isDamaged())&&l.push(o)}if(!l.length)return 0;i||(l=k(l));var c=$.getEnhancement(e,a.id,r);r+=c;var u=0;for(o=0,d=l.length;o<d;o++){var p;if((p=s[l[o]]).nullified)p.nullified--,T.enabled&&T.appendLines(C.name(e)+" heals "+C.name(p)+" but it is nullified!");else{u++;var f=r;if(!f){var m=a.mult;f=Math.ceil(p.health*m)}f>p.health-p.health_left&&(f=p.health-p.health_left),p.health_left+=f,T.enabled&&(c&&T.appendLines("<u>(Enhance: +"+c+")</u>"),T.appendLines(C.name(e)+" heals "+C.name(p)+" by "+f))}}return u},poisonstrike:function(e,a,t){return p.strike(e,a,!0)},strike:function(e,n,a){for(var t=b(e),r=n.x,i=n.y,s=n.all,l=ae[t].assaults,o=[],d=0,c=l.length;d<c;d++){(f=l[d]).isAlive()&&f.isInFaction(i)&&o.push(d)}if(!o.length)return 0;s||(o=k(o));var u=$.getEnhancement(e,n.id,r);r+=u;var p=0;for(d=0,c=o.length;d<c;d++){var f;if((f=l[o[d]]).invisible)f.invisible--,T.enabled&&T.appendLines(C.name(e)+" bolts "+C.name(f)+" but it is invisible!");else{p++;var m=r,h=z(f,m);m=h.damage;var v=h.shatter,g=0;0<m&&a&&f.isAlive()&&r>f.poisoned&&(g=r,f.poisoned=g),E(e,f,m,v,function(e,a,t){T.appendLines("<u>(Strike: +"+n.x),u&&T.appendLines(" Enhance: +"+u),T.appendLines(h.echo),T.appendLines(") = "+t+" damage</u>"),T.appendLines(C.name(e)+" bolts "+C.name(a)+" for "+t+" damage"),a.isAlive()?g&&T.appendLines(" and inflicts poison("+g+") on it"):T.appendLines(" and it dies"),T.appendLines("")}),f.backlash&&w(e,f)}}return p},intensify:function(e,a,t){for(var n=b(e),r=a.x,i=a.y,s=a.all,l=ae[n].assaults,o=[],d=0,c=l.length;d<c;d++){(p=l[d]).isAlive()&&p.isInFaction(i)&&(p.scorched||p.poisoned)&&o.push(d)}if(!o.length)return 0;s||(o=k(o)),r+=$.getEnhancement(e,a.id,r);var u=0;for(d=0,c=o.length;d<c;d++){var p,f=(p=l[o[d]]).scorched?"scorch":"";f+=p.poisoned?f?" and poison":"poison":"",p.invisible?(p.invisible--,T.enabled&&T.appendLines(C.name(e)+" intensifies "+f+" on "+C.name(p)+" but it is invisible!")):(u++,p.scorched&&(p.scorched.amount+=r),p.poisoned&&(p.poisoned+=r),T.enabled&&T.appendLines(C.name(e)+" intensifies "+f+" on "+C.name(p)+" by "+r),p.backlash&&w(e,p))}return u},ignite:function(e,a,t){for(var n=b(e),r=(a.x,a.y),i=(a.all,ae[n].assaults),s=[],l=0,o=i.length;l<o;l++){var d=i[l];d.isAlive()&&d.isInFaction(r)&&s.push(l)}return f(e,a,"ignites",s,i,function(e,a){e.scorch(a)})},jamself:function(e,a){return e.jammed=!0,e.jammedSelf=!0,T.enabled&&T.appendLines(C.name(e)+" freezes itself"),1},jam:function(e,a){y(e);for(var t=b(e),n=a.all,r=ae[t].assaults,i=[],s=0,l=r.length;s<l;s++){(d=r[s]).isAlive()&&(n||d.isActiveNextTurn()&&d.isUnjammed())&&i.push(s)}if(!i.length)return 0;n||(i=k(i));var o=0;for(s=0,l=i.length;s<l;s++){var d;(d=r[i[s]]).invisible?(d.invisible--,a.countdown=0,T.enabled&&T.appendLines(C.name(e)+" freezes "+C.name(d)+" but it is invisible!")):(o++,d.jammed=!0,T.enabled&&T.appendLines(C.name(e)+" freezes "+C.name(d)),d.backlash&&w(e,d))}return o},frost:function(e,n){y(e);var a=b(e),t=n.x,r=$.getEnhancement(e,n.id,t);t+=r;n.all;for(var i=ae[a].assaults,s=[],l=e.key-1,o=l+2;l<=o;l++){(p=i[l])&&p.isAlive()&&s.push(l)}if(!s.length)return 0;for(var d=0,c=0,u=s.length;c<u;c++){var p;if((p=i[s[c]]).invisible)p.invisible--,T.enabled&&T.appendLines(C.name(e)+" breathes frost at "+C.name(p)+" but it is invisible!");else{d++;var f=t,m=z(p,f);E(e,p,f=m.damage,m.shatter,function(e,a,t){T.appendLines("<u>(Frostbreath: +"+n.x),r&&T.appendLines(" Enhance: +"+r),T.appendLines(m.echo),T.appendLines(") = "+t+" damage</u>"),T.appendLines(C.name(e)+" breathes frost at "+C.name(a)+" for "+t+" damage"),T.appendLines(a.isAlive()?"":" and it dies")}),p.backlash&&w(e,p)}}return d},heartseeker:function(e,a){var t=b(e),n=a.x,r=ae[t].assaults[e.key];return r?(n+=$.getEnhancement(e,a.id,n),r.heartseeker+=n,r.enfeebled+=n,T.enabled&&T.appendLines(C.name(e)+" inflicts heartseeker "+n+" on "+C.name(r)),1):0},enfeeble:function(e,a){for(var t=a.y,n=b(e),r=ae[n].assaults,i=[],s=0,l=r.length;s<l;s++){var o=r[s];o.isAlive()&&o.isInFaction(t)&&i.push(s)}return f(e,a,"hexes",i,r,function(e,a){e.enfeebled+=a})},weakenself:function(e,a){return p.weaken(e,a)},weaken:function(e,a){var t,r=a.y;switch(a.id){case"weakenself":t=y(e);break;default:t=b(e)}var i=a.all,s=ae[t].assaults,l=[],n=function(e){for(var a=0,t=s.length;a<t;a++){var n=s[a];n.isAlive()&&n.isInFaction(r)&&(i||n.isActiveNextTurn()&&n.isUnjammed()&&(e||n.hasAttack()))&&l.push(a)}};n(!1),l.length||n(!0);return f(e,a,"weakens",l,s,function(e,a){e.attack_weaken+=a})}};function f(e,a,t,n,r,i){if(!n.length)return 0;var s=$.getEnhancement(e,a.id,a.x),l=a.x+s;a.all||(n=k(n));for(var o=0,d=0,c=n.length;d<c;d++){var u=r[n[d]];u.invisible?(u.invisible--,T.enabled&&T.appendLines(C.name(e)+" "+t+" "+C.name(u)+" but it is invisible!")):(o++,i(u,l),T.enabled&&(s&&T.appendLines("<u>(Enhance: +"+s+")</u>"),T.appendLines(C.name(e)+" "+t+" "+C.name(u)+" by "+l)),u.backlash&&w(e,u))}return o}var m={enlarge:function(e,a){var t=a.y,n=y(e),r=a.x,i=$.getEnhancement(e,a.id,r);r+=i;for(var s=a.all,l=ae[n].assaults,o=[],d=0,c=l.length;d<c;d++){(p=l[d]).isAlive()&&p.isInFaction(t)&&(s||p.isUnjammed()&&p.isActive())&&o.push(d)}if(!o.length)return 0;s||(o=k(o));var u=0;for(d=0,c=o.length;d<c;d++){var p=l[o[d]],f=r;if(!f){var m=a.mult;f=Math.ceil(p.attack*m)}p.attack_rally+=f,T.enabled&&(i&&T.appendLines("<u>(Enhance: +"+i+")</u>"),T.appendLines(C.name(e)+" enlarges "+C.name(p)+" by "+f)),u++}return u},rally:function(e,a){for(var t=a.y,n=y(e),r=a.x,i=a.all,s=ae[n].assaults,l=[],o=0,d=s.length;o<d;o++){(p=s[o]).isAlive()&&p.isInFaction(t)&&(i||p.isActive()&&p.isUnjammed())&&l.push(o)}if(!l.length)return 0;i||(l=k(l));var c=$.getEnhancement(e,a.id,r);r+=c;var u=0;for(o=0,d=l.length;o<d;o++){var p;if((p=s[l[o]]).nullified)p.nullified--,T.enabled&&T.appendLines(C.name(e)+" empowers "+C.name(p)+" but it is nullified!");else{u++;var f=r;if(!f){var m=a.mult;f=Math.ceil(p.attack*m)}p.attack_rally+=f,T.enabled&&(c&&T.appendLines("<u>(Enhance: +"+c+")</u>"),T.appendLines(C.name(e)+" empowers "+C.name(p)+" by "+f))}}return u},legion:function(e,a){var t=y(e),n=ae[t].assaults,r=a.x,i=$.getEnhancement(e,a.id,r);r+=i;var s=a.y,l=e.key-1,o=l+2;l<0&&(l+=2);for(var d=0;l<=o;){var c=n[l];c&&c.isActive()&&c.isInFaction(s)&&(c.nullified?(c.nullified--,T.enabled&&T.appendLines(C.name(e)+" activates legion and empowers "+C.name(c)+" but it is nullified!")):(d++,c.attack_rally+=r,T.enabled&&(i&&T.appendLines("<u>(Enhance: +"+i+")</u>"),T.appendLines(C.name(e)+" activates legion and empowers "+C.name(c)+" by "+r)))),l+=2}return d},fervor:function(e,a){var t=y(e),n=ae[t].assaults,r=a.x,i=$.getEnhancement(e,a.id,r);r+=i;var s=a.y,l=0,o=e.key-1,d=o+2;for(o<0&&(o+=2);o<=d;){var c=n[o];c&&c.isInFaction(s)&&(l+=r),o+=2}return l?(e.attack_rally+=l,T.enabled&&(i&&T.appendLines("<u>(Enhance: +"+i+")</u>"),T.appendLines(C.name(e)+" activates fervor for "+l)),1):0},barrage:function(e,a){var t=b(e),n=a.x,r=a.y,i=a.all,s=ae[t].assaults;n+=$.getEnhancement(e,a.id,n);for(var l=0;l<n;l++){for(var o=[],d=0,c=s.length;d<c;d++){(p=s[d]).isAlive()&&p.isInFaction(r)&&o.push(d)}if(!o.length)return 0;i||(o=k(o));var u=0;for(d=0,c=o.length;d<c;d++){var p;if((p=s[o[d]]).invisible)p.invisible--,T.enabled&&T.appendLines(C.name(e)+" throws a bomb at "+C.name(p)+" but it is invisible!");else{u++;var f=1,m=z(p,f,{enfeeble:!0});E(e,p,f=m.damage,m.shatter,function(e,a,t){T.appendLines("<u>(Barrage: +1"),T.appendLines(m.echo),T.appendLines(") = "+t+" damage</u>"),T.appendLines(C.name(e)+" throws a bomb at "+C.name(a)+" for "+t+" damage"),T.appendLines(a.isAlive()?"":" and it dies")})}}}return u},enhance:function(e,a){for(var t=a.y,n=y(e),r=(b(e),a.x),i=(t=a.y,a.s),s=a.mult,l=a.all,o=ae[n].assaults,d=_(i),c=[],u=0,p=o.length;u<p;u++){(m=o[u]).isAlive()&&m.isInFaction(t)&&(l||!d||m.isActive()&&m.isUnjammed())&&m.hasSkill(i)&&c.push(u)}if(!c.length)return 0;l||(c=k(c));var f=0;for(u=0,p=c.length;u<p;u++){var m;if((m=o[c[u]]).nullified)m.nullified--,T.enabled&&T.appendLines(C.name(e)+" enhances "+C.name(m)+" but it is nullified!");else{f++;var h=m.enhanced;0<r?(h[i]=(h[i]||0)+r,T.enabled&&T.appendLines(C.name(e)+" enhances "+i+" of "+C.name(m,!1)+" by "+r)):0<s&&(h[i]=-s,T.enabled&&T.appendLines(C.name(e)+" enhances "+i+" of "+C.name(m,!1)+" by "+100*s+"%"))}}return f},enrage:function(e,a){for(var t=y(e),n=a.y,r=a.x,i=a.all,s=ae[t].assaults,l=[],o=0,d=s.length;o<d;o++){(p=s[o]).isAlive()&&p.isInFaction(n)&&l.push(o)}if(!l.length)return 0;i||(l=k(l));var c=$.getEnhancement(e,a.id,r);r+=c;var u=0;for(o=0,d=l.length;o<d;o++){var p,f=r;(p=s[l[o]]).nullified?(p.nullified--,T.enabled&&T.appendLines(C.name(e)+" enrages "+C.name(p)+" but it is nullified!")):(u++,a.mult&&(f=Math.ceil(a.mult*p.health)),p.enraged+=f,T.enabled&&(c&&T.appendLines("<u>(Enhance: +"+c+")</u>"),T.appendLines(C.name(e)+" enrages "+C.name(p)+" by "+f)))}return u},imbue:function(e,a){for(var t=a.y,n=y(e),r=(b(e),a.x),i=(a.c,a.s),s=a.all,l=ae[n].assaults,o=_(i),d=[],c=0,u=l.length;c<u;c++){(f=l[c]).isAlive()&&f.isInFaction(t)&&(s||!o||f.isActive()&&f.isUnjammed())&&d.push(c)}if(!d.length)return 0;a={id:i,x:r};s||(d=k(d));var p=0;for(c=0,u=d.length;c<u;c++){var f;if((f=l[d[c]]).nullified)f.nullified--,T.enabled&&T.appendLines(C.name(e)+" enhances "+C.name(f)+" but it is nullified!");else if(p++,f.hasSkill(i)){var m=f.enhanced;m[i]=(m[i]||0)+r,T.enabled&&T.appendLines(C.name(e)+" imbues "+C.name(f,!1)+" existing "+C.skill(a)+" by "+r)}else f.imbue(a),T.enabled&&T.appendLines(C.name(e)+" imbues "+C.name(f,!1)+" with "+C.skill(a))}return p},mark:function(e,a){for(var t=a.y,n=(y(e),b(e)),r=a.x,i=a.all,s=ae[n].assaults,l=e.mark_target,o=[],d=0,c=s.length;d<c;d++){if((p=s[d]).isAlive()&&p.isInFaction(t)){if(p.uid===l){o=[d];break}o.push(d)}}if(!o.length)return 0;i||(o=k(o)),r+=$.getEnhancement(e,a.id,r);var u=0;for(d=0,c=o.length;d<c;d++){var p;u++,(p=s[o[d]]).enfeebled+=r,e.mark_target=p.uid,T.enabled&&T.appendLines(C.name(e)+" marks "+C.name(p)+" by "+r),a.countdown=1}return u}},h={ambush:function(e,a,t){var n=t.x,r=t.base,i=t.mult,s=n;if(!s){i=t.mult;s=Math.ceil(a[r]*i)}return E(e,a,s,null,function(e,a,t){T.appendLines(C.name(e)+" ambushes "+C.name(a)+" for "+t+" damage"),T.appendLines(a.isAlive()?"":" and it dies")}),1},slow:function(e,a,t){var n=t.x,r=t.base,i=t.mult,s=n;if(!s){i=t.mult;s=Math.ceil(a[r]*i)}return a.timer+=s,T.enabled&&T.appendLines(C.name(e)+" slows "+C.name(a)+" by "+s),1}},A={unearth:function(e,a,t){if(!e.isToken){var n=$.create(t.card||e.id,t.level||t.x),r=s.byIdWithBgeApplied(n,null,!0);r.isToken=!0;var i=t.mult;return i&&(r.attack=Math.floor(e.attack*i),r.health=Math.floor(e.health*i)),d(r,e.owner,!0),T.enabled&&T.appendLines(C.name(r)+" is unearthed</br>"),1}},reanimate:function(e,a,t){return e.reanimated?0:(e.health_left=t.x,e.reanimated=!0,T.enabled&&T.appendLines(" and is reanimated</br>"),1)}};function L(e){if(e.silenced)T.enabled&&T.appendLines(C.name(e)+" is silenced and cannot use skills</br>");else for(var a=e.skill,t=u(e),n=0,r=a.length;n<r&&t();n++){var i=a[n];if(!i.countdown){var s=c(p,i.id)(e,i);i.c&&0<s&&(i.countdown=i.c),x.areShown&&x.drawField(ae,null,null,se,e)}}}function S(){cache_player_deck=getdeck?e.decodeHash(getdeck):t.defaultDeck(),cache_player_deck_cards=t.getDeckCards(cache_player_deck,"player"),pvpAI=!0,getdeck2?(cache_cpu_deck=e.decodeHash(getdeck2),getmission&&(pvpAI=!1)):getmission?(cache_cpu_deck=t.mission(getmission,missionlevel),pvpAI=!1):getraid?(cache_cpu_deck=t.raid(getraid,raidlevel),pvpAI=!1):cache_cpu_deck=t.defaultDeck(),cache_cpu_deck_cards=t.getDeckCards(cache_cpu_deck,"cpu")}function I(o){var d=o.uids={};["player","cpu"].forEach(function(e){for(var a=ee[e],t=a.deck,n="player"===e?1:101,r=0;r<t.length;r++){var i=n+r,s=t[r];s.owner=e,s.played=!1,s.uid=i,d[i]=s}var l=a.commander;l.owner=e,l.health_left=l.health,l.reusableSkills||l.resetTimers();i="player"===e?-1:-2;l.uid=i,d[i]=l,o[e].commander=l})}function D(e,a){x.clearFrames(),U(e,a)}function U(e,a){if(SIMULATOR.pause)return SIMULATOR.pause=!1;var t=function(e,a){var t,n;n=surge?(t="cpu","player"):(t="player","cpu");if(0<e){if(ie&&(!ae.player.commander.isAlive()||!ae.cpu.commander.isAlive()))return!(ne=!1);if(!O(e,ae,t,n,a))return!1;if(!ae.player.commander.isAlive()||!ae.cpu.commander.isAlive())return!(ne=!1)}else!surge&&SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(e);for(e++;e<=r+1;e++){if(e===r+1)return!(ne=!1);B(e,t,n,ae);if(!O(e,ae,t,n,!0))return!1;if(!ae.player.commander.isAlive()||!ae.cpu.commander.isAlive())return ne=!1,T.enabled&&T.appendLines("<u>Turn "+e+" ends</u><br><br></div>"),!0}return!(ne=!1)}(e,a);return t&&re&&n.debug_end(),t}function O(e,a,t,n,r){if(e%2)var i=t,s=n;else i=n,s=t;return closeDiv=!1,!!function(e,a,t){var n=ee[e],r=n.deck,i=n.ordered;{if(ie&&"cpu"===e&&t)return R(e,r,i,a,t),!1;if(r[0]){SIMULATOR.waiting=!1;var s=0;if(1==r.length)s=0;else{for(var l=0;l<r.length;l++){var o=r[l];if(o.trap&&(d(o.trap,e,a),o.trap=!1),2===l)break}s=n.chooseCard(e,r,i,a,t)}if(s<0)return!1;d(r[s],e,a),function(e,a){var t=a,n=e.length-1;for(;t<n;)e[t]=e[++t];e.length=t}(r,s)}}return!0}(i,e,r)&&(function(e,a,t,n){for(var r=t[e],i=r.commander,s=r.assaults,l=t[a],o=l.commander,d=l.assaults,c=0;c<Z.onTurn.length;c++){var u=Z.onTurn[c];u.enemy_only&&"cpu"!==e||(u.ally_only&&"player"!==e||(u.owner=e,g(u),L(u)))}g(r.commander);for(var p=0,f=s.length;p<f;p++){var m=s[p];G(m,"evade","invisible"),G(m,"absorb","warded")}(function(e){for(var a=e.assaults,t=0,n=a.length;t<n;t++){var r=a[t];if(r.isAlive()&&r.isActive()&&r.isUnjammed()){var i=r.flurry;i&&0===i.countdown&&r.hasAttack()&&(i.countdown=i.c,r.dualstrike_triggered=!0),g(r)}}})(r),L(i);for(var p=0,f=s.length;p<f;p++){var m=s[p];if(m.isAlive()&&m.isActive())if(m.jammed)T.enabled&&T.appendLines(C.name(m)+" is frozen and cannot attack");else{var h=1;for(m.dualstrike_triggered&&(h++,T.enabled&&T.appendLines(C.name(m)+" activates dualstrike"));0<h;h--)if(L(m),m.isAlive())if(m.hasAttack()){if(Y(m,d,o),!o.isAlive()||!i.isAlive())return;if(!m.isAlive())break}else T.enabled&&0<m.permanentAttack()&&T.appendLines(C.name(m)+" is weakened and cannot attack")}}(function(e){for(var a=0,t=e.length;a<t;a++){var n=e[a];if(n.jammedSelf?n.jammedSelf=!1:n.jammed=!1,n.attack_rally=0,n.attack_weaken=0,n.nullified=0,n.dualstrike_triggered=!1,n.silenced=!1,n.regenerate&&n.isDamaged()){var r=n.regenerate,i=$.getEnhancement(n,"regenerate",r);r+=i;var s=n.health-n.health_left;s<=r&&(r=s),n.health_left+=r,T.enabled&&T.appendLines(C.name(n)+" regenerates "+r+" health")}var l=n.poisoned;if(l){var o=n.warded;o&&(l-=K(n,"warded",l)),E(null,n,l,null,function(e,a,t){T.appendLines(C.name(a)+" takes "+t),o&&T.appendLines(" (Poison: +"+n.poisoned+" Ward: -"+o+")"),T.appendLines(" poison damage"),T.appendLines(a.isAlive()?"":" and it dies")})}var l=n.envenomed;if(l){var o=n.warded;o&&(l-=K(n,"warded",l)),E(null,n,l,null,function(e,a,t){T.appendLines(C.name(a)+" takes "+t),o&&T.appendLines(" (Venom: +"+n.envenomed+" Ward: -"+o+")"),T.appendLines(" venom damage"),T.appendLines(a.isAlive()?"":" and it dies")})}var d=n.scorched;if(d){l=d.amount;var o=n.warded;o&&(l-=K(n,"warded",l)),E(null,n,l,null,function(e,a,t){T.appendLines(C.name(a)+" takes "+t),o&&T.appendLines(" (Scorch: +"+d.amount+" Ward: -"+o+")"),T.appendLines(" scorch damage"),a.isAlive()?a.scorched||T.appendLines(" and scorch wears off"):T.appendLines(" and it dies"),T.appendLines("")}),1<d.timer?d.timer--:n.scorched=0}var c=n.corroded;if(c)if(c.timer--,c.timer<0)n.corroded=!1,n.attack_corroded=0,T.enabled&&T.appendLines(C.name(n)+" recovers from corrosion");else{var u=c.amount;n.attack_corroded=u,T.enabled&&T.appendLines(C.name(n)+" loses "+u+" attack to corrosion")}n.isAlive()||P(n,null)}})(s),v("player"),v("cpu"),T.enabled&&T.appendLines("<u>Turn "+n+" ends</u><br><br></div>")}(i,s,a,e),!0)}function F(e,a,t){var n=a[t];return n?e+" draws "+C.name(n,!0)+"<br/>":""}function B(e,a,t,n){if(choice=void 0,(te=e)%2)var r=a,i=t;else r=t,i=a;if(T.enabled){var s=C.name(n[r].commander),l=ee[r].deck;T.appendLines('<div id="turn_"'+e+' class="turn-info"><hr/><br/><u>Turn '+e+" begins for "+s+"</u>"),e<=2&&(T.appendLines(F(s,l,0)),T.appendLines(F(s,l,1))),T.appendLines(F(s,l,2))}var o=n[r],d=n[i],c=o.assaults,u=d.assaults;J(o.commander);for(var p=0,f=c.length;p<f;p++){var m=c[p];if(0<m.timer&&(3===e&&tournament||(m.timer--,T.enabled&&T.appendLines(C.name(m)+" reduces its timer"))),m.valor){var h=u[p];h&&m.adjustedAttack()<h.adjustedAttack()?(m.attack_valor+=m.valor,T.enabled&&T.appendLines(C.name(m)+" activates valor, boosting its attack by "+m.valor)):T.enabled&&(T.appendLines(C.name(m)+" activates valor but "),h?T.appendLines("enemy is not strong enough."):T.appendLines("there is no opposing enemy."))}m.enfeebled=m.envenomed+m.heartseeker,m.enraged=0,m.invisible=0,m.protected=0,m.barrier_ice=0,m.warded=0,m.enhanced={},m.removeImbue(),J(m)}}function R(e,a,t,n,r){return SIMULATOR.waiting=!0,closeDiv=!0,r&&(hideTable(),outputTurns(),x.drawField(ae,null,U,n),SIMULATOR.sendBattleUpdate(n)),-1}function H(e,a,t,n,r){var i=a.slice(0,3);closeDiv=!0;for(var s=[],l=[],o=0,d=i.length;o<d;o++){var c=i[o],u=o+": "+c.name;1<c.maxLevel&&(u+="{"+c.level+"/"+c.maxLevel+"}"),s.push(u),l.push(c)}if(r&&(hideTable(),outputTurns(),x.drawField(ae,l,D,n)),void 0===choice)return-1;var p=choice;return p||(p=0),p}function q(e,a,t,n,r){if(void 0===t)return 0;for(var i=a.slice(0,3),s=!1,l=0,o=t.length;l<o;l++){for(var d,c=t[l],u=c.priority,p=-1,f=0,m=i.length;f<m;f++){var h=(d=i[f]).priority;if($.areEqual(c,d)){s=!0;break}0<u&&u==h&&(p=f)}if(!s&&0<=p&&(s=!0,d=i[f=p]),s){for(var v=t.length-1;l<v;l++)t[l]=t[l+1];return t.length=l,f}}return-1}function j(e,a,t,n,r){var i=a.slice(0,3);return~~(Math.random()*i.length)}function V(e,a,t,n,r){for(var i,s,l,o,d,c=a.slice(0,3),u=-1,p=-1,f=0;f<c.length;f++){var m=c[f],h=(void 0,s=(i=m).id.toString(),l=6*parseInt(i.rarity),o=3*(4<s.length?parseInt(s[0]):0),d=parseInt(i.level)-parseInt(i.maxLevel),l+o+d);p<h&&(p=h,u=f)}return u}function W(e,a,t,n,r){return 0}function G(e,a,t){var n=0;e[a]&&(n=e[a],n+=$.getEnhancement(e,a,n));e[t]=n}function z(e,a,t){var n=(t=t||{}).enfeeble?0:e.enfeebled||0,r=t.stasis?0:M(e),i=t.protect?0:e.protected||0,s=t.ward?0:e.warded||0;a+=n-r;var l=!1;s&&(a-=K(e,"warded",a)),i&&(a-=K(e,"protected",a),0==e.protected&&(l=e.barrier_ice)),r&&(a-=r);return T.enabled&&(n&&T.appendLines(" Enfeeble: +"+n),r&&T.appendLines(" Stasis: -"+r),i&&T.appendLines(" Barrier: -"+i),s&&T.appendLines(" Ward: -"+s)),a<0&&(a=0),{damage:a,shatter:l,echo:""}}function K(e,a,t){var n=e[a];return n<=t?(e[a]=0,n):(e[a]-=t,t)}function J(e){Q(e,e.skill),Q(e,e.earlyActivationSkills);var a=e.flurry;a&&a.countdown&&(a.countdown--,T.enabled&&(a.countdown?T.appendLines(C.name(e)+" charges  dualstrike (ready in "+a.countdown+" turns)"):T.appendLines(C.name(e)+" readies dualstrike")))}function Q(e,a){for(var t=0,n=a.length;t<n;t++){var r=a[t];r.countdown&&(r.countdown--,T.enabled&&(r.countdown?T.appendLines(C.name(e)+" charges "+i.nameFromId(r.id)+" (ready in "+r.countdown+" turns)"):T.appendLines(C.name(e)+" readies "+i.nameFromId(r.id))))}}function Y(e,a,t){var n=a[e.key];if(n&&n.isAlive()){var r,i=!1;if(!n.taunt)if((r=a[e.key-1])&&r.taunt)n=r,i=!0;else(r=a[e.key+1])&&r.taunt&&(n=r,i=!0);i&&T.enabled&&T.appendLines(C.name(n)+" taunts "+C.name(e))}else n=t;var s=e.adjustedAttack(),l=n.enfeebled;s+=l,T.enabled&&(T.appendLines("<u>(Attack: +"+e.attack),e.attack_berserk&&T.appendLines(" Berserk: +"+e.attack_berserk),e.attack_valor&&T.appendLines(" Valor: +"+e.attack_valor),e.attack_rally&&T.appendLines(" Rally: +"+e.attack_rally),e.attack_weaken&&T.appendLines(" Weaken: -"+e.attack_weaken),e.attack_corroded&&T.appendLines(" Corrosion: -"+e.attack_corroded),l&&T.appendLines(" Enfeeble: +"+l));var o=e.pierce;o?o+=$.getEnhancement(e,"pierce",o):o=0;var d=n.protected,c=!1,u=n.armored,p=M(n);if(d&&(T.enabled&&T.appendLines(" Barrier: -"+d),o&&(d<=o?(T.enabled&&T.appendLines(" Pierce: +"+d),o-=d,d=0,n.protected=0):(T.enabled&&T.appendLines(" Pierce: +"+o),d-=o,n.protected-=o,o=0)),d&&(d<=s?(c=n.barrier_ice,s-=d,n.protected=0):(n.protected-=s,s=0))),p&&(p+=$.getEnhancement(n,"stasis",p),T.enabled&&T.appendLines(" Shroud: -"+p),o&&(p<o?(T.enabled&&T.appendLines(" Pierce: +"+p),p=0):(T.enabled&&T.appendLines(" Pierce: +"+o),p-=o)),s-=p),u&&(u+=$.getEnhancement(n,"armored",u),T.enabled&&T.appendLines(" Armor: -"+u),o&&(u<o?(T.enabled&&T.appendLines(" Pierce: +"+u),u=0):(T.enabled&&T.appendLines(" Pierce: +"+o),u-=o)),s-=u),s<0&&(s=0),T.enabled&&T.appendLines(") = "+s+" damage</u>"),E(e,n,s,null,function(e,a,t){T.appendLines(C.name(e)+" attacks "+C.name(a)+" for "+t+" damage"),T.appendLines(a.isAlive()?"":" and it dies")}),x.areShown&&x.drawField(ae,null,null,se,e),t.isAlive()){if(0<s&&n.isAssault()&&n.isAlive()){if(e.poison){var f=e.poison;(f+=$.getEnhancement(e,"poison",f))>n.poisoned&&(n.poisoned=f,T.enabled&&T.appendLines(C.name(e)+" inflicts poison("+f+") on "+C.name(n)))}if(e.venom){var m=e.venom;if((m+=$.getEnhancement(e,"venom",m))>n.envenomed){var h=m-n.envenomed;n.envenomed=m,n.enfeebled+=h,T.enabled&&T.appendLines(C.name(e)+" inflicts venom("+m+") on "+C.name(n))}}if(e.nullify){var v=e.nullify;v+=$.getEnhancement(e,"nullify",v),n.nullified+=v,T.enabled&&T.appendLines(C.name(e)+" inflicts nullify("+v+") on "+C.name(n))}if(e.silence&&(n.silenced=!0,T.enabled&&T.appendLines(C.name(e)+" inflicts silence on "+C.name(n))),e.daze){var g=e.daze;g+=$.getEnhancement(e,"daze",g),n.attack_weaken+=g,T.enabled&&T.appendLines(C.name(e)+" dazed "+C.name(n)+" for "+g)}}if(c&&N(n),0<s&&e.isAlive()){if(e.leech&&e.isDamaged()){var b=e.leech;b+=$.getEnhancement(e,"leech",b);var k=e.health-e.health_left;k<=b&&(b=k),e.health_left+=b,T.enabled&&T.appendLines(C.name(e)+" siphons "+b+" health")}if(e.reinforce){var y=e.reinforce;y+=$.getEnhancement(e,"reinforce",y),e.protected+=y,T.enabled&&T.appendLines(C.name(e)+" reinforces itself with barrier "+y)}if(n.counter){var _=0+n.counter;X(e,n,"Vengance",_,$.getEnhancement(n,"counter",_))}if(n.counterburn){var w=n.counterburn||0;w+=$.getEnhancement(n,"counterburn",w),e.scorched?(e.scorched.amount+=w,e.scorched.timer=2):e.scorched={amount:w,timer:2},T.enabled&&T.appendLines(C.name(n)+" inflicts counterburn("+w+") on "+C.name(e))}if(n.counterpoison){f=n.counterpoison||0;(f+=$.getEnhancement(n,"counterpoison",f))>e.poisoned&&(e.poisoned=f,T.enabled&&T.appendLines(C.name(n)+" inflicts counterpoison("+f+") on "+C.name(e)))}if(n.fury){var A=n.fury,L=$.getEnhancement(n,"counter",A);if(n.isAlive()){var S=A+L;n.attack_berserk+=S,T.enabled&&T.appendLines(C.name(n)+" activates fury and gains "+S+" attack")}X(e,n,"Fury",A,L)}if(0<n.enraged&&(n.attack_berserk+=n.enraged,T.enabled&&T.appendLines(C.name(n)+" is enraged and gains "+n.enraged+" attack!</br>")),e.berserk){var I=e.berserk;I+=$.getEnhancement(e,"berserk",I),e.attack_berserk+=I,T.enabled&&T.appendLines(C.name(e)+" activates berserk and gains "+I+" attack")}}if(n.corrosive){var D=n.corrosive||0;D+=$.getEnhancement(n,"corrosive",D),e.corroded?(e.corroded.amount+=D,e.corroded.timer=2):e.corroded={amount:D,timer:2},T.enabled&&T.appendLines(C.name(n)+" inflicts corrosion("+D+") on "+C.name(e)),e.attack_corroded=D,T.enabled&&T.appendLines(C.name(e)+" loses "+D+" attack to corrosion")}e.isAlive()||P(e,n),x.areShown&&x.drawField(ae,null,null,se,e)}}function X(e,a,n,t,r){var i=t+r,s=z(e,i,{enfeeble:!0});i=s.damage;s.shatter;T.enabled&&(T.appendLines("<u>("+n+": +"+t),r&&T.appendLines(" Enhance: +"+r),T.appendLines(s.echo),T.appendLines(") = "+i+" damage</u>")),E(a,e,i,null,function(e,a,t){T.appendLines(C.name(a)+" takes "+t+" "+n.toLowerCase()+" damage"),T.appendLines(a.isAlive()?"":" and it dies")})}SIMULATOR.pause=!1,SIMULATOR.performTurns=U,SIMULATOR.waitForOpponent=R;var Z,ee={},ae={},te=0,ne=!1,re=!1,ie=!1,se=0,le=0,oe=0;SIMULATOR.simulate=function(){if(ne=!0,function(){SIMULATOR.simulation_turns=0;var e={cpu:{deck:[]},player:{deck:[]}};SIMULATOR.deck=e,SIMULATOR.field={cpu:{assaults:[]},player:{assaults:[]}},cache_player_deck_cards&&(e.player=t.copyDeck(cache_player_deck_cards)),getmission&&1<missionlevel&&missionlevel<7?(cache_cpu_deck=t.mission(getmission,missionlevel),cache_cpu_deck_cards=t.getDeckCards(cache_cpu_deck,"cpu")):getraid&&(cache_cpu_deck=t.raid(getraid,raidlevel),cache_cpu_deck_cards=t.getDeckCards(cache_cpu_deck,"cpu")),cache_cpu_deck_cards&&(e.cpu=t.copyDeck(cache_cpu_deck_cards)),getordered&&!getexactorder&&(e.player.ordered=t.copyCardList(e.player.deck)),getordered2&&!getexactorder2&&(e.cpu.ordered=t.copyCardList(e.cpu.deck)),e.player.chooseCard=re?H:getordered?q:j,e.cpu.chooseCard=getordered2?q:pvpAI?V:getexactorder2?j:W}(),getexactorder?getordered||(ee.player.shuffleHand=!0):shuffle(ee.player.deck),getexactorder2?getordered2||(ee.cpu.shuffleHand=!0):shuffle(ee.cpu.deck),I(ae),getsiege){var e=BATTLEGROUNDS[tower_type].effect[tower_level];if(e){e=$.create(e.id,e.level);var a=s.byIdWithBgeApplied(e);a.uid=150,d(ae.uids[150]=a,"cpu",-1,!0)}}return U(0)},SIMULATOR.onPlaySkills=h,SIMULATOR.calculatePoints=function(e){var a=ae.uids,t={player:{total:0,taken:0},cpu:{total:0,taken:0}};for(var n in a){var r=a[n],i=t[r.owner];i&&(i.total+=r.health,(r.played||r.isCommander())&&(i.taken+=r.health-r.health_left))}t.player.percent=i.taken/i.total,t.cpu.percent=i.taken/i.total;var s=ae.cpu.commander;if(getdeck2)if(s.isAlive()&&!e)var l=Math.floor(25*t.cpu.percent);else l=130-Math.floor(15*t.player.percent);else l=s.isAlive()&&!e?(l=Math.floor(t.cpu.percent/.02),Math.max(5,l)):200-Math.floor(t.player.percent/.02);return l},Object.defineProperties(SIMULATOR,{setupDecks:{get:function(){return S},set:function(e){S=e}},setupField:{get:function(){return I},set:function(e){I=e}},deck:{get:function(){return ee},set:function(e){ee=e}},field:{get:function(){return ae},set:function(e){ae=e}},battlegrounds:{get:function(){return Z},set:function(e){Z=e}},simulation_turns:{get:function(){return te},set:function(e){te=e}},simulating:{get:function(){return ne},set:function(e){ne=e}},totalDeckHealth:{get:function(){return le},set:function(e){le=e}},totalCpuDeckHealth:{get:function(){return oe},set:function(e){oe=e}},user_controlled:{get:function(){return re},set:function(e){re=e}},livePvP:{get:function(){return ie},set:function(e){ie=e}}})}(),function(e){"use strict";var a=function(e,a,t){return e.filter(function(e){return e[t]==a})},t=function(e,a,t,n,r){var i=t.filter(function(e){return e.id==a})[0];if(i){var s=i[n];return e.filter(function(e){var a=e[r];return 0<=s.indexOf(a)})}return[]};e.module("core",[]).filter("forMissions",function(){return function(e,a){if(!e||!a)return e;for(var t=[],n=0,r=e.length;n<r;n++){for(var i=e[n],s=i.missions,l=!0,o=0;o<s.length;o++){if(!a[s[o]]){l=!1;break}}l&&t.push(i)}return t}}).filter("filterByParent",function(){return a}).filter("filterChildren",function(){return t}),e.module("simulatorApp",["core"]).controller("SimulatorCtrl",["$scope","$window",function(r,e){function a(e){var a=Object.keys(e);a.sort(function(e,a){return Number(e)-Number(a)});for(var t=[],n=0;n<a.length;n++){var r=a[n],i=e[r];t.push(i)}return t}function t(e){var a=[];for(var t in e)a.push(e[t]);return a}r.locations=[],r.campaigns=[],r.missions=e.TITANS,r.raids=e.RAIDS,r.battlegrounds=e.BATTLEGROUNDS,r.mapBattlegrounds=t(e.MAP_BATTLEGROUNDS),r.campaignBGEs=[],r.tower=!1,r.auto=!1,r.debugMode=!1,r.selections={location:"",campaign:"",mission:"",raid:""},r.titans=function(){r.campaigns=t(e.CAMPAIGNS),r.missions=e.TITANS},r.campaignSections=function(){r.locations=a(e.LOCATIONS).sort(function(e,a){return Number(e.id)-Number(a.id)}),r.missions=a(e.MISSIONS),r.campaigns=a(e.CAMPAIGNS)},r.filteredRaids=function(){var a={};return t(r.raids).sort(function(e,a){return Number(a.id)-Number(e.id)}).forEach(function(e){a[e.name]||(a[e.name]=e)}),t(a).sort(function(e,a){return Number(e.id)-Number(a.id)})},r.getLocationClass=function(e){if(!e){var a=r.selections.location;e=r.locations.filter(function(e){return e.id==a})[0]}if(e){var t=Number(e.id);return 0===t?"heroUpgrade":100<=t?"event":"black"}return"grey"},r.getCampaignClass=function(e){if(!e){var a=r.selections.campaign;e=r.campaigns.filter(function(e){return e.id==a})[0]}return e?e.side_mission?0==e.location_id?"heroUpgrade":"mythic":e.isLocation?"location":"black":"grey"},r.$watch("selections.location",function(e,a){r.selections.campaign=""}),r.$watch("selections.campaign",function(e,a){r.selections.mission=""}),r.towerTypes=["Castle Tower","Cannon Tower","Tree of Life"],r.selectableBattlegrounds=function(){var e=[];for(var a in r.battlegrounds){var t=r.battlegrounds[a];t.hidden||t.isTower||e.push(t)}return e.sort(function(e,a){return e.id-a.id}),e},r.personalBattlegrounds=function(){var e=[];for(var a in r.battlegrounds){var t=r.battlegrounds[a],n=Number(t.id);1e3<n&&n<2e3&&e.push(t)}return e.sort(function(e,a){return e.id-a.id}),e},r.towerTypes=function(){var e=[];for(var a in r.battlegrounds){var t=r.battlegrounds[a];t.isTower&&e.push(t)}return e.sort(function(e,a){return e.id-a.id}),e},r.$watch("debugMode",function(e,a){})}])}(angular),function(a){"use strict";var t,n=require("storageAPI");try{t=a.module("simulatorApp")}catch(e){t=a.module("simulatorApp",[])}t.controller("DeckStorageCtrl",["$scope","$window",function(e,a){e.getSavedDecks=n.getSavedDecks,e.keys=function(e){return e?Object.keys(e):[]}}])}(angular);var bgeApi=require("bgeApi"),base64=require("base64"),urlHelpers=require("urlHelpers"),loadDeck=require("loadDeck"),cardUI=require("cardUI"),simController=require("simController"),dataUpdater=(storageAPI=require("storageAPI"),require("dataUpdater"));function doneLoading(){$("body").removeClass("loading"),checkTutorial()}function updateGameData(e){var a=doneLoading;e&&(a=function(){doneLoading(),e()}),dataUpdater.updateData(a,!0)}function setDeckSortable(e,o){$(e).sortable({items:".card:not(.commander):not(.blank)",tolerance:"intersect",helper:function(e,a){return a.clone()},start:function(e,a){var t=a.placeholder.index()-1;a.item.data("origPos",t),$(a.item).hide()},stop:function(e,a){var t=a.item.data("origPos")-1,n=a.item.index()-1,r=$(o),i=base64.decodeHash(r.val()),s=i.deck;s.splice(n,0,s.splice(t,1)[0]);var l=base64.encodeHash(i);r.val(l)}})}function showMapBGEs(){mapBGEDialog.dialog("open"),mapBGEDialog.dialog("option","position",{my:"center",at:"center",of:window})}function loadDeck(e){$('label[for="loadDeckName"]').html("<strong>Deck:</strong>"),loadDeckDialog.dialog("open"),loadDeckDialog.dialog("option","position",{my:"center",at:"center",of:window}),loadDeckDialog.hashField=e}function onDeckLoaded(e,a){$(a).val(e).change()}$(function(){$("#deck1").change(function(){this.value=this.value.trim(),r("attack_deck",base64.decodeHash(this.value),"player")}),$("#deck2").change(function(){this.value=this.value.trim(),r("defend_deck",base64.decodeHash(this.value),"cpu")}),$("#battleground").change(function(){$("#deck1").change(),$("#deck2").val()?$("#deck2").change():$("#mission").val()?$("#mission").change():$("#raid").val()&&$("#raid").change()});for(var e=$("label[bge-desc]"),a=0;a<e.length;a++){$(e[a]).hover(t,n)}function t(e){var a=$("#tooltip"),t=$("#tooltip-text");t.html($(e.target).attr("bge-desc")),t.width(200),a.show(),$("#tooltip .arrow").css("borderTopWidth",0).css("borderBottomWidth",0);var n=$(e.target).offset();n.left-=230,n.top-=a.outerHeight()/2-10,a.offset(n);var r=t.innerHeight()/2-4;$("#tooltip .arrow").css("borderTopWidth",r).css("borderBottomWidth",r)}function n(e){$("#tooltip").hide()}function r(e,a,t){var n=$("#"+e);if(n.children().remove(),!urlHelpers.paramDefined("seedtest")){var r=simController.getConfiguration(),i=bgeApi.getBattlegrounds(getbattleground,selfbges,enemybges,mapbges,r.selectedCampaign,missionlevel,getraid,raidlevel);i=i.onCreate.filter(function(e){return!("player"===t&&e.enemy_only||"cpu"===t&&e.ally_only)}),n.append(cardUI.makeDeckHTML(a,!1,i))}}$(".accordion").accordion({collapsible:!0,active:!1,heightStyle:"content"}).filter(".start-open").accordion("option","active",0);if($("#raid, #raid_level").change(function(){var e,a=$("#raid").val(),t=$("#raid_level");a?(e=loadDeck.raid(a,t.val()),"Dungeon"===RAIDS[a].type?t.attr("max",150):t.attr("max",40)):(e=base64.decodeHash(""),t.attr("max",40)),r("defend_deck",e,"cpu")}),$("#location, #campaign").change(function(){$("#mission").change()}),$("#mission, #mission_level").change(function(){var e,a=$("#mission").val();if(a){var t=$("#mission_level").val();e=loadDeck.mission(a,t)}else e=base64.decodeHash("");r("defend_deck",e,"cpu")}),loadDeckDialog=$("#loadDeckDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{Delete:function(){var e=$("#loadDeckName").val();storageAPI.deleteDeck(e)},Load:function(){var e=$("#loadDeckName").val();onDeckLoaded(storageAPI.loadDeck(e),loadDeckDialog.hashField),loadDeckDialog.dialog("close")},Cancel:function(){loadDeckDialog.dialog("close")}}}),mapBGEDialog=$("#bgeDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{OK:function(){mapBGEDialog.dialog("close")},Cancel:function(){mapBGEDialog.dialog("close")}}}),r("attack_deck",base64.decodeHash("")),r("defend_deck",base64.decodeHash("")),setDeckSortable("#attack_deck","#deck1"),setDeckSortable("#defend_deck","#deck2"),urlHelpers.paramDefined("latestCards")){var i=null;urlHelpers.paramDefined("autostart")&&(i=function(){simController.startsim(1)}),updateGameData(i)}else loadCardCache();processQueryString()});var deckPopupDialog,dark=!1;function toggleTheme(){dark?($("#theme").attr("href","dist/light.min.css"),$("#toggleTheme").val("Dark Theme")):($("#theme").attr("href","dist/dark.min.css"),$("#toggleTheme").val("Light Theme")),dark=!dark}base64=require("base64"),urlHelpers=require("urlHelpers"),loadDeck=require("loadDeck");var style,debugLog=require("debugLog");simController=require("simController");function processQueryString(){if($("#header").load("templates/header.html",function(){"undefined"!=typeof showTutorial&&$("#help").click(showTutorial)}),$.holdReady(!0),$("#footer").load("templates/footer.html",function(){$.holdReady(!1)}),!document.getElementById("ui"))return 0;angular.element(document.getElementById("ui")).scope();$("#generate_link").on("click",display_generated_link),$("#btn_simulate").on("click",simController.startsim),$("#btnStop").on("click",simController.stopsim),$("#display_history").on("click",display_history),$("#deck1").val(urlHelpers.paramValue("deck1")).change(),$("#deck2").val(urlHelpers.paramValue("deck2")).change(),$("#surge").prop("checked",urlHelpers.paramDefined("surge")),$("#siege").prop("checked",urlHelpers.paramDefined("siege"));var e=Math.min(Math.max(urlHelpers.paramValue("tower_level")||18,0),18);$("#tower_level").val(e);var a=urlHelpers.paramValue("tower_type")||501;$("#tower_type").val(a),$("#auto_mode").prop("checked",urlHelpers.paramDefined("auto_mode")),$("#tournament").prop("checked",urlHelpers.paramDefined("tournament")),$("#ordered").prop("checked",urlHelpers.paramDefined("ordered")),$("#exactorder").prop("checked",urlHelpers.paramDefined("exactorder")),$("#ordered2").prop("checked",urlHelpers.paramDefined("ordered2")),$("#exactorder2").prop("checked",urlHelpers.paramDefined("exactorder2")),urlHelpers.paramDefined("randomAI")&&(pvpAI=!1);var t=urlHelpers.paramValue("location"),n=urlHelpers.paramValue("campaign"),r=urlHelpers.paramValue("mission"),i=urlHelpers.paramValue("raid");if(t&&$("#location").val(t).change(),n&&(t||(t=CAMPAIGNS[n].location_id,$("#location").val(t).change()),$("#campaign").val(n).change()),r&&($("#mission_level").val(urlHelpers.paramValue("mission_level")||7),$("#mission").val(r).change()),i&&($("#raid_level").val(urlHelpers.paramValue("raid_level")||25),$("#raid").val(i).change()),urlHelpers.paramDefined("bges"))for(var s=urlHelpers.paramValue("bges"),l=0;l<s.length;l+=2){var o=base64.toDecimal(s.substring(l,l+2));$("#battleground_"+o).prop("checked",!0)}else for(document.getElementsByName("battleground"),l=0;l<current_bges.length;l++)$("#battleground_"+current_bges[l]).prop("checked",!0);if(s=urlHelpers.paramValue("selfbges"))for(l=0;l<s.length;l+=2){o=base64.toDecimal(s.substring(l,l+2))+1e4;$("#self-battleground_"+o).prop("checked",!0)}if(s=urlHelpers.paramValue("enemybges"))for(l=0;l<s.length;l+=2){o=base64.toDecimal(s.substring(l,l+2))+1e4;$("#enemy-battleground_"+o).prop("checked",!0)}var d=urlHelpers.paramValue("mapBges");if(d&&setSelectedMapBattlegrounds(d),$("#battleground").change(),$("#sims").val(urlHelpers.paramValue("sims")||1e4),urlHelpers.paramDefined("debug")&&$("#debug").click(),urlHelpers.paramDefined("mass_debug")&&$("#mass_debug").click(),urlHelpers.paramDefined("loss_debug")&&$("#loss_debug").click(),urlHelpers.paramDefined("win_debug")&&$("#win_debug").click(),urlHelpers.paramDefined("play_debug")&&$("#play_debug").click(),document.title="SimSpellstone "+text_version+" - The Spellstone Simulator that runs from your browser!",urlHelpers.paramDefined("autostart")&&!urlHelpers.paramDefined("latestCards"))simController.startsim(1);else if(urlHelpers.paramDefined("unit_tests")){var c=document.getElementsByTagName("body")[0],u=document.createElement("script");u.src="scripts/unit_tests.js",c.appendChild(u),u.onload=function(){var e=document.createElement("script");e.src="scripts/unit_test_runner.js",c.appendChild(e)}}document.getElementById("missionDeckDialog")&&(deckPopupDialog=$("#missionDeckDialog").dialog({autoOpen:!1,minWidth:500,minHeight:20,modal:!0,resizable:!1,draggable:!1,buttons:{Close:function(){deckPopupDialog.dialog("close")}},open:function(e,a){$(".ui-dialog-titlebar-close",a.dialog|a).hide()}}))}window.addEventListener("error",function(e,a,t){var n="JavaScript error:\n "+e+"\n on line "+t+"\n for "+a;if(window.sa("send","exception",{exDescription:n,exFatal:!1}),0===t){var r="<br><br><i>Error Message:</i><br><br><i>It appears you're having trouble loading SimSpellstone. Thanks.</i><br><br>";return outp?outp(r):document.write(r),1}n+="\n",n+="Browser CodeName: "+navigator.appCodeName+"\n",n+="Browser Name: "+navigator.appName+"\n",n+="Browser Version: "+navigator.appVersion+"\n",n+="Cookies Enabled: "+navigator.cookieEnabled+"\n",n+="Platform: "+navigator.platform+"\n",n+="User-agent header: "+navigator.userAgent+"\n";try{n+="URL: "+generate_link()+"\n"}catch(e){}outp('<br><br><i>Error Message:</i><br><textarea cols=50 rows=6 onclick="this.select()"><blockquote>'+n+"</blockquote></textarea>"),current_timeout&&clearTimeout(current_timeout)});var u_black=!1;function toggle_u(){var e=!1;if(void 0===style)e=!0,style=document.createElement("style");else for(;style.hasChildNodes();)style.removeChild(style.firstChild);var a,t=document.getElementsByTagName("head")[0];a=u_black?(u_black=!1,document.createTextNode("u { text-decoration: none; font-style:normal; color: #dddddd; font-weight: normal; }")):(u_black=!0,document.createTextNode("u { text-decoration: none; font-style:normal; color: #000000; font-weight: normal; }")),style.type="text/css",style.styleSheet?style.styleSheet.cssText=a.nodeValue:style.appendChild(a),!0===e&&t.appendChild(style)}function toggleUI(e){e?$("#ui").show():$("#ui").hide()}function showUI(){toggleUI(!0),document.getElementById("stop").style.display="none"}function hideUI(){$(".accordion").accordion("option","active",null),toggleUI(!1),document.getElementById("stop").style.display="block"}function getSelectedBattlegrounds(e){e=e||"";for(var a=[],t=document.getElementsByName(e+"battleground"),n=0;n<t.length;n++){var r=t[n];r&&r.checked&&a.push(r.value)}return a=a.join()}function getSelectedMapBattlegrounds(){for(var e=[],a=$("#location").val(),t=document.getElementsByName("map-battleground"),n=0;n<t.length;n++){var r=t[n];0<r.value&&e.push(a+"-"+n+"-"+r.value)}return e=e.join()}function setSelectedMapBattlegrounds(e){for(var a=document.getElementsByName("map-battleground"),t=0;t<e.length&&t<a.length;t++)a[t].value=e[t]}function outp(e){$("#content").html(e)}function outputTurns(){var e=debugLog.getLog();if(e){closeDiv&&(e+="</div>",closeDiv=!1),outp(e="<input id='show-turns' type='button' value='Show All' /> <div id='turn-container'>Turn: <select id='turn-picker'></select></div> <div>"+e+"</div>");for(var a=$(".turn-info").hide().length,t=[],n=0;n<a;n++){var r=n+1;t.push("<option value='"+n+"'>"+r+"</option>")}var i=n-1;i&&closeDiv&&i--,$("#turn-picker").append(t).change(function(e){var a=e.target.selectedIndex;$(".turn-info").hide().eq(a).show()}).val(i).change();var s=!0;$("#show-turns").click(function(){if(s=!s){var e=$("#turn-picker").val();$(".turn-info").hide().eq(e).show(),$("#turn-container").show(),this.value="Show All"}else $(".turn-info").show(),$("#turn-container").hide(),this.value="Show One"})}}function showWinrate(){if(suppressOutput);else if(debugLog.enabled||0==sims_left){var e="";if(e+='<br><br><i>Non-autostart link</i><br><a href="'+generate_link()+'">'+generate_link()+'</a><br><br><i>Autostart link</i><br><a href="'+generate_link(1)+'">'+generate_link(1)+"</a><br><br>",debugLog.enabled)return e}var a=(100*(wins/games)).toFixed(2)+"%";$("#wins").html(wins),$("#winrate").html(a);var t=losses/games*100;t=t.toFixed(2)+"%",$("#losses").html(losses),$("#lossrate").html(t);var n=draws/games*100;n=n.toFixed(2)+"%",$("#draws").html(draws),$("#drawrate").html(n);var r=marginOfError(wins,games);$("#marginGames").html((r*games).toFixed(0)),r=r.toFixed(2)+"%",$("#marginPercent").html(r);var i=(100*games/(games+sims_left)).toFixed("2")+"%";$(".battleCount").html(games),$("#percentComplete").html(i),$("#avgLength").html((total_turns/games).toFixed(1)),$("#avgPoints").html((points/games).toFixed(2)),$("#winrateTable").show();var s="";if(0==sims_left){s+=e;var l="",o=[],d=document.getElementById("deck1").value;d&&(o.player=base64.decodeHash(d)),o.player&&(l=base64.encodeHash(o.player)),battle_history+=a+" (+/- "+r+") &nbsp; &nbsp; "+l+"<br>"}return s}function hideTable(){$("#winrateTable").hide()}function setSimStatus(e,a,t){if($("#simStatusMsg").html(e),a&&t){var n=games+sims_left,r=(100*games/n).toFixed("2")+"%",i="("+games+"/"+n+") "+r;$("#progress").html(i),$("#speed").show(),$("#elapsed").html(a),$("#simsPerSec").html(t)}else $("#progress").html(""),$("#speed").hide();$("#simulationStatus").show()}function winrateDev(e,a){if(a<=1)return 1;var t=e/a,n=a;return Math.sqrt(n*t*(1-t))}function marginOfError(e,a){if(a<=1)return 1;var t=e/a,n=a;return 100*(1.96*Math.sqrt(t*(1-t)/n)+.5/n)}function generate_link(e){var a=0,t=document.URL,n=t.indexOf("?");0<n&&(t=t.substring(0,n));var r=[];addValueParam(r,"deck1"),addValueParam(r,"deck2"),addValueParam(r,"location"),addValueParam(r,"campaign"),addValueParam(r,"mission"),addValueParam(r,"mission_level"),addValueParam(r,"raid"),addValueParam(r,"raid_level");var i=$("select[name=map-battleground]").toArray().reduce(function(e,a){return e+a.value},"");i.length&&r.push("mapBges="+i),addBoolParam(r,"surge"),addBoolParam(r,"siege")&&(addValueParam(r,"tower_level"),addValueParam(r,"tower_type")),addBoolParam(r,"auto_mode"),addBoolParam(r,"tournament"),addBoolParam(r,"ordered"),addBoolParam(r,"exactorder"),addBoolParam(r,"ordered2"),addBoolParam(r,"exactorder2");for(var s="",l=document.getElementsByName("battleground"),o=0;o<l.length;o++)(a=l[o]).checked&&(s+=base64.fromDecimal(a.value,2));r.push("bges="+s);for(s="",l=document.getElementsByName("self-battleground"),o=0;o<l.length;o++)(a=l[o]).checked&&(s+=base64.fromDecimal(a.value-1e4,2));s&&r.push("selfbges="+s);for(s="",l=document.getElementsByName("enemy-battleground"),o=0;o<l.length;o++)(a=l[o]).checked&&(s+=base64.fromDecimal(a.value-1e4,2));return s&&r.push("enemybges="+s),addValueParam(r,"sims"),addBoolParam(r,"debug"),addBoolParam(r,"mass_debug"),addBoolParam(r,"loss_debug"),addBoolParam(r,"win_debug"),addBoolParam(r,"play_debug"),e&&r.push("autostart"),0<r.length?t+"?"+r.join("&"):t}function addValueParam(e,a,t){var n=$("#"+(t||a)).val();return!!n&&(e.push(a+"="+n),!0)}function addBoolParam(e,a){return!!$("#"+a).is(":checked")&&(e.push(a),!0)}var deckBuilders={};function load_deck_builder(e){if("player"===e)var a=$("#deck1").val();else{a=$("#deck2").val();var t=$("#mission").val(),n=$("#mission_level").val(),r=$("#raid").val(),i=$("#raid_level").val()}deck=a?base64.decodeHash(a):t?loadDeck.mission(t,n):r?loadDeck.raid(r,i):loadDeck.defaultDeck();var s=base64.encodeHash(deck),l="player"==e?"Player Deck":"Enemy Deck",o=e?$("#"+("player"==e?"deck1":"deck2")):null,d=deckBuilders[e];null==d||d.closed?deckBuilders[e]=open_deck_builder(l,s,null,o):d.focus()}function open_deck_builder(e,a,t,n){var r=["nosort"];a&&r.push("hash="+a),t&&r.push("inventory="+t),e&&r.push("name="+e),urlHelpers.paramDefined("ajax")&&r.push("ajax"),r.push("fromSim");var i,s="DeckBuilder.html?"+r.join("&"),l=Math.min(screen.width,1e3),o=Math.min(screen.height,700),d=Number((screen.width-l)/2),c=Number((screen.height-o)/2),u="scrollbars,left="+d+"top="+c+",width="+l+",height="+o+",top="+c+",left="+d,p=window.open(s,"",u);return $(p).load((i=n,function(){i&&(p.updateSimulator=function(e){i.val(e).change()})})),p}function display_generated_link(){outp('<br><i>Non-autostart link</i><br><a href="'+generate_link()+'">'+generate_link()+'</a><br><br><i>Autostart link</i><br><a href="'+generate_link(1)+'">'+generate_link(1)+"</a><br><br>")}function clear_history(){battle_history="",display_history()}function display_history(){outp("<br><hr>"+(battle_history||"No history available.")+'<hr><br><br><input type="button" value="Clear History" onclick="clear_history();" style="text-align: center; font-weight: normal;"><br><br>')}var current_timeout,cache_player_deck,cache_cpu_deck,cache_player_deck_cards,cache_cpu_deck_cards,battle_history="",mass_debug=!1,loss_debug=!1,win_debug=!1,found_desired=!1,play_debug=!1,getdeck="",getdeck2="",getcardlist="",getcardlist2="",getordered=!1,getordered2=!1,getexactorder=!1,getexactorder2=!1,getmission=0,missionlevel=0,getraid=!1,raidlevel=0,getbattleground="",enemybges="",selfbges="",mapbges="",getsiege=0,tower_level=0,tower_type=0,pvpAI=!0,closeDiv=!1,wins=0,losses=0,draws=0,games=0,points=0,num_sims=0,last_games=[],sims_left=0,surge=!1,battleground=[],total_turns=0,choice=void 0,tournament=!1,suppressOutput=!1,orders={},cardStats={};function getTutorialScript(){for(var e=[{msg:"Welcome to SIM Spellstone!  This is a brief tutorial of how to use the Simulator."},{ui:"#setup-container",msg:"Here is where you set everything up for a simulation.",actions:[i]},{ui:"#setup-container",msg:'When you are done, you can click the "Setup" bar to hide this section.',actions:[r]},{ui:"#setup-container",msg:"Clicking it again will open it back up.",actions:[i]},{ui:"#attacker-container",msg:"Use this section to set up the deck for the attacker."},{ui:"#edit-player",msg:'Click "Edit" to open the DeckBuilder and create a deck.'},{ui:"#load-player",msg:'Click "Load" to choose a deck from the ones you have saved in the DeckBuilder.'},{ui:"#attacker-hash-container",msg:"If you have a deck hash, you can simply paste it here as well."},{ui:"#attacker-advanced",msg:"This section contains some additional settings for the attacker that determine how their deck is played."},{ui:"#auto-container",msg:"Check this to have fights run on auto, rather than playing them yourself.",showFor:"battle"},{ui:"#auto-container",msg:'Setting the attacker to "auto" also enables the "Ordered" and "Do Not Shuffle" options.',showFor:"battle"},{ui:"#ordered-container",msg:"Check this to have the AI attempt to play the attacker's deck as close as possible to the order that the cards are listed."},{ui:"#exactorder-container",msg:"Check this to disable shuffling of the attacker's deck."},{ui:"#defender-container",msg:"Use this section to set up the deck for the defender."},{ui:"#defender-hash-container",msg:"You can manually create a deck for the defender here."},{ui:"#pve-container",msg:"Or you can choose a PvE deck to sim against.",actions:[o]},{ui:"#campaign-container",msg:"To choose a campaign mission, first pick a Campaign from the dropdown...",actions:[l]},{ui:"#mission-container",msg:"... then pick a Mission from the mission dropdown.",actions:[d,l,function(){$("#mission").val(11).change()}]},{ui:"#raid-container",msg:"To fight against a raid boss, pick the desired Raid from the dropdown",actions:[o,function(){$("#raid").val(24005).change()}]},{ui:"#defender-advanced",msg:"This section contains some additional settings for the defender that determine how their deck is played.",actions:[d]},{ui:"#surge-container",msg:"Check this to have the defender go first.",showFor:"battle"},{ui:"#tower-container",msg:"Use these fields to set up a tower for the defender."},{ui:"#siege-container",msg:"Check this field to turn the tower on."},{ui:"#tower_level",msg:"This field determines the BR of the defender.  The tower's level is one less than the defender's BR."},{ui:"#tower_type",msg:"This field determines which type of tower the defender will have."},{ui:"#bge-container",msg:"Check/uncheck boxes here to set active battleground effects.",actions:[s,i]},{ui:"#view-container",msg:'Click "View" to display the currently set decks for the attacker and defender.',actions:[r,function(){$("#view-container").accordion("option","active",0)}]},{ui:"#view-container",msg:"Click it again to hide it.",actions:[s]},{ui:"#sims-container",msg:"This field determines how many fights to run.",showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Simulate" to run a batch of fights.',showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Battle" to start a fight.',showFor:"battle"},{ui:"#generate_link",msg:'Click "Generate Link" to create a link that will open this tool with all of the current settings.'},{msg:'To view this tutorial again at any time, you can click the "Help" button.  (Note: this will reset the Simulator.)'}],a=require("urlHelpers").getCurrentPage(),t=0;t<e.length;t++){var n=e[t];n.showFor&&n.showFor!==a&&e.splice(t--,1)}function r(){$("#setup-container").accordion("option","active",null)}function i(){$("#setup-container").accordion("option","active",0)}function s(){$("#view-container").accordion("option","active",null)}function l(){$("#campaign").val(1).change()}function o(){$("#campaign").val("").change()}function d(){$("#raid").val("").change()}return e}$(document).ready(function(){var a=require("storageAPI"),s=getTutorialScript(),e=$("<div></div>");function t(){a.shouldShowTutorial?n():d()}function n(){o=0,c(),$("#tutorial").show()}$(document.body).append(e),e.load("templates/tutorial-overlay.html",null,function(){e.replaceWith(function(){return $(this).contents()}),$("#tutorial-show").prop("checked",a.shouldShowTutorial).change(function(e){a.setShowTutorial(this.checked)}),$("#help").click(n),$("#tutorial-close, #tutorial-skip").click(d),$("#tutorial-next").click(r),$("#tutorial-prev").click(i),"undefined"==typeof delayTutorial&&t()});var l,o=0;function r(){o++,c()}function i(){o--,c()}function d(){$("#tutorial").hide(),$("#tutorial-permahide").is(":checked")&&a.hideTutorial()}function c(){clearTimeout(l);var e=s[o],a=e.actions;if(a)for(var t=0;t<a.length;t++)a[t]();var n=e.msg,r=e.ui;if(r){var i=$(r);e.dialog&&(i=i.parent()),u(i),a&&(l=setTimeout(u,500,i)),n.indexOf(!1)&&(n=n.replace(/\{0\}/g,i.text()))}else $(".overlay-fog").width(0).height(0);$("#tutorialMessage").text(n),o<s.length-1?($("#tutorial-next").show(),$("#tutorial-close").hide()):($("#tutorial-next").hide(),$("#tutorial-close").show()),0<o?$("#tutorial-prev").removeClass("disabled"):$("#tutorial-prev").addClass("disabled")}function u(e){var a=e.offset();$(".overlay-fog").css({top:a.top-2+"px",left:a.left-2+"px"}).width(e.outerWidth()+4+"px").height(e.outerHeight()+4+"px")}window.showTutorial=n,window.checkTutorial=t});
//# sourceMappingURL=simulator.min.js.map