for(var skillID in function(){var n={};window.define=function(e,t){n[e]="function"==typeof t?t():t},window.require=function(e){var t=n[e];if(t)return t;throw"Module '"+e+"' is not defined yet."}}(),"function"!=typeof Object.assign&&(Object.assign=function(e){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");e=Object(e);for(var t=1;t<arguments.length;t++){var n=arguments[t];if(null!=n)for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}),Function.prototype.debounce=function(n){var r,a=this;return function(){var e=this,t=arguments;clearTimeout(r),r=setTimeout(function(){r=null,a.apply(e,t)},n)}},Function.prototype.throttle=function(n){var r,a=this;return function(){var e=this,t=arguments;if(!r){a.apply(e,t);r=setTimeout(function(){r=null,a.apply(e,t)},n)}}},define("factions",{names:{0:"Factionless",1:"Aether",2:"Chaos",3:"Wyld",4:"Frog",5:"Elemental",6:"Angel",7:"Undead",8:"Void",9:"Dragon",10:"Avian",11:"Goblin",12:"Seafolk",13:"Insect",14:"Bear",15:"Token",16:"Mecha",17:"Knight",999:"Tower"},IDs:{Factionless:0,Aether:1,Chaos:2,Wyld:3,Frog:4,Elemental:5,Angel:6,Undead:7,Void:8,Dragon:9,Avian:10,Goblin:11,Seafolk:12,Insect:13,Bear:14,Token:15,Mecha:16,Knight:17,Tower:999}}),define("skillApi",function(){function c(e,t){var n=t.id;switch(SKILL_DATA[n].type){case"toggle":return void(e[n]=!0);case"passive":e[t.id]=(0|e[t.id])+t.x;break;case"flurry":e[t.id]=t;break;case"onDeath":e.onDeathSkills.push(t);break;case"earlyActivation":e.earlyActivationSkills.push(t);break;case"activation":default:e.skill.push(t)}}function l(e){var t={};return t.id=e.id,t.x=e.x,t.mult=e.mult,t.on_delay_mult=e.on_delay_mult,t.all=e.all,t.y=e.y,t.z=e.z,t.c=e.c,t.s=e.s,t}return{setSkill:c,copySkill:l,copySkills:function(e,t,n){e.skill=[],e.earlyActivationSkills=[],e.onDeathSkills=[];var r=[],a=!0;for(var i in t){var o=t[i];if(o.c){var s=l(o);c(e,s),r.push(s),a=!1}else if(n){var s=l(o);s.x=Math.ceil(s.x*n),c(e,s)}else c(e,o)}e.reusableSkills=a,e.skillTimers=r},nameFromId:function(e){var t=SKILL_DATA[e];return t?t.name:e}}}),define("runeApi",function(){function c(e){return RUNES[e]}return{addRunes:function(e,t){e.runes||(e.runes=[]);for(var n=0,r=t.length;n<r;n++){var a=t[n].id,i=c(a).stat_boost;for(var o in e.runes.push({id:a,stat_boost:i}),i){var s=i[o];"skill"===o||(isNaN(s)&&(s=Math.max(Math.ceil(e[o]*s.mult),s.min_bonus||1)),e[o]+=parseInt(s))}}},canUseRune:function(e,t){var n=c(t),r=n.stat_boost;if(n.faction_req&&!e.isInFaction(n.faction_req))return!1;for(var a in r)if("skill"===a){var i=r[a],o=i.all?1:0;if(!e.hasSkill(i.id,o))return!1}return!0},getRune:c}}),define("cardInfo",function(){function n(e){return CARDS[e]}return{loadCard:n,isCommander:function(e){var t=n(e);return t&&"1"==t.card_type},isAssault:function(e){var t=n(e);return t&&"2"==t.card_type},isTrap:function(e){var t=n(e);return t&&"3"==t.card_type}}}),define("matchTimer",function(){function n(e,t){return((t-e)/1e3).toFixed(3)}return{elapsed:function(){var e=this.timeStop||Date.now();return n(this.timeStart,e)},batchElapsed:function(e){return t=e||this.batchStarted,n(t,Date.now());var t},startBatch:function(){this.batchStarted=Date.now()},stop:function(){this.timeStop=Date.now()},reset:function(){this.timeStart=Date.now(),this.timeStop=0}}}),define("urlHelpers",function(){return{paramDefined:function(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var r=t[n].split("=");if(decodeURIComponent(r[0])==e)return!0}return!1},paramValue:function(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var r=t[n].split("=");if(decodeURIComponent(r[0])==e)return decodeURIComponent(r[1]?r[1]:"")}return},getCurrentPage:function(){var e=window.location.href,t=e.indexOf(".html"),n=(e=e.substring(0,t)).lastIndexOf("/")+1;return e=e.substring(n).toLowerCase()}}}),define("debugLog",function(){return{enabled:!1,write:function(e){echo+=e},writeLine:function(e){echo+=e+"</br>"}}}),define("animations",function(){var e={drawField:function(e,t,n,r,a){var i=CARD_GUI.doDrawField(e,t,n,r,a);o.push(i),s||(c(),s=setInterval(c,500))},clearFrames:function(){o=[],clearInterval(s),s=null}},o=[],s=null,t=!1;function c(){if(0===o.length)t?(clearInterval(s),s=null):t=!0;else{var e=o.splice(0,1)[0];$("#cardSpace").children().remove().end().append(e),t=!1}}return e}),define("log",function(){var e={skill:function(e){var t=r.nameFromId(e.id);e.all&&(t+=" all");e.y&&(t+=" "+n.names[e.y]);e.s&&(t+=" "+r.nameFromId(e.s));e.c?t+=" every "+e.c+" turns":e.x&&(t+=" "+e.x);return t},name:function(e,t){if("cpu"===e.owner)var n="i";else var n="b";var r="<"+n+">";r+=e.name,e.runes.length&&(r+="*");1<e.maxLevel&&(r+="{"+e.level+"/"+e.maxLevel+"}");void 0!==e.key&&(r+=" ("+e.key+")");if(r+="</"+n+">",!t){if(r+="<u>",e.isCommander())r+=" [",void 0!==e.health_left?r+=i(e.health_left):r+=e.health,r+=" HP]";else if(e.isAssault()){r+=" [";var a=e.adjustedAttack();(isNaN(a)||null==a)&&(a=e.attack),r+=a,r+="/",void 0!==e.health_left?r+=i(e.health_left):r+=e.health,r+="/",void 0!==e.timer?r+=e.timer:r+=e.cost,r+="]"}r+="</u>"}return r}},n=require("factions"),r=require("skillApi");function i(e){return e>Math.floor(e)&&(e=e.toFixed(1)),e}return e}),define("base64",function(){"use strict";var i=require("cardInfo"),e={encodeHash:function(e){var t=[];e.commander&&t.push(e.commander);return t.concat(e.deck).map(r).join("")},decodeHash:function(e){for(var t,n={deck:[]},r=0;r<e.length;r+=5){var a=e.substr(r,5);(t=l(a))&&(i.loadCard(t.id)?!n.commander&&i.isCommander(t.id)?n.commander=t:n.deck.push(t):console.log("Could not decode '"+a+"' ("+t.id+")"))}n.commander||(n.commander=elariaCaptain);return n},fromDecimal:u,toDecimal:d,fromUnitInfo:r},o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!~",s={};for(var t in CARDS)if(t<1e4){var n=FUSIONS[t];(!n||Number(n)<1e4)&&(s[t]=!0)}var c=1e3;function r(e){var t=parseInt(e.id),n=parseInt(e.level)-1;if(s[t]){var r=Math.floor(n/7);n=n%7}else{r=Math.floor(t/1e4);t%=1e4}var a=0;e.runes.length&&(a=parseInt(e.runes[0].id),a%=5e3);var i=t;return u(i=(i=7*(i=3*i+r)+n)*c+a,5)}function l(e){var t=d(e),n=t%c,r=(t=(t-n)/c)%7,a=(t=(t-r++)/7)%3,i=t=(t-a)/3;s[i]?r+=7*a:0<a&&(i=Number(a+""+i));var o=makeUnitInfo(i,r);return 0<n&&o.runes.push({id:n+5e3}),o}function u(e,t){for(var n="",r=0;r<t;r++){var a=e%64;n+=o[a],e=(e-a)/64}return n}function d(e){for(var t=0,n=e.length-1;0<=n;n--){t*=64,t+=o.indexOf(e[n])}return t}return e}),define("cardApi",function(){var e={byId:a,byIdSlim:function(e,t){var n=s.loadCard(e.id),r={};"1"==n.card_type?(r.isCommander=function(){return!0},r.isAssault=function(){return!1}):(r.isCommander=function(){return!1},r.isAssault=function(){return!0});if(n){if(r.id=n.id,r.name=n.name,r.rarity=n.rarity,r.maxLevel=n.maxLevel,e.level?(r.level=e.level,r.level>r.maxLevel&&(r.level=r.maxLevel)):r.level=1,t){if(r.attack=n.attack,r.health=n.health,r.cost=n.cost,r.set=n.set,r.card_type=n.card_type,r.type=n.type,r.sub_type=n.sub_type||[],r.skill=n.skill,1<r.level)for(var a in n.upgrades){var i=n.upgrades[a];if(void 0!==i.cost&&(r.cost=i.cost),void 0!==i.health&&(r.health=i.health),void 0!==i.attack&&(r.attack=i.attack),void 0!==i.desc&&(r.desc=i.desc),0<i.skill.length&&(r.skill=i.skill),a==r.level)break}var o=e.runes;o&&(r.skill=r.skill.slice(),l(r,o),h(r.skill,o))}}else r.id=void 0,r.name=void 0,r.card_type=void 0,r.set=void 0,r.type=void 0,r.sub_type=[],r.level=void 0,r.maxLevel=void 0,t&&(r.skill=[]);return r},byIdWithBgeApplied:function(e,t,n){return t=t||SIMULATOR.battlegrounds.onCreate,a(e,t,null,n)},makeBattleground:t,applyDefaultStatuses:r},s=require("cardInfo"),_=require("skillApi"),c=require("runeApi"),n={attack_berserk:0,attack_valor:0,attack_rally:0,attack_weaken:0,attack_corroded:0,corrosion_timer:0,mark_target:0,barrier_ice:0,corroded:0,enfeebled:0,enraged:0,envenomed:0,heartseeker:0,imbued:0,invisible:0,nullified:0,poisoned:0,protected:0,scorched:0,warded:0,jammed:!1,jammedSelf:!1,silenced:!1,valor_triggered:!1,dualstrike_triggered:!1,ondeath_triggered:!1,reanimated:!1};function r(e){for(var t in e.removeImbue(),e.enhanced={},n)e[t]=n[t]}function l(e,t){e.runes||(e.runes=[]);for(var n=0,r=t.length;n<r;n++){var a=t[n].id,i=c.getRune(a).stat_boost;for(var o in e.runes.push({id:a,stat_boost:i}),i){var s=i[o];"skill"===o||(isNaN(s)&&(s=Math.max(Math.ceil(e[o]*s.mult),s.min_bonus||1)),e[o]+=parseInt(s))}}}function a(e,t,n,r){var a=s.loadCard(e.id);if(a){a.skill||(a.skill=[]);var i=o(a,e.level,e.runes,t,n,r);return e.priority&&(i.priority=e.priority),i}return console.log(e.id+" not found"),(a={}).id=e.id,a.level=e.level,a.name=void 0,a.health=void 0,a.skill=[],a}function h(e,t,n){if(t)for(var r=0,a=t.length;r<a;r++){var i=t[r].id,o=RUNES[i].stat_boost;for(var s in o){var c=o[s];if("skill"===s)for(var l=c.id,u=c.x,d=c.mult,h=0;h<e.length;h++){var f=e[h];if(f.id===l&&(f.all||0)==(c.all||0)){f=_.copySkill(f),!u&&d&&(u=Math.ceil(f.x*d)),c.min_bonus&&(u=Math.max(u,c.min_bonus)),u&&(f.x+=parseInt(u)*n),c.c&&(f.c-=Math.min(f.c,parseInt(c.c)*n)),f.boosted=!0,e[h]=f;break}}}}}var i,o=function(){var d;function g(e,t){return a({id:e.id,level:e.level})[t]}function b(e,t,n){for(var r in t){var a=t[r];a.x&&((a=_.copySkill(a)).x+=Math.ceil(a.x*n),a.boosted=!0,t[r]=a,e.highlighted.push(a.id))}}for(var e in d={p:null,health_left:0,timer:0,key:void 0,isCommander:function(){return"1"==this.card_type},isAssault:function(){return"2"==this.card_type},isTrap:function(){return"3"==this.card_type},isAlive:function(){return 0<this.health_left},isDamaged:function(){return this.health_left<this.health},isActive:function(){return 0==this.timer},isActiveNextTurn:function(){return this.timer<=1},isInactive:function(){return 1<=this.timer},isUnjammed:function(){return!this.jammed},isUnsilenced:function(){return!this.silenced},imbue:function(e){this.imbued||(this.imbued={});var t,n=this.imbued,r=e.id;switch(SKILL_DATA[r].type){case"toggle":return this[r]=!0,void(this.imbued[r]=1);case"passive":return this[r]+=parseInt(e.x),void(this.imbued[r]=(this.imbued[r]||0)+e.x);case"flurry":return void(this.flurry||(this.flurry=e,this.flurry.countdown=0,this.imbued.flurry=!0));case"onDeath":t="onDeathSkills";break;case"earlyActivation":t="earlyActivationSkills";break;case"activation":default:t="skill"}if(void 0===n[t]){var a=this[t];n[t]=a.length,this[t]=a.slice()}this[t].push(e)},scorch:function(e){var t=this.scorched;t?(t.amount+=e,t.timer=2):this.scorched={amount:e,timer:2}},removeImbue:function(){var e=this.imbued;if(e){for(var t in e){var n=e[t];"skill"===t||"earlyActivationSkills"===t||"onDeathSkills"===t?this[t]=this[t].slice(0,n):this[t]-=n}this.imbued=0}},hasSkill:function(e,t){var n;switch(SKILL_DATA[e].type){case"toggle":case"passive":case"flurry":return this[e];case"onDeath":n=this.onDeathSkills;break;case"earlyActivation":n=this.earlyActivationSkills;break;case"activation":default:n=this.skill}for(var r in n){var a=n[r];if(a.id===e&&(void 0===t||(a.all||0)==t))return!0}return!1},hasAttack:function(){return 0<this.adjustedAttack()},attackPlusBuffs:function(){return this.attack+this.attack_rally+this.attack_berserk+this.attack_valor},adjustedAttack:function(){return this.attack+this.attack_rally+this.attack_berserk+this.attack_valor-this.attack_weaken-this.attack_corroded},permanentAttack:function(){return this.attack+this.attack_berserk+this.attack_valor},isInFaction:function(e){if(void 0===e)return 1;var t=e.split(",");if(t.length<=1)return this.type==e?1:0<=this.sub_type.indexOf(e.toString())?1:0;for(var n=0;n<t.length;n++)if(!this.isInFaction(t[n]))return 0;return 1},resetTimers:function(){for(var e=0,t=this.skillTimers.length;e<t;e++)this.skillTimers[e].countdown=0},addRunes:function(e){l(this,e)}},SKILL_DATA){var t=SKILL_DATA[e].type;"passive"===t?d[e]=0:"toggle"===t&&(d[e]=!1)}return r(d),function(e,t,n,r,a,i){t||(t=1);var o=Object.create(d);o.id=e.id,o.name=e.name,o.attack=e.attack,o.health=e.health,o.maxLevel=e.maxLevel,o.level=t>o.maxLevel?o.maxLevel:t,o.cost=e.cost,o.rarity=e.rarity,o.card_type=e.card_type,o.type=e.type,o.sub_type=e.sub_type||[],o.set=e.set;var s,c=e.skill;if(1<o.level)for(var l in e.upgrades)if(void 0!==(s=e.upgrades[l]).cost&&(o.cost=s.cost),void 0!==s.health&&(o.health=s.health),void 0!==s.attack&&(o.attack=s.attack),void 0!==s.desc&&(o.desc=s.desc),0<s.skill.length&&(c=s.skill),l==o.level)break;if(c=c.slice(),r&&r.length&&function(t,e,n,r){t.highlighted=[];for(var a=0;a<n.length;a++){var i=n[a];if("statChange"==i.modifierType&&!r)for(var o=0;o<i.effects.length;o++){var s=i.effects[o];t.isInFaction(s.y)&&Object.keys(s).forEach(function(e){t[e]=s[e]})}}}(o,0,r,i),n){o.addRunes(n);var u=1;r&&r.forEach(function(e){"runeMultiplier"==e.modifierType&&e.effects.forEach(function(e){o.isInFaction(e.y)&&(u=parseInt(e.mult))})}),h(c,n,u)}else o.runes=[];return r&&r.length&&function(e,t,n,r){e.highlighted=[];for(var a=0;a<n.length;a++){var i=n[a];if("evolve_skill"===i.modifierType)for(var o=0;o<i.effects.length;o++){var s=i.effects[o];for(var c in t){var l=t[c];l.id==s.id&&l.all==s.all&&((l=_.copySkill(l)).id=s.s,l.boosted=!0,t[c]=l,e.highlighted.push(l.id))}}else if("add_skill"===i.modifierType)for(o=0;o<i.effects.length;o++){var u=i.effects[o];if(e.isInFaction(u.y)){if(u.rarity&&e.rarity!=u.rarity)continue;var d={};if(d.id=u.id,d.x=u.x||0,u.mult)if(u.base){var h=g(e,u.base);d.x+=Math.ceil(u.mult*h)}else d.mult=u.mult;if(d.z=u.z,d.c=u.c,d.s=u.s,d.all=u.all,u.card&&(d.card=u.card),u.level&&(d.level=u.level),d.boosted=!0,u.mult&&u.base&&0==d.x)continue;t.push(d),e.highlighted.push(d.id)}}else if("scale_attributes"!==i.modifierType||r){if("scale_stat"===i.modifierType&&!r)for(o=0;o<i.effects.length;o++)f=i.effects[o],e.isInFaction(f.y)&&(e[i.scaledStat]+=Math.ceil(g(e,f.base)*f.mult))}else for(var o=0;o<i.effects.length;o++){var f=i.effects[o];if(e.isInFaction(f.y)){var p=f.mult,m=Math.ceil(e.attack*p);e.attack+=m;var v=Math.ceil(e.health*p);e.health+=v,b(e,t,p)}}}}(o,c,r,i),a&&b(o,c,a),_.copySkills(o,c),o}}(),t=((i=function(e,t,n){this.name=e,_.copySkills(this,[t],n)}).prototype={p:null,name:null,runes:[],isCommander:function(){return!1},isAssault:function(){return!1},resetTimers:function(){for(var e=0,t=this.skillTimers.length;e<t;e++)this.skillTimers[e].countdown=0}},function(e,t,n){return new i(e,t,n)});return e}),define("loadDeck",function(){var l=require("cardInfo"),_=require("cardApi");function k(e){for(var t=function(e){for(var t,n=e.id;void 0!==(n=REVERSE_FUSIONS[t=n]););return t}(e),n=-1;void 0!==t;)n++,t=FUSIONS[t];return n}function y(e,t,n){if(t=parseInt(t),e.mastery_level&&t<parseInt(e.mastery_level))return null;if(e.remove_mastery_level&&t>=parseInt(e.remove_mastery_level))return null;var r=e.id,a=!1;r||(r=function(e){var t=[];for(var n in CARDS)if(!REVERSE_FUSIONS[n]){var r=CARDS[n];if("1"!=r.card_type&&!(e.max_rarity&&Number(e.max_rarity)<Number(r.rarity)||e.min_rarity&&Number(e.min_rarity)>Number(r.rarity))&&(!e.type||e.type==r.type||0<=r.sub_type.indexOf(e.type.toString()))){if(e.set&&e.set.split(",").indexOf(r.set)<0)continue;t.push(n)}}return t[~~(Math.random()*t.length)]}(e),a=!0);var i=e.level||1;if(n<=t)i=7,u(r)&&(r=d(r));else if(1<t&&l.isCommander(r)){var o=(Number(l.loadCard(r).rarity)+1)/(n-1),s=t-1;i=Math.ceil(o*s)}var c=makeUnitInfo(r,i);return a&&(c.randomInfo={unitInfo:e,level:t,maxedAt:n}),c}function w(e){var t=parseInt(l.loadCard(e.id).rarity)+2;if(e.level==t){if(!u(e.id))return!1;e.id=d(e.id,1),e.level=1}else e.level++;return!0}function u(e){return!(-1<i.indexOf(e))&&(!l.isCommander(e)&&!!FUSIONS[e])}function d(e,t){if(-1==i.indexOf(e))if(t)for(var n=0;n<t;n++)e=a(e);else do{var r=a(e);e=r}while(e!==r);return e}function a(e){var t=FUSIONS[e];return t||e}var i=["8005","8006","8007","8008","8009","8010"];function o(e,t,n){var r=n+1;t||(t=r);var a=[];a.deck=[];var i=function(e,t){t=parseInt(t);var n=e.commander;if(n.card){for(var r=[],a=0;a<n.card.length;a++){var i=n.card[a],o=parseInt(i.min_mastery_level)||0,s=parseInt(i.max_mastery_level)||999;o<=t&&t<=s&&r.push(i)}(n=r[~~(Math.random()*r.length)]).possibilities=r}return n}(e,t),o=y(i,t,r);i.possibilities&&(o.randomInfo={possibilities:i.possibilities,level:t,maxedAt:r}),a.commander=o;var s=e.deck,c=a.deck;for(var l in s){var u=y(s[l],t,r);u&&c.push(u)}var d,h,f,p,m=function(e){for(var t=0,n=0;n<e.length;n++){var r=e[n],a=_.byId(r);t+=(k(a)+1)*a.maxLevel-1}return t}(c),v=(d=t,f=m,p=7==(h=r)?(d-1)/(h-1):d/h,Math.ceil(f*p));if(1<t&&t<r)for(var g=c.slice();0<v&&0<g.length;){var b=Math.floor(Math.random()*g.length);w(g[b])?v--:g.splice(b,1)}return a}function n(e){for(var t=[],n=0,r=e.length;n<r;n++)t[n]=e[n];return t}return{mission:function(e,t){var n=MISSIONS[e];return n?o(n,t,6):0},raid:function(e,t,n){n||(n=25);var r=RAIDS[e];{if(r){var a={commander:r.commander,deck:r.deck.card};return o(a,t,Number(r.upgradeLevels))}return 0}},defaultDeck:function(){return{commander:elariaCaptain,deck:[]}},copyCardList:n,copyDeck:function(e){var t={};return t.commander=e.commander,t.deck=n(e.deck),t},getDeckCards:function(e,t){var n={};n.commander=_.byId(e.commander),n.deck=[];for(var r=e.deck,a=SIMULATOR.battlegrounds.onCreate.filter(function(e){return!("player"===t&&e.enemy_only||"cpu"===t&&e.ally_only)}),i=0,o=r.length;i<o;i++)n.deck.push(_.byIdWithBgeApplied(r[i],a));return n}}}),define("unitInfo",function(){var e={areEqual:function(e,t){if(!e!=!t)return!1;var n=a.fromUnitInfo(e),r=a.fromUnitInfo(t);return n===r},getEnhancement:function(e,t,n){var r=e.enhanced,a=r&&r[t]||0;a<0&&(a=Math.ceil(n*-a));return a},initializeUnit:function(e,t,n){e.owner=t,e.timer=e.cost,e.health_left=e.health,r.applyDefaultStatuses(e),e.key=n,e.reusableSkills||e.resetTimers()},isImbued:function(e,t,n){var r;switch(SKILL_DATA[t].type){case"flurry":case"toggle":return e.imbued[t];case"passive":return e[t]===e.imbued[t];case"onDeath":r="onDeathSkills";break;case"earlyActivation":r="earlyActivationSkills";break;case"activation":default:r="skill"}return void 0!==e.imbued[r]&&n>=e.imbued[r]}},a=require("base64"),r=require("cardApi");return e}),define("bgeApi",function(){var e={getBattlegrounds:function(e,t,n,r,a,i,o,s){var c={onCreate:[],onTurn:[],onCardPlayed:[]};v(c,e),v(c,t,"player"),v(c,n,"cpu"),function(e,t,n){if(t)for(var r=t.split(","),a=0;a<r.length;a++){var i=r[a].split("-"),o=i[0],s=i[1],c=i[2],l=Object.keys(MAP_BATTLEGROUNDS).filter(function(e){return MAP_BATTLEGROUNDS[e].location_id==o})[0],u=(l=MAP_BATTLEGROUNDS[l]).effects[s].upgrades[c];m(e,u,n)}}(c,r,"player"),a?function(e,t,n){var r=CAMPAIGNS[t];if(r){var a=r.battleground_id;if(a){var i=BATTLEGROUNDS[a];if(n=Number(n)-1,!i.starting_level||Number(i.starting_level)<=n){if(i.scale_with_level){i=JSON.parse(JSON.stringify(i));for(var o=n-Number(i.starting_level),s=0;s<i.effect.length;s++){var c=i.effect[s];c.mult=c.base_mult+c.mult*o}}m(e,i,"cpu")}}}}(c,a,i):o&&function(e,t,n){var r=RAIDS[t].bge;if(r){var a=BATTLEGROUNDS[r];if(a&&Number(n)>=Number(a.starting_level))for(var i=a.enemy_only,o=0;o<a.effect.length;o++){var s=a.effect[o],c=s.effect_type;if("skill"===c){if(a.scale_with_level)var l=a.scale_with_level*(n-a.starting_level+1);else var l=1;var u=d.makeBattleground(a.name,s,l);u.enemy_only=i,e.onTurn.push(u)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(c)){var u=h(a.name,s);u.enemy_only=i,e.onCreate.push(u)}else if(0<=["scale_attack","scale_health"].indexOf(c)){var u=f(a.name,s);u.enemy_only=i,e.onCreate.push(u)}else if("trap_card"===c){var u=p(a.name,s);u.enemy_only=i,e.onCardPlayed.push(u)}}}}(c,o,s);return c}},l=require("log"),d=require("cardApi"),u=require("debugLog");function h(e,t){return{name:e,modifierType:t.effect_type,effects:[t]}}function f(e,t){return{name:e,modifierType:"scale_stat",scaledStat:t.effect_type.replace("scale_",""),effects:[t]}}var n,r,s=((n=function(e,t){this.p=null,this.name=e,this.effect=t,this.runes=[]}).prototype={onCardPlayed:function(e){SIMULATOR.onPlaySkills[this.effect.id](this,e,this.effect)},isCommander:function(){return!1},isAssault:function(){return!1}},function(e,t){return new n(e,t)}),p=((r=function(e,t){this.name=e,this.id=t.id,this.base=t.base,this.mult=t.mult,this.target_deck=t.target_deck,this.y=t.y}).prototype={onCardPlayed:function(e,t,n){var r="opponent"===this.target_deck?n:t;if(e.isInFaction(this.y)){for(var a=[],i=0;i<r.length;i++)(e=r[i]).trap||a.push(e);if(a.length){var o=Math.ceil(e[this.base]*this.mult),s=makeUnitInfo(this.id,o),c=d.byId(s);a[~~(Math.random()*a.length)].trap=c,u.enabled&&(echo+=this.name+" inserts "+l.name(c)+" into the opposing deck.<br/>")}}}},function(e,t){return new r(e,t)});function m(e,t,n){for(var r=0;r<t.effect.length;r++){var a=t.effect[r],i=a.effect_type;if("skill"===i){var o=d.makeBattleground(t.name,a);"player"===n&&(o.ally_only=!0),"cpu"===n&&(o.enemy_only=!0),e.onTurn.push(o)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(i)){o=h(t.name,a);"player"===n&&(o.ally_only=!0),"cpu"===n&&(o.enemy_only=!0),e.onCreate.push(o)}else if(0<=["scale_attack","scale_health"].indexOf(i)){o=f(t.name,a);"player"===n&&(o.ally_only=!0),"cpu"===n&&(o.enemy_only=!0),e.onCreate.push(o)}else if("trap_card"===i){o=p(t.name,a);"player"===n&&(o.ally_only=!0),"cpu"===n&&(o.enemy_only=!0),e.onCardPlayed.push(o)}else if("on_play"===i){(o=s(t.name,a.effect)).attacker=a.attacker,o.defender=a.defender,o.first_play=a.first_play,"player"===n&&(o.ally_only=!0),"cpu"===n&&(o.enemy_only=!0),e.onCardPlayed.push(o)}}}function v(e,t,n){if(!t)return null;for(var r=t.split(","),a=0;a<r.length;a++){var i=r[a];m(e,BATTLEGROUNDS[i],n)}}return e}),SKILL_DATA){var skillInfo=SKILL_DATA[skillID];"flurry"===skillID?skillInfo.type="flurry":0<=["turnStart","onAttack","onDamaged","turnEnd"].indexOf(skillInfo.type)&&(skillInfo.type="passive")}var REVERSE_FUSIONS={};for(var id in FUSIONS){var fusion=FUSIONS[id];REVERSE_FUSIONS[fusion]=id}var DATA_UPDATER=function(){var i="https://spellstone.synapse-games.com",h={},f={},o=null;var s=["cards_heroes.xml","cards_premium_aether.xml","cards_premium_chaos.xml","cards_premium_wyld.xml","cards_reward.xml","cards_shard.xml","cards_special.xml","cards_standard.xml","cards_story.xml","fusion_recipes_cj2.xml"];function p(e){var t,n,r={};if(r.id=v(e,"id"),r.name=v(e,"name"),d(r,e,"desc"),r.picture=v(e,"picture")||(t=v(e,"asset_prefab"),n="prefab_",t?n+t:t),!r.picture){var a=v(e,"portrait");r.picture=a?"portrait_"+a.toLowerCase().replace("portrait_",""):"NotFound"}var i=v(e,"hidden_until")||v(e,"hidden_until_time");i&&(r.hidden_until=i+"000"),r.rarity=v(e,"rarity"),r.set=v(e,"set"),r.card_type=v(e,"card_type"),m(r,e,"shard_card"),r.type=v(e,"type")||0,r.sub_type=g(e,"sub_type")||[],m(r,e,"health"),"1"!=r.card_type&&(m(r,e,"attack"),m(r,e,"cost"));var o=function(e){for(var t=e.getElementsByTagName("upgrade"),n={},r=0;r<t.length;r++)n[r+2]=u(t[r]);return n}(e);return r.maxLevel=1+Object.keys(o).length,r.skill=c(e),r.upgrades=o,r}function c(e){for(var t=e.childNodes,n=[],r=0;r<t.length;r++){var a=t[r];"skill"===a.nodeName&&n.push(l(a))}return n}function l(e){var t={id:v(e,"id",!0)};return m(t,e,"x",!0),m(t,e,"mult",!0),m(t,e,"on_delay_mult",!0),d(t,e,"y",!0),m(t,e,"z",!0),m(t,e,"c",!0),d(t,e,"s",!0),d(t,e,"all",!0),t}function u(e){var t={};return m(t,e,"attack"),m(t,e,"health"),m(t,e,"cost"),d(t,e,"desc"),t.skill=c(e),t}function d(e,t,n,r){var a=v(t,n,r);null!=a&&0<a.length&&(e[n]=a)}function m(e,t,n,r){var a,i=null!=(a=v(t,n,r))?Number(a):-1;0<=i&&(e[n]=i)}function v(e,t,n){if(n)return e.getAttribute(t);var r=g(e,t);return r?r[0]:null}function g(e,t){var n=null,r=$(e).children(t);if(0<r.length){n=[];for(var a=0;a<r.length;a++)n.push(r[a].textContent)}return n}return{updateData:function(e,t){$("body").addClass("loading"),$("#loadingSplash").html("Checking for New Cards...");var n=Date.now();if(!o||6e4<o-n||t){o=n,h={};var r=[];r.push(function(){for(var e=[],t=0;t<s.length;t++){var n=jQuery.ajax({url:i+"/assets/"+s[t],success:function(e){for(var t="undefined"!=typeof spoilers,n=e.getElementsByTagName("unit"),r=0;r<n.length;r++){n[r];var a=v(n[r],"id"),i=p(n[r]),o=!1;CARDS[a]?JSON.stringify(CARDS[a])!==JSON.stringify(i)&&(o=!0):o=!0,o&&(t&&(spoilers[a]=!0),h[a]=i),CARDS[a]=i}for(var s=e.getElementsByTagName("fusion_recipe"),r=0;r<s.length;r++){var c=s[r],l=v(c,"card_id",!1),u=c.getElementsByTagName("resource")[0];if(u){var d=v(u,"card_id",!0);FUSIONS[d]&&FUSIONS[d]==l||(f[d]=l,FUSIONS[d]=l)}}},async:!0,cache:!1});e.push(n)}return $.when.apply($,e)}());var a=function(){!function(){if(void 0!==storageAPI){var e=storageAPI.getField("GameData","CardCache");e?(e.newCards=e.newCards||{},e.newFusions=e.newFusions||{},$.extend(e.newCards,h),$.extend(e.newFusions,f)):e={newCards:h,newFusions:f},e.lastUpdated=Date.now(),storageAPI.setField("GameData","CardCache",e)}}(),$("body").removeClass("loading"),e&&e()};$.when.apply($,r).then(a,a)}else e&&e()}}}();function shuffle(e){var t,n,r,a=e.length;if(0==a)return!1;for(;--a;)t=~~(Math.random()*(a+1)),n=e[a],r=e[t],e[a]=r,e[t]=n}function makeUnitInfo(e,t,n){var r={id:Number(e),level:Number(t),runes:[]};return n&&(r.runes=n),r}window.loadCardCache=function(){var e=storageAPI.getField("GameData","CardCache");if(e&&e.lastUpdated>DataUpdated)e.newCards&&($.extend(CARDS,e.newCards),$.extend(FUSIONS,e.newFusions)),DataUpdated=e.lastUpdated;else{var t={newCards:{},newFusions:{},lastUpdated:Date.now()};storageAPI.setField("GameData","CardCache",t)}};var elariaCaptain=makeUnitInfo(202,1),SIM_CONTROLLER=function(){var r=require("matchTimer"),e=require("debugLog");return{getConfiguration:function(){getdeck=$("#deck1").val(),getordered=$("#ordered").is(":checked"),getexactorder=$("#exactorder").is(":checked"),getdeck2=$("#deck2").val(),getcampaign=$("#campaign").val(),getmission=$("#mission").val(),missionlevel=$("#mission_level").val(),getraid=$("#raid").val(),raidlevel=$("#raid_level").val(),getordered2=$("#ordered2").is(":checked"),getexactorder2=$("#exactorder2").is(":checked"),surge=$("#surge").is(":checked"),getsiege=$("#siege").is(":checked"),tower_level=$("#tower_level").val(),tower_type=$("#tower_type").val(),BATTLEGROUNDS&&(getbattleground=getSelectedBattlegrounds(),selfbges=getSelectedBattlegrounds("self-"),enemybges=getSelectedBattlegrounds("enemy-"),mapbges=getmission?getSelectedMapBattlegrounds():""),sims_left=$("#sims").val()||1,e.enabled=$("#debug").is(":checked"),(play_debug=e.enabled&&$("#play_debug").is(":checked"))&&(e.enabled=!1),mass_debug=$("#mass_debug").is(":checked"),win_debug=$("#win_debug").is(":checked"),loss_debug=$("#loss_debug").is(":checked"),showAnimations=$("#animations").is(":checked"),$("#auto_mode").length&&(auto_mode=$("#auto_mode").is(":checked"),SIMULATOR.user_controlled=!auto_mode),tournament=$("#tournament").is(":checked")},debug_end:function(e){var t;e=SIM_CONTROLLER.processSimResult(),sims_left=0,r.stop();var n="";getdeck2&&(n=" ("+SIMULATOR.calculatePoints()+" points)"),t="draw"==e?"<br><h1>DRAW"+n+"</h1><br>":e?"<br><h1>WIN"+n+"</h1><br>":"<br><h1>LOSS"+n+"</h1><br>",echo&&outputTurns(echo),setSimStatus(t),showUI(),SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(SIMULATOR.simulation_turns),SIM_CONTROLLER.end_sims_callback&&SIM_CONTROLLER.end_sims_callback()},end_sims_callback:null,stop_sims_callback:null}}();!function(){var e=require("bgeApi"),o=require("matchTimer"),t=require("urlHelpers"),s=require("debugLog");function c(){if(SIMULATOR.user_controlled)l(!0)&&SIM_CONTROLLER.debug_end();else if(!s.enabled&&!play_debug||mass_debug||loss_debug||win_debug)if(0<sims_left){if(d<=u){var e=0;if(0<d){u=0;var t=games/(games+sims_left)*100;t=t.toFixed(2);var n=o.elapsed(),r=o.batchElapsed();setSimStatus("Running simulations...",n,(e=0==r?0:d/r).toFixed(1)),showWinrate()}(d=1)<e&&(d=Math.ceil(e/8)),sims_left<d&&(d=sims_left),(s.enabled||play_debug)&&(mass_debug||loss_debug||win_debug)&&(d=1),o.startBatch(),current_timeout=setTimeout(c,1);for(var a=0;a<d;a++)l()}}else{d=u=0,o.stop();n=o.elapsed();var i=games/n;i=i.toFixed(2),echo&&outp(echo),setSimStatus("Simulations complete.",n,i),showWinrate(),showUI(),SIM_CONTROLLER.end_sims_callback&&SIM_CONTROLLER.end_sims_callback()}else l(!0),SIM_CONTROLLER.debug_end()}SIM_CONTROLLER.startsim=function(){return total_turns=0,o.reset(),echo="",d=games=0,SIM_CONTROLLER.getConfiguration(),SIMULATOR.battlegrounds=e.getBattlegrounds(getbattleground,selfbges,enemybges,mapbges,getcampaign,missionlevel,getraid,raidlevel),hideUI(),SIMULATOR.setupDecks(),points=draws=losses=wins=0,outp(""),SIMULATOR.user_controlled?setSimStatus(""):(hideTable(),setSimStatus("Initializing simulations...")),window.ga("send","event","simulation","start","single-threaded",sims_left),current_timeout=setTimeout(c),!1},SIM_CONTROLLER.stopsim=function(){o.stop();var e=o.elapsed(),t=games/e;t=t.toFixed(2),SIMULATOR.simulating=!1,current_timeout&&clearTimeout(current_timeout),SIMULATOR.user_controlled||(setSimStatus("Simulations interrupted.",e,t),showWinrate()),showUI(),SIM_CONTROLLER.stop_sims_callback&&SIM_CONTROLLER.stop_sims_callback()};var n=t.paramValue("seedtest")||0;function l(e){if(n&&Math.seedrandom(n++),!SIMULATOR.simulate())return!1;e||SIM_CONTROLLER.processSimResult()}SIM_CONTROLLER.processSimResult=function(){var e;return e=!!SIMULATOR.field.player.commander.isAlive()&&(!SIMULATOR.field.cpu.commander.isAlive()||"draw"),0<d&&(0<sims_left&&sims_left--,u++),"draw"==e?draws++:e?wins++:losses++,points+=SIMULATOR.calculatePoints(),games++,total_turns+=SIMULATOR.simulation_turns,(s.enabled||play_debug)&&(loss_debug?"draw"==e?(echo="Draw found after "+games+" games. Displaying debug output... <br><br>"+echo,echo+="<br><h1>DRAW</h1><br>",sims_left=0):e?sims_left?echo="":(echo="No losses found after "+games+" games. No debug output to display.<br><br>",sims_left=0):(echo="Loss found after "+games+" games. Displaying debug output... <br><br>"+echo,echo+="<br><h1>LOSS</h1><br>",sims_left=0):win_debug?e&&"draw"!=e?(echo="Win found after "+games+" games. Displaying debug output... <br><br>"+echo,echo+="<br><h1>WIN</h1><br>",sims_left=0):sims_left?echo="":(echo="No wins found after "+games+" games. No debug output to display.<br><br>",sims_left=0):mass_debug&&(echo+="draw"==e?"<br><h1>DRAW</h1><br>":e?"<br><h1>WIN</h1><br>":"<br><h1>LOSS</h1><br>"),mass_debug&&sims_left&&(echo+="<br><hr>NEW BATTLE BEGINS<hr><br>")),e};var u=0,d=0}();var SIMULATOR={};!function(){var T=require("log"),p=require("cardApi"),i=require("skillApi"),e=require("base64"),L=require("unitInfo"),n=require("loadDeck"),x=require("debugLog"),R=require("animations");function l(e,t,n,r){var a=Z[t].assaults;if(!e.id)return 0;var i=a.length;if(L.initializeUnit(e,t,i),e.played=!0,e.isAssault()&&(a[i]=e),!x.enabled&&!play_debug||r||x.writeLine(T.name(Z[t].commander)+" plays "+T.name(e)),e.isTrap())g(e),S(e);else for(var o=0;o<Y.onCardPlayed.length;o++){var s=Y.onCardPlayed[o],c="player"===t?"cpu":"player";if(s.defender){if(!surge&&"cpu"!==t)continue;if(surge&&"player"!==t)continue;s.owner=c}else if(s.attacker){if(!surge&&"player"!==t)continue;if(surge&&"cpu"!==t)continue;s.owner=t}else{if(s.enemy_only&&"cpu"!==t)continue;if(s.ally_only&&"player"!==t)continue;s.owner=t}1<n&&s.first_play||s.onCardPlayed(e,X[t].deck,X[c].deck)}showAnimations&&R.drawField(Z,null,null,n)}function v(e){for(var t=Z[e].assaults,n=0,r=t.length;n<r;n++){var a=t[n];if(!a.isAlive()){x.enabled&&x.writeLine(T.name(a)+" <strong>is removed from field</strong>");var i=n;for(n++;n<r;n++)(a=t[n]).isAlive()?(t[a.key=i]=a,i++):x.enabled&&x.writeLine(T.name(a)+" <strong>is removed from field</strong>");t.length=i;break}}}function b(e){return[e[~~(Math.random()*e.length)]]}function _(e){return e.owner}function k(e){return"cpu"==e.owner?"player":"player"==e.owner?"cpu":void 0}function E(e,t,n,r,a){n>=t.health_left?t.health_left=0:t.health_left-=n,x.enabled&&a(e,t,n),r&&B(t),!t.isAlive()&&e&&M(t,e)}function B(e){var t=e.barrier_ice,n=Z[k(e)],r=n.assaults[e.key];r&&r.isAlive()||(r=n.commander),E(e,r,t,null,function(e,t,n){x.write(T.name(e)+"'s barrier shatters and hits "+T.name(t)+" for "+n+" damage"),x.writeLine(t.isAlive()?"":" and it dies")})}function u(e,t){return e[t]||r}function r(e,t){if(x.enabled){var n=SKILL_DATA[t.id]?SKILL_DATA[t.id].name:t.id;x.writeLine(T.name(e)+" attempts to use "+n+", but it is not implemented.")}return 0}function g(e){var t=e.earlyActivationSkills,n=t.length;if(n)if(e.silenced)x.enabled&&x.writeLine(T.name(e)+" is silenced and cannot use skills");else{var r=e.dualstrike_triggered;x.enabled&&r&&x.writeLine(T.name(e)+" activates dualstrike");for(var a=r?2:1,i=d(e),o=0;o<a;o++)for(var s=0;s<n&&i();s++){var c=t[s];if(!c.countdown){var l=u(h,c.id)(e,c);c.c&&0<l&&(c.countdown=c.c),showAnimations&&R.drawField(Z,null,null,re,e)}}}}function t(){return!0}function d(e){return e.isAlive?e.isAlive.bind(e):t}function M(e,t){if(!e.ondeath_triggered){var n=e.onDeathSkills,r=n.length;if(0!=r){for(var a=0;a<r;a++){var i=n[a];c[i.id](e,t,i),showAnimations&&R.drawField(Z,null,null,re,e)}e.ondeath_triggered=!0}}}var a=["backlash","counter","counterburn","counterpoison","armored","evade","stasis"];function y(e){return-1===a.indexOf(e)}function w(e,t){if(e.isAssault()&&t.isAlive()){var n=t.backlash;J(e,t,"Backlash",n,L.getEnhancement(t,"backlash",n))}}function O(e){return e.isActive()&&e.isUnjammed()?0:e.stasis||0}var s={burnself:function(e,t){var n=t.x;return e.scorched?(e.scorched.amount+=n,e.scorched.timer=2):e.scorched={amount:n,timer:2},x.enabled&&(echo+=T.name(e)+" inflicts scorch("+n+") on itself<br>"),1},scorchbreath:function(e,t){return s.burn(e,t)},burn:function(e,t){var n,r=k(e),a=Z[r].assaults;switch(t.id){case"scorchbreath":var i=Math.max(0,e.key-1),o=Math.min(a.length,e.key+2);n=a.slice(i,o);break;case"burnself":n=[e];break;default:n=a.slice(e.key,e.key+1)}if(!n.length)return 0;var s=t.x;s+=L.getEnhancement(e,"burn",s);for(var c=0,l=0;l<n.length;l++){var u=n[l];u.scorched?(u.scorched.amount+=s,u.scorched.timer=2):u.scorched={amount:s,timer:2},x.enabled&&(echo+=T.name(e)+" inflicts scorch("+s+") on "+T.name(u)+"<br>"),c++}return c},protect_ice:function(e,t){return s.protect(e,t,"barrier_ice")},protect_seafolk:function(e,t){return s.protect(e,t,null,null,!0)},evadebarrier:function(e,t){return s.protect(e,t,"invisible",function(e,t){return" and imbues it with invisible "+t})},protect:function(e,t,n,r,a){for(var i=t.y,o=_(e),s=t.x,c=t.all,l=Z[o].assaults,u=[],d=0,h=l.length;d<h;d++){!(m=l[d]).isAlive()||!m.isInFaction(i)||a&&m.isActive()||u.push(d)}if(!u.length)return 0;c||(u=b(u));var f=L.getEnhancement(e,t.id,s);s+=f;var p=0;for(d=0,h=u.length;d<h;d++){var m;if((m=l[u[d]]).nullified)m.nullified--,x.enabled&&(echo+=T.name(e)+" protects "+T.name(m)+" but it is nullified!<br>");else{p++;var v=s;if(!v){var g=t.mult;m.isActive()||(g+=t.on_delay_mult||0),v=Math.ceil(m.health*g)}m.protected+=v,n&&(m[n]=(m[n]||0)+v),x.enabled&&(f&&(echo+="<u>(Enhance: +"+f+")</u><br>"),echo+=T.name(e)+" barriers "+T.name(m)+" by "+v,"function"==typeof r&&(echo+=r(m,v)),echo+="<br>")}}return p},heal:function(e,t){for(var n=_(e),r=t.y,a=t.x,i=t.all,o=Z[n].assaults,s=[],c=0,l=o.length;c<l;c++){(h=o[c]).isAlive()&&h.isInFaction(r)&&(i||h.isDamaged())&&s.push(c)}if(!s.length)return 0;i||(s=b(s));var u=L.getEnhancement(e,t.id,a);a+=u;var d=0;for(c=0,l=s.length;c<l;c++){var h;if((h=o[s[c]]).nullified)h.nullified--,x.enabled&&(echo+=T.name(e)+" heals "+T.name(h)+" but it is nullified!<br>");else{d++;var f=a;if(!f){var p=t.mult;f=Math.ceil(h.health*p)}f>h.health-h.health_left&&(f=h.health-h.health_left),h.health_left+=f,x.enabled&&(u&&(echo+="<u>(Enhance: +"+u+")</u><br>"),echo+=T.name(e)+" heals "+T.name(h)+" by "+f+"<br>")}}return d},poisonstrike:function(e,t,n){return s.strike(e,t,!0)},strike:function(e,r,t){for(var n=k(e),a=r.x,i=r.y,o=r.all,s=Z[n].assaults,c=[],l=0,u=s.length;l<u;l++){(f=s[l]).isAlive()&&f.isInFaction(i)&&c.push(l)}if(!c.length)return 0;o||(c=b(c));var d=L.getEnhancement(e,r.id,a);a+=d;var h=0;for(l=0,u=c.length;l<u;l++){var f;if((f=s[c[l]]).invisible)f.invisible--,x.enabled&&(echo+=T.name(e)+" bolts "+T.name(f)+" but it is invisible!<br>");else{h++;var p=a,m=z(f,p);p=m.damage;var v=m.shatter,g=0;0<p&&t&&f.isAlive()&&a>f.poisoned&&(g=a,f.poisoned=g),E(e,f,p,v,function(e,t,n){echo+="<u>(Strike: +"+r.x,d&&(echo+=" Enhance: +"+d),echo+=m.echo,echo+=") = "+n+" damage</u><br>",echo+=T.name(e)+" bolts "+T.name(t)+" for "+n+" damage",t.isAlive()?g&&(echo+=" and inflicts poison("+g+") on it"):echo+=" and it dies",echo+="<br>"}),f.backlash&&w(e,f)}}return h},intensify:function(e,t,n){for(var r=k(e),a=t.x,i=t.y,o=t.all,s=Z[r].assaults,c=[],l=0,u=s.length;l<u;l++){(h=s[l]).isAlive()&&h.isInFaction(i)&&(h.scorched||h.poisoned)&&c.push(l)}if(!c.length)return 0;o||(c=b(c)),a+=L.getEnhancement(e,t.id,a);var d=0;for(l=0,u=c.length;l<u;l++){var h,f=(h=s[c[l]]).scorched?"scorch":"";f+=h.poisoned?f?" and poison":"poison":"",h.invisible?(h.invisible--,x.enabled&&(echo+=T.name(e)+" intensifies "+f+" on "+T.name(h)+" but it is invisible!<br>")):(d++,h.scorched&&(h.scorched.amount+=a),h.poisoned&&(h.poisoned+=a),x.enabled&&(echo+=T.name(e)+" intensifies "+f+" on "+T.name(h)+" by "+a+"<br>"),h.backlash&&w(e,h))}return d},ignite:function(e,t,n){for(var r=k(e),a=t.x,i=t.y,o=t.all,s=Z[r].assaults,c=[],l=0,u=s.length;l<u;l++){(h=s[l]).isAlive()&&h.isInFaction(i)&&c.push(l)}if(!c.length)return 0;o||(c=b(c)),a+=L.getEnhancement(e,t.id,a);var d=0;for(l=0,u=c.length;l<u;l++){var h;(h=s[c[l]]).invisible?(h.invisible--,x.enabled&&(echo+=T.name(e)+" ignites "+T.name(h)+" but it is invisible!<br>")):(d++,h.scorch(a),x.enabled&&(echo+=T.name(e)+" ignites("+a+") "+T.name(h)+"<br>"),h.backlash&&w(e,h))}return d},jamself:function(e,t){return e.jammed=!0,e.jammedSelf=!0,x.enabled&&(echo+=T.name(e)+" freezes itself<br>"),1},jam:function(e,t){_(e);for(var n=k(e),r=t.all,a=Z[n].assaults,i=[],o=0,s=a.length;o<s;o++){(l=a[o]).isAlive()&&(r||l.isActiveNextTurn()&&l.isUnjammed())&&i.push(o)}if(!i.length)return 0;r||(i=b(i));var c=0;for(o=0,s=i.length;o<s;o++){var l;(l=a[i[o]]).invisible?(l.invisible--,t.countdown=0,x.enabled&&(echo+=T.name(e)+" freezes "+T.name(l)+" but it is invisible!<br>")):(c++,l.jammed=!0,x.enabled&&(echo+=T.name(e)+" freezes "+T.name(l)+"<br>"),l.backlash&&w(e,l))}return c},frost:function(e,r){_(e);var t=k(e),n=r.x,a=L.getEnhancement(e,r.id,n);n+=a;r.all;for(var i=Z[t].assaults,o=[],s=e.key-1,c=s+2;s<=c;s++){(h=i[s])&&h.isAlive()&&o.push(s)}if(!o.length)return 0;for(var l=0,u=0,d=o.length;u<d;u++){var h;if((h=i[o[u]]).invisible)h.invisible--,x.enabled&&(echo+=T.name(e)+" breathes frost at "+T.name(h)+" but it is invisible!<br>");else{l++;var f=n,p=z(h,f);E(e,h,f=p.damage,p.shatter,function(e,t,n){echo+="<u>(Frostbreath: +"+r.x,a&&(echo+=" Enhance: +"+a),echo+=p.echo,echo+=") = "+n+" damage</u><br>",echo+=T.name(e)+" breathes frost at "+T.name(t)+" for "+n+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"}),h.backlash&&w(e,h)}}return l},heartseeker:function(e,t){t.y;var n=k(e),r=t.x,a=Z[n].assaults[e.key];return a?(r+=L.getEnhancement(e,t.id,r),a.heartseeker+=r,a.enfeebled+=r,x.enabled&&(echo+=T.name(e)+" inflicts heartseeker "+r+" on "+T.name(a)+"<br>"),1):0},enfeeble:function(e,t){for(var n=t.y,r=(_(e),k(e)),a=t.x,i=t.all,o=Z[r].assaults,s=[],c=0,l=o.length;c<l;c++){(d=o[c]).isAlive()&&d.isInFaction(n)&&s.push(c)}if(!s.length)return 0;i||(s=b(s)),a+=L.getEnhancement(e,t.id,a);var u=0;for(c=0,l=s.length;c<l;c++){var d;(d=o[s[c]]).invisible?(d.invisible--,x.enabled&&(echo+=T.name(e)+" hexes "+T.name(d)+" but it is invisible!<br>")):(u++,d.enfeebled+=a,x.enabled&&(echo+=T.name(e)+" hexes "+T.name(d)+" by "+a+"<br>"),d.backlash&&w(e,d))}return u},weakenself:function(e,t){return s.weaken(e,t)},weaken:function(e,t){var n,a=t.y;switch(t.id){case"weakenself":n=_(e);break;default:n=k(e)}var r=t.x,i=t.all,o=Z[n].assaults,s=[],c=function(e){for(var t=0,n=o.length;t<n;t++){var r=o[t];r.isAlive()&&r.isInFaction(a)&&(i||r.isActiveNextTurn()&&r.isUnjammed()&&(e||r.hasAttack()))&&s.push(t)}};if(c(!1),s.length||c(!0),!s.length)return 0;i||(s=b(s));var l=L.getEnhancement(e,t.id,r);r+=l;for(var u=0,d=0,h=s.length;d<h;d++){var f=o[s[d]];f.invisible?(f.invisible--,x.enabled&&(echo+=T.name(e)+" weakens "+T.name(f)+" but it is invisible!<br>")):(u++,f.attack_weaken+=r,x.enabled&&(l&&(echo+="<u>(Enhance: +"+l+")</u><br>"),echo+=T.name(e)+" weakens "+T.name(f)+" by "+r+"<br>"),f.backlash&&w(e,f))}return u}},h={enlarge:function(e,t){var n=t.y,r=_(e),a=t.x,i=L.getEnhancement(e,t.id,a);a+=i;for(var o=t.all,s=Z[r].assaults,c=[],l=0,u=s.length;l<u;l++){(h=s[l]).isAlive()&&h.isInFaction(n)&&(o||h.isUnjammed()&&h.isActive())&&c.push(l)}if(!c.length)return 0;o||(c=b(c));var d=0;for(l=0,u=c.length;l<u;l++){var h=s[c[l]],f=a;if(!f){var p=t.mult;f=Math.ceil(h.attack*p)}h.attack_rally+=f,x.enabled&&(i&&(echo+="<u>(Enhance: +"+i+")</u><br>"),echo+=T.name(e)+" enlarges "+T.name(h)+" by "+f+"<br>"),d++}return d},rally:function(e,t){for(var n=t.y,r=_(e),a=t.x,i=t.all,o=Z[r].assaults,s=[],c=0,l=o.length;c<l;c++){(h=o[c]).isAlive()&&h.isInFaction(n)&&(i||h.isActive()&&h.isUnjammed())&&s.push(c)}if(!s.length)return 0;i||(s=b(s));var u=L.getEnhancement(e,t.id,a);a+=u;var d=0;for(c=0,l=s.length;c<l;c++){var h;if((h=o[s[c]]).nullified)h.nullified--,x.enabled&&(echo+=T.name(e)+" empowers "+T.name(h)+" but it is nullified!<br>");else{d++;var f=a;if(!f){var p=t.mult;f=Math.ceil(h.attack*p)}h.attack_rally+=f,x.enabled&&(u&&(echo+="<u>(Enhance: +"+u+")</u><br>"),echo+=T.name(e)+" empowers "+T.name(h)+" by "+f+"<br>")}}return d},legion:function(e,t){var n=_(e),r=Z[n].assaults,a=t.x,i=L.getEnhancement(e,t.id,a);a+=i;var o=t.y,s=e.key-1,c=s+2;s<0&&(s+=2);for(var l=0;s<=c;){var u=r[s];u&&u.isActive()&&u.isInFaction(o)&&(u.nullified?(u.nullified--,x.enabled&&(echo+=T.name(e)+" activates legion and empowers "+T.name(u)+" but it is nullified!<br>")):(l++,u.attack_rally+=a,x.enabled&&(i&&(echo+="<u>(Enhance: +"+i+")</u><br>"),echo+=T.name(e)+" activates legion and empowers "+T.name(u)+" by "+a+"<br>"))),s+=2}return l},fervor:function(e,t){var n=_(e),r=Z[n].assaults,a=t.x,i=L.getEnhancement(e,t.id,a);a+=i;var o=t.y,s=0,c=e.key-1,l=c+2;for(c<0&&(c+=2);c<=l;){var u=r[c];u&&u.isInFaction(o)&&(s+=a),c+=2}return s?(e.attack_rally+=s,x.enabled&&(i&&(echo+="<u>(Enhance: +"+i+")</u><br>"),echo+=T.name(e)+" activates fervor for "+s+"<br>"),1):0},barrage:function(e,t){var n=k(e),r=t.x,a=t.y,i=t.all,o=Z[n].assaults;r+=L.getEnhancement(e,t.id,r);for(var s=0;s<r;s++){for(var c=[],l=0,u=o.length;l<u;l++){(h=o[l]).isAlive()&&h.isInFaction(a)&&c.push(l)}if(!c.length)return 0;i||(c=b(c));var d=0;for(l=0,u=c.length;l<u;l++){var h;if((h=o[c[l]]).invisible)h.invisible--,x.enabled&&(echo+=T.name(e)+" throws a bomb at "+T.name(h)+" but it is invisible!<br>");else{d++;var f=1,p=z(h,f,{enfeeble:!0});E(e,h,f=p.damage,p.shatter,function(e,t,n){echo+="<u>(Barrage: +1",echo+=p.echo,echo+=") = "+n+" damage</u><br>",echo+=T.name(e)+" throws a bomb at "+T.name(t)+" for "+n+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}}}return d},enhance:function(e,t){for(var n=t.y,r=_(e),a=(k(e),t.x),i=(n=t.y,t.s),o=t.mult,s=t.all,c=Z[r].assaults,l=y(i),u=[],d=0,h=c.length;d<h;d++){(p=c[d]).isAlive()&&p.isInFaction(n)&&(s||!l||p.isActive()&&p.isUnjammed())&&p.hasSkill(i)&&u.push(d)}if(!u.length)return 0;s||(u=b(u));var f=0;for(d=0,h=u.length;d<h;d++){var p;if((p=c[u[d]]).nullified)p.nullified--,x.enabled&&(echo+=T.name(e)+" enhances "+T.name(p)+" but it is nullified!<br>");else{f++;var m=p.enhanced;0<a?(m[i]=(m[i]||0)+a,x.enabled&&(echo+=T.name(e)+" enhances "+i+" of "+T.name(p,!1)+" by "+a+"<br>")):0<o&&(m[i]=-o,x.enabled&&(echo+=T.name(e)+" enhances "+i+" of "+T.name(p,!1)+" by "+100*o+"%<br>"))}}return f},enrage:function(e,t){for(var n=_(e),r=t.y,a=t.x,i=t.all,o=Z[n].assaults,s=[],c=0,l=o.length;c<l;c++){(h=o[c]).isAlive()&&h.isInFaction(r)&&s.push(c)}if(!s.length)return 0;i||(s=b(s));var u=L.getEnhancement(e,t.id,a);a+=u;var d=0;for(c=0,l=s.length;c<l;c++){var h,f=a;(h=o[s[c]]).nullified?(h.nullified--,x.enabled&&(echo+=T.name(e)+" enrages "+T.name(h)+" but it is nullified!<br>")):(d++,t.mult&&(f=Math.ceil(t.mult*h.health)),h.enraged+=f,x.enabled&&(u&&(echo+="<u>(Enhance: +"+u+")</u><br>"),echo+=T.name(e)+" enrages "+T.name(h)+" by "+f+"<br>"))}return d},imbue:function(e,t){for(var n=t.y,r=_(e),a=(k(e),t.x),i=(t.c,t.s),o=t.all,s=Z[r].assaults,c=y(i),l=[],u=0,d=s.length;u<d;u++){(f=s[u]).isAlive()&&f.isInFaction(n)&&(o||!c||f.isActive()&&f.isUnjammed())&&l.push(u)}if(!l.length)return 0;t={id:i,x:a};o||(l=b(l));var h=0;for(u=0,d=l.length;u<d;u++){var f;if((f=s[l[u]]).nullified)f.nullified--,x.enabled&&(echo+=T.name(e)+" enhances "+T.name(f)+" but it is nullified!<br>");else if(h++,f.hasSkill(i)){var p=f.enhanced;p[i]=(p[i]||0)+a,x.enabled&&(echo+=T.name(e)+" imbues "+T.name(f,!1)+" existing "+T.skill(t)+" by "+a+"<br>")}else f.imbue(t),x.enabled&&(echo+=T.name(e)+" imbues "+T.name(f,!1)+" with "+T.skill(t)+"<br>")}return h},mark:function(e,t){for(var n=t.y,r=(_(e),k(e)),a=t.x,i=t.all,o=Z[r].assaults,s=e.mark_target,c=[],l=0,u=o.length;l<u;l++){if((h=o[l]).isAlive()&&h.isInFaction(n)){if(h.uid===s){c=[l];break}c.push(l)}}if(!c.length)return 0;i||(c=b(c)),a+=L.getEnhancement(e,t.id,a);var d=0;for(l=0,u=c.length;l<u;l++){var h;d++,(h=o[c[l]]).enfeebled+=a,e.mark_target=h.uid,x.enabled&&(echo+=T.name(e)+" marks "+T.name(h)+" by "+a+"<br>"),t.countdown=1}return d},snaretongue:function(e,t){for(var n=t.y,r=(_(e),k(e)),a=Z[r].assaults,i=(e.mark_target,[]),o=0,s=a.length;o<s;o++){(c=a[o]).isAlive()&&c.isInFaction(n)&&i.push(o)}if(!i.length)return 0;var c=a[i.reduce(function(e,t){return a[t].health_left<a[e].health_left?t:e},i[0])],l=e.key,u=c.key;if(l==l)return x.enabled&&(echo+=T.name(e)+" activates snaretongue and keeps "+T.name(c)+" in front of it<br>"),!1;if(a.splice(c.key,1),a.length<l){CARDS[0]=CARDS[0]||{id:"0",name:"Filler",picture:"",rarity:"0",set:"9999",card_type:"0",type:"0",sub_type:[],health:1,attack:0,cost:0,maxLevel:1,skill:[]};var d=p.byId({id:0,level:1});d.name="filler",d.health_left=0;for(var h=a.length;h<l;h++)a.push(d)}a.splice(l,0,c);h=Math.min(l,u);for(var f=Math.max(l,u);h<=f;h++)a[h].key=h;return x.enabled&&(echo+=T.name(e)+" activates snaretongue and pulls "+T.name(c)+" in front of it<br>"),t.countdown=1}},o={ambush:function(e,t,n){var r=n.x,a=n.base,i=n.mult,o=r;if(!o){i=n.mult;o=Math.ceil(t[a]*i)}return E(e,t,o,null,function(e,t,n){echo+=T.name(e)+" ambushes "+T.name(t)+" for "+n+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"}),1},slow:function(e,t,n){var r=n.x,a=n.base,i=n.mult,o=r;if(!o){i=n.mult;o=Math.ceil(t[a]*i)}return t.timer+=o,x.enabled&&(echo+=T.name(e)+" slows "+T.name(t)+" by "+o+"<br>"),1}},c={unearth:function(e,t,n){if(!e.isToken){var r=makeUnitInfo(n.card||e.id,n.level||n.x),a=p.byIdWithBgeApplied(r,null,!0);a.isToken=!0;var i=n.mult;return i&&(a.attack=Math.floor(e.attack*i),a.health=Math.floor(e.health*i)),l(a,e.owner,!0),x.enabled&&(echo+=T.name(a)+" is unearthed</br>"),1}},reanimate:function(e,t,n){return e.reanimated?0:(e.health_left=n.x,e.reanimated=!0,x.enabled&&(echo+=" and is reanimated</br>"),1)}};function S(e){if(e.silenced)x.enabled&&(echo+=T.name(e)+" is silenced and cannot use skills</br>");else for(var t=e.skill,n=d(e),r=0,a=t.length;r<a&&n();r++){var i=t[r];if(!i.countdown){var o=u(s,i.id)(e,i);i.c&&0<o&&(i.countdown=i.c),showAnimations&&R.drawField(Z,null,null,re,e)}}}function f(){cache_player_deck=getdeck?e.decodeHash(getdeck):n.defaultDeck(),cache_player_deck_cards=n.getDeckCards(cache_player_deck,"player"),pvpAI=!0,getdeck2?(cache_cpu_deck=e.decodeHash(getdeck2),getmission&&(pvpAI=!1)):getmission?(cache_cpu_deck=n.mission(getmission,missionlevel),pvpAI=!1):getraid?(cache_cpu_deck=n.raid(getraid,raidlevel),pvpAI=!1):cache_cpu_deck=n.defaultDeck(),cache_cpu_deck_cards=n.getDeckCards(cache_cpu_deck,"cpu")}function m(c){var l=c.uids={};["player","cpu"].forEach(function(e){for(var t=X[e],n=t.deck,r="player"===e?1:101,a=0;a<n.length;a++){var i=r+a,o=n[a];o.owner=e,o.played=!1,o.uid=i,l[i]=o}var s=t.commander;s.owner=e,s.health_left=s.health,s.reusableSkills||s.resetTimers();i="player"===e?-1:-2;s.uid=i,l[i]=s,c[e].commander=s})}function A(e,t){R.clearFrames(),I(e,t)}function I(e,t){if(SIMULATOR.pause)return SIMULATOR.pause=!1;var n=function(e,t){var n,r;r=surge?(n="cpu","player"):(n="player","cpu");if(0<e){if(ne&&(!Z.player.commander.isAlive()||!Z.cpu.commander.isAlive()))return!(ee=!1);if(!C(e,Z,n,r,t))return!1;if(!Z.player.commander.isAlive()||!Z.cpu.commander.isAlive())return!(ee=!1)}else!surge&&SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(e);for(e++;e<=max_turns+1;e++){if(e==max_turns+1)return!(ee=!1);$(e,n,r,Z);if(!C(e,Z,n,r,!0))return!1;if(!Z.player.commander.isAlive()||!Z.cpu.commander.isAlive())return ee=!1,x.enabled&&(echo+="<u>Turn "+e+" ends</u><br><br></div>"),!0}return!(ee=!1)}(e,t);return n&&te&&SIM_CONTROLLER.debug_end(),n}function C(e,t,n,r,a){if(e%2)var i=n,o=r;else i=r,o=n;return closeDiv=!1,!!function(e,t,n){var r=X[e],a=r.deck,i=r.ordered;{if(ne&&"cpu"===e&&n)return P(e,a,i,t,n),!1;if(a[0]){SIMULATOR.waiting=!1;var o=0;if(1==a.length)o=0;else{for(var s=0;s<a.length;s++){var c=a[s];if(c.trap&&(l(c.trap,e,t),c.trap=!1),2===s)break}o=r.chooseCard(e,a,i,t,n)}if(o<0)return!1;l(a[o],e,t),function(e,t){var n=t,r=e.length-1;for(;n<r;)e[n]=e[++n];e.length=n}(a,o)}}return!0}(i,e,a)&&(function(e,t,n,r){for(var a=n[e],i=a.commander,o=a.assaults,s=n[t],c=s.commander,l=s.assaults,u=0;u<Y.onTurn.length;u++){var d=Y.onTurn[u];d.enemy_only&&"cpu"!==e||(d.ally_only&&"player"!==e||(d.owner=e,g(d),S(d)))}g(a.commander);for(var h=0,f=o.length;h<f;h++){var p=o[h];q(p,"evade","invisible"),q(p,"absorb","warded")}(function(e){for(var t=e.assaults,n=0,r=t.length;n<r;n++){var a=t[n];if(a.isAlive()&&a.isActive()&&a.isUnjammed()){var i=a.flurry;i&&0===i.countdown&&a.hasAttack()&&(i.countdown=i.c,a.dualstrike_triggered=!0),g(a)}}})(a),S(i);for(var h=0,f=o.length;h<f;h++){var p=o[h];if(p.isAlive()&&p.isActive())if(p.jammed)x.enabled&&(echo+=T.name(p)+" is frozen and cannot attack<br>");else{var m=1;for(p.dualstrike_triggered&&(m++,x.enabled&&(echo+=T.name(p)+" activates dualstrike<br>"));0<m;m--)if(S(p),p.isAlive())if(p.hasAttack()){if(K(p,l,c),!c.isAlive()||!i.isAlive())return;if(!p.isAlive())break}else x.enabled&&0<p.permanentAttack()&&(echo+=T.name(p)+" is weakened and cannot attack<br>")}}(function(e){for(var t=0,n=e.length;t<n;t++){var r=e[t];if(r.jammedSelf?r.jammedSelf=!1:r.jammed=!1,r.attack_rally=0,r.attack_weaken=0,r.nullified=0,r.dualstrike_triggered=!1,r.silenced=!1,r.regenerate&&r.isDamaged()){var a=r.regenerate,i=L.getEnhancement(r,"regenerate",a);a+=i;var o=r.health-r.health_left;o<=a&&(a=o),r.health_left+=a,x.enabled&&(echo+=T.name(r)+" regenerates "+a+" health<br>")}var s=r.poisoned;if(s){var c=r.warded;c&&(s-=G(r,"warded",s)),E(null,r,s,null,function(e,t,n){echo+=T.name(t)+" takes "+n,c&&(echo+=" (Poison: +"+r.poisoned+" Ward: -"+c+")"),echo+=" poison damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}var s=r.envenomed;if(s){var c=r.warded;c&&(s-=G(r,"warded",s)),E(null,r,s,null,function(e,t,n){echo+=T.name(t)+" takes "+n,c&&(echo+=" (Venom: +"+r.envenomed+" Ward: -"+c+")"),echo+=" venom damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}var l=r.scorched;if(l){s=l.amount;var c=r.warded;c&&(s-=G(r,"warded",s)),E(null,r,s,null,function(e,t,n){echo+=T.name(t)+" takes "+n,c&&(echo+=" (Scorch: +"+l.amount+" Ward: -"+c+")"),echo+=" scorch damage",t.isAlive()?t.scorched||(echo+=" and scorch wears off"):echo+=" and it dies",echo+="<br>"}),1<l.timer?l.timer--:r.scorched=0}var u=r.corroded;if(u)if(u.timer--,u.timer<0)r.corroded=!1,r.attack_corroded=0,x.enabled&&(echo+=T.name(r)+" recovers from corrosion<br>");else{var d=u.amount;r.attack_corroded=d,x.enabled&&(echo+=T.name(r)+" loses "+d+" attack to corrosion<br>")}r.isAlive()||M(r,null)}})(o),v("player"),v("cpu"),x.enabled&&(echo+="<u>Turn "+r+" ends</u><br><br></div>")}(i,o,t,e),!0)}function D(e,t,n){var r=t[n];return r?e+" draws "+T.name(r,!0)+"<br/>":""}function $(e,t,n,r){if(choice=void 0,(Q=e)%2)var a=t,i=n;else a=n,i=t;if(x.enabled){var o=T.name(r[a].commander),s=X[a].deck;echo+='<div id="turn_"'+e+' class="turn-info"><hr/><br/><u>Turn '+e+" begins for "+o+"</u><br>",e<=2&&(echo+=D(o,s,0),echo+=D(o,s,1)),echo+=D(o,s,2)}var c=r[a],l=r[i],u=c.assaults,d=l.assaults;V(c.commander);for(var h=0,f=u.length;h<f;h++){var p=u[h];if(0<p.timer&&(3===e&&tournament||(p.timer--,x.enabled&&(echo+=T.name(p)+" reduces its timer<br>"))),p.valor){var m=d[h];m&&p.adjustedAttack()<m.adjustedAttack()?(p.attack_valor+=p.valor,x.enabled&&(echo+=T.name(p)+" activates valor, boosting its attack by "+p.valor+"<br/>")):x.enabled&&(echo+=T.name(p)+" activates valor but ",echo+=m?"enemy is not strong enough.<br/>":"there is no opposing enemy.<br/>")}p.enfeebled=p.envenomed+p.heartseeker,p.enraged=0,p.invisible=0,p.protected=0,p.barrier_ice=0,p.warded=0,p.enhanced={},p.removeImbue(),V(p)}}function P(e,t,n,r,a){return SIMULATOR.waiting=!0,closeDiv=!0,a&&(hideTable(),outputTurns(echo),R.drawField(Z,null,I,r),SIMULATOR.sendBattleUpdate(r)),-1}function U(e,t,n,r,a){var i=t.slice(0,3);closeDiv=!0;for(var o=[],s=[],c=0,l=i.length;c<l;c++){var u=i[c],d=c+": "+u.name;1<u.maxLevel&&(d+="{"+u.level+"/"+u.maxLevel+"}"),o.push(d),s.push(u)}if(a&&(hideTable(),outputTurns(echo),R.drawField(Z,s,A,r)),void 0===choice)return-1;var h=choice;return h||(h=0),h}function N(e,t,n,r,a){if(void 0===n)return 0;for(var i=t.slice(0,3),o=!1,s=0,c=n.length;s<c;s++){for(var l,u=n[s],d=u.priority,h=-1,f=0,p=i.length;f<p;f++){var m=(l=i[f]).priority;if(L.areEqual(u,l)){o=!0;break}0<d&&d==m&&(h=f)}if(!o&&0<=h&&(o=!0,l=i[f=h]),o){for(var v=n.length-1;s<v;s++)n[s]=n[s+1];return n.length=s,f}}return-1}function F(e,t,n,r,a){var i=t.slice(0,3);return~~(Math.random()*i.length)}function H(e,t,n,r,a){for(var i,o,s,c,l,u=t.slice(0,3),d=-1,h=-1,f=0;f<u.length;f++){var p=u[f],m=(void 0,o=(i=p).id.toString(),s=6*parseInt(i.rarity),c=3*(4<o.length?parseInt(o[0]):0),l=parseInt(i.level)-parseInt(i.maxLevel),s+c+l);h<m&&(h=m,d=f)}return d}function j(e,t,n,r,a){return 0}function q(e,t,n){var r=0;e[t]&&(r=e[t],r+=L.getEnhancement(e,t,r));e[n]=r}function z(e,t,n){var r=(n=n||{}).enfeeble?0:e.enfeebled||0,a=n.stasis?0:O(e),i=n.protect?0:e.protected||0,o=n.ward?0:e.warded||0;t+=r-a;var s=!1;o&&(t-=G(e,"warded",t)),i&&(t-=G(e,"protected",t),0==e.protected&&(s=e.barrier_ice)),a&&(t-=a);var c="";return x.enabled&&(r&&(c+=" Enfeeble: +"+r),a&&(c+=" Stasis: -"+a),i&&(c+=" Barrier: -"+i),o&&(c+=" Ward: -"+o)),t<0&&(t=0),{damage:t,shatter:s,echo:c}}function G(e,t,n){var r=e[t];return r<=n?(e[t]=0,r):(e[t]-=n,n)}function V(e){W(e,e.skill),W(e,e.earlyActivationSkills);var t=e.flurry;t&&t.countdown&&(t.countdown--,x.enabled&&(t.countdown?echo+=T.name(e)+" charges  dualstrike (ready in "+t.countdown+" turns)<br/>":echo+=T.name(e)+" readies dualstrike<br/>"))}function W(e,t){for(var n=0,r=t.length;n<r;n++){var a=t[n];a.countdown&&(a.countdown--,x.enabled&&(a.countdown?echo+=T.name(e)+" charges "+i.nameFromId(a.id)+" (ready in "+a.countdown+" turns)<br/>":echo+=T.name(e)+" readies "+i.nameFromId(a.id)+"<br/>"))}}function K(e,t,n){var r=t[e.key];if(r&&r.isAlive()){var a,i=!1;if(!r.taunt)if((a=t[e.key-1])&&a.taunt)r=a,i=!0;else(a=t[e.key+1])&&a.taunt&&(r=a,i=!0);i&&x.enabled&&(echo+=T.name(r)+" taunts "+T.name(e))}else r=n;var o=e.adjustedAttack(),s=r.enfeebled;o+=s,x.enabled&&(echo+="<u>(Attack: +"+e.attack,e.attack_berserk&&(echo+=" Berserk: +"+e.attack_berserk),e.attack_valor&&(echo+=" Valor: +"+e.attack_valor),e.attack_rally&&(echo+=" Rally: +"+e.attack_rally),e.attack_weaken&&(echo+=" Weaken: -"+e.attack_weaken),e.attack_corroded&&(echo+=" Corrosion: -"+e.attack_corroded),s&&(echo+=" Enfeeble: +"+s));var c=e.pierce;c?c+=L.getEnhancement(e,"pierce",c):c=0;var l=r.protected,u=!1,d=r.armored,h=O(r);if(l&&(x.enabled&&(echo+=" Barrier: -"+l),c&&(l<=c?(x.enabled&&(echo+=" Pierce: +"+l),c-=l,l=0,r.protected=0):(x.enabled&&(echo+=" Pierce: +"+c),l-=c,r.protected-=c,c=0)),l&&(l<=o?(u=r.barrier_ice,o-=l,r.protected=0):(r.protected-=o,o=0))),h&&(h+=L.getEnhancement(r,"stasis",h),x.enabled&&(echo+=" Shroud: -"+h),c&&(h<c?(x.enabled&&(echo+=" Pierce: +"+h),h=0):(x.enabled&&(echo+=" Pierce: +"+c),h-=c)),o-=h),d&&(d+=L.getEnhancement(r,"armored",d),x.enabled&&(echo+=" Armor: -"+d),c&&(d<c?(x.enabled&&(echo+=" Pierce: +"+d),d=0):(x.enabled&&(echo+=" Pierce: +"+c),d-=c)),o-=d),o<0&&(o=0),x.enabled&&(echo+=") = "+o+" damage</u><br>"),E(e,r,o,null,function(e,t,n){echo+=T.name(e)+" attacks "+T.name(t)+" for "+n+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"}),showAnimations&&R.drawField(Z,null,null,re,e),n.isAlive()){if(0<o&&r.isAssault()&&r.isAlive()){if(e.poison){var f=e.poison;(f+=L.getEnhancement(e,"poison",f))>r.poisoned&&(r.poisoned=f,x.enabled&&(echo+=T.name(e)+" inflicts poison("+f+") on "+T.name(r)+"<br>"))}if(e.venom){var p=e.venom;if((p+=L.getEnhancement(e,"venom",p))>r.envenomed){var m=p-r.envenomed;r.envenomed=p,r.enfeebled+=m,x.enabled&&(echo+=T.name(e)+" inflicts venom("+p+") on "+T.name(r)+"<br>")}}if(e.nullify){var v=e.nullify;v+=L.getEnhancement(e,"nullify",v),r.nullified+=v,x.enabled&&(echo+=T.name(e)+" inflicts nullify("+v+") on "+T.name(r)+"<br>")}if(e.silence&&(r.silenced=!0,x.enabled&&(echo+=T.name(e)+" inflicts silence on "+T.name(r)+"<br>")),e.daze){var g=e.daze;g+=L.getEnhancement(e,"daze",g),r.attack_weaken+=g,x.enabled&&(echo+=T.name(e)+" dazed "+T.name(r)+" for "+g+"<br>")}}if(u&&B(r),0<o&&e.isAlive()){if(e.leech&&e.isDamaged()){var b=e.leech;b+=L.getEnhancement(e,"leech",b);var _=e.health-e.health_left;_<=b&&(b=_),e.health_left+=b,x.enabled&&(echo+=T.name(e)+" siphons "+b+" health<br>")}if(e.reinforce){var k=e.reinforce;k+=L.getEnhancement(e,"reinforce",k),e.protected+=k,x.enabled&&(echo+=T.name(e)+" reinforces itself with barrier "+k+"<br>")}if(r.counter){var y=0+r.counter;J(e,r,"Vengance",y,L.getEnhancement(r,"counter",y))}if(r.counterburn){var w=r.counterburn||0;w+=L.getEnhancement(r,"counterburn",w),e.scorched?(e.scorched.amount+=w,e.scorched.timer=2):e.scorched={amount:w,timer:2},x.enabled&&(echo+=T.name(r)+" inflicts counterburn("+w+") on "+T.name(e)+"<br>")}if(r.counterpoison){f=r.counterpoison||0;(f+=L.getEnhancement(r,"counterpoison",f))>e.poisoned&&(e.poisoned=f,x.enabled&&(echo+=T.name(r)+" inflicts counterpoison("+f+") on "+T.name(e)+"<br>"))}if(r.fury){var S=r.fury,A=L.getEnhancement(r,"counter",S);if(r.isAlive()){var I=S+A;r.attack_berserk+=I,x.enabled&&(echo+=T.name(r)+" activates fury and gains "+I+" attack<br>")}J(e,r,"Fury",S,A)}if(0<r.enraged&&(r.attack_berserk+=r.enraged,x.enabled&&(echo+=T.name(r)+" is enraged and gains "+r.enraged+" attack!</br>")),e.berserk){var C=e.berserk;C+=L.getEnhancement(e,"berserk",C),e.attack_berserk+=C,x.enabled&&(echo+=T.name(e)+" activates berserk and gains "+C+" attack<br>")}}if(r.corrosive){var D=r.corrosive||0;D+=L.getEnhancement(r,"corrosive",D),e.corroded?(e.corroded.amount+=D,e.corroded.timer=2):e.corroded={amount:D,timer:2},x.enabled&&(echo+=T.name(r)+" inflicts corrosion("+D+") on "+T.name(e)+"<br>"),e.attack_corroded=D,x.enabled&&(echo+=T.name(e)+" loses "+D+" attack to corrosion<br>")}e.isAlive()||M(e,r),showAnimations&&R.drawField(Z,null,null,re,e)}}function J(e,t,r,n,a){var i=n+a,o=z(e,i,{enfeeble:!0});i=o.damage;o.shatter;x.enabled&&(echo+="<u>("+r+": +"+n,a&&(echo+=" Enhance: +"+a),echo+=o.echo,echo+=") = "+i+" damage</u><br>"),E(t,e,i,null,function(e,t,n){echo+=T.name(t)+" takes "+n+" "+r.toLowerCase()+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}SIMULATOR.pause=!1,SIMULATOR.performTurns=I,SIMULATOR.waitForOpponent=P;var Y,X={},Z={},Q=0,ee=!1,te=!1,ne=!1,re=0,ae=0,ie=0;SIMULATOR.simulate=function(){if(ee=!0,function(){SIMULATOR.simulation_turns=0;var e={cpu:{deck:[]},player:{deck:[]}};SIMULATOR.deck=e,SIMULATOR.field={cpu:{assaults:[]},player:{assaults:[]}},cache_player_deck_cards&&(e.player=n.copyDeck(cache_player_deck_cards)),getmission&&1<missionlevel&&missionlevel<7?(cache_cpu_deck=n.mission(getmission,missionlevel),cache_cpu_deck_cards=n.getDeckCards(cache_cpu_deck,"cpu")):getraid&&(cache_cpu_deck=n.raid(getraid,raidlevel),cache_cpu_deck_cards=n.getDeckCards(cache_cpu_deck,"cpu")),cache_cpu_deck_cards&&(e.cpu=n.copyDeck(cache_cpu_deck_cards)),getordered&&!getexactorder&&(e.player.ordered=n.copyCardList(e.player.deck)),getordered2&&!getexactorder2&&(e.cpu.ordered=n.copyCardList(e.cpu.deck)),e.player.chooseCard=te?U:getordered?N:F,e.cpu.chooseCard=getordered2?N:pvpAI?H:getexactorder2?F:j}(),getexactorder?getordered||(X.player.shuffleHand=!0):shuffle(X.player.deck),getexactorder2?getordered2||(X.cpu.shuffleHand=!0):shuffle(X.cpu.deck),m(Z),getsiege){var e=BATTLEGROUNDS[tower_type].effect[tower_level];if(e){e=makeUnitInfo(e.id,e.level);var t=p.byIdWithBgeApplied(e);t.uid=150,l(Z.uids[150]=t,"cpu",-1,!0)}}return I(0)},SIMULATOR.onPlaySkills=o,SIMULATOR.calculatePoints=function(e){var t=Z.uids,n={player:{total:0,taken:0},cpu:{total:0,taken:0}};for(var r in t){var a=t[r],i=n[a.owner];i&&(i.total+=a.health,(a.played||a.isCommander())&&(i.taken+=a.health-a.health_left))}n.player.percent=i.taken/i.total,n.cpu.percent=i.taken/i.total;var o=Z.cpu.commander;if(getdeck2)if(o.isAlive()&&!e)var s=Math.floor(25*n.cpu.percent);else s=130-Math.floor(15*n.player.percent);else s=o.isAlive()&&!e?(s=Math.floor(n.cpu.percent/.02),Math.max(5,s)):200-Math.floor(n.player.percent/.02);return s},Object.defineProperties(SIMULATOR,{setupDecks:{get:function(){return f},set:function(e){f=e}},setupField:{get:function(){return m},set:function(e){m=e}},deck:{get:function(){return X},set:function(e){X=e}},field:{get:function(){return Z},set:function(e){Z=e}},battlegrounds:{get:function(){return Y},set:function(e){Y=e}},simulation_turns:{get:function(){return Q},set:function(e){Q=e}},simulating:{get:function(){return ee},set:function(e){ee=e}},totalDeckHealth:{get:function(){return ae},set:function(e){ae=e}},totalCpuDeckHealth:{get:function(){return ie},set:function(e){ie=e}},user_controlled:{get:function(){return te},set:function(e){te=e}},livePvP:{get:function(){return ne},set:function(e){ne=e}}})}(),function(e){"use strict";var t=function(e,t,n){return e.filter(function(e){return e[n]==t})},n=function(e,t,n,r,a){var i=n.filter(function(e){return e.id==t})[0];if(i){var o=i[r];return e.filter(function(e){var t=e[a];return 0<=o.indexOf(t)})}return[]};e.module("core",[]).filter("forMissions",function(){return function(e,t){if(!e||!t)return e;for(var n=[],r=0,a=e.length;r<a;r++){for(var i=e[r],o=i.missions,s=!0,c=0;c<o.length;c++){if(!t[o[c]]){s=!1;break}}s&&n.push(i)}return n}}).filter("filterByParent",function(){return t}).filter("filterChildren",function(){return n}),e.module("simulatorApp",["core"]).controller("SimulatorCtrl",["$scope","$window",function(a,e){function t(e){var t=Object.keys(e);t.sort(function(e,t){return Number(e)-Number(t)});for(var n=[],r=0;r<t.length;r++){var a=t[r],i=e[a];n.push(i)}return n}function n(e){var t=[];for(var n in e)t.push(e[n]);return t}a.locations=[],a.campaigns=[],a.missions=e.TITANS,a.raids=e.RAIDS,a.battlegrounds=e.BATTLEGROUNDS,a.mapBattlegrounds=n(e.MAP_BATTLEGROUNDS),a.campaignBGEs=[],a.tower=!1,a.auto=!1,a.debugMode=!1,a.selections={location:"",campaign:"",mission:"",raid:""},a.titans=function(){a.campaigns=n(e.CAMPAIGNS),a.missions=e.TITANS},a.campaignSections=function(){a.locations=t(e.LOCATIONS).sort(function(e,t){return Number(e.id)-Number(t.id)}),a.missions=t(e.MISSIONS),a.campaigns=t(e.CAMPAIGNS)},a.filteredRaids=function(){var t={};return n(a.raids).sort(function(e,t){return Number(t.id)-Number(e.id)}).forEach(function(e){t[e.name]||(t[e.name]=e)}),n(t).sort(function(e,t){return Number(e.id)-Number(t.id)})},a.getLocationClass=function(e){if(!e){var t=a.selections.location;e=a.locations.filter(function(e){return e.id==t})[0]}if(e){var n=Number(e.id);return 0===n?"heroUpgrade":100<=n?"event":"black"}return"grey"},a.getCampaignClass=function(e){if(!e){var t=a.selections.campaign;e=a.campaigns.filter(function(e){return e.id==t})[0]}return e?e.side_mission?0==e.location_id?"heroUpgrade":"mythic":e.isLocation?"location":"black":"grey"},a.$watch("selections.location",function(e,t){a.selections.campaign=""}),a.$watch("selections.campaign",function(e,t){a.selections.mission=""}),a.towerTypes=["Castle Tower","Cannon Tower","Tree of Life"],a.selectableBattlegrounds=function(){var e=[];for(var t in a.battlegrounds){var n=a.battlegrounds[t];n.hidden||n.isTower||e.push(n)}return e.sort(function(e,t){return e.id-t.id}),e},a.personalBattlegrounds=function(){var e=[];for(var t in a.battlegrounds){var n=a.battlegrounds[t],r=Number(n.id);1e3<r&&r<2e3&&e.push(n)}return e.sort(function(e,t){return e.id-t.id}),e},a.towerTypes=function(){var e=[];for(var t in a.battlegrounds){var n=a.battlegrounds[t];n.isTower&&e.push(n)}return e.sort(function(e,t){return e.id-t.id}),e},a.$watch("debugMode",function(e,t){})}])}(angular);var loadDeckDialog,mapBGEDialog,storageAPI={};function doneLoading(){$("body").removeClass("loading"),checkTutorial()}function updateGameData(e){var t=doneLoading;e&&(t=function(){doneLoading(),e()}),DATA_UPDATER.updateData(t,!0)}function setDeckSortable(e,c){$(e).sortable({items:".card:not(.commander):not(.blank)",tolerance:"intersect",helper:function(e,t){return t.clone()},start:function(e,t){var n=t.placeholder.index()-1;t.item.data("origPos",n),$(t.item).hide()},stop:function(e,t){var n=t.item.data("origPos")-1,r=t.item.index()-1,a=$(c),i=base64.decodeHash(a.val()),o=i.deck;o.splice(r,0,o.splice(n,1)[0]);var s=base64.encodeHash(i);a.val(s)}})}function showMapBGEs(){mapBGEDialog.dialog("open"),mapBGEDialog.dialog("option","position",{my:"center",at:"center",of:window})}function loadDeck(e){$('label[for="loadDeckName"]').html("<strong>Deck:</strong>"),loadDeckDialog.dialog("open"),loadDeckDialog.dialog("option","position",{my:"center",at:"center",of:window}),loadDeckDialog.hashField=e}function onDeckLoaded(e,t){$(t).val(e).change()}!function(t){"use strict";var n;try{n=t.module("simulatorApp")}catch(e){n=t.module("simulatorApp",[])}n.controller("DeckStorageCtrl",["$scope","$window",function(e,t){e.getSavedDecks=t.storageAPI.getSavedDecks,e.keys=function(e){return e?Object.keys(e):[]}}])}(angular),function(e){try{var t=window.localStorage,n="__storage_test__";return t.setItem(n,n),t.removeItem(n),!0}catch(e){return!1}}()?function(){var a=require("urlHelpers"),i="SavedDecks",o="Tutorial";function s(e){var t=localStorage.getItem(e);if(t)try{t=JSON.parse(t)}catch(e){t={}}else t={};return storageAPI.data[e]=t}storageAPI.initialize=function(){var e,t=a.getCurrentPage();void 0===(e=s(i)).savedDecks&&storageAPI.setField(i,"savedDecks",e),storageAPI.getField(i,"savedDecks",{}),storageAPI.shouldShowTutorial=storageAPI.getField(o,t,!0)[t];var n=storageAPI.onUpdateDecks;storageAPI.onUpdateDecks=function(e){n(),storageAPI.setField(i,"savedDecks",e)};var r=storageAPI.setShowTutorial;storageAPI.setShowTutorial=function(e){r(e),storageAPI.setField(o,t,e)}},storageAPI.getField=function(e,t,n){var r=s(e)[t];return void 0===r&&(r=n,storageAPI.setField(e,t,r)),r},storageAPI.setField=function(e,t,n){var r=s(e);r[t]=n,localStorage.setItem(e,JSON.stringify(r))},window.addEventListener("storage",function(e){"__storage_test__"!==e.key&&(localStorage.getItem(e.key)!==e.newValue&&angular.element("#loadDeckDialog").scope().$apply(localStorage.setItem(e.key,e.newValue)))})}():function(){storageAPI.initialize=function(){storageAPI.getSavedDecks=function(){return{}},storageAPI.loadDeck=e,storageAPI.deleteDeck=e,storageAPI.clearDecks=e,storageAPI.getField=function(e,t,n){return n},storageAPI.setField=function(){},storageAPI.savedDecks={},storageAPI.shouldShowTutorial=!0};var e=function(e,t){alert("Your browser does not support this feature.")}}(),function(){var e,t="SavedDecks";storageAPI.data={},storageAPI.getSavedDecks=function(){return storageAPI.getField(t,"savedDecks",{})},storageAPI.saveDeck=function(e,t){var n=storageAPI.getSavedDecks();n[e]=t,storageAPI.onUpdateDecks(n)},storageAPI.loadDeck=function(e){return storageAPI.getSavedDecks()[e]},storageAPI.deleteDeck=function(e){var t=storageAPI.getSavedDecks();delete t[e],storageAPI.onUpdateDecks(t)},storageAPI.clearDecks=function(e){var t=storageAPI.getSavedDecks();for(var e in t)delete t[e];storageAPI.onUpdateDecks(t)},storageAPI.onUpdateDecks=function(){e||(e=angular.element("#loadDeckDialog").scope()),e.$apply()},storageAPI.setShowTutorial=function(e){shouldShowTutorial=e},storageAPI.initialize()}(),$(function(){var i=require("bgeApi"),r=require("base64"),o=require("urlHelpers"),a=require("loadDeck");$("#deck1").change(function(){this.value=this.value.trim(),c("attack_deck",r.decodeHash(this.value),"player")}),$("#deck2").change(function(){this.value=this.value.trim(),c("defend_deck",r.decodeHash(this.value),"cpu")}),$("#battleground").change(function(){$("#deck1").change(),$("#deck2").val()?$("#deck2").change():$("#mission").val()?$("#mission").change():$("#raid").val()&&$("#raid").change()});for(var e=$("label[bge-desc]"),t=0;t<e.length;t++){$(e[t]).hover(n,s)}function n(e){var t=$("#tooltip"),n=$("#tooltip-text");n.html($(e.target).attr("bge-desc")),n.width(200),t.show(),$("#tooltip .arrow").css("borderTopWidth",0).css("borderBottomWidth",0);var r=$(e.target).offset();r.left-=230,r.top-=t.outerHeight()/2-10,t.offset(r);var a=n.innerHeight()/2-4;$("#tooltip .arrow").css("borderTopWidth",a).css("borderBottomWidth",a)}function s(e){$("#tooltip").hide()}function c(e,t,n){var r=$("#"+e);if(r.children().remove(),!o.paramDefined("seedtest")){SIM_CONTROLLER.getConfiguration();var a=i.getBattlegrounds(getbattleground,selfbges,enemybges,mapbges,getcampaign,missionlevel,getraid,raidlevel);a=a.onCreate.filter(function(e){return!("player"===n&&e.enemy_only||"cpu"===n&&e.ally_only)}),r.append(CARD_GUI.makeDeckHTML(t,!1,a))}}$(".accordion").accordion({collapsible:!0,active:!1,heightStyle:"content"}).filter(".start-open").accordion("option","active",0);if($("#raid, #raid_level").change(function(){var e,t=$("#raid").val(),n=$("#raid_level");t?(e=a.raid(t,n.val()),"Dungeon"===RAIDS[t].type?n.attr("max",150):n.attr("max",40)):(e=r.decodeHash(""),n.attr("max",40)),c("defend_deck",e,"cpu")}),$("#location, #campaign").change(function(){$("#mission").change()}),$("#mission, #mission_level").change(function(){var e,t=$("#mission").val();if(t){var n=$("#mission_level").val();e=a.mission(t,n)}else e=r.decodeHash("");c("defend_deck",e,"cpu")}),loadDeckDialog=$("#loadDeckDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{Delete:function(){var e=$("#loadDeckName").val();storageAPI.deleteDeck(e)},Load:function(){var e=$("#loadDeckName").val();onDeckLoaded(storageAPI.loadDeck(e),loadDeckDialog.hashField),loadDeckDialog.dialog("close")},Cancel:function(){loadDeckDialog.dialog("close")}}}),mapBGEDialog=$("#bgeDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{OK:function(){mapBGEDialog.dialog("close")},Cancel:function(){mapBGEDialog.dialog("close")}}}),c("attack_deck",r.decodeHash("")),c("defend_deck",r.decodeHash("")),setDeckSortable("#attack_deck","#deck1"),setDeckSortable("#defend_deck","#deck2"),o.paramDefined("latestCards")){var l=null;o.paramDefined("autostart")&&(l=function(){SIM_CONTROLLER.startsim(1)}),updateGameData(l)}else loadCardCache();processQueryString()});var deckPopupDialog,dark=!1;function toggleTheme(){dark?($("#theme").attr("href","dist/light.min.css"),$("#toggleTheme").val("Dark Theme")):($("#theme").attr("href","dist/dark.min.css"),$("#toggleTheme").val("Light Theme")),dark=!dark}var style,base64=require("base64"),urlHelpers=require("urlHelpers"),loadDeck=require("loadDeck"),debugLog=require("debugLog");function processQueryString(){if($("#header").load("templates/header.html",function(){"undefined"!=typeof showTutorial&&$("#help").click(showTutorial)}),$.holdReady(!0),$("#footer").load("templates/footer.html",function(){$.holdReady(!1)}),!document.getElementById("ui"))return 0;angular.element(document.getElementById("ui")).scope();$("#generate_link").on("click",display_generated_link),$("#btn_simulate").on("click",SIM_CONTROLLER.startsim),$("#btnStop").on("click",SIM_CONTROLLER.stopsim),$("#display_history").on("click",display_history),$("#deck1").val(urlHelpers.paramValue("deck1")).change(),$("#deck2").val(urlHelpers.paramValue("deck2")).change(),$("#surge").prop("checked",urlHelpers.paramDefined("surge")),$("#siege").prop("checked",urlHelpers.paramDefined("siege"));var e=Math.min(Math.max(urlHelpers.paramValue("tower_level")||18,0),18);$("#tower_level").val(e);var t=urlHelpers.paramValue("tower_type")||501;$("#tower_type").val(t),$("#auto_mode").prop("checked",urlHelpers.paramDefined("auto_mode")),$("#tournament").prop("checked",urlHelpers.paramDefined("tournament")),$("#ordered").prop("checked",urlHelpers.paramDefined("ordered")),$("#exactorder").prop("checked",urlHelpers.paramDefined("exactorder")),$("#ordered2").prop("checked",urlHelpers.paramDefined("ordered2")),$("#exactorder2").prop("checked",urlHelpers.paramDefined("exactorder2")),urlHelpers.paramDefined("randomAI")&&(pvpAI=!1);var n=urlHelpers.paramValue("location"),r=urlHelpers.paramValue("campaign"),a=urlHelpers.paramValue("mission"),i=urlHelpers.paramValue("raid");if(n&&$("#location").val(n).change(),r&&(n||(n=CAMPAIGNS[r].location_id,$("#location").val(n).change()),$("#campaign").val(r).change()),a&&($("#mission_level").val(urlHelpers.paramValue("mission_level")||7),$("#mission").val(a).change()),i&&($("#raid_level").val(urlHelpers.paramValue("raid_level")||25),$("#raid").val(i).change()),urlHelpers.paramDefined("bges"))for(var o=urlHelpers.paramValue("bges"),s=0;s<o.length;s+=2){var c=base64.toDecimal(o.substring(s,s+2));$("#battleground_"+c).prop("checked",!0)}else for(document.getElementsByName("battleground"),s=0;s<current_bges.length;s++)$("#battleground_"+current_bges[s]).prop("checked",!0);if(o=urlHelpers.paramValue("selfbges"))for(s=0;s<o.length;s+=2){c=base64.toDecimal(o.substring(s,s+2))+1e4;$("#self-battleground_"+c).prop("checked",!0)}if(o=urlHelpers.paramValue("enemybges"))for(s=0;s<o.length;s+=2){c=base64.toDecimal(o.substring(s,s+2))+1e4;$("#enemy-battleground_"+c).prop("checked",!0)}var l=urlHelpers.paramValue("mapBges");if(l&&setSelectedMapBattlegrounds(l),$("#battleground").change(),$("#sims").val(urlHelpers.paramValue("sims")||1e4),urlHelpers.paramDefined("debug")&&$("#debug").click(),urlHelpers.paramDefined("mass_debug")&&$("#mass_debug").click(),urlHelpers.paramDefined("loss_debug")&&$("#loss_debug").click(),urlHelpers.paramDefined("win_debug")&&$("#win_debug").click(),urlHelpers.paramDefined("play_debug")&&$("#play_debug").click(),document.title="SimSpellstone "+text_version+" - The Spellstone Simulator that runs from your browser!",urlHelpers.paramDefined("autostart")&&!urlHelpers.paramDefined("latestCards"))SIM_CONTROLLER.startsim(1);else if(urlHelpers.paramDefined("unit_tests")){var u=document.getElementsByTagName("body")[0],d=document.createElement("script");d.src="scripts/unit_tests.js",u.appendChild(d),d.onload=function(){var e=document.createElement("script");e.src="scripts/unit_test_runner.js",u.appendChild(e)}}document.getElementById("missionDeckDialog")&&(deckPopupDialog=$("#missionDeckDialog").dialog({autoOpen:!1,minWidth:500,minHeight:20,modal:!0,resizable:!1,draggable:!1,buttons:{Close:function(){deckPopupDialog.dialog("close")}},open:function(e,t){$(".ui-dialog-titlebar-close",t.dialog|t).hide()}}))}window.addEventListener("error",function(e,t,n){var r="JavaScript error:\n "+e+"\n on line "+n+"\n for "+t;if(window.sa("send","exception",{exDescription:r,exFatal:!1}),0===n){var a="<br><br><i>Error Message:</i><br><br><i>It appears you're having trouble loading SimSpellstone. Thanks.</i><br><br>";return outp?outp(a):document.write(a),1}r+="\n",r+="Browser CodeName: "+navigator.appCodeName+"\n",r+="Browser Name: "+navigator.appName+"\n",r+="Browser Version: "+navigator.appVersion+"\n",r+="Cookies Enabled: "+navigator.cookieEnabled+"\n",r+="Platform: "+navigator.platform+"\n",r+="User-agent header: "+navigator.userAgent+"\n",r+="SimSpellstone version: "+text_version+"\n",getdeck&&(r+="Deck hash: "+getdeck+"\n"),getcardlist&&(r+="Card list: "+getcardlist+"\n"),getordered&&(r+="Ordered: Yes\n"),getexactorder&&(r+="Exact-order: Yes\n"),surge&&(r+="Surge: Yes\n"),getdeck2&&(r+="Enemy deck hash: "+getdeck2+"\n"),getcardlist2&&(r+="Enemy Card list: "+getcardlist2+"\n"),getordered2&&(r+="Enemy Ordered: Yes\n"),getexactorder2&&(r+="Enemy Exact-order: Yes\n"),getmission&&(r+="Mission ID: "+getmission+"\n"),getraid&&(r+="Raid ID: "+getraid+"\n"),getbattleground&&(r+="Battleground ID: "+getbattleground+"\n"),games&&(r+="Sims run so far: "+games+"\n"),outp('<br><br><i>Error Message:</i><br><textarea cols=50 rows=6 onclick="this.select()"><blockquote>'+r+"</blockquote></textarea>"+echo),current_timeout&&clearTimeout(current_timeout)});var u_black=!1;function toggle_u(){var e=!1;if(void 0===style)e=!0,style=document.createElement("style");else for(;style.hasChildNodes();)style.removeChild(style.firstChild);var t,n=document.getElementsByTagName("head")[0];t=u_black?(u_black=!1,document.createTextNode("u { text-decoration: none; font-style:normal; color: #dddddd; font-weight: normal; }")):(u_black=!0,document.createTextNode("u { text-decoration: none; font-style:normal; color: #000000; font-weight: normal; }")),style.type="text/css",style.styleSheet?style.styleSheet.cssText=t.nodeValue:style.appendChild(t),!0===e&&n.appendChild(style)}function toggleUI(e){e?$("#ui").show():$("#ui").hide()}function showUI(){toggleUI(!0),document.getElementById("stop").style.display="none"}function hideUI(){$(".accordion").accordion("option","active",null),toggleUI(!1),document.getElementById("stop").style.display="block"}function getSelectedBattlegrounds(e){e=e||"";for(var t=[],n=document.getElementsByName(e+"battleground"),r=0;r<n.length;r++){var a=n[r];a&&a.checked&&t.push(a.value)}return t=t.join()}function getSelectedMapBattlegrounds(){for(var e=[],t=$("#location").val(),n=document.getElementsByName("map-battleground"),r=0;r<n.length;r++){var a=n[r];0<a.value&&e.push(t+"-"+r+"-"+a.value)}return e=e.join()}function setSelectedMapBattlegrounds(e){for(var t=document.getElementsByName("map-battleground"),n=0;n<e.length&&n<t.length;n++)t[n].value=e[n]}function outp(e){$("#content").html(e)}function outputTurns(e){closeDiv&&(e+="</div>",closeDiv=!1),outp(e="<input id='show-turns' type='button' value='Show All' /> <div id='turn-container'>Turn: <select id='turn-picker'></select></div> <div>"+e+"</div>");for(var t=$(".turn-info").hide().length,n=[],r=0;r<t;r++){var a=r+1;n.push("<option value='"+r+"'>"+a+"</option>")}var i=r-1;i&&closeDiv&&i--,$("#turn-picker").append(n).change(function(e){var t=e.target.selectedIndex;$(".turn-info").hide().eq(t).show()}).val(i).change();var o=!0;$("#show-turns").click(function(){if(o=!o){var e=$("#turn-picker").val();$(".turn-info").hide().eq(e).show(),$("#turn-container").show(),this.value="Show All"}else $(".turn-info").show(),$("#turn-container").hide(),this.value="Show One"})}function showWinrate(){if(suppressOutput);else if(debugLog.enabled||0==sims_left){var e="";if(e+='<br><br><i>Non-autostart link</i><br><a href="'+generate_link()+'">'+generate_link()+'</a><br><br><i>Autostart link</i><br><a href="'+generate_link(1)+'">'+generate_link(1)+"</a><br><br>",debugLog.enabled)return e}var t=(100*(wins/games)).toFixed(2)+"%";$("#wins").html(wins),$("#winrate").html(t);var n=losses/games*100;n=n.toFixed(2)+"%",$("#losses").html(losses),$("#lossrate").html(n);var r=draws/games*100;r=r.toFixed(2)+"%",$("#draws").html(draws),$("#drawrate").html(r);var a=marginOfError(wins,games);$("#marginGames").html((a*games).toFixed(0)),a=a.toFixed(2)+"%",$("#marginPercent").html(a);var i=(100*games/(games+sims_left)).toFixed("2")+"%";$(".battleCount").html(games),$("#percentComplete").html(i),$("#avgLength").html((total_turns/games).toFixed(1)),$("#avgPoints").html((points/games).toFixed(2)),$("#winrateTable").show();var o="";if(0==sims_left){o+=e;var s="",c=[],l=document.getElementById("deck1").value;l&&(c.player=base64.decodeHash(l)),c.player&&(s=base64.encodeHash(c.player)),battle_history+=t+" (+/- "+a+") &nbsp; &nbsp; "+s+"<br>"}return o}function hideTable(){$("#winrateTable").hide()}function setSimStatus(e,t,n){if($("#simStatusMsg").html(e),t&&n){var r=games+sims_left,a=(100*games/r).toFixed("2")+"%",i="("+games+"/"+r+") "+a;$("#progress").html(i),$("#speed").show(),$("#elapsed").html(t),$("#simsPerSec").html(n)}else $("#progress").html(""),$("#speed").hide();$("#simulationStatus").show()}function winrateDev(e,t){if(t<=1)return 1;var n=e/t,r=t;return Math.sqrt(r*n*(1-n))}function marginOfError(e,t){if(t<=1)return 1;var n=e/t,r=t;return 100*(1.96*Math.sqrt(n*(1-n)/r)+.5/r)}function generate_link(e){var t=0,n=document.URL,r=n.indexOf("?");0<r&&(n=n.substring(0,r));var a=[];addValueParam(a,"deck1"),addValueParam(a,"deck2"),addValueParam(a,"location"),addValueParam(a,"campaign"),addValueParam(a,"mission"),addValueParam(a,"mission_level"),addValueParam(a,"raid"),addValueParam(a,"raid_level");var i=$("select[name=map-battleground]").toArray().reduce(function(e,t){return e+t.value},"");i.length&&a.push("mapBges="+i),addBoolParam(a,"surge"),addBoolParam(a,"siege")&&(addValueParam(a,"tower_level"),addValueParam(a,"tower_type")),addBoolParam(a,"auto_mode"),addBoolParam(a,"tournament"),addBoolParam(a,"ordered"),addBoolParam(a,"exactorder"),addBoolParam(a,"ordered2"),addBoolParam(a,"exactorder2");for(var o="",s=document.getElementsByName("battleground"),c=0;c<s.length;c++)(t=s[c]).checked&&(o+=base64.fromDecimal(t.value,2));a.push("bges="+o);for(o="",s=document.getElementsByName("self-battleground"),c=0;c<s.length;c++)(t=s[c]).checked&&(o+=base64.fromDecimal(t.value-1e4,2));o&&a.push("selfbges="+o);for(o="",s=document.getElementsByName("enemy-battleground"),c=0;c<s.length;c++)(t=s[c]).checked&&(o+=base64.fromDecimal(t.value-1e4,2));return o&&a.push("enemybges="+o),addValueParam(a,"sims"),addBoolParam(a,"debug"),addBoolParam(a,"mass_debug"),addBoolParam(a,"loss_debug"),addBoolParam(a,"win_debug"),addBoolParam(a,"play_debug"),e&&a.push("autostart"),0<a.length?n+"?"+a.join("&"):n}function addValueParam(e,t,n){var r=$("#"+(n||t)).val();return!!r&&(e.push(t+"="+r),!0)}function addBoolParam(e,t){return!!$("#"+t).is(":checked")&&(e.push(t),!0)}var deckBuilders={};function load_deck_builder(e){if("player"===e)var t=$("#deck1").val();else{t=$("#deck2").val();var n=$("#mission").val(),r=$("#mission_level").val(),a=$("#raid").val(),i=$("#raid_level").val()}deck=t?base64.decodeHash(t):n?loadDeck.mission(n,r):a?loadDeck.raid(a,i):loadDeck.defaultDeck();var o=base64.encodeHash(deck),s="player"==e?"Player Deck":"Enemy Deck",c=e?$("#"+("player"==e?"deck1":"deck2")):null,l=deckBuilders[e];null==l||l.closed?deckBuilders[e]=open_deck_builder(s,o,null,c):l.focus()}function open_deck_builder(e,t,n,r){var a=["nosort"];t&&a.push("hash="+t),n&&a.push("inventory="+n),e&&a.push("name="+e),urlHelpers.paramDefined("ajax")&&a.push("ajax"),a.push("fromSim");var i,o="DeckBuilder.html?"+a.join("&"),s=Math.min(screen.width,1e3),c=Math.min(screen.height,700),l=Number((screen.width-s)/2),u=Number((screen.height-c)/2),d="scrollbars,left="+l+"top="+u+",width="+s+",height="+c+",top="+u+",left="+l,h=window.open(o,"",d);return $(h).load((i=r,function(){i&&(h.updateSimulator=function(e){i.val(e).change()})})),h}function display_generated_link(){outp('<br><i>Non-autostart link</i><br><a href="'+generate_link()+'">'+generate_link()+'</a><br><br><i>Autostart link</i><br><a href="'+generate_link(1)+'">'+generate_link(1)+"</a><br><br>")}function clear_history(){battle_history="",display_history()}function display_history(){outp("<br><hr>"+(battle_history||"No history available.")+'<hr><br><br><input type="button" value="Clear History" onclick="clear_history();" style="text-align: center; font-weight: normal;"><br><br>')}var current_timeout,cache_player_deck,cache_cpu_deck,cache_player_deck_cards,cache_cpu_deck_cards,battle_history="",max_turns=100,mass_debug=!1,loss_debug=!1,win_debug=!1,found_desired=!1,play_debug=!1,showAnimations=!1,getdeck="",getdeck2="",getcardlist="",getcardlist2="",getordered=!1,getordered2=!1,getexactorder=!1,getexactorder2=!1,getcampaign=0,getmission=0,missionlevel=0,getraid=!1,raidlevel=0,getbattleground="",enemybges="",selfbges="",mapbges="",getsiege=0,tower_level=0,tower_type=0,pvpAI=!0,echo="",closeDiv=!1,wins=0,losses=0,draws=0,games=0,points=0,num_sims=0,last_games=[],sims_left=0,surge=!1,battleground=[],total_turns=0,choice=void 0,auto_mode=!1,tournament=!1,suppressOutput=!1,orders={},cardStats={},CARD_GUI={};function createImg(e,t){return $("<img>").addClass(t).attr("src",e)[0]}function createDiv(e,t){return $("<div>").addClass(e).html(t)[0]}function createSpan(e,t){return $("<span>").addClass(e).html(t)[0]}function getTutorialScript(){for(var e=[{msg:"Welcome to SIM Spellstone!  This is a brief tutorial of how to use the Simulator."},{ui:"#setup-container",msg:"Here is where you set everything up for a simulation.",actions:[i]},{ui:"#setup-container",msg:'When you are done, you can click the "Setup" bar to hide this section.',actions:[a]},{ui:"#setup-container",msg:"Clicking it again will open it back up.",actions:[i]},{ui:"#attacker-container",msg:"Use this section to set up the deck for the attacker."},{ui:"#edit-player",msg:'Click "Edit" to open the DeckBuilder and create a deck.'},{ui:"#load-player",msg:'Click "Load" to choose a deck from the ones you have saved in the DeckBuilder.'},{ui:"#attacker-hash-container",msg:"If you have a deck hash, you can simply paste it here as well."},{ui:"#attacker-advanced",msg:"This section contains some additional settings for the attacker that determine how their deck is played."},{ui:"#auto-container",msg:"Check this to have fights run on auto, rather than playing them yourself.",showFor:"battle"},{ui:"#auto-container",msg:'Setting the attacker to "auto" also enables the "Ordered" and "Do Not Shuffle" options.',showFor:"battle"},{ui:"#ordered-container",msg:"Check this to have the AI attempt to play the attacker's deck as close as possible to the order that the cards are listed."},{ui:"#exactorder-container",msg:"Check this to disable shuffling of the attacker's deck."},{ui:"#defender-container",msg:"Use this section to set up the deck for the defender."},{ui:"#defender-hash-container",msg:"You can manually create a deck for the defender here."},{ui:"#pve-container",msg:"Or you can choose a PvE deck to sim against.",actions:[u]},{ui:"#campaign-container",msg:"To choose a campaign mission, first pick a Campaign from the dropdown...",actions:[c]},{ui:"#mission-container",msg:"... then pick a Mission from the mission dropdown.",actions:[h,c,l]},{ui:"#raid-container",msg:"To fight against a raid boss, pick the desired Raid from the dropdown",actions:[u,d]},{ui:"#defender-advanced",msg:"This section contains some additional settings for the defender that determine how their deck is played.",actions:[h]},{ui:"#surge-container",msg:"Check this to have the defender go first.",showFor:"battle"},{ui:"#tower-container",msg:"Use these fields to set up a tower for the defender."},{ui:"#siege-container",msg:"Check this field to turn the tower on."},{ui:"#tower_level",msg:"This field determines the BR of the defender.  The tower's level is one less than the defender's BR."},{ui:"#tower_type",msg:"This field determines which type of tower the defender will have."},{ui:"#bge-container",msg:"Check/uncheck boxes here to set active battleground effects.",actions:[o,i]},{ui:"#view-container",msg:'Click "View" to display the currently set decks for the attacker and defender.',actions:[a,s]},{ui:"#view-container",msg:"Click it again to hide it.",actions:[o]},{ui:"#sims-container",msg:"This field determines how many fights to run.",showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Simulate" to run a batch of fights.',showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Battle" to start a fight.',showFor:"battle"},{ui:"#generate_link",msg:'Click "Generate Link" to create a link that will open this tool with all of the current settings.'},{msg:'To view this tutorial again at any time, you can click the "Help" button.  (Note: this will reset the Simulator.)'}],t=require("urlHelpers").getCurrentPage(),n=0;n<e.length;n++){var r=e[n];r.showFor&&r.showFor!==t&&e.splice(n--,1)}function a(){$("#setup-container").accordion("option","active",null)}function i(){$("#setup-container").accordion("option","active",0)}function o(){$("#view-container").accordion("option","active",null)}function s(){$("#view-container").accordion("option","active",0)}function c(){$("#campaign").val(1).change()}function l(){$("#mission").val(11).change()}function u(){$("#campaign").val("").change()}function d(){$("#raid").val(24005).change()}function h(){$("#raid").val("").change()}return e}!function(){var m=require("cardApi"),U=require("cardInfo"),N=require("runeApi"),F=require("factions"),v=require("unitInfo"),t="";function r(e,t,n){var r=[],a=m.byId(e.commander);r.push(b(a,!1,!1));for(var i=0,o=e.deck.length;i<o;i++){var s=e.deck[i];if(n)var c=m.byIdWithBgeApplied(s,n);else c=m.byId(s);r.push(b(c,!1,!1))}if(!t)for(;i<15;i++)r.push(createDiv("card blank"));return r}function c(e,t,n,r,a,i){var o,s,c;a=a||0;for(var l=0,u=[],d=0,h=e.length;d<h&&(!i||l<i);d++){var f=e[d],p=m.byId(f);v.areEqual(p,s)?c++:(a<=l&&(g(o,c),(o=b(p,t,!(c=1),n,r,null,d)).setAttribute("data-i",d),void 0!==f.index&&o.setAttribute("data-index",f.index),u.push(o)),s=p,l++)}return g(o,c),u}function i(e,t,n,r,a){t||(t=[]);var i=[];if(r){var o=document.createElement("h1");o.innerHTML="Turn: "+r+" (Currently at "+SIMULATOR.calculatePoints(!0)+" points)",i.push(o)}var s=createDiv("field"),c=null;if(a){c=a.owner;a=a.isCommander()?-1:a.key}return"player"===c?(s.appendChild(l(e.cpu)),s.appendChild(l(e.player,a))):(s.appendChild(l(e.cpu,a)),s.appendChild(l(e.player))),i.push(s),i.push(u(t,n,r)),i.push(document.createElement("br")),i.push(document.createElement("br")),i}function l(e,t){var n=createDiv("float-left"),r=b(e.commander,!1,!0);-1===t&&d(r),n.appendChild(r);var a=e.assaults;if(a)for(var i=0,o=a.length;i<o;i++){var s=a[i];r=b(s,!1,!0);s.timer&&r.classList.add("inactive"),t===i&&d(r),n.appendChild(r)}return n}function u(e,t,n){for(var r=createDiv("float-left hand"),a=0,i=e.length;a<i;a++){var o=e[a];if(o){var s=b(o,!1);0===a?s.classList.add("left"):2===a?s.classList.add("right"):2<a&&s.classList.add("inactive");t&&s.addEventListener("click",function(e){return function(){choice=e,t(n)}}(a)),r.appendChild(s)}}return r}function d(e){e.style.outline="5px solid LawnGreen"}function g(e,t){var n=parseInt(t);if(n==t&&(t=1<n?n:null),t){var r=createDiv("multiplier","x"+t);r.setAttribute("data-count",t);var a=createImg(V("cardAssets")+"multiplier.png","multiplier");e.appendChild(a),e.appendChild(r)}}function b(e,t,n,r,a,i,o){var s=createDiv("card");s.setAttribute("data-id",e.id),s.setAttribute("data-level",e.level);for(var c=e.runes,l=[],u={},d=0,h=c.length;d<h;d++){var f=c[d].id;l.push(c[d].id);var p=N.getRune(f);for(var m in p.stat_boost)"skill"==m&&(m=p.stat_boost.skill.id),u[m]=!0}var v=e.highlighted;if(v)for(d=0;d<v.length;d++){u[m=v[d]]=!0}s.setAttribute("data-runeids",l.join(","));var g=U.loadCard(e.id).picture;if(g){var b=document.createElement("i");0==g.indexOf("portrait_")?b.className="portrait portrait-"+g:b.className="sprite sprite-"+g,s.appendChild(b)}e.isCommander()&&s.classList.add("commander"),s.classList.add(F.names[e.type].toLowerCase());var _=createDiv("card-name",(void 0!==e.uid?"("+e.uid+") ":"")+e.name),k=createDiv("card-id","("+e.id+")");if(_.appendChild(k),s.appendChild(_),!e.isCommander()){if(0<=e.attack){if(n){e.isUnjammed()||s.classList.add("frozen");var y=createDiv("card-attack",e.adjustedAttack().toString());e.adjustedAttack()>e.attack?y.classList.add("increased"):e.adjustedAttack()<e.attack?y.classList.add("decreased"):u.attack&&y.classList.add("increased")}else y=createDiv("card-attack",e.attack.toString());s.appendChild(createImg(V("cardAssets")+"Attack.png","attack")),s.appendChild(y)}0<=e.cost&&(n?e.timer&&(s.appendChild(createDiv("delay",e.timer)),s.appendChild(createImg(V("cardAssets")+"Timer.png","timer"))):(s.appendChild(createDiv("delay",e.cost)),s.appendChild(createImg(V("cardAssets")+"Timer.png","timer"))))}if(0<=e.health){if(n){var w=createDiv("card-health",e.health_left.toString());e.health_left<e.health?w.classList.add("decreased"):u.health&&w.classList.add("increased")}else{w=createDiv("card-health",e.health.toString());u.health&&w.classList.add("increased")}s.appendChild(createImg(V("cardAssets")+"Health.png","health")),s.appendChild(w)}var S=createDiv("card-skills"),A=createDiv("card-skills-short");e.earlyActivationSkills&&H(e,S,A,e.earlyActivationSkills,n),H(e,S,A,e.skill,n),e.onDeathSkills&&H(e,S,A,e.onDeathSkills,n),function(t,n,r,a,i){Object.getOwnPropertyNames(SKILL_DATA).filter(function(e){return 0<=["passive","toggle"].indexOf(SKILL_DATA[e].type)}).forEach(function(e){!function(e,t,n,r,a,i){var o=r[a];if(o){var s={id:a,x:o,boosted:i[a]};e.appendChild(j(r,s,n)),e.appendChild(document.createElement("br")),t.appendChild(q(s.id))}}(t,n,a,r,e,i)});var e=r.flurry;e&&(t.appendChild(j(r,e,a)),t.appendChild(document.createElement("br")),n.appendChild(q(e.id)))}(S,A,e,n,u);var I,C,D=S.cloneNode(!0);if(D.className="card-skills-detailed",A.hasChildNodes()&&(t?(s.appendChild(A),s.appendChild(S)):s.appendChild(D)),s.appendChild(createDiv("faction")),n){var T=function(e){var t=[];if(e.enfeebled){var n=z("enfeeble",e.enfeebled);t.push(n)}if(e.marked){var n=z("enfeeble",e.marked);t.push(n)}if(e.nullified){var n=z("nullify",e.nullified);t.push(n)}if(e.poisoned){var n=z("poison",e.poisoned);t.push(n)}if(e.scorched&&e.scorched.amount){var n=z("burn",e.scorched.amount);t.push(n)}var r=[];if(e.enraged){var n=z("enrage",e.enraged);t.push(n)}if(e.protected){var n=z("protect",e.protected);r.push(n)}if(e.invisible){var n=z("evade",e.invisible);r.push(n)}var a=[];if(0<t.length){for(var i=createDiv("card-debuffs"),o=0,s=t.length;o<s;o++)i.appendChild(t[o]);a.push(i)}if(0<r.length){for(var c=createDiv("card-buffs"),o=0,s=r.length;o<s;o++)c.appendChild(r[o]);a.push(c)}return a}(e);if(0<T.length){s.appendChild(createDiv("hidden","..."));var L=createDiv("card-statuses");for(d=0;d<T.length;d++){var x=T[d];L.appendChild(x)}s.appendChild(L)}}if(e.set){var R=(I=e.set,C=W[I],createImg(V("cardAssets")+C+".png"));R.className="set",s.appendChild(R)}var E=e.sub_type;if(E.length){var B=createDiv("subfaction");for(d=0;d<E.length;d++){var M=E[d];if(M){var O=G(M);B.appendChild(O)}}s.appendChild(B)}if(0<e.rarity){if(e.maxLevel>Number(e.rarity)+2)var $=createImg(V("cardAssets")+"Level_"+e.rarity+"_"+e.maxLevel+"_"+e.level+".png");else $=createImg(V("cardAssets")+"Level_"+e.rarity+"_"+e.level+".png");if($.className="level",9999<e.id){var P="1"==e.id.toString()[0]?"Dualfuse":"Quadfuse";(P=createImg(V("cardAssets")+P+".png")).className="fusion",s.appendChild(P)}s.appendChild($)}else if(1<e.maxLevel){($=createImg(V("cardAssets")+e.maxLevel+"_"+e.level+".png")).className="level",s.appendChild($)}return r&&s.addEventListener("click",function(){return r(s,o)}),a&&(s.oncontextmenu=function(){return a(s,o)}),i&&(s.onmouseover=function(){return i(s,o)}),s}function H(e,t,n,r,a){for(var i=0;i<r.length;i++){var o=r[i];t.appendChild(j(e,o,a,i)),t.appendChild(document.createElement("br")),n.appendChild(q(o.id))}}function j(e,t,n,r){var a=document.createElement("span");a.className="skill",a.appendChild(q(t.id));var i=v.isImbued(e,t.id,r),o=v.getEnhancement(e,t.id,t.x);i?a.classList.add("imbued"):(t.boosted||o)&&a.classList.add("increased"),t.all&&(a.innerHTML+=" All "),t.y&&a.appendChild(G(t.y)),t.s&&a.appendChild(q(t.s));var s=(0|t.x)+o;return s&&(a.innerHTML+=" "+s+" "),t.c&&(a.innerHTML+=t.c,n&&(a.innerHTML+=" ("+(t.countdown?t.countdown:"0")+")")),a}function q(e){var t=V("skills"),n=SKILL_DATA[e],r=createImg(t+=(n?n.icon:e)+".png");switch(e){case"weakenself":case"enlarge":r.classList.add("affect-self")}return r.title=n?n.name:e,r}function z(e,t){var n=document.createElement("span");return n.appendChild(q(e)),t&&(n.innerHTML+=t),n}function G(e){var t=F.names[e];return createImg(V("factions")+t+".png")}function V(e){return t+"res/"+e+"/"}var W={1e3:"Basic",1100:"Legacy",7e3:"Basic",2e3:"Reward",2100:"Reward",3e3:"Premium",4e3:"BoxOnly",5e3:"Champion",5100:"Champion",9999:"StoryElements"};CARD_GUI.clearCardSpace=function(){$("#cardSpace").empty()},CARD_GUI.clearDeckSpace=function(){document.getElementById("deck").innerHTML=""},CARD_GUI.draw_deck=function(e,t){var n=$("#deck");return n.children().remove(),n.append(r(e,t)),n},CARD_GUI.create_card_html=b,CARD_GUI.makeDeckHTML=r,CARD_GUI.makeCardListHTML=function(e,t,n){for(var r=createDiv("float-left"),a=0,i=e.deck.length;a<i;a++){var o=e.deck[a],s=b(m.byId(o),!1,!1,t,n,null,a);void 0!==o.index&&s.setAttribute("data-index",o.index),r.appendChild(s)}return r},CARD_GUI.draw_card_list=function(e,t,n,r,a,i){var o=c(e,t,null,null,a,i),s=$("#cardSpace");return s.empty(),s.append(o),s},CARD_GUI.draw_cards=function(e,t,n,r){var a=i(e,t,n,r);$("#cardSpace").children().remove().end().append(a)},CARD_GUI.doDrawField=i,CARD_GUI.draw_inventory=function(e){var t=c(e.deck),n=$("#deck");return n.children().remove(),n.append(c([e.commander])),n.append(t),n},CARD_GUI.draw_hand=u,CARD_GUI.createItemHTML=function(e,t,n){var r=createDiv("card item"),a=document.createElement("i");a.className="sprite sprite-Item",r.appendChild(a),n&&((n=createImg(V("items")+n+".png")).className="item-image",r.appendChild(n));var i=createDiv("card-name",e);return r.appendChild(i),r.classList.add("factionless"),r.appendChild(createDiv("faction")),g(r,t),r},CARD_GUI.addMult=g,CARD_GUI.addWeight=function(e,t){if(0<t){var n=createDiv("weight",(100*t).toFixed(2)+"%");n.setAttribute("data-count",t);var r=createImg(V("cardAssets")+"multiplier.png","weight");e.appendChild(r),e.appendChild(n)}},Object.defineProperties(CARD_GUI,{assetsRoot:{get:function(){return t},set:function(e){t=e}}})}(),$(document).ready(function(){var o=getTutorialScript(),e=$("<div></div>");function t(){storageAPI.shouldShowTutorial?n():i()}function n(){c=0,l();$("#tutorial").show()}$(document.body).append(e),e.load("templates/tutorial-overlay.html",null,function(){e.replaceWith(function(){return $(this).contents()}),$("#tutorial-show").prop("checked",storageAPI.shouldShowTutorial).change(function(e){storageAPI.setShowTutorial(this.checked)}),$("#help").click(n),$("#tutorial-close, #tutorial-skip").click(i),$("#tutorial-next").click(r),$("#tutorial-prev").click(a),"undefined"==typeof delayTutorial&&t()});var s,c=0;function r(){c++,l()}function a(){c--,l()}function i(){$("#tutorial").hide(),$("#tutorial-permahide").is(":checked")&&storageAPI.hideTutorial()}function l(){clearTimeout(s);var e=o[c],t=e.actions;if(t)for(var n=0;n<t.length;n++)t[n]();var r=e.msg,a=e.ui;if(a){var i=$(a);e.dialog&&(i=i.parent()),u(i),t&&(s=setTimeout(u,500,i)),r.indexOf(!1)&&(r=r.replace(/\{0\}/g,i.text()))}else $(".overlay-fog").width(0).height(0);$("#tutorialMessage").text(r),c<o.length-1?($("#tutorial-next").show(),$("#tutorial-close").hide()):($("#tutorial-next").hide(),$("#tutorial-close").show()),0<c?$("#tutorial-prev").removeClass("disabled"):$("#tutorial-prev").addClass("disabled")}function u(e){var t=e.offset();$(".overlay-fog").css({top:t.top-2+"px",left:t.left-2+"px"}).width(e.outerWidth()+4+"px").height(e.outerHeight()+4+"px")}window.showTutorial=n,window.checkTutorial=t}),function(){function e(){CARD_GUI.draw_cards(SIMULATOR.field)}SIM_CONTROLLER.end_sims_callback=function(){hideUI(),e()},SIM_CONTROLLER.stop_sims_callback=e}();var battle_sim=!0;function getTutorialScript(){for(var e=[{msg:"Welcome to SIM Spellstone!  This is a brief tutorial of how to use the Live PvP functions.",actions:[o,c]},{ui:"#attacker-hash-container",msg:"First, set up your deck."},{ui:"#self-battleground",msg:"Then add any personal BGEs (totems) you want to use.",actions:[o]},{ui:"#btn_simulate",msg:'If you wish to be the defender, you\'re almost done.  Click "Ready" to start waiting for a battle request.',actions:[a,i,s]},{ui:"#myPeerID",msg:"Then copy your ID and send it to your opponent (they will need this to connect to you).",actions:[a]},{ui:"#btnStop",msg:'Click "Stop" at any time to stop waiting and edit your settings again.',actions:[a,s]},{msg:"If you want to be the attacker, you are in charge of choosing the match type(s) and battleground effects.",actions:[i,o]},{ui:"#first-player-advantage-container",msg:'This section lets you pick various options for dealing with "First-Player Advantage".'},{ui:"#surge-container",msg:"This setting makes the defender go first."},{ui:"#tournament-container",msg:"This setting causes the attacker's first card to not tick down right away."},{ui:"#tower-container",msg:"These settings will provide the defender with the specified tower."},{ui:"#battlefield-container",msg:"Configure the desired battleground effects for the match here."},{msg:"When you configured have the desired match settings, it is time to start the match.",actions:[c,o]},{ui:"#enemyPeerID",msg:"Paste your opponent's ID into the ID field.",actions:[function(){var e=$("#myPeerID").val();e=e.split("").reverse().join(""),$("#enemyPeerID").val(e).change()},s]},{ui:"#btn_simulate",msg:'Finally, click "Connect!" to start the fight.'}],t=require("urlHelpers").getCurrentPage(),n=0;n<e.length;n++){var r=e[n];r.showFor&&r.showFor!==t&&e.splice(n--,1)}function a(){$("#btn_simulate").click()}function i(){$("#btnStop").click()}function o(){$("#setup-container").accordion("option","active",0)}function s(){$("#setup-container").accordion("option","active",null)}function c(){$("#enemyPeerID").val("").change()}return e}!function i(o,s,c){function l(n,e){if(!s[n]){if(!o[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(u)return u(n,!0);var r=new Error("Cannot find module '"+n+"'");throw r.code="MODULE_NOT_FOUND",r}var a=s[n]={exports:{}};o[n][0].call(a.exports,function(e){var t=o[n][1][e];return l(t||e)},a,a.exports,i,o,s,c)}return s[n].exports}for(var u="function"==typeof require&&require,e=0;e<c.length;e++)l(c[e]);return l}({1:[function(e,t){t.exports.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,t.exports.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,t.exports.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate},{}],2:[function(e,t){function r(e,t,n){return this instanceof r?(a.call(this),this.options=s.extend({serialization:"binary",reliable:!1},n),this.open=!1,this.type="data",this.peer=e,this.provider=t,this.id=this.options.connectionId||r._idPrefix+s.randomToken(),this.label=this.options.label||this.id,this.metadata=this.options.metadata,this.serialization=this.options.serialization,this.reliable=this.options.reliable,this._buffer=[],this._buffering=!1,this.bufferSize=0,this._chunkedData={},this.options._payload&&(this._peerBrowser=this.options._payload.browser),void i.startConnection(this,this.options._payload||{originator:!0})):new r(e,t,n)}var s=e("./util"),a=e("eventemitter3"),i=e("./negotiator"),n=e("reliable");s.inherits(r,a),r._idPrefix="dc_",r.prototype.initialize=function(e){this._dc=this.dataChannel=e,this._configureDataChannel()},r.prototype._configureDataChannel=function(){var t=this;s.supports.sctp&&(this._dc.binaryType="arraybuffer"),this._dc.onopen=function(){s.log("Data channel connection success"),t.open=!0,t.emit("open")},!s.supports.sctp&&this.reliable&&(this._reliable=new n(this._dc,s.debug)),this._reliable?this._reliable.onmessage=function(e){t.emit("data",e)}:this._dc.onmessage=function(e){t._handleDataMessage(e)},this._dc.onclose=function(){s.log("DataChannel closed for:",t.peer),t.close()}},r.prototype._handleDataMessage=function(e){var t=this,n=e.data,r=n.constructor;if("binary"===this.serialization||"binary-utf8"===this.serialization){if(r===Blob)return void s.blobToArrayBuffer(n,function(e){n=s.unpack(e),t.emit("data",n)});if(r===ArrayBuffer)n=s.unpack(n);else if(r===String){var a=s.binaryStringToArrayBuffer(n);n=s.unpack(a)}}else"json"===this.serialization&&(n=JSON.parse(n));if(n.__peerData){var i=n.__peerData,o=this._chunkedData[i]||{data:[],count:0,total:n.total};return o.data[n.n]=n.data,o.count+=1,o.total===o.count&&(delete this._chunkedData[i],n=new Blob(o.data),this._handleDataMessage({data:n})),void(this._chunkedData[i]=o)}this.emit("data",n)},r.prototype.close=function(){this.open&&(this.open=!1,i.cleanup(this),this.emit("close"))},r.prototype.send=function(e,t){if(this.open)if(this._reliable)this._reliable.send(e);else{var n=this;if("json"===this.serialization)this._bufferedSend(JSON.stringify(e));else if("binary"===this.serialization||"binary-utf8"===this.serialization){var r=s.pack(e);if((s.chunkedBrowsers[this._peerBrowser]||s.chunkedBrowsers[s.browser])&&!t&&r.size>s.chunkedMTU)return void this._sendChunks(r);s.supports.sctp?s.supports.binaryBlob?this._bufferedSend(r):s.blobToArrayBuffer(r,function(e){n._bufferedSend(e)}):s.blobToBinaryString(r,function(e){n._bufferedSend(e)})}else this._bufferedSend(e)}else this.emit("error",new Error("Connection is not open. You should listen for the `open` event before sending messages."))},r.prototype._bufferedSend=function(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this.bufferSize=this._buffer.length)},r.prototype._trySend=function(e){try{this._dc.send(e)}catch(e){this._buffering=!0;var t=this;return setTimeout(function(){t._buffering=!1,t._tryBuffer()},100),!1}return!0},r.prototype._tryBuffer=function(){if(0!==this._buffer.length){var e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this.bufferSize=this._buffer.length,this._tryBuffer())}},r.prototype._sendChunks=function(e){for(var t=s.chunk(e),n=0,r=t.length;n<r;n+=1){e=t[n];this.send(e,!0)}},r.prototype.handleMessage=function(e){var t=e.payload;switch(e.type){case"ANSWER":this._peerBrowser=t.browser,i.handleSDP(e.type,this,t.sdp);break;case"CANDIDATE":i.handleCandidate(this,t.candidate);break;default:s.warn("Unrecognized message type:",e.type,"from peer:",this.peer)}},t.exports=r},{"./negotiator":5,"./util":8,eventemitter3:9,reliable:12}],3:[function(e){window.Socket=e("./socket"),window.MediaConnection=e("./mediaconnection"),window.DataConnection=e("./dataconnection"),window.Peer=e("./peer"),window.RTCPeerConnection=e("./adapter").RTCPeerConnection,window.RTCSessionDescription=e("./adapter").RTCSessionDescription,window.RTCIceCandidate=e("./adapter").RTCIceCandidate,window.Negotiator=e("./negotiator"),window.util=e("./util"),window.BinaryPack=e("js-binarypack")},{"./adapter":1,"./dataconnection":2,"./mediaconnection":4,"./negotiator":5,"./peer":6,"./socket":7,"./util":8,"js-binarypack":10}],4:[function(e,t){function r(e,t,n){return this instanceof r?(i.call(this),this.options=a.extend({},n),this.open=!1,this.type="media",this.peer=e,this.provider=t,this.metadata=this.options.metadata,this.localStream=this.options._stream,this.id=this.options.connectionId||r._idPrefix+a.randomToken(),void(this.localStream&&o.startConnection(this,{_stream:this.localStream,originator:!0}))):new r(e,t,n)}var a=e("./util"),i=e("eventemitter3"),o=e("./negotiator");a.inherits(r,i),r._idPrefix="mc_",r.prototype.addStream=function(e){a.log("Receiving stream",e),this.remoteStream=e,this.emit("stream",e)},r.prototype.handleMessage=function(e){var t=e.payload;switch(e.type){case"ANSWER":o.handleSDP(e.type,this,t.sdp),this.open=!0;break;case"CANDIDATE":o.handleCandidate(this,t.candidate);break;default:a.warn("Unrecognized message type:",e.type,"from peer:",this.peer)}},r.prototype.answer=function(e){if(this.localStream)a.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");else{this.options._payload._stream=e,this.localStream=e,o.startConnection(this,this.options._payload);for(var t=this.provider._getMessages(this.id),n=0,r=t.length;n<r;n+=1)this.handleMessage(t[n]);this.open=!0}},r.prototype.close=function(){this.open&&(this.open=!1,o.cleanup(this),this.emit("close"))},t.exports=r},{"./negotiator":5,"./util":8,eventemitter3:9}],5:[function(e,t){var o=e("./util"),a=e("./adapter").RTCPeerConnection,i=e("./adapter").RTCSessionDescription,s=e("./adapter").RTCIceCandidate,c={pcs:{data:{},media:{}},queue:[],_idPrefix:"pc_",startConnection:function(e,t){var n=c._getPeerConnection(e,t);if("media"===e.type&&t._stream&&n.addStream(t._stream),e.pc=e.peerConnection=n,t.originator){if("data"===e.type){var r={};o.supports.sctp||(r={reliable:t.reliable});var a=n.createDataChannel(e.label,r);e.initialize(a)}o.supports.onnegotiationneeded||c._makeOffer(e)}else c.handleSDP("OFFER",e,t.sdp)},_getPeerConnection:function(e,t){var n;return c.pcs[e.type]||o.error(e.type+" is not a valid connection type. Maybe you overrode the `type` property somewhere."),c.pcs[e.type][e.peer]||(c.pcs[e.type][e.peer]={}),c.pcs[e.type][e.peer],t.pc&&(n=c.pcs[e.type][e.peer][t.pc]),n&&"stable"===n.signalingState||(n=c._startPeerConnection(e)),n},_startPeerConnection:function(e){o.log("Creating RTCPeerConnection.");var t=c._idPrefix+o.randomToken(),n={};"data"!==e.type||o.supports.sctp?"media"===e.type&&(n={optional:[{DtlsSrtpKeyAgreement:!0}]}):n={optional:[{RtpDataChannels:!0}]};var r=new a(e.provider.options.config,n);return c.pcs[e.type][e.peer][t]=r,c._setupListeners(e,r,t),r},_setupListeners:function(t,e){var r=t.peer,a=t.id,i=t.provider;o.log("Listening for ICE candidates."),e.onicecandidate=function(e){e.candidate&&(o.log("Received ICE candidates for:",t.peer),i.socket.send({type:"CANDIDATE",payload:{candidate:e.candidate,type:t.type,connectionId:t.id},dst:r}))},e.oniceconnectionstatechange=function(){switch(e.iceConnectionState){case"disconnected":case"failed":o.log("iceConnectionState is disconnected, closing connections to "+r),t.close();break;case"completed":e.onicecandidate=o.noop}},e.onicechange=e.oniceconnectionstatechange,o.log("Listening for `negotiationneeded`"),e.onnegotiationneeded=function(){o.log("`negotiationneeded` triggered"),"stable"==e.signalingState?c._makeOffer(t):o.log("onnegotiationneeded triggered when not stable. Is another connection being established?")},o.log("Listening for data channel"),e.ondatachannel=function(e){o.log("Received data channel");var t=e.channel;i.getConnection(r,a).initialize(t)},o.log("Listening for remote stream"),e.onaddstream=function(e){o.log("Received remote stream");var t=e.stream,n=i.getConnection(r,a);"media"===n.type&&n.addStream(t)}},cleanup:function(e){o.log("Cleaning up PeerConnection to "+e.peer);var t=e.pc;!t||"closed"===t.readyState&&"closed"===t.signalingState||(t.close(),e.pc=null)},_makeOffer:function(t){var n=t.pc;n.createOffer(function(e){o.log("Created offer."),!o.supports.sctp&&"data"===t.type&&t.reliable&&(e.sdp=Reliable.higherBandwidthSDP(e.sdp)),n.setLocalDescription(e,function(){o.log("Set localDescription: offer","for:",t.peer),t.provider.socket.send({type:"OFFER",payload:{sdp:e,type:t.type,label:t.label,connectionId:t.id,reliable:t.reliable,serialization:t.serialization,metadata:t.metadata,browser:o.browser},dst:t.peer})},function(e){t.provider.emitError("webrtc",e),o.log("Failed to setLocalDescription, ",e)})},function(e){t.provider.emitError("webrtc",e),o.log("Failed to createOffer, ",e)},t.options.constraints)},_makeAnswer:function(t){var n=t.pc;n.createAnswer(function(e){o.log("Created answer."),!o.supports.sctp&&"data"===t.type&&t.reliable&&(e.sdp=Reliable.higherBandwidthSDP(e.sdp)),n.setLocalDescription(e,function(){o.log("Set localDescription: answer","for:",t.peer),t.provider.socket.send({type:"ANSWER",payload:{sdp:e,type:t.type,connectionId:t.id,browser:o.browser},dst:t.peer})},function(e){t.provider.emitError("webrtc",e),o.log("Failed to setLocalDescription, ",e)})},function(e){t.provider.emitError("webrtc",e),o.log("Failed to create answer, ",e)})},handleSDP:function(e,t,n){n=new i(n);var r=t.pc;o.log("Setting remote description",n),r.setRemoteDescription(n,function(){o.log("Set remoteDescription:",e,"for:",t.peer),"OFFER"===e&&c._makeAnswer(t)},function(e){t.provider.emitError("webrtc",e),o.log("Failed to setRemoteDescription, ",e)})},handleCandidate:function(e,t){var n=t.candidate,r=t.sdpMLineIndex;e.pc.addIceCandidate(new s({sdpMLineIndex:r,candidate:n})),o.log("Added ICE candidate for:",e.peer)}};t.exports=c},{"./adapter":1,"./util":8}],6:[function(e,t){function n(e,t){return this instanceof n?(r.call(this),e&&e.constructor==Object?(t=e,e=void 0):e&&(e=e.toString()),t=u.extend({debug:0,host:u.CLOUD_HOST,port:u.CLOUD_PORT,key:"peerjs",path:"/",token:u.randomToken(),config:u.defaultConfig},t),"/"===(this.options=t).host&&(t.host=window.location.hostname),"/"!==t.path[0]&&(t.path="/"+t.path),"/"!==t.path[t.path.length-1]&&(t.path+="/"),void 0===t.secure&&t.host!==u.CLOUD_HOST&&(t.secure=u.isSecure()),t.logFunction&&u.setLogFunction(t.logFunction),u.setLogLevel(t.debug),u.supports.audioVideo||u.supports.data?u.validateId(e)?u.validateKey(t.key)?t.secure&&"0.peerjs.com"===t.host?void this._delayedAbort("ssl-unavailable","The cloud server currently does not support HTTPS. Please run your own PeerServer to use HTTPS."):(this.destroyed=!1,this.disconnected=!1,this.open=!1,this.connections={},this._lostMessages={},this._initializeServerConnection(),void(e?this._initialize(e):this._retrieveId())):void this._delayedAbort("invalid-key",'API KEY "'+t.key+'" is invalid'):void this._delayedAbort("invalid-id",'ID "'+e+'" is invalid'):void this._delayedAbort("browser-incompatible","The current browser does not support WebRTC")):new n(e,t)}var u=e("./util"),r=e("eventemitter3"),a=e("./socket"),d=e("./mediaconnection"),h=e("./dataconnection");u.inherits(n,r),n.prototype._initializeServerConnection=function(){var t=this;this.socket=new a(this.options.secure,this.options.host,this.options.port,this.options.path,this.options.key),this.socket.on("message",function(e){t._handleMessage(e)}),this.socket.on("error",function(e){t._abort("socket-error",e)}),this.socket.on("disconnected",function(){t.disconnected||(t.emitError("network","Lost connection to server."),t.disconnect())}),this.socket.on("close",function(){t.disconnected||t._abort("socket-closed","Underlying socket is already closed.")})},n.prototype._retrieveId=function(){var n=this,e=new XMLHttpRequest,t=(this.options.secure?"https://":"http://")+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/id";t+="?ts="+(new Date).getTime()+Math.random(),e.open("get",t,!0),e.onerror=function(e){u.error("Error retrieving ID",e);var t="";"/"===n.options.path&&n.options.host!==u.CLOUD_HOST&&(t=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),n._abort("server-error","Could not get an ID from the server."+t)},e.onreadystatechange=function(){return 4===e.readyState?200!==e.status?void e.onerror():void n._initialize(e.responseText):void 0},e.send(null)},n.prototype._initialize=function(e){this.id=e,this.socket.start(this.id,this.options.token)},n.prototype._handleMessage=function(e){var t,n=e.type,r=e.payload,a=e.src;switch(n){case"OPEN":this.emit("open",this.id),this.open=!0;break;case"ERROR":this._abort("server-error",r.msg);break;case"ID-TAKEN":this._abort("unavailable-id","ID `"+this.id+"` is taken");break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this.options.key+'" is invalid');break;case"LEAVE":u.log("Received leave message from",a),this._cleanupPeer(a);break;case"EXPIRE":this.emitError("peer-unavailable","Could not connect to peer "+a);break;case"OFFER":var i=r.connectionId;if(t=this.getConnection(a,i))u.warn("Offer received for existing Connection ID:",i);else{if("media"===r.type)t=new d(a,this,{connectionId:i,_payload:r,metadata:r.metadata}),this._addConnection(a,t),this.emit("call",t);else{if("data"!==r.type)return void u.warn("Received malformed connection type:",r.type);t=new h(a,this,{connectionId:i,_payload:r,metadata:r.metadata,label:r.label,serialization:r.serialization,reliable:r.reliable}),this._addConnection(a,t),this.emit("connection",t)}for(var o=this._getMessages(i),s=0,c=o.length;s<c;s+=1)t.handleMessage(o[s])}break;default:if(!r)return void u.warn("You received a malformed message from "+a+" of type "+n);var l=r.connectionId;(t=this.getConnection(a,l))&&t.pc?t.handleMessage(e):l?this._storeMessage(l,e):u.warn("You received an unrecognized message:",e)}},n.prototype._storeMessage=function(e,t){this._lostMessages[e]||(this._lostMessages[e]=[]),this._lostMessages[e].push(t)},n.prototype._getMessages=function(e){var t=this._lostMessages[e];return t?(delete this._lostMessages[e],t):[]},n.prototype.connect=function(e,t){if(this.disconnected)return u.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");var n=new h(e,this,t);return this._addConnection(e,n),n},n.prototype.call=function(e,t,n){if(this.disconnected)return u.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");if(t){(n=n||{})._stream=t;var r=new d(e,this,n);return this._addConnection(e,r),r}u.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.")},n.prototype._addConnection=function(e,t){this.connections[e]||(this.connections[e]=[]),this.connections[e].push(t)},n.prototype.getConnection=function(e,t){var n=this.connections[e];if(!n)return null;for(var r=0,a=n.length;r<a;r++)if(n[r].id===t)return n[r];return null},n.prototype._delayedAbort=function(e,t){var n=this;u.setZeroTimeout(function(){n._abort(e,t)})},n.prototype._abort=function(e,t){u.error("Aborting!"),this._lastServerId?this.disconnect():this.destroy(),this.emitError(e,t)},n.prototype.emitError=function(e,t){u.error("Error:",t),"string"==typeof t&&(t=new Error(t)),t.type=e,this.emit("error",t)},n.prototype.destroy=function(){this.destroyed||(this._cleanup(),this.disconnect(),this.destroyed=!0)},n.prototype._cleanup=function(){if(this.connections)for(var e=Object.keys(this.connections),t=0,n=e.length;t<n;t++)this._cleanupPeer(e[t]);this.emit("close")},n.prototype._cleanupPeer=function(e){for(var t=this.connections[e],n=0,r=t.length;n<r;n+=1)t[n].close()},n.prototype.disconnect=function(){var e=this;u.setZeroTimeout(function(){e.disconnected||(e.disconnected=!0,e.open=!1,e.socket&&e.socket.close(),e.emit("disconnected",e.id),e._lastServerId=e.id,e.id=null)})},n.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)u.log("Attempting reconnection to server with ID "+this._lastServerId),this.disconnected=!1,this._initializeServerConnection(),this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(this.disconnected||this.open)throw new Error("Peer "+this.id+" cannot reconnect because it is not disconnected from the server!");u.error("In a hurry? We're still trying to make the initial connection!")}},n.prototype.listAllPeers=function(t){t=t||function(){};var n=this,r=new XMLHttpRequest,e=(this.options.secure?"https://":"http://")+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/peers";e+="?ts="+(new Date).getTime()+Math.random(),r.open("get",e,!0),r.onerror=function(){n._abort("server-error","Could not get peers from the server."),t([])},r.onreadystatechange=function(){if(4===r.readyState){if(401===r.status){var e;throw e=n.options.host!==u.CLOUD_HOST?"It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":"You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",t([]),new Error("It doesn't look like you have permission to list peers IDs. "+e)}t(200!==r.status?[]:JSON.parse(r.responseText))}},r.send(null)},t.exports=n},{"./dataconnection":2,"./mediaconnection":4,"./socket":7,"./util":8,eventemitter3:9}],7:[function(e,t){function s(e,t,n,r,a){if(!(this instanceof s))return new s(e,t,n,r,a);c.call(this),this.disconnected=!1,this._queue=[];var i=e?"https://":"http://",o=e?"wss://":"ws://";this._httpUrl=i+t+":"+n+r+a,this._wsUrl=o+t+":"+n+r+"peerjs?key="+a}var i=e("./util"),c=e("eventemitter3");i.inherits(s,c),s.prototype.start=function(e,t){this.id=e,this._httpUrl+="/"+e+"/"+t,this._wsUrl+="&id="+e+"&token="+t,this._startXhrStream(),this._startWebSocket()},s.prototype._startWebSocket=function(){var n=this;this._socket||(this._socket=new WebSocket(this._wsUrl),this._socket.onmessage=function(t){try{var e=JSON.parse(t.data)}catch(e){return void i.log("Invalid server message",t.data)}n.emit("message",e)},this._socket.onclose=function(){i.log("Socket closed."),n.disconnected=!0,n.emit("disconnected")},this._socket.onopen=function(){n._timeout&&(clearTimeout(n._timeout),setTimeout(function(){n._http.abort(),n._http=null},5e3)),n._sendQueuedMessages(),i.log("Socket open")})},s.prototype._startXhrStream=function(e){try{var t=this;this._http=new XMLHttpRequest,this._http._index=1,this._http._streamIndex=e||0,this._http.open("post",this._httpUrl+"/id?i="+this._http._streamIndex,!0),this._http.onerror=function(){clearTimeout(t._timeout),t.emit("disconnected")},this._http.onreadystatechange=function(){2==this.readyState&&this.old?(this.old.abort(),delete this.old):2<this.readyState&&200===this.status&&this.responseText&&t._handleStream(this)},this._http.send(null),this._setHTTPTimeout()}catch(e){i.log("XMLHttpRequest not available; defaulting to WebSockets")}},s.prototype._handleStream=function(t){var e=t.responseText.split("\n");if(t._buffer)for(;0<t._buffer.length;){var n=t._buffer.shift(),r=e[n];try{r=JSON.parse(r)}catch(e){t._buffer.shift(n);break}this.emit("message",r)}var a=e[t._index];if(a)if(t._index+=1,t._index===e.length)t._buffer||(t._buffer=[]),t._buffer.push(t._index-1);else{try{a=JSON.parse(a)}catch(e){return void i.log("Invalid server message",a)}this.emit("message",a)}},s.prototype._setHTTPTimeout=function(){var t=this;this._timeout=setTimeout(function(){var e=t._http;t._wsOpen()?e.abort():(t._startXhrStream(e._streamIndex+1),t._http.old=e)},25e3)},s.prototype._wsOpen=function(){return this._socket&&1==this._socket.readyState},s.prototype._sendQueuedMessages=function(){for(var e=0,t=this._queue.length;e<t;e+=1)this.send(this._queue[e])},s.prototype.send=function(e){if(!this.disconnected){if(!this.id)return void this._queue.push(e);if(!e.type)return void this.emit("error","Invalid message");var t=JSON.stringify(e);if(this._wsOpen())this._socket.send(t);else{var n=new XMLHttpRequest,r=this._httpUrl+"/"+e.type.toLowerCase();n.open("post",r,!0),n.setRequestHeader("Content-Type","application/json"),n.send(t)}}},s.prototype.close=function(){!this.disconnected&&this._wsOpen()&&(this._socket.close(),this.disconnected=!0)},t.exports=s},{"./util":8,eventemitter3:9}],8:[function(e,t){var l={iceServers:[{url:"stun:stun.l.google.com:19302"}]},c=1,n=e("js-binarypack"),u=e("./adapter").RTCPeerConnection,d={noop:function(){},CLOUD_HOST:"0.peerjs.com",CLOUD_PORT:9e3,chunkedBrowsers:{Chrome:1},chunkedMTU:16300,logLevel:0,setLogLevel:function(e){var t=parseInt(e,10);d.logLevel=isNaN(parseInt(e,10))?e?3:0:t,d.log=d.warn=d.error=d.noop,0<d.logLevel&&(d.error=d._printWith("ERROR")),1<d.logLevel&&(d.warn=d._printWith("WARNING")),2<d.logLevel&&(d.log=d._print)},setLogFunction:function(e){e.constructor!==Function?d.warn("The log function you passed in is not a function. Defaulting to regular logs."):d._print=e},_printWith:function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t),d._print.apply(d,e)}},_print:function(){var e=!1,t=Array.prototype.slice.call(arguments);t.unshift("PeerJS: ");for(var n=0,r=t.length;n<r;n++)t[n]instanceof Error&&(t[n]="("+t[n].name+") "+t[n].message,e=!0);e?console.error.apply(console,t):console.log.apply(console,t)},defaultConfig:l,browser:window.mozRTCPeerConnection?"Firefox":window.webkitRTCPeerConnection?"Chrome":window.RTCPeerConnection?"Supported":"Unsupported",supports:function(){if(void 0===u)return{};var e,t,n=!0,r=!0,a=!1,i=!1,o=!!window.webkitRTCPeerConnection;try{e=new u(l,{optional:[{RtpDataChannels:!0}]})}catch(e){r=n=!1}if(n)try{t=e.createDataChannel("_PEERJSTEST")}catch(e){n=!1}if(n){try{t.binaryType="blob",a=!0}catch(e){}var s=new u(l,{});try{i=s.createDataChannel("_PEERJSRELIABLETEST",{}).reliable}catch(e){}s.close()}if(r&&(r=!!e.addStream),!o&&n){var c=new u(l,{optional:[{RtpDataChannels:!0}]});c.onnegotiationneeded=function(){o=!0,d&&d.supports&&(d.supports.onnegotiationneeded=!0)},c.createDataChannel("_PEERJSNEGOTIATIONTEST"),setTimeout(function(){c.close()},1e3)}return e&&e.close(),{audioVideo:r,data:n,binaryBlob:a,binary:i,reliable:i,sctp:i,onnegotiationneeded:o}}(),validateId:function(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(e)},validateKey:function(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(e)},debug:!1,inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:n.pack,unpack:n.unpack,log:function(){if(d.debug){var e=!1,t=Array.prototype.slice.call(arguments);t.unshift("PeerJS: ");for(var n=0,r=t.length;n<r;n++)t[n]instanceof Error&&(t[n]="("+t[n].name+") "+t[n].message,e=!0);e?console.error.apply(console,t):console.log.apply(console,t)}},setZeroTimeout:function(t){function e(e){e.source==t&&e.data==r&&(e.stopPropagation&&e.stopPropagation(),n.length&&n.shift()())}var n=[],r="zero-timeout-message";return t.addEventListener?t.addEventListener("message",e,!0):t.attachEvent&&t.attachEvent("onmessage",e),function(e){n.push(e),t.postMessage(r,"*")}}(window),chunk:function(e){for(var t=[],n=e.size,r=index=0,a=Math.ceil(n/d.chunkedMTU);r<n;){var i=Math.min(n,r+d.chunkedMTU),o=e.slice(r,i),s={__peerData:c,n:index,data:o,total:a};t.push(s),r=i,index+=1}return c+=1,t},blobToArrayBuffer:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsArrayBuffer(e)},blobToBinaryString:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsBinaryString(e)},binaryStringToArrayBuffer:function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=255&e.charCodeAt(n);return t.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isSecure:function(){return"https:"===location.protocol}};t.exports=d},{"./adapter":1,"js-binarypack":10}],9:[function(e,t){"use strict";function r(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function n(){}n.prototype._events=void 0,n.prototype.listeners=function(e){if(!this._events||!this._events[e])return[];for(var t=0,n=this._events[e].length,r=[];t<n;t++)r.push(this._events[e][t].fn);return r},n.prototype.emit=function(e,t,n,r,a,i){if(!this._events||!this._events[e])return!1;var o,s,c,l=this._events[e],u=l.length,d=arguments.length,h=l[0];if(1===u){switch(h.once&&this.removeListener(e,h.fn,!0),d){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,n),!0;case 4:return h.fn.call(h.context,t,n,r),!0;case 5:return h.fn.call(h.context,t,n,r,a),!0;case 6:return h.fn.call(h.context,t,n,r,a,i),!0}for(s=1,o=new Array(d-1);s<d;s++)o[s-1]=arguments[s];h.fn.apply(h.context,o)}else for(s=0;s<u;s++)switch(l[s].once&&this.removeListener(e,l[s].fn,!0),d){case 1:l[s].fn.call(l[s].context);break;case 2:l[s].fn.call(l[s].context,t);break;case 3:l[s].fn.call(l[s].context,t,n);break;default:if(!o)for(c=1,o=new Array(d-1);c<d;c++)o[c-1]=arguments[c];l[s].fn.apply(l[s].context,o)}return!0},n.prototype.on=function(e,t,n){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),this._events[e].push(new r(t,n||this)),this},n.prototype.once=function(e,t,n){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),this._events[e].push(new r(t,n||this,!0)),this},n.prototype.removeListener=function(e,t,n){if(!this._events||!this._events[e])return this;var r=this._events[e],a=[];if(t)for(var i=0,o=r.length;i<o;i++)r[i].fn!==t&&r[i].once!==n&&a.push(r[i]);return this._events[e]=a.length?a:null,this},n.prototype.removeAllListeners=function(e){return this._events&&(e?this._events[e]=null:this._events={}),this},n.prototype.off=n.prototype.removeListener,n.prototype.addListener=n.prototype.on,n.prototype.setMaxListeners=function(){return this},((n.EventEmitter=n).EventEmitter2=n).EventEmitter3=n,"object"==typeof t&&t.exports&&(t.exports=n)},{}],10:[function(e,t){function n(e){this.index=0,this.dataBuffer=e,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function r(){this.bufferBuilder=new i}function a(e){var t=e.charCodeAt(0);return t<=2047?"00":t<=65535?"000":t<=2097151?"0000":t<=67108863?"00000":"000000"}var i=e("./bufferbuilder").BufferBuilder,o=e("./bufferbuilder").binaryFeatures,s={unpack:function(e){return new n(e).unpack()},pack:function(e){var t=new r;return t.pack(e),t.getBuffer()}};t.exports=s,n.prototype.unpack=function(){var e,t=this.unpack_uint8();if(t<128)return t;if((224^t)<32)return(224^t)-32;if((e=160^t)<=15)return this.unpack_raw(e);if((e=176^t)<=15)return this.unpack_string(e);if((e=144^t)<=15)return this.unpack_array(e);if((e=128^t)<=15)return this.unpack_map(e);switch(t){case 192:return null;case 193:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:case 213:case 214:case 215:return;case 216:return e=this.unpack_uint16(),this.unpack_string(e);case 217:return e=this.unpack_uint32(),this.unpack_string(e);case 218:return e=this.unpack_uint16(),this.unpack_raw(e);case 219:return e=this.unpack_uint32(),this.unpack_raw(e);case 220:return e=this.unpack_uint16(),this.unpack_array(e);case 221:return e=this.unpack_uint32(),this.unpack_array(e);case 222:return e=this.unpack_uint16(),this.unpack_map(e);case 223:return e=this.unpack_uint32(),this.unpack_map(e)}},n.prototype.unpack_uint8=function(){var e=255&this.dataView[this.index];return this.index++,e},n.prototype.unpack_uint16=function(){var e=this.read(2),t=256*(255&e[0])+(255&e[1]);return this.index+=2,t},n.prototype.unpack_uint32=function(){var e=this.read(4),t=256*(256*(256*e[0]+e[1])+e[2])+e[3];return this.index+=4,t},n.prototype.unpack_uint64=function(){var e=this.read(8),t=256*(256*(256*(256*(256*(256*(256*e[0]+e[1])+e[2])+e[3])+e[4])+e[5])+e[6])+e[7];return this.index+=8,t},n.prototype.unpack_int8=function(){var e=this.unpack_uint8();return e<128?e:e-256},n.prototype.unpack_int16=function(){var e=this.unpack_uint16();return e<32768?e:e-65536},n.prototype.unpack_int32=function(){var e=this.unpack_uint32();return e<Math.pow(2,31)?e:e-Math.pow(2,32)},n.prototype.unpack_int64=function(){var e=this.unpack_uint64();return e<Math.pow(2,63)?e:e-Math.pow(2,64)},n.prototype.unpack_raw=function(e){if(this.length<this.index+e)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+e+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+e);return this.index+=e,t},n.prototype.unpack_string=function(e){for(var t,n,r=this.read(e),a=0,i="";a<e;)(t=r[a])<128?(i+=String.fromCharCode(t),a++):(192^t)<32?(n=(192^t)<<6|63&r[a+1],i+=String.fromCharCode(n),a+=2):(n=(15&t)<<12|(63&r[a+1])<<6|63&r[a+2],i+=String.fromCharCode(n),a+=3);return this.index+=e,i},n.prototype.unpack_array=function(e){for(var t=new Array(e),n=0;n<e;n++)t[n]=this.unpack();return t},n.prototype.unpack_map=function(e){for(var t={},n=0;n<e;n++){var r=this.unpack(),a=this.unpack();t[r]=a}return t},n.prototype.unpack_float=function(){var e=this.unpack_uint32(),t=(e>>23&255)-127;return(0==e>>31?1:-1)*(8388607&e|8388608)*Math.pow(2,t-23)},n.prototype.unpack_double=function(){var e=this.unpack_uint32(),t=this.unpack_uint32(),n=(e>>20&2047)-1023;return(0==e>>31?1:-1)*((1048575&e|1048576)*Math.pow(2,n-20)+t*Math.pow(2,n-52))},n.prototype.read=function(e){var t=this.index;if(t+e<=this.length)return this.dataView.subarray(t,t+e);throw new Error("BinaryPackFailure: read index out of range")},r.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()},r.prototype.pack=function(e){var t=typeof e;if("string"==t)this.pack_string(e);else if("number"==t)Math.floor(e)===e?this.pack_integer(e):this.pack_double(e);else if("boolean"==t)!0===e?this.bufferBuilder.append(195):!1===e&&this.bufferBuilder.append(194);else if("undefined"==t)this.bufferBuilder.append(192);else{if("object"!=t)throw new Error('Type "'+t+'" not yet supported');if(null===e)this.bufferBuilder.append(192);else{var n=e.constructor;if(n==Array)this.pack_array(e);else if(n==Blob||n==File)this.pack_bin(e);else if(n==ArrayBuffer)this.pack_bin(o.useArrayBufferView?new Uint8Array(e):e);else if("BYTES_PER_ELEMENT"in e)this.pack_bin(o.useArrayBufferView?new Uint8Array(e.buffer):e.buffer);else if(n==Object)this.pack_object(e);else if(n==Date)this.pack_string(e.toString());else{if("function"!=typeof e.toBinaryPack)throw new Error('Type "'+n.toString()+'" not yet supported');this.bufferBuilder.append(e.toBinaryPack())}}}this.bufferBuilder.flush()},r.prototype.pack_bin=function(e){var t=e.length||e.byteLength||e.size;if(t<=15)this.pack_uint8(160+t);else if(t<=65535)this.bufferBuilder.append(218),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(t)}this.bufferBuilder.append(e)},r.prototype.pack_string=function(e){var t,n=600<(t=e).length?new Blob([t]).size:t.replace(/[^\u0000-\u007F]/g,a).length;if(n<=15)this.pack_uint8(176+n);else if(n<=65535)this.bufferBuilder.append(216),this.pack_uint16(n);else{if(!(n<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(n)}this.bufferBuilder.append(e)},r.prototype.pack_array=function(e){var t=e.length;if(t<=15)this.pack_uint8(144+t);else if(t<=65535)this.bufferBuilder.append(220),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(t)}for(var n=0;n<t;n++)this.pack(e[n])},r.prototype.pack_integer=function(e){if(-32<=e&&e<=127)this.bufferBuilder.append(255&e);else if(0<=e&&e<=255)this.bufferBuilder.append(204),this.pack_uint8(e);else if(-128<=e&&e<=127)this.bufferBuilder.append(208),this.pack_int8(e);else if(0<=e&&e<=65535)this.bufferBuilder.append(205),this.pack_uint16(e);else if(-32768<=e&&e<=32767)this.bufferBuilder.append(209),this.pack_int16(e);else if(0<=e&&e<=4294967295)this.bufferBuilder.append(206),this.pack_uint32(e);else if(-2147483648<=e&&e<=2147483647)this.bufferBuilder.append(210),this.pack_int32(e);else if(-0x8000000000000000<=e&&e<=0x8000000000000000)this.bufferBuilder.append(211),this.pack_int64(e);else{if(!(0<=e&&e<=0x10000000000000000))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(e)}},r.prototype.pack_double=function(e){var t=0;e<0&&(t=1,e=-e);var n=Math.floor(Math.log(e)/Math.LN2),r=e/Math.pow(2,n)-1,a=Math.floor(r*Math.pow(2,52)),i=Math.pow(2,32),o=t<<31|n+1023<<20|a/i&1048575,s=a%i;this.bufferBuilder.append(203),this.pack_int32(o),this.pack_int32(s)},r.prototype.pack_object=function(e){var t=Object.keys(e).length;if(t<=15)this.pack_uint8(128+t);else if(t<=65535)this.bufferBuilder.append(222),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(t)}for(var n in e)e.hasOwnProperty(n)&&(this.pack(n),this.pack(e[n]))},r.prototype.pack_uint8=function(e){this.bufferBuilder.append(e)},r.prototype.pack_uint16=function(e){this.bufferBuilder.append(e>>8),this.bufferBuilder.append(255&e)},r.prototype.pack_uint32=function(e){var t=4294967295&e;this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t)},r.prototype.pack_uint64=function(e){var t=e/Math.pow(2,32),n=e%Math.pow(2,32);this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t),this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)},r.prototype.pack_int8=function(e){this.bufferBuilder.append(255&e)},r.prototype.pack_int16=function(e){this.bufferBuilder.append((65280&e)>>8),this.bufferBuilder.append(255&e)},r.prototype.pack_int32=function(e){this.bufferBuilder.append(e>>>24&255),this.bufferBuilder.append((16711680&e)>>>16),this.bufferBuilder.append((65280&e)>>>8),this.bufferBuilder.append(255&e)},r.prototype.pack_int64=function(e){var t=Math.floor(e/Math.pow(2,32)),n=e%Math.pow(2,32);this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t),this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)}},{"./bufferbuilder":11}],11:[function(e,t){function n(){this._pieces=[],this._parts=[]}var r={};r.useBlobBuilder=function(){try{return new Blob([]),!1}catch(e){return!0}}(),r.useArrayBufferView=!r.useBlobBuilder&&function(){try{return 0===new Blob([new Uint8Array([])]).size}catch(e){return!0}}(),t.exports.binaryFeatures=r;var a=t.exports.BlobBuilder;"undefined"!=typeof window&&(a=t.exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder),n.prototype.append=function(e){"number"==typeof e?this._pieces.push(e):(this.flush(),this._parts.push(e))},n.prototype.flush=function(){if(0<this._pieces.length){var e=new Uint8Array(this._pieces);r.useArrayBufferView||(e=e.buffer),this._parts.push(e),this._pieces=[]}},n.prototype.getBuffer=function(){if(this.flush(),r.useBlobBuilder){for(var e=new a,t=0,n=this._parts.length;t<n;t++)e.append(this._parts[t]);return e.getBlob()}return new Blob(this._parts)},t.exports.BufferBuilder=n},{}],12:[function(e,t){function n(e,t){return this instanceof n?(this._dc=e,l.debug=t,this._outgoing={},this._incoming={},this._received={},this._window=1e3,this._mtu=500,this._interval=0,this._count=0,this._queue=[],void this._setupDC()):new n(e)}var l=e("./util");n.prototype.send=function(e){var t=l.pack(e);return t.size<this._mtu?void this._handleSend(["no",t]):(this._outgoing[this._count]={ack:0,chunks:this._chunk(t)},l.debug&&(this._outgoing[this._count].timer=new Date),this._sendWindowedChunks(this._count),void(this._count+=1))},n.prototype._setupInterval=function(){var r=this;this._timeout=setInterval(function(){var e=r._queue.shift();if(e._multiple)for(var t=0,n=e.length;t<n;t+=1)r._intervalSend(e[t]);else r._intervalSend(e)},this._interval)},n.prototype._intervalSend=function(e){var t=this;e=l.pack(e),l.blobToBinaryString(e,function(e){t._dc.send(e)}),0===t._queue.length&&(clearTimeout(t._timeout),t._timeout=null)},n.prototype._processAcks=function(){for(var e in this._outgoing)this._outgoing.hasOwnProperty(e)&&this._sendWindowedChunks(e)},n.prototype._handleSend=function(e){for(var t=!0,n=0,r=this._queue.length;n<r;n+=1){var a=this._queue[n];a===e?t=!1:a._multiple&&-1!==a.indexOf(e)&&(t=!1)}t&&(this._queue.push(e),this._timeout||this._setupInterval())},n.prototype._setupDC=function(){var r=this;this._dc.onmessage=function(e){var t=e.data;if(t.constructor===String){var n=l.binaryStringToArrayBuffer(t);t=l.unpack(n),r._handleMessage(t)}}},n.prototype._handleMessage=function(e){var t,n=e[1],r=this._incoming[n],a=this._outgoing[n];switch(e[0]){case"no":var i=n;i&&this.onmessage(l.unpack(i));break;case"end":if(t=r,this._received[n]=e[2],!t)break;this._ack(n);break;case"ack":if(t=a){var o=e[2];t.ack=Math.max(o,t.ack),t.ack>=t.chunks.length?(l.log("Time: ",new Date-t.timer),delete this._outgoing[n]):this._processAcks()}break;case"chunk":if(!(t=r)){if(!0===this._received[n])break;t={ack:["ack",n,0],chunks:[]},this._incoming[n]=t}var s=e[2],c=e[3];t.chunks[s]=new Uint8Array(c),s===t.ack[2]&&this._calculateNextAck(n),this._ack(n);break;default:this._handleSend(e)}},n.prototype._chunk=function(e){for(var t=[],n=e.size,r=0;r<n;){var a=Math.min(n,r+this._mtu),i={payload:e.slice(r,a)};t.push(i),r=a}return l.log("Created",t.length,"chunks."),t},n.prototype._ack=function(e){var t=this._incoming[e].ack;this._received[e]===t[2]&&(this._complete(e),this._received[e]=!0),this._handleSend(t)},n.prototype._calculateNextAck=function(e){for(var t=this._incoming[e],n=t.chunks,r=0,a=n.length;r<a;r+=1)if(void 0===n[r])return void(t.ack[2]=r);t.ack[2]=n.length},n.prototype._sendWindowedChunks=function(e){l.log("sendWindowedChunks for: ",e);for(var t=this._outgoing[e],n=t.chunks,r=[],a=Math.min(t.ack+this._window,n.length),i=t.ack;i<a;i+=1)n[i].sent&&i!==t.ack||(n[i].sent=!0,r.push(["chunk",e,i,n[i].payload]));t.ack+this._window>=n.length&&r.push(["end",e,n.length]),r._multiple=!0,this._handleSend(r)},n.prototype._complete=function(e){l.log("Completed called for",e);var t=this,n=this._incoming[e].chunks,r=new Blob(n);l.blobToArrayBuffer(r,function(e){t.onmessage(l.unpack(e))}),delete this._incoming[e]},n.higherBandwidthSDP=function(e){var t=navigator.appVersion.match(/Chrome\/(.*?) /);if(t&&(t=parseInt(t[1].split(".").shift()))<31){var n=e.split("b=AS:30");if(1<n.length)return n[0]+"b=AS:102400"+n[1]}return e},n.prototype.onmessage=function(){},t.exports.Reliable=n},{"./util":13}],13:[function(e,t){var n=e("js-binarypack"),r={debug:!1,inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:n.pack,unpack:n.unpack,log:function(){if(r.debug){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e.unshift("Reliable: "),console.log.apply(console,e)}},setZeroTimeout:function(t){function e(e){e.source==t&&e.data==r&&(e.stopPropagation&&e.stopPropagation(),n.length&&n.shift()())}var n=[],r="zero-timeout-message";return t.addEventListener?t.addEventListener("message",e,!0):t.attachEvent&&t.attachEvent("onmessage",e),function(e){n.push(e),t.postMessage(r,"*")}}(this),blobToArrayBuffer:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsArrayBuffer(e)},blobToBinaryString:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsBinaryString(e)},binaryStringToArrayBuffer:function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=255&e.charCodeAt(n);return t.buffer},randomToken:function(){return Math.random().toString(36).substr(2)}};t.exports=r},{"js-binarypack":10}]},{},[3]);var emptyFunction=SIMULATOR.sendBattleUpdate=function(){},cardInfo=require("cardInfo");base64=require("base64");$(document).ready(function(){var n=new Peer({key:"12gvgzijkheka9k9",debug:3,logFunction:function(){var e,t=Array.prototype.slice.call(arguments).join(" ");e=t,$(".log").append(e+"<br/>"),console.log(e)}}),r=null,a=!1,i=!1;function o(e){s(e),i=$("#surge").is(":checked");var t={type:"requestFight",data:{hash:$("#deck1").val(),bges:function(){for(var e="",t=document.getElementsByName("battleground"),n=0;n<t.length;n++)d=t[n],d.checked&&(e+=base64.fromDecimal(d.value,2));return e}(),tournament:$("#tournament").is(":checked"),surge:!i}};e.send(JSON.stringify(t))}function s(t){t.on("data",function(e){!function(e,t){var n=JSON.parse(t);switch(n.type){case"requestFight":!function(e,t){var n;a?(n={type:"accepted",data:$("#deck1").val()},$("#deck2").val(t.hash),function(e){$("#battleground input").prop("checked",!1);for(var t=0;t<e.length;t+=2){var n=base64.toDecimal(e.substring(t,t+2));$("#battleground_"+n).prop("checked",!0)}}(t.bges),i=$("#surge").prop("checked"),$("#surge").prop("checked",t.surge),$("#tournament").prop("checked",t.tournament),SIMULATOR.sendBattleUpdate=c,SIMULATOR.waiting=!0,SIMULATOR.pause=!0,SIMULATOR.livePvP=!0,SIM_CONTROLLER.startsim(),SIM_CONTROLLER.end_sims_callback=l,$("#btnStop").off("click").on("click",l)):n={type:"rejected"};e.send(JSON.stringify(n))}(e,n.data);break;case"accepted":r=n.data,$("#deck2").val(r),$("#btnStop").off("click").on("click",l),SIMULATOR.livePvP=!0,SIMULATOR.sendBattleUpdate=c,SIM_CONTROLLER.startsim(),SIM_CONTROLLER.end_sims_callback=l;break;case"rejected":CARD_GUI.clearCardSpace(),outp("Opponent is not ready"),m();break;case"updateField":!function(e){if(SIMULATOR.waiting){var t=SIMULATOR.field=e.field,n=SIMULATOR.simulation_turns=e.turn;echo=(echo=(echo=(echo=e.echo).replace(/<b>/g,"<z>").replace(/<\/b>/g,"</z>")).replace(/<i>/g,"<b>").replace(/<\/i>/g,"</b>")).replace(/<z>/g,"<i>").replace(/<\/z>/g,"</i>"),u(t.player.commander);for(var r=t.player.assaults,a=0;a<r.length;a++)u(r[a]);u(t.cpu.commander);for(var r=t.cpu.assaults,a=0;a<r.length;a++)u(r[a]);var i=t.player;t.player=t.cpu,t.cpu=i,CARD_GUI.draw_cards(t),SIMULATOR.performTurns(n,!0)}}(n.data)}var r}(t,e)}),t.on("close",function(){SIMULATOR.sendBattleUpdate=emptyFunction,SIMULATOR.livePvP=!1,l()}),r=t.peer}function c(e){var t={type:"updateField",data:{field:SIMULATOR.field,turn:e,echo:echo}};p().send(JSON.stringify(t))}function l(){setTimeout(m,1),SIMULATOR.simulating&&SIM_CONTROLLER.stopsim(),$("#surge").prop("checked",i)}function u(e){e.__proto__=CardPrototype,e.owner="player"===e.owner?"cpu":"player"}function e(){$("#enemyPeerID").val()?$("#btn_simulate").off("click").on("click",f).val("Connect!"):$("#btn_simulate").off("click").on("click",t).val("Ready!")}function t(){hideUI(),points=draws=losses=wins=0,outp(""),setSimStatus(""),CARD_GUI.clearCardSpace(),a=!0,$("#btnStop").off("click").on("click",h)}function h(){a=!1,showUI()}function f(){var e=$("#enemyPeerID").val();if(!r){var t=n.connect(e,{label:"chat",serialization:"none",metadata:{message:"hi i want to chat with you!"}});t.on("open",function(){o(t)}),t.on("error",function(e){alert(e)}),r=e}}function p(){return n.connections[r][0]}function m(){null!==r&&(p().close(),delete n.connections[r],r=null),a=!1}$("#debug").prop("checked",!0),n.on("open",function(e){$("#myPeerID").val(e)}),n.on("connection",function(e){s(e)}),n.on("error",function(e){console.log(e),m()}),$("#btn_simulate").off("click").on("click",t),$("#enemyPeerID").on("change",e).on("keyup",e.debounce(50)),$("#send").submit(function(e){e.preventDefault(),sendMsg()}),window.onunload=window.onbeforeunload=function(e){n&&!n.destroyed&&n.destroy()}});
//# sourceMappingURL=livePvP.min.js.map