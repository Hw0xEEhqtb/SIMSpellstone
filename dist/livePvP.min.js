for(var skillID in SKILL_DATA){var skillInfo=SKILL_DATA[skillID];"flurry"===skillID?skillInfo.type="flurry":0<=["turnStart","onAttack","onDamaged","turnEnd"].indexOf(skillInfo.type)&&(skillInfo.type="passive")}var REVERSE_FUSIONS={};for(var id in FUSIONS){var fusion=FUSIONS[id];REVERSE_FUSIONS[fusion]=id}var DATA_UPDATER=function(){var i="https://spellstone.synapse-games.com",h={},f={},o=null;var s=["cards_heroes.xml","cards_premium_aether.xml","cards_premium_chaos.xml","cards_premium_wyld.xml","cards_reward.xml","cards_shard.xml","cards_special.xml","cards_standard.xml","cards_story.xml","fusion_recipes_cj2.xml"];function p(e){var t,n,a={};if(a.id=m(e,"id"),a.name=m(e,"name"),d(a,e,"desc"),a.picture=m(e,"picture")||(t=m(e,"asset_prefab"),n="prefab_",t?n+t:t),!a.picture){var r=m(e,"portrait");a.picture=r?"portrait_"+r.toLowerCase().replace("portrait_",""):"NotFound"}var i=m(e,"hidden_until")||m(e,"hidden_until_time");i&&(a.hidden_until=i+"000"),a.rarity=m(e,"rarity"),a.set=m(e,"set"),a.card_type=m(e,"card_type"),g(a,e,"shard_card"),a.type=m(e,"type")||0,a.sub_type=v(e,"sub_type")||[],g(a,e,"health"),"1"!=a.card_type&&(g(a,e,"attack"),g(a,e,"cost"));var o=function(e){for(var t=e.getElementsByTagName("upgrade"),n={},a=0;a<t.length;a++)n[a+2]=u(t[a]);return n}(e);return a.maxLevel=1+Object.keys(o).length,a.skill=l(e),a.upgrades=o,a}function l(e){for(var t=e.childNodes,n=[],a=0;a<t.length;a++){var r=t[a];"skill"===r.nodeName&&n.push(c(r))}return n}function c(e){var t={id:m(e,"id",!0)};return g(t,e,"x",!0),g(t,e,"mult",!0),g(t,e,"on_delay_mult",!0),d(t,e,"y",!0),g(t,e,"z",!0),g(t,e,"c",!0),d(t,e,"s",!0),d(t,e,"all",!0),t}function u(e){var t={};return g(t,e,"attack"),g(t,e,"health"),g(t,e,"cost"),d(t,e,"desc"),t.skill=l(e),t}function d(e,t,n,a){var r=m(t,n,a);null!=r&&0<r.length&&(e[n]=r)}function g(e,t,n,a){var r,i=null!=(r=m(t,n,a))?Number(r):-1;0<=i&&(e[n]=i)}function m(e,t,n){if(n)return e.getAttribute(t);var a=v(e,t);return a?a[0]:null}function v(e,t){var n=null,a=$(e).children(t);if(0<a.length){n=[];for(var r=0;r<a.length;r++)n.push(a[r].textContent)}return n}return{updateData:function(e,t){$("body").addClass("loading"),$("#loadingSplash").html("Checking for New Cards...");var n=Date.now();if(!o||6e4<o-n||t){o=n,h={};var a=[];a.push(function(){for(var e=[],t=0;t<s.length;t++){var n=jQuery.ajax({url:i+"/assets/"+s[t],success:function(e){for(var t="undefined"!=typeof spoilers,n=e.getElementsByTagName("unit"),a=0;a<n.length;a++){n[a];var r=m(n[a],"id"),i=p(n[a]),o=!1;CARDS[r]?JSON.stringify(CARDS[r])!==JSON.stringify(i)&&(o=!0):o=!0,o&&(t&&(spoilers[r]=!0),h[r]=i),CARDS[r]=i}for(var s=e.getElementsByTagName("fusion_recipe"),a=0;a<s.length;a++){var l=s[a],c=m(l,"card_id",!1),u=l.getElementsByTagName("resource")[0];if(u){var d=m(u,"card_id",!0);FUSIONS[d]&&FUSIONS[d]==c||(f[d]=c,FUSIONS[d]=c)}}},async:!0,cache:!1});e.push(n)}return $.when.apply($,e)}());var r=function(){!function(){if(void 0!==storageAPI){var e=storageAPI.getField("GameData","CardCache");e?(e.newCards=e.newCards||{},e.newFusions=e.newFusions||{},$.extend(e.newCards,h),$.extend(e.newFusions,f)):e={newCards:h,newFusions:f},e.lastUpdated=Date.now(),storageAPI.setField("GameData","CardCache",e)}}(),$("body").removeClass("loading"),e&&e()};$.when.apply($,a).then(r,r)}else e&&e()}}}(),base64=function(){"use strict";var e={encodeHash:function(e){var t=[];e.commander&&t.push(e.commander);return t.concat(e.deck).map(a).join("")},decodeHash:function(e){for(var t,n={deck:[]},a=0;a<e.length;a+=5){var r=e.substr(a,5);(t=o(r))&&(loadCard(t.id)?!n.commander&&is_commander(t.id)?n.commander=t:n.deck.push(t):console.log("Could not decode '"+r+"' ("+t.id+")"))}n.commander||(n.commander=elariaCaptain);return n},fromDecimal:c,toDecimal:u,fromUnitInfo:a},i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!~",s={};for(var t in CARDS)if(t<1e4){var n=FUSIONS[t];(!n||Number(n)<1e4)&&(s[t]=!0)}var l=1e3;function a(e){var t=parseInt(e.id),n=parseInt(e.level)-1;if(s[t]){var a=Math.floor(n/7);n=n%7}else{a=Math.floor(t/1e4);t%=1e4}var r=0;e.runes.length&&(r=parseInt(e.runes[0].id),r%=5e3);var i=t;return c(i=(i=7*(i=3*i+a)+n)*l+r,5)}function o(e){var t=u(e),n=t%l,a=(t=(t-n)/l)%7,r=(t=(t-a++)/7)%3,i=t=(t-r)/3;s[i]?a+=7*r:0<r&&(i=Number(r+""+i));var o=makeUnitInfo(i,a);return 0<n&&o.runes.push({id:n+5e3}),o}function c(e,t){for(var n="",a=0;a<t;a++){var r=e%64;n+=i[r],e=(e-r)/64}return n}function u(e){for(var t=0,n=e.length-1;0<=n;n--){t*=64,t+=i.indexOf(e[n])}return t}return e}(),loadDeck=function(){function _(e){for(var t=function(e){for(var t,n=e.id;void 0!==(n=REVERSE_FUSIONS[t=n]););return t}(e),n=-1;void 0!==t;)n++,t=FUSIONS[t];return n}function k(e,t,n){if(t=parseInt(t),e.mastery_level&&t<parseInt(e.mastery_level))return null;if(e.remove_mastery_level&&t>=parseInt(e.remove_mastery_level))return null;var a=e.id,r=!1;a||(a=function(e){var t=[];for(var n in CARDS)if(!REVERSE_FUSIONS[n]){var a=CARDS[n];if("1"!=a.card_type&&!(e.max_rarity&&Number(e.max_rarity)<Number(a.rarity)||e.min_rarity&&Number(e.min_rarity)>Number(a.rarity))&&(!e.type||e.type==a.type||0<=a.sub_type.indexOf(e.type.toString()))){if(e.set&&e.set.split(",").indexOf(a.set)<0)continue;t.push(n)}}return t[~~(Math.random()*t.length)]}(e),r=!0);var i=e.level||1;if(n<=t)i=7,c(a)&&(a=u(a));else if(1<t&&is_commander(a)){var o=(Number(loadCard(a).rarity)+1)/(n-1),s=t-1;i=Math.ceil(o*s)}var l=makeUnitInfo(a,i);return r&&(l.randomInfo={unitInfo:e,level:t,maxedAt:n}),l}function y(e){var t=parseInt(loadCard(e.id).rarity)+2;if(e.level==t){if(!c(e.id))return!1;e.id=u(e.id,1),e.level=1}else e.level++;return!0}function c(e){return!(-1<i.indexOf(e))&&(!is_commander(e)&&!!FUSIONS[e])}function u(e,t){if(-1==i.indexOf(e))if(t)for(var n=0;n<t;n++)e=r(e);else do{var a=r(e);e=a}while(e!==a);return e}function r(e){var t=FUSIONS[e];return t||e}var i=["8005","8006","8007","8008","8009","8010"];function o(e,t,n){var a=n+1;t||(t=a);var r=[];r.deck=[];var i=function(e,t){t=parseInt(t);var n=e.commander;if(n.card){for(var a=[],r=0;r<n.card.length;r++){var i=n.card[r],o=parseInt(i.min_mastery_level)||0,s=parseInt(i.max_mastery_level)||999;o<=t&&t<=s&&a.push(i)}(n=a[~~(Math.random()*a.length)]).possibilities=a}return n}(e,t),o=k(i,t,a);i.possibilities&&(o.randomInfo={possibilities:i.possibilities,level:t,maxedAt:a}),r.commander=o;var s=e.deck,l=r.deck;for(var c in s){var u=k(s[c],t,a);u&&l.push(u)}var d,h,f,p,g=function(e){for(var t=0,n=0;n<e.length;n++){var a=getCardByID(e[n]);t+=(_(a)+1)*a.maxLevel-1}return t}(l),m=(d=t,f=g,p=7==(h=a)?(d-1)/(h-1):d/h,Math.ceil(f*p));if(1<t&&t<a)for(var v=l.slice();0<m&&0<v.length;){var b=Math.floor(Math.random()*v.length);y(v[b])?m--:v.splice(b,1)}return r}return{mission:function(e,t){var n=MISSIONS[e];return n?o(n,t,6):0},raid:function(e,t,n){n||(n=25);var a=RAIDS[e];{if(a){var r={commander:a.commander,deck:a.deck.card};return o(r,t,Number(a.upgradeLevels))}return 0}}}}(),log=function(){function i(e){return e>Math.floor(e)&&(e=e.toFixed(1)),e}return{skill:function(e){var t=skillNameFromID(e.id);e.all&&(t+=" all");e.y&&(t+=" "+factions.names[e.y]);e.s&&(t+=" "+skillNameFromID(e.s));e.c?t+=" every "+e.c+" turns":e.x&&(t+=" "+e.x);return t},name:function(e,t){if("cpu"===e.owner)var n="i";else var n="b";var a="<"+n+">";a+=e.name,e.runes.length&&(a+="*");1<e.maxLevel&&(a+="{"+e.level+"/"+e.maxLevel+"}");void 0!==e.key&&(a+=" ("+e.key+")");if(a+="</"+n+">",!t){if(a+="<u>",e.isCommander())a+=" [",void 0!==e.health_left?a+=i(e.health_left):a+=e.health,a+=" HP]";else if(e.isAssault()){a+=" [";var r=e.adjustedAttack();(isNaN(r)||null==r)&&(r=e.attack),a+=r,a+="/",void 0!==e.health_left?a+=i(e.health_left):a+=e.health,a+="/",void 0!==e.timer?a+=e.timer:a+=e.cost,a+="]"}a+="</u>"}return a}}}();function parseInt(e){return e>>0}window.loadCardCache=function(){var e=storageAPI.getField("GameData","CardCache");if(e&&e.lastUpdated>DataUpdated)e.newCards&&($.extend(CARDS,e.newCards),$.extend(FUSIONS,e.newFusions)),DataUpdated=e.lastUpdated;else{var t={newCards:{},newFusions:{},lastUpdated:Date.now()};storageAPI.setField("GameData","CardCache",t)}},"function"!=typeof String.prototype.format&&(String.prototype.format=function(){var n=arguments;return this.replace(/{(\d+)}/g,function(e,t){return void 0!==n[t]?n[t]:e})}),"function"!=typeof Object.assign&&(Object.assign=function(e){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");e=Object(e);for(var t=1;t<arguments.length;t++){var n=arguments[t];if(null!=n)for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e});var curry=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(this,t.concat(Array.prototype.slice.call(arguments,0)))}};function _GET(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var a=t[n].split("=");if(decodeURIComponent(a[0])==e)return decodeURIComponent(a[1]?a[1]:"")}}function _DEFINED(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var a=t[n].split("=");if(decodeURIComponent(a[0])==e)return!0}return!1}Function.prototype.debounce=function(n){var a,r=this;return function(){var e=this,t=arguments;clearTimeout(a),a=setTimeout(function(){a=null,r.apply(e,t)},n)}},Function.prototype.throttle=function(e){var n,a=this;return function(){var e=this,t=arguments;n||(a.apply(e,t),n=setTimeout(function(){n=null,a.apply(e,t)},250))}};var matchTimer={elapsed:function(){var e=this.timeStop||Date.now();return this.elapsedSeconds(this.timeStart,e)},timeSince:function(e){return this.elapsedSeconds(e,Date.now())},elapsedSeconds:function(e,t){return((t-e)/1e3).toFixed(3)},batchElapsed:function(e){return this.timeSince(e||this.batchStarted)},startBatch:function(){this.batchStarted=Date.now()},stop:function(){this.timeStop=Date.now()},reset:function(){this.timeStart=Date.now(),this.timeStop=0}};function shuffle(e){var t,n,a,r=e.length;if(0==r)return!1;for(;--r;)t=~~(Math.random()*(r+1)),n=e[r],a=e[t],e[r]=a,e[t]=n}function initializeCard(e,t,n){e.owner=t,e.timer=e.cost,e.health_left=e.health,applyDefaultStatuses(e),e.key=n,e.reusableSkills||e.resetTimers()}function copy_deck(e){var t={};return t.commander=e.commander,t.deck=copy_card_list(e.deck),t}function getDeckCards(e,t){var n={};n.commander=getCardByID(e.commander),n.deck=[];for(var a=e.deck,r=SIMULATOR.battlegrounds.onCreate.filter(function(e){return!("player"===t&&e.enemy_only||"cpu"===t&&e.ally_only)}),i=0,o=a.length;i<o;i++)n.deck.push(get_card_apply_battlegrounds(a[i],r));return n}function copy_card_list(e){for(var t=[],n=0,a=e.length;n<a;n++)t[n]=e[n];return t}var CardPrototype,defaultStatusValues={attack_berserk:0,attack_valor:0,attack_rally:0,attack_weaken:0,attack_corroded:0,corrosion_timer:0,mark_target:0,barrier_ice:0,corroded:0,enfeebled:0,enraged:0,envenomed:0,heartseeker:0,imbued:0,invisible:0,nullified:0,poisoned:0,protected:0,scorched:0,warded:0,jammed:!1,jammedSelf:!1,silenced:!1,valor_triggered:!1,dualstrike_triggered:!1,ondeath_triggered:!1,reanimated:!1};function applyDefaultStatuses(e){for(var t in e.removeImbue(),e.enhanced={},defaultStatusValues)e[t]=defaultStatusValues[t]}var makeUnit=function(){function v(e,t){return getCardByID({id:e.id,level:e.level})[t]}function b(e,t,n){for(var a in t){var r=t[a];r.x&&((r=copy_skill(r)).x+=Math.ceil(r.x*n),r.boosted=!0,t[a]=r,e.highlighted.push(r.id))}}for(var e in CardPrototype={p:null,health_left:0,timer:0,key:void 0,isCommander:function(){return"1"==this.card_type},isAssault:function(){return"2"==this.card_type},isTrap:function(){return"3"==this.card_type},isAlive:function(){return 0<this.health_left},isDamaged:function(){return this.health_left<this.health},isActive:function(){return 0==this.timer},isActiveNextTurn:function(){return this.timer<=1},isInactive:function(){return 1<=this.timer},isUnjammed:function(){return!this.jammed},isUnsilenced:function(){return!this.silenced},imbue:function(e){this.imbued||(this.imbued={});var t,n=this.imbued,a=e.id;switch(SKILL_DATA[a].type){case"toggle":return this[a]=!0,void(this.imbued[a]=1);case"passive":return this[a]+=parseInt(e.x),void(this.imbued[a]=(this.imbued[a]||0)+e.x);case"flurry":return void(this.flurry||(this.flurry=e,this.flurry.countdown=0,this.imbued.flurry=!0));case"onDeath":t="onDeathSkills";break;case"earlyActivation":t="earlyActivationSkills";break;case"activation":default:t="skill"}if(void 0===n[t]){var r=this[t];n[t]=r.length,this[t]=r.slice()}this[t].push(e)},scorch:function(e){var t=this.scorched;t?(t.amount+=e,t.timer=2):this.scorched={amount:e,timer:2}},removeImbue:function(){var e=this.imbued;if(e){for(var t in e){var n=e[t];"skill"===t||"earlyActivationSkills"===t||"onDeathSkills"===t?this[t]=this[t].slice(0,n):this[t]-=n}this.imbued=0}},hasSkill:function(e,t){var n;switch(SKILL_DATA[e].type){case"toggle":case"passive":case"flurry":return this[e];case"onDeath":n=this.onDeathSkills;break;case"earlyActivation":n=this.earlyActivationSkills;break;case"activation":default:n=this.skill}for(var a in n){var r=n[a];if(r.id===e&&(void 0===t||(r.all||0)==t))return!0}return!1},hasAttack:function(){return 0<this.adjustedAttack()},attackPlusBuffs:function(){return this.attack+this.attack_rally+this.attack_berserk+this.attack_valor},adjustedAttack:function(){return this.attack+this.attack_rally+this.attack_berserk+this.attack_valor-this.attack_weaken-this.attack_corroded},permanentAttack:function(){return this.attack+this.attack_berserk+this.attack_valor},isInFaction:function(e){if(void 0===e)return 1;var t=e.split(",");if(t.length<=1)return this.type==e?1:0<=this.sub_type.indexOf(e.toString())?1:0;for(var n=0;n<t.length;n++)if(!this.isInFaction(t[n]))return 0;return 1},resetTimers:function(){for(var e=0,t=this.skillTimers.length;e<t;e++)this.skillTimers[e].countdown=0},addRunes:function(e){addRunes(this,e)}},SKILL_DATA){var t=SKILL_DATA[e].type;"passive"===t?CardPrototype[e]=0:"toggle"===t&&(CardPrototype[e]=!1)}return applyDefaultStatuses(CardPrototype),function(e,t,n,a,r,i){t||(t=1);var o=Object.create(CardPrototype);o.id=e.id,o.name=e.name,o.attack=e.attack,o.health=e.health,o.maxLevel=e.maxLevel,o.level=t>o.maxLevel?o.maxLevel:t,o.cost=e.cost,o.rarity=e.rarity,o.card_type=e.card_type,o.type=e.type,o.sub_type=e.sub_type||[],o.set=e.set;var s,l=e.skill;if(1<o.level)for(var c in e.upgrades)if(void 0!==(s=e.upgrades[c]).cost&&(o.cost=s.cost),void 0!==s.health&&(o.health=s.health),void 0!==s.attack&&(o.attack=s.attack),void 0!==s.desc&&(o.desc=s.desc),0<s.skill.length&&(l=s.skill),c==o.level)break;if(l=l.slice(),a&&a.length&&function(t,e,n,a){t.highlighted=[];for(var r=0;r<n.length;r++){var i=n[r];if("statChange"==i.modifierType&&!a)for(var o=0;o<i.effects.length;o++){var s=i.effects[o];t.isInFaction(s.y)&&Object.keys(s).forEach(function(e){t[e]=s[e]})}}}(o,0,a,i),n){o.addRunes(n);var u=1;a&&a.forEach(function(e){"runeMultiplier"==e.modifierType&&e.effects.forEach(function(e){o.isInFaction(e.y)&&(u=parseInt(e.mult))})}),addRunesToSkills(l,n,u)}else o.runes=[];return a&&a.length&&function(e,t,n,a){e.highlighted=[];for(var r=0;r<n.length;r++){var i=n[r];if("evolve_skill"===i.modifierType)for(var o=0;o<i.effects.length;o++){var s=i.effects[o];for(var l in t){var c=t[l];c.id==s.id&&c.all==s.all&&((c=copy_skill(c)).id=s.s,c.boosted=!0,t[l]=c,e.highlighted.push(c.id))}}else if("add_skill"===i.modifierType)for(o=0;o<i.effects.length;o++){var u=i.effects[o];if(e.isInFaction(u.y)){if(u.rarity&&e.rarity!=u.rarity)continue;var d={};if(d.id=u.id,d.x=u.x||0,u.mult)if(u.base){var h=v(e,u.base);d.x+=Math.ceil(u.mult*h)}else d.mult=u.mult;if(d.z=u.z,d.c=u.c,d.s=u.s,d.all=u.all,u.card&&(d.card=u.card),u.level&&(d.level=u.level),d.boosted=!0,u.mult&&u.base&&0==d.x)continue;t.push(d),e.highlighted.push(d.id)}}else if("scale_attributes"!==i.modifierType||a){if("scale_stat"===i.modifierType&&!a)for(o=0;o<i.effects.length;o++)f=i.effects[o],e.isInFaction(f.y)&&(e[i.scaledStat]+=Math.ceil(v(e,f.base)*f.mult))}else for(var o=0;o<i.effects.length;o++){var f=i.effects[o];if(e.isInFaction(f.y)){var p=f.mult,g=Math.ceil(e.attack*p);e.attack+=g;var m=Math.ceil(e.health*p);e.health+=m,b(e,t,p)}}}}(o,l,a,i),r&&b(o,l,r),copy_skills_2(o,l),o}}(),getEnhancement=function(e,t,n){var a=e.enhanced,r=a&&a[t]||0;return r<0&&(r=Math.ceil(n*-r)),r},isImbued=function(e,t,n){var a;switch(SKILL_DATA[t].type){case"flurry":case"toggle":return e.imbued[t];case"passive":return e[t]===e.imbued[t];case"onDeath":a="onDeathSkills";break;case"earlyActivation":a="earlyActivationSkills";break;case"activation":default:a="skill"}return void 0!==e.imbued[a]&&n>=e.imbued[a]},addRunes=function(e,t){e.runes||(e.runes=[]);for(var n=0,a=t.length;n<a;n++){var r=t[n].id,i=getRune(r).stat_boost;for(var o in e.runes.push({id:r,stat_boost:i}),i){var s=i[o];"skill"==o||(isNaN(s)&&(s=Math.max(Math.ceil(e[o]*s.mult),s.min_bonus||1)),e[o]+=parseInt(s))}}};function addRunesToSkills(e,t,n){if(t)for(var a=0,r=t.length;a<r;a++){var i=t[a].id,o=RUNES[i].stat_boost;for(var s in o){var l=o[s];if("skill"==s)for(var c=l.id,u=l.x,d=l.mult,h=0;h<e.length;h++){var f=e[h];if(f.id==c&&(f.all||0)==(l.all||0)){f=copy_skill(f),!u&&d&&(u=Math.ceil(f.x*d)),l.min_bonus&&(u=Math.max(u,l.min_bonus)),u&&(f.x+=parseInt(u)*n),l.c&&(f.c-=Math.min(f.c,parseInt(l.c)*n)),f.boosted=!0,e[h]=f;break}}}}}var getRune=function(e){return RUNES[e]},canUseRune=function(e,t){var n=getRune(t),a=n.stat_boost;if(n.faction_req&&!e.isInFaction(n.faction_req))return!1;for(var r in a)if("skill"==r){var i=a[r],o=i.all?1:0;if(!e.hasSkill(i.id,o))return!1}return!0};function MakeSkillModifier(e,t){return{name:e,modifierType:t.effect_type,effects:[t]}}function MakeStatScalar(e,t){return{name:e,modifierType:"scale_stat",scaledStat:t.effect_type.replace("scale_",""),effects:[t]}}var MakeOnPlayBGE=function(){var n=function(e,t){this.p=null,this.name=e,this.effect=t,this.runes=[]};return n.prototype={onCardPlayed:function(e){SIMULATOR.onPlaySkills[this.effect.id](this,e,this.effect)},isCommander:function(){return!1},isAssault:function(){return!1}},function(e,t){return new n(e,t)}}(),MakeTrap=function(){var n=function(e,t){this.name=e,this.id=t.id,this.base=t.base,this.mult=t.mult,this.target_deck=t.target_deck,this.y=t.y};return n.prototype={onCardPlayed:function(e,t,n){var a="opponent"===this.target_deck?n:t;if(e.isInFaction(this.y)){for(var r=[],i=0;i<a.length;i++){(e=a[i]).trap||r.push(e)}if(r.length){var o=Math.ceil(e[this.base]*this.mult),s=getCardByID(makeUnitInfo(this.id,o));r[~~(Math.random()*r.length)].trap=s,debug&&(echo+=this.name+" inserts "+debug_name(s)+" into the opposing deck.<br/>")}}}},function(e,t){return new n(e,t)}}(),getBattlegrounds=function(e,t,n,a,r,i,o,s){var l={onCreate:[],onTurn:[],onCardPlayed:[]};return addBgesFromList(l,e),addBgesFromList(l,t,"player"),addBgesFromList(l,n,"cpu"),addMapBGEs(l,a,"player"),r?addMissionBGE(l,r,i):o&&addRaidBGE(l,o,s),l};function addBgesFromList(e,t,n){if(!t)return null;for(var a=t.split(","),r=0;r<a.length;r++){var i=a[r];addBgeFromList(e,BATTLEGROUNDS[i],n)}}function addMissionBGE(e,t,n){var a=CAMPAIGNS[t];if(a){var r=a.battleground_id;if(r){var i=BATTLEGROUNDS[r];if(n=Number(n)-1,!i.starting_level||Number(i.starting_level)<=n){if(i.scale_with_level){i=JSON.parse(JSON.stringify(i));for(var o=n-Number(i.starting_level),s=0;s<i.effect.length;s++){var l=i.effect[s];l.mult=l.base_mult+l.mult*o}}addBgeFromList(e,i,"cpu")}}}}function addRaidBGE(e,t,n){var a=RAIDS[t].bge;if(a){var r=BATTLEGROUNDS[a];if(r&&Number(n)>=Number(r.starting_level))for(var i=r.enemy_only,o=0;o<r.effect.length;o++){var s=r.effect[o],l=s.effect_type;if("skill"===l){if(r.scale_with_level)var c=r.scale_with_level*(n-r.starting_level+1);else c=1;(u=MakeBattleground(r.name,s,c)).enemy_only=i,e.onTurn.push(u)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(effect_Type)){(u=MakeSkillModifier(r.name,s)).enemy_only=i,e.onCreate.push(u)}else if(0<=["scale_attack","scale_health"].indexOf(effect_Type)){(u=MakeStatScalar(r.name,s)).enemy_only=i,e.onCreate.push(u)}else if("trap_card"===l){var u;(u=MakeTrap(r.name,s)).enemy_only=i,e.onCardPlayed.push(u)}}}}function addMapBGEs(e,t,n){if(!t)return null;for(var a=t.split(","),r=0;r<a.length;r++){var i=a[r].split("-"),o=i[0],s=i[1],l=i[2],c=Object.keys(MAP_BATTLEGROUNDS).filter(function(e){return MAP_BATTLEGROUNDS[e].location_id==o})[0];addBgeFromList(e,(c=MAP_BATTLEGROUNDS[c]).effects[s].upgrades[l],n)}}function addBgeFromList(e,t,n){for(var a=0;a<t.effect.length;a++){var r=t.effect[a],i=r.effect_type;if("skill"===i){var o=MakeBattleground(t.name,r);"player"===n&&(o.ally_only=!0),"cpu"===n&&(o.enemy_only=!0),e.onTurn.push(o)}else if(0<=["evolve_skill","add_skill","scale_attributes","statChange","runeMultiplier"].indexOf(i)){o=MakeSkillModifier(t.name,r);"player"===n&&(o.ally_only=!0),"cpu"===n&&(o.enemy_only=!0),e.onCreate.push(o)}else if(0<=["scale_attack","scale_health"].indexOf(i)){o=MakeStatScalar(t.name,r);"player"===n&&(o.ally_only=!0),"cpu"===n&&(o.enemy_only=!0),e.onCreate.push(o)}else if("trap_card"===i){o=MakeTrap(t.name,r);"player"===n&&(o.ally_only=!0),"cpu"===n&&(o.enemy_only=!0),e.onCardPlayed.push(o)}else if("on_play"===i){(o=MakeOnPlayBGE(t.name,r.effect)).attacker=r.attacker,o.defender=r.defender,o.first_play=r.first_play,"player"===n&&(o.ally_only=!0),"cpu"===n&&(o.enemy_only=!0),e.onCardPlayed.push(o)}}}var reverseFusions,MakeBattleground=function(){var a=function(e,t,n){this.name=e,copy_skills_2(this,[t],n)};return a.prototype={p:null,name:null,runes:[],isCommander:function(){return!1},isAssault:function(){return!1},resetTimers:function(){for(var e=0,t=this.skillTimers.length;e<t;e++)this.skillTimers[e].countdown=0}},function(e,t,n){return new a(e,t,n)}}();function copy_skills_2(e,t,n){e.skill=[],e.earlyActivationSkills=[],e.onDeathSkills=[];var a=[],r=!0;for(var i in t){var o=t[i];if(o.c)setSkill_2(e,s=copy_skill(o)),a.push(s),r=!1;else if(n){var s;(s=copy_skill(o)).x=Math.ceil(s.x*n),setSkill_2(e,s)}else setSkill_2(e,o)}e.reusableSkills=r,e.skillTimers=a}function setSkill_2(e,t){var n=t.id;switch(SKILL_DATA[n].type){case"toggle":return void(e[n]=!0);case"passive":e[t.id]=(0|e[t.id])+t.x;break;case"flurry":e[t.id]=t;break;case"onDeath":e.onDeathSkills.push(t);break;case"earlyActivation":e.earlyActivationSkills.push(t);break;case"activation":default:e.skill.push(t)}}function copy_skills(e,t,n,a){e.skill=[],e.earlyActivationSkills=[],e.onDeathSkills=[],e.skillTimers||(e.skillTimers=[]),copy_Skill_lists(e,e.skill,t),copy_Skill_lists(e,e.earlyActivationSkills,n),copy_Skill_lists(e,e.onDeathSkills,a)}function copy_Skill_lists(e,t,n){for(var a=0;a<n.length;a++){var r=n[a];if(r.c){var i=copy_skill(r);t.push(i),e.skillTimers.push(i)}else t.push(r)}}function copy_skill(e){var t={};return t.id=e.id,t.x=e.x,t.mult=e.mult,t.on_delay_mult=e.on_delay_mult,t.all=e.all,t.y=e.y,t.z=e.z,t.c=e.c,t.s=e.s,t}function skillNameFromID(e){var t=SKILL_DATA[e];return t?t.name:e}function areEqual(e,t){return!e==!t&&base64.fromUnitInfo(e)===base64.fromUnitInfo(t)}function getDefaultDeck(){return{commander:elariaCaptain,deck:[]}}function getFusion(e){var t=0;for(reverseFusions||getReverseFusions();t++,reverseFusions[e];);return t}function getReverseFusions(){for(var e in reverseFusions={},FUSIONS)reverseFusions[FUSIONS[e]]=e}var get_card_apply_battlegrounds=function(e,t,n){return getCardByID(e,t=t||SIMULATOR.battlegrounds.onCreate,null,n)};function get_skills(e,t){var n,a=loadCard(e),r=a.skill;if(1<t)for(var i in a.upgrades)if(0<(n=a.upgrades[i]).skill.length&&(r=n.skill),i==t)break;return r}function getCardByID(e,t,n,a){var r=loadCard(e.id);if(r){r.skill||(r.skill=[]);var i=makeUnit(r,e.level,e.runes,t,n,a);return e.priority&&(i.priority=e.priority),i}return console.log(e.id+" not found"),(r={}).id=e.id,r.level=e.level,r.name=void 0,r.health=void 0,r.skill=[],r}function get_slim_card_by_id(e,t){var n=loadCard(e.id),a={};if("1"==n.card_type?(a.isCommander=function(){return!0},a.isAssault=function(){return!1}):(a.isCommander=function(){return!1},a.isAssault=function(){return!0}),n){if(a.id=n.id,a.name=n.name,a.rarity=n.rarity,a.maxLevel=n.maxLevel,e.level?(a.level=e.level,a.level>a.maxLevel&&(a.level=a.maxLevel)):a.level=1,t){if(a.attack=n.attack,a.health=n.health,a.cost=n.cost,a.set=n.set,a.card_type=n.card_type,a.type=n.type,a.sub_type=n.sub_type||[],a.skill=n.skill,1<a.level)for(var r in n.upgrades){var i=n.upgrades[r];if(void 0!==i.cost&&(a.cost=i.cost),void 0!==i.health&&(a.health=i.health),void 0!==i.attack&&(a.attack=i.attack),void 0!==i.desc&&(a.desc=i.desc),0<i.skill.length&&(a.skill=i.skill),r==a.level)break}var o=e.runes;o&&(a.skill=a.skill.slice(),addRunes(a,o),addRunesToSkills(a.skill,o))}}else a.id=void 0,a.name=void 0,a.card_type=void 0,a.set=void 0,a.type=void 0,a.sub_type=[],a.level=void 0,a.maxLevel=void 0,t&&(a.skill=[]);return a}function loadCard(e){return CARDS[e]}function getCardInfo(e){var t=e.id,n=e.level,a=CARDS[t],r=Object.assign({},a);if(1<n&&1<n)for(var i in a.upgrades){var o=a.upgrades[i];if(void 0!==o.cost&&(r.cost=o.cost),void 0!==o.health&&(r.health=o.health),void 0!==o.attack&&(r.attack=o.attack),void 0!==o.desc&&(r.desc=o.desc),0<o.skill.length&&(r.skill=o.skill),i==n)break}return r.level=n,r.maxLevel=a.maxLevel,r}function get_card_name_by_id(e){var t=loadCard(e);return t?t.name:0}function is_commander(e){var t=loadCard(e);return t&&"1"==t.card_type}function is_assault(e){var t=loadCard(e);return t&&"2"==t.card_type}function is_trap(e){var t=loadCard(e);return t&&"3"==t.card_type}var makeUnitKey=function(e){var t=e.id+"_"+e.level;return e.runes&&e.runes.length&&(t+="_"+e.runes[0].id),t};function makeUnitInfo(e,t,n){var a={id:Number(e),level:Number(t),runes:[]};return n&&(a.runes=n),a}var elariaCaptain=makeUnitInfo(202,1);function getRarity(e){return rarityStrings[e]}function getCurrentPage(){var e=window.location.href,t=e.indexOf(".html"),n=(e=e.substring(0,t)).lastIndexOf("/")+1;return e=e.substring(n).toLowerCase()}var rarityStrings=["","Common","Rare","Epic","Legendary","Mythic"],factions={names:{0:"Factionless",1:"Aether",2:"Chaos",3:"Wyld",4:"Frog",5:"Elemental",6:"Angel",7:"Undead",8:"Void",9:"Dragon",10:"Avian",11:"Goblin",12:"Seafolk",13:"Insect",14:"Bear",15:"Token",16:"Mecha",17:"Knight",999:"Tower"},IDs:{Factionless:0,Aether:1,Chaos:2,Wyld:3,Frog:4,Elemental:5,Angel:6,Undead:7,Void:8,Dragon:9,Avian:10,Goblin:11,Seafolk:12,Insect:13,Bear:14,Token:15,Mecha:16,Knight:17,Tower:999}},SIM_CONTROLLER={getConfiguration:function(){getdeck=$("#deck1").val(),getordered=$("#ordered").is(":checked"),getexactorder=$("#exactorder").is(":checked"),getdeck2=$("#deck2").val(),getcampaign=$("#campaign").val(),getmission=$("#mission").val(),missionlevel=$("#mission_level").val(),getraid=$("#raid").val(),raidlevel=$("#raid_level").val(),getordered2=$("#ordered2").is(":checked"),getexactorder2=$("#exactorder2").is(":checked"),surge=$("#surge").is(":checked"),getsiege=$("#siege").is(":checked"),tower_level=$("#tower_level").val(),tower_type=$("#tower_type").val(),BATTLEGROUNDS&&(getbattleground=getSelectedBattlegrounds(),selfbges=getSelectedBattlegrounds("self-"),enemybges=getSelectedBattlegrounds("enemy-"),mapbges=getmission?getSelectedMapBattlegrounds():""),sims_left=$("#sims").val()||1,debug=$("#debug").is(":checked"),(play_debug=debug&&$("#play_debug").is(":checked"))&&(debug=!1),mass_debug=$("#mass_debug").is(":checked"),win_debug=$("#win_debug").is(":checked"),loss_debug=$("#loss_debug").is(":checked"),showAnimations=$("#animations").is(":checked"),$("#auto_mode").length&&(auto_mode=$("#auto_mode").is(":checked"),SIMULATOR.user_controlled=!auto_mode),tournament=$("#tournament").is(":checked")},debug_end:function(e){var t;e=SIM_CONTROLLER.processSimResult(),sims_left=0,matchTimer.stop();var n="";getdeck2&&(n=" ("+SIMULATOR.calculatePoints()+" points)"),t="draw"==e?"<br><h1>DRAW"+n+"</h1><br>":e?"<br><h1>WIN"+n+"</h1><br>":"<br><h1>LOSS"+n+"</h1><br>",echo&&outputTurns(echo),setSimStatus(t),showUI(),SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(SIMULATOR.simulation_turns),SIM_CONTROLLER.end_sims_callback&&SIM_CONTROLLER.end_sims_callback()},end_sims_callback:null,stop_sims_callback:null};!function(){function o(){if(SIMULATOR.user_controlled)s(!0)&&SIM_CONTROLLER.debug_end();else if(!debug&&!play_debug||mass_debug||loss_debug||win_debug)if(0<sims_left){if(c<=l){var e=0;if(0<c){l=0;var t=games/(games+sims_left)*100;t=t.toFixed(2);var n=matchTimer.elapsed(),a=matchTimer.batchElapsed();setSimStatus("Running simulations...",n,(e=0==a?0:c/a).toFixed(1)),showWinrate()}(c=1)<e&&(c=Math.ceil(e/8)),sims_left<c&&(c=sims_left),(debug||play_debug)&&(mass_debug||loss_debug||win_debug)&&(c=1),matchTimer.startBatch(),current_timeout=setTimeout(o,1);for(var r=0;r<c;r++)s()}}else{c=l=0,matchTimer.stop();n=matchTimer.elapsed();var i=games/n;i=i.toFixed(2),echo&&outp(echo),setSimStatus("Simulations complete.",n,i),showWinrate(),showUI(),SIM_CONTROLLER.end_sims_callback&&SIM_CONTROLLER.end_sims_callback()}else s(!0),SIM_CONTROLLER.debug_end()}SIM_CONTROLLER.startsim=function(){return total_turns=0,matchTimer.reset(),echo="",c=games=0,SIM_CONTROLLER.getConfiguration(),SIMULATOR.battlegrounds=getBattlegrounds(getbattleground,selfbges,enemybges,mapbges,getcampaign,missionlevel,getraid,raidlevel),hideUI(),SIMULATOR.setupDecks(),points=draws=losses=wins=0,outp(""),SIMULATOR.user_controlled?setSimStatus(""):(hideTable(),setSimStatus("Initializing simulations...")),current_timeout=setTimeout(o),!1},SIM_CONTROLLER.stopsim=function(){matchTimer.stop();var e=matchTimer.elapsed(),t=games/e;t=t.toFixed(2),SIMULATOR.simulating=!1,current_timeout&&clearTimeout(current_timeout),SIMULATOR.user_controlled||(setSimStatus("Simulations interrupted.",e,t),showWinrate()),showUI(),SIM_CONTROLLER.stop_sims_callback&&SIM_CONTROLLER.stop_sims_callback()};var t=_GET("seedtest")||0;function s(e){if(t&&Math.seedrandom(t++),!SIMULATOR.simulate())return!1;e||SIM_CONTROLLER.processSimResult()}SIM_CONTROLLER.processSimResult=function(){var e;return e=!!SIMULATOR.field.player.commander.isAlive()&&(!SIMULATOR.field.cpu.commander.isAlive()||"draw"),0<c&&(0<sims_left&&sims_left--,l++),"draw"==e?draws++:e?wins++:losses++,points+=SIMULATOR.calculatePoints(),games++,total_turns+=SIMULATOR.simulation_turns,(debug||play_debug)&&(loss_debug?"draw"==e?(echo="Draw found after "+games+" games. Displaying debug output... <br><br>"+echo,echo+="<br><h1>DRAW</h1><br>",sims_left=0):e?sims_left?echo="":(echo="No losses found after "+games+" games. No debug output to display.<br><br>",sims_left=0):(echo="Loss found after "+games+" games. Displaying debug output... <br><br>"+echo,echo+="<br><h1>LOSS</h1><br>",sims_left=0):win_debug?e&&"draw"!=e?(echo="Win found after "+games+" games. Displaying debug output... <br><br>"+echo,echo+="<br><h1>WIN</h1><br>",sims_left=0):sims_left?echo="":(echo="No wins found after "+games+" games. No debug output to display.<br><br>",sims_left=0):mass_debug&&(echo+="draw"==e?"<br><h1>DRAW</h1><br>":e?"<br><h1>WIN</h1><br>":"<br><h1>LOSS</h1><br>"),mass_debug&&sims_left&&(echo+="<br><hr>NEW BATTLE BEGINS<hr><br>")),e};var l=0,c=0}();var SIMULATOR={};!function(){"use strict";function c(e,t,n,a){var r=H[t].assaults;if(!e.id)return 0;var i=r.length;if(initializeCard(e,t,i),e.played=!0,e.isAssault()&&(r[i]=e),!debug&&!play_debug||a||(echo+=log.name(H[t].commander)+" plays "+log.name(e)+"<br>"),e.isTrap())v(e),S(e);else for(var o=0;o<G.onCardPlayed.length;o++){var s=G.onCardPlayed[o],l="player"===t?"cpu":"player";if(s.defender){if(!surge&&"cpu"!=t)continue;if(surge&&"player"!=t)continue;s.owner=l}else if(s.attacker){if(!surge&&"player"!=t)continue;if(surge&&"cpu"!=t)continue;s.owner=t}else{if(s.enemy_only&&"cpu"!=t)continue;if(s.ally_only&&"player"!=t)continue;s.owner=t}1<n&&s.first_play||s.onCardPlayed(e,z[t].deck,z[l].deck)}showAnimations&&drawField(H,null,null,n)}function m(e){for(var t=H[e].assaults,n=0,a=t.length;n<a;n++){var r=t[n];if(!r.isAlive()){debug&&(echo+=log.name(r)+" <strong>is removed from field</strong><br>");var i=n;for(n++;n<a;n++)(r=t[n]).isAlive()?(t[r.key=i]=r,i++):debug&&(echo+=log.name(r)+" <strong>is removed from field</strong><br>");t.length=i;break}}}function b(e){return[e[~~(Math.random()*e.length)]]}function _(e){return e.owner}function k(e){return"cpu"==e.owner?"player":"player"==e.owner?"cpu":void 0}function T(e,t,n,a,r){n>=t.health_left?t.health_left=0:t.health_left-=n,debug&&r(e,t,n),a&&E(t),!t.isAlive()&&e&&L(t,e)}function E(e){var t=e.barrier_ice,n=k(e),a=H[n],r=a.assaults[e.key];r&&r.isAlive()||(r=a.commander),T(e,r,t,null,function(e,t,n){echo+=log.name(e)+"'s barrier shatters and hits "+log.name(t)+" for "+n+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}function u(e,t){return e[t]||n}function n(e,t){if(debug){var n=SKILL_DATA[t.id]?SKILL_DATA[t.id].name:t.id;echo+=log.name(e)+" attempts to use "+n+", but it is not implemented.<br>"}return 0}function v(e){var t=e.earlyActivationSkills,n=t.length;if(0!=n)if(e.silenced)debug&&(echo+=log.name(e)+" is silenced and cannot use skills</br>");else{var a=e.dualstrike_triggered;debug&&a&&(echo+=log.name(e)+" activates dualstrike<br>");for(var r=a?2:1,i=d(e),o=0;o<r;o++)for(var s=0;s<n&&i();s++){var l=t[s];if(!l.countdown){var c=u(h,l.id)(e,l);l.c&&0<c&&(l.countdown=l.c),showAnimations&&drawField(H,null,null,J,e)}}}}function t(){return!0}function d(e){return e.isAlive?e.isAlive.bind(e):t}function L(e,t){if(!e.ondeath_triggered){var n=e.onDeathSkills,a=n.length;if(0!=a){for(var r=0;r<a;r++){var i=n[r];o[i.id](e,t,i),showAnimations&&drawField(H,null,null,J,e)}e.ondeath_triggered=!0}}}var a=["backlash","counter","counterburn","counterpoison","armored","evade","stasis"];function y(e){return-1===a.indexOf(e)}function w(e,t){if(e.isAssault()&&t.isAlive()){var n=t.backlash;j(e,t,"Backlash",n,getEnhancement(t,"backlash",n))}}function x(e){return e.isActive()&&e.isUnjammed()?0:e.stasis||0}var s={burnself:function(e,t){var n=t.x;return e.scorched?(e.scorched.amount+=n,e.scorched.timer=2):e.scorched={amount:n,timer:2},debug&&(echo+=log.name(e)+" inflicts scorch("+n+") on itself<br>"),1},scorchbreath:function(e,t){return s.burn(e,t)},burn:function(e,t){var n,a=k(e),r=H[a].assaults;switch(t.id){case"scorchbreath":var i=Math.max(0,e.key-1),o=Math.min(r.length,e.key+2);n=r.slice(i,o);break;case"burnself":n=[e];break;default:n=r.slice(e.key,e.key+1)}if(!n.length)return 0;var s=t.x;s+=getEnhancement(e,"burn",s);for(var l=0,c=0;c<n.length;c++){var u=n[c];u.scorched?(u.scorched.amount+=s,u.scorched.timer=2):u.scorched={amount:s,timer:2},debug&&(echo+=log.name(e)+" inflicts scorch("+s+") on "+log.name(u)+"<br>"),l++}return l},protect_ice:function(e,t){return s.protect(e,t,"barrier_ice")},protect_seafolk:function(e,t){return s.protect(e,t,null,null,!0)},evadebarrier:function(e,t){return s.protect(e,t,"invisible",function(e,t){return" and imbues it with invisible "+t})},protect:function(e,t,n,a,r){for(var i=t.y,o=_(e),s=t.x,l=t.all,c=H[o].assaults,u=[],d=0,h=c.length;d<h;d++){!(g=c[d]).isAlive()||!g.isInFaction(i)||r&&g.isActive()||u.push(d)}if(!u.length)return 0;l||(u=b(u));var f=getEnhancement(e,t.id,s);s+=f;var p=0;for(d=0,h=u.length;d<h;d++){var g;if((g=c[u[d]]).nullified)g.nullified--,debug&&(echo+=log.name(e)+" protects "+log.name(g)+" but it is nullified!<br>");else{p++;var m=s;if(!m){var v=t.mult;g.isActive()||(v+=t.on_delay_mult||0),m=Math.ceil(g.health*v)}g.protected+=m,n&&(g[n]=(g[n]||0)+m),debug&&(f&&(echo+="<u>(Enhance: +"+f+")</u><br>"),echo+=log.name(e)+" barriers "+log.name(g)+" by "+m,"function"==typeof a&&(echo+=a(g,m)),echo+="<br>")}}return p},heal:function(e,t){for(var n=_(e),a=t.y,r=t.x,i=t.all,o=H[n].assaults,s=[],l=0,c=o.length;l<c;l++){(h=o[l]).isAlive()&&h.isInFaction(a)&&(i||h.isDamaged())&&s.push(l)}if(!s.length)return 0;i||(s=b(s));var u=getEnhancement(e,t.id,r);r+=u;var d=0;for(l=0,c=s.length;l<c;l++){var h;if((h=o[s[l]]).nullified)h.nullified--,debug&&(echo+=log.name(e)+" heals "+log.name(h)+" but it is nullified!<br>");else{d++;var f=r;if(!f){var p=t.mult;f=Math.ceil(h.health*p)}f>h.health-h.health_left&&(f=h.health-h.health_left),h.health_left+=f,debug&&(u&&(echo+="<u>(Enhance: +"+u+")</u><br>"),echo+=log.name(e)+" heals "+log.name(h)+" by "+f+"<br>")}}return d},poisonstrike:function(e,t,n){return s.strike(e,t,!0)},strike:function(e,a,t){for(var n=k(e),r=a.x,i=a.y,o=a.all,s=H[n].assaults,l=[],c=0,u=s.length;c<u;c++){(f=s[c]).isAlive()&&f.isInFaction(i)&&l.push(c)}if(!l.length)return 0;o||(l=b(l));var d=getEnhancement(e,a.id,r);r+=d;var h=0;for(c=0,u=l.length;c<u;c++){var f;if((f=s[l[c]]).invisible)f.invisible--,debug&&(echo+=log.name(e)+" bolts "+log.name(f)+" but it is invisible!<br>");else{h++;var p=r,g=$(f,p);p=g.damage;var m=g.shatter,v=0;0<p&&t&&f.isAlive()&&r>f.poisoned&&(v=r,f.poisoned=v),T(e,f,p,m,function(e,t,n){echo+="<u>(Strike: +"+a.x,d&&(echo+=" Enhance: +"+d),echo+=g.echo,echo+=") = "+n+" damage</u><br>",echo+=log.name(e)+" bolts "+log.name(t)+" for "+n+" damage",t.isAlive()?v&&(echo+=" and inflicts poison("+v+") on it"):echo+=" and it dies",echo+="<br>"}),f.backlash&&w(e,f)}}return h},intensify:function(e,t,n){for(var a=k(e),r=t.x,i=t.y,o=t.all,s=H[a].assaults,l=[],c=0,u=s.length;c<u;c++){(h=s[c]).isAlive()&&h.isInFaction(i)&&(h.scorched||h.poisoned)&&l.push(c)}if(!l.length)return 0;o||(l=b(l)),r+=getEnhancement(e,t.id,r);var d=0;for(c=0,u=l.length;c<u;c++){var h,f=(h=s[l[c]]).scorched?"scorch":"";f+=h.poisoned?f?" and poison":"poison":"",h.invisible?(h.invisible--,debug&&(echo+=log.name(e)+" intensifies "+f+" on "+log.name(h)+" but it is invisible!<br>")):(d++,h.scorched&&(h.scorched.amount+=r),h.poisoned&&(h.poisoned+=r),debug&&(echo+=log.name(e)+" intensifies "+f+" on "+log.name(h)+" by "+r+"<br>"),h.backlash&&w(e,h))}return d},ignite:function(e,t,n){for(var a=k(e),r=t.x,i=t.y,o=t.all,s=H[a].assaults,l=[],c=0,u=s.length;c<u;c++){(h=s[c]).isAlive()&&h.isInFaction(i)&&l.push(c)}if(!l.length)return 0;o||(l=b(l)),r+=getEnhancement(e,t.id,r);var d=0;for(c=0,u=l.length;c<u;c++){var h;(h=s[l[c]]).invisible?(h.invisible--,debug&&(echo+=log.name(e)+" ignites "+log.name(h)+" but it is invisible!<br>")):(d++,h.scorch(r),debug&&(echo+=log.name(e)+" ignites("+r+") "+log.name(h)+"<br>"),h.backlash&&w(e,h))}return d},jamself:function(e,t){return e.jammed=!0,e.jammedSelf=!0,debug&&(echo+=log.name(e)+" freezes itself<br>"),1},jam:function(e,t){_(e);for(var n=k(e),a=t.all,r=H[n].assaults,i=[],o=0,s=r.length;o<s;o++){(c=r[o]).isAlive()&&(a||c.isActiveNextTurn()&&c.isUnjammed())&&i.push(o)}if(!i.length)return 0;a||(i=b(i));var l=0;for(o=0,s=i.length;o<s;o++){var c;(c=r[i[o]]).invisible?(c.invisible--,t.countdown=0,debug&&(echo+=log.name(e)+" freezes "+log.name(c)+" but it is invisible!<br>")):(l++,c.jammed=!0,debug&&(echo+=log.name(e)+" freezes "+log.name(c)+"<br>"),c.backlash&&w(e,c))}return l},frost:function(e,a){_(e);var t=k(e),n=a.x,r=getEnhancement(e,a.id,n);n+=r;a.all;for(var i=H[t].assaults,o=[],s=e.key-1,l=s+2;s<=l;s++){(h=i[s])&&h.isAlive()&&o.push(s)}if(!o.length)return 0;for(var c=0,u=0,d=o.length;u<d;u++){var h;if((h=i[o[u]]).invisible)h.invisible--,debug&&(echo+=log.name(e)+" breathes frost at "+log.name(h)+" but it is invisible!<br>");else{c++;var f=n,p=$(h,f);T(e,h,f=p.damage,p.shatter,function(e,t,n){echo+="<u>(Frostbreath: +"+a.x,r&&(echo+=" Enhance: +"+r),echo+=p.echo,echo+=") = "+n+" damage</u><br>",echo+=log.name(e)+" breathes frost at "+log.name(t)+" for "+n+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"}),h.backlash&&w(e,h)}}return c},heartseeker:function(e,t){t.y;var n=k(e),a=t.x,r=H[n].assaults[e.key];return r?(a+=getEnhancement(e,t.id,a),r.heartseeker+=a,r.enfeebled+=a,debug&&(echo+=log.name(e)+" inflicts heartseeker "+a+" on "+log.name(r)+"<br>"),1):0},enfeeble:function(e,t){for(var n=t.y,a=(_(e),k(e)),r=t.x,i=t.all,o=H[a].assaults,s=[],l=0,c=o.length;l<c;l++){(d=o[l]).isAlive()&&d.isInFaction(n)&&s.push(l)}if(!s.length)return 0;i||(s=b(s)),r+=getEnhancement(e,t.id,r);var u=0;for(l=0,c=s.length;l<c;l++){var d;(d=o[s[l]]).invisible?(d.invisible--,debug&&(echo+=log.name(e)+" hexes "+log.name(d)+" but it is invisible!<br>")):(u++,d.enfeebled+=r,debug&&(echo+=log.name(e)+" hexes "+log.name(d)+" by "+r+"<br>"),d.backlash&&w(e,d))}return u},weakenself:function(e,t){return s.weaken(e,t)},weaken:function(e,t){var n,r=t.y;switch(t.id){case"weakenself":n=_(e);break;default:n=k(e)}var a=t.x,i=t.all,o=H[n].assaults,s=[],l=function(e){for(var t=0,n=o.length;t<n;t++){var a=o[t];a.isAlive()&&a.isInFaction(r)&&(i||a.isActiveNextTurn()&&a.isUnjammed()&&(e||a.hasAttack()))&&s.push(t)}};if(l(!1),s.length||l(!0),!s.length)return 0;i||(s=b(s));var c=getEnhancement(e,t.id,a);a+=c;for(var u=0,d=0,h=s.length;d<h;d++){var f=o[s[d]];f.invisible?(f.invisible--,debug&&(echo+=log.name(e)+" weakens "+log.name(f)+" but it is invisible!<br>")):(u++,f.attack_weaken+=a,debug&&(c&&(echo+="<u>(Enhance: +"+c+")</u><br>"),echo+=log.name(e)+" weakens "+log.name(f)+" by "+a+"<br>"),f.backlash&&w(e,f))}return u}},h={enlarge:function(e,t){var n=t.y,a=_(e),r=t.x,i=getEnhancement(e,t.id,r);r+=i;for(var o=t.all,s=H[a].assaults,l=[],c=0,u=s.length;c<u;c++){(h=s[c]).isAlive()&&h.isInFaction(n)&&(o||h.isUnjammed()&&h.isActive())&&l.push(c)}if(!l.length)return 0;o||(l=b(l));var d=0;for(c=0,u=l.length;c<u;c++){var h=s[l[c]],f=r;if(!f){var p=t.mult;f=Math.ceil(h.attack*p)}h.attack_rally+=f,debug&&(i&&(echo+="<u>(Enhance: +"+i+")</u><br>"),echo+=log.name(e)+" enlarges "+log.name(h)+" by "+f+"<br>"),d++}return d},rally:function(e,t){for(var n=t.y,a=_(e),r=t.x,i=t.all,o=H[a].assaults,s=[],l=0,c=o.length;l<c;l++){(h=o[l]).isAlive()&&h.isInFaction(n)&&(i||h.isActive()&&h.isUnjammed())&&s.push(l)}if(!s.length)return 0;i||(s=b(s));var u=getEnhancement(e,t.id,r);r+=u;var d=0;for(l=0,c=s.length;l<c;l++){var h;if((h=o[s[l]]).nullified)h.nullified--,debug&&(echo+=log.name(e)+" empowers "+log.name(h)+" but it is nullified!<br>");else{d++;var f=r;if(!f){var p=t.mult;f=Math.ceil(h.attack*p)}h.attack_rally+=f,debug&&(u&&(echo+="<u>(Enhance: +"+u+")</u><br>"),echo+=log.name(e)+" empowers "+log.name(h)+" by "+f+"<br>")}}return d},legion:function(e,t){var n=_(e),a=H[n].assaults,r=t.x,i=getEnhancement(e,t.id,r);r+=i;var o=t.y,s=e.key-1,l=s+2;s<0&&(s+=2);for(var c=0;s<=l;){var u=a[s];u&&u.isActive()&&u.isInFaction(o)&&(u.nullified?(u.nullified--,debug&&(echo+=log.name(e)+" activates legion and empowers "+log.name(u)+" but it is nullified!<br>")):(c++,u.attack_rally+=r,debug&&(i&&(echo+="<u>(Enhance: +"+i+")</u><br>"),echo+=log.name(e)+" activates legion and empowers "+log.name(u)+" by "+r+"<br>"))),s+=2}return c},fervor:function(e,t){var n=_(e),a=H[n].assaults,r=t.x,i=getEnhancement(e,t.id,r);r+=i;var o=t.y,s=0,l=e.key-1,c=l+2;for(l<0&&(l+=2);l<=c;){var u=a[l];u&&u.isInFaction(o)&&(s+=r),l+=2}return s?(e.attack_rally+=s,debug&&(i&&(echo+="<u>(Enhance: +"+i+")</u><br>"),echo+=log.name(e)+" activates fervor for "+s+"<br>"),1):0},barrage:function(e,t){var n=k(e),a=t.x,r=t.y,i=t.all,o=H[n].assaults;a+=getEnhancement(e,t.id,a);for(var s=0;s<a;s++){for(var l=[],c=0,u=o.length;c<u;c++){(h=o[c]).isAlive()&&h.isInFaction(r)&&l.push(c)}if(!l.length)return 0;i||(l=b(l));var d=0;for(c=0,u=l.length;c<u;c++){var h;if((h=o[l[c]]).invisible)h.invisible--,debug&&(echo+=log.name(e)+" throws a bomb at "+log.name(h)+" but it is invisible!<br>");else{d++;var f=1,p=$(h,f,{enfeeble:!0});T(e,h,f=p.damage,p.shatter,function(e,t,n){echo+="<u>(Barrage: +1",echo+=p.echo,echo+=") = "+n+" damage</u><br>",echo+=log.name(e)+" throws a bomb at "+log.name(t)+" for "+n+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}}}return d},enhance:function(e,t){for(var n=t.y,a=_(e),r=(k(e),t.x),i=(n=t.y,t.s),o=t.mult,s=t.all,l=H[a].assaults,c=y(i),u=[],d=0,h=l.length;d<h;d++){(p=l[d]).isAlive()&&p.isInFaction(n)&&(s||!c||p.isActive()&&p.isUnjammed())&&p.hasSkill(i)&&u.push(d)}if(!u.length)return 0;s||(u=b(u));var f=0;for(d=0,h=u.length;d<h;d++){var p;if((p=l[u[d]]).nullified)p.nullified--,debug&&(echo+=log.name(e)+" enhances "+log.name(p)+" but it is nullified!<br>");else{f++;var g=p.enhanced;0<r?(g[i]=(g[i]||0)+r,debug&&(echo+=log.name(e)+" enhances "+i+" of "+log.name(p,!1)+" by "+r+"<br>")):0<o&&(g[i]=-o,debug&&(echo+=log.name(e)+" enhances "+i+" of "+log.name(p,!1)+" by "+100*o+"%<br>"))}}return f},enrage:function(e,t){for(var n=_(e),a=t.y,r=t.x,i=t.all,o=H[n].assaults,s=[],l=0,c=o.length;l<c;l++){(h=o[l]).isAlive()&&h.isInFaction(a)&&s.push(l)}if(!s.length)return 0;i||(s=b(s));var u=getEnhancement(e,t.id,r);r+=u;var d=0;for(l=0,c=s.length;l<c;l++){var h,f=r;(h=o[s[l]]).nullified?(h.nullified--,debug&&(echo+=log.name(e)+" enrages "+log.name(h)+" but it is nullified!<br>")):(d++,t.mult&&(f=Math.ceil(t.mult*h.health)),h.enraged+=f,debug&&(u&&(echo+="<u>(Enhance: +"+u+")</u><br>"),echo+=log.name(e)+" enrages "+log.name(h)+" by "+f+"<br>"))}return d},imbue:function(e,t){for(var n=t.y,a=_(e),r=(k(e),t.x),i=(t.c,t.s),o=t.all,s=H[a].assaults,l=y(i),c=[],u=0,d=s.length;u<d;u++){(f=s[u]).isAlive()&&f.isInFaction(n)&&(o||!l||f.isActive()&&f.isUnjammed())&&c.push(u)}if(!c.length)return 0;t={id:i,x:r};o||(c=b(c));var h=0;for(u=0,d=c.length;u<d;u++){var f;if((f=s[c[u]]).nullified)f.nullified--,debug&&(echo+=log.name(e)+" enhances "+log.name(f)+" but it is nullified!<br>");else if(h++,f.hasSkill(i)){var p=f.enhanced;p[i]=(p[i]||0)+r,debug&&(echo+=log.name(e)+" imbues "+log.name(f,!1)+" existing "+log.skill(t)+" by "+r+"<br>")}else f.imbue(t),debug&&(echo+=log.name(e)+" imbues "+log.name(f,!1)+" with "+log.skill(t)+"<br>")}return h},mark:function(e,t){for(var n=t.y,a=(_(e),k(e)),r=t.x,i=t.all,o=H[a].assaults,s=e.mark_target,l=[],c=0,u=o.length;c<u;c++){if((h=o[c]).isAlive()&&h.isInFaction(n)){if(h.uid===s){l=[c];break}l.push(c)}}if(!l.length)return 0;i||(l=b(l)),r+=getEnhancement(e,t.id,r);var d=0;for(c=0,u=l.length;c<u;c++){var h;d++,(h=o[l[c]]).enfeebled+=r,e.mark_target=h.uid,debug&&(echo+=log.name(e)+" marks "+log.name(h)+" by "+r+"<br>"),t.countdown=1}return d},snaretongue:function(e,t){for(var n=t.y,a=(_(e),k(e)),r=H[a].assaults,i=(e.mark_target,[]),o=0,s=r.length;o<s;o++){(l=r[o]).isAlive()&&l.isInFaction(n)&&i.push(o)}if(!i.length)return 0;var l=r[i.reduce(function(e,t){return r[t].health_left<r[e].health_left?t:e},i[0])],c=e.key,u=l.key;if(c==c)return debug&&(echo+=log.name(e)+" activates snaretongue and keeps "+log.name(l)+" in front of it<br>"),!1;if(r.splice(l.key,1),r.length<c){CARDS[0]=CARDS[0]||{id:"0",name:"Filler",picture:"",rarity:"0",set:"9999",card_type:"0",type:"0",sub_type:[],health:1,attack:0,cost:0,maxLevel:1,skill:[]};var d=getCardByID({id:0,level:1});d.name="filler",d.health_left=0;for(var h=r.length;h<c;h++)r.push(d)}r.splice(c,0,l);h=Math.min(c,u);for(var f=Math.max(c,u);h<=f;h++)r[h].key=h;return debug&&(echo+=log.name(e)+" activates snaretongue and pulls "+log.name(l)+" in front of it<br>"),t.countdown=1}},e={ambush:function(e,t,n){var a=n.x,r=n.base,i=n.mult,o=a;if(!o){i=n.mult;o=Math.ceil(t[r]*i)}return T(e,t,o,null,function(e,t,n){echo+=log.name(e)+" ambushes "+log.name(t)+" for "+n+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"}),1},slow:function(e,t,n){var a=n.x,r=n.base,i=n.mult,o=a;if(!o){i=n.mult;o=Math.ceil(t[r]*i)}return t.timer+=o,debug&&(echo+=log.name(e)+" slows "+log.name(t)+" by "+o+"<br>"),1}},o={unearth:function(e,t,n){if(!e.isToken){var a=makeUnitInfo(n.card||e.id,n.level||n.x),r=get_card_apply_battlegrounds(a,null,!0);r.isToken=!0;var i=n.mult;return i&&(r.attack=Math.floor(e.attack*i),r.health=Math.floor(e.health*i)),c(r,e.owner,!0),debug&&(echo+=log.name(r)+" is unearthed</br>"),1}},reanimate:function(e,t,n){return e.reanimated?0:(e.health_left=n.x,e.reanimated=!0,debug&&(echo+=" and is reanimated</br>"),1)}};function S(e){if(e.silenced)debug&&(echo+=log.name(e)+" is silenced and cannot use skills</br>");else for(var t=e.skill,n=d(e),a=0,r=t.length;a<r&&n();a++){var i=t[a];if(!i.countdown){var o=u(s,i.id)(e,i);i.c&&0<o&&(i.countdown=i.c),showAnimations&&drawField(H,null,null,J,e)}}}function r(){cache_player_deck=getdeck?base64.decodeHash(getdeck):getDefaultDeck(),cache_player_deck_cards=getDeckCards(cache_player_deck,"player"),pvpAI=!0,getdeck2?(cache_cpu_deck=base64.decodeHash(getdeck2),getmission&&(pvpAI=!1)):getmission?(cache_cpu_deck=loadDeck.mission(getmission,missionlevel),pvpAI=!1):getraid?(cache_cpu_deck=loadDeck.raid(getraid,raidlevel),pvpAI=!1):cache_cpu_deck=getDefaultDeck(),cache_cpu_deck_cards=getDeckCards(cache_cpu_deck,"cpu")}function i(l){var c=l.uids={};["player","cpu"].forEach(function(e){for(var t=z[e],n=t.deck,a="player"===e?1:101,r=0;r<n.length;r++){var i=a+r,o=n[r];o.owner=e,o.played=!1,o.uid=i,c[i]=o}var s=t.commander;s.owner=e,s.health_left=s.health,s.reusableSkills||s.resetTimers();i="player"===e?-1:-2;s.uid=i,c[i]=s,l[e].commander=s})}function f(e,t){clearFrames(),l(e,t)}function l(e,t){if(SIMULATOR.pause)return SIMULATOR.pause=!1;var n=function(e,t){var n,a;a=surge?(n="cpu","player"):(n="player","cpu");if(0<e){if(K&&(!H.player.commander.isAlive()||!H.cpu.commander.isAlive()))return!(V=!1);if(!p(e,H,n,a,t))return!1;if(!H.player.commander.isAlive()||!H.cpu.commander.isAlive())return!(V=!1)}else!surge&&SIMULATOR.sendBattleUpdate&&SIMULATOR.sendBattleUpdate(e);for(e++;e<=max_turns+1;e++){if(e==max_turns+1)return!(V=!1);g(e,n,a,H);if(!p(e,H,n,a,!0))return!1;if(!H.player.commander.isAlive()||!H.cpu.commander.isAlive())return debug&&(echo+="<u>Turn "+e+" ends</u><br><br></div>"),!(V=!1)}return!(V=!1)}(e,t);return n&&q&&SIM_CONTROLLER.debug_end(),n}function p(e,t,n,a,r){if(e%2)var i=n,o=a;else i=a,o=n;return closeDiv=!1,!!function(e,t,n){var a=z[e],r=a.deck,i=a.ordered;{if(K&&"cpu"===e&&n)return A(e,r,i,t,n),!1;if(r[0]){SIMULATOR.waiting=!1;var o=0;if(1==r.length)o=0;else{for(var s=0;s<r.length;s++){var l=r[s];if(l.trap&&(c(l.trap,e,t),l.trap=!1),2===s)break}o=a.chooseCard(e,r,i,t,n)}if(o<0)return!1;c(r[o],e,t),function(e,t){var n=t,a=e.length-1;for(;n<a;)e[n]=e[++n];e.length=n}(r,o)}}return!0}(i,e,r)&&(function(e,t,n,a){for(var r=n[e],i=r.commander,o=r.assaults,s=n[t],l=s.commander,c=s.assaults,u=0;u<G.onTurn.length;u++){var d=G.onTurn[u];d.enemy_only&&"cpu"!==e||(d.ally_only&&"player"!==e||(d.owner=e,v(d),S(d)))}v(r.commander);for(var h=0,f=o.length;h<f;h++){var p=o[h];O(p,"evade","invisible"),O(p,"absorb","warded")}(function(e){for(var t=e.assaults,n=0,a=t.length;n<a;n++){var r=t[n];if(r.isAlive()&&r.isActive()&&r.isUnjammed()){var i=r.flurry;i&&0===i.countdown&&r.hasAttack()&&(i.countdown=i.c,r.dualstrike_triggered=!0),v(r)}}})(r),S(i);for(var h=0,f=o.length;h<f;h++){var p=o[h];if(p.isAlive()&&p.isActive())if(p.jammed)debug&&(echo+=log.name(p)+" is frozen and cannot attack<br>");else{var g=1;for(p.dualstrike_triggered&&(g++,debug&&(echo+=log.name(p)+" activates dualstrike<br>"));0<g;g--)if(S(p),p.isAlive())if(p.hasAttack()){if(F(p,c,l),!l.isAlive()||!i.isAlive())return;if(!p.isAlive())break}else debug&&0<p.permanentAttack()&&(echo+=log.name(p)+" is weakened and cannot attack<br>")}}(function(e){for(var t=0,n=e.length;t<n;t++){var a=e[t];if(a.jammedSelf?a.jammedSelf=!1:a.jammed=!1,a.attack_rally=0,a.attack_weaken=0,a.nullified=0,a.dualstrike_triggered=!1,a.silenced=!1,a.regenerate&&a.isDamaged()){var r=a.regenerate,i=getEnhancement(a,"regenerate",r);r+=i;var o=a.health-a.health_left;o<=r&&(r=o),a.health_left+=r,debug&&(echo+=log.name(a)+" regenerates "+r+" health<br>")}var s=a.poisoned;if(s){var l=a.warded;l&&(s-=P(a,"warded",s)),T(null,a,s,null,function(e,t,n){echo+=log.name(t)+" takes "+n,l&&(echo+=" (Poison: +"+a.poisoned+" Ward: -"+l+")"),echo+=" poison damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}var s=a.envenomed;if(s){var l=a.warded;l&&(s-=P(a,"warded",s)),T(null,a,s,null,function(e,t,n){echo+=log.name(t)+" takes "+n,l&&(echo+=" (Venom: +"+a.envenomed+" Ward: -"+l+")"),echo+=" venom damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}var c=a.scorched;if(c){s=c.amount;var l=a.warded;l&&(s-=P(a,"warded",s)),T(null,a,s,null,function(e,t,n){echo+=log.name(t)+" takes "+n,l&&(echo+=" (Scorch: +"+c.amount+" Ward: -"+l+")"),echo+=" scorch damage",t.isAlive()?t.scorched||(echo+=" and scorch wears off"):echo+=" and it dies",echo+="<br>"}),1<c.timer?c.timer--:a.scorched=0}var u=a.corroded;if(u)if(u.timer--,u.timer<0)a.corroded=!1,a.attack_corroded=0,debug&&(echo+=log.name(a)+" recovers from corrosion<br>");else{var d=u.amount;a.attack_corroded=d,debug&&(echo+=log.name(a)+" loses "+d+" attack to corrosion<br>")}a.isAlive()||L(a,null)}})(o),m("player"),m("cpu"),debug&&(echo+="<u>Turn "+a+" ends</u><br><br></div>")}(i,o,t,e),!0)}function I(e,t,n){var a=t[n];return a?e+" draws "+log.name(a,!0)+"<br/>":""}function g(e,t,n,a){if(choice=void 0,(W=e)%2)var r=t,i=n;else r=n,i=t;if(debug){var o=log.name(a[r].commander),s=z[r].deck;echo+='<div id="turn_"'+e+' class="turn-info"><hr/><br/><u>Turn '+e+" begins for "+o+"</u><br>",e<=2&&(echo+=I(o,s,0),echo+=I(o,s,1)),echo+=I(o,s,2)}var l=a[r],c=a[i],u=l.assaults,d=c.assaults;N(l.commander);for(var h=0,f=u.length;h<f;h++){var p=u[h];if(0<p.timer&&(3===e&&tournament||(p.timer--,debug&&(echo+=log.name(p)+" reduces its timer<br>"))),p.valor){var g=d[h];g&&p.adjustedAttack()<g.adjustedAttack()?(p.attack_valor+=p.valor,debug&&(echo+=log.name(p)+" activates valor, boosting its attack by "+p.valor+"<br/>")):debug&&(echo+=log.name(p)+" activates valor but ",echo+=g?"enemy is not strong enough.<br/>":"there is no opposing enemy.<br/>")}p.enfeebled=p.envenomed+p.heartseeker,p.enraged=0,p.invisible=0,p.protected=0,p.barrier_ice=0,p.warded=0,p.enhanced={},p.removeImbue(),N(p)}}function A(e,t,n,a,r){return SIMULATOR.waiting=!0,closeDiv=!0,r&&(hideTable(),outputTurns(echo),drawField(H,null,l,a),SIMULATOR.sendBattleUpdate(a)),-1}function C(e,t,n,a,r){var i=t.slice(0,3);closeDiv=!0;for(var o=[],s=[],l=0,c=i.length;l<c;l++){var u=i[l],d=l+": "+u.name;1<u.maxLevel&&(d+="{"+u.level+"/"+u.maxLevel+"}"),o.push(d),s.push(u)}if(r&&(hideTable(),outputTurns(echo),drawField(H,s,f,a)),void 0===choice)return-1;var h=choice;return h||(h=0),h}function D(e,t,n,a,r){if(void 0===n)return 0;for(var i=t.slice(0,3),o=!1,s=0,l=n.length;s<l;s++){for(var c,u=n[s],d=u.priority,h=-1,f=0,p=i.length;f<p;f++){var g=(c=i[f]).priority;if(areEqual(u,c)){o=!0;break}0<d&&d==g&&(h=f)}if(!o&&0<=h&&(o=!0,c=i[f=h]),o){for(var m=n.length-1;s<m;s++)n[s]=n[s+1];return n.length=s,f}}return-1}function R(e,t,n,a,r){var i=t.slice(0,3);return~~(Math.random()*i.length)}function B(e,t,n,a,r){for(var i,o,s,l,c,u=t.slice(0,3),d=-1,h=-1,f=0;f<u.length;f++){var p=u[f],g=(void 0,o=(i=p).id.toString(),s=6*parseInt(i.rarity),l=3*(4<o.length?parseInt(o[0]):0),c=parseInt(i.level)-parseInt(i.maxLevel),s+l+c);h<g&&(h=g,d=f)}return d}function M(e,t,n,a,r){return 0}function O(e,t,n){var a=0;e[t]&&(a=e[t],a+=getEnhancement(e,t,a));e[n]=a}function $(e,t,n){var a=(n=n||{}).enfeeble?0:e.enfeebled||0,r=n.stasis?0:x(e),i=n.protect?0:e.protected||0,o=n.ward?0:e.warded||0;t+=a-r;var s=!1;o&&(t-=P(e,"warded",t)),i&&(t-=P(e,"protected",t),0==e.protected&&(s=e.barrier_ice)),r&&(t-=r);var l="";return debug&&(a&&(l+=" Enfeeble: +"+a),r&&(l+=" Stasis: -"+r),i&&(l+=" Barrier: -"+i),o&&(l+=" Ward: -"+o)),t<0&&(t=0),{damage:t,shatter:s,echo:l}}function P(e,t,n){var a=e[t];return a<=n?(e[t]=0,a):(e[t]-=n,n)}function N(e){U(e,e.skill),U(e,e.earlyActivationSkills);var t=e.flurry;t&&t.countdown&&(t.countdown--,debug&&(t.countdown?echo+=log.name(e)+" charges  dualstrike (ready in "+t.countdown+" turns)<br/>":echo+=log.name(e)+" readies dualstrike<br/>"))}function U(e,t){for(var n=0,a=t.length;n<a;n++){var r=t[n];r.countdown&&(r.countdown--,debug&&(r.countdown?echo+=log.name(e)+" charges "+skillNameFromID(r.id)+" (ready in "+r.countdown+" turns)<br/>":echo+=log.name(e)+" readies "+skillNameFromID(r.id)+"<br/>"))}}function F(e,t,n){var a=t[e.key];if(a&&a.isAlive()){var r,i=!1;if(!a.taunt)if((r=t[e.key-1])&&r.taunt)a=r,i=!0;else(r=t[e.key+1])&&r.taunt&&(a=r,i=!0);i&&debug&&(echo+=log.name(a)+" taunts "+log.name(e))}else a=n;var o=e.adjustedAttack(),s=a.enfeebled;o+=s,debug&&(echo+="<u>(Attack: +"+e.attack,e.attack_berserk&&(echo+=" Berserk: +"+e.attack_berserk),e.attack_valor&&(echo+=" Valor: +"+e.attack_valor),e.attack_rally&&(echo+=" Rally: +"+e.attack_rally),e.attack_weaken&&(echo+=" Weaken: -"+e.attack_weaken),e.attack_corroded&&(echo+=" Corrosion: -"+e.attack_corroded),s&&(echo+=" Enfeeble: +"+s));var l=e.pierce;l?l+=getEnhancement(e,"pierce",l):l=0;var c=a.protected,u=!1,d=a.armored,h=x(a);if(c&&(debug&&(echo+=" Barrier: -"+c),l&&(c<=l?(debug&&(echo+=" Pierce: +"+c),l-=c,c=0,a.protected=0):(debug&&(echo+=" Pierce: +"+l),c-=l,a.protected-=l,l=0)),c&&(c<=o?(u=a.barrier_ice,o-=c,a.protected=0):(a.protected-=o,o=0))),h&&(h+=getEnhancement(a,"stasis",h),debug&&(echo+=" Shroud: -"+h),l&&(h<l?(debug&&(echo+=" Pierce: +"+h),h=0):(debug&&(echo+=" Pierce: +"+l),h-=l)),o-=h),d&&(d+=getEnhancement(a,"armored",d),debug&&(echo+=" Armor: -"+d),l&&(d<l?(debug&&(echo+=" Pierce: +"+d),d=0):(debug&&(echo+=" Pierce: +"+l),d-=l)),o-=d),o<0&&(o=0),debug&&(echo+=") = "+o+" damage</u><br>"),T(e,a,o,null,function(e,t,n){echo+=log.name(e)+" attacks "+log.name(t)+" for "+n+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"}),showAnimations&&drawField(H,null,null,J,e),n.isAlive()){if(0<o&&a.isAssault()&&a.isAlive()){if(e.poison){var f=e.poison;(f+=getEnhancement(e,"poison",f))>a.poisoned&&(a.poisoned=f,debug&&(echo+=log.name(e)+" inflicts poison("+f+") on "+log.name(a)+"<br>"))}if(e.venom){var p=e.venom;if((p+=getEnhancement(e,"venom",p))>a.envenomed){var g=p-a.envenomed;a.envenomed=p,a.enfeebled+=g,debug&&(echo+=log.name(e)+" inflicts venom("+p+") on "+log.name(a)+"<br>")}}if(e.nullify){var m=e.nullify;m+=getEnhancement(e,"nullify",m),a.nullified+=m,debug&&(echo+=log.name(e)+" inflicts nullify("+m+") on "+log.name(a)+"<br>")}if(e.silence&&(a.silenced=!0,debug&&(echo+=log.name(e)+" inflicts silence on "+log.name(a)+"<br>")),e.daze){var v=e.daze;v+=getEnhancement(e,"daze",v),a.attack_weaken+=v,debug&&(echo+=log.name(e)+" dazed "+log.name(a)+" for "+v+"<br>")}}if(u&&E(a),0<o&&e.isAlive()){if(e.leech&&e.isDamaged()){var b=e.leech;b+=getEnhancement(e,"leech",b);var _=e.health-e.health_left;_<=b&&(b=_),e.health_left+=b,debug&&(echo+=log.name(e)+" siphons "+b+" health<br>")}if(e.reinforce){var k=e.reinforce;k+=getEnhancement(e,"reinforce",k),e.protected+=k,debug&&(echo+=log.name(e)+" reinforces itself with barrier "+k+"<br>")}if(a.counter){var y=0+a.counter;j(e,a,"Vengance",y,getEnhancement(a,"counter",y))}if(a.counterburn){var w=a.counterburn||0;w+=getEnhancement(a,"counterburn",w),e.scorched?(e.scorched.amount+=w,e.scorched.timer=2):e.scorched={amount:w,timer:2},debug&&(echo+=log.name(a)+" inflicts counterburn("+w+") on "+log.name(e)+"<br>")}if(a.counterpoison){f=a.counterpoison||0;(f+=getEnhancement(a,"counterpoison",f))>e.poisoned&&(e.poisoned=f,debug&&(echo+=log.name(a)+" inflicts counterpoison("+f+") on "+log.name(e)+"<br>"))}if(a.fury){var S=a.fury,I=getEnhancement(a,"counter",S);if(a.isAlive()){var A=S+I;a.attack_berserk+=A,debug&&(echo+=log.name(a)+" activates fury and gains "+A+" attack<br>")}j(e,a,"Fury",S,I)}if(0<a.enraged&&(a.attack_berserk+=a.enraged,debug&&(echo+=log.name(a)+" is enraged and gains "+a.enraged+" attack!</br>")),e.berserk){var C=e.berserk;C+=getEnhancement(e,"berserk",C),e.attack_berserk+=C,debug&&(echo+=log.name(e)+" activates berserk and gains "+C+" attack<br>")}}if(a.corrosive){var D=a.corrosive||0;D+=getEnhancement(a,"corrosive",D),e.corroded?(e.corroded.amount+=D,e.corroded.timer=2):e.corroded={amount:D,timer:2},debug&&(echo+=log.name(a)+" inflicts corrosion("+D+") on "+log.name(e)+"<br>"),e.attack_corroded=D,debug&&(echo+=log.name(e)+" loses "+D+" attack to corrosion<br>")}e.isAlive()||L(e,a),showAnimations&&drawField(H,null,null,J,e)}}function j(e,t,a,n,r){var i=n+r,o=$(e,i,{enfeeble:!0});i=o.damage;o.shatter;debug&&(echo+="<u>("+a+": +"+n,r&&(echo+=" Enhance: +"+r),echo+=o.echo,echo+=") = "+i+" damage</u><br>"),T(t,e,i,null,function(e,t,n){echo+=log.name(t)+" takes "+n+" "+a.toLowerCase()+" damage",echo+=(t.isAlive()?"":" and it dies")+"<br>"})}SIMULATOR.pause=!1,SIMULATOR.performTurns=l,SIMULATOR.waitForOpponent=A;var G,z={},H={},W=0,V=!1,q=!1,K=!1,J=0,Y=0,X=0;SIMULATOR.simulate=function(){if(V=!0,function(){SIMULATOR.simulation_turns=0;var e={cpu:{deck:[]},player:{deck:[]}};SIMULATOR.deck=e,SIMULATOR.field={cpu:{assaults:[]},player:{assaults:[]}},cache_player_deck_cards&&(e.player=copy_deck(cache_player_deck_cards)),getmission&&1<missionlevel&&missionlevel<7?(cache_cpu_deck=loadDeck.mission(getmission,missionlevel),cache_cpu_deck_cards=getDeckCards(cache_cpu_deck,"cpu")):getraid&&(cache_cpu_deck=loadDeck.raid(getraid,raidlevel),cache_cpu_deck_cards=getDeckCards(cache_cpu_deck,"cpu")),cache_cpu_deck_cards&&(e.cpu=copy_deck(cache_cpu_deck_cards)),getordered&&!getexactorder&&(e.player.ordered=copy_card_list(e.player.deck)),getordered2&&!getexactorder2&&(e.cpu.ordered=copy_card_list(e.cpu.deck)),e.player.chooseCard=q?C:getordered?D:R,e.cpu.chooseCard=getordered2?D:pvpAI?B:getexactorder2?R:M}(),getexactorder?getordered||(z.player.shuffleHand=!0):shuffle(z.player.deck),getexactorder2?getordered2||(z.cpu.shuffleHand=!0):shuffle(z.cpu.deck),i(H),getsiege){var e=BATTLEGROUNDS[tower_type].effect[tower_level];if(e){e=makeUnitInfo(e.id,e.level);var t=get_card_apply_battlegrounds(e);t.uid=150,c(H.uids[150]=t,"cpu",-1,!0)}}return l(0)},SIMULATOR.onPlaySkills=e,SIMULATOR.calculatePoints=function(e){var t=H.uids,n={player:{total:0,taken:0},cpu:{total:0,taken:0}};for(var a in t){var r=t[a],i=n[r.owner];i&&(i.total+=r.health,(r.played||r.isCommander())&&(i.taken+=r.health-r.health_left))}n.player.percent=i.taken/i.total,n.cpu.percent=i.taken/i.total;var o=H.cpu.commander;if(getdeck2)if(o.isAlive()&&!e)var s=Math.floor(25*n.cpu.percent);else s=130-Math.floor(15*n.player.percent);else s=o.isAlive()&&!e?(s=Math.floor(n.cpu.percent/.02),Math.max(5,s)):200-Math.floor(n.player.percent/.02);return s},Object.defineProperties(SIMULATOR,{setupDecks:{get:function(){return r},set:function(e){r=e}},setupField:{get:function(){return i},set:function(e){i=e}},deck:{get:function(){return z},set:function(e){z=e}},field:{get:function(){return H},set:function(e){H=e}},battlegrounds:{get:function(){return G},set:function(e){G=e}},simulation_turns:{get:function(){return W},set:function(e){W=e}},simulating:{get:function(){return V},set:function(e){V=e}},totalDeckHealth:{get:function(){return Y},set:function(e){Y=e}},totalCpuDeckHealth:{get:function(){return X},set:function(e){X=e}},user_controlled:{get:function(){return q},set:function(e){q=e}},livePvP:{get:function(){return K},set:function(e){K=e}}})}(),function(e){"use strict";var t=function(e,t,n){return e.filter(function(e){return e[n]==t})},n=function(e,t,n,a,r){var i=n.filter(function(e){return e.id==t})[0];if(i){var o=i[a];return e.filter(function(e){var t=e[r];return 0<=o.indexOf(t)})}return[]};e.module("core",[]).filter("forMissions",function(){return function(e,t){if(!e||!t)return e;for(var n=[],a=0,r=e.length;a<r;a++){for(var i=e[a],o=i.missions,s=!0,l=0;l<o.length;l++){if(!t[o[l]]){s=!1;break}}s&&n.push(i)}return n}}).filter("filterByParent",function(){return t}).filter("filterChildren",function(){return n}),e.module("simulatorApp",["core"]).controller("SimulatorCtrl",["$scope","$window",function(r,e){function t(e){var t=Object.keys(e);t.sort(function(e,t){return Number(e)-Number(t)});for(var n=[],a=0;a<t.length;a++){var r=t[a],i=e[r];n.push(i)}return n}function n(e){var t=[];for(var n in e)t.push(e[n]);return t}r.locations=[],r.campaigns=[],r.missions=e.TITANS,r.raids=e.RAIDS,r.battlegrounds=e.BATTLEGROUNDS,r.mapBattlegrounds=n(e.MAP_BATTLEGROUNDS),r.campaignBGEs=[],r.tower=!1,r.auto=!1,r.debugMode=!1,r.selections={location:"",campaign:"",mission:"",raid:""},r.titans=function(){r.campaigns=n(e.CAMPAIGNS),r.missions=e.TITANS},r.campaignSections=function(){r.locations=t(e.LOCATIONS).sort(function(e,t){return Number(e.id)-Number(t.id)}),r.missions=t(e.MISSIONS),r.campaigns=t(e.CAMPAIGNS)},r.filteredRaids=function(){var t={};return n(r.raids).sort(function(e,t){return Number(t.id)-Number(e.id)}).forEach(function(e){t[e.name]||(t[e.name]=e)}),n(t).sort(function(e,t){return Number(e.id)-Number(t.id)})},r.getLocationClass=function(e){if(!e){var t=r.selections.location;e=r.locations.filter(function(e){return e.id==t})[0]}if(e){var n=Number(e.id);return 0===n?"heroUpgrade":100<=n?"event":"black"}return"grey"},r.getCampaignClass=function(e){if(!e){var t=r.selections.campaign;e=r.campaigns.filter(function(e){return e.id==t})[0]}return e?e.side_mission?0==e.location_id?"heroUpgrade":"mythic":e.isLocation?"location":"black":"grey"},r.$watch("selections.location",function(e,t){r.selections.campaign=""}),r.$watch("selections.campaign",function(e,t){r.selections.mission=""}),r.towerTypes=["Castle Tower","Cannon Tower","Tree of Life"],r.selectableBattlegrounds=function(){var e=[];for(var t in r.battlegrounds){var n=r.battlegrounds[t];n.hidden||n.isTower||e.push(n)}return e.sort(function(e,t){return e.id-t.id}),e},r.personalBattlegrounds=function(){var e=[];for(var t in r.battlegrounds){var n=r.battlegrounds[t],a=Number(n.id);1e3<a&&a<2e3&&e.push(n)}return e.sort(function(e,t){return e.id-t.id}),e},r.towerTypes=function(){var e=[];for(var t in r.battlegrounds){var n=r.battlegrounds[t];n.isTower&&e.push(n)}return e.sort(function(e,t){return e.id-t.id}),e},r.$watch("debugMode",function(e,t){})}])}(angular);var loadDeckDialog,mapBGEDialog,storageAPI={};function doneLoading(){$("body").removeClass("loading"),checkTutorial()}function updateGameData(e){var t=doneLoading;e&&(t=function(){doneLoading(),e()}),DATA_UPDATER.updateData(t,!0)}function setDeckSortable(e,l){$(e).sortable({items:".card:not(.commander):not(.blank)",tolerance:"intersect",helper:function(e,t){return t.clone()},start:function(e,t){var n=t.placeholder.index()-1;t.item.data("origPos",n),$(t.item).hide()},stop:function(e,t){var n=t.item.data("origPos")-1,a=t.item.index()-1,r=$(l),i=base64.decodeHash(r.val()),o=i.deck;o.splice(a,0,o.splice(n,1)[0]);var s=base64.encodeHash(i);r.val(s)}})}function showMapBGEs(){mapBGEDialog.dialog("open"),mapBGEDialog.dialog("option","position",{my:"center",at:"center",of:window})}function loadDeck(e){$('label[for="loadDeckName"]').html("<strong>Deck:</strong>"),loadDeckDialog.dialog("open"),loadDeckDialog.dialog("option","position",{my:"center",at:"center",of:window}),loadDeckDialog.hashField=e}function onDeckLoaded(e,t){$(t).val(e).change()}!function(t){"use strict";var n;try{n=t.module("simulatorApp")}catch(e){n=t.module("simulatorApp",[])}n.controller("DeckStorageCtrl",["$scope","$window",function(e,t){e.getSavedDecks=t.storageAPI.getSavedDecks,e.keys=function(e){return e?Object.keys(e):[]}}])}(angular),function(e){try{var t=window.localStorage,n="__storage_test__";return t.setItem(n,n),t.removeItem(n),!0}catch(e){return!1}}()?function(){var r="SavedDecks",i="Tutorial";function o(e){var t=localStorage.getItem(e);if(t)try{t=JSON.parse(t)}catch(e){t={}}else t={};return storageAPI.data[e]=t}storageAPI.initialize=function(){var e,t=getCurrentPage();void 0===(e=o(r)).savedDecks&&storageAPI.setField(r,"savedDecks",e),storageAPI.getField(r,"savedDecks",{}),storageAPI.shouldShowTutorial=storageAPI.getField(i,t,!0)[t];var n=storageAPI.onUpdateDecks;storageAPI.onUpdateDecks=function(e){n(),storageAPI.setField(r,"savedDecks",e)};var a=storageAPI.setShowTutorial;storageAPI.setShowTutorial=function(e){a(e),storageAPI.setField(i,t,e)}},storageAPI.getField=function(e,t,n){var a=o(e)[t];return void 0===a&&(a=n,storageAPI.setField(e,t,a)),a},storageAPI.setField=function(e,t,n){var a=o(e);a[t]=n,localStorage.setItem(e,JSON.stringify(a))},window.addEventListener("storage",function(e){"__storage_test__"!==e.key&&(localStorage.getItem(e.key)!==e.newValue&&angular.element("#loadDeckDialog").scope().$apply(localStorage.setItem(e.key,e.newValue)))})}():function(){storageAPI.initialize=function(){storageAPI.getSavedDecks=function(){return{}},storageAPI.loadDeck=e,storageAPI.deleteDeck=e,storageAPI.clearDecks=e,storageAPI.getField=function(e,t,n){return n},storageAPI.setField=function(){},storageAPI.savedDecks={},storageAPI.shouldShowTutorial=!0};var e=function(e,t){alert("Your browser does not support this feature.")}}(),function(){var e,t="SavedDecks";storageAPI.data={},storageAPI.getSavedDecks=function(){return storageAPI.getField(t,"savedDecks",{})},storageAPI.saveDeck=function(e,t){var n=storageAPI.getSavedDecks();n[e]=t,storageAPI.onUpdateDecks(n)},storageAPI.loadDeck=function(e){return storageAPI.getSavedDecks()[e]},storageAPI.deleteDeck=function(e){var t=storageAPI.getSavedDecks();delete t[e],storageAPI.onUpdateDecks(t)},storageAPI.clearDecks=function(e){var t=storageAPI.getSavedDecks();for(var e in t)delete t[e];storageAPI.onUpdateDecks(t)},storageAPI.onUpdateDecks=function(){e||(e=angular.element("#loadDeckDialog").scope()),e.$apply()},storageAPI.setShowTutorial=function(e){shouldShowTutorial=e},storageAPI.initialize()}(),$(function(){$("#deck1").change(function(){this.value=this.value.trim(),r("attack_deck",base64.decodeHash(this.value),"player")}),$("#deck2").change(function(){this.value=this.value.trim(),r("defend_deck",base64.decodeHash(this.value),"cpu")}),$("#battleground").change(function(){$("#deck1").change(),$("#deck2").val()?$("#deck2").change():$("#mission").val()?$("#mission").change():$("#raid").val()&&$("#raid").change()});for(var e=$("label[bge-desc]"),t=0;t<e.length;t++){$(e[t]).hover(n,a)}function n(e){var t=$("#tooltip"),n=$("#tooltip-text");n.html($(e.target).attr("bge-desc")),n.width(200),t.show(),$("#tooltip .arrow").css("borderTopWidth",0).css("borderBottomWidth",0);var a=$(e.target).offset();a.left-=230,a.top-=t.outerHeight()/2-10,t.offset(a);var r=n.innerHeight()/2-4;$("#tooltip .arrow").css("borderTopWidth",r).css("borderBottomWidth",r)}function a(e){$("#tooltip").hide()}function r(e,t,n){var a=$("#"+e);if(a.children().remove(),!_DEFINED("seedtest")){SIM_CONTROLLER.getConfiguration();var r=getBattlegrounds(getbattleground,selfbges,enemybges,mapbges,getcampaign,missionlevel,getraid,raidlevel);r=r.onCreate.filter(function(e){return!("player"===n&&e.enemy_only||"cpu"===n&&e.ally_only)}),a.append(CARD_GUI.makeDeckHTML(t,!1,r))}}$(".accordion").accordion({collapsible:!0,active:!1,heightStyle:"content"}).filter(".start-open").accordion("option","active",0);if($("#raid, #raid_level").change(function(){var e,t=$("#raid").val(),n=$("#raid_level");t?(e=loadDeck.raid(t,n.val()),"Dungeon"===RAIDS[t].type?n.attr("max",150):n.attr("max",40)):(e=base64.decodeHash(""),n.attr("max",40)),r("defend_deck",e,"cpu")}),$("#location, #campaign").change(function(){$("#mission").change()}),$("#mission, #mission_level").change(function(){var e,t=$("#mission").val();if(t){var n=$("#mission_level").val();e=loadDeck.mission(t,n)}else e=base64.decodeHash("");r("defend_deck",e,"cpu")}),loadDeckDialog=$("#loadDeckDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{Delete:function(){var e=$("#loadDeckName").val();storageAPI.deleteDeck(e)},Load:function(){var e=$("#loadDeckName").val();onDeckLoaded(storageAPI.loadDeck(e),loadDeckDialog.hashField),loadDeckDialog.dialog("close")},Cancel:function(){loadDeckDialog.dialog("close")}}}),mapBGEDialog=$("#bgeDialog").dialog({autoOpen:!1,minWidth:320,modal:!0,resizable:!1,buttons:{OK:function(){mapBGEDialog.dialog("close")},Cancel:function(){mapBGEDialog.dialog("close")}}}),r("attack_deck",base64.decodeHash("")),r("defend_deck",base64.decodeHash("")),setDeckSortable("#attack_deck","#deck1"),setDeckSortable("#defend_deck","#deck2"),_DEFINED("latestCards")){var i=null;_DEFINED("autostart")&&(i=function(){SIM_CONTROLLER.startsim(1)}),updateGameData(i)}else loadCardCache();processQueryString()});var dark=!1;function toggleTheme(){dark?($("#theme").attr("href","dist/light.min.css"),$("#toggleTheme").val("Dark Theme")):($("#theme").attr("href","dist/dark.min.css"),$("#toggleTheme").val("Light Theme")),dark=!dark}var frames=[],frameInterval=null;function drawField(e,t,n,a,r){var i=CARD_GUI.doDrawField(e,t,n,a,r);frames.push(i),frameInterval||(drawFrames(),frameInterval=setInterval(drawFrames,500))}function clearFrames(){frames=[],clearInterval(frameInterval),frameInterval=null}var deckPopupDialog,style,disabledInterval=!1;function drawFrames(){if(0===frames.length)disabledInterval?(clearInterval(frameInterval),frameInterval=null):disabledInterval=!0;else{var e=frames.splice(0,1)[0];$("#cardSpace").children().remove().end().append(e),disabledInterval=!1}}function processQueryString(){if($("#header").load("templates/header.html",function(){"undefined"!=typeof showTutorial&&$("#help").click(showTutorial)}),$.holdReady(!0),$("#footer").load("templates/footer.html",function(){$.holdReady(!1)}),!document.getElementById("ui"))return 0;angular.element(document.getElementById("ui")).scope();$("#generate_link").on("click",display_generated_link),$("#btn_simulate").on("click",SIM_CONTROLLER.startsim),$("#btnStop").on("click",SIM_CONTROLLER.stopsim),$("#display_history").on("click",display_history),$("#deck1").val(_GET("deck1")).change(),$("#deck2").val(_GET("deck2")).change(),$("#surge").prop("checked",_DEFINED("surge")),$("#siege").prop("checked",_DEFINED("siege"));var e=Math.min(Math.max(_GET("tower_level")||18,0),18);$("#tower_level").val(e);var t=_GET("tower_type")||501;$("#tower_type").val(t),$("#auto_mode").prop("checked",_DEFINED("auto_mode")),$("#tournament").prop("checked",_DEFINED("tournament")),$("#ordered").prop("checked",_DEFINED("ordered")),$("#exactorder").prop("checked",_DEFINED("exactorder")),$("#ordered2").prop("checked",_DEFINED("ordered2")),$("#exactorder2").prop("checked",_DEFINED("exactorder2")),_DEFINED("randomAI")&&(pvpAI=!1);var n=_GET("location"),a=_GET("campaign"),r=_GET("mission"),i=_GET("raid");if(n&&$("#location").val(n).change(),a&&(n||(n=CAMPAIGNS[a].location_id,$("#location").val(n).change()),$("#campaign").val(a).change()),r&&($("#mission_level").val(_GET("mission_level")||7),$("#mission").val(r).change()),i&&($("#raid_level").val(_GET("raid_level")||25),$("#raid").val(i).change()),_DEFINED("bges"))for(var o=_GET("bges"),s=0;s<o.length;s+=2){var l=base64.toDecimal(o.substring(s,s+2));$("#battleground_"+l).prop("checked",!0)}else for(document.getElementsByName("battleground"),s=0;s<current_bges.length;s++)$("#battleground_"+current_bges[s]).prop("checked",!0);if(o=_GET("selfbges"))for(s=0;s<o.length;s+=2){l=base64.toDecimal(o.substring(s,s+2))+1e4;$("#self-battleground_"+l).prop("checked",!0)}if(o=_GET("enemybges"))for(s=0;s<o.length;s+=2){l=base64.toDecimal(o.substring(s,s+2))+1e4;$("#enemy-battleground_"+l).prop("checked",!0)}var c=_GET("mapBges");if(c&&setSelectedMapBattlegrounds(c),$("#battleground").change(),$("#sims").val(_GET("sims")||1e4),_DEFINED("debug")&&$("#debug").click(),_DEFINED("mass_debug")&&$("#mass_debug").click(),_DEFINED("loss_debug")&&$("#loss_debug").click(),_DEFINED("win_debug")&&$("#win_debug").click(),_DEFINED("play_debug")&&$("#play_debug").click(),document.title="SimSpellstone "+text_version+" - The Spellstone Simulator that runs from your browser!",_DEFINED("autostart")&&!_DEFINED("latestCards"))SIM_CONTROLLER.startsim(1);else if(_DEFINED("unit_tests")){var u=document.getElementsByTagName("body")[0],d=document.createElement("script");d.src="scripts/unit_tests.js",u.appendChild(d),d.onload=function(){var e=document.createElement("script");e.src="scripts/unit_test_runner.js",u.appendChild(e)}}document.getElementById("missionDeckDialog")&&(deckPopupDialog=$("#missionDeckDialog").dialog({autoOpen:!1,minWidth:500,minHeight:20,modal:!0,resizable:!1,draggable:!1,buttons:{Close:function(){deckPopupDialog.dialog("close")}},open:function(e,t){$(".ui-dialog-titlebar-close",t.dialog|t).hide()}}))}window.addEventListener("error",function(e,t,n){if(0==n){var a="<br><br><i>Error Message:</i><br><br><i>It appears you're having trouble loading SimSpellstone. Thanks.</i><br><br>";return outp?outp(a):document.write(a),1}var r="JavaScript error:\n "+e+"\n on line "+n+"\n for "+t;r+="\n",r+="Browser CodeName: "+navigator.appCodeName+"\n",r+="Browser Name: "+navigator.appName+"\n",r+="Browser Version: "+navigator.appVersion+"\n",r+="Cookies Enabled: "+navigator.cookieEnabled+"\n",r+="Platform: "+navigator.platform+"\n",r+="User-agent header: "+navigator.userAgent+"\n",r+="SimSpellstone version: "+text_version+"\n",getdeck&&(r+="Deck hash: "+getdeck+"\n"),getcardlist&&(r+="Card list: "+getcardlist+"\n"),getordered&&(r+="Ordered: Yes\n"),getexactorder&&(r+="Exact-order: Yes\n"),surge&&(r+="Surge: Yes\n"),getdeck2&&(r+="Enemy deck hash: "+getdeck2+"\n"),getcardlist2&&(r+="Enemy Card list: "+getcardlist2+"\n"),getordered2&&(r+="Enemy Ordered: Yes\n"),getexactorder2&&(r+="Enemy Exact-order: Yes\n"),getmission&&(r+="Mission ID: "+getmission+"\n"),getraid&&(r+="Raid ID: "+getraid+"\n"),getbattleground&&(r+="Battleground ID: "+getbattleground+"\n"),games&&(r+="Sims run so far: "+games+"\n"),outp('<br><br><i>Error Message:</i><br><textarea cols=50 rows=6 onclick="this.select()"><blockquote>'+r+"</blockquote></textarea>"+echo),current_timeout&&clearTimeout(current_timeout)});var u_black=!1;function toggle_u(){var e=!1;if(void 0===style)e=!0,style=document.createElement("style");else for(;style.hasChildNodes();)style.removeChild(style.firstChild);var t,n=document.getElementsByTagName("head")[0];t=u_black?(u_black=!1,document.createTextNode("u { text-decoration: none; font-style:normal; color: #dddddd; font-weight: normal; }")):(u_black=!0,document.createTextNode("u { text-decoration: none; font-style:normal; color: #000000; font-weight: normal; }")),style.type="text/css",style.styleSheet?style.styleSheet.cssText=t.nodeValue:style.appendChild(t),!0===e&&n.appendChild(style)}function toggleUI(e){e?$("#ui").show():$("#ui").hide()}function showUI(){toggleUI(!0),document.getElementById("stop").style.display="none"}function hideUI(){$(".accordion").accordion("option","active",null),toggleUI(!1),document.getElementById("stop").style.display="block"}function getSelectedBattlegrounds(e){e=e||"";for(var t=[],n=document.getElementsByName(e+"battleground"),a=0;a<n.length;a++){var r=n[a];r&&r.checked&&t.push(r.value)}return t=t.join()}function getSelectedMapBattlegrounds(){for(var e=[],t=$("#location").val(),n=document.getElementsByName("map-battleground"),a=0;a<n.length;a++){var r=n[a];0<r.value&&e.push(t+"-"+a+"-"+r.value)}return e=e.join()}function setSelectedMapBattlegrounds(e){for(var t=document.getElementsByName("map-battleground"),n=0;n<e.length&&n<t.length;n++)t[n].value=e[n]}function outp(e){$("#content").html(e)}function outputTurns(e){closeDiv&&(e+="</div>",closeDiv=!1),outp(e="<input id='show-turns' type='button' value='Show All' /> <div id='turn-container'>Turn: <select id='turn-picker'></select></div> <div>"+e+"</div>");for(var t=$(".turn-info").hide().length,n=[],a=0;a<t;a++){var r=a+1;n.push("<option value='"+a+"'>"+r+"</option>")}var i=a-1;i&&closeDiv&&i--,$("#turn-picker").append(n).change(function(e){var t=e.target.selectedIndex;$(".turn-info").hide().eq(t).show()}).val(i).change();var o=!0;$("#show-turns").click(function(){if(o=!o){var e=$("#turn-picker").val();$(".turn-info").hide().eq(e).show(),$("#turn-container").show(),this.value="Show All"}else $(".turn-info").show(),$("#turn-container").hide(),this.value="Show One"})}function showWinrate(){if(suppressOutput);else if(debug||0==sims_left){var e="";if(e+='<br><br><i>Non-autostart link</i><br><a href="'+generate_link()+'">'+generate_link()+'</a><br><br><i>Autostart link</i><br><a href="'+generate_link(1)+'">'+generate_link(1)+"</a><br><br>",debug)return e}var t=(100*(wins/games)).toFixed(2)+"%";$("#wins").html(wins),$("#winrate").html(t);var n=losses/games*100;n=n.toFixed(2)+"%",$("#losses").html(losses),$("#lossrate").html(n);var a=draws/games*100;a=a.toFixed(2)+"%",$("#draws").html(draws),$("#drawrate").html(a);var r=marginOfError(wins,games);$("#marginGames").html((r*games).toFixed(0)),r=r.toFixed(2)+"%",$("#marginPercent").html(r);var i=(100*games/(games+sims_left)).toFixed("2")+"%";$(".battleCount").html(games),$("#percentComplete").html(i),$("#avgLength").html((total_turns/games).toFixed(1)),$("#avgPoints").html((points/games).toFixed(2)),$("#winrateTable").show();var o="";if(0==sims_left){o+=e;var s="",l=[],c=document.getElementById("deck1").value;c&&(l.player=base64.decodeHash(c)),l.player&&(s=base64.encodeHash(l.player)),battle_history+=t+" (+/- "+r+") &nbsp; &nbsp; "+s+"<br>"}return o}function hideTable(){$("#winrateTable").hide()}function setSimStatus(e,t,n){if($("#simStatusMsg").html(e),t&&n){var a=games+sims_left,r=(100*games/a).toFixed("2")+"%",i="("+games+"/"+a+") "+r;$("#progress").html(i),$("#speed").show(),$("#elapsed").html(t),$("#simsPerSec").html(n)}else $("#progress").html(""),$("#speed").hide();$("#simulationStatus").show()}function winrateDev(e,t){if(t<=1)return 1;var n=e/t,a=t;return Math.sqrt(a*n*(1-n))}function marginOfError(e,t){if(t<=1)return 1;var n=e/t,a=t;return 100*(1.96*Math.sqrt(n*(1-n)/a)+.5/a)}function generate_link(e){var t=0,n=document.URL,a=n.indexOf("?");0<a&&(n=n.substring(0,a));var r=[];addValueParam(r,"deck1"),addValueParam(r,"deck2"),addValueParam(r,"location"),addValueParam(r,"campaign"),addValueParam(r,"mission"),addValueParam(r,"mission_level"),addValueParam(r,"raid"),addValueParam(r,"raid_level");var i=$("select[name=map-battleground]").toArray().reduce(function(e,t){return e+t.value},"");i.length&&r.push("mapBges="+i),addBoolParam(r,"surge"),addBoolParam(r,"siege")&&(addValueParam(r,"tower_level"),addValueParam(r,"tower_type")),addBoolParam(r,"auto_mode"),addBoolParam(r,"tournament"),addBoolParam(r,"ordered"),addBoolParam(r,"exactorder"),addBoolParam(r,"ordered2"),addBoolParam(r,"exactorder2");for(var o="",s=document.getElementsByName("battleground"),l=0;l<s.length;l++)(t=s[l]).checked&&(o+=base64.fromDecimal(t.value,2));r.push("bges="+o);for(o="",s=document.getElementsByName("self-battleground"),l=0;l<s.length;l++)(t=s[l]).checked&&(o+=base64.fromDecimal(t.value-1e4,2));o&&r.push("selfbges="+o);for(o="",s=document.getElementsByName("enemy-battleground"),l=0;l<s.length;l++)(t=s[l]).checked&&(o+=base64.fromDecimal(t.value-1e4,2));return o&&r.push("enemybges="+o),addValueParam(r,"sims"),addBoolParam(r,"debug"),addBoolParam(r,"mass_debug"),addBoolParam(r,"loss_debug"),addBoolParam(r,"win_debug"),addBoolParam(r,"play_debug"),e&&r.push("autostart"),0<r.length?n+"?"+r.join("&"):n}function addValueParam(e,t,n){var a=$("#"+(n||t)).val();return!!a&&(e.push(t+"="+a),!0)}function addBoolParam(e,t){return!!$("#"+t).is(":checked")&&(e.push(t),!0)}function load_deck_builder_for_field(e){var t=$("#"+e),n=t.val();n||(n=base64.encodeHash({commander:elariaCaptain,deck:[]})),open_deck_builder("Card Hash",n,null,t)}var deckBuilders={};function load_deck_builder(e){if("player"===e)var t=$("#deck1").val();else{t=$("#deck2").val();var n=$("#mission").val(),a=$("#mission_level").val(),r=$("#raid").val(),i=$("#raid_level").val()}var o,s={commander:elariaCaptain,deck:[]};t?s=base64.decodeHash(t):n?s=loadDeck.mission(n,a):r&&(s=loadDeck.raid(r,i)),s&&(o=base64.encodeHash(s));var l="player"==e?"Player Deck":"Enemy Deck",c=e?$("#"+("player"==e?"deck1":"deck2")):null,u=deckBuilders[e];null==u||u.closed?deckBuilders[e]=open_deck_builder(l,o,null,c):u.focus()}function open_deck_builder(e,t,n,a){var r=["nosort"];t&&r.push("hash="+t),n&&r.push("inventory="+n),e&&r.push("name="+e),_DEFINED("ajax")&&r.push("ajax"),r.push("fromSim");var i,o="DeckBuilder.html?"+r.join("&"),s=Math.min(screen.width,1e3),l=Math.min(screen.height,700),c=Number((screen.width-s)/2),u=Number((screen.height-l)/2),d="scrollbars,left="+c+"top="+u+",width="+s+",height="+l+",top="+u+",left="+c,h=window.open(o,"",d);return $(h).load((i=a,function(){i&&(h.updateSimulator=function(e){i.val(e).change()})})),h}function display_generated_link(){outp('<br><i>Non-autostart link</i><br><a href="'+generate_link()+'">'+generate_link()+'</a><br><br><i>Autostart link</i><br><a href="'+generate_link(1)+'">'+generate_link(1)+"</a><br><br>")}function clear_history(){battle_history="",display_history()}function display_history(){outp("<br><hr>"+(battle_history||"No history available.")+'<hr><br><br><input type="button" value="Clear History" onclick="clear_history();" style="text-align: center; font-weight: normal;"><br><br>')}function supports_html5_storage(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}var current_timeout,cache_player_deck,cache_cpu_deck,cache_player_deck_cards,cache_cpu_deck_cards,battle_history="",max_turns=100,debug=!1,mass_debug=!1,loss_debug=!1,win_debug=!1,found_desired=!1,play_debug=!1,showAnimations=!1,getdeck="",getdeck2="",getcardlist="",getcardlist2="",getordered=!1,getordered2=!1,getexactorder=!1,getexactorder2=!1,getcampaign=0,getmission=0,missionlevel=0,getraid=!1,raidlevel=0,getbattleground="",enemybges="",selfbges="",mapbges="",getsiege=0,tower_level=0,tower_type=0,pvpAI=!0,echo="",closeDiv=!1,wins=0,losses=0,draws=0,games=0,points=0,num_sims=0,last_games=[],sims_left=0,surge=!1,battleground=[],total_turns=0,choice=void 0,auto_mode=!1,tournament=!1,suppressOutput=!1,orders={},cardStats={},CARD_GUI={};function createImg(e,t){return $("<img>").addClass(t).attr("src",e)[0]}function createDiv(e,t){return $("<div>").addClass(e).html(t)[0]}function createSpan(e,t){return $("<span>").addClass(e).html(t)[0]}function getTutorialScript(){for(var e=[{msg:"Welcome to SIM Spellstone!  This is a brief tutorial of how to use the Simulator."},{ui:"#setup-container",msg:"Here is where you set everything up for a simulation.",actions:[i]},{ui:"#setup-container",msg:'When you are done, you can click the "Setup" bar to hide this section.',actions:[r]},{ui:"#setup-container",msg:"Clicking it again will open it back up.",actions:[i]},{ui:"#attacker-container",msg:"Use this section to set up the deck for the attacker."},{ui:"#edit-player",msg:'Click "Edit" to open the DeckBuilder and create a deck.'},{ui:"#load-player",msg:'Click "Load" to choose a deck from the ones you have saved in the DeckBuilder.'},{ui:"#attacker-hash-container",msg:"If you have a deck hash, you can simply paste it here as well."},{ui:"#attacker-advanced",msg:"This section contains some additional settings for the attacker that determine how their deck is played."},{ui:"#auto-container",msg:"Check this to have fights run on auto, rather than playing them yourself.",showFor:"battle"},{ui:"#auto-container",msg:'Setting the attacker to "auto" also enables the "Ordered" and "Do Not Shuffle" options.',showFor:"battle"},{ui:"#ordered-container",msg:"Check this to have the AI attempt to play the attacker's deck as close as possible to the order that the cards are listed."},{ui:"#exactorder-container",msg:"Check this to disable shuffling of the attacker's deck."},{ui:"#defender-container",msg:"Use this section to set up the deck for the defender."},{ui:"#defender-hash-container",msg:"You can manually create a deck for the defender here."},{ui:"#pve-container",msg:"Or you can choose a PvE deck to sim against.",actions:[u]},{ui:"#campaign-container",msg:"To choose a campaign mission, first pick a Campaign from the dropdown...",actions:[l]},{ui:"#mission-container",msg:"... then pick a Mission from the mission dropdown.",actions:[h,l,c]},{ui:"#raid-container",msg:"To fight against a raid boss, pick the desired Raid from the dropdown",actions:[u,d]},{ui:"#defender-advanced",msg:"This section contains some additional settings for the defender that determine how their deck is played.",actions:[h]},{ui:"#surge-container",msg:"Check this to have the defender go first.",showFor:"battle"},{ui:"#tower-container",msg:"Use these fields to set up a tower for the defender."},{ui:"#siege-container",msg:"Check this field to turn the tower on."},{ui:"#tower_level",msg:"This field determines the BR of the defender.  The tower's level is one less than the defender's BR."},{ui:"#tower_type",msg:"This field determines which type of tower the defender will have."},{ui:"#bge-container",msg:"Check/uncheck boxes here to set active battleground effects.",actions:[o,i]},{ui:"#view-container",msg:'Click "View" to display the currently set decks for the attacker and defender.',actions:[r,s]},{ui:"#view-container",msg:"Click it again to hide it.",actions:[o]},{ui:"#sims-container",msg:"This field determines how many fights to run.",showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Simulate" to run a batch of fights.',showFor:"titans"},{ui:"#btn_simulate",msg:'Click "Battle" to start a fight.',showFor:"battle"},{ui:"#generate_link",msg:'Click "Generate Link" to create a link that will open this tool with all of the current settings.'},{msg:'To view this tutorial again at any time, you can click the "Help" button.  (Note: this will reset the Simulator.)'}],t=getCurrentPage(),n=0;n<e.length;n++){var a=e[n];a.showFor&&a.showFor!==t&&e.splice(n--,1)}function r(){$("#setup-container").accordion("option","active",null)}function i(){$("#setup-container").accordion("option","active",0)}function o(){$("#view-container").accordion("option","active",null)}function s(){$("#view-container").accordion("option","active",0)}function l(){$("#campaign").val(1).change()}function c(){$("#mission").val(11).change()}function u(){$("#campaign").val("").change()}function d(){$("#raid").val(24005).change()}function h(){$("#raid").val("").change()}return e}!function(){var t="";function a(e,t,n){var a=[],r=getCardByID(e.commander);a.push(m(r,!1,!1));for(var i=0,o=e.deck.length;i<o;i++){var s=e.deck[i];if(n)var l=get_card_apply_battlegrounds(s,n);else l=getCardByID(s);a.push(m(l,!1,!1))}if(!t)for(;i<15;i++)a.push(createDiv("card blank"));return a}function l(e,t,n,a,r,i){var o,s,l;r=r||0;for(var c=0,u=[],d=0,h=e.length;d<h&&(!i||c<i);d++){var f=e[d],p=getCardByID(f);areEqual(p,s)?l++:(r<=c&&(g(o,l),(o=m(p,t,!(l=1),n,a,null,d)).setAttribute("data-i",d),void 0!==f.index&&o.setAttribute("data-index",f.index),u.push(o)),s=p,c++)}return g(o,l),u}function i(e,t,n,a,r){t||(t=[]);var i=[];if(a){var o=document.createElement("h1");o.innerHTML="Turn: "+a+" (Currently at "+SIMULATOR.calculatePoints(!0)+" points)",i.push(o)}var s=createDiv("field"),l=null;if(r){l=r.owner;r=r.isCommander()?-1:r.key}return"player"===l?(s.appendChild(c(e.cpu)),s.appendChild(c(e.player,r))):(s.appendChild(c(e.cpu,r)),s.appendChild(c(e.player))),i.push(s),i.push(u(t,n,a)),i.push(document.createElement("br")),i.push(document.createElement("br")),i}function c(e,t){var n=createDiv("float-left"),a=m(e.commander,!1,!0);-1===t&&d(a),n.appendChild(a);var r=e.assaults;if(r)for(var i=0,o=r.length;i<o;i++){var s=r[i];a=m(s,!1,!0);s.timer&&a.classList.add("inactive"),t===i&&d(a),n.appendChild(a)}return n}function u(e,t,n){for(var a=createDiv("float-left hand"),r=0,i=e.length;r<i;r++){var o=e[r];if(o){var s=m(o,!1);0===r?s.classList.add("left"):2===r?s.classList.add("right"):2<r&&s.classList.add("inactive");t&&s.addEventListener("click",function(e){return function(){choice=e,t(n)}}(r)),a.appendChild(s)}}return a}function d(e){e.style.outline="5px solid LawnGreen"}function g(e,t){var n=parseInt(t);if(n==t&&(t=1<n?n:null),t){var a=createDiv("multiplier","x"+t);a.setAttribute("data-count",t);var r=createImg(z("cardAssets")+"multiplier.png","multiplier");e.appendChild(r),e.appendChild(a)}}function m(e,t,n,a,r,i,o){var s=createDiv("card");s.setAttribute("data-id",e.id),s.setAttribute("data-level",e.level);for(var l=e.runes,c=[],u={},d=0,h=l.length;d<h;d++){var f=l[d].id;c.push(l[d].id);var p=getRune(f);for(var g in p.stat_boost)"skill"==g&&(g=p.stat_boost.skill.id),u[g]=!0}var m=e.highlighted;if(m)for(d=0;d<m.length;d++){u[g=m[d]]=!0}s.setAttribute("data-runeids",c.join(","));var v=loadCard(e.id).picture;if(v){var b=document.createElement("i");0==v.indexOf("portrait_")?b.className="portrait portrait-"+v:b.className="sprite sprite-"+v,s.appendChild(b)}e.isCommander()&&s.classList.add("commander"),s.classList.add(factions.names[e.type].toLowerCase());var _=createDiv("card-name",(void 0!==e.uid?"("+e.uid+") ":"")+e.name),k=createDiv("card-id","("+e.id+")");if(_.appendChild(k),s.appendChild(_),!e.isCommander()){if(0<=e.attack){if(n){e.isUnjammed()||s.classList.add("frozen");var y=createDiv("card-attack",e.adjustedAttack().toString());e.adjustedAttack()>e.attack?y.classList.add("increased"):e.adjustedAttack()<e.attack?y.classList.add("decreased"):u.attack&&y.classList.add("increased")}else y=createDiv("card-attack",e.attack.toString());s.appendChild(createImg(z("cardAssets")+"Attack.png","attack")),s.appendChild(y)}0<=e.cost&&(n?e.timer&&(s.appendChild(createDiv("delay",e.timer)),s.appendChild(createImg(z("cardAssets")+"Timer.png","timer"))):(s.appendChild(createDiv("delay",e.cost)),s.appendChild(createImg(z("cardAssets")+"Timer.png","timer"))))}if(0<=e.health){if(n){var w=createDiv("card-health",e.health_left.toString());e.health_left<e.health?w.classList.add("decreased"):u.health&&w.classList.add("increased")}else{w=createDiv("card-health",e.health.toString());u.health&&w.classList.add("increased")}s.appendChild(createImg(z("cardAssets")+"Health.png","health")),s.appendChild(w)}var S=createDiv("card-skills"),I=createDiv("card-skills-short");e.earlyActivationSkills&&N(e,S,I,e.earlyActivationSkills,n),N(e,S,I,e.skill,n),e.onDeathSkills&&N(e,S,I,e.onDeathSkills,n),function(t,n,a,r,i){Object.getOwnPropertyNames(SKILL_DATA).filter(function(e){return 0<=["passive","toggle"].indexOf(SKILL_DATA[e].type)}).forEach(function(e){!function(e,t,n,a,r,i){var o=a[r];if(o){var s={id:r,x:o,boosted:i[r]};e.appendChild(U(a,s,n)),e.appendChild(document.createElement("br")),t.appendChild(F(s.id))}}(t,n,r,a,e,i)});var e=a.flurry;e&&(t.appendChild(U(a,e,r)),t.appendChild(document.createElement("br")),n.appendChild(F(e.id)))}(S,I,e,n,u);var A,C,D=S.cloneNode(!0);if(D.className="card-skills-detailed",I.hasChildNodes()&&(t?(s.appendChild(I),s.appendChild(S)):s.appendChild(D)),s.appendChild(createDiv("faction")),n){var T=function(e){var t=[];if(e.enfeebled){var n=j("enfeeble",e.enfeebled);t.push(n)}if(e.marked){var n=j("enfeeble",e.marked);t.push(n)}if(e.nullified){var n=j("nullify",e.nullified);t.push(n)}if(e.poisoned){var n=j("poison",e.poisoned);t.push(n)}if(e.scorched&&e.scorched.amount){var n=j("burn",e.scorched.amount);t.push(n)}var a=[];if(e.enraged){var n=j("enrage",e.enraged);t.push(n)}if(e.protected){var n=j("protect",e.protected);a.push(n)}if(e.invisible){var n=j("evade",e.invisible);a.push(n)}var r=[];if(0<t.length){for(var i=createDiv("card-debuffs"),o=0,s=t.length;o<s;o++)i.appendChild(t[o]);r.push(i)}if(0<a.length){for(var l=createDiv("card-buffs"),o=0,s=a.length;o<s;o++)l.appendChild(a[o]);r.push(l)}return r}(e);if(0<T.length){s.appendChild(createDiv("hidden","..."));var E=createDiv("card-statuses");for(d=0;d<T.length;d++){var L=T[d];E.appendChild(L)}s.appendChild(E)}}if(e.set){var x=(A=e.set,C=H[A],createImg(z("cardAssets")+C+".png"));x.className="set",s.appendChild(x)}var R=e.sub_type;if(R.length){var B=createDiv("subfaction");for(d=0;d<R.length;d++){var M=R[d];if(M){var O=G(M);B.appendChild(O)}}s.appendChild(B)}if(0<e.rarity){if(e.maxLevel>Number(e.rarity)+2)var $=createImg(z("cardAssets")+"Level_"+e.rarity+"_"+e.maxLevel+"_"+e.level+".png");else $=createImg(z("cardAssets")+"Level_"+e.rarity+"_"+e.level+".png");if($.className="level",9999<e.id){var P="1"==e.id.toString()[0]?"Dualfuse":"Quadfuse";(P=createImg(z("cardAssets")+P+".png")).className="fusion",s.appendChild(P)}s.appendChild($)}else if(1<e.maxLevel){($=createImg(z("cardAssets")+e.maxLevel+"_"+e.level+".png")).className="level",s.appendChild($)}return a&&s.addEventListener("click",function(){return a(s,o)}),r&&(s.oncontextmenu=function(){return r(s,o)}),i&&(s.onmouseover=function(){return i(s,o)}),s}function N(e,t,n,a,r){for(var i=0;i<a.length;i++){var o=a[i];t.appendChild(U(e,o,r,i)),t.appendChild(document.createElement("br")),n.appendChild(F(o.id))}}function U(e,t,n,a){var r=document.createElement("span");r.className="skill",r.appendChild(F(t.id));var i=isImbued(e,t.id,a),o=getEnhancement(e,t.id,t.x);i?r.classList.add("imbued"):(t.boosted||o)&&r.classList.add("increased"),t.all&&(r.innerHTML+=" All "),t.y&&r.appendChild(G(t.y)),t.s&&r.appendChild(F(t.s));var s=(0|t.x)+o;return s&&(r.innerHTML+=" "+s+" "),t.c&&(r.innerHTML+=t.c,n&&(r.innerHTML+=" ("+(t.countdown?t.countdown:"0")+")")),r}function F(e){var t=z("skills"),n=SKILL_DATA[e],a=createImg(t+=(n?n.icon:e)+".png");switch(e){case"weakenself":case"enlarge":a.classList.add("affect-self")}return a.title=n?n.name:e,a}function j(e,t){var n=document.createElement("span");return n.appendChild(F(e)),t&&(n.innerHTML+=t),n}function G(e){var t=factions.names[e];return createImg(z("factions")+t+".png")}function z(e){return t+"res/"+e+"/"}var H={1e3:"Basic",1100:"Legacy",7e3:"Basic",2e3:"Reward",2100:"Reward",3e3:"Premium",4e3:"BoxOnly",5e3:"Champion",5100:"Champion",9999:"StoryElements"};CARD_GUI.clearCardSpace=function(){$("#cardSpace").empty()},CARD_GUI.clearDeckSpace=function(){document.getElementById("deck").innerHTML=""},CARD_GUI.draw_deck=function(e,t){var n=$("#deck");return n.children().remove(),n.append(a(e,t)),n},CARD_GUI.create_card_html=m,CARD_GUI.makeDeckHTML=a,CARD_GUI.makeCardListHTML=function(e,t,n){for(var a=createDiv("float-left"),r=0,i=e.deck.length;r<i;r++){var o=e.deck[r],s=m(getCardByID(o),!1,!1,t,n,null,r);void 0!==o.index&&s.setAttribute("data-index",o.index),a.appendChild(s)}return a},CARD_GUI.draw_card_list=function(e,t,n,a,r,i){var o=l(e,t,null,null,r,i),s=$("#cardSpace");return s.empty(),s.append(o),s},CARD_GUI.draw_cards=function(e,t,n,a){var r=i(e,t,n,a);$("#cardSpace").children().remove().end().append(r)},CARD_GUI.doDrawField=i,CARD_GUI.draw_inventory=function(e){var t=l(e.deck),n=$("#deck");return n.children().remove(),n.append(l([e.commander])),n.append(t),n},CARD_GUI.draw_hand=u,CARD_GUI.createItemHTML=function(e,t,n){var a=createDiv("card item"),r=document.createElement("i");r.className="sprite sprite-Item",a.appendChild(r),n&&((n=createImg(z("items")+n+".png")).className="item-image",a.appendChild(n));var i=createDiv("card-name",e);return a.appendChild(i),a.classList.add("factionless"),a.appendChild(createDiv("faction")),g(a,t),a},CARD_GUI.addMult=g,CARD_GUI.addWeight=function(e,t){if(0<t){var n=createDiv("weight",(100*t).toFixed(2)+"%");n.setAttribute("data-count",t);var a=createImg(z("cardAssets")+"multiplier.png","weight");e.appendChild(a),e.appendChild(n)}},Object.defineProperties(CARD_GUI,{assetsRoot:{get:function(){return t},set:function(e){t=e}}})}(),$(document).ready(function(){var o=getTutorialScript(),e=$("<div></div>");function t(){storageAPI.shouldShowTutorial?n():i()}function n(){l=0,c();$("#tutorial").show()}$(document.body).append(e),e.load("templates/tutorial-overlay.html",null,function(){e.replaceWith(function(){return $(this).contents()}),$("#tutorial-show").prop("checked",storageAPI.shouldShowTutorial).change(function(e){storageAPI.setShowTutorial(this.checked)}),$("#help").click(n),$("#tutorial-close, #tutorial-skip").click(i),$("#tutorial-next").click(a),$("#tutorial-prev").click(r),"undefined"==typeof delayTutorial&&t()});var s,l=0;function a(){l++,c()}function r(){l--,c()}function i(){$("#tutorial").hide(),$("#tutorial-permahide").is(":checked")&&storageAPI.hideTutorial()}function c(){clearTimeout(s);var e=o[l],t=e.actions;if(t)for(var n=0;n<t.length;n++)t[n]();var a=e.msg,r=e.ui;if(r){var i=$(r);e.dialog&&(i=i.parent()),u(i),t&&(s=setTimeout(u,500,i)),a.indexOf(!1)&&(a=a.replace(/\{0\}/g,i.text()))}else $(".overlay-fog").width(0).height(0);$("#tutorialMessage").text(a),l<o.length-1?($("#tutorial-next").show(),$("#tutorial-close").hide()):($("#tutorial-next").hide(),$("#tutorial-close").show()),0<l?$("#tutorial-prev").removeClass("disabled"):$("#tutorial-prev").addClass("disabled")}function u(e){var t=e.offset();$(".overlay-fog").css({top:t.top-2+"px",left:t.left-2+"px"}).width(e.outerWidth()+4+"px").height(e.outerHeight()+4+"px")}window.showTutorial=n,window.checkTutorial=t}),function(){function e(){CARD_GUI.draw_cards(SIMULATOR.field)}SIM_CONTROLLER.end_sims_callback=function(){hideUI(),e()},SIM_CONTROLLER.stop_sims_callback=e}();var battle_sim=!0;function getTutorialScript(){for(var e=[{msg:"Welcome to SIM Spellstone!  This is a brief tutorial of how to use the Live PvP functions.",actions:[o,l]},{ui:"#attacker-hash-container",msg:"First, set up your deck."},{ui:"#self-battleground",msg:"Then add any personal BGEs (totems) you want to use.",actions:[o]},{ui:"#btn_simulate",msg:'If you wish to be the defender, you\'re almost done.  Click "Ready" to start waiting for a battle request.',actions:[r,i,s]},{ui:"#myPeerID",msg:"Then copy your ID and send it to your opponent (they will need this to connect to you).",actions:[r]},{ui:"#btnStop",msg:'Click "Stop" at any time to stop waiting and edit your settings again.',actions:[r,s]},{msg:"If you want to be the attacker, you are in charge of choosing the match type(s) and battleground effects.",actions:[i,o]},{ui:"#first-player-advantage-container",msg:'This section lets you pick various options for dealing with "First-Player Advantage".'},{ui:"#surge-container",msg:"This setting makes the defender go first."},{ui:"#tournament-container",msg:"This setting causes the attacker's first card to not tick down right away."},{ui:"#tower-container",msg:"These settings will provide the defender with the specified tower."},{ui:"#battlefield-container",msg:"Configure the desired battleground effects for the match here."},{msg:"When you configured have the desired match settings, it is time to start the match.",actions:[l,o]},{ui:"#enemyPeerID",msg:"Paste your opponent's ID into the ID field.",actions:[function(){var e=$("#myPeerID").val();e=e.split("").reverse().join(""),$("#enemyPeerID").val(e).change()},s]},{ui:"#btn_simulate",msg:'Finally, click "Connect!" to start the fight.'}],t=getCurrentPage(),n=0;n<e.length;n++){var a=e[n];a.showFor&&a.showFor!==t&&e.splice(n--,1)}function r(){$("#btn_simulate").click()}function i(){$("#btnStop").click()}function o(){$("#setup-container").accordion("option","active",0)}function s(){$("#setup-container").accordion("option","active",null)}function l(){$("#enemyPeerID").val("").change()}return e}!function i(o,s,l){function c(n,e){if(!s[n]){if(!o[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(u)return u(n,!0);var a=new Error("Cannot find module '"+n+"'");throw a.code="MODULE_NOT_FOUND",a}var r=s[n]={exports:{}};o[n][0].call(r.exports,function(e){var t=o[n][1][e];return c(t||e)},r,r.exports,i,o,s,l)}return s[n].exports}for(var u="function"==typeof require&&require,e=0;e<l.length;e++)c(l[e]);return c}({1:[function(e,t){t.exports.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,t.exports.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,t.exports.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate},{}],2:[function(e,t){function a(e,t,n){return this instanceof a?(r.call(this),this.options=s.extend({serialization:"binary",reliable:!1},n),this.open=!1,this.type="data",this.peer=e,this.provider=t,this.id=this.options.connectionId||a._idPrefix+s.randomToken(),this.label=this.options.label||this.id,this.metadata=this.options.metadata,this.serialization=this.options.serialization,this.reliable=this.options.reliable,this._buffer=[],this._buffering=!1,this.bufferSize=0,this._chunkedData={},this.options._payload&&(this._peerBrowser=this.options._payload.browser),void i.startConnection(this,this.options._payload||{originator:!0})):new a(e,t,n)}var s=e("./util"),r=e("eventemitter3"),i=e("./negotiator"),n=e("reliable");s.inherits(a,r),a._idPrefix="dc_",a.prototype.initialize=function(e){this._dc=this.dataChannel=e,this._configureDataChannel()},a.prototype._configureDataChannel=function(){var t=this;s.supports.sctp&&(this._dc.binaryType="arraybuffer"),this._dc.onopen=function(){s.log("Data channel connection success"),t.open=!0,t.emit("open")},!s.supports.sctp&&this.reliable&&(this._reliable=new n(this._dc,s.debug)),this._reliable?this._reliable.onmessage=function(e){t.emit("data",e)}:this._dc.onmessage=function(e){t._handleDataMessage(e)},this._dc.onclose=function(){s.log("DataChannel closed for:",t.peer),t.close()}},a.prototype._handleDataMessage=function(e){var t=this,n=e.data,a=n.constructor;if("binary"===this.serialization||"binary-utf8"===this.serialization){if(a===Blob)return void s.blobToArrayBuffer(n,function(e){n=s.unpack(e),t.emit("data",n)});if(a===ArrayBuffer)n=s.unpack(n);else if(a===String){var r=s.binaryStringToArrayBuffer(n);n=s.unpack(r)}}else"json"===this.serialization&&(n=JSON.parse(n));if(n.__peerData){var i=n.__peerData,o=this._chunkedData[i]||{data:[],count:0,total:n.total};return o.data[n.n]=n.data,o.count+=1,o.total===o.count&&(delete this._chunkedData[i],n=new Blob(o.data),this._handleDataMessage({data:n})),void(this._chunkedData[i]=o)}this.emit("data",n)},a.prototype.close=function(){this.open&&(this.open=!1,i.cleanup(this),this.emit("close"))},a.prototype.send=function(e,t){if(this.open)if(this._reliable)this._reliable.send(e);else{var n=this;if("json"===this.serialization)this._bufferedSend(JSON.stringify(e));else if("binary"===this.serialization||"binary-utf8"===this.serialization){var a=s.pack(e);if((s.chunkedBrowsers[this._peerBrowser]||s.chunkedBrowsers[s.browser])&&!t&&a.size>s.chunkedMTU)return void this._sendChunks(a);s.supports.sctp?s.supports.binaryBlob?this._bufferedSend(a):s.blobToArrayBuffer(a,function(e){n._bufferedSend(e)}):s.blobToBinaryString(a,function(e){n._bufferedSend(e)})}else this._bufferedSend(e)}else this.emit("error",new Error("Connection is not open. You should listen for the `open` event before sending messages."))},a.prototype._bufferedSend=function(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this.bufferSize=this._buffer.length)},a.prototype._trySend=function(e){try{this._dc.send(e)}catch(e){this._buffering=!0;var t=this;return setTimeout(function(){t._buffering=!1,t._tryBuffer()},100),!1}return!0},a.prototype._tryBuffer=function(){if(0!==this._buffer.length){var e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this.bufferSize=this._buffer.length,this._tryBuffer())}},a.prototype._sendChunks=function(e){for(var t=s.chunk(e),n=0,a=t.length;n<a;n+=1){e=t[n];this.send(e,!0)}},a.prototype.handleMessage=function(e){var t=e.payload;switch(e.type){case"ANSWER":this._peerBrowser=t.browser,i.handleSDP(e.type,this,t.sdp);break;case"CANDIDATE":i.handleCandidate(this,t.candidate);break;default:s.warn("Unrecognized message type:",e.type,"from peer:",this.peer)}},t.exports=a},{"./negotiator":5,"./util":8,eventemitter3:9,reliable:12}],3:[function(e){window.Socket=e("./socket"),window.MediaConnection=e("./mediaconnection"),window.DataConnection=e("./dataconnection"),window.Peer=e("./peer"),window.RTCPeerConnection=e("./adapter").RTCPeerConnection,window.RTCSessionDescription=e("./adapter").RTCSessionDescription,window.RTCIceCandidate=e("./adapter").RTCIceCandidate,window.Negotiator=e("./negotiator"),window.util=e("./util"),window.BinaryPack=e("js-binarypack")},{"./adapter":1,"./dataconnection":2,"./mediaconnection":4,"./negotiator":5,"./peer":6,"./socket":7,"./util":8,"js-binarypack":10}],4:[function(e,t){function a(e,t,n){return this instanceof a?(i.call(this),this.options=r.extend({},n),this.open=!1,this.type="media",this.peer=e,this.provider=t,this.metadata=this.options.metadata,this.localStream=this.options._stream,this.id=this.options.connectionId||a._idPrefix+r.randomToken(),void(this.localStream&&o.startConnection(this,{_stream:this.localStream,originator:!0}))):new a(e,t,n)}var r=e("./util"),i=e("eventemitter3"),o=e("./negotiator");r.inherits(a,i),a._idPrefix="mc_",a.prototype.addStream=function(e){r.log("Receiving stream",e),this.remoteStream=e,this.emit("stream",e)},a.prototype.handleMessage=function(e){var t=e.payload;switch(e.type){case"ANSWER":o.handleSDP(e.type,this,t.sdp),this.open=!0;break;case"CANDIDATE":o.handleCandidate(this,t.candidate);break;default:r.warn("Unrecognized message type:",e.type,"from peer:",this.peer)}},a.prototype.answer=function(e){if(this.localStream)r.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");else{this.options._payload._stream=e,this.localStream=e,o.startConnection(this,this.options._payload);for(var t=this.provider._getMessages(this.id),n=0,a=t.length;n<a;n+=1)this.handleMessage(t[n]);this.open=!0}},a.prototype.close=function(){this.open&&(this.open=!1,o.cleanup(this),this.emit("close"))},t.exports=a},{"./negotiator":5,"./util":8,eventemitter3:9}],5:[function(e,t){var o=e("./util"),r=e("./adapter").RTCPeerConnection,i=e("./adapter").RTCSessionDescription,s=e("./adapter").RTCIceCandidate,l={pcs:{data:{},media:{}},queue:[],_idPrefix:"pc_",startConnection:function(e,t){var n=l._getPeerConnection(e,t);if("media"===e.type&&t._stream&&n.addStream(t._stream),e.pc=e.peerConnection=n,t.originator){if("data"===e.type){var a={};o.supports.sctp||(a={reliable:t.reliable});var r=n.createDataChannel(e.label,a);e.initialize(r)}o.supports.onnegotiationneeded||l._makeOffer(e)}else l.handleSDP("OFFER",e,t.sdp)},_getPeerConnection:function(e,t){var n;return l.pcs[e.type]||o.error(e.type+" is not a valid connection type. Maybe you overrode the `type` property somewhere."),l.pcs[e.type][e.peer]||(l.pcs[e.type][e.peer]={}),l.pcs[e.type][e.peer],t.pc&&(n=l.pcs[e.type][e.peer][t.pc]),n&&"stable"===n.signalingState||(n=l._startPeerConnection(e)),n},_startPeerConnection:function(e){o.log("Creating RTCPeerConnection.");var t=l._idPrefix+o.randomToken(),n={};"data"!==e.type||o.supports.sctp?"media"===e.type&&(n={optional:[{DtlsSrtpKeyAgreement:!0}]}):n={optional:[{RtpDataChannels:!0}]};var a=new r(e.provider.options.config,n);return l.pcs[e.type][e.peer][t]=a,l._setupListeners(e,a,t),a},_setupListeners:function(t,e){var a=t.peer,r=t.id,i=t.provider;o.log("Listening for ICE candidates."),e.onicecandidate=function(e){e.candidate&&(o.log("Received ICE candidates for:",t.peer),i.socket.send({type:"CANDIDATE",payload:{candidate:e.candidate,type:t.type,connectionId:t.id},dst:a}))},e.oniceconnectionstatechange=function(){switch(e.iceConnectionState){case"disconnected":case"failed":o.log("iceConnectionState is disconnected, closing connections to "+a),t.close();break;case"completed":e.onicecandidate=o.noop}},e.onicechange=e.oniceconnectionstatechange,o.log("Listening for `negotiationneeded`"),e.onnegotiationneeded=function(){o.log("`negotiationneeded` triggered"),"stable"==e.signalingState?l._makeOffer(t):o.log("onnegotiationneeded triggered when not stable. Is another connection being established?")},o.log("Listening for data channel"),e.ondatachannel=function(e){o.log("Received data channel");var t=e.channel;i.getConnection(a,r).initialize(t)},o.log("Listening for remote stream"),e.onaddstream=function(e){o.log("Received remote stream");var t=e.stream,n=i.getConnection(a,r);"media"===n.type&&n.addStream(t)}},cleanup:function(e){o.log("Cleaning up PeerConnection to "+e.peer);var t=e.pc;!t||"closed"===t.readyState&&"closed"===t.signalingState||(t.close(),e.pc=null)},_makeOffer:function(t){var n=t.pc;n.createOffer(function(e){o.log("Created offer."),!o.supports.sctp&&"data"===t.type&&t.reliable&&(e.sdp=Reliable.higherBandwidthSDP(e.sdp)),n.setLocalDescription(e,function(){o.log("Set localDescription: offer","for:",t.peer),t.provider.socket.send({type:"OFFER",payload:{sdp:e,type:t.type,label:t.label,connectionId:t.id,reliable:t.reliable,serialization:t.serialization,metadata:t.metadata,browser:o.browser},dst:t.peer})},function(e){t.provider.emitError("webrtc",e),o.log("Failed to setLocalDescription, ",e)})},function(e){t.provider.emitError("webrtc",e),o.log("Failed to createOffer, ",e)},t.options.constraints)},_makeAnswer:function(t){var n=t.pc;n.createAnswer(function(e){o.log("Created answer."),!o.supports.sctp&&"data"===t.type&&t.reliable&&(e.sdp=Reliable.higherBandwidthSDP(e.sdp)),n.setLocalDescription(e,function(){o.log("Set localDescription: answer","for:",t.peer),t.provider.socket.send({type:"ANSWER",payload:{sdp:e,type:t.type,connectionId:t.id,browser:o.browser},dst:t.peer})},function(e){t.provider.emitError("webrtc",e),o.log("Failed to setLocalDescription, ",e)})},function(e){t.provider.emitError("webrtc",e),o.log("Failed to create answer, ",e)})},handleSDP:function(e,t,n){n=new i(n);var a=t.pc;o.log("Setting remote description",n),a.setRemoteDescription(n,function(){o.log("Set remoteDescription:",e,"for:",t.peer),"OFFER"===e&&l._makeAnswer(t)},function(e){t.provider.emitError("webrtc",e),o.log("Failed to setRemoteDescription, ",e)})},handleCandidate:function(e,t){var n=t.candidate,a=t.sdpMLineIndex;e.pc.addIceCandidate(new s({sdpMLineIndex:a,candidate:n})),o.log("Added ICE candidate for:",e.peer)}};t.exports=l},{"./adapter":1,"./util":8}],6:[function(e,t){function n(e,t){return this instanceof n?(a.call(this),e&&e.constructor==Object?(t=e,e=void 0):e&&(e=e.toString()),t=u.extend({debug:0,host:u.CLOUD_HOST,port:u.CLOUD_PORT,key:"peerjs",path:"/",token:u.randomToken(),config:u.defaultConfig},t),"/"===(this.options=t).host&&(t.host=window.location.hostname),"/"!==t.path[0]&&(t.path="/"+t.path),"/"!==t.path[t.path.length-1]&&(t.path+="/"),void 0===t.secure&&t.host!==u.CLOUD_HOST&&(t.secure=u.isSecure()),t.logFunction&&u.setLogFunction(t.logFunction),u.setLogLevel(t.debug),u.supports.audioVideo||u.supports.data?u.validateId(e)?u.validateKey(t.key)?t.secure&&"0.peerjs.com"===t.host?void this._delayedAbort("ssl-unavailable","The cloud server currently does not support HTTPS. Please run your own PeerServer to use HTTPS."):(this.destroyed=!1,this.disconnected=!1,this.open=!1,this.connections={},this._lostMessages={},this._initializeServerConnection(),void(e?this._initialize(e):this._retrieveId())):void this._delayedAbort("invalid-key",'API KEY "'+t.key+'" is invalid'):void this._delayedAbort("invalid-id",'ID "'+e+'" is invalid'):void this._delayedAbort("browser-incompatible","The current browser does not support WebRTC")):new n(e,t)}var u=e("./util"),a=e("eventemitter3"),r=e("./socket"),d=e("./mediaconnection"),h=e("./dataconnection");u.inherits(n,a),n.prototype._initializeServerConnection=function(){var t=this;this.socket=new r(this.options.secure,this.options.host,this.options.port,this.options.path,this.options.key),this.socket.on("message",function(e){t._handleMessage(e)}),this.socket.on("error",function(e){t._abort("socket-error",e)}),this.socket.on("disconnected",function(){t.disconnected||(t.emitError("network","Lost connection to server."),t.disconnect())}),this.socket.on("close",function(){t.disconnected||t._abort("socket-closed","Underlying socket is already closed.")})},n.prototype._retrieveId=function(){var n=this,e=new XMLHttpRequest,t=(this.options.secure?"https://":"http://")+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/id";t+="?ts="+(new Date).getTime()+Math.random(),e.open("get",t,!0),e.onerror=function(e){u.error("Error retrieving ID",e);var t="";"/"===n.options.path&&n.options.host!==u.CLOUD_HOST&&(t=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),n._abort("server-error","Could not get an ID from the server."+t)},e.onreadystatechange=function(){return 4===e.readyState?200!==e.status?void e.onerror():void n._initialize(e.responseText):void 0},e.send(null)},n.prototype._initialize=function(e){this.id=e,this.socket.start(this.id,this.options.token)},n.prototype._handleMessage=function(e){var t,n=e.type,a=e.payload,r=e.src;switch(n){case"OPEN":this.emit("open",this.id),this.open=!0;break;case"ERROR":this._abort("server-error",a.msg);break;case"ID-TAKEN":this._abort("unavailable-id","ID `"+this.id+"` is taken");break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this.options.key+'" is invalid');break;case"LEAVE":u.log("Received leave message from",r),this._cleanupPeer(r);break;case"EXPIRE":this.emitError("peer-unavailable","Could not connect to peer "+r);break;case"OFFER":var i=a.connectionId;if(t=this.getConnection(r,i))u.warn("Offer received for existing Connection ID:",i);else{if("media"===a.type)t=new d(r,this,{connectionId:i,_payload:a,metadata:a.metadata}),this._addConnection(r,t),this.emit("call",t);else{if("data"!==a.type)return void u.warn("Received malformed connection type:",a.type);t=new h(r,this,{connectionId:i,_payload:a,metadata:a.metadata,label:a.label,serialization:a.serialization,reliable:a.reliable}),this._addConnection(r,t),this.emit("connection",t)}for(var o=this._getMessages(i),s=0,l=o.length;s<l;s+=1)t.handleMessage(o[s])}break;default:if(!a)return void u.warn("You received a malformed message from "+r+" of type "+n);var c=a.connectionId;(t=this.getConnection(r,c))&&t.pc?t.handleMessage(e):c?this._storeMessage(c,e):u.warn("You received an unrecognized message:",e)}},n.prototype._storeMessage=function(e,t){this._lostMessages[e]||(this._lostMessages[e]=[]),this._lostMessages[e].push(t)},n.prototype._getMessages=function(e){var t=this._lostMessages[e];return t?(delete this._lostMessages[e],t):[]},n.prototype.connect=function(e,t){if(this.disconnected)return u.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");var n=new h(e,this,t);return this._addConnection(e,n),n},n.prototype.call=function(e,t,n){if(this.disconnected)return u.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");if(t){(n=n||{})._stream=t;var a=new d(e,this,n);return this._addConnection(e,a),a}u.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.")},n.prototype._addConnection=function(e,t){this.connections[e]||(this.connections[e]=[]),this.connections[e].push(t)},n.prototype.getConnection=function(e,t){var n=this.connections[e];if(!n)return null;for(var a=0,r=n.length;a<r;a++)if(n[a].id===t)return n[a];return null},n.prototype._delayedAbort=function(e,t){var n=this;u.setZeroTimeout(function(){n._abort(e,t)})},n.prototype._abort=function(e,t){u.error("Aborting!"),this._lastServerId?this.disconnect():this.destroy(),this.emitError(e,t)},n.prototype.emitError=function(e,t){u.error("Error:",t),"string"==typeof t&&(t=new Error(t)),t.type=e,this.emit("error",t)},n.prototype.destroy=function(){this.destroyed||(this._cleanup(),this.disconnect(),this.destroyed=!0)},n.prototype._cleanup=function(){if(this.connections)for(var e=Object.keys(this.connections),t=0,n=e.length;t<n;t++)this._cleanupPeer(e[t]);this.emit("close")},n.prototype._cleanupPeer=function(e){for(var t=this.connections[e],n=0,a=t.length;n<a;n+=1)t[n].close()},n.prototype.disconnect=function(){var e=this;u.setZeroTimeout(function(){e.disconnected||(e.disconnected=!0,e.open=!1,e.socket&&e.socket.close(),e.emit("disconnected",e.id),e._lastServerId=e.id,e.id=null)})},n.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)u.log("Attempting reconnection to server with ID "+this._lastServerId),this.disconnected=!1,this._initializeServerConnection(),this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(this.disconnected||this.open)throw new Error("Peer "+this.id+" cannot reconnect because it is not disconnected from the server!");u.error("In a hurry? We're still trying to make the initial connection!")}},n.prototype.listAllPeers=function(t){t=t||function(){};var n=this,a=new XMLHttpRequest,e=(this.options.secure?"https://":"http://")+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/peers";e+="?ts="+(new Date).getTime()+Math.random(),a.open("get",e,!0),a.onerror=function(){n._abort("server-error","Could not get peers from the server."),t([])},a.onreadystatechange=function(){if(4===a.readyState){if(401===a.status){var e;throw e=n.options.host!==u.CLOUD_HOST?"It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":"You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",t([]),new Error("It doesn't look like you have permission to list peers IDs. "+e)}t(200!==a.status?[]:JSON.parse(a.responseText))}},a.send(null)},t.exports=n},{"./dataconnection":2,"./mediaconnection":4,"./socket":7,"./util":8,eventemitter3:9}],7:[function(e,t){function s(e,t,n,a,r){if(!(this instanceof s))return new s(e,t,n,a,r);l.call(this),this.disconnected=!1,this._queue=[];var i=e?"https://":"http://",o=e?"wss://":"ws://";this._httpUrl=i+t+":"+n+a+r,this._wsUrl=o+t+":"+n+a+"peerjs?key="+r}var i=e("./util"),l=e("eventemitter3");i.inherits(s,l),s.prototype.start=function(e,t){this.id=e,this._httpUrl+="/"+e+"/"+t,this._wsUrl+="&id="+e+"&token="+t,this._startXhrStream(),this._startWebSocket()},s.prototype._startWebSocket=function(){var n=this;this._socket||(this._socket=new WebSocket(this._wsUrl),this._socket.onmessage=function(t){try{var e=JSON.parse(t.data)}catch(e){return void i.log("Invalid server message",t.data)}n.emit("message",e)},this._socket.onclose=function(){i.log("Socket closed."),n.disconnected=!0,n.emit("disconnected")},this._socket.onopen=function(){n._timeout&&(clearTimeout(n._timeout),setTimeout(function(){n._http.abort(),n._http=null},5e3)),n._sendQueuedMessages(),i.log("Socket open")})},s.prototype._startXhrStream=function(e){try{var t=this;this._http=new XMLHttpRequest,this._http._index=1,this._http._streamIndex=e||0,this._http.open("post",this._httpUrl+"/id?i="+this._http._streamIndex,!0),this._http.onerror=function(){clearTimeout(t._timeout),t.emit("disconnected")},this._http.onreadystatechange=function(){2==this.readyState&&this.old?(this.old.abort(),delete this.old):2<this.readyState&&200===this.status&&this.responseText&&t._handleStream(this)},this._http.send(null),this._setHTTPTimeout()}catch(e){i.log("XMLHttpRequest not available; defaulting to WebSockets")}},s.prototype._handleStream=function(t){var e=t.responseText.split("\n");if(t._buffer)for(;0<t._buffer.length;){var n=t._buffer.shift(),a=e[n];try{a=JSON.parse(a)}catch(e){t._buffer.shift(n);break}this.emit("message",a)}var r=e[t._index];if(r)if(t._index+=1,t._index===e.length)t._buffer||(t._buffer=[]),t._buffer.push(t._index-1);else{try{r=JSON.parse(r)}catch(e){return void i.log("Invalid server message",r)}this.emit("message",r)}},s.prototype._setHTTPTimeout=function(){var t=this;this._timeout=setTimeout(function(){var e=t._http;t._wsOpen()?e.abort():(t._startXhrStream(e._streamIndex+1),t._http.old=e)},25e3)},s.prototype._wsOpen=function(){return this._socket&&1==this._socket.readyState},s.prototype._sendQueuedMessages=function(){for(var e=0,t=this._queue.length;e<t;e+=1)this.send(this._queue[e])},s.prototype.send=function(e){if(!this.disconnected){if(!this.id)return void this._queue.push(e);if(!e.type)return void this.emit("error","Invalid message");var t=JSON.stringify(e);if(this._wsOpen())this._socket.send(t);else{var n=new XMLHttpRequest,a=this._httpUrl+"/"+e.type.toLowerCase();n.open("post",a,!0),n.setRequestHeader("Content-Type","application/json"),n.send(t)}}},s.prototype.close=function(){!this.disconnected&&this._wsOpen()&&(this._socket.close(),this.disconnected=!0)},t.exports=s},{"./util":8,eventemitter3:9}],8:[function(e,t){var c={iceServers:[{url:"stun:stun.l.google.com:19302"}]},l=1,n=e("js-binarypack"),u=e("./adapter").RTCPeerConnection,d={noop:function(){},CLOUD_HOST:"0.peerjs.com",CLOUD_PORT:9e3,chunkedBrowsers:{Chrome:1},chunkedMTU:16300,logLevel:0,setLogLevel:function(e){var t=parseInt(e,10);d.logLevel=isNaN(parseInt(e,10))?e?3:0:t,d.log=d.warn=d.error=d.noop,0<d.logLevel&&(d.error=d._printWith("ERROR")),1<d.logLevel&&(d.warn=d._printWith("WARNING")),2<d.logLevel&&(d.log=d._print)},setLogFunction:function(e){e.constructor!==Function?d.warn("The log function you passed in is not a function. Defaulting to regular logs."):d._print=e},_printWith:function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t),d._print.apply(d,e)}},_print:function(){var e=!1,t=Array.prototype.slice.call(arguments);t.unshift("PeerJS: ");for(var n=0,a=t.length;n<a;n++)t[n]instanceof Error&&(t[n]="("+t[n].name+") "+t[n].message,e=!0);e?console.error.apply(console,t):console.log.apply(console,t)},defaultConfig:c,browser:window.mozRTCPeerConnection?"Firefox":window.webkitRTCPeerConnection?"Chrome":window.RTCPeerConnection?"Supported":"Unsupported",supports:function(){if(void 0===u)return{};var e,t,n=!0,a=!0,r=!1,i=!1,o=!!window.webkitRTCPeerConnection;try{e=new u(c,{optional:[{RtpDataChannels:!0}]})}catch(e){a=n=!1}if(n)try{t=e.createDataChannel("_PEERJSTEST")}catch(e){n=!1}if(n){try{t.binaryType="blob",r=!0}catch(e){}var s=new u(c,{});try{i=s.createDataChannel("_PEERJSRELIABLETEST",{}).reliable}catch(e){}s.close()}if(a&&(a=!!e.addStream),!o&&n){var l=new u(c,{optional:[{RtpDataChannels:!0}]});l.onnegotiationneeded=function(){o=!0,d&&d.supports&&(d.supports.onnegotiationneeded=!0)},l.createDataChannel("_PEERJSNEGOTIATIONTEST"),setTimeout(function(){l.close()},1e3)}return e&&e.close(),{audioVideo:a,data:n,binaryBlob:r,binary:i,reliable:i,sctp:i,onnegotiationneeded:o}}(),validateId:function(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(e)},validateKey:function(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(e)},debug:!1,inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:n.pack,unpack:n.unpack,log:function(){if(d.debug){var e=!1,t=Array.prototype.slice.call(arguments);t.unshift("PeerJS: ");for(var n=0,a=t.length;n<a;n++)t[n]instanceof Error&&(t[n]="("+t[n].name+") "+t[n].message,e=!0);e?console.error.apply(console,t):console.log.apply(console,t)}},setZeroTimeout:function(t){function e(e){e.source==t&&e.data==a&&(e.stopPropagation&&e.stopPropagation(),n.length&&n.shift()())}var n=[],a="zero-timeout-message";return t.addEventListener?t.addEventListener("message",e,!0):t.attachEvent&&t.attachEvent("onmessage",e),function(e){n.push(e),t.postMessage(a,"*")}}(window),chunk:function(e){for(var t=[],n=e.size,a=index=0,r=Math.ceil(n/d.chunkedMTU);a<n;){var i=Math.min(n,a+d.chunkedMTU),o=e.slice(a,i),s={__peerData:l,n:index,data:o,total:r};t.push(s),a=i,index+=1}return l+=1,t},blobToArrayBuffer:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsArrayBuffer(e)},blobToBinaryString:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsBinaryString(e)},binaryStringToArrayBuffer:function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=255&e.charCodeAt(n);return t.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isSecure:function(){return"https:"===location.protocol}};t.exports=d},{"./adapter":1,"js-binarypack":10}],9:[function(e,t){"use strict";function a(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function n(){}n.prototype._events=void 0,n.prototype.listeners=function(e){if(!this._events||!this._events[e])return[];for(var t=0,n=this._events[e].length,a=[];t<n;t++)a.push(this._events[e][t].fn);return a},n.prototype.emit=function(e,t,n,a,r,i){if(!this._events||!this._events[e])return!1;var o,s,l,c=this._events[e],u=c.length,d=arguments.length,h=c[0];if(1===u){switch(h.once&&this.removeListener(e,h.fn,!0),d){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,n),!0;case 4:return h.fn.call(h.context,t,n,a),!0;case 5:return h.fn.call(h.context,t,n,a,r),!0;case 6:return h.fn.call(h.context,t,n,a,r,i),!0}for(s=1,o=new Array(d-1);s<d;s++)o[s-1]=arguments[s];h.fn.apply(h.context,o)}else for(s=0;s<u;s++)switch(c[s].once&&this.removeListener(e,c[s].fn,!0),d){case 1:c[s].fn.call(c[s].context);break;case 2:c[s].fn.call(c[s].context,t);break;case 3:c[s].fn.call(c[s].context,t,n);break;default:if(!o)for(l=1,o=new Array(d-1);l<d;l++)o[l-1]=arguments[l];c[s].fn.apply(c[s].context,o)}return!0},n.prototype.on=function(e,t,n){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),this._events[e].push(new a(t,n||this)),this},n.prototype.once=function(e,t,n){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),this._events[e].push(new a(t,n||this,!0)),this},n.prototype.removeListener=function(e,t,n){if(!this._events||!this._events[e])return this;var a=this._events[e],r=[];if(t)for(var i=0,o=a.length;i<o;i++)a[i].fn!==t&&a[i].once!==n&&r.push(a[i]);return this._events[e]=r.length?r:null,this},n.prototype.removeAllListeners=function(e){return this._events&&(e?this._events[e]=null:this._events={}),this},n.prototype.off=n.prototype.removeListener,n.prototype.addListener=n.prototype.on,n.prototype.setMaxListeners=function(){return this},((n.EventEmitter=n).EventEmitter2=n).EventEmitter3=n,"object"==typeof t&&t.exports&&(t.exports=n)},{}],10:[function(e,t){function n(e){this.index=0,this.dataBuffer=e,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function a(){this.bufferBuilder=new i}function r(e){var t=e.charCodeAt(0);return t<=2047?"00":t<=65535?"000":t<=2097151?"0000":t<=67108863?"00000":"000000"}var i=e("./bufferbuilder").BufferBuilder,o=e("./bufferbuilder").binaryFeatures,s={unpack:function(e){return new n(e).unpack()},pack:function(e){var t=new a;return t.pack(e),t.getBuffer()}};t.exports=s,n.prototype.unpack=function(){var e,t=this.unpack_uint8();if(t<128)return t;if((224^t)<32)return(224^t)-32;if((e=160^t)<=15)return this.unpack_raw(e);if((e=176^t)<=15)return this.unpack_string(e);if((e=144^t)<=15)return this.unpack_array(e);if((e=128^t)<=15)return this.unpack_map(e);switch(t){case 192:return null;case 193:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:case 213:case 214:case 215:return;case 216:return e=this.unpack_uint16(),this.unpack_string(e);case 217:return e=this.unpack_uint32(),this.unpack_string(e);case 218:return e=this.unpack_uint16(),this.unpack_raw(e);case 219:return e=this.unpack_uint32(),this.unpack_raw(e);case 220:return e=this.unpack_uint16(),this.unpack_array(e);case 221:return e=this.unpack_uint32(),this.unpack_array(e);case 222:return e=this.unpack_uint16(),this.unpack_map(e);case 223:return e=this.unpack_uint32(),this.unpack_map(e)}},n.prototype.unpack_uint8=function(){var e=255&this.dataView[this.index];return this.index++,e},n.prototype.unpack_uint16=function(){var e=this.read(2),t=256*(255&e[0])+(255&e[1]);return this.index+=2,t},n.prototype.unpack_uint32=function(){var e=this.read(4),t=256*(256*(256*e[0]+e[1])+e[2])+e[3];return this.index+=4,t},n.prototype.unpack_uint64=function(){var e=this.read(8),t=256*(256*(256*(256*(256*(256*(256*e[0]+e[1])+e[2])+e[3])+e[4])+e[5])+e[6])+e[7];return this.index+=8,t},n.prototype.unpack_int8=function(){var e=this.unpack_uint8();return e<128?e:e-256},n.prototype.unpack_int16=function(){var e=this.unpack_uint16();return e<32768?e:e-65536},n.prototype.unpack_int32=function(){var e=this.unpack_uint32();return e<Math.pow(2,31)?e:e-Math.pow(2,32)},n.prototype.unpack_int64=function(){var e=this.unpack_uint64();return e<Math.pow(2,63)?e:e-Math.pow(2,64)},n.prototype.unpack_raw=function(e){if(this.length<this.index+e)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+e+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+e);return this.index+=e,t},n.prototype.unpack_string=function(e){for(var t,n,a=this.read(e),r=0,i="";r<e;)(t=a[r])<128?(i+=String.fromCharCode(t),r++):(192^t)<32?(n=(192^t)<<6|63&a[r+1],i+=String.fromCharCode(n),r+=2):(n=(15&t)<<12|(63&a[r+1])<<6|63&a[r+2],i+=String.fromCharCode(n),r+=3);return this.index+=e,i},n.prototype.unpack_array=function(e){for(var t=new Array(e),n=0;n<e;n++)t[n]=this.unpack();return t},n.prototype.unpack_map=function(e){for(var t={},n=0;n<e;n++){var a=this.unpack(),r=this.unpack();t[a]=r}return t},n.prototype.unpack_float=function(){var e=this.unpack_uint32(),t=(e>>23&255)-127;return(0==e>>31?1:-1)*(8388607&e|8388608)*Math.pow(2,t-23)},n.prototype.unpack_double=function(){var e=this.unpack_uint32(),t=this.unpack_uint32(),n=(e>>20&2047)-1023;return(0==e>>31?1:-1)*((1048575&e|1048576)*Math.pow(2,n-20)+t*Math.pow(2,n-52))},n.prototype.read=function(e){var t=this.index;if(t+e<=this.length)return this.dataView.subarray(t,t+e);throw new Error("BinaryPackFailure: read index out of range")},a.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()},a.prototype.pack=function(e){var t=typeof e;if("string"==t)this.pack_string(e);else if("number"==t)Math.floor(e)===e?this.pack_integer(e):this.pack_double(e);else if("boolean"==t)!0===e?this.bufferBuilder.append(195):!1===e&&this.bufferBuilder.append(194);else if("undefined"==t)this.bufferBuilder.append(192);else{if("object"!=t)throw new Error('Type "'+t+'" not yet supported');if(null===e)this.bufferBuilder.append(192);else{var n=e.constructor;if(n==Array)this.pack_array(e);else if(n==Blob||n==File)this.pack_bin(e);else if(n==ArrayBuffer)this.pack_bin(o.useArrayBufferView?new Uint8Array(e):e);else if("BYTES_PER_ELEMENT"in e)this.pack_bin(o.useArrayBufferView?new Uint8Array(e.buffer):e.buffer);else if(n==Object)this.pack_object(e);else if(n==Date)this.pack_string(e.toString());else{if("function"!=typeof e.toBinaryPack)throw new Error('Type "'+n.toString()+'" not yet supported');this.bufferBuilder.append(e.toBinaryPack())}}}this.bufferBuilder.flush()},a.prototype.pack_bin=function(e){var t=e.length||e.byteLength||e.size;if(t<=15)this.pack_uint8(160+t);else if(t<=65535)this.bufferBuilder.append(218),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(t)}this.bufferBuilder.append(e)},a.prototype.pack_string=function(e){var t,n=600<(t=e).length?new Blob([t]).size:t.replace(/[^\u0000-\u007F]/g,r).length;if(n<=15)this.pack_uint8(176+n);else if(n<=65535)this.bufferBuilder.append(216),this.pack_uint16(n);else{if(!(n<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(n)}this.bufferBuilder.append(e)},a.prototype.pack_array=function(e){var t=e.length;if(t<=15)this.pack_uint8(144+t);else if(t<=65535)this.bufferBuilder.append(220),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(t)}for(var n=0;n<t;n++)this.pack(e[n])},a.prototype.pack_integer=function(e){if(-32<=e&&e<=127)this.bufferBuilder.append(255&e);else if(0<=e&&e<=255)this.bufferBuilder.append(204),this.pack_uint8(e);else if(-128<=e&&e<=127)this.bufferBuilder.append(208),this.pack_int8(e);else if(0<=e&&e<=65535)this.bufferBuilder.append(205),this.pack_uint16(e);else if(-32768<=e&&e<=32767)this.bufferBuilder.append(209),this.pack_int16(e);else if(0<=e&&e<=4294967295)this.bufferBuilder.append(206),this.pack_uint32(e);else if(-2147483648<=e&&e<=2147483647)this.bufferBuilder.append(210),this.pack_int32(e);else if(-0x8000000000000000<=e&&e<=0x8000000000000000)this.bufferBuilder.append(211),this.pack_int64(e);else{if(!(0<=e&&e<=0x10000000000000000))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(e)}},a.prototype.pack_double=function(e){var t=0;e<0&&(t=1,e=-e);var n=Math.floor(Math.log(e)/Math.LN2),a=e/Math.pow(2,n)-1,r=Math.floor(a*Math.pow(2,52)),i=Math.pow(2,32),o=t<<31|n+1023<<20|r/i&1048575,s=r%i;this.bufferBuilder.append(203),this.pack_int32(o),this.pack_int32(s)},a.prototype.pack_object=function(e){var t=Object.keys(e).length;if(t<=15)this.pack_uint8(128+t);else if(t<=65535)this.bufferBuilder.append(222),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(t)}for(var n in e)e.hasOwnProperty(n)&&(this.pack(n),this.pack(e[n]))},a.prototype.pack_uint8=function(e){this.bufferBuilder.append(e)},a.prototype.pack_uint16=function(e){this.bufferBuilder.append(e>>8),this.bufferBuilder.append(255&e)},a.prototype.pack_uint32=function(e){var t=4294967295&e;this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t)},a.prototype.pack_uint64=function(e){var t=e/Math.pow(2,32),n=e%Math.pow(2,32);this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t),this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)},a.prototype.pack_int8=function(e){this.bufferBuilder.append(255&e)},a.prototype.pack_int16=function(e){this.bufferBuilder.append((65280&e)>>8),this.bufferBuilder.append(255&e)},a.prototype.pack_int32=function(e){this.bufferBuilder.append(e>>>24&255),this.bufferBuilder.append((16711680&e)>>>16),this.bufferBuilder.append((65280&e)>>>8),this.bufferBuilder.append(255&e)},a.prototype.pack_int64=function(e){var t=Math.floor(e/Math.pow(2,32)),n=e%Math.pow(2,32);this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t),this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)}},{"./bufferbuilder":11}],11:[function(e,t){function n(){this._pieces=[],this._parts=[]}var a={};a.useBlobBuilder=function(){try{return new Blob([]),!1}catch(e){return!0}}(),a.useArrayBufferView=!a.useBlobBuilder&&function(){try{return 0===new Blob([new Uint8Array([])]).size}catch(e){return!0}}(),t.exports.binaryFeatures=a;var r=t.exports.BlobBuilder;"undefined"!=typeof window&&(r=t.exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder),n.prototype.append=function(e){"number"==typeof e?this._pieces.push(e):(this.flush(),this._parts.push(e))},n.prototype.flush=function(){if(0<this._pieces.length){var e=new Uint8Array(this._pieces);a.useArrayBufferView||(e=e.buffer),this._parts.push(e),this._pieces=[]}},n.prototype.getBuffer=function(){if(this.flush(),a.useBlobBuilder){for(var e=new r,t=0,n=this._parts.length;t<n;t++)e.append(this._parts[t]);return e.getBlob()}return new Blob(this._parts)},t.exports.BufferBuilder=n},{}],12:[function(e,t){function n(e,t){return this instanceof n?(this._dc=e,c.debug=t,this._outgoing={},this._incoming={},this._received={},this._window=1e3,this._mtu=500,this._interval=0,this._count=0,this._queue=[],void this._setupDC()):new n(e)}var c=e("./util");n.prototype.send=function(e){var t=c.pack(e);return t.size<this._mtu?void this._handleSend(["no",t]):(this._outgoing[this._count]={ack:0,chunks:this._chunk(t)},c.debug&&(this._outgoing[this._count].timer=new Date),this._sendWindowedChunks(this._count),void(this._count+=1))},n.prototype._setupInterval=function(){var a=this;this._timeout=setInterval(function(){var e=a._queue.shift();if(e._multiple)for(var t=0,n=e.length;t<n;t+=1)a._intervalSend(e[t]);else a._intervalSend(e)},this._interval)},n.prototype._intervalSend=function(e){var t=this;e=c.pack(e),c.blobToBinaryString(e,function(e){t._dc.send(e)}),0===t._queue.length&&(clearTimeout(t._timeout),t._timeout=null)},n.prototype._processAcks=function(){for(var e in this._outgoing)this._outgoing.hasOwnProperty(e)&&this._sendWindowedChunks(e)},n.prototype._handleSend=function(e){for(var t=!0,n=0,a=this._queue.length;n<a;n+=1){var r=this._queue[n];r===e?t=!1:r._multiple&&-1!==r.indexOf(e)&&(t=!1)}t&&(this._queue.push(e),this._timeout||this._setupInterval())},n.prototype._setupDC=function(){var a=this;this._dc.onmessage=function(e){var t=e.data;if(t.constructor===String){var n=c.binaryStringToArrayBuffer(t);t=c.unpack(n),a._handleMessage(t)}}},n.prototype._handleMessage=function(e){var t,n=e[1],a=this._incoming[n],r=this._outgoing[n];switch(e[0]){case"no":var i=n;i&&this.onmessage(c.unpack(i));break;case"end":if(t=a,this._received[n]=e[2],!t)break;this._ack(n);break;case"ack":if(t=r){var o=e[2];t.ack=Math.max(o,t.ack),t.ack>=t.chunks.length?(c.log("Time: ",new Date-t.timer),delete this._outgoing[n]):this._processAcks()}break;case"chunk":if(!(t=a)){if(!0===this._received[n])break;t={ack:["ack",n,0],chunks:[]},this._incoming[n]=t}var s=e[2],l=e[3];t.chunks[s]=new Uint8Array(l),s===t.ack[2]&&this._calculateNextAck(n),this._ack(n);break;default:this._handleSend(e)}},n.prototype._chunk=function(e){for(var t=[],n=e.size,a=0;a<n;){var r=Math.min(n,a+this._mtu),i={payload:e.slice(a,r)};t.push(i),a=r}return c.log("Created",t.length,"chunks."),t},n.prototype._ack=function(e){var t=this._incoming[e].ack;this._received[e]===t[2]&&(this._complete(e),this._received[e]=!0),this._handleSend(t)},n.prototype._calculateNextAck=function(e){for(var t=this._incoming[e],n=t.chunks,a=0,r=n.length;a<r;a+=1)if(void 0===n[a])return void(t.ack[2]=a);t.ack[2]=n.length},n.prototype._sendWindowedChunks=function(e){c.log("sendWindowedChunks for: ",e);for(var t=this._outgoing[e],n=t.chunks,a=[],r=Math.min(t.ack+this._window,n.length),i=t.ack;i<r;i+=1)n[i].sent&&i!==t.ack||(n[i].sent=!0,a.push(["chunk",e,i,n[i].payload]));t.ack+this._window>=n.length&&a.push(["end",e,n.length]),a._multiple=!0,this._handleSend(a)},n.prototype._complete=function(e){c.log("Completed called for",e);var t=this,n=this._incoming[e].chunks,a=new Blob(n);c.blobToArrayBuffer(a,function(e){t.onmessage(c.unpack(e))}),delete this._incoming[e]},n.higherBandwidthSDP=function(e){var t=navigator.appVersion.match(/Chrome\/(.*?) /);if(t&&(t=parseInt(t[1].split(".").shift()))<31){var n=e.split("b=AS:30");if(1<n.length)return n[0]+"b=AS:102400"+n[1]}return e},n.prototype.onmessage=function(){},t.exports.Reliable=n},{"./util":13}],13:[function(e,t){var n=e("js-binarypack"),a={debug:!1,inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:n.pack,unpack:n.unpack,log:function(){if(a.debug){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e.unshift("Reliable: "),console.log.apply(console,e)}},setZeroTimeout:function(t){function e(e){e.source==t&&e.data==a&&(e.stopPropagation&&e.stopPropagation(),n.length&&n.shift()())}var n=[],a="zero-timeout-message";return t.addEventListener?t.addEventListener("message",e,!0):t.attachEvent&&t.attachEvent("onmessage",e),function(e){n.push(e),t.postMessage(a,"*")}}(this),blobToArrayBuffer:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsArrayBuffer(e)},blobToBinaryString:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsBinaryString(e)},binaryStringToArrayBuffer:function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=255&e.charCodeAt(n);return t.buffer},randomToken:function(){return Math.random().toString(36).substr(2)}};t.exports=a},{"js-binarypack":10}]},{},[3]);var emptyFunction=SIMULATOR.sendBattleUpdate=function(){};$(document).ready(function(){var n=new Peer({key:"12gvgzijkheka9k9",debug:3,logFunction:function(){var e,t=Array.prototype.slice.call(arguments).join(" ");e=t,$(".log").append(e+"<br/>"),console.log(e)}}),a=null,r=!1,i=!1;function o(e){s(e),i=$("#surge").is(":checked");var t={type:"requestFight",data:{hash:$("#deck1").val(),bges:function(){for(var e="",t=document.getElementsByName("battleground"),n=0;n<t.length;n++)d=t[n],d.checked&&(e+=base64.fromDecimal(d.value,2));return e}(),tournament:$("#tournament").is(":checked"),surge:!i}};e.send(JSON.stringify(t))}function s(t){t.on("data",function(e){!function(e,t){var n=JSON.parse(t);switch(n.type){case"requestFight":!function(e,t){var n;r?(n={type:"accepted",data:$("#deck1").val()},$("#deck2").val(t.hash),function(e){$("#battleground input").prop("checked",!1);for(var t=0;t<e.length;t+=2){var n=base64.toDecimal(e.substring(t,t+2));$("#battleground_"+n).prop("checked",!0)}}(t.bges),i=$("#surge").prop("checked"),$("#surge").prop("checked",t.surge),$("#tournament").prop("checked",t.tournament),SIMULATOR.sendBattleUpdate=l,SIMULATOR.waiting=!0,SIMULATOR.pause=!0,SIMULATOR.livePvP=!0,SIM_CONTROLLER.startsim(),SIM_CONTROLLER.end_sims_callback=c,$("#btnStop").off("click").on("click",c)):n={type:"rejected"};e.send(JSON.stringify(n))}(e,n.data);break;case"accepted":a=n.data,$("#deck2").val(a),$("#btnStop").off("click").on("click",c),SIMULATOR.livePvP=!0,SIMULATOR.sendBattleUpdate=l,SIM_CONTROLLER.startsim(),SIM_CONTROLLER.end_sims_callback=c;break;case"rejected":CARD_GUI.clearCardSpace(),outp("Opponent is not ready"),g();break;case"updateField":!function(e){if(SIMULATOR.waiting){var t=SIMULATOR.field=e.field,n=SIMULATOR.simulation_turns=e.turn;echo=(echo=(echo=(echo=e.echo).replace(/<b>/g,"<z>").replace(/<\/b>/g,"</z>")).replace(/<i>/g,"<b>").replace(/<\/i>/g,"</b>")).replace(/<z>/g,"<i>").replace(/<\/z>/g,"</i>"),u(t.player.commander);for(var a=t.player.assaults,r=0;r<a.length;r++)u(a[r]);u(t.cpu.commander);for(var a=t.cpu.assaults,r=0;r<a.length;r++)u(a[r]);var i=t.player;t.player=t.cpu,t.cpu=i,CARD_GUI.draw_cards(t),SIMULATOR.performTurns(n,!0)}}(n.data)}var a}(t,e)}),t.on("close",function(){SIMULATOR.sendBattleUpdate=emptyFunction,SIMULATOR.livePvP=!1,c()}),a=t.peer}function l(e){var t={type:"updateField",data:{field:SIMULATOR.field,turn:e,echo:echo}};p().send(JSON.stringify(t))}function c(){setTimeout(g,1),SIMULATOR.simulating&&SIM_CONTROLLER.stopsim(),$("#surge").prop("checked",i)}function u(e){e.__proto__=CardPrototype,e.owner="player"===e.owner?"cpu":"player"}function e(){$("#enemyPeerID").val()?$("#btn_simulate").off("click").on("click",f).val("Connect!"):$("#btn_simulate").off("click").on("click",t).val("Ready!")}function t(){hideUI(),points=draws=losses=wins=0,outp(""),setSimStatus(""),CARD_GUI.clearCardSpace(),r=!0,$("#btnStop").off("click").on("click",h)}function h(){r=!1,showUI()}function f(){var e=$("#enemyPeerID").val();if(!a){var t=n.connect(e,{label:"chat",serialization:"none",metadata:{message:"hi i want to chat with you!"}});t.on("open",function(){o(t)}),t.on("error",function(e){alert(e)}),a=e}}function p(){return n.connections[a][0]}function g(){null!==a&&(p().close(),delete n.connections[a],a=null),r=!1}$("#debug").prop("checked",!0),n.on("open",function(e){$("#myPeerID").val(e)}),n.on("connection",function(e){s(e)}),n.on("error",function(e){console.log(e),g()}),$("#btn_simulate").off("click").on("click",t),$("#enemyPeerID").on("change",e).on("keyup",e.debounce(50)),$("#send").submit(function(e){e.preventDefault(),sendMsg()}),window.onunload=window.onbeforeunload=function(e){n&&!n.destroyed&&n.destroy()}});